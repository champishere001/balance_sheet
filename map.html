<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HP Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body{height:100%;margin:0}
    body{
      background:#060914;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#eaf0ff;
    }
    #map{height:100%;width:100%}

    .badge{
      position:absolute;left:12px;top:12px;z-index:9999;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.16);
      color:#eaf0ff;
      padding:10px 12px;border-radius:14px;
      backdrop-filter: blur(12px);
      font-weight:800;font-size:12px;
      max-width: calc(100% - 24px);
      box-sizing:border-box;
      box-shadow: 0 10px 22px rgba(0,0,0,.45);
    }
    .badge b{display:block;font-size:13px}
    .badge span{opacity:.85;font-weight:700;display:block;margin-top:3px;line-height:1.25}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="badge" id="badge">
    <b>Himachal Map</b>
    <span>“Let the mountains reset your mind.”</span>
  </div>

  <script>
    // District centers (approx) - match your district names
    const DIST = {
      "Bilaspur": {lat:31.330, lng:76.760},
      "Chamba": {lat:32.556, lng:76.127},
      "Hamirpur": {lat:31.686, lng:76.521},
      "Kangra": {lat:32.100, lng:76.270},
      "Kinnaur": {lat:31.595, lng:78.400},
      "Kullu": {lat:31.957, lng:77.110},
      "Lahaul & Spiti": {lat:32.490, lng:77.600},
      "Mandi": {lat:31.708, lng:76.932},
      "Shimla": {lat:31.104, lng:77.173},
      "Sirmaur": {lat:30.570, lng:77.300},
      "Solan": {lat:30.910, lng:77.110},
      "Una": {lat:31.470, lng:76.270},
      // alternate key
      "Lahaul and Spiti": {lat:32.490, lng:77.600}
    };

    const map = L.map("map", { zoomControl:true }).setView([31.9, 77.2], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const badge = document.getElementById("badge");
    let districtMarker = null;
    let placeMarker = null;

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function setBadge(title, subtitle){
      badge.innerHTML = `<b>${escapeHtml(title)}</b><span>${escapeHtml(subtitle || "")}</span>`;
    }

    function findDistrictKey(name){
      const n = String(name||"").toLowerCase().trim();
      return Object.keys(DIST).find(k => k.toLowerCase() === n) || null;
    }

    function focusDistrict(name){
      const key = findDistrictKey(name);
      if(!key){
        setBadge("Himachal Map", "District not found");
        return;
      }
      const {lat,lng} = DIST[key];
      map.setView([lat,lng], 9, {animate:true, duration:0.6});

      if(districtMarker) districtMarker.remove();
      districtMarker = L.marker([lat,lng]).addTo(map).bindPopup(`<b>${escapeHtml(key)}</b><br/>District center`).openPopup();

      setBadge(key, "District center");
    }

    function focusPlace(payload){
      const lat = Number(payload?.lat);
      const lng = Number(payload?.lng);
      if(!Number.isFinite(lat) || !Number.isFinite(lng)) return;

      const title = payload?.title || "Place";
      const sub = payload?.type ? `Type: ${payload.type}` : "";

      map.setView([lat,lng], 13, {animate:true, duration:0.6});
      if(placeMarker) placeMarker.remove();
      placeMarker = L.marker([lat,lng]).addTo(map).bindPopup(`<b>${escapeHtml(title)}</b><br/>${escapeHtml(sub)}`).openPopup();

      setBadge(title, sub || "Selected place");
    }

    function readDistrictFromHash(){
      const m = (location.hash||"").match(/district=([^&]+)/i);
      if(m){
        focusDistrict(decodeURIComponent(m[1]));
      }else{
        setBadge("Himachal Map", "Select a district");
      }
    }
    window.addEventListener("hashchange", readDistrictFromHash);
    readDistrictFromHash();

    // Receive focus from parent (index.html)
    window.addEventListener("message", (ev)=>{
      const data = ev.data;
      if(!data || typeof data !== "object") return;
      if(data.type === "FOCUS_DISTRICT") focusDistrict(data.district);
      if(data.type === "FOCUS_PLACE") focusPlace(data);
    });
  </script>
</body>
</html>