<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="light"/>
  <title>Himachal Tour Packages | Dashboard</title>
  <meta name="description" content="Explore Himachal tour packages with live road route maps, day-wise itineraries, places, and instant price estimates." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <link rel="canonical" href="https://himachalexplorer.in/" />
  <meta name="theme-color" content="#EAF3FF" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
:root{
  --bg0:#F6FAFF;
  --bg1:#EAF3FF;
  --card: rgba(255,255,255,.62);
  --stroke: rgba(10,30,60,.16);
  --muted: rgba(10,30,60,.62);
  --text: rgba(10,30,60,.92);
  --shadow: 0 18px 70px rgba(10,30,60,.14);
  --radius: 16px;
  --acc:#2563EB;
  --gap: 12px;
  --shellW: min(94vw, 1700px);
  --heroH: clamp(220px, 26vw, 320px);
}

*{ box-sizing:border-box; }
html, body{ height:100%; }
body{
  margin:0; color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1100px 520px at 20% 0%, rgba(37,99,235,.12), transparent 60%),
    radial-gradient(900px 520px at 85% 10%, rgba(14,165,233,.10), transparent 62%),
    radial-gradient(900px 520px at 50% 92%, rgba(59,130,246,.08), transparent 64%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  overflow-x:hidden;
  -webkit-text-size-adjust: 100%;
  text-rendering: optimizeLegibility;
}
.aurora{
  position:fixed; inset:-30%;
  background:
    radial-gradient(900px 500px at 25% 30%, rgba(37,99,235,.12), transparent 66%),
    radial-gradient(900px 520px at 75% 25%, rgba(14,165,233,.10), transparent 68%),
    radial-gradient(860px 540px at 55% 75%, rgba(59,130,246,.08), transparent 70%);
  filter: blur(50px); opacity:.85; animation: drift 14s ease-in-out infinite;
  pointer-events:none; z-index:-3;
  transform: translateZ(0);
}
@keyframes drift{
  0%,100%{transform:translate3d(0,0,0) scale(1);}
  50%{transform:translate3d(3%,-2%,0) scale(1.06);}
}
.noise{
  position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.06; mix-blend-mode:multiply;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
}
.shell{ width: var(--shellW); margin: 0 auto; padding: 12px 10px 18px; }

/* ===== HERO ===== */
.hero{
  border-radius: 22px; border:1px solid var(--stroke);
  overflow:hidden; position:relative; box-shadow: var(--shadow);
  background: rgba(255,255,255,.62);
}
.heroMedia{ height: var(--heroH); position:relative; overflow:hidden; background: rgba(255,255,255,.62); }
.heroMedia img{ width:100%; height:100%; object-fit:cover; display:block; transform: translateZ(0); }
.heroMedia::after{
  content:""; position:absolute; inset:0;
  background: linear-gradient(90deg, rgba(255,255,255,.28), rgba(255,255,255,.10), rgba(255,255,255,.24));
  pointer-events:none;
}
.heroBar{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding: 12px 14px;
  background: rgba(255,255,255,.66);
  border-top:1px solid rgba(10,30,60,.14);
  backdrop-filter: blur(14px);
}
.heroBrand{ display:flex; align-items:center; gap:12px; min-width:0; }
.logo{
  width:56px; height:56px; border-radius:16px;
  background: rgba(255,255,255,.78);
  border:1px solid rgba(10,30,60,.16);
  display:grid; place-items:center; overflow:hidden;
  box-shadow: 0 14px 34px rgba(10,30,60,.12);
  flex:0 0 auto;
}
.logo img{ width:100%; height:100%; object-fit:cover; display:block; }
.brandText{ min-width:0; }
.heroTitle{
  margin:0;
  font-size: clamp(16px, 2.1vw, 22px);
  letter-spacing:.14em; text-transform: uppercase;
  font-weight: 1000; color: rgba(10,30,60,.96);
  line-height: 1.1;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.heroSub{
  margin:7px 0 0;
  font-size: 12px; color: rgba(10,30,60,.70);
  letter-spacing:.08em; text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.heroRight{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; flex:0 0 auto; }

.chip{
  border:1px solid rgba(10,30,60,.18);
  background: rgba(255,255,255,.62);
  color: rgba(10,30,60,.82);
  border-radius: 999px;
  padding: 8px 10px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing:.10em;
  display:inline-flex; align-items:center; gap:10px;
  cursor:pointer; user-select:none;
  box-shadow: 0 10px 24px rgba(10,30,60,.10);
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
}
.chip.primary{
  border-color: rgba(37,99,235,.40);
  background: rgba(37,99,235,.16);
  color: rgba(10,30,60,.92);
  font-weight: 950;
}

/* =========================================================
   MAIN LAYOUT (LEFT 22% | CENTER 54% | RIGHT 24%)
   ========================================================= */
.main{
  display:grid;
  grid-template-columns: 22% 54% 24%;
  gap: var(--gap);
  margin-top: 12px;
  align-items: stretch;
  min-width:0;
}

/* panes same height; scroll INSIDE */
.pane{
  border: 1px solid var(--stroke);
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.56));
  box-shadow: var(--shadow);
  backdrop-filter: blur(14px);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-width: 0;
  min-height: 0;
  height: calc(100vh - 24px);
  min-height: 640px;
  max-height: 920px;
}

.paneHdr{
  padding: 10px 12px;
  border-bottom:1px solid rgba(10,30,60,.14);
  display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
  background: rgba(255,255,255,.62);
}
.paneHdr .t{ margin:0; font-size:11px; letter-spacing:.18em; text-transform: uppercase; font-weight: 950; }
.paneHdr .s{ font-size:10.5px; color:var(--muted); letter-spacing:.10em; text-transform: uppercase; }

/* ===== LEFT ===== */
.sideInner{
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
.sideCard{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.62);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 12px 36px rgba(10,30,60,.10);
}
.field label{
  display:block; font-size: 10.5px; color: var(--muted);
  text-transform: uppercase; letter-spacing:.12em; margin:0 0 6px 2px;
}
input, select{
  width:100%; padding: 10px 10px; border-radius: 12px;
  border: 1px solid rgba(10,30,60,.18);
  background: rgba(255,255,255,.82);
  color: rgba(10,30,60,.92);
  outline:none; font-size: 13px;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}
input:focus, select:focus{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.16); }

.btnRow{ display:flex; gap:8px; margin-top:8px; }
.btn{
  flex:1; padding: 10px 10px; border-radius: 12px;
  border: 1px solid rgba(37,99,235,.30);
  background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(14,165,233,.72));
  color:#fff; font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
  cursor:pointer; font-size: 11px;
  box-shadow: 0 14px 34px rgba(37,99,235,.18);
  -webkit-tap-highlight-color: transparent;
}
.btn.secondary{
  border: 1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  color: rgba(10,30,60,.86);
  box-shadow: 0 10px 24px rgba(10,30,60,.10);
}

.pills{ display:flex; flex-wrap:wrap; gap:7px; margin-top:10px; }
.pill{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.62);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10.5px;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.78);
  display:inline-flex; align-items:center; gap:8px;
}
.pill b{ color: rgba(10,30,60,.92); letter-spacing:.06em; }

/* ===== LEFT: ALL PACKAGES LIST ===== */
.otherWrap{ flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
.otherHdr{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.62);
  border-radius: 14px;
  padding: 10px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  box-shadow: 0 10px 24px rgba(10,30,60,.10);
}
.otherHdr .h{ font-size: 11px; font-weight: 950; letter-spacing:.14em; text-transform: uppercase; }
.otherHdr .xBtn{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  color: rgba(10,30,60,.86);
  border-radius: 12px;
  padding: 7px 10px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  cursor:pointer;
  user-select:none;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
}
.otherList{
  flex:1; min-height:0; overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding: 2px;
  display:flex; flex-direction:column; gap:8px;
}
.otherHint{
  border:1px dashed rgba(10,30,60,.20);
  background: rgba(255,255,255,.58);
  border-radius: 14px;
  padding: 10px;
  color: rgba(10,30,60,.72);
  font-size: 11px;
  letter-spacing:.02em;
  line-height: 1.35;
}

/* side package card */
.pkgSide{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.70);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 10px 20px rgba(10,30,60,.08);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  gap:8px;
  -webkit-tap-highlight-color: transparent;
}
.pkgSide.active{
  border-color: rgba(37,99,235,.40);
  box-shadow: 0 0 0 3px rgba(37,99,235,.14);
  background: rgba(37,99,235,.10);
}
.pkgSideTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.pkgSideTop .t1{
  font-size: 10.5px;
  font-weight: 1000;
  letter-spacing:.12em;
  text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.pkgSideTop .badge{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.76);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
  white-space: nowrap;
  flex:0 0 auto;
}
.pkgSideTop .badge.blue{ border-color: rgba(37,99,235,.32); background: rgba(37,99,235,.12); }
.pkgSideRow{
  display:flex; gap:8px; flex-wrap:wrap;
  font-size: 10px;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.72);
}
.pkgSideRow span{
  border:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.66);
  border-radius: 999px;
  padding: 6px 8px;
  white-space: nowrap;
}
.pkgSidePrice{
  font-size: 11px;
  font-weight: 1000;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.92);
}

/* ===== CENTER: SELECTED ONLY ===== */
.centerInner{ display:flex; flex-direction:column; min-height:0; flex:1; }
.centerScroll{
  flex:1; min-height:0; overflow:auto;
  padding: 12px;
  background: rgba(255,255,255,.52);
  -webkit-overflow-scrolling: touch;
}

/* Selected package hero card */
.selWrap{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  border-radius: 18px;
  overflow:hidden;
  box-shadow: 0 14px 36px rgba(10,30,60,.10);
}
.selTop{
  display:flex;
  gap:12px;
  padding:12px;
  border-bottom:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.66);
}
.selMedia{
  width: 38%;
  min-width: 280px;
  border-radius: 16px;
  overflow:hidden;
  border:1px solid rgba(10,30,60,.14);
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.78), rgba(37,99,235,.12));
}
.selMedia img{ width:100%; height:220px; object-fit:cover; display:block; }
.selInfo{ flex:1; min-width:0; display:flex; flex-direction:column; gap:8px; }
.selTitleRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.selTitle{
  margin:0;
  font-size: 12px;
  font-weight: 1000;
  letter-spacing:.14em;
  text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.selBadges{ display:flex; gap:8px; flex-wrap:wrap; }
.badgePill{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.72);
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  color: rgba(10,30,60,.82);
  font-weight: 950;
}
.badgePill.blue{ border-color: rgba(37,99,235,.30); background: rgba(37,99,235,.12); }
.badgePill.green{ border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.14); }
.badgePill.orange{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.14); }

.routeLine{
  font-size: 11px;
  color: rgba(10,30,60,.80);
  letter-spacing:.03em;
  line-height: 1.45;
}

.detailsGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  padding: 12px;
  background: rgba(255,255,255,.56);
}
@media (max-width: 980px){
  .selTop{ flex-direction:column; }
  .selMedia{ width:100%; min-width:unset; }
  .detailsGrid{ grid-template-columns: 1fr; }
}

.detailsCard{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 12px 34px rgba(10,30,60,.10);
  min-width:0;
}
.bigTitle{ margin:0; font-size: 12px; letter-spacing:.18em; text-transform: uppercase; color: rgba(10,30,60,.94); }
.muted{ color: var(--muted); font-size: 10.8px; letter-spacing:.08em; text-transform: uppercase; line-height:1.35; }

.priceRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.tierBtn{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.74);
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 1000;
  cursor:pointer;
}
.tierBtn.active{
  border-color: rgba(37,99,235,.40);
  background: rgba(37,99,235,.14);
  box-shadow: 0 0 0 3px rgba(37,99,235,.14);
}
.priceOld{
  text-decoration: line-through;
  color: rgba(10,30,60,.60);
  font-weight: 900;
  letter-spacing:.06em;
}
.priceNew{
  margin-top:6px;
  font-size: 18px;
  font-weight: 1100;
  letter-spacing:.06em;
}
.priceSmall{
  margin-top:6px;
  font-size: 11px;
  color: rgba(10,30,60,.72);
  letter-spacing:.02em;
  text-transform:none;
}
.discPill{
  border:1px solid rgba(34,197,94,.30);
  background: rgba(34,197,94,.14);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 1100;
}
.enqRow{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
.enqBtn{
  flex:1;
  border:1px solid rgba(34,197,94,.30);
  background: rgba(34,197,94,.14);
  color: rgba(10,30,60,.92);
  border-radius: 14px;
  padding: 10px 10px;
  text-decoration:none;
  text-transform: uppercase;
  letter-spacing:.10em;
  font-weight: 950;
  font-size: 11px;
  display:flex; align-items:center; justify-content:center; gap:10px;
  user-select:none;
  box-shadow: 0 12px 28px rgba(34,197,94,.14);
  -webkit-tap-highlight-color: transparent;
  min-width: 220px;
}

/* Itinerary */
.itinDays{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.itDay{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 10px 22px rgba(10,30,60,.08);
}
.itDayTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
.itDayTop .d{ font-size: 11px; font-weight: 1000; letter-spacing:.18em; text-transform: uppercase; }
.placeBtn{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  width:100%;
  border:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.66);
  border-radius: 14px;
  padding: 10px;
  cursor:pointer;
  box-shadow: 0 10px 20px rgba(10,30,60,.08);
  -webkit-tap-highlight-color: transparent;
  margin-top: 7px;
}
.placeBtn .left{ min-width:0; }
.placeBtn .nm{
  font-size: 11px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.placeBtn .sm{
  margin-top:4px; font-size: 10px; color: rgba(10,30,60,.62);
  letter-spacing:.08em; text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.placeBtn .tag{
  border:1px solid rgba(37,99,235,.30);
  background: rgba(37,99,235,.12);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
  white-space: nowrap;
  flex:0 0 auto;
}

/* Nearby (circular images + name under) */
.nearWrap{
  margin-top:10px;
  border:1px dashed rgba(10,30,60,.18);
  background: rgba(255,255,255,.58);
  border-radius: 14px;
  padding: 10px;
}
.nearTop{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom:10px;
}
.nearTop .k{
  font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(10,30,60,.62);
  font-weight: 1000;
}
.nearCircles{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 520px){
  .nearCircles{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
}
.nearItem{
  display:flex; flex-direction:column; align-items:center; gap:7px;
  cursor:pointer; user-select:none;
}
.nearCircle{
  width: 64px; height: 64px; border-radius: 999px;
  overflow:hidden;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.76);
  box-shadow: 0 10px 22px rgba(10,30,60,.10);
}
.nearCircle img{ width:100%; height:100%; object-fit:cover; display:block; }
.nearName{
  width:100%;
  font-size: 10px;
  font-weight: 950;
  letter-spacing:.08em;
  text-transform: uppercase;
  color: rgba(10,30,60,.86);
  text-align:center;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* ===== MAP (RIGHT 24% + STICKY) ===== */
.mapPane{
  position: sticky;
  top: 12px;
  height: calc(100vh - 24px);
  min-height: 640px;
  max-height: 920px;
  display:flex;
  flex-direction:column;
  min-height:0;
}
#map{
  width:100%;
  flex:1;
  min-height: 520px;
  background: rgba(255,255,255,.62);
  border-radius: 14px;
}
.mapTools{
  padding: 10px 12px;
  border-top:1px solid rgba(10,30,60,.14);
  display:flex; gap:8px; flex-wrap:wrap;
  background: rgba(255,255,255,.62);
}
.toolBtn{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  color: rgba(10,30,60,.86);
  border-radius: 12px;
  padding: 9px 10px;
  font-size: 10.5px;
  letter-spacing:.12em;
  text-transform: uppercase;
  cursor:pointer;
  display:inline-flex; align-items:center; gap:10px;
  user-select:none; white-space: nowrap; text-decoration:none;
  box-shadow: 0 10px 20px rgba(10,30,60,.08);
  -webkit-tap-highlight-color: transparent;
}

/* ===== WHATSAPP FLOAT ===== */
.waFloat{
  position:fixed; right: 14px; bottom: 14px; z-index: 10000;
  display:flex; align-items:center; gap:10px; padding: 12px 14px;
  border-radius: 999px; border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.74);
  backdrop-filter: blur(14px);
  box-shadow: 0 26px 70px rgba(10,30,60,.16);
  color: rgba(10,30,60,.92); text-decoration:none; user-select:none; -webkit-tap-highlight-color: transparent;
}
.waIcon{ width:40px; height:40px; border-radius: 999px; display:grid; place-items:center; background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.30); flex:0 0 auto; }
.waText{ display:flex; flex-direction:column; line-height:1.1; min-width:0; }
.waText .t1{ font-size: 12px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase; white-space:nowrap; }
.waText .t2{ margin-top:4px; font-size: 11px; color: rgba(10,30,60,.70); letter-spacing:.04em; white-space:nowrap; }
.waClose{
  width:34px; height:34px; border-radius: 999px;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.78);
  color: rgba(10,30,60,.86);
  display:grid; place-items:center;
  cursor:pointer; flex:0 0 auto; user-select:none;
}

/* ===== BOT TOAST ===== */
.botToast{
  position:fixed; left: 14px; bottom: 14px; z-index: 9999;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.74);
  border-radius: 14px;
  padding: 10px 12px;
  color: rgba(10,30,60,.86);
  font-size: 11px;
  letter-spacing:.08em;
  box-shadow: 0 26px 70px rgba(10,30,60,.16);
  display:none;
  max-width: min(520px, calc(100vw - 28px));
}
.botToast.show{ display:block; }

/* ===== PLACE MODAL ===== */
.placeModal{
  position:fixed; inset:0; z-index: 20000;
  background: rgba(10,30,60,.35);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 14px;
}
.placeModal.show{ display:flex; }
.placeCard{
  width:min(980px, 100%);
  border-radius: 18px;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.92);
  box-shadow: 0 30px 90px rgba(10,30,60,.26);
  overflow:hidden;
}
.placeCardTop{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 12px;
  border-bottom:1px solid rgba(10,30,60,.12);
  background: rgba(255,255,255,.80);
}
.placeCardTop .ttl{
  font-size: 12px; font-weight: 1000; letter-spacing:.14em; text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  max-width: calc(100% - 100px);
}
.placeClose{
  border:1px solid rgba(10,30,60,.16);
  background:#fff;
  border-radius: 12px;
  padding: 7px 10px;
  cursor:pointer;
  font-size: 11px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
}
.placeBody{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 12px;
  padding: 12px;
}
@media (max-width: 900px){ .placeBody{ grid-template-columns: 1fr; } }
.placeGallery{
  border:1px solid rgba(10,30,60,.14);
  border-radius: 16px;
  overflow:hidden;
  background: rgba(255,255,255,.72);
}
.placeGallery img{ width:100%; height: 340px; object-fit:cover; display:block; }
.placeText{
  border:1px solid rgba(10,30,60,.14);
  border-radius: 16px;
  background: rgba(255,255,255,.72);
  padding: 12px;
  min-width:0;
}
.placeText .k{ font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(10,30,60,.60); }
.placeText .v{ margin-top:6px; font-size: 12px; color: rgba(10,30,60,.86); line-height: 1.55; }
.placeActions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
.placeActions a{
  text-decoration:none;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.86);
  border-radius: 12px;
  padding: 9px 10px;
  font-size: 10.5px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
  color: rgba(10,30,60,.88);
}

/* ===== FOOTER (minimal) ===== */
footer{
  margin-top: 12px;
  border:1px solid rgba(10,30,60,.16);
  border-radius: 18px;
  background: rgba(255,255,255,.62);
  box-shadow: var(--shadow);
  backdrop-filter: blur(14px);
  overflow:hidden;
}
.footInner{ padding: 14px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
.footLeft{
  font-size: 11px;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.70);
}
.footLinks{ display:flex; gap:10px; flex-wrap:wrap; }
.footLinks a{
  font-size: 11px;
  letter-spacing:.10em;
  text-transform: uppercase;
  text-decoration:none;
  color: rgba(10,30,60,.86);
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  padding: 8px 10px;
  border-radius: 999px;
  box-shadow: 0 10px 22px rgba(10,30,60,.08);
  -webkit-tap-highlight-color: transparent;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1200px){
  .main{ grid-template-columns: 1fr; }
  .mapPane{ position:relative; top:auto; height:520px; max-height:none; min-height:520px; }
  #map{ min-height: 420px; }
  .pane{ height:auto; max-height:none; min-height:unset; }
  .heroBar{ flex-direction: column; align-items: stretch; }
  .heroRight{ justify-content:flex-start; }
}
@media (max-width: 520px){
  .shell{ padding: 10px 8px 16px; }
  .heroBar{ padding: 10px 10px; }
  .logo{ width:52px; height:52px; border-radius: 16px; }
  .chip{ padding: 8px 9px; font-size: 10.5px; }
  .waText{ display:none; }
  .waFloat{ padding: 10px; }
  .waClose{ display:none; }
}
@media (prefers-reduced-motion: reduce){
  .aurora{ animation:none; }
}
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="noise"></div>

  <!-- WhatsApp Floating CTA -->
  <a
    class="waFloat"
    id="waFloat"
    href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
    target="_blank" rel="noopener"
    aria-label="Chat on WhatsApp with Chandan Panwar"
  >
    <div class="waIcon" aria-hidden="true">
      <svg width="22" height="22" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M16 3C9.1 3 3.5 8.3 3.5 14.9c0 2.5.8 4.8 2.2 6.7L4 29l7.6-1.9c1.8 1 3.9 1.6 6.4 1.6 6.9 0 12.5-5.3 12.5-11.9S22.9 3 16 3z" fill="rgba(10,30,60,.10)"/>
        <path d="M16.1 6.1c-5.1 0-9.2 3.9-9.2 8.8 0 1.9.6 3.6 1.7 5.1l-1.1 4 4.2-1.1c1.4.8 3.1 1.3 4.9 1.3 5.1 0 9.2-3.9 9.2-8.8s-4.1-8.8-9.2-8.8z" fill="rgba(10,30,60,.12)"/>
        <path d="M23 19.1c-.3.8-1.6 1.5-2.2 1.6-.6.1-1.3.2-2.2-.1-.5-.2-1.2-.4-2-.8-3.5-1.9-5.7-5-5.9-5.3-.2-.3-1.4-1.8-1.4-3.5 0-1.7.9-2.5 1.2-2.9.3-.3.7-.4.9-.4h.7c.2 0 .5-.1.7.5.2.6.9 2.1 1 2.3.1.2.1.5 0 .7-.1.2-.2.4-.4.6-.2.2-.3.3-.5.5-.2.2-.4.4-.2.8.2.4.8 1.3 1.7 2.1 1.2 1.1 2.2 1.4 2.6 1.6.3.2.6.1.8-.1.2-.2 1-1.1 1.2-1.5.2-.4.5-.3.8-.2.3.1 2 .9 2.3 1 .3.1.5.2.6.4.1.1.1.8-.2 1.6z" fill="#0a1e3c" opacity=".92"/>
      </svg>
    </div>
    <div class="waText">
      <div class="t1">WhatsApp</div>
      <div class="t2">Chat for booking</div>
    </div>
    <div class="waClose" id="waClose" title="Hide" aria-label="Hide WhatsApp button">âœ•</div>
  </a>

  <div class="shell">
    <!-- HERO -->
    <div class="hero">
      <div class="heroMedia">
        <img src="./style/vivek-kumar-7k1IKQZikSc-unsplash.jpg" alt="Himachal Explorer" onerror="this.style.display='none';">
      </div>

      <div class="heroBar">
        <div class="heroBrand">
          <div class="logo">
            <img src="./style/logo.png" alt="Himachal Explorer Logo" onerror="this.remove(); this.parentNode.textContent='HP';">
          </div>
          <div class="brandText">
            <div class="heroTitle">Himachal Explorer Portal</div>
            <div class="heroSub" id="statusLine">Loadingâ€¦</div>
          </div>
        </div>

        <div class="heroRight">
          <div class="chip primary" id="mintLoginBtn">Mint Login</div>
          <div class="chip" id="refreshBtn">Refresh</div>
          <div class="chip" id="fitMapBtn">Fit Route</div>
          <div class="chip" id="clearRouteBtn">Clear</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- LEFT -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Trip Filters</p>
            <div class="s">Start + days + tier</div>
          </div>
          <div class="s" id="leftHint">Auto loaded</div>
        </div>

        <div class="sideInner">
          <div class="sideCard">
            <div class="field">
              <label>Start City / Pickup</label>
              <input id="startInp" list="startList" placeholder="E.g. SHIMLA / CHANDIGARH / DELHI" autocomplete="off">
              <datalist id="startList"></datalist>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Tier</label>
              <select id="visitType">
                <option value="budget">BUDGET</option>
                <option value="premium">PREMIUM</option>
                <option value="luxury">LUXURY</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Trip Duration (Days)</label>
              <select id="daysSel">
                <option value="">ANY</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                <option>11</option><option>12</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Travellers (Pax)</label>
              <select id="paxSel">
                <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
              </select>
            </div>

            <div class="btnRow">
              <button class="btn secondary" id="resetBtn" type="button">Reset</button>
              <button class="btn" id="genBtn" type="button">Show Packages</button>
            </div>

            <div class="pills" id="pills"></div>
          </div>

          <!-- âœ… LEFT: All packages list (ONLY list, center shows only selected) -->
          <div class="otherWrap">
            <div class="otherHdr">
              <div class="h">All Packages</div>
              <div class="xBtn" id="closeSelectedBtn" title="Close selected package">Close</div>
            </div>
            <div class="otherList" id="otherPkgList">
              <div class="otherHint">
                Select Start and tap <b>Show Packages</b>.<br>
                Then tap any package card to open it in the center.
              </div>
            </div>
          </div>

          <div class="sideCard">
            <div class="muted" style="text-transform:none;letter-spacing:.02em;">
              Tip: Start can be passed from index using <b>?start=SHIMLA</b>.
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Selected Package</p>
            <div class="s" id="centerHint">One package only â€¢ full details</div>
          </div>
          <div class="s" id="pkgCount">â€”</div>
        </div>

        <div class="centerInner">
          <div class="centerScroll" id="centerScroll">
            <div class="otherHint">
              No package selected yet.<br>
              Choose a package from left list to see full details here.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="pane mapPane">
        <div class="paneHdr">
          <div>
            <p class="t">Live Route Map</p>
            <div class="s">OSRM road polyline + stop pins</div>
          </div>
          <div class="s" id="kmBadge">â€”</div>
        </div>

        <div id="map"></div>

        <div class="mapTools">
          <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
          <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
          <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
        </div>
      </div>
    </div>

    <footer>
      <div class="footInner">
        <div class="footLeft">Â© <span id="yy"></span> Himachal Explorer Portal</div>
        <div class="footLinks">
          <a href="#" id="topLink">Top</a>
          <a href="./index.html">Change Mode</a>
          <a href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
             target="_blank" rel="noopener">WhatsApp</a>
        </div>
      </div>
    </footer>
  </div><!-- /shell -->

  <!-- botToast -->
  <div class="botToast" id="botToast">ðŸ‘‹ Welcome! Loadingâ€¦</div>

  <!-- Place Modal -->
  <div class="placeModal" id="placeModal" role="dialog" aria-modal="true">
    <div class="placeCard">
      <div class="placeCardTop">
        <div class="ttl" id="pmTitle">PLACE</div>
        <button class="placeClose" id="pmClose" type="button">Close</button>
      </div>
      <div class="placeBody">
        <div class="placeGallery">
          <img id="pmImg" src="" alt="Place photo" onerror="this.style.display='none'">
        </div>
        <div class="placeText">
          <div class="k">Overview</div>
          <div class="v" id="pmDesc">â€”</div>
          <div style="height:10px"></div>
          <div class="k">Details</div>
          <div class="v" id="pmMeta">â€”</div>
          <div class="placeActions" id="pmActions"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       FIREBASE LOADER (MODULE)
       Saves:
       HX_TEMPLATES, HX_PLACES, HX_COSTS
       ========================================================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    async function fetchNode(path){
      const snap = await get(child(ref(db), path));
      return snap.exists() ? snap.val() : {};
    }

    window.hxFetchFirebaseAndCache = async function(){
      const NODE_TEMPLATES  = "templates";
      const NODE_PLACES     = "places";
      const NODE_COSTS      = "package_cost_breakdown";

      const [templates, places, costs] = await Promise.all([
        fetchNode(NODE_TEMPLATES),
        fetchNode(NODE_PLACES),
        fetchNode(NODE_COSTS)
      ]);

      sessionStorage.setItem("HX_TEMPLATES", JSON.stringify(templates || {}));
      sessionStorage.setItem("HX_PLACES", JSON.stringify(places || {}));
      sessionStorage.setItem("HX_COSTS", JSON.stringify(costs || {}));

      return { templates, places, costs };
    };
  </script>

  <script>
  /* =========================================================
     DASHBOARD (Selected package only in center)
     - Packages list ALWAYS on left under filters
     - Center shows ONLY selected package details
     - Prices from template (budget/premium/luxury per person)
     - Discount smart 10â€“20% deterministic by package_id
     - Itinerary shown only if available
     - Map right (24%) OSRM route + pins
     ========================================================= */

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg){ $("statusLine").textContent = msg; }
  function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function rupees(n){ return "â‚¹" + Math.round(Number(n)||0).toLocaleString("en-IN"); }
  function slugifyName(name){
    return String(name||"")
      .trim().toLowerCase()
      .replace(/&/g," and ")
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }
  function splitCSV(x){
    return String(x||"")
      .split(",")
      .map(s=>String(s).trim())
      .filter(Boolean);
  }

  /* Toast */
  function showBot(msg){
    const el = $("botToast");
    if(!el) return;
    el.innerHTML = msg || "ðŸ‘‹ Welcome!";
    el.classList.add("show");
    clearTimeout(showBot._t);
    showBot._t = setTimeout(()=> el.classList.remove("show"), 3600);
  }

  /* ===== Images ===== */
  const IMG_BASE = "./Places/";
  const IMG_MAX = 4;

  function getPlacePhotos(place, placeId){
    const out = [];
    ["photo_1","photo_2","photo_3","photo_4","image","img","cover","photo_url"].forEach(k=>{
      const v = String(place?.[k] || "").trim();
      // If photo_1 is number flag (1), ignore
      if(v && !/^\d+$/.test(v)) out.push(v);
    });
    const pid = String(placeId || place?.place_id || place?.id || "").trim();
    if(pid){
      for(let i=1; i<=IMG_MAX; i++){
        out.push(`${IMG_BASE}${pid}_${i}.jpg`);
        out.push(`${IMG_BASE}${pid}_${i}.jpeg`);
        out.push(`${IMG_BASE}${pid}_${i}.png`);
        out.push(`${IMG_BASE}${pid}_${i}.webp`);
      }
    }
    return Array.from(new Set(out));
  }

  /* Place modal */
  function openPlaceModal({ place, dayNum, orderNum, placeId }){
    const modal = $("placeModal");
    const ttl = $("pmTitle");
    const img = $("pmImg");
    const desc = $("pmDesc");
    const meta = $("pmMeta");
    const actions = $("pmActions");

    const name = placeNameAny(place, placeId);
    const dist = districtAny(place) || "â€”";
    const lat = latAny(place), lng = lngAny(place);

    ttl.textContent = `${name} â€¢ Day ${dayNum}${orderNum ? " â€¢ Stop " + orderNum : ""}`;

    const photos = getPlacePhotos(place, placeId);
    let idx = 0;
    img.style.display = "block";
    img.onerror = ()=>{
      idx += 1;
      if(idx < photos.length){
        img.style.display = "block";
        img.src = photos[idx];
      }else{
        img.style.display = "none";
      }
    };
    img.src = photos[0] || "./style/n1.jpg";

    const short =
      String(place?.history_tagline || place?.what_you_find || place?.description || "")
      .trim() || "Beautiful spot in Himachal Pradesh. Tap directions to navigate.";

    desc.textContent = short;

    meta.innerHTML = `
      <div><b>District:</b> ${escapeHtml(dist)}</div>
      <div><b>Coordinates:</b> ${isFinite(lat)&&isFinite(lng) ? `${lat.toFixed(5)}, ${lng.toFixed(5)}` : "â€”"}</div>
      <div><b>Category:</b> ${escapeHtml(String(place?.category || "â€”"))}</div>
      <div><b>Segment:</b> ${escapeHtml(String(place?.segment || "â€”"))}</div>
      <div><b>Region:</b> ${escapeHtml(String(place?.region || "â€”"))}</div>
    `;

    const gmaps = (isFinite(lat) && isFinite(lng))
      ? `https://www.google.com/maps?q=${lat},${lng}`
      : "";

    actions.innerHTML = `
      ${gmaps ? `<a href="${gmaps}" target="_blank" rel="noopener">Open in Maps</a>` : ""}
      <a href="#" id="pmNextPhoto">Next Photo</a>
    `;

    const next = document.getElementById("pmNextPhoto");
    if(next){
      next.onclick = (e)=>{
        e.preventDefault();
        if(!photos.length) return;
        idx = (idx + 1) % photos.length;
        img.style.display = "block";
        img.src = photos[idx];
      };
    }

    modal.classList.add("show");
  }
  function closePlaceModal(){ $("placeModal")?.classList.remove("show"); }

  /* Helpers */
  function placeIdAny(p, key){ return String(p?.place_id || p?.id || key || "").trim(); }
  function placeNameAny(p, key){ return String(p?.name || p?.["Location Name"] || p?.title || key || "PLACE").trim(); }
  function latAny(p){ return Number(p?.latitude ?? p?.lat ?? p?.Latitude); }
  function lngAny(p){ return Number(p?.longitude ?? p?.lng ?? p?.Longitude); }
  function districtAny(p){ return String(p?.district || p?.District || "").trim().toUpperCase(); }
  function regionAny(p){ return String(p?.region || "").trim(); }

  function haversineKm(lat1, lon1, lat2, lon2){
    const toRad = (d)=> (d*Math.PI)/180;
    const R = 6371;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  /* Pricing from template */
  function getTierPrice(pkg, tier){
    const k = `${tier}_price_per_person`;
    const n = Number(pkg?.[k]);
    return isFinite(n) ? n : 0;
  }
  function hashCode(str){
    const s = String(str||"");
    let h = 0;
    for(let i=0;i<s.length;i++){
      h = (h<<5) - h + s.charCodeAt(i);
      h |= 0;
    }
    return Math.abs(h);
  }
  function smartDiscountPercent(packageId){
    // deterministic 10â€“20
    const h = hashCode(packageId);
    return 10 + (h % 11); // 10..20
  }

  /* ===== Map ===== */
  let map, tile, tileDark, markersLayer, routeLine;
  let showMode = "all";
  let tilesDark = false;

  function invalidateMapSoon(){
    try{
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 60);
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 260);
    }catch(e){}
  }
  function initMap(){
    map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
    tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    tile.addTo(map);
    tileDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 });
    markersLayer = L.layerGroup().addTo(map);
    invalidateMapSoon();
    window.addEventListener("resize", invalidateMapSoon, { passive:true });
  }
  function clearMap(){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    $("kmBadge").textContent = "â€”";
    invalidateMapSoon();
  }

  async function drawOSRMRoute(latlngs){
    // latlngs: [{lat,lng,name,placeId,placeObj, day, order}]
    if(!latlngs || latlngs.length < 2) return { km:0, hrs:0 };

    // OSRM expects lng,lat
    const coords = latlngs.map(p => `${p.lng},${p.lat}`).join(";");
    const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson&steps=false`;

    const res = await fetch(url);
    const data = await res.json();
    if(!data || data.code !== "Ok" || !data.routes || !data.routes[0]) return { km:0, hrs:0 };

    const r = data.routes[0];
    const km = (r.distance || 0) / 1000;
    const hrs = (r.duration || 0) / 3600;

    // Draw line
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    routeLine = L.geoJSON(r.geometry, { weight: 5, opacity: 0.9 }).addTo(map);

    // Fit
    try{
      const b = routeLine.getBounds();
      map.fitBounds(b.pad(0.15));
    }catch(e){}

    return { km, hrs };
  }

  function markerPopupHTML(p){
    const place = p.placeObj || {};
    const photos = getPlacePhotos(place, p.placeId);
    const img = photos[0] || "./style/n1.jpg";
    const short = String(place?.history_tagline || place?.what_you_find || "").trim();
    return `
      <div style="min-width:220px;max-width:260px">
        <div style="border-radius:12px;overflow:hidden;border:1px solid rgba(10,30,60,.14);margin-bottom:8px">
          <img src="${img}" style="width:100%;height:110px;object-fit:cover;display:block" onerror="this.style.display='none'"/>
        </div>
        <div style="font-weight:1000;letter-spacing:.10em;text-transform:uppercase;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.name)}</div>
        <div style="margin-top:4px;font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:rgba(10,30,60,.65)">${escapeHtml(p.tag || "")}</div>
        ${short ? `<div style="margin-top:6px;font-size:11px;color:rgba(10,30,60,.80);line-height:1.35">${escapeHtml(short).slice(0,140)}${short.length>140?"â€¦":""}</div>` : ""}
      </div>
    `;
  }

  function addMarkers(latlngs){
    markersLayer.clearLayers();
    const pts = (showMode === "se") ? [latlngs[0], latlngs[latlngs.length-1]] : latlngs;

    pts.forEach((p, idx)=>{
      const m = L.marker([p.lat, p.lng]).addTo(markersLayer);
      m.bindPopup(markerPopupHTML(p), { maxWidth: 280 });

      m.on("click", ()=>{
        openPlaceModal({ place: p.placeObj, dayNum: p.day || 1, orderNum: p.order || (idx+1), placeId: p.placeId });
      });
    });
  }

  /* ===== Data ===== */
  let TEMPLATES = {};
  let PLACES = {};
  let COSTS = {};

  let NAME_TO_ID = new Map();
  let STARTS = [];
  let ALL_TEMPL_ARR = [];
  let FILTERED_ARR = [];

  let CURRENT_KEY = "";
  let CURRENT_TIER = "budget";

  function buildNameIndex(){
    NAME_TO_ID = new Map();
    for(const [key, p] of Object.entries(PLACES||{})){
      const id = placeIdAny(p, key);
      const nm = placeNameAny(p, id);
      if(id) NAME_TO_ID.set(String(id).toLowerCase(), id);
      if(nm) NAME_TO_ID.set(String(nm).toLowerCase(), id);
      const slug = slugifyName(nm);
      if(slug && id) NAME_TO_ID.set(slug, id);
    }
  }
  function getPlaceIdByNameAny(name){
    const nm = String(name || "").trim();
    if(!nm) return "";
    const direct = NAME_TO_ID.get(nm.toLowerCase());
    if(direct && PLACES[direct]) return direct;
    const slug = slugifyName(nm);
    if(slug && PLACES[slug]) return slug;
    return "";
  }

  function buildStartList(templates){
    const counts = new Map();
    templates.forEach(t=>{
      const s = String(t.start_point || t.start || "").trim();
      if(!s) return;
      const key = s.toUpperCase();
      counts.set(key, (counts.get(key) || 0) + 1);
    });
    const arr = Array.from(counts.entries()).map(([k,v])=>({ key:k, n:v }));
    arr.sort((a,b)=> b.n - a.n || a.key.localeCompare(b.key));
    STARTS = arr.map(x=>x.key);

    const dl = $("startList");
    dl.innerHTML = "";
    arr.forEach(x=>{
      const opt = document.createElement("option");
      opt.value = x.key;
      dl.appendChild(opt);
    });
  }

  function normalizeStartInput(){
    const typed = String($("startInp").value || "").trim().toUpperCase();
    if(!typed) return "";
    const exact = STARTS.find(s => s === typed);
    if(exact) return exact;
    const partial = STARTS.find(s => s.startsWith(typed));
    if(partial) return partial;
    return typed; // allow custom
  }

  function getSelectedPax(){
    const v = Number($("paxSel")?.value || 2);
    return (isFinite(v) && v > 0) ? v : 2;
  }

  /* Session storage support */
  function loadFromIndexStorage(){
    try{
      const t = sessionStorage.getItem("HX_TEMPLATES");
      const p = sessionStorage.getItem("HX_PLACES");
      const c = sessionStorage.getItem("HX_COSTS");
      if(!t || !p || !c) return false;
      TEMPLATES = JSON.parse(t) || {};
      PLACES = JSON.parse(p) || {};
      COSTS = JSON.parse(c) || {};
      return true;
    }catch(e){
      console.warn(e);
      return false;
    }
  }

  async function loadAll(){
    setStatus("Loading dataâ€¦");
    let ok = loadFromIndexStorage();

    if(!ok){
      try{
        setStatus("Fetching from Firebaseâ€¦");
        if(typeof window.hxFetchFirebaseAndCache === "function"){
          await window.hxFetchFirebaseAndCache();
          ok = loadFromIndexStorage();
        }
      }catch(e){
        console.error("Firebase fetch failed:", e);
        ok = false;
      }
    }

    if(!ok){
      setStatus("Data not found");
      $("centerScroll").innerHTML = `
        <div class="otherHint">
          <b>Data not found.</b><br>
          Firebase blocked or rules issue.<br>
          Open DevTools console for exact error.
        </div>`;
      showBot("âŒ Firebase not loading. Check DB rules.");
      return;
    }

    buildNameIndex();

    ALL_TEMPL_ARR = Object.entries(TEMPLATES||{}).map(([k,v])=>({ key:k, ...(v||{}) }));
    buildStartList(ALL_TEMPL_ARR);

    // Pre-fill start from query
    try{
      const qs = new URLSearchParams(location.search);
      const startQS = (qs.get("start") || "").trim();
      if(startQS) $("startInp").value = String(startQS).toUpperCase();
    }catch(e){}

    // Default show packages if start exists
    const start = normalizeStartInput();
    if(start){
      applyFiltersAndRender();
    }

    setStatus("Ready");
    showBot("âœ… Data loaded");
  }

  /* Filtering */
  function applyFiltersAndRender(){
    const start = normalizeStartInput();
    const days = String($("daysSel").value || "").trim();
    CURRENT_TIER = String($("visitType").value || "budget").toLowerCase();

    // Pills
    const pills = [];
    if(start) pills.push(`<span class="pill"><b>Start</b> ${escapeHtml(start)}</span>`);
    if(days) pills.push(`<span class="pill"><b>Days</b> ${escapeHtml(days)}</span>`);
    pills.push(`<span class="pill"><b>Tier</b> ${escapeHtml(CURRENT_TIER)}</span>`);
    $("pills").innerHTML = pills.join("");

    // Filter
    FILTERED_ARR = ALL_TEMPL_ARR.filter(t=>{
      const sp = String(t.start_point || t.start || "").trim().toUpperCase();
      const d = String(t.days || "").trim();
      if(start && sp && sp !== start) return false;
      if(days && d && d !== days) return false;
      return true;
    });

    // Sort by price (selected tier) ascending
    FILTERED_ARR.sort((a,b)=>{
      const pa = getTierPrice(a, CURRENT_TIER);
      const pb = getTierPrice(b, CURRENT_TIER);
      if(pa !== pb) return pa - pb;
      return String(a.package_name||a.route_name||a.key).localeCompare(String(b.package_name||b.route_name||b.key));
    });

    $("pkgCount").textContent = `${FILTERED_ARR.length} found`;

    // Render left list
    renderLeftPackageList();

    // Auto select first if none selected or not in filtered
    if(!CURRENT_KEY || !FILTERED_ARR.find(x=>x.key === CURRENT_KEY)){
      if(FILTERED_ARR[0]){
        selectPackage(FILTERED_ARR[0].key);
      }else{
        CURRENT_KEY = "";
        $("centerScroll").innerHTML = `
          <div class="otherHint">
            No packages found for these filters.<br>
            Try changing Start/Days.
          </div>`;
        clearMap();
      }
    }else{
      // Re-render selected with new tier
      renderSelected(CURRENT_KEY);
    }
  }

  function renderLeftPackageList(){
    const list = $("otherPkgList");
    if(!FILTERED_ARR.length){
      list.innerHTML = `
        <div class="otherHint">
          No packages yet for selected filters.
        </div>`;
      return;
    }

    const pax = getSelectedPax();
    const tier = CURRENT_TIER;

    list.innerHTML = FILTERED_ARR.map(t=>{
      const name = String(t.package_name || t.route_name || t.key || "PACKAGE");
      const district = String(t.district || "").toUpperCase();
      const days = Number(t.days || 0) || 0;
      const drive = String(t.drive_level || "").toUpperCase();
      const base = getTierPrice(t, tier);
      const disc = smartDiscountPercent(t.package_id || t.key);
      const finalP = Math.round(base * (1 - disc/100));
      const total = finalP * pax;

      return `
        <div class="pkgSide ${t.key===CURRENT_KEY?"active":""}" data-key="${escapeHtml(t.key)}">
          <div class="pkgSideTop">
            <div class="t1" title="${escapeHtml(name)}">${escapeHtml(name)}</div>
            <div class="badge blue">${disc}% OFF</div>
          </div>
          <div class="pkgSideRow">
            ${district ? `<span>${escapeHtml(district)}</span>` : ""}
            ${days ? `<span>${days}D</span>` : ""}
            ${drive ? `<span>${escapeHtml(drive)}</span>` : ""}
          </div>
          <div class="pkgSidePrice">
            ${rupees(finalP)} / person â€¢ ${rupees(total)} for ${pax} pax
          </div>
        </div>
      `;
    }).join("");

    // Click handler
    Array.from(list.querySelectorAll(".pkgSide")).forEach(el=>{
      el.addEventListener("click", ()=>{
        const k = el.getAttribute("data-key");
        if(k) selectPackage(k);
      }, { passive:true });
    });
  }

  /* Selected package */
  function getDayPlaceIds(pkg, dayNo){
    return splitCSV(pkg?.[`day${dayNo}_place_ids`]);
  }

  function getStopsFromItinerary(pkg){
    const daysN = Number(pkg.days || 0) || 0;
    const out = [];
    let order = 0;
    for(let d=1; d<=Math.max(daysN, 1); d++){
      const ids = getDayPlaceIds(pkg, d);
      ids.forEach(id=>{
        const pid = String(id||"").trim();
        const place = PLACES[pid] || PLACES[getPlaceIdByNameAny(pid)] || null;
        const lat = latAny(place), lng = lngAny(place);
        if(isFinite(lat) && isFinite(lng)){
          order += 1;
          out.push({ lat, lng, name: placeNameAny(place, pid), placeId: pid, placeObj: place, day: d, order });
        }
      });
    }
    return out;
  }

  function pickCoverPhotoFromPackage(pkg){
    // Try: major_place_ids first
    const majors = splitCSV(pkg.major_place_ids);
    const first = majors[0] || getDayPlaceIds(pkg, 1)[0] || "";
    const pid = first ? String(first).trim() : "";
    const place = PLACES[pid] || PLACES[getPlaceIdByNameAny(pid)] || null;
    const photos = getPlacePhotos(place, pid);
    return photos[0] || "./style/n1.jpg";
  }

  function renderDayBlock(dayNo, placeIds){
    const buttons = placeIds.map((pid, idx)=>{
      const place = PLACES[pid] || PLACES[getPlaceIdByNameAny(pid)] || {};
      const nm = placeNameAny(place, pid);
      const reg = regionAny(place) || String(place?.segment || "").trim();
      const tag = districtAny(place) || String(place?.category || "").toUpperCase();
      return `
        <button class="placeBtn" type="button"
          data-place="${escapeHtml(pid)}"
          data-day="${dayNo}"
          data-order="${idx+1}"
        >
          <div class="left">
            <div class="nm">${escapeHtml(nm)}</div>
            <div class="sm">${escapeHtml(reg || "Himachal Pradesh")}</div>
          </div>
          <div class="tag">${escapeHtml(tag || "STOP")}</div>
        </button>
      `;
    }).join("");

    return `
      <div class="itDay">
        <div class="itDayTop">
          <div class="d">Day ${dayNo}</div>
          <div class="muted">${placeIds.length} stops</div>
        </div>
        ${buttons}
        <div class="nearWrap" id="nearWrap_${dayNo}">
          <div class="nearTop">
            <div class="k">Nearby places</div>
            <div class="muted" style="text-transform:uppercase">Tap to open</div>
          </div>
          <div class="nearCircles" id="nearCircles_${dayNo}"></div>
        </div>
      </div>
    `;
  }

  function computeNearbyForDay(dayNo, dayPlaceIds){
    // choose first stop as anchor if possible
    const anchorId = dayPlaceIds[0] || "";
    const anchorPlace = PLACES[anchorId] || PLACES[getPlaceIdByNameAny(anchorId)] || null;
    const al = latAny(anchorPlace), ag = lngAny(anchorPlace);
    if(!isFinite(al) || !isFinite(ag)) return [];

    const daySet = new Set(dayPlaceIds.map(x=>String(x)));
    const district = districtAny(anchorPlace);
    const region = regionAny(anchorPlace);

    const candidates = [];
    for(const [pid, p] of Object.entries(PLACES||{})){
      if(daySet.has(pid)) continue;
      const lat = latAny(p), lng = lngAny(p);
      if(!isFinite(lat) || !isFinite(lng)) continue;

      // prefer same district/region first
      const distOk = district && districtAny(p) === district;
      const regOk = region && regionAny(p) === region;

      const km = haversineKm(al, ag, lat, lng);
      // keep within 50km
      if(km > 50) continue;

      candidates.push({
        pid,
        place: p,
        score: (distOk ? -20 : 0) + (regOk ? -10 : 0) + km
      });
    }

    candidates.sort((a,b)=> a.score - b.score);
    return candidates.slice(0, 8);
  }

  function renderNearbyIntoDay(dayNo, pkg){
    const ids = getDayPlaceIds(pkg, dayNo);
    const out = computeNearbyForDay(dayNo, ids);
    const box = document.getElementById(`nearCircles_${dayNo}`);
    if(!box) return;

    if(!out.length){
      box.innerHTML = `<div class="muted" style="grid-column:1/-1;text-transform:none;letter-spacing:.02em;">No nearby places found for this day yet.</div>`;
      return;
    }

    box.innerHTML = out.map(o=>{
      const photos = getPlacePhotos(o.place, o.pid);
      const img = photos[0] || "./style/n1.jpg";
      const nm = placeNameAny(o.place, o.pid);
      return `
        <div class="nearItem" data-place="${escapeHtml(o.pid)}" data-day="${dayNo}" data-order="0">
          <div class="nearCircle">
            <img src="${img}" alt="${escapeHtml(nm)}" onerror="this.src='./style/n1.jpg'">
          </div>
          <div class="nearName" title="${escapeHtml(nm)}">${escapeHtml(nm)}</div>
        </div>
      `;
    }).join("");

    Array.from(box.querySelectorAll(".nearItem")).forEach(el=>{
      el.addEventListener("click", ()=>{
        const pid = el.getAttribute("data-place");
        const day = Number(el.getAttribute("data-day") || dayNo);
        const place = PLACES[pid] || PLACES[getPlaceIdByNameAny(pid)] || {};
        openPlaceModal({ place, dayNum: day, orderNum: 0, placeId: pid });
      }, { passive:true });
    });
  }

  function renderCostBreakdown(pkgKey){
    // COSTS node optional. If exists, show a simple table-like list.
    const node = COSTS?.[pkgKey] || COSTS?.[String(pkgKey||"")] || null;
    if(!node) return "";

    const entries = Object.entries(node || {});
    if(!entries.length) return "";

    const rows = entries.slice(0, 18).map(([k,v])=>{
      const label = String(k||"").replace(/_/g," ").toUpperCase();
      const valNum = Number(v);
      const val = isFinite(valNum) ? rupees(valNum) : escapeHtml(String(v));
      return `<div class="priceRow" style="margin-top:6px"><div class="muted" style="text-transform:uppercase">${escapeHtml(label)}</div><div style="font-weight:1000">${val}</div></div>`;
    }).join("");

    return `
      <div style="height:10px"></div>
      <div class="muted" style="text-transform:uppercase">Costing (if available)</div>
      ${rows}
    `;
  }

  async function renderSelected(key){
    const pkg = ALL_TEMPL_ARR.find(x=>x.key===key);
    if(!pkg){
      $("centerScroll").innerHTML = `<div class="otherHint">Package not found.</div>`;
      return;
    }

    const tier = CURRENT_TIER;
    const pax = getSelectedPax();

    const name = String(pkg.package_name || pkg.route_name || pkg.key || "PACKAGE");
    const district = String(pkg.district || "").toUpperCase();
    const daysN = Number(pkg.days || 0) || 0;
    const drive = String(pkg.drive_level || "").toUpperCase();
    const routeId = String(pkg.route_id || "").toUpperCase().trim();
    const routePath = String(pkg.route_path || pkg.route_name || "").trim();

    const b = getTierPrice(pkg, "budget");
    const p = getTierPrice(pkg, "premium");
    const l = getTierPrice(pkg, "luxury");

    const disc = smartDiscountPercent(pkg.package_id || pkg.key);
    const base = getTierPrice(pkg, tier);
    const finalPer = Math.round(base * (1 - disc/100));
    const total = finalPer * pax;

    const cover = pickCoverPhotoFromPackage(pkg);

    // Itinerary HTML
    let itinHTML = "";
    for(let d=1; d<=Math.max(daysN, 1); d++){
      const ids = getDayPlaceIds(pkg, d);
      if(ids.length){
        itinHTML += renderDayBlock(d, ids);
      }
    }
    if(!itinHTML){
      itinHTML = `<div class="itDay"><div class="muted" style="text-transform:none;letter-spacing:.02em;">Itinerary not available for this package yet.</div></div>`;
    }

    $("centerScroll").innerHTML = `
      <div class="selWrap">
        <div class="selTop">
          <div class="selMedia">
            <img src="${cover}" alt="${escapeHtml(name)}" onerror="this.src='./style/n1.jpg'">
          </div>
          <div class="selInfo">
            <div class="selTitleRow">
              <h3 class="selTitle" title="${escapeHtml(name)}">${escapeHtml(name)}</h3>
            </div>

            <div class="selBadges">
              ${district ? `<span class="badgePill blue">${escapeHtml(district)}</span>` : ""}
              ${daysN ? `<span class="badgePill green">${daysN} DAYS</span>` : ""}
              ${drive ? `<span class="badgePill orange">${escapeHtml(drive)} DRIVE</span>` : ""}
              ${routeId ? `<span class="badgePill">${escapeHtml(routeId)}</span>` : ""}
            </div>

            ${routePath ? `<div class="routeLine"><b>Route:</b> ${escapeHtml(routePath)}</div>` : ""}

            <div class="enqRow">
              <a class="enqBtn"
                 href="https://wa.me/917018138847?text=${encodeURIComponent(`Hi Chandan, I want to book: ${name}. Tier: ${tier.toUpperCase()}, Pax: ${pax}. Price per person: â‚¹${finalPer} (after ${disc}% off). Start: ${pkg.start_point || pkg.start || ""}.`)}"
                 target="_blank" rel="noopener">
                WhatsApp Booking
              </a>
            </div>
          </div>
        </div>

        <div class="detailsGrid">
          <div class="detailsCard">
            <div class="bigTitle">Pricing (from template)</div>

            <div style="height:10px"></div>

            <div class="priceRow">
              <button class="tierBtn ${tier==='budget'?'active':''}" data-tier="budget" type="button">Budget</button>
              <div style="font-weight:1000;letter-spacing:.06em">${rupees(b||0)}</div>
            </div>

            <div class="priceRow" style="margin-top:6px">
              <button class="tierBtn ${tier==='premium'?'active':''}" data-tier="premium" type="button">Premium</button>
              <div style="font-weight:1000;letter-spacing:.06em">${rupees(p||0)}</div>
            </div>

            <div class="priceRow" style="margin-top:6px">
              <button class="tierBtn ${tier==='luxury'?'active':''}" data-tier="luxury" type="button">Luxury</button>
              <div style="font-weight:1000;letter-spacing:.06em">${rupees(l||0)}</div>
            </div>

            <div style="height:10px"></div>

            <div class="priceRow">
              <div class="priceOld">${rupees(base)}</div>
              <div class="discPill">${disc}% OFF</div>
            </div>

            <div class="priceNew">${rupees(finalPer)} <span style="font-size:12px;font-weight:950;letter-spacing:.10em;text-transform:uppercase;color:rgba(10,30,60,.70)">/ person</span></div>
            <div class="priceSmall">Total for ${pax} pax: <b>${rupees(total)}</b></div>

            ${renderCostBreakdown(pkg.key)}

            <div class="priceSmall" style="margin-top:10px">
              Discount is auto-decided (10â€“20%) per package for smart offers.
            </div>
          </div>

          <div class="detailsCard">
            <div class="bigTitle">Itinerary</div>
            <div class="muted" style="margin-top:6px">${daysN ? `${daysN} days` : "â€”"} â€¢ Tap places to open details</div>

            <div class="itinDays">
              ${itinHTML}
            </div>

            ${pkg.important_notes ? `<div class="priceSmall" style="margin-top:10px"><b>Note:</b> ${escapeHtml(pkg.important_notes)}</div>` : ""}
          </div>
        </div>
      </div>
    `;

    // Wire tier buttons
    Array.from(document.querySelectorAll(".tierBtn")).forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const t = btn.getAttribute("data-tier");
        if(!t) return;
        $("visitType").value = t;
        CURRENT_TIER = t;
        applyFiltersAndRender(); // updates left list + re-render selected
      }, { passive:true });
    });

    // Wire place buttons
    Array.from(document.querySelectorAll(".placeBtn")).forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const pid = btn.getAttribute("data-place") || "";
        const day = Number(btn.getAttribute("data-day") || 1);
        const ord = Number(btn.getAttribute("data-order") || 1);
        const place = PLACES[pid] || PLACES[getPlaceIdByNameAny(pid)] || {};
        openPlaceModal({ place, dayNum: day, orderNum: ord, placeId: pid });
      }, { passive:true });
    });

    // Render nearby circles for each day that exists
    for(let d=1; d<=Math.max(daysN, 1); d++){
      const ids = getDayPlaceIds(pkg, d);
      if(ids.length) renderNearbyIntoDay(d, pkg);
    }

    // Map route + pins
    await updateMapForPackage(pkg);

    // Update left highlight
    renderLeftPackageList();
  }

  async function updateMapForPackage(pkg){
    clearMap();

    // Prefer itinerary stops
    const stops = getStopsFromItinerary(pkg);

    // If no itinerary stops, fallback to start/end coords if present in template
    let latlngs = stops;

    if(!latlngs.length){
      const lat = Number(pkg.latitude), lng = Number(pkg.longitude);
      if(isFinite(lat) && isFinite(lng)){
        latlngs = [{ lat, lng, name: pkg.end_point || pkg.district || "STOP", placeId:"", placeObj:null, day:1, order:1 }];
      }
    }

    if(latlngs.length){
      addMarkers(latlngs);

      // Draw route only if 2+ points
      let km = 0, hrs = 0;
      if(latlngs.length >= 2){
        try{
          const out = await drawOSRMRoute(latlngs);
          km = out.km || 0;
          hrs = out.hrs || 0;
        }catch(e){
          console.warn("OSRM failed", e);
        }
      }else{
        // Fit single marker
        try{ map.setView([latlngs[0].lat, latlngs[0].lng], 11); }catch(e){}
      }

      const kmTxt = km ? `${km.toFixed(0)} km` : "â€”";
      const hrTxt = hrs ? `${hrs.toFixed(1)} hrs` : "";
      $("kmBadge").textContent = hrTxt ? `${kmTxt} â€¢ ${hrTxt}` : kmTxt;
      invalidateMapSoon();
    }else{
      $("kmBadge").textContent = "â€”";
      invalidateMapSoon();
    }
  }

  function selectPackage(key){
    CURRENT_KEY = key;
    showBot("âœ… Package selected");
    renderSelected(key);
  }

  /* UI wiring */
  function wireUI(){
    $("yy").textContent = new Date().getFullYear();

    $("pmClose").onclick = closePlaceModal;
    $("placeModal").addEventListener("click", (e)=>{
      if(e.target === $("placeModal")) closePlaceModal();
    });

    $("waClose").onclick = (e)=>{
      e.preventDefault(); e.stopPropagation();
      $("waFloat").style.display = "none";
      showBot("âœ… WhatsApp button hidden");
    };

    $("topLink").onclick = (e)=>{ e.preventDefault(); window.scrollTo({top:0, behavior:"smooth"}); };

    $("refreshBtn").onclick = async ()=>{
      showBot("ðŸ”„ Refreshing dataâ€¦");
      try{
        sessionStorage.removeItem("HX_TEMPLATES");
        sessionStorage.removeItem("HX_PLACES");
        sessionStorage.removeItem("HX_COSTS");
      }catch(e){}
      await loadAll();
      applyFiltersAndRender();
    };

    $("fitMapBtn").onclick = ()=>{
      try{
        if(routeLine){
          map.fitBounds(routeLine.getBounds().pad(0.15));
        }else{
          map.setView([31.1048, 77.1734], 8);
        }
      }catch(e){}
    };

    $("clearRouteBtn").onclick = ()=>{
      clearMap();
      showBot("ðŸ§¹ Map cleared");
    };

    $("toggleTilesBtn").onclick = ()=>{
      tilesDark = !tilesDark;
      try{
        if(tilesDark){
          map.removeLayer(tile);
          tileDark.addTo(map);
        }else{
          map.removeLayer(tileDark);
          tile.addTo(map);
        }
      }catch(e){}
    };

    $("showAllStopsBtn").onclick = ()=>{
      showMode = "all";
      if(CURRENT_KEY){
        const pkg = ALL_TEMPL_ARR.find(x=>x.key===CURRENT_KEY);
        if(pkg) updateMapForPackage(pkg);
      }
    };

    $("showStartEndBtn").onclick = ()=>{
      showMode = "se";
      if(CURRENT_KEY){
        const pkg = ALL_TEMPL_ARR.find(x=>x.key===CURRENT_KEY);
        if(pkg) updateMapForPackage(pkg);
      }
    };

    $("genBtn").onclick = ()=>{
      applyFiltersAndRender();
      showBot("âœ… Packages loaded in left list");
    };

    $("resetBtn").onclick = ()=>{
      $("daysSel").value = "";
      $("visitType").value = "budget";
      CURRENT_TIER = "budget";
      applyFiltersAndRender();
      showBot("âœ… Filters reset");
    };

    $("paxSel").onchange = ()=>{
      // update list + selected totals
      applyFiltersAndRender();
    };

    $("closeSelectedBtn").onclick = ()=>{
      CURRENT_KEY = "";
      $("centerScroll").innerHTML = `
        <div class="otherHint">
          Package closed.<br>
          Select another package from left list.
        </div>`;
      clearMap();
      renderLeftPackageList();
    };
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      wireUI();
      initMap();
      await loadAll();
    }catch(err){
      console.error(err);
      setStatus("Error loading");
      showBot("âŒ Error. Check console.");
    }
  });
  </script>
</body>
</html>