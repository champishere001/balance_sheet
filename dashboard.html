<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="light"/>
  <title>Himachal Tour Packages | Dashboard</title>
  <meta name="description" content="Himachal tour packages dashboard with pricing, itinerary, and live route map." />
  <meta name="theme-color" content="#EAF3FF" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg0:#F6FAFF;
      --bg1:#EAF3FF;
      --card: rgba(255,255,255,.62);
      --stroke: rgba(10,30,60,.16);
      --muted: rgba(10,30,60,.62);
      --text: rgba(10,30,60,.92);
      --shadow: 0 18px 70px rgba(10,30,60,.14);
      --radius: 16px;
      --acc:#2563EB;
      --gap: 12px;
      --shellW: min(94vw, 1700px);
      --heroH: clamp(200px, 24vw, 300px);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 520px at 20% 0%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(14,165,233,.10), transparent 62%),
        radial-gradient(900px 520px at 50% 92%, rgba(59,130,246,.08), transparent 64%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    .aurora{
      position:fixed; inset:-30%;
      background:
        radial-gradient(900px 500px at 25% 30%, rgba(37,99,235,.12), transparent 66%),
        radial-gradient(900px 520px at 75% 25%, rgba(14,165,233,.10), transparent 68%),
        radial-gradient(860px 540px at 55% 75%, rgba(59,130,246,.08), transparent 70%);
      filter: blur(50px); opacity:.85; animation: drift 14s ease-in-out infinite;
      pointer-events:none; z-index:-3;
      transform: translateZ(0);
    }
    @keyframes drift{
      0%,100%{transform:translate3d(0,0,0) scale(1);}
      50%{transform:translate3d(3%,-2%,0) scale(1.06);}
    }
    .noise{
      position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.06; mix-blend-mode:multiply;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }

    .shell{ width: var(--shellW); margin: 0 auto; padding: 12px 10px 18px; }

    /* ===== HERO ===== */
    .hero{
      border-radius: 22px; border:1px solid var(--stroke);
      overflow:hidden; position:relative; box-shadow: var(--shadow);
      background: rgba(255,255,255,.62);
    }
    .heroMedia{ height: var(--heroH); position:relative; overflow:hidden; background: rgba(255,255,255,.62); }
    .heroMedia img{ width:100%; height:100%; object-fit:cover; display:block; transform: translateZ(0); }
    .heroMedia::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.28), rgba(255,255,255,.10), rgba(255,255,255,.24));
      pointer-events:none;
    }
    .heroBar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 14px;
      background: rgba(255,255,255,.66);
      border-top:1px solid rgba(10,30,60,.14);
      backdrop-filter: blur(14px);
      flex-wrap:wrap;
    }
    .heroBrand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:56px; height:56px; border-radius:16px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(10,30,60,.16);
      display:grid; place-items:center; overflow:hidden;
      box-shadow: 0 14px 34px rgba(10,30,60,.12);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brandText{ min-width:0; }
    .heroTitle{
      margin:0;
      font-size: clamp(16px, 2.1vw, 22px);
      letter-spacing:.14em; text-transform: uppercase;
      font-weight: 1000; color: rgba(10,30,60,.96);
      line-height: 1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .heroSub{
      margin:7px 0 0;
      font-size: 12px; color: rgba(10,30,60,.70);
      letter-spacing:.08em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .heroRight{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; flex:0 0 auto; }

    .chip{
      border:1px solid rgba(10,30,60,.18);
      background: rgba(255,255,255,.62);
      color: rgba(10,30,60,.82);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.10em;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer; user-select:none;
      box-shadow: 0 10px 24px rgba(10,30,60,.10);
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .chip.primary{
      border-color: rgba(37,99,235,.40);
      background: rgba(37,99,235,.16);
      color: rgba(10,30,60,.92);
      font-weight: 950;
    }

    /* =========================================================
       MAIN LAYOUT (LEFT 22% | CENTER 54% | RIGHT 24%)
       ========================================================= */
    .main{
      display:grid;
      grid-template-columns: 22% 54% 24%;
      gap: var(--gap);
      margin-top: 12px;
      align-items: stretch;
      min-width:0;
      grid-template-areas: "left center map";
    }

    .pane{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.56));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width: 0;
      min-height: 0;
      height: calc(100vh - 24px);
      min-height: 640px;
      max-height: 920px;
    }
    .paneHdr{
      padding: 10px 12px;
      border-bottom:1px solid rgba(10,30,60,.14);
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.62);
    }
    .paneHdr .t{ margin:0; font-size:11px; letter-spacing:.18em; text-transform: uppercase; font-weight: 950; }
    .paneHdr .s{ font-size:10.5px; color:var(--muted); letter-spacing:.10em; text-transform: uppercase; }

    /* ===== LEFT ===== */
    .leftPane{ grid-area:left; }
    .sideInner{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .sideCard{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 12px 36px rgba(10,30,60,.10);
    }
    .field label{
      display:block; font-size: 10.5px; color: var(--muted);
      text-transform: uppercase; letter-spacing:.12em; margin:0 0 6px 2px;
    }
    input, select{
      width:100%; padding: 10px 10px; border-radius: 12px;
      border: 1px solid rgba(10,30,60,.18);
      background: rgba(255,255,255,.82);
      color: rgba(10,30,60,.92);
      outline:none; font-size: 13px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    input:focus, select:focus{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.16); }
    .btnRow{ display:flex; gap:8px; margin-top:8px; }
    .btn{
      flex:1; padding: 10px 10px; border-radius: 12px;
      border: 1px solid rgba(37,99,235,.30);
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(14,165,233,.72));
      color:#fff; font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
      cursor:pointer; font-size: 11px;
      box-shadow: 0 14px 34px rgba(37,99,235,.18);
      -webkit-tap-highlight-color: transparent;
    }
    .btn.secondary{
      border: 1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.86);
      box-shadow: 0 10px 24px rgba(10,30,60,.10);
    }

    .otherWrap{ flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
    .otherHdr{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 14px;
      padding: 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 10px 24px rgba(10,30,60,.10);
    }
    .otherHdr .h{ font-size: 11px; font-weight: 950; letter-spacing:.14em; text-transform: uppercase; }
    .otherHdr .xBtn{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.86);
      border-radius: 12px;
      padding: 7px 10px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .otherList{
      flex:1; min-height:0; overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 2px;
      display:flex; flex-direction:column; gap:8px;
    }
    .otherHint{
      border:1px dashed rgba(10,30,60,.20);
      background: rgba(255,255,255,.58);
      border-radius: 14px;
      padding: 10px;
      color: rgba(10,30,60,.72);
      font-size: 11px;
      line-height: 1.35;
    }
    .pkgSide{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.70);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 20px rgba(10,30,60,.08);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      -webkit-tap-highlight-color: transparent;
    }
    .pkgSide.active{
      border-color: rgba(37,99,235,.40);
      box-shadow: 0 0 0 3px rgba(37,99,235,.14);
      background: rgba(37,99,235,.10);
    }
    .pkgSideTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .pkgSideTop .t1{
      font-size: 10.5px;
      font-weight: 1000;
      letter-spacing:.12em;
      text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pkgSideRow{
      display:flex; gap:8px; flex-wrap:wrap;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(10,30,60,.72);
    }
    .pkgSideRow span{
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.66);
      border-radius: 999px;
      padding: 6px 8px;
      white-space: nowrap;
    }

    /* ===== CENTER (Selected package only) ===== */
    .centerPane{ grid-area:center; }
    .centerScroll{
      flex:1; min-height:0; overflow:auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(255,255,255,.52);
    }
    .emptyState{
      margin: 12px;
      border:1px dashed rgba(10,30,60,.20);
      background: rgba(255,255,255,.58);
      border-radius: 16px;
      padding: 12px;
      color: rgba(10,30,60,.72);
      font-size: 12px;
      line-height: 1.5;
    }

    /* Header full width + photo reduced ~10% */
    .selHeader{
      display:grid;
      grid-template-columns: 44% 56%;
      gap: 12px;
      padding: 12px;
      background: rgba(255,255,255,.66);
      border-bottom:1px solid rgba(10,30,60,.14);
    }
    @media (max-width: 980px){ .selHeader{ grid-template-columns: 1fr; } }
    .selImg{
      height: 225px; /* photo reduced */
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(10,30,60,.12);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.78), rgba(37,99,235,.12));
    }
    .selImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    .selTitleBox{ min-width:0; display:flex; flex-direction:column; gap:10px; }
    .selTitle{
      margin:0;
      font-size: 12px;
      font-weight: 1100;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(10,30,60,.94);
    }
    .metaChips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip2{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(10,30,60,.78);
      white-space: nowrap;
      font-weight: 950;
    }
    .metaLine{
      font-size: 11px;
      color: rgba(10,30,60,.72);
      letter-spacing:.06em;
      line-height:1.45;
    }
    .waBig{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      border:1px solid rgba(34,197,94,.30);
      background: rgba(34,197,94,.14);
      color: rgba(10,30,60,.92);
      border-radius: 14px;
      padding: 10px 10px;
      text-decoration:none;
      text-transform: uppercase;
      letter-spacing:.10em;
      font-weight: 1100;
      font-size: 11px;
      box-shadow: 0 12px 28px rgba(34,197,94,.14);
      width: fit-content;
    }

    /* Pricing first */
    .costBoxFull{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.70);
      border-radius: 16px;
      padding: 12px;
      margin: 12px;
      box-shadow: 0 12px 34px rgba(10,30,60,.10);
    }
    .costHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .costTitle{
      margin:0;
      font-size: 11px;
      font-weight: 1100;
      letter-spacing:.16em;
      text-transform: uppercase;
    }
    .offPill{
      border:1px solid rgba(34,197,94,.30);
      background: rgba(34,197,94,.14);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 1100;
      white-space: nowrap;
    }
    .priceRows .priceRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 0;
      border-top:1px solid rgba(10,30,60,.10);
    }
    .priceRows .priceRow:first-child{ border-top:none; padding-top:0; }
    .k{
      font-size: 10px;
      letter-spacing:.14em;
      text-transform: uppercase;
      color: rgba(10,30,60,.62);
      font-weight: 900;
    }
    .v{
      font-size: 12px;
      font-weight: 1100;
      letter-spacing:.06em;
      color: rgba(10,30,60,.92);
      text-align:right;
    }
    .strike{ text-decoration: line-through; opacity:.65; margin-right:8px; }
    .totalRow{
      margin-top:6px;
      border-top:1px solid rgba(10,30,60,.14);
      padding-top:10px;
    }
    .totalRow .v{ font-size:16px; }
    .priceNotes{
      margin-top:10px;
      border:1px dashed rgba(10,30,60,.18);
      background: rgba(255,255,255,.58);
      border-radius: 14px;
      padding: 10px;
      font-size: 11px;
      line-height: 1.45;
      color: rgba(10,30,60,.74);
    }

    /* Compact itinerary after pricing */
    .itinCompact{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.70);
      border-radius: 16px;
      padding: 12px;
      margin: 0 12px 12px;
      box-shadow: 0 12px 34px rgba(10,30,60,.10);
    }
    .itinHead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .itinHead .t{
      margin:0;
      font-size: 11px;
      font-weight: 1100;
      letter-spacing:.16em;
      text-transform: uppercase;
    }
    .dayCompact{
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
      margin-top:10px;
    }
    .dayTitle{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-weight:1100;
      font-size:11px;
      letter-spacing:.14em;
      text-transform: uppercase;
    }
    .stopChips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .stopChip{
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.66);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    details.dayDetails{ margin-top:8px; }
    details.dayDetails summary{
      cursor:pointer;
      font-size:10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(10,30,60,.72);
      font-weight: 1000;
    }

    .placeBtn{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      width:100%;
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(10,30,60,.08);
      margin-top: 8px;
      text-align:left;
    }
    .placeBtn .left{ min-width:0; }
    .placeBtn .nm{
      font-size: 11px; font-weight: 1100; letter-spacing:.10em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .placeBtn .sm{
      margin-top:4px; font-size: 10px; color: rgba(10,30,60,.62);
      letter-spacing:.08em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .placeBtn .tag{
      border:1px solid rgba(37,99,235,.30);
      background: rgba(37,99,235,.12);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 1100;
      white-space: nowrap;
      flex:0 0 auto;
    }

    /* Nearby suggestions (circular) */
    .nearWrap{
      margin-top:10px;
      border:1px dashed rgba(10,30,60,.18);
      background: rgba(255,255,255,.58);
      border-radius: 14px;
      padding: 10px;
    }
    .nearTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px; }
    .nearTop .k{
      font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(10,30,60,.62);
      font-weight: 1100;
    }
    .nearCards{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .nearCircle{
      width:74px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      text-align:center;
    }
    .nearCircle .img{
      width:60px; height:60px; border-radius:999px;
      overflow:hidden; margin: 0 auto;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
    }
    .nearCircle img{ width:100%; height:100%; object-fit:cover; display:block; }
    .nearCircle .nm{
      margin-top:6px;
      font-size:10px;
      font-weight:1100;
      letter-spacing:.10em;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: rgba(10,30,60,.86);
    }

    /* ===== MAP (RIGHT 24%) ===== */
    .mapPane{ grid-area:map; position: sticky; top: 12px; }
    #map{
      width:100%;
      flex:1;
      min-height: 520px;
      background: rgba(255,255,255,.62);
      border-radius: 14px;
    }
    .mapTools{
      padding: 10px 12px;
      border-top:1px solid rgba(10,30,60,.14);
      display:flex; gap:8px; flex-wrap:wrap;
      background: rgba(255,255,255,.62);
    }
    .toolBtn{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.86);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none; white-space: nowrap;
      box-shadow: 0 10px 20px rgba(10,30,60,.08);
    }

    /* ===== BOT TOAST ===== */
    .botToast{
      position:fixed; left: 14px; bottom: 14px; z-index: 9999;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.74);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(10,30,60,.86);
      font-size: 11px;
      letter-spacing:.08em;
      box-shadow: 0 26px 70px rgba(10,30,60,.16);
      display:none;
      max-width: min(520px, calc(100vw - 28px));
    }
    .botToast.show{ display:block; }

    /* ===== PLACE MODAL ===== */
    .placeModal{
      position:fixed; inset:0; z-index: 20000;
      background: rgba(10,30,60,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }
    .placeModal.show{ display:flex; }
    .placeCard{
      width:min(980px, 100%);
      border-radius: 18px;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.92);
      box-shadow: 0 30px 90px rgba(10,30,60,.26);
      overflow:hidden;
    }
    .placeCardTop{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-bottom:1px solid rgba(10,30,60,.12);
      background: rgba(255,255,255,.80);
    }
    .placeCardTop .ttl{
      font-size: 12px; font-weight: 1100; letter-spacing:.14em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: calc(100% - 110px);
    }
    .placeClose{
      border:1px solid rgba(10,30,60,.16);
      background:#fff;
      border-radius: 12px;
      padding: 7px 10px;
      cursor:pointer;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 1100;
    }
    .placeBody{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 900px){ .placeBody{ grid-template-columns: 1fr; } }
    .placeGallery{
      border:1px solid rgba(10,30,60,.14);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.72);
    }
    .placeGallery img{ width:100%; height: 340px; object-fit:cover; display:block; }
    .placeText{
      border:1px solid rgba(10,30,60,.14);
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      padding: 12px;
      min-width:0;
    }
    .placeText .kk{ font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(10,30,60,.60); }
    .placeText .vv{ margin-top:6px; font-size: 12px; color: rgba(10,30,60,.86); line-height: 1.55; }
    .placeActions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .placeActions a{
      text-decoration:none;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.86);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 1100;
      color: rgba(10,30,60,.88);
    }

    /* ===== PHONE COMPATIBILITY (stack + center first) ===== */
    @media (max-width: 1100px){
      .main{
        grid-template-columns: 1fr;
        grid-template-areas:
          "center"
          "left"
          "map";
      }
      .pane{ height:auto; max-height:none; min-height:unset; }
      .mapPane{ position:relative; top:auto; }
      #map{ min-height: 420px; }
      .heroRight{ justify-content:flex-start; }
    }
    @media (max-width: 520px){
      .shell{ padding: 10px 8px 16px; }
      .logo{ width:52px; height:52px; }
      .chip{ padding: 8px 9px; font-size: 10.5px; }
      .selImg{ height: 205px; }
    }
    @media (prefers-reduced-motion: reduce){
      .aurora{ animation:none; }
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="noise"></div>

  <div class="shell">
    <!-- HERO -->
    <div class="hero">
      <div class="heroMedia">
        <img src="./style/vivek-kumar-7k1IKQZikSc-unsplash.jpg" alt="Himachal Explorer" onerror="this.style.display='none';">
      </div>
      <div class="heroBar">
        <div class="heroBrand">
          <div class="logo">
            <img src="./style/logo.png" alt="Logo" onerror="this.remove(); this.parentNode.textContent='HP';">
          </div>
          <div class="brandText">
            <div class="heroTitle">Himachal Explorer Portal</div>
            <div class="heroSub" id="statusLine">Loading…</div>
          </div>
        </div>

        <div class="heroRight">
          <div class="chip primary" id="backBtn">Back</div>
          <div class="chip" id="refreshBtn">Refresh</div>
          <div class="chip" id="fitMapBtn">Fit Route</div>
          <div class="chip" id="clearRouteBtn">Clear</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- LEFT -->
      <div class="pane leftPane">
        <div class="paneHdr">
          <div>
            <p class="t">Trip Filters</p>
            <div class="s">Start + days + tier</div>
          </div>
          <div class="s" id="leftHint">Auto loaded</div>
        </div>

        <div class="sideInner">
          <div class="sideCard">
            <div class="field">
              <label>Start City / Pickup</label>
              <input id="startInp" list="startList" placeholder="E.g. SHIMLA / CHANDIGARH / DELHI" autocomplete="off">
              <datalist id="startList"></datalist>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Package Tier</label>
              <select id="visitType">
                <option value="budget">BUDGET</option>
                <option value="premium">PREMIUM</option>
                <option value="luxury">LUXURY</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Trip Duration (Days)</label>
              <select id="daysSel">
                <option value="">ANY</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                <option>11</option><option>12</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Travellers (Pax)</label>
              <select id="paxSel">
                <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
              </select>
            </div>

            <div class="btnRow">
              <button class="btn secondary" id="resetBtn" type="button">Reset</button>
              <button class="btn" id="genBtn" type="button">Show</button>
            </div>
          </div>

          <div class="otherWrap">
            <div class="otherHdr">
              <div class="h">All Packages</div>
              <div class="xBtn" id="closeSelectedBtn">Close</div>
            </div>
            <div class="otherList" id="otherPkgList">
              <div class="otherHint">Packages will appear here after data load. Tap to open in center.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="pane centerPane">
        <div class="paneHdr">
          <div>
            <p class="t">Selected Package</p>
            <div class="s">Pricing first → itinerary</div>
          </div>
          <div class="s" id="pkgCount">—</div>
        </div>
        <div class="centerScroll" id="centerScroll">
          <div class="emptyState">Select any package from the left list to view details here.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="pane mapPane">
        <div class="paneHdr">
          <div>
            <p class="t">Live Route Map</p>
            <div class="s">OSRM road polyline + stop pins</div>
          </div>
          <div class="s" id="kmBadge">—</div>
        </div>
        <div id="map"></div>
        <div class="mapTools">
          <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
          <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
          <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
        </div>
      </div>
    </div>
  </div>

  <div class="botToast" id="botToast">Loading…</div>

  <!-- Place Modal -->
  <div class="placeModal" id="placeModal" role="dialog" aria-modal="true">
    <div class="placeCard">
      <div class="placeCardTop">
        <div class="ttl" id="pmTitle">PLACE</div>
        <button class="placeClose" id="pmClose" type="button">Close</button>
      </div>
      <div class="placeBody">
        <div class="placeGallery">
          <img id="pmImg" src="" alt="Place photo" onerror="this.style.display='none'">
        </div>
        <div class="placeText">
          <div class="kk">Overview</div>
          <div class="vv" id="pmDesc">—</div>
          <div style="height:10px"></div>
          <div class="kk">Details</div>
          <div class="vv" id="pmMeta">—</div>
          <div class="placeActions" id="pmActions"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase Loader -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    async function fetchNode(path){
      // NOTE: using ref(db, path) is the correct direct reference
      const snap = await get(ref(db, path));
      return snap.exists() ? snap.val() : {};
    }

    window.hxFetchFirebaseAndCache = async function(){
      const [templates, places, costs] = await Promise.all([
        fetchNode("templates"),
        fetchNode("places"),
        fetchNode("package_cost_breakdown")
      ]);

      sessionStorage.setItem("HX_TEMPLATES", JSON.stringify(templates || {}));
      sessionStorage.setItem("HX_PLACES", JSON.stringify(places || {}));
      sessionStorage.setItem("HX_COSTS", JSON.stringify(costs || {}));
      return { templates, places, costs };
    };
  </script>

  <script>
    const $ = (id)=>document.getElementById(id);

    /* toast */
    function showBot(msg){
      const el = $("botToast");
      el.textContent = msg || "";
      el.classList.add("show");
      clearTimeout(showBot._t);
      showBot._t = setTimeout(()=> el.classList.remove("show"), 3200);
    }
    function setStatus(msg){ $("statusLine").textContent = msg; }

    /* safe */
    function escapeHtml(str){
      return String(str ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function safeUpper(x){ return String(x ?? "").trim().toUpperCase(); }
    function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
    function rupees(n){ return "₹" + Math.round(Number(n)||0).toLocaleString("en-IN"); }

    function splitCSV(s){
      return String(s||"")
        .split(",")
        .map(x=>x.trim())
        .filter(Boolean);
    }

    /* discount stable 10–20 */
    function hashToDiscount(key){
      const s = String(key||"");
      let h = 0;
      for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
      return 10 + (h % 11); // 10..20
    }

    /* places helpers */
    function placeIdAny(p, key){ return String(p?.place_id || p?.id || key || "").trim(); }
    function placeNameAny(p, key){ return String(p?.name || p?.["Location Name"] || p?.title || key || "PLACE").trim(); }
    function latAny(p){ return Number(p?.latitude ?? p?.lat ?? p?.Latitude); }
    function lngAny(p){ return Number(p?.longitude ?? p?.lng ?? p?.Longitude); }
    function districtAny(p){ return String(p?.district || p?.District || "").trim().toUpperCase(); }

    function haversineKm(lat1, lon1, lat2, lon2){
      const toRad = (d)=> (d*Math.PI)/180;
      const R = 6371;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    /* image helpers */
    const IMG_BASE = "./Places/";
    const IMG_MAX = 4;

    function getPlacePhotos(place, placeId){
      const out = [];
      ["photo_1","photo_2","photo_3","image","img","cover"].forEach(k=>{
        const v = String(place?.[k] || "").trim();
        if(v && v !== "1") out.push(v);
      });
      const pid = String(placeId || place?.place_id || place?.id || "").trim();
      if(pid){
        for(let i=1; i<=IMG_MAX; i++){
          out.push(`${IMG_BASE}${pid}_${i}.jpg`);
          out.push(`${IMG_BASE}${pid}_${i}.jpeg`);
          out.push(`${IMG_BASE}${pid}_${i}.png`);
          out.push(`${IMG_BASE}${pid}_${i}.webp`);
        }
      }
      return Array.from(new Set(out));
    }
    function choosePackageHeroImage(tpl){
      const direct = String(tpl.cover || tpl.photo || tpl.image || "").trim();
      if(direct) return direct;
      const d1 = splitCSV(tpl.day1_place_ids || "")[0];
      if(d1 && PLACES[d1]){
        const photos = getPlacePhotos(PLACES[d1], d1);
        if(photos[0]) return photos[0];
      }
      return "./style/n1.jpg";
    }

    /* =========================================================
       PRICING: USE package_cost_breakdown FIRST (NO REMOVALS)
       ========================================================= */
    function normalizeCostsKeys(){
      const fixed = {};
      for(const [k,v] of Object.entries(COSTS || {})){
        fixed[String(k).trim().toLowerCase()] = v;
      }
      COSTS = fixed;
    }
    function getTplKey(tpl){
      return String(tpl?.package_id || tpl?.key || tpl?.id || "").trim().toLowerCase();
    }
    function getCostRowForTemplate(tpl, fallbackKey){
      const pid = getTplKey(tpl) || String(fallbackKey || "").trim().toLowerCase();
      return (pid && COSTS && COSTS[pid]) ? COSTS[pid] : null;
    }
    function pickBasePrice(tpl, tier, fallbackKey){
      // 1) from COSTS node (preferred)
      const row = getCostRowForTemplate(tpl, fallbackKey);
      if(row){
        const b = Number(row.budget_price_per_person || 0);
        const p = Number(row.premium_price_per_person || 0);
        const l = Number(row.luxury_price_per_person || 0);
        if(tier==="luxury")  return l || p || b || 0;
        if(tier==="premium") return p || b || l || 0;
        return b || p || l || 0;
      }
      // 2) fallback: template fields (kept)
      const b = Number(tpl.budget_price_per_person || tpl.budget_price || 0);
      const p = Number(tpl.premium_price_per_person || tpl.premium_price || 0);
      const l = Number(tpl.luxury_price_per_person || tpl.luxury_price || 0);
      if(tier==="luxury") return l || p || b || 0;
      if(tier==="premium") return p || b || l || 0;
      return b || p || l || 0;
    }

    /* Map */
    let map, tile, tileDark, markersLayer, routeLine;
    let showMode = "all";
    let tilesDark = false;

    function invalidateMapSoon(){
      try{
        setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 80);
        setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 260);
      }catch(e){}
    }

    function initMap(){
      map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
      tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
      tileDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 });
      tile.addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      window.addEventListener("resize", invalidateMapSoon, { passive:true });
      invalidateMapSoon();
    }

    function clearMap(){
      markersLayer.clearLayers();
      if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
      $("kmBadge").textContent = "—";
      invalidateMapSoon();
    }

    function fitToAll(){
      const layers = markersLayer.getLayers();
      if(!layers.length){ map.setView([31.1048, 77.1734], 8); return; }
      const group = L.featureGroup(layers);
      map.fitBounds(group.getBounds().pad(0.18));
    }

    async function fetchOSRMRoute(latlngs){
      const pts = latlngs.slice(0, 60).map(([lat,lng])=> `${lng},${lat}`).join(";");
      const url = `https://router.project-osrm.org/route/v1/driving/${pts}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("OSRM failed");
      const json = await res.json();
      return json?.routes?.[0] || null;
    }

    /* Data */
    let TEMPLATES = {};
    let PLACES = {};
    let COSTS = {};

    let STARTS = [];
    let ACTIVE_KEYS = [];
    let CURRENT_KEY = "";
    let shownSuggestions = new Set();

    function loadFromCache(){
      try{
        const t = sessionStorage.getItem("HX_TEMPLATES");
        const p = sessionStorage.getItem("HX_PLACES");
        const c = sessionStorage.getItem("HX_COSTS");
        if(!t || !p || !c) return false;
        TEMPLATES = JSON.parse(t) || {};
        PLACES = JSON.parse(p) || {};
        COSTS = JSON.parse(c) || {};
        normalizeCostsKeys(); // IMPORTANT
        return true;
      }catch(e){ return false; }
    }

    function buildStartList(){
      const counts = new Map();
      Object.values(TEMPLATES).forEach(t=>{
        const s = safeUpper(t.start_point || t.start || "");
        if(!s) return;
        counts.set(s, (counts.get(s)||0) + 1);
      });
      STARTS = Array.from(counts.keys()).sort((a,b)=> counts.get(b)-counts.get(a) || a.localeCompare(b));
      const dl = $("startList");
      dl.innerHTML = "";
      STARTS.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s;
        dl.appendChild(opt);
      });
    }

    function getSelectedPax(){
      const v = Number($("paxSel")?.value || 2);
      return (isFinite(v) && v>0) ? v : 2;
    }

    function filterKeys(){
      const start = safeUpper($("startInp").value || "");
      const days = String($("daysSel").value || "").trim();
      const list = Object.entries(TEMPLATES).map(([k,v])=>({ key:k, ...v }));

      const filtered = list.filter(t=>{
        if(start){
          const s = safeUpper(t.start_point || t.start || "");
          if(s !== start) return false;
        }
        if(days){
          if(String(t.days||"") !== days) return false;
        }
        return true;
      });

      filtered.sort((a,b)=> (Number(a.days||0)-Number(b.days||0)) || String(a.package_name||a.route_name||a.key).localeCompare(String(b.package_name||b.route_name||b.key)));
      return filtered.map(x=>x.key);
    }

    function renderLeftList(){
      ACTIVE_KEYS = filterKeys();
      $("pkgCount").textContent = `${ACTIVE_KEYS.length} packages`;

      const host = $("otherPkgList");
      host.innerHTML = "";

      if(!ACTIVE_KEYS.length){
        host.innerHTML = `<div class="otherHint">No packages found. Try Reset.</div>`;
        return;
      }

      ACTIVE_KEYS.forEach(key=>{
        const t = TEMPLATES[key] || {};
        const title = String(t.package_name || t.route_name || key || "PACKAGE");
        const days = Number(t.days||0) || "";
        const district = String(t.district||"").toUpperCase();
        const drive = String(t.drive_level||"").toUpperCase();

        const card = document.createElement("div");
        card.className = "pkgSide" + (key===CURRENT_KEY ? " active" : "");
        card.innerHTML = `
          <div class="pkgSideTop">
            <div class="t1">${escapeHtml(title)}</div>
          </div>
          <div class="pkgSideRow">
            ${days ? `<span>${days}D</span>` : ""}
            ${district ? `<span>${escapeHtml(district)}</span>` : ""}
            ${drive ? `<span>${escapeHtml(drive)}</span>` : ""}
          </div>
        `;
        card.onclick = ()=>{
          CURRENT_KEY = key;
          renderLeftList();
          renderSelected();
        };
        host.appendChild(card);
      });
    }

    /* Nearby: unique across all days */
    function findNearby(anchorId, maxKm=55, limit=8){
      const anchor = PLACES[anchorId];
      if(!anchor) return [];
      const aLat = latAny(anchor), aLng = lngAny(anchor);
      if(!isFinite(aLat) || !isFinite(aLng)) return [];

      const out = [];
      for(const [id, p] of Object.entries(PLACES)){
        if(id === anchorId) continue;
        const lat = latAny(p), lng = lngAny(p);
        if(!isFinite(lat) || !isFinite(lng)) continue;
        const d = haversineKm(aLat,aLng,lat,lng);
        if(d <= maxKm){
          const photos = getPlacePhotos(p, id);
          out.push({
            id,
            name: placeNameAny(p, id),
            img: photos[0] || "./style/n1.jpg",
            dist: d
          });
        }
      }
      out.sort((x,y)=> x.dist - y.dist);
      return out.slice(0, limit);
    }

    /* Place modal (no lat/lng display) */
    function openPlaceModal({ place, dayNum, orderNum, placeId }){
      const modal = $("placeModal");
      const ttl = $("pmTitle");
      const img = $("pmImg");
      const desc = $("pmDesc");
      const meta = $("pmMeta");
      const actions = $("pmActions");

      const name = placeNameAny(place, placeId);
      const dist = districtAny(place) || "—";

      ttl.textContent = `${name} • Day ${dayNum}${orderNum ? " • Stop " + orderNum : ""}`;

      const photos = getPlacePhotos(place, placeId);
      let idx = 0;
      img.style.display = "block";
      img.onerror = ()=>{
        idx += 1;
        if(idx < photos.length){
          img.style.display = "block";
          img.src = photos[idx];
        }else{
          img.style.display = "none";
        }
      };
      img.src = photos[0] || "./style/n1.jpg";

      const short =
        String(place?.history_tagline || place?.what_you_find || place?.description || "")
        .trim() || "Beautiful spot in Himachal Pradesh.";

      desc.textContent = short;

      meta.innerHTML = `
        <div><b>District:</b> ${escapeHtml(dist)}</div>
        <div><b>Category:</b> ${escapeHtml(String(place?.category || "—"))}</div>
        <div><b>Segment:</b> ${escapeHtml(String(place?.segment || "—"))}</div>
      `;

      const lat = latAny(place), lng = lngAny(place);
      const gmaps = (isFinite(lat) && isFinite(lng)) ? `https://www.google.com/maps?q=${lat},${lng}` : "";

      actions.innerHTML = `
        ${gmaps ? `<a href="${gmaps}" target="_blank" rel="noopener">Open in Maps</a>` : ""}
        <a href="#" id="pmNextPhoto">Next Photo</a>
      `;

      const next = document.getElementById("pmNextPhoto");
      if(next){
        next.onclick = (e)=>{
          e.preventDefault();
          if(!photos.length) return;
          idx = (idx + 1) % photos.length;
          img.style.display = "block";
          img.src = photos[idx];
        };
      }

      modal.classList.add("show");
    }
    function closePlaceModal(){ $("placeModal")?.classList.remove("show"); }

    async function renderItineraryAndMap(tpl){
      const days = Number(tpl.days || 0) || 0;
      const container = document.getElementById("itinDays");
      container.innerHTML = "";

      clearMap();

      const allStops = [];
      const allStopMeta = [];
      const allDayPlaceIds = new Set();

      for(let d=1; d<=Math.max(1, days); d++){
        const ids = splitCSV(tpl[`day${d}_place_ids`] || "");
        if(!ids.length) continue;

        ids.forEach(x=> allDayPlaceIds.add(x));

        const dayWrap = document.createElement("div");
        dayWrap.className = "dayCompact";

        const ttl = document.createElement("div");
        ttl.className = "dayTitle";
        ttl.innerHTML = `<span>Day ${d}</span><span>${ids.length} stops</span>`;
        dayWrap.appendChild(ttl);

        const chips = document.createElement("div");
        chips.className = "stopChips";
        ids.slice(0,3).forEach((pid, idx)=>{
          const place = PLACES[pid] || {};
          const nm = placeNameAny(place, pid);
          const chip = document.createElement("div");
          chip.className = "stopChip";
          chip.textContent = nm;
          chip.onclick = ()=> openPlaceModal({ place, dayNum:d, orderNum: idx+1, placeId: pid });

          const lat = latAny(place), lng = lngAny(place);
          if(isFinite(lat) && isFinite(lng)){
            allStops.push([lat, lng]);
            allStopMeta.push({ pid, place, day: d, order: idx+1 });
          }
          chips.appendChild(chip);
        });
        dayWrap.appendChild(chips);

        const det = document.createElement("details");
        det.className = "dayDetails";
        det.innerHTML = `<summary>View all stops</summary>`;
        const detInner = document.createElement("div");

        ids.forEach((pid, idx)=>{
          const place = PLACES[pid] || {};
          const nm = placeNameAny(place, pid);

          const lat = latAny(place), lng = lngAny(place);
          if(isFinite(lat) && isFinite(lng) && idx>=3){
            allStops.push([lat, lng]);
            allStopMeta.push({ pid, place, day: d, order: idx+1 });
          }

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "placeBtn";
          btn.innerHTML = `
            <div class="left">
              <div class="nm">${escapeHtml(nm)}</div>
              <div class="sm">${escapeHtml(districtAny(place) || "Himachal Pradesh")}</div>
            </div>
            <div class="tag">OPEN</div>
          `;
          btn.onclick = ()=>{
            openPlaceModal({ place, dayNum:d, orderNum: idx+1, placeId: pid });
            if(isFinite(lat) && isFinite(lng)) map.setView([lat,lng], 12, {animate:true});
          };
          detInner.appendChild(btn);
        });

        det.appendChild(detInner);
        dayWrap.appendChild(det);

        const anchorId = ids[ids.length-1] || ids[0];
        const nearby = findNearby(anchorId, 55, 10)
          .filter(x => !shownSuggestions.has(x.id))
          .filter(x => !allDayPlaceIds.has(x.id))
          .slice(0, 4);

        nearby.forEach(x=> shownSuggestions.add(x.id));

        if(nearby.length){
          const near = document.createElement("div");
          near.className = "nearWrap";
          near.innerHTML = `
            <div class="nearTop"><div class="k">Nearby Suggestions</div></div>
            <div class="nearCards">
              ${nearby.map(x=>`
                <div class="nearCircle" data-pid="${escapeHtml(x.id)}">
                  <div class="img"><img src="${escapeHtml(x.img)}" onerror="this.src='./style/n1.jpg'"></div>
                  <div class="nm">${escapeHtml(x.name)}</div>
                </div>
              `).join("")}
            </div>
          `;
          dayWrap.appendChild(near);

          near.querySelectorAll(".nearCircle").forEach(el=>{
            el.addEventListener("click", ()=>{
              const pid = el.getAttribute("data-pid");
              const p = PLACES[pid] || {};
              openPlaceModal({ place:p, dayNum:d, orderNum:"", placeId:pid });
              const lat = latAny(p), lng = lngAny(p);
              if(isFinite(lat) && isFinite(lng)) map.setView([lat,lng], 12, {animate:true});
            });
          });
        }

        container.appendChild(dayWrap);
      }

      function applyShowMode(){
        markersLayer.clearLayers();
        const arr = (showMode==="ends" && allStopMeta.length)
          ? [allStopMeta[0], allStopMeta[allStopMeta.length-1]]
          : allStopMeta;

        arr.forEach(m=>{
          const lat = latAny(m.place), lng = lngAny(m.place);
          const marker = L.marker([lat,lng]).addTo(markersLayer);
          marker.bindPopup(`<b>${escapeHtml(placeNameAny(m.place, m.pid))}</b><br>Day ${m.day} • Stop ${m.order}`);
          marker.on("click", ()=> openPlaceModal({ place:m.place, dayNum:m.day, orderNum:m.order, placeId:m.pid }));
        });
        invalidateMapSoon();
      }

      if(allStops.length >= 2){
        try{
          const route = await fetchOSRMRoute(allStops);
          if(route?.geometry?.coordinates?.length){
            const latlngs = route.geometry.coordinates.map(c=>[c[1], c[0]]);
            routeLine = L.polyline(latlngs, { weight: 4, opacity: 0.85 }).addTo(map);
            const km = (route.distance || 0) / 1000;
            $("kmBadge").textContent = km ? `${km.toFixed(0)} km` : "—";
          }
        }catch(e){
          console.warn(e);
        }
      }

      applyShowMode();
      fitToAll();

      $("showAllStopsBtn").onclick = ()=>{ showMode = "all"; applyShowMode(); showBot("Showing all stops"); };
      $("showStartEndBtn").onclick = ()=>{ showMode = "ends"; applyShowMode(); showBot("Showing start/end only"); };
    }

    function renderSelected(){
      const host = $("centerScroll");
      if(!CURRENT_KEY){
        host.innerHTML = `<div class="emptyState">Select any package from the left list to view details here.</div>`;
        clearMap();
        return;
      }

      const tpl = TEMPLATES[CURRENT_KEY] || {};
      const tier = safeLower($("visitType").value || "budget");
      const pax = getSelectedPax();

      // COSTS-first pricing (key passed as fallback)
      const base = pickBasePrice(tpl, tier, CURRENT_KEY);

      const offPct = hashToDiscount(CURRENT_KEY);
      const discounted = Math.round(base * (1 - offPct/100));
      const total = discounted * pax;

      const title = String(tpl.package_name || tpl.route_name || CURRENT_KEY || "PACKAGE");
      const start = safeUpper(tpl.start_point || tpl.start || "");
      const end = safeUpper(tpl.end_point || "");
      const days = Number(tpl.days || 0) || "";
      const drive = safeUpper(tpl.drive_level || "");
      const cat = String(tpl.category || "").trim();
      const hotel = String(tpl.hotel_category || "").trim();
      const routePath = String(tpl.route_path || tpl.route_name || "").trim();

      const season = String(tpl.best_season || "").trim();
      const meal = String(tpl.meal_plan || "").trim();
      const ideal = String(tpl.ideal_for || "").trim();
      const night = String(tpl.night_plan || "").trim();
      const notes = String(tpl.important_notes || tpl.notes || "").trim();
      const inclusions = String(tpl.inclusions || "").trim();
      const exclusions = String(tpl.exclusions || "").trim();

      const heroImg = choosePackageHeroImage(tpl);

      const msg = encodeURIComponent(`Hi Chandan, I want to book: ${title} | ${days} days | ${tier.toUpperCase()} | Pax: ${pax}`);
      const wa = `https://wa.me/917018138847?text=${msg}`;

      host.innerHTML = `
        <div class="selHeader">
          <div class="selImg">
            <img src="${escapeHtml(heroImg)}" alt="${escapeHtml(title)}" onerror="this.src='./style/n1.jpg'">
          </div>
          <div class="selTitleBox">
            <h2 class="selTitle">${escapeHtml(title)}</h2>
            <div class="metaChips">
              ${days ? `<span class="chip2">${days} Days</span>` : ""}
              ${cat ? `<span class="chip2">${escapeHtml(cat)}</span>` : ""}
              ${drive ? `<span class="chip2">${escapeHtml(drive)} Drive</span>` : ""}
              ${hotel ? `<span class="chip2">${escapeHtml(hotel)}</span>` : ""}
            </div>
            <div class="metaLine">
              ${start ? `<b>Start:</b> ${escapeHtml(start)}&nbsp;&nbsp;` : ""}
              ${end ? `<b>End:</b> ${escapeHtml(end)}&nbsp;&nbsp;` : ""}
              ${routePath ? `<br><b>Route:</b> ${escapeHtml(routePath)}` : ""}
            </div>
            <a class="waBig" href="${wa}" target="_blank" rel="noopener">WhatsApp Booking</a>
          </div>
        </div>

        <!-- PRICING FIRST -->
        <div class="costBoxFull">
          <div class="costHead">
            <p class="costTitle">Package Pricing</p>
            <span class="offPill">${offPct}% Discount</span>
          </div>

          <div class="priceRows">
            <div class="priceRow">
              <span class="k">Tier</span>
              <span class="v">${escapeHtml(tier.toUpperCase())}</span>
            </div>
            <div class="priceRow">
              <span class="k">Travellers</span>
              <span class="v">${pax}</span>
            </div>
            <div class="priceRow">
              <span class="k">Price / Person</span>
              <span class="v"><span class="strike">${rupees(base)}</span>${rupees(discounted)}</span>
            </div>
            <div class="priceRow totalRow">
              <span class="k">Total Payable</span>
              <span class="v">${rupees(total)}</span>
            </div>
          </div>

          <div class="priceNotes">
            ${season ? `<div><b>Best Season:</b> ${escapeHtml(season)}</div>` : ""}
            ${meal ? `<div><b>Meal Plan:</b> ${escapeHtml(meal)}</div>` : ""}
            ${ideal ? `<div><b>Ideal For:</b> ${escapeHtml(ideal)}</div>` : ""}
            ${night ? `<div><b>Nights:</b> ${escapeHtml(night)}</div>` : ""}
            ${notes ? `<div style="margin-top:6px"><b>Notes:</b> ${escapeHtml(notes)}</div>` : ""}
            ${(inclusions) ? `<div style="margin-top:6px"><b>Includes:</b> ${escapeHtml(inclusions)}</div>` : ""}
            ${(exclusions) ? `<div><b>Excludes:</b> ${escapeHtml(exclusions)}</div>` : ""}
          </div>
        </div>

        <!-- ITINERARY AFTER PRICING -->
        <div class="itinCompact">
          <div class="itinHead">
            <p class="t">Itinerary</p>
            <span class="s">Day-wise</span>
          </div>
          <div id="itinDays"></div>
        </div>
      `;

      shownSuggestions = new Set(); // reset per package
      renderItineraryAndMap(tpl);
      invalidateMapSoon();
    }

    async function loadAll(){
      setStatus("Loading data…");
      let ok = loadFromCache();
      if(!ok){
        try{
          setStatus("Fetching from Firebase…");
          if(typeof window.hxFetchFirebaseAndCache === "function"){
            await window.hxFetchFirebaseAndCache();
            ok = loadFromCache();
          }
        }catch(e){
          console.error(e);
          ok = false;
        }
      }

      if(!ok){
        setStatus("Data not found");
        showBot("Firebase not loading. Use GitHub Pages/Live Server (not file://) + check DB Rules.");
        $("otherPkgList").innerHTML = `<div class="otherHint">Data not loading. Open on GitHub Pages / Live Server and check Firebase rules.</div>`;
        return;
      }

      buildStartList();
      renderLeftList();
      setStatus("Ready");
      showBot("Data loaded");
    }

    function wireUI(){
      $("pmClose").onclick = closePlaceModal;
      $("placeModal").addEventListener("click", (e)=>{
        if(e.target === $("placeModal")) closePlaceModal();
      });

      $("resetBtn").onclick = ()=>{
        $("startInp").value = "";
        $("daysSel").value = "";
        $("visitType").value = "budget";
        $("paxSel").value = "2";
        CURRENT_KEY = "";
        renderLeftList();
        renderSelected();
        showBot("Filters reset");
      };

      $("genBtn").onclick = ()=>{
        CURRENT_KEY = "";
        renderLeftList();
        renderSelected();
        showBot("Filtered packages updated");
      };

      $("refreshBtn").onclick = async ()=>{
        sessionStorage.removeItem("HX_TEMPLATES");
        sessionStorage.removeItem("HX_PLACES");
        sessionStorage.removeItem("HX_COSTS");
        await loadAll();
        showBot("Refreshed");
      };

      $("fitMapBtn").onclick = ()=>{ fitToAll(); showBot("Fit route"); };
      $("clearRouteBtn").onclick = ()=>{ clearMap(); showBot("Cleared map"); };

      $("toggleTilesBtn").onclick = ()=>{
        tilesDark = !tilesDark;
        if(tilesDark){
          map.removeLayer(tile);
          tileDark.addTo(map);
          showBot("Dark tiles");
        }else{
          map.removeLayer(tileDark);
          tile.addTo(map);
          showBot("Light tiles");
        }
      };

      $("closeSelectedBtn").onclick = ()=>{
        CURRENT_KEY = "";
        renderLeftList();
        renderSelected();
        showBot("Closed");
      };

      // Back: MUST go previous page (not always to opening page)
      $("backBtn").onclick = ()=>{
        if(history.length > 1) history.back();
        else location.href = "./index.html";
      };

      $("visitType").addEventListener("change", ()=>{ if(CURRENT_KEY) renderSelected(); });
      $("paxSel").addEventListener("change", ()=>{ if(CURRENT_KEY) renderSelected(); });
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      wireUI();
      initMap();
      await loadAll();
    });
  </script>
</body>
</html>