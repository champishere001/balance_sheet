<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="light"/>

  <title>Himachal Tour Packages | Himachal Explorer Portal</title>
  <meta name="description" content="Explore Himachal tour packages with live road route maps, day-wise itineraries, places, and instant price estimates." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <link rel="canonical" href="https://himachalexplorer.in/" />
  <meta name="theme-color" content="#EAF3FF" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg0:#F6FAFF;
      --bg1:#EAF3FF;
      --card: rgba(255,255,255,.62);
      --stroke: rgba(10,30,60,.16);
      --muted: rgba(10,30,60,.62);
      --text: rgba(10,30,60,.92);
      --shadow: 0 18px 70px rgba(10,30,60,.14);
      --radius: 16px;
      --acc:#2563EB;
      --gap: 12px;
      --shellW: min(90vw, 1700px);
      --heroH: clamp(220px, 26vw, 320px);
    }
    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 520px at 20% 0%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(14,165,233,.10), transparent 62%),
        radial-gradient(900px 520px at 50% 92%, rgba(59,130,246,.08), transparent 64%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    .aurora{
      position:fixed; inset:-30%;
      background:
        radial-gradient(900px 500px at 25% 30%, rgba(37,99,235,.12), transparent 66%),
        radial-gradient(900px 520px at 75% 25%, rgba(14,165,233,.10), transparent 68%),
        radial-gradient(860px 540px at 55% 75%, rgba(59,130,246,.08), transparent 70%);
      filter: blur(50px); opacity:.85; animation: drift 14s ease-in-out infinite;
      pointer-events:none; z-index:-3;
      transform: translateZ(0);
    }
    @keyframes drift{
      0%,100%{transform:translate3d(0,0,0) scale(1);}
      50%{transform:translate3d(3%,-2%,0) scale(1.06);}
    }

    .noise{
      position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.06; mix-blend-mode:multiply;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }

    .shell{ width: var(--shellW); margin: 0 auto; padding: 12px 10px 18px; }

    .hero{
      border-radius: 22px; border:1px solid var(--stroke);
      overflow:hidden; position:relative; box-shadow: var(--shadow);
      background: rgba(255,255,255,.62);
    }
    .heroMedia{ height: var(--heroH); position:relative; overflow:hidden; background: rgba(255,255,255,.62); }
    .heroMedia img{ width:100%; height:100%; object-fit:cover; display:block; transform: translateZ(0); }
    .heroMedia::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.28), rgba(255,255,255,.10), rgba(255,255,255,.24));
      pointer-events:none;
    }
    .heroBar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 14px;
      background: rgba(255,255,255,.66);
      border-top:1px solid rgba(10,30,60,.14);
      backdrop-filter: blur(14px);
    }
    .heroBrand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .logo{
      width:56px; height:56px; border-radius:16px;
      background: rgba(255,255,255,.78);
      border:1px solid rgba(10,30,60,.16);
      display:grid; place-items:center; overflow:hidden;
      box-shadow: 0 14px 34px rgba(10,30,60,.12);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brandText{ min-width:0; }
    .heroTitle{
      margin:0;
      font-size: clamp(16px, 2.1vw, 22px);
      letter-spacing:.14em; text-transform: uppercase;
      font-weight: 1000; color: rgba(10,30,60,.96);
      line-height: 1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .heroSub{
      margin:7px 0 0;
      font-size: 12px; color: rgba(10,30,60,.70);
      letter-spacing:.08em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .heroRight{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; flex:0 0 auto; }
    .chip{
      border:1px solid rgba(10,30,60,.18);
      background: rgba(255,255,255,.62);
      color: rgba(10,30,60,.82);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.10em;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer; user-select:none;
      box-shadow: 0 10px 24px rgba(10,30,60,.10);
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:hover{ background: rgba(255,255,255,.74); }
    .chip.primary{
      border-color: rgba(37,99,235,.40);
      background: rgba(37,99,235,.16);
      color: rgba(10,30,60,.92);
      font-weight: 950;
    }

    .main{
      display:grid;
      grid-template-columns: 20% 55% 25%;
      gap: var(--gap);
      margin-top: 12px;
      align-items:start;
    }

    .pane{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.56));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      min-height: 620px;
      display:flex;
      flex-direction:column;
      min-width: 0;
    }
    .paneHdr{
      padding: 10px 12px;
      border-bottom:1px solid rgba(10,30,60,.14);
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.62);
    }
    .paneHdr .t{ margin:0; font-size:11px; letter-spacing:.18em; text-transform: uppercase; font-weight: 950; }
    .paneHdr .s{ font-size:10.5px; color:var(--muted); letter-spacing:.10em; text-transform: uppercase; }

    .sideInner{ padding: 12px; display:flex; flex-direction:column; gap:10px; min-height:0; }
    .sideCard{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 12px 36px rgba(10,30,60,.10);
    }
    .field label{
      display:block; font-size: 10.5px; color: var(--muted);
      text-transform: uppercase; letter-spacing:.12em; margin:0 0 6px 2px;
    }
    input, select{
      width:100%; padding: 10px 10px; border-radius: 12px;
      border: 1px solid rgba(10,30,60,.18);
      background: rgba(255,255,255,.82);
      color: rgba(10,30,60,.92);
      outline:none; font-size: 13px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    input:focus, select:focus{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.16); }

    .btnRow{ display:flex; gap:8px; margin-top:8px; }
    .btn{
      flex:1; padding: 10px 10px; border-radius: 12px;
      border: 1px solid rgba(37,99,235,.30);
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(14,165,233,.72));
      color:#fff; font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
      cursor:pointer; font-size: 11px;
      box-shadow: 0 14px 34px rgba(37,99,235,.18);
      -webkit-tap-highlight-color: transparent;
    }
    .btn.secondary{
      border: 1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.86);
      box-shadow: 0 10px 24px rgba(10,30,60,.10);
    }

    .pills{ display:flex; flex-wrap:wrap; gap:7px; margin-top:10px; }
    .pill{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10.5px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(10,30,60,.78);
      display:inline-flex; align-items:center; gap:8px;
    }
    .pill b{ color: rgba(10,30,60,.92); letter-spacing:.06em; }

    .otherWrap{ flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
    .otherHdr{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 14px;
      padding: 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 10px 24px rgba(10,30,60,.10);
    }
    .otherHdr .h{ font-size: 11px; font-weight: 950; letter-spacing:.14em; text-transform: uppercase; }
    .otherHdr .xBtn{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.86);
      border-radius: 12px;
      padding: 7px 10px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .otherList{
      flex:1; min-height:0; overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 2px;
      display:flex; flex-direction:column; gap:8px;
    }
    .otherHint{
      border:1px dashed rgba(10,30,60,.20);
      background: rgba(255,255,255,.58);
      border-radius: 14px;
      padding: 10px;
      color: rgba(10,30,60,.72);
      font-size: 11px;
      letter-spacing:.02em;
      line-height: 1.35;
    }

    .pkgMini{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 9px 10px;
      box-shadow: 0 10px 20px rgba(10,30,60,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .pkgMini:hover{ border-color: rgba(37,99,235,.35); background: rgba(255,255,255,.78); }

    .miniThumb{
      width:44px; height:44px;
      border-radius: 12px;
      overflow:hidden;
      border:1px solid rgba(10,30,60,.14);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.78), rgba(37,99,235,.10));
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .miniThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .miniThumb .ini{ font-weight: 950; letter-spacing:.08em; font-size: 12px; }
    .pkgMini .l{ min-width:0; }
    .pkgMini .t1{
      font-size: 10.8px;
      font-weight: 1000;
      letter-spacing:.10em;
      text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pkgMini .t2{
      margin-top:5px;
      font-size: 10px;
      color: rgba(10,30,60,.62);
      letter-spacing:.02em;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pkgMini .r{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }
    .miniBadge{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      font-weight: 950;
      color: rgba(10,30,60,.86);
      white-space: nowrap;
    }
    .miniBadge.blue{ border-color: rgba(37,99,235,.32); background: rgba(37,99,235,.12); }
    .miniOpen{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.74);
      border-radius: 12px;
      padding: 7px 9px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 1000;
      white-space: nowrap;
      color: rgba(10,30,60,.90);
    }

    .centerInner{ display:flex; flex-direction:column; min-height:0; flex:1; }
    .districtBar{
      display:flex; flex-wrap:nowrap; gap:8px;
      padding:10px 12px;
      border-bottom:1px solid rgba(10,30,60,.14);
      overflow-x:auto; -webkit-overflow-scrolling: touch;
      background: rgba(255,255,255,.62);
    }
    .distItem{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.86);
      border-radius: 999px;
      padding:8px 10px;
      font-size: 10.5px;
      letter-spacing:.10em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
      white-space:nowrap;
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
      -webkit-tap-highlight-color: transparent;
    }
    .distItem.active{
      border-color: rgba(37,99,235,.40);
      box-shadow: 0 0 0 3px rgba(37,99,235,.14);
      background: rgba(37,99,235,.14);
    }

    .centreHero{
      margin: 12px;
      border:1px solid rgba(10,30,60,.16);
      border-radius: 18px;
      overflow:hidden;
      position:relative;
      height: clamp(220px, 26vw, 280px);
      background: rgba(255,255,255,.62);
      box-shadow: 0 24px 80px rgba(10,30,60,.12);
    }
    .centreHero img{
      width:100%; height:100%; object-fit:cover; display:block;
      filter:saturate(1.05) contrast(1.02);
      transition: opacity .5s ease;
      transform: translateZ(0);
    }
    .centreHero:before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.05), rgba(255,255,255,.30));
      z-index:2;
    }
    .centreHeroContent{
      position:absolute; inset:0; z-index:3;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center; padding: 14px; gap:10px;
    }
    .centreHeroContent .h{
      font-size: clamp(16px, 2.2vw, 22px);
      font-weight: 950; letter-spacing:.14em; text-transform: uppercase;
      color: rgba(10,30,60,.94);
      text-shadow: 0 14px 30px rgba(255,255,255,.55);
    }
    .centreHeroContent .p{
      max-width: 520px; font-size: 12px;
      color: rgba(10,30,60,.74);
      letter-spacing:.08em; text-transform: uppercase; line-height: 1.5;
      text-shadow: 0 14px 30px rgba(255,255,255,.55);
    }
    .centreHeroContent .tag{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(10,30,60,.86);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
    }

    .pkgList{
      padding: 12px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      background: rgba(255,255,255,.52);
      flex:1;
    }

    /* âœ… GRID CHANGE: Desktop 3-4, Mobile 2 columns */
    .pkgGrid{
      display:grid !important;
      gap: 10px;
      align-items: stretch;
      grid-template-columns: repeat(4, minmax(260px, 1fr));
    }
    @media (max-width: 1400px){
      .pkgGrid{ grid-template-columns: repeat(3, minmax(260px, 1fr)); }
    }
    @media (max-width: 980px){
      .pkgGrid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width: 520px){
      .pkgGrid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }

    /* Skeleton loading */
    .skGrid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:10px; }
    .skCard{
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.58);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 14px 36px rgba(10,30,60,.08);
      position:relative;
      height: 260px;
    }
    .skShimmer{
      position:absolute; inset:0;
      background: linear-gradient(110deg, rgba(255,255,255,.10) 0%, rgba(255,255,255,.52) 35%, rgba(255,255,255,.10) 70%);
      transform: translateX(-60%);
      animation: shimmer 1.2s ease-in-out infinite;
      opacity:.75;
    }
    @keyframes shimmer{ 0%{transform:translateX(-60%);} 100%{transform:translateX(60%);} }
    .skTop{ height: 70%; background: rgba(37,99,235,.08); }
    .skBottom{ height:30%; padding: 10px; display:flex; flex-direction:column; gap:10px; }
    .skLine{ height: 10px; border-radius: 999px; background: rgba(10,30,60,.10); }
    .skLine.w60{ width:60%; } .skLine.w80{ width:80%; } .skLine.w40{ width:40%; }

    .pkgW{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      box-shadow: 0 14px 36px rgba(10,30,60,.10);
      -webkit-tap-highlight-color: transparent;
      height: 100%;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .pkgW:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.30); background: rgba(255,255,255,.76); }
    .pkgW.active{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.14), 0 18px 40px rgba(10,30,60,.12); }

    /* Image 70% + details 30% (default tile) */
    .pkgCard{
      display:flex;
      flex-direction:column;
      min-height: 260px;
      flex: 1;
    }
    .pkgMedia{
      position:relative;
      flex: 7 0 auto;
      min-height: 170px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.78), rgba(37,99,235,.12));
      border-bottom: 1px solid rgba(10,30,60,.12);
      overflow:hidden;
    }
    .pkgMedia img{
      width:100%; height:100%;
      object-fit:cover; display:block;
      filter: saturate(1.02) contrast(1.02);
      transform: scale(1.001);
    }
    .pkgMedia::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.08), rgba(255,255,255,.44));
      pointer-events:none;
    }
    .pkgTagRow{
      position:absolute; left:10px; right:10px; top:10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .pkgBadge{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.74);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(10,30,60,.86);
      white-space: nowrap;
      backdrop-filter: blur(10px);
    }
    .pkgBadge.purple{ border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.16); color: rgba(10,30,60,.92); }
    .pkgBadge.green{ border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.16); color: rgba(10,30,60,.92); }

    .pkgRouteId{
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.70);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(10,30,60,.72);
      white-space: nowrap;
      max-width: 58%;
      overflow:hidden; text-overflow: ellipsis;
      backdrop-filter: blur(10px);
    }

    .pkgInfo{
      flex: 3 0 auto;
      padding: 10px 10px 12px;
      background: rgba(255,255,255,.62);
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .pkgTitleRow{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .pkgTitle{
      margin:0;
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(10,30,60,.94);
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      min-width:0;
    }
    .pkgOpen{
      flex:0 0 auto;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.74);
      color: rgba(10,30,60,.92);
      border-radius: 12px;
      padding: 7px 10px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 950;
      white-space: nowrap;
    }

    .pkgMeta{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pkgChip{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(10,30,60,.72);
      display:inline-flex; gap:6px; align-items:center;
      white-space: nowrap;
    }
    .pkgChip b{ color: rgba(10,30,60,.92); letter-spacing:.06em; }

    .pkgDetails{
      display:none;
      border-top:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.56);
      padding: 12px;
    }
    .pkgW.active .pkgDetails{ display:block; }

    .detailsGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .detailsCard{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 12px 34px rgba(10,30,60,.10);
      min-width:0;
    }
    .bigTitle{ margin:0; font-size: 12px; letter-spacing:.18em; text-transform: uppercase; color: rgba(10,30,60,.94); }
    .muted{ color: var(--muted); font-size: 10.8px; letter-spacing:.08em; text-transform: uppercase; line-height:1.35; }
    .mini{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 9px;
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
      min-width:0;
    }
    .mini .k{ font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(10,30,60,.60); }
    .mini .v{ margin-top:5px; font-size: 13px; font-weight: 950; letter-spacing:.06em; color: rgba(10,30,60,.94); }
    .mini .v small{ font-size: 10.5px; color: rgba(10,30,60,.62); font-weight: 800; }

    .enqRow{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .enqBtn{
      flex:1;
      border:1px solid rgba(34,197,94,.30);
      background: rgba(34,197,94,.14);
      color: rgba(10,30,60,.92);
      border-radius: 14px;
      padding: 10px 10px;
      text-decoration:none;
      text-transform: uppercase;
      letter-spacing:.10em;
      font-weight: 950;
      font-size: 11px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
      box-shadow: 0 12px 28px rgba(34,197,94,.14);
      -webkit-tap-highlight-color: transparent;
      min-width: 220px;
    }
    .enqBtn.disabled{
      opacity:.55;
      pointer-events:none;
      border-color: rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
    }

    .daysList{ display:flex; flex-direction:column; gap:9px; margin-top:10px; }
    .dayCard{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
      min-width:0;
    }
    .dayTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 7px; }
    .dayTop .d{ font-size: 11px; font-weight: 950; letter-spacing:.18em; text-transform: uppercase; }

    .placeBtn{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      width:100%;
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(10,30,60,.08);
      -webkit-tap-highlight-color: transparent;
      margin-top: 7px;
    }
    .placeBtn .left{ min-width:0; }
    .placeBtn .nm{
      font-size: 11px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .placeBtn .sm{
      margin-top:4px; font-size: 10px; color: rgba(10,30,60,.62);
      letter-spacing:.08em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .placeBtn .tag{
      border:1px solid rgba(37,99,235,.30);
      background: rgba(37,99,235,.12);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 950;
      white-space: nowrap;
      flex:0 0 auto;
    }

    .nearWrap{
      margin-top:10px;
      border:1px dashed rgba(10,30,60,.18);
      background: rgba(255,255,255,.58);
      border-radius: 14px;
      padding: 10px;
    }
    .nearTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .nearTop .k{
      font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(10,30,60,.62);
      font-weight: 1000;
    }

    /* âœ… Nearby photo + name cards */
    .nearGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .nearGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .nearCard{
      border:1px solid rgba(10,30,60,.14);
      background: rgba(255,255,255,.72);
      border-radius: 14px;
      overflow:hidden;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
    }
    .nearCard .img{ height: 74px; background: rgba(37,99,235,.08); }
    .nearCard .img img{ width:100%; height:100%; object-fit:cover; display:block; }
    .nearCard .tx{
      padding: 8px 9px;
      font-size: 10.5px;
      font-weight: 950;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: rgba(10,30,60,.90);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .infoBar{
      margin: 12px;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 14px 36px rgba(10,30,60,.10);
    }
    .infoRow{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .infoTitle{ font-size: 12px; font-weight: 1000; letter-spacing:.14em; text-transform: uppercase; }
    .infoMeta{
      font-size: 11px; color: rgba(10,30,60,.68);
      letter-spacing:.04em;
      margin-top: 4px;
      max-width: 820px;
    }
    .infoPills{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .infoPill{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 10.5px;
      letter-spacing:.10em;
      text-transform: uppercase;
    }
    .infoPill b{ letter-spacing:.06em; }

    .mapPane{ position: sticky; top: 12px; height: calc(100vh - 24px); min-height: 620px; max-height: 920px; }
    #map{ width:100%; flex:1; min-height: 520px; background: rgba(255,255,255,.62); }

    .mapTools{
      padding: 10px 12px;
      border-top:1px solid rgba(10,30,60,.14);
      display:flex; gap:8px; flex-wrap:wrap;
      background: rgba(255,255,255,.62);
    }
    .toolBtn{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.86);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none; white-space: nowrap; text-decoration:none;
      box-shadow: 0 10px 20px rgba(10,30,60,.08);
      -webkit-tap-highlight-color: transparent;
    }

    .routeInlineTools{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 8px;
    }

    .waFloat{
      position:fixed; right: 14px; bottom: 14px; z-index: 10000;
      display:flex; align-items:center; gap:10px; padding: 12px 14px;
      border-radius: 999px; border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.74);
      backdrop-filter: blur(14px);
      box-shadow: 0 26px 70px rgba(10,30,60,.16);
      color: rgba(10,30,60,.92); text-decoration:none; user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .waIcon{
      width:40px; height:40px; border-radius: 999px; display:grid; place-items:center;
      background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.30); flex:0 0 auto;
    }
    .waText{ display:flex; flex-direction:column; line-height:1.1; min-width:0; }
    .waText .t1{ font-size: 12px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase; white-space:nowrap; }
    .waText .t2{ margin-top:4px; font-size: 11px; color: rgba(10,30,60,.70); letter-spacing:.04em; white-space:nowrap; }
    .waClose{
      width:34px; height:34px; border-radius: 999px;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.78);
      color: rgba(10,30,60,.86);
      display:grid; place-items:center;
      cursor:pointer; flex:0 0 auto; user-select:none;
    }

    .botToast{
      position:fixed; left: 14px; bottom: 14px; z-index: 9999;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.74);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(10,30,60,.86);
      font-size: 11px;
      letter-spacing:.08em;
      box-shadow: 0 26px 70px rgba(10,30,60,.16);
      display:none;
      max-width: min(520px, calc(100vw - 28px));
    }
    .botToast.show{ display:block; }

    .placeModal{
      position:fixed; inset:0; z-index: 20000;
      background: rgba(10,30,60,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }
    .placeModal.show{ display:flex; }
    .placeCard{
      width:min(980px, 100%);
      border-radius: 18px;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.92);
      box-shadow: 0 30px 90px rgba(10,30,60,.26);
      overflow:hidden;
    }
    .placeCardTop{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-bottom:1px solid rgba(10,30,60,.12);
      background: rgba(255,255,255,.80);
    }
    .placeCardTop .ttl{
      font-size: 12px; font-weight: 1000; letter-spacing:.14em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: calc(100% - 100px);
    }
    .placeClose{
      border:1px solid rgba(10,30,60,.16);
      background:#fff;
      border-radius: 12px;
      padding: 7px 10px;
      cursor:pointer;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 950;
    }
    .placeBody{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 900px){ .placeBody{ grid-template-columns: 1fr; } }
    .placeGallery{
      border:1px solid rgba(10,30,60,.14);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.72);
    }
    .placeGallery img{ width:100%; height: 340px; object-fit:cover; display:block; }
    .placeText{
      border:1px solid rgba(10,30,60,.14);
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      padding: 12px;
      min-width:0;
    }
    .placeText .k{ font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(10,30,60,.60); }
    .placeText .v{ margin-top:6px; font-size: 12px; color: rgba(10,30,60,.86); line-height: 1.55; }
    .placeActions{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .placeActions a{
      text-decoration:none;
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.86);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 950;
      color: rgba(10,30,60,.88);
    }

    footer{
      margin-top: 12px;
      border:1px solid rgba(10,30,60,.16);
      border-radius: 18px;
      background: rgba(255,255,255,.62);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .footInner{ padding: 14px 16px; display:flex; flex-direction:column; gap:12px; }
    .footTopRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .footLeft{
      font-size: 11px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(10,30,60,.70);
    }
    .footLinks{ display:flex; gap:10px; flex-wrap:wrap; }
    .footLinks a{
      font-size: 11px;
      letter-spacing:.10em;
      text-transform: uppercase;
      text-decoration:none;
      color: rgba(10,30,60,.86);
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      padding: 8px 10px;
      border-radius: 999px;
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
      -webkit-tap-highlight-color: transparent;
    }
    .footLinks a:hover{ background: rgba(255,255,255,.78); }

    .footerFancyGrid{
      display:grid;
      grid-template-columns: 1fr 24%;
      gap: 14px;
      border-top: 1px solid rgba(10,30,60,.12);
      padding-top: 12px;
      align-items: stretch;
    }
    .footerAboutGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      min-width:0;
    }
    .footerBox{
      border:1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 14px 36px rgba(10,30,60,.10);
      min-width:0;
    }
    .footerTitle{
      font-size: 11px;
      font-weight: 1000;
      letter-spacing:.14em;
      text-transform: uppercase;
      margin: 0 0 10px;
      color: rgba(10,30,60,.92);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .footerTitle .tag{
      border:1px solid rgba(37,99,235,.30);
      background: rgba(37,99,235,.10);
      color: rgba(10,30,60,.90);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 950;
      white-space: nowrap;
    }
    .footerBox ul{
      margin:0;
      padding-left: 16px;
      display:grid;
      gap: 6px;
      color: rgba(10,30,60,.78);
      font-size: 11px;
      line-height: 1.6;
    }
    .footerDistrictBox{
      border:1px solid rgba(10,30,60,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.56));
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 14px 36px rgba(10,30,60,.10);
      min-width:0;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
    }
    .footerDistrictBox .help{ color: rgba(10,30,60,.68); font-size: 11px; letter-spacing:.02em; line-height: 1.45; }
    .footerDistrictBox select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(10,30,60,.16);
      background: rgba(255,255,255,.66);
      color: rgba(10,30,60,.90);
      font-size: 11px;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-weight: 900;
      box-shadow: 0 10px 22px rgba(10,30,60,.08);
      cursor: pointer;
    }

    /* âœ… Selected package becomes a ROW in center */
    .pkgW.selectedRow{ grid-column: 1 / -1; }
    .pkgW.selectedRow .pkgCard{ flex-direction: row; min-height: 220px; }
    .pkgW.selectedRow .pkgMedia{
      flex: 0 0 38%;
      min-height: 220px;
      border-bottom: none;
      border-right: 1px solid rgba(10,30,60,.12);
    }
    .pkgW.selectedRow .pkgInfo{ flex: 1 1 auto; padding: 14px; }

    @media (max-width: 1200px){
      .main{ grid-template-columns: 1fr; }
      .mapPane{ position:relative; top:auto; height:520px; max-height:none; }
      #map{ min-height: 420px; }
      .pane{ min-height: unset; }
      .heroBar{ flex-direction: column; align-items: stretch; }
      .heroRight{ justify-content:flex-start; }
      .footerFancyGrid{ grid-template-columns: 1fr; }
      .footerAboutGrid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      .shell{ padding: 10px 8px 16px; }
      .heroBar{ padding: 10px 10px; }
      .logo{ width:52px; height:52px; border-radius: 16px; }
      .chip{ padding: 8px 9px; font-size: 10.5px; }
      .detailsGrid{ grid-template-columns: 1fr; }
      .waText{ display:none; }
      .waFloat{ padding: 10px; }
      .waClose{ display:none; }
      .footTopRow{ flex-direction:column; align-items:flex-start; }

      .pkgW.selectedRow .pkgCard{ flex-direction: column; }
      .pkgW.selectedRow .pkgMedia{
        flex: 0 0 auto;
        border-right: none;
        border-bottom: 1px solid rgba(10,30,60,.12);
        min-height: 160px;
      }
    }
    @media (prefers-reduced-motion: reduce){
      .aurora{ animation:none; }
      .pkgW{ transition:none; }
      .centreHero img{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="noise"></div>

  <!-- WhatsApp Floating CTA -->
  <a
    class="waFloat"
    id="waFloat"
    href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
    target="_blank" rel="noopener"
    aria-label="Chat on WhatsApp with Chandan Panwar"
  >
    <div class="waIcon" aria-hidden="true">
      <svg width="22" height="22" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M16 3C9.1 3 3.5 8.3 3.5 14.9c0 2.5.8 4.8 2.2 6.7L4 29l7.6-1.9c1.8 1 3.9 1.6 6.4 1.6 6.9 0 12.5-5.3 12.5-11.9S22.9 3 16 3z" fill="rgba(10,30,60,.10)"/>
        <path d="M16.1 6.1c-5.1 0-9.2 3.9-9.2 8.8 0 1.9.6 3.6 1.7 5.1l-1.1 4 4.2-1.1c1.4.8 3.1 1.3 4.9 1.3 5.1 0 9.2-3.9 9.2-8.8s-4.1-8.8-9.2-8.8z" fill="rgba(10,30,60,.12)"/>
        <path d="M23 19.1c-.3.8-1.6 1.5-2.2 1.6-.6.1-1.3.2-2.2-.1-.5-.2-1.2-.4-2-.8-3.5-1.9-5.7-5-5.9-5.3-.2-.3-1.4-1.8-1.4-3.5 0-1.7.9-2.5 1.2-2.9.3-.3.7-.4.9-.4h.7c.2 0 .5-.1.7.5.2.6.9 2.1 1 2.3.1.2.1.5 0 .7-.1.2-.2.4-.4.6-.2.2-.3.3-.5.5-.2.2-.4.4-.2.8.2.4.8 1.3 1.7 2.1 1.2 1.1 2.2 1.4 2.6 1.6.3.2.6.1.8-.1.2-.2 1-1.1 1.2-1.5.2-.4.5-.3.8-.2.3.1 2 .9 2.3 1 .3.1.5.2.6.4.1.1.1.8-.2 1.6z" fill="#0a1e3c" opacity=".92"/>
      </svg>
    </div>
    <div class="waText">
      <div class="t1">WhatsApp</div>
      <div class="t2">Chat for booking</div>
    </div>
    <div class="waClose" id="waClose" title="Hide" aria-label="Hide WhatsApp button">âœ•</div>
  </a>

  <div class="shell">
    <!-- HERO -->
    <div class="hero">
      <div class="heroMedia">
        <img src="./style/images/vivek-kumar-7k1IKQZikSc-unsplash.jpg" alt="Himachal Explorer" onerror="this.style.display='none';">
      </div>

      <div class="heroBar">
        <div class="heroBrand">
          <div class="logo">
            <img src="./style/images/logo.png" alt="Himachal Explorer Logo" onerror="this.remove(); this.parentNode.textContent='HP';">
          </div>
          <div class="brandText">
            <div class="heroTitle">Himachal Explorer Portal</div>
            <div class="heroSub" id="statusLine">Loadingâ€¦</div>
          </div>
        </div>

        <div class="heroRight">
          <div class="chip primary" id="mintLoginBtn">Mint Login</div>
          <div class="chip" id="refreshBtn">Refresh</div>
          <div class="chip" id="fitMapBtn">Fit Route</div>
          <div class="chip" id="clearRouteBtn">Clear</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- LEFT -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Trip Filters</p>
            <div class="s">Start + days + category</div>
          </div>
          <div class="s" id="leftHint">Quick selection</div>
        </div>

        <div class="sideInner">
          <div class="sideCard">
            <div class="field">
              <label>Start City / Pickup</label>
              <input id="startInp" list="startList" placeholder="E.g. SHIMLA / CHANDIGARH / DELHI" autocomplete="off">
              <datalist id="startList"></datalist>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Package Category</label>
              <select id="visitType">
                <option value="budget">BUDGET</option>
                <option value="premium">PREMIUM</option>
                <option value="luxury">LUXURY</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Trip Duration (Days)</label>
              <select id="daysSel">
                <option value="">ANY</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                <option>11</option><option>12</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Travellers (Pax)</label>
              <select id="paxSel">
                <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
              </select>
            </div>

            <div class="btnRow">
              <button class="btn secondary" id="resetBtn" type="button">Reset Filters</button>
              <button class="btn" id="genBtn" type="button">Show Packages</button>
            </div>

            <div class="pills" id="pills"></div>
          </div>

          <div class="otherWrap">
            <div class="otherHdr">
              <div class="h">Other Packages</div>
              <div class="xBtn" id="closeSelectedBtn" title="Close selected package">Close</div>
            </div>
            <div class="otherList" id="otherPkgList">
              <div class="otherHint">
                Select a package in the center. <br>
                After selection, remaining packages will appear here (compact list).
              </div>
            </div>
          </div>

          <div class="sideCard">
            <div class="muted" style="text-transform:none;letter-spacing:.02em;">
              Tip: Select <b>Start City</b>, optionally <b>Days</b>, then click <b>Show Packages</b>.
              Pricing is pulled from Firebase per-person and multiplied by Travellers.
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Packages</p>
            <div class="s" id="centerHint">Grid tiles â†’ click to open itinerary</div>
          </div>
          <div class="s" id="pkgCount">â€”</div>
        </div>

        <div class="centerInner">
          <div class="districtBar" id="districtBar"></div>

          <div class="centreHero" id="centreHero">
            <img id="centreHeroImg" src="./style/images/kinnaur-kailash.webp" alt="Himachal Pradesh" onerror="this.src='./style/images/n1.jpg'">
            <div class="centreHeroContent">
              <div class="tag">Himachal Explorer Portal</div>
              <div class="h">Discover Himachal Pradesh</div>
              <div class="p">Mountains â€¢ Valleys â€¢ Temples â€¢ Treks â€¢ Hidden Places â€¢ Road Trips</div>
              <div class="tag" id="modeTag">Mode: â€”</div>
            </div>
          </div>

          <div class="pkgList" id="pkgList">
            <div class="pill"><b>Choose Start</b> then click <b>Show Packages</b></div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="pane mapPane">
        <div class="paneHdr">
          <div>
            <p class="t">Live Route Map</p>
            <div class="s">OSRM road polyline + day-wise pins</div>
          </div>
          <div class="s" id="kmBadge">â€”</div>
        </div>

        <div id="map"></div>

        <div class="mapTools">
          <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
          <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
          <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      <div class="footInner">
        <div class="footTopRow">
          <div class="footLeft">Â© <span id="yy"></span> Himachal Explorer Portal</div>
          <div class="footLinks">
            <a href="#" id="topLink">Top</a>
            <a href="./index.html">Change Mode</a>
            <a href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
               target="_blank" rel="noopener">WhatsApp</a>
          </div>
        </div>

        <div class="footerFancyGrid">
          <div class="footerAboutGrid">
            <div class="footerBox">
              <div class="footerTitle">
                About Website <span class="tag">Live Portal</span>
              </div>
              <ul>
                <li>Route map + stop markers (OSRM)</li>
                <li>Day-wise itinerary with place popups</li>
                <li>Pricing from Firebase + rule-based markup</li>
                <li>Instant WhatsApp booking query</li>
                <li>District guide integration</li>
              </ul>
            </div>

            <div class="footerBox">
              <div class="footerTitle">
                About Us <span class="tag">Quality</span>
              </div>
              <ul>
                <li>Comfort-focused travel planning</li>
                <li>Verified hotel coordination</li>
                <li>Family & elder-friendly route design</li>
                <li>Clear communication & honest pricing</li>
                <li>We are new â€” but quality is non-negotiable</li>
              </ul>
            </div>
          </div>

          <div class="footerDistrictBox">
            <div>
              <div class="footerTitle">
                Explore District <span class="tag">Guides</span>
              </div>
              <div class="help">Pick a district to open its guide page.</div>
            </div>

            <select id="districtSelect">
              <option value="">Select District</option>
              <option value="./districts/bilaspur.html">Bilaspur</option>
              <option value="./districts/chamba.html">Chamba</option>
              <option value="./districts/hamirpur.html">Hamirpur</option>
              <option value="./districts/kangra.html">Kangra</option>
              <option value="./districts/kinnaur.html">Kinnaur</option>
              <option value="./districts/kullu.html">Kullu</option>
              <option value="./districts/lahaul-spiti.html">Lahaul & Spiti</option>
              <option value="./districts/mandi.html">Mandi</option>
              <option value="./districts/shimla.html">Shimla</option>
              <option value="./districts/sirmaur.html">Sirmaur</option>
              <option value="./districts/solan.html">Solan</option>
              <option value="./districts/una.html">Una</option>
            </select>
          </div>
        </div>
      </div>
    </footer>
  </div><!-- /shell -->

  <!-- âœ… DO NOT REMOVE: botToast -->
  <div class="botToast" id="botToast">ðŸ‘‹ Welcome! Choose Start â†’ Show Packages.</div>

  <!-- âœ… DO NOT REMOVE: Place Modal -->
  <div class="placeModal" id="placeModal" role="dialog" aria-modal="true">
    <div class="placeCard">
      <div class="placeCardTop">
        <div class="ttl" id="pmTitle">PLACE</div>
        <button class="placeClose" id="pmClose" type="button">Close</button>
      </div>
      <div class="placeBody">
        <div class="placeGallery">
          <img id="pmImg" src="" alt="Place photo" onerror="this.style.display='none'">
        </div>
        <div class="placeText">
          <div class="k">Overview</div>
          <div class="v" id="pmDesc">â€”</div>

          <div style="height:10px"></div>
          <div class="k">Details</div>
          <div class="v" id="pmMeta">â€”</div>

          <div class="placeActions" id="pmActions"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* =========================================================
     âœ… FINAL DASHBOARD PAGE (Edited)
     - Desktop: 3-4 packages; Mobile: 2-column grid
     - On package open: only selected in center (row) and others shift to LEFT sidebar
     - Fixed: broken getNearbySuggestions + CSS media braces
     - Added: cost breakdown (baseâ†’markupâ†’discountâ†’final) + savings
     - Added: nearby photo+name cards
     ========================================================= */

  /* ===== TOUR MODE from Landing ===== */
  let TOUR_MODE = null; // "outside" | "intercity"
  function initModeFromLanding(){
    const qs = new URLSearchParams(location.search);
    const modeQS = (qs.get("mode") || "").toLowerCase();
    const modeLS = (localStorage.getItem("travel_origin") || "").toLowerCase();
    const origin = modeQS || modeLS || "within"; // within|outside
    TOUR_MODE = (origin === "outside") ? "outside" : "intercity";
    const mt = document.getElementById("modeTag");
    if(mt) mt.textContent = `Mode: ${TOUR_MODE === "outside" ? "Outside Himachal" : "Within Himachal"}`;
    showBot(`âœ… Mode: ${TOUR_MODE === "outside" ? "Outside Himachal" : "Within Himachal"} selected`);
  }

  /* ===== Firebase Config ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
    authDomain: "revnue-records.firebaseapp.com",
    databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "revnue-records",
    storageBucket: "revnue-records.firebasestorage.app",
    messagingSenderId: "182348503564",
    appId: "1:182348503564:web:480085405b09177245ac29",
    measurementId: "G-MGTDBCG896"
  };

  const NODE_TEMPLATES  = "templates";
  const NODE_PLACES     = "places";
  const NODE_COSTS      = "package_cost_breakdown";

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg){ $("statusLine").textContent = msg; }
  function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function normCaps(x){ return String(x||"").trim().toUpperCase().replace(/\s+/g," "); }
  function rupees(n){ return "â‚¹" + Math.round(Number(n)||0).toLocaleString("en-IN"); }
  function slugifyName(name){
    return String(name||"")
      .trim().toLowerCase()
      .replace(/&/g," and ")
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }

  /* âœ… DO NOT REMOVE: botToast */
  function showBot(msg){
    const el = $("botToast");
    if(!el) return;
    el.innerHTML = msg || "ðŸ‘‹ Welcome!";
    el.classList.add("show");
    clearTimeout(showBot._t);
    showBot._t = setTimeout(()=> el.classList.remove("show"), 3600);
  }

  /* âœ… Place images (Firebase first, then /Places fallback) */
  const PLACES_IMG_BASE = "./Places/";
  const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/champishere001/Himachal_Explorer/main/Places/";
  const IMG_BASE = PLACES_IMG_BASE;  // change to GITHUB_RAW_BASE if needed
  const IMG_MAX = 4;

  function getPlacePhotos(place, placeId){
    const out = [];
    ["photo_1","photo_2","photo_3","image","img","cover"].forEach(k=>{
      const v = String(place?.[k] || "").trim();
      if(v) out.push(v);
    });
    const pid = String(placeId || place?.place_id || place?.id || "").trim();
    if(pid){
      for(let i=1; i<=IMG_MAX; i++){
        out.push(`${IMG_BASE}${pid}_${i}.jpg`);
        out.push(`${IMG_BASE}${pid}_${i}.jpeg`);
        out.push(`${IMG_BASE}${pid}_${i}.png`);
        out.push(`${IMG_BASE}${pid}_${i}.webp`);
      }
    }
    return Array.from(new Set(out));
  }

  /* âœ… DO NOT REMOVE: place modal */
  function openPlaceModal({ place, dayNum, orderNum, placeId }){
    const modal = $("placeModal");
    const ttl = $("pmTitle");
    const img = $("pmImg");
    const desc = $("pmDesc");
    const meta = $("pmMeta");
    const actions = $("pmActions");

    const name = placeNameAny(place, placeId);
    const dist = districtAny(place) || "â€”";
    const lat = latAny(place), lng = lngAny(place);

    ttl.textContent = `${name} â€¢ Day ${dayNum}${orderNum ? " â€¢ Stop " + orderNum : ""}`;

    const photos = getPlacePhotos(place, placeId);
    let idx = 0;
    img.style.display = "block";
    img.onerror = ()=>{
      idx += 1;
      if(idx < photos.length){
        img.style.display = "block";
        img.src = photos[idx];
      }else{
        img.style.display = "none";
      }
    };
    img.src = photos[0] || "./style/images/n1.jpg";

    const short =
      String(place?.history_tagline || place?.what_you_find || place?.description || "")
      .trim() || "Beautiful spot in Himachal Pradesh. Tap directions to navigate.";

    desc.textContent = short;

    meta.innerHTML = `
      <div><b>District:</b> ${escapeHtml(dist)}</div>
      <div><b>Coordinates:</b> ${isFinite(lat)&&isFinite(lng) ? `${lat.toFixed(5)}, ${lng.toFixed(5)}` : "â€”"}</div>
      <div><b>Category:</b> ${escapeHtml(String(place?.category || "â€”"))}</div>
      <div><b>Segment:</b> ${escapeHtml(String(place?.segment || "â€”"))}</div>
    `;

    const gmaps = (isFinite(lat) && isFinite(lng))
      ? `https://www.google.com/maps?q=${lat},${lng}`
      : "";

    actions.innerHTML = `
      ${gmaps ? `<a href="${gmaps}" target="_blank" rel="noopener">Open in Maps</a>` : ""}
      <a href="#" id="pmNextPhoto">Next Photo</a>
    `;

    const next = document.getElementById("pmNextPhoto");
    if(next){
      next.onclick = (e)=>{
        e.preventDefault();
        if(!photos.length) return;
        idx = (idx + 1) % photos.length;
        img.style.display = "block";
        img.src = photos[idx];
      };
    }

    modal.classList.add("show");
  }
  function closePlaceModal(){ $("placeModal")?.classList.remove("show"); }

  /* ===== Helpers for places/templates ===== */
  function placeIdAny(p, key){ return String(p?.place_id || p?.id || key || "").trim(); }
  function placeNameAny(p, key){ return String(p?.name || p?.["Location Name"] || p?.title || key || "PLACE").trim(); }
  function latAny(p){ return Number(p?.latitude ?? p?.lat ?? p?.Latitude); }
  function lngAny(p){ return Number(p?.longitude ?? p?.lng ?? p?.Longitude); }
  function districtAny(p){ return String(p?.district || p?.District || "").trim().toUpperCase(); }

  function haversineKm(lat1, lon1, lat2, lon2){
    const toRad = (d)=> (d*Math.PI)/180;
    const R = 6371;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function isLocalComputed(tpl){
    const routeId = String(tpl.route_id || "").toUpperCase().trim();
    const regionStyle = String(tpl.region_style || "").toLowerCase().trim();
    const pkgId = String(tpl.package_id || tpl.key || "").toLowerCase();
    return regionStyle === "local" || routeId.endsWith("-LCL") || pkgId.includes("-local");
  }

  /* ===== Map ===== */
  let map, tile, tileDark, markersLayer, routeLine;
  let showMode = "all";
  let tilesDark = false;

  function invalidateMapSoon(){
    try{
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 60);
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 260);
    }catch(e){}
  }
  function initMap(){
    map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
    tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    tile.addTo(map);

    tileDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 });

    markersLayer = L.layerGroup().addTo(map);
    invalidateMapSoon();
    window.addEventListener("resize", invalidateMapSoon, { passive:true });
  }
  function clearMap(){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    $("kmBadge").textContent = "â€”";
    invalidateMapSoon();
  }
  function dayIconHTML(day, order){
    return `
      <div style="
        width:34px;height:34px;border-radius:999px;
        display:grid;place-items:center;
        border:1px solid rgba(10,30,60,.22);
        background: rgba(255,255,255,.92);
        box-shadow: 0 10px 22px rgba(10,30,60,.14);
        font-family: ui-sans-serif,system-ui;">
        <div style="text-align:center;line-height:1;">
          <div style="font-size:10px;font-weight:950;letter-spacing:.10em;">D${day}</div>
          <div style="font-size:11px;font-weight:1000;">${order}</div>
        </div>
      </div>`;
  }

  /* ===== Data ===== */
  let db, analytics;
  function trackEvent(name, params={}){
    try{ if(analytics && typeof analytics.logEvent === 'function'){ analytics.logEvent(name, params); } }catch(e){}
  }

  let TEMPLATES = {};
  let PLACES = {};
  let COSTS = {};
  let NAME_TO_ID = new Map();
  let STARTS = [];
  let ACTIVE_TEMPLATES = [];
  let INTER_ALL = [];
  let DISTRICT_KEYS = [];
  let ACTIVE_DISTRICT = "ALL";
  let CURRENT_TEMPLATE_KEY = "";
  let CURRENT_DAY_INDEX = new Map();
  let CURRENT_ROUTE_KM = 0;
  let CURRENT_ROUTE_HRS = 0;
  let LOADING = false;

  function renderSkeleton(targetEl){
    if(!targetEl) return;
    const wrap = document.createElement('div');
    wrap.className = 'skGrid';
    for(let i=0;i<8;i++){
      const c = document.createElement('div');
      c.className = 'skCard';
      c.innerHTML = `<div class="skTop"></div><div class="skBottom"><div class="skLine w80"></div><div class="skLine w60"></div><div class="skLine w40"></div></div><div class="skShimmer"></div>`;
      wrap.appendChild(c);
    }
    targetEl.innerHTML = '';
    targetEl.appendChild(wrap);
  }

  function buildNameIndex(){
    NAME_TO_ID = new Map();
    for(const [key, p] of Object.entries(PLACES||{})){
      const id = placeIdAny(p, key);
      const nm = placeNameAny(p, id);
      if(id) NAME_TO_ID.set(String(id).toLowerCase(), id);
      if(nm) NAME_TO_ID.set(String(nm).toLowerCase(), id);
    }
  }
  function getPlaceIdByNameAny(name){
    const nm = String(name || "").trim();
    if(!nm) return "";
    const direct = NAME_TO_ID.get(nm.toLowerCase());
    if(direct && PLACES[direct]) return direct;
    const slug = slugifyName(nm);
    if(slug && PLACES[slug]) return slug;
    return "";
  }

  function buildStartList(templates){
    const counts = new Map();
    templates.forEach(t=>{
      const s = String(t.start_point || t.start || "").trim();
      if(!s) return;
      const key = s.toUpperCase();
      const cur = counts.get(key) || { local:0, inter:0 };
      if(isLocalComputed(t)) cur.local += 1;
      else cur.inter += 1;
      counts.set(key, cur);
    });

    const arr = Array.from(counts.entries()).map(([k,v])=>({ key:k, ...v }));
    arr.sort((a,b)=>{
      const aPri = (TOUR_MODE==="outside") ? a.inter : a.local;
      const bPri = (TOUR_MODE==="outside") ? b.inter : b.local;
      if(bPri !== aPri) return bPri - aPri;
      return a.key.localeCompare(b.key);
    });

    STARTS = arr.map(x=>x.key);
    const dl = $("startList");
    dl.innerHTML = "";
    arr.forEach(x=>{
      const opt = document.createElement("option");
      opt.value = x.key;
      dl.appendChild(opt);
    });
  }

  function normalizeStartInput(){
    const typed = String($("startInp").value || "").trim().toUpperCase();
    if(!typed) return "";
    const exact = STARTS.find(s => s === typed);
    if(exact) return exact;
    const partial = STARTS.find(s => s.startsWith(typed));
    if(partial) return partial;
    return "";
  }

  function getSelectedPax(){
    const v = Number($("paxSel")?.value || 2);
    return (isFinite(v) && v > 0) ? v : 2;
  }

  function stopsFromTemplate(tpl){
    const days = Number(tpl.days || 1);
    const out = [];
    const seen = new Set();

    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      if(!raw) continue;
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
        if(seen.has(pid)) return;
        seen.add(pid);
        out.push(pid);
      });
    }
    if(!out.length){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>out.push(pid));
    }
    return out;
  }

  function routeIdsFromTemplateIncludingStart(tpl){
    const baseStops = stopsFromTemplate(tpl);
    const startName = String(tpl?.start_point || tpl?.start || "").trim();
    const startPid = getPlaceIdByNameAny(startName);
    if(startPid){
      const filtered = baseStops.filter(x => x !== startPid);
      return [startPid, ...filtered];
    }
    return baseStops;
  }

  function getEndNameFromRoutePath(tpl){
    const start = String(tpl.start_point || tpl.start || "").trim().toLowerCase();
    const rpRaw = String(tpl.route_path || "").trim();
    if(!rpRaw) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";
    const tokens = rpRaw.replace(/->/g,"|").replace(/>/g,"|")
      .split("|").map(x=>String(x||"").trim()).filter(Boolean);
    if(!tokens.length) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";
    let end = tokens[tokens.length - 1];
    if(end && start && end.toLowerCase() === start && tokens.length >= 2) end = tokens[tokens.length - 2];
    return end || "UNKNOWN";
  }
  function endDistrictFromTemplate(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const pid = getPlaceIdByNameAny(endName);
    if(pid && PLACES[pid]){
      const d = districtAny(PLACES[pid]);
      if(d) return d;
    }
    const td = String(tpl.district || tpl.end_district || "").trim().toUpperCase();
    if(td) return td;
    return normCaps(endName || "UNKNOWN");
  }
  function endKeyFromRoutePath(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const pid = getPlaceIdByNameAny(endName);
    if(pid && PLACES[pid]){
      const d = districtAny(PLACES[pid]);
      return d || normCaps(endName);
    }
    return normCaps(endName);
  }

  function matchesStart(tpl, startUpper){
    return String(tpl.start_point||tpl.start||"").trim().toUpperCase() === startUpper;
  }
  function matchesDaysOptional(tpl, daysFilter){
    if(!daysFilter) return true;
    return Number(tpl.days||0) === Number(daysFilter);
  }

  function buildDayWise(tpl){
    const days = Number(tpl.days || 1);
    const blocks = [];
    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      blocks.push({ day:d, ids });
    }
    const anyHas = blocks.some(x=>x.ids.length);
    if(!anyHas){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      return [{ day:1, ids }];
    }
    return blocks.filter(x=>x.ids.length);
  }
  function makeDayIndexFromTemplate(tpl){
    const blocks = buildDayWise(tpl);
    const mp = new Map();
    blocks.forEach((b)=>{
      b.ids.forEach((pid, i)=>{
        mp.set(pid, { day: b.day, order: i+1 });
      });
    });
    return mp;
  }

  /* âœ… FIXED: nearby suggestions (no stray code outside function) */
  function getNearbySuggestions(anchorPid, limit = 5, maxKm = 18){
    const a = PLACES[anchorPid];
    if(!a) return [];
    const distA = districtAny(a);

    const lat1 = latAny(a), lng1 = lngAny(a);
    const hasA = isFinite(lat1) && isFinite(lng1);

    const scored = [];
    for(const [pid, p] of Object.entries(PLACES)){
      if(pid === anchorPid) continue;

      const lat2 = latAny(p), lng2 = lngAny(p);
      const hasB = isFinite(lat2) && isFinite(lng2);

      if(hasA && hasB){
        const km = haversineKm(lat1, lng1, lat2, lng2);
        if(km > maxKm) continue;
        const bonus = (distA && districtAny(p) === distA) ? -0.6 : 0;
        scored.push({ pid, score: km + bonus, km });
        continue;
      }
      if(distA && districtAny(p) === distA){
        scored.push({ pid, score: 999, km: 999 });
      }
    }

    scored.sort((x,y)=>x.score - y.score);

    const out = [];
    const seen = new Set();
    for(const s of scored){
      if(seen.has(s.pid)) continue;
      seen.add(s.pid);
      out.push(s.pid);
      if(out.length >= limit) break;
    }
    return out;
  }

  /* ===== Pricing ===== */
  function getPerPersonPrice(tpl){
    const tier = String($("visitType")?.value || "budget").toLowerCase();
    const pid = String(tpl.package_id || tpl.key || "").trim();
    const node = COSTS?.[pid] || COSTS?.[String(pid).toLowerCase()] || null;
    const src = node || tpl || {};
    const b = Number(src.budget_price_per_person ?? src.budget ?? src.budget_pp ?? 0);
    const p = Number(src.premium_price_per_person ?? src.premium ?? src.premium_pp ?? 0);
    const l = Number(src.luxury_price_per_person ?? src.luxury ?? src.luxury_pp ?? 0);
    if(tier === "premium") return isFinite(p) && p>0 ? p : NaN;
    if(tier === "luxury")  return isFinite(l) && l>0 ? l : NaN;
    return isFinite(b) && b>0 ? b : NaN;
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function computeMarkupPct(tpl, pax){
    const days = Number(tpl?.days || 0) || 0;
    const local = isLocalComputed(tpl);
    const lowPax = Number(pax || 0) <= 2;

    if(local && days <= 2 && lowPax){
      let pct = 5 + (days === 2 ? 5 : 2.5);
      if(Number(pax) === 1) pct += 1.5;
      return clamp(pct, 5, 10);
    }
    if(days >= 6){
      const pct = 10 + ((clamp(days, 6, 12) - 6) / (12 - 6)) * 5;
      return clamp(pct, 10, 15);
    }
    if(days >= 3){
      const pct = 8 + ((clamp(days, 3, 5) - 3) / (5 - 3)) * 2;
      return clamp(pct, 8, 10);
    }
    return 6.5;
  }
  function applyMarkup(perPersonBase, markupPct){
    const base = Number(perPersonBase || 0);
    if(!isFinite(base) || base <= 0) return NaN;
    const pct = Number(markupPct || 0);
    return Math.round(base * (1 + pct/100));
  }

  /* âœ… Added: discount + final price */
  function computeDiscountPct(tpl, pax){
    const P = Number(pax||0);
    if(P >= 8) return 7;
    if(P >= 6) return 5;
    if(P >= 4) return 3;
    return 0;
  }
  function applyDiscount(amount, discountPct){
    const a = Number(amount||0);
    const d = Number(discountPct||0);
    if(!isFinite(a) || a<=0) return NaN;
    if(!isFinite(d) || d<=0) return Math.round(a);
    return Math.round(a * (1 - d/100));
  }

  const WHATSAPP_NUMBER = "917018138847";
  const CALL_NUMBER = "+91 70181 38847";
  const EMAIL_ID = "info@himachalexplorer.in";
  function buildWhatsAppMessage({tpl, startName, endKey, pax, tier, km, total, perPerson, markupPct}){
    const days = Number(tpl?.days || 0) || 0;
    const code = String(tpl?.route_id || "â€”");
    const route = String(tpl?.route_path || "").trim();
    const includes = String(tpl?.includes || tpl?.inclusions || "").trim();
    const lines = [
      "Hi Chandan, I want to finalize this package:",
      "",
      `Mode: ${TOUR_MODE === "intercity" ? "WITHIN HP" : "OUTSIDE HP"}`,
      `Start: ${String(startName||"").toUpperCase()}`,
      `Destination: ${String(endKey||"").toUpperCase()}`,
      `Days: ${days}`,
      `Type: ${String(tier||"").toUpperCase()}`,
      `Pax: ${pax}`,
      `Route KM (est.): ${isFinite(km)?Number(km).toFixed(1):"â€”"}`,
      `Markup: ${isFinite(markupPct)?Number(markupPct).toFixed(1)+"%":"â€”"}`,
      `Per Person (final): ${isFinite(perPerson)?rupees(perPerson):"â€”"}`,
      `Total (final): ${isFinite(total)?rupees(total):"â€”"}`,
      `Code: ${code}`,
      route ? `Route: ${route}` : "",
      includes ? `Includes: ${includes}` : "",
      "",
      "Please confirm final price and availability."
    ].filter(Boolean);
    return lines.join("\n");
  }

  function setCentreHeroVisible(on){
    const hero = $("centreHero");
    if(!hero) return;
    hero.style.display = on ? "block" : "none";
  }

  /* ===== Centre hero slideshow ===== */
  const CENTRE_HERO_IMAGES = ["./style/images/kinnaur-kailash.webp","./style/images/n1.jpg","./style/images/temple.jpg","./style/images/trek.jpeg"];
  let heroIdx = 0;
  function startCentreHero(){
    const img = $("centreHeroImg");
    if(!img) return;
    setInterval(()=>{
      heroIdx = (heroIdx + 1) % CENTRE_HERO_IMAGES.length;
      img.style.opacity = 0;
      setTimeout(()=>{
        img.src = CENTRE_HERO_IMAGES[heroIdx];
        img.style.opacity = 1;
      }, 250);
    }, 4200);
  }

  /* ===== OSRM route drawing ===== */
  async function drawRoadRouteFromPlaces(placeIds, dayIndex = new Map()){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }

    const pts = [];
    const validIds = [];
    for(const pid of placeIds){
      const p = PLACES[pid] || {};
      const lat = latAny(p);
      const lng = lngAny(p);
      if(isFinite(lat) && isFinite(lng)){
        pts.push([lng,lat]);
        validIds.push(pid);
      }
    }
    if(pts.length < 2) return { ok:false, km:0, hrs:0 };

    const maxPts = 25;
    let used = pts;
    if(pts.length > maxPts){
      const step = Math.ceil(pts.length / maxPts);
      used = pts.filter((_,i)=> i%step===0 || i===pts.length-1);
    }

    try{
      const url =
        "https://router.project-osrm.org/route/v1/driving/" +
        used.map(c=>c.join(",")).join(";") +
        "?overview=full&geometries=geojson&steps=false";

      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes?.length) return { ok:false, km:0, hrs:0 };

      const r = data.routes[0];
      const latlngs = r.geometry.coordinates.map(c=>[c[1],c[0]]);
      routeLine = L.polyline(latlngs, { weight: 5, opacity: .95 }).addTo(map);
      map.fitBounds(routeLine.getBounds(), { padding:[22,22] });
      invalidateMapSoon();

      const markIds = (showMode==="startend")
        ? [validIds[0], validIds[validIds.length-1]]
        : validIds;

      for(const pid of markIds){
        const p = PLACES[pid] || {};
        const lat = latAny(p);
        const lng = lngAny(p);
        if(!isFinite(lat)||!isFinite(lng)) continue;

        const di = dayIndex.get(pid) || { day: 1, order: 1 };
        const icon = L.divIcon({
          className: "",
          html: dayIconHTML(di.day || 1, di.order || 1),
          iconSize: [34,34],
          iconAnchor: [17,17]
        });

        const m = L.marker([lat,lng], { riseOnHover:true, icon }).addTo(markersLayer);

        const nm = placeNameAny(p, pid);
        const dist = districtAny(p) || "";
        const photos = getPlacePhotos(p, pid);
        const hero = photos[0] || "";

        m.bindPopup(
          `<div style="font-family:ui-sans-serif,system-ui;letter-spacing:.02em;max-width:280px">
            ${hero ? `<img src="${escapeHtml(hero)}" onerror="this.remove()"
              style="width:100%;height:140px;object-fit:cover;border-radius:12px;border:1px solid rgba(10,30,60,.14);margin-bottom:8px" />` : ""}
            <b style="letter-spacing:.08em;text-transform:uppercase;">${escapeHtml(nm)}</b><br>
            <span style="opacity:.75">${escapeHtml(dist)}</span><br>
            <span style="opacity:.65;font-size:12px">${Number(lat).toFixed(5)}, ${Number(lng).toFixed(5)}</span>
          </div>`,
          { maxWidth: 300 }
        );

        m.on("click", ()=>{
          const di2 = dayIndex.get(pid) || { day: 1, order: 1 };
          openPlaceModal({ place:p, dayNum: di2.day || 1, orderNum: di2.order || 1, placeId: pid });
        });
      }

      const km = Number(r.distance/1000);
      const hrs = Number(r.duration/3600);
      $("kmBadge").textContent = (isFinite(km)?km.toFixed(1):"â€”") + " KM";
      return { ok:true, km, hrs };
    }catch(e){
      console.error(e);
      return { ok:false, km:0, hrs:0 };
    }
  }

  /* ===== Render package details ===== */
  function renderInlineDetails(detailsEl, tpl, startUpper, endKey, km){
    const pax = getSelectedPax();
    const tier = String($("visitType")?.value || "budget").toUpperCase();

    const perPersonBase = getPerPersonPrice(tpl);
    const markupPct = computeMarkupPct(tpl, pax);
    const perPersonAfterMarkup = applyMarkup(perPersonBase, markupPct);

    const discountPct = computeDiscountPct(tpl, pax);
    const perPersonFinal = applyDiscount(perPersonAfterMarkup, discountPct);

    const totalFinal = isFinite(perPersonFinal) ? (perPersonFinal * pax) : NaN;
    const totalNoDiscount = isFinite(perPersonAfterMarkup) ? (perPersonAfterMarkup * pax) : NaN;
    const savings = (isFinite(totalNoDiscount) && isFinite(totalFinal)) ? (totalNoDiscount - totalFinal) : NaN;

    const waBtnId = `wa_inline_${tpl.key}`;
    detailsEl.innerHTML = `
      <div class="detailsCard">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div style="min-width:220px;flex:1">
            <h3 class="bigTitle">${escapeHtml(String(startUpper||"START").toUpperCase())} â†’ ${escapeHtml(String(endKey||"").toUpperCase())}</h3>
            <div class="muted" style="margin-top:6px; text-transform:none; letter-spacing:.02em;">
              ${escapeHtml(String(tpl.route_path || tpl.route_id || "").trim() || "â€”")}
            </div>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <div class="mini" style="min-width:170px">
              <div class="k">Total (final)</div>
              <div class="v">${isFinite(totalFinal)?rupees(totalFinal):"â€”"} <small>(${escapeHtml(tier)})</small></div>
            </div>
            <div class="mini" style="min-width:170px">
              <div class="k">Per Person (final)</div>
              <div class="v">${isFinite(perPersonFinal)?rupees(perPersonFinal):"â€”"} <small>after discount</small></div>
            </div>
          </div>
        </div>

        <div class="detailsGrid" style="margin-top:10px;">
          <div class="mini"><div class="k">Base PP</div><div class="v">${isFinite(perPersonBase)?rupees(perPersonBase):"â€”"} <small>Firebase</small></div></div>
          <div class="mini"><div class="k">Markup</div><div class="v">${isFinite(markupPct)?Number(markupPct).toFixed(1)+"%":"â€”"} <small>rule</small></div></div>
          <div class="mini"><div class="k">After Markup</div><div class="v">${isFinite(perPersonAfterMarkup)?rupees(perPersonAfterMarkup):"â€”"} <small>PP</small></div></div>
          <div class="mini"><div class="k">Discount</div><div class="v">${Number(discountPct||0).toFixed(0)}% <small>pax-based</small></div></div>
          <div class="mini"><div class="k">Travellers</div><div class="v">${escapeHtml(String(pax))} <small>selected</small></div></div>
          <div class="mini"><div class="k">You Save</div><div class="v">${isFinite(savings)&&savings>0?rupees(savings):"â€”"} <small>total</small></div></div>
          <div class="mini"><div class="k">Route</div><div class="v">${(isFinite(km)&&km>0)?Number(km).toFixed(1):"â€”"} <small>KM</small></div></div>
          <div class="mini"><div class="k">Time</div><div class="v">${(isFinite(CURRENT_ROUTE_HRS)&&CURRENT_ROUTE_HRS>0)?(Number(CURRENT_ROUTE_HRS).toFixed(1)):"â€”"} <small>hrs est.</small></div></div>
        </div>

        <div class="enqRow">
          <a id="${waBtnId}" class="enqBtn disabled" href="#" target="_blank" rel="noopener">Send Query on WhatsApp</a>
          <a class="enqBtn" id="call_${tpl.key}" href="tel:${CALL_NUMBER.replace(/\s/g, '')}" style="border-color: rgba(37,99,235,.30);background: rgba(37,99,235,.14);box-shadow: 0 12px 28px rgba(37,99,235,.12);">Call Now</a>
          <a class="enqBtn" id="mail_${tpl.key}" href="mailto:${EMAIL_ID}?subject=${encodeURIComponent('Himachal Tour Package Enquiry')}" style="border-color: rgba(10,30,60,.16);background: rgba(255,255,255,.66);">Email</a>
        </div>

        <div class="muted" style="margin-top:10px;text-transform:none;letter-spacing:.02em;">
          Road route controls (works on mobile + desktop):
        </div>
        <div class="routeInlineTools">
          <div class="toolBtn" data-act="stops">Show Stops</div>
          <div class="toolBtn" data-act="startend">Start/End Only</div>
          <div class="toolBtn" data-act="fit">Fit Route</div>
          <div class="toolBtn" data-act="tiles">Toggle Tiles</div>
        </div>
      </div>

      <div class="daysList" id="days_${tpl.key}" style="margin-top:10px;"></div>
    `;

    const toolWrap = detailsEl.querySelector(".routeInlineTools");
    if(toolWrap){
      toolWrap.querySelectorAll(".toolBtn").forEach(btn=>{
        btn.onclick = async (e)=>{
          e.preventDefault(); e.stopPropagation();
          const act = btn.getAttribute("data-act");
          if(act === "stops"){ $("showAllStopsBtn").click(); }
          else if(act === "startend"){ $("showStartEndBtn").click(); }
          else if(act === "fit"){ $("fitMapBtn").click(); }
          else if(act === "tiles"){ $("toggleTilesBtn").click(); }
        };
      });
    }

    const startName = normalizeStartInput() || (tpl.start_point || tpl.start || startUpper || "");
    const msg = buildWhatsAppMessage({ tpl, startName, endKey, pax, tier, km, total: totalFinal, perPerson: perPersonFinal, markupPct });
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
    const waEl = document.getElementById(waBtnId);
    if(isFinite(perPersonFinal)){
      waEl.classList.remove("disabled");
      waEl.href = url;
    }
    if(waEl){
      waEl.onclick = (e)=>{ e.stopPropagation(); trackEvent('enquiry_whatsapp', { package_key: String(tpl.key||''), route_id: String(tpl.route_id||''), start: String(startName||''), end: String(endKey||''), pax: Number(pax||0) }); };
    }
    const callEl = document.getElementById(`call_${tpl.key}`);
    if(callEl){ callEl.onclick = (e)=>{ e.stopPropagation(); trackEvent('enquiry_call', { package_key: String(tpl.key||''), route_id: String(tpl.route_id||'') }); }; }
    const mailEl = document.getElementById(`mail_${tpl.key}`);
    if(mailEl){ mailEl.onclick = (e)=>{ e.stopPropagation(); trackEvent('enquiry_email', { package_key: String(tpl.key||''), route_id: String(tpl.route_id||'') }); }; }

    const daysWrap = document.getElementById(`days_${tpl.key}`);
    const blocks = buildDayWise(tpl);

    blocks.forEach(block=>{
      const dayCard = document.createElement("div");
      dayCard.className = "dayCard";
      dayCard.innerHTML = `
        <div class="dayTop">
          <div class="d">Day ${block.day}</div>
          <div class="muted" style="text-transform:none;letter-spacing:.02em;">${block.ids.length} places</div>
        </div>
        <div class="muted" style="text-transform:none;letter-spacing:.02em;">Places</div>
        <div class="dayPlaces"></div>
      `;
      const cont = dayCard.querySelector(".dayPlaces");

      block.ids.forEach((pid, idx)=>{
        const p = PLACES[pid] || {};
        const name = placeNameAny(p, pid);
        const dist = districtAny(p) || "â€”";

        const line = document.createElement("div");
        line.className = "placeBtn";
        line.innerHTML = `
          <div class="left">
            <div class="nm">${escapeHtml(name)}</div>
            <div class="sm">${escapeHtml(dist)}</div>
          </div>
          <div class="tag">Day ${block.day}</div>
        `;
        line.onclick = (e)=>{
          e.stopPropagation();
          const lat = latAny(p), lng = lngAny(p);
          if(isFinite(lat) && isFinite(lng)){
            map.setView([lat,lng], Math.max(map.getZoom(), 12), { animate:true });
            invalidateMapSoon();
          }
          openPlaceModal({ place: p, dayNum: block.day, orderNum: (idx+1), placeId: pid });
        };
        cont.appendChild(line);
      });

      const anchorPid = block.ids[0];
      const near = getNearbySuggestions(anchorPid, 6, 18);
      const nearWrap = document.createElement("div");
      nearWrap.className = "nearWrap";

      if(near.length){
        nearWrap.innerHTML = `
          <div class="nearTop">
            <div class="k">Nearby Suggestions</div>
            <div class="muted" style="text-transform:none;letter-spacing:.02em;">tap to open</div>
          </div>
          <div class="nearGrid"></div>
        `;
        const grid = nearWrap.querySelector(".nearGrid");

        near.forEach(npid=>{
          const p = PLACES[npid] || {};
          const name = placeNameAny(p, npid);
          const photos = getPlacePhotos(p, npid);
          const imgSrc = photos[0] || "";

          const card = document.createElement("div");
          card.className = "nearCard";
          card.innerHTML = `
            <div class="img">
              ${imgSrc ? `<img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(name)}" onerror="this.remove()">` : ``}
            </div>
            <div class="tx">${escapeHtml(name)}</div>
          `;

          card.onclick = (e)=>{
            e.stopPropagation();
            const lat = latAny(p), lng = lngAny(p);
            if(isFinite(lat) && isFinite(lng)){
              map.setView([lat,lng], Math.max(map.getZoom(), 12), { animate:true });
              invalidateMapSoon();
            }
            openPlaceModal({ place: p, dayNum: block.day, orderNum: 0, placeId: npid });
          };

          grid.appendChild(card);
        });
      }else{
        nearWrap.innerHTML = `
          <div class="nearTop"><div class="k">Nearby Suggestions</div></div>
          <div class="muted" style="text-transform:none;letter-spacing:.02em;">No nearby suggestions available for this stop.</div>
        `;
      }
      dayCard.appendChild(nearWrap);
      daysWrap.appendChild(dayCard);
    });
  }

  /* ===== UI rendering ===== */
  function renderDistrictChips(){
    const bar = $("districtBar");
    if(!bar) return;
    const chips = ["ALL", ...DISTRICT_KEYS];
    if(!ACTIVE_DISTRICT || !chips.includes(ACTIVE_DISTRICT)) ACTIVE_DISTRICT = "ALL";
    bar.innerHTML = chips.map(d=>{
      const active = (d===ACTIVE_DISTRICT) ? "active" : "";
      const label = (d==="ALL") ? "ALL DESTINATIONS" : d;
      const count = (d==="ALL") ? INTER_ALL.length : INTER_ALL.filter(t=>endDistrictFromTemplate(t)===d).length;
      return `<div class="distItem ${active}" data-d="${escapeHtml(d)}">${escapeHtml(label)} (${count})</div>`;
    }).join("");
    bar.querySelectorAll(".distItem").forEach(el=>{
      el.onclick = ()=>{ ACTIVE_DISTRICT = el.dataset.d || "ALL"; trackEvent('filter_district', { district: ACTIVE_DISTRICT }); renderPanels(); };
    });
  }

  function renderPackageCard(tpl, startUpper){
    const endKey = endKeyFromRoutePath(tpl);
    const local = isLocalComputed(tpl);

    const perPersonBase = getPerPersonPrice(tpl);
    const pax = getSelectedPax();
    const markupPct = computeMarkupPct(tpl, pax);
    const perPersonAfterMarkup = applyMarkup(perPersonBase, markupPct);
    const discountPct = computeDiscountPct(tpl, pax);
    const perPersonFinal = applyDiscount(perPersonAfterMarkup, discountPct);

    const firstStop = (stopsFromTemplate(tpl)[0] || "");
    const p = PLACES[firstStop] || {};
    const photos = getPlacePhotos(p, firstStop);
    const thumb = photos[0] || "";

    const badgeClass = local ? "green" : "purple";
    const badgeText = local ? "LOCAL" : "INTER";

    const el = document.createElement("div");
    el.className = "pkgW";
    el.dataset.key = tpl.key;

    el.innerHTML = `
      <div class="pkgCard">
        <div class="pkgMedia">
          ${thumb ? `<img src="${escapeHtml(thumb)}" alt="${escapeHtml(endKey)}" onerror="this.remove()">` : ``}
          <div class="pkgTagRow">
            <div class="pkgRouteId">${escapeHtml(String(tpl.route_id || tpl.package_id || "PACKAGE").toUpperCase())}</div>
            <div class="pkgBadge ${badgeClass}">${badgeText}</div>
          </div>
        </div>

        <div class="pkgInfo">
          <div class="pkgTitleRow">
            <h4 class="pkgTitle">${escapeHtml(String(endKey).toUpperCase())}</h4>
            <div class="pkgOpen">${CURRENT_TEMPLATE_KEY===tpl.key ? "Close" : "Open"}</div>
          </div>

          <div class="pkgMeta">
            <div class="pkgChip">Days <b>${escapeHtml(String(tpl.days||"â€”"))}</b></div>
            <div class="pkgChip">Start <b>${escapeHtml(startUpper)}</b></div>
            <div class="pkgChip">PP <b>${isFinite(perPersonFinal)?rupees(perPersonFinal):"â€”"}</b></div>
          </div>
        </div>
      </div>

      <div class="pkgDetails"></div>
    `;

    el.onclick = (e)=>{ e.stopPropagation(); toggleOpenTemplate(tpl.key); };
    return el;
  }

  function renderOtherPackages(list, startUpper){
    const box = $("otherPkgList");
    if(!box) return;
    box.innerHTML = "";
    if(!list.length){
      box.innerHTML = `<div class="otherHint">No other packages for this filter.</div>`;
      return;
    }
    list.forEach(tpl=>{
      const endKey = endKeyFromRoutePath(tpl);
      const local = isLocalComputed(tpl);
      const el = document.createElement("div");
      el.className = "pkgMini";
      el.innerHTML = `
        <div class="miniThumb">
          ${(() => {
            const fs = (stopsFromTemplate(tpl)[0] || "");
            const pp = PLACES[fs] || {};
            const ph = getPlacePhotos(pp, fs);
            const th = ph[0] || "";
            return th ? `<img src="${escapeHtml(th)}" alt="" onerror="this.remove()">` : `<div class="ini">${escapeHtml(endKey).slice(0,2)}</div>`;
          })()}
        </div>
        <div class="l">
          <div class="t1">${escapeHtml(String(endKey).toUpperCase())}</div>
          <div class="t2">${escapeHtml(String(tpl.route_id || tpl.package_id || "").toUpperCase())}</div>
        </div>
        <div class="r">
          <div class="miniBadge ${local ? "" : "blue"}">${local ? "LOCAL" : "INTER"}</div>
          <div class="miniOpen">Open</div>
        </div>
      `;
      el.onclick = (e)=>{ e.stopPropagation(); toggleOpenTemplate(tpl.key); };
      box.appendChild(el);
    });
  }

  function highlightActiveCard(){
    document.querySelectorAll(".pkgW").forEach(x=>x.classList.toggle("active", x.dataset.key === CURRENT_TEMPLATE_KEY));
  }

  function renderPills(startUpper){
    const pills = $("pills");
    const days = $("daysSel").value || "ANY";
    const tier = String($("visitType").value || "budget").toUpperCase();
    const pax = getSelectedPax();
    pills.innerHTML = `
      <div class="pill">Mode <b>${escapeHtml(TOUR_MODE === "outside" ? "OUTSIDE HP" : "WITHIN HP")}</b></div>
      <div class="pill">Start <b>${escapeHtml(startUpper || "â€”")}</b></div>
      <div class="pill">Days <b>${escapeHtml(String(days))}</b></div>
      <div class="pill">Type <b>${escapeHtml(tier)}</b></div>
      <div class="pill">Pax <b>${escapeHtml(String(pax))}</b></div>
    `;
  }

  /* âœ… Alteration: when selected, show only selected in center and move rest to left sidebar */
  function renderPanels(){
    const startUpper = normalizeStartInput();
    const listEl = $("pkgList");

    if(!startUpper){
      $("pkgCount").textContent = "â€”";
      $("districtBar").innerHTML = "";
      listEl.innerHTML = `<div class="pill"><b>Choose Start</b> then click <b>Show Packages</b></div>`;
      setCentreHeroVisible(true);
      renderOtherPackages([], "");
      return;
    }

    const daysFilter = $("daysSel").value || "";
    let list = ACTIVE_TEMPLATES.filter(t=>matchesStart(t, startUpper) && matchesDaysOptional(t, daysFilter));

    list.sort((a,b)=>{
      const aLocal = isLocalComputed(a) ? 1 : 0;
      const bLocal = isLocalComputed(b) ? 1 : 0;
      if(TOUR_MODE === "outside"){
        if(aLocal !== bLocal) return aLocal - bLocal;
      }else{
        if(aLocal !== bLocal) return bLocal - aLocal;
      }
      return String(a.route_id||"").localeCompare(String(b.route_id||""));
    });

    INTER_ALL = list.slice();
    DISTRICT_KEYS = Array.from(new Set(list.map(endDistrictFromTemplate))).filter(Boolean).sort();
    renderDistrictChips();

    const filtered = (ACTIVE_DISTRICT === "ALL")
      ? list
      : list.filter(t=>endDistrictFromTemplate(t) === ACTIVE_DISTRICT);

    $("pkgCount").textContent = `${filtered.length}`;

    const selectedTpl = CURRENT_TEMPLATE_KEY
      ? filtered.find(t=>t.key === CURRENT_TEMPLATE_KEY)
      : null;

    setCentreHeroVisible(!selectedTpl);

    listEl.innerHTML = "";
    if(LOADING){ renderSkeleton(listEl); return; }

    const grid = document.createElement("div");
    grid.className = "pkgGrid";

    if(selectedTpl){
      const card = renderPackageCard(selectedTpl, startUpper);
      card.classList.add("selectedRow");
      grid.appendChild(card);

      const others = filtered.filter(t=>t.key !== CURRENT_TEMPLATE_KEY);
      renderOtherPackages(others, startUpper);
    }else{
      filtered.forEach(tpl=>{
        grid.appendChild(renderPackageCard(tpl, startUpper));
      });
      renderOtherPackages(filtered, startUpper);
    }

    listEl.appendChild(grid);
    highlightActiveCard();
  }

  async function toggleOpenTemplate(key, pushHistory = true){
    const startUpper = normalizeStartInput();
    if(!startUpper) return;

    if(CURRENT_TEMPLATE_KEY === key){
      trackEvent('package_close', { package_key: String(key||'') });
      CURRENT_TEMPLATE_KEY = "";
      clearMap();
      setCentreHeroVisible(true);
      renderPanels();
      if(pushHistory) historyPush("close");
      return;
    }

    CURRENT_TEMPLATE_KEY = key;

    const tpl = ACTIVE_TEMPLATES.find(t=>t.key===key);
    trackEvent('package_open', { package_key: String(key||''), route_id: String(tpl?.route_id||''), days: Number(tpl?.days||0) });
    if(!tpl) return;

    setCentreHeroVisible(false);
    renderPanels();
    highlightActiveCard();

    const card = document.querySelector(`.pkgW[data-key="${CSS.escape(key)}"]`);
    if(card) card.classList.add("selectedRow"); /* keep row style */
    const detailsEl = card ? card.querySelector(".pkgDetails") : null;

    const endKey = endKeyFromRoutePath(tpl);

    CURRENT_DAY_INDEX = makeDayIndexFromTemplate(tpl);
    const placeIds = routeIdsFromTemplateIncludingStart(tpl);

    const rr = await drawRoadRouteFromPlaces(placeIds, CURRENT_DAY_INDEX);
    CURRENT_ROUTE_KM = rr?.km || 0;
    CURRENT_ROUTE_HRS = rr?.hrs || 0;

    if(detailsEl){
      renderInlineDetails(detailsEl, tpl, startUpper, endKey, CURRENT_ROUTE_KM);
    }

    if(pushHistory) historyPush("open");
  }

  /* ===== History / popstate (DO NOT REMOVE) ===== */
  let HISTORY_BOOTED = false;
  let IGNORE_POP = false;

  function snapshotState(){
    return {
      start: String($("startInp")?.value || ""),
      visitType: String($("visitType")?.value || "budget"),
      days: String($("daysSel")?.value || ""),
      pax: String($("paxSel")?.value || "2"),
      activeDistrict: String(ACTIVE_DISTRICT || "ALL"),
      selectedKey: String(CURRENT_TEMPLATE_KEY || ""),
      tourMode: TOUR_MODE
    };
  }
  function applySnapshot(s){
    if(!s) return;
    $("startInp").value = s.start ?? "";
    $("visitType").value = s.visitType ?? "budget";
    $("daysSel").value = s.days ?? "";
    $("paxSel").value = s.pax ?? "2";
    ACTIVE_DISTRICT = s.activeDistrict ?? "ALL";
    TOUR_MODE = s.tourMode ?? TOUR_MODE;
    const mt = $("modeTag");
    if(mt) mt.textContent = `Mode: ${TOUR_MODE === "outside" ? "Outside Himachal" : "Within Himachal"}`;
  }
  function historyReplace(tag){ history.replaceState({ tag, ...snapshotState() }, "", location.href); }
  function historyPush(tag){ history.pushState({ tag, ...snapshotState() }, "", location.href); }

  function bootHistory(){
    if(HISTORY_BOOTED) return;
    HISTORY_BOOTED = true;

    historyReplace("boot");

    window.addEventListener("popstate", async (ev)=>{
      if(IGNORE_POP) return;
      const st = ev.state;

      if(!st){
        if(CURRENT_TEMPLATE_KEY){
          IGNORE_POP = true;
          try{ await toggleOpenTemplate(CURRENT_TEMPLATE_KEY, false); } finally{ IGNORE_POP = false; }
        }
        return;
      }

      applySnapshot(st);
      clearMap();
      CURRENT_ROUTE_KM = 0;
      CURRENT_ROUTE_HRS = 0;

      const startNorm = normalizeStartInput() || "";
      if(!startNorm){
        CURRENT_TEMPLATE_KEY = "";
        setCentreHeroVisible(true);
        $("districtBar").innerHTML = "";
        $("pkgCount").textContent = "â€”";
        renderPanels();
        return;
      }

      applyFilters(false);

      if(st.selectedKey){
        IGNORE_POP = true;
        try{ await toggleOpenTemplate(st.selectedKey, false); } finally{ IGNORE_POP = false; }
      }else{
        CURRENT_TEMPLATE_KEY = "";
        setCentreHeroVisible(true);
        renderPanels();
      }
    });
  }

  /* ===== Filtering (Show Packages) ===== */
  function applyFilters(push = true){
    const startUpper = normalizeStartInput();
    trackEvent('apply_filters', { start: String(startUpper||''), days: String($('daysSel')?.value||''), tier: String($('visitType')?.value||''), pax: Number(getSelectedPax()||0), mode: String(TOUR_MODE||'') });
    renderPills(startUpper);
    renderPanels();
    if(push) historyPush("filters");
  }

  /* ===== Firebase load ===== */
  async function dbGet(path){
    const snap = await db.ref(path).get();
    return snap.exists() ? snap.val() : null;
  }

  async function loadAll(){
    setStatus("Connecting to Firebaseâ€¦");
    firebase.initializeApp(firebaseConfig);
    try{ analytics = firebase.analytics(); }catch(e){}

    db = firebase.database();

    LOADING = true;
    try{ const listEl = $("pkgList"); if(listEl) renderSkeleton(listEl); }catch(e){}
    setStatus("Loading placesâ€¦");
    const places = await dbGet(NODE_PLACES) || {};
    PLACES = places;

    buildNameIndex();

    setStatus("Loading templatesâ€¦");
    const templates = await dbGet(NODE_TEMPLATES) || {};
    TEMPLATES = templates;

    setStatus("Loading pricingâ€¦");
    const costs = await dbGet(NODE_COSTS) || {};
    COSTS = costs;

    const arr = Object.entries(TEMPLATES).map(([k,v])=>({ key:k, ...(v||{}) }));
    ACTIVE_TEMPLATES = arr;

    initModeFromLanding();
    buildStartList(arr);

    try{
      const qs = new URLSearchParams(location.search);
      const startQS = (qs.get("start") || "").trim();
      if(startQS){
        const v = String(startQS).toUpperCase();
        $("startInp").value = v;
      }
    }catch(e){}

    LOADING = false;
    setStatus("Ready");
    showBot("ðŸ‘‹ Welcome! Select Start â†’ Show Packages.");

    if(String($("startInp").value||"").trim()) applyFilters(false);
    else renderPanels();
  }

  /* ===== UI Wiring ===== */
  function wireUI(){
    $("yy").textContent = new Date().getFullYear();

    $("genBtn").onclick = ()=> applyFilters(true);
    $("resetBtn").onclick = ()=>{
      $("startInp").value = "";
      $("daysSel").value = "";
      $("visitType").value = "budget";
      $("paxSel").value = "2";
      ACTIVE_DISTRICT = "ALL";
      CURRENT_TEMPLATE_KEY = "";
      clearMap();
      renderPanels();
      historyPush("reset");
      showBot("âœ… Filters reset");
    };

    $("startInp").addEventListener("change", ()=>{ renderPills(normalizeStartInput()); });
    $("visitType").addEventListener("change", ()=>{ renderPanels(); historyPush("tier"); });
    $("daysSel").addEventListener("change", ()=>{ renderPanels(); historyPush("days"); });
    $("paxSel").addEventListener("change", ()=>{ renderPanels(); historyPush("pax"); });

    $("refreshBtn").onclick = async ()=>{ showBot("ðŸ”„ Refreshing dataâ€¦"); await loadAll(); };
    $("fitMapBtn").onclick = ()=>{ if(routeLine) map.fitBounds(routeLine.getBounds(), { padding:[22,22] }); };
    $("clearRouteBtn").onclick = ()=>{ CURRENT_TEMPLATE_KEY=""; clearMap(); setCentreHeroVisible(true); renderPanels(); historyPush("clear"); };

    $("showAllStopsBtn").onclick = async ()=>{
      showMode="all";
      if(CURRENT_TEMPLATE_KEY){
        const tpl = ACTIVE_TEMPLATES.find(t=>t.key===CURRENT_TEMPLATE_KEY);
        if(tpl) await drawRoadRouteFromPlaces(routeIdsFromTemplateIncludingStart(tpl), makeDayIndexFromTemplate(tpl));
      }
      showBot("âœ… Showing all stops");
    };
    $("showStartEndBtn").onclick = async ()=>{
      showMode="startend";
      if(CURRENT_TEMPLATE_KEY){
        const tpl = ACTIVE_TEMPLATES.find(t=>t.key===CURRENT_TEMPLATE_KEY);
        if(tpl) await drawRoadRouteFromPlaces(routeIdsFromTemplateIncludingStart(tpl), makeDayIndexFromTemplate(tpl));
      }
      showBot("âœ… Showing start/end only");
    };
    $("toggleTilesBtn").onclick = ()=>{
      tilesDark = !tilesDark;
      if(tilesDark){
        map.removeLayer(tile);
        tileDark.addTo(map);
      }else{
        map.removeLayer(tileDark);
        tile.addTo(map);
      }
      showBot(`ðŸ—ºï¸ Tiles: ${tilesDark ? "Dark" : "Light"}`);
    };

    $("closeSelectedBtn").onclick = ()=>{ if(CURRENT_TEMPLATE_KEY) toggleOpenTemplate(CURRENT_TEMPLATE_KEY); };

    $("pmClose").onclick = closePlaceModal;
    $("placeModal").addEventListener("click", (e)=>{ if(e.target === $("placeModal")) closePlaceModal(); });

    $("topLink").onclick = (e)=>{ e.preventDefault(); window.scrollTo({top:0, behavior:"smooth"}); };
    $("districtSelect").onchange = (e)=>{ const v = e.target.value; if(v) location.href = v; };

    $("waClose").onclick = (e)=>{
      e.preventDefault(); e.stopPropagation();
      $("waFloat").style.display = "none";
      showBot("âœ… WhatsApp button hidden");
    };

    $("mintLoginBtn").onclick = ()=> showBot("ðŸ”’ Mint Login (hook your auth here)");
  }

  /* ===== Boot ===== */
  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      wireUI();
      initMap();
      startCentreHero();
      bootHistory();
      initModeFromLanding();
      await loadAll();
    }catch(err){
      console.error(err);
      setStatus("Error loading");
      showBot("âŒ Error loading data. Check console + Firebase rules.");
    }
  });
  </script>
</body>
</html>