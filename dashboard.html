<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="color-scheme" content="light"/>
  <title>Himachal Tour Packages | Himachal Explorer Portal</title>
  <meta name="description" content="Explore Himachal tour packages with live road route maps, day-wise itineraries, places, and instant price estimates." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <link rel="canonical" href="https://himachalexplorer.in/" />
  <meta name="theme-color" content="#EAF3FF" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
:root{
  --bg0:#F6FAFF;
  --bg1:#EAF3FF;
  --card: rgba(255,255,255,.62);
  --stroke: rgba(10,30,60,.16);
  --muted: rgba(10,30,60,.62);
  --text: rgba(10,30,60,.92);
  --shadow: 0 18px 70px rgba(10,30,60,.14);
  --radius: 16px;
  --acc:#2563EB;
  --gap: 12px;
  --shellW: min(94vw, 1700px);
  --heroH: clamp(220px, 26vw, 320px);
}
*{ box-sizing:border-box; }
html, body{ height:100%; }
body{
  margin:0; color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:
    radial-gradient(1100px 520px at 20% 0%, rgba(37,99,235,.12), transparent 60%),
    radial-gradient(900px 520px at 85% 10%, rgba(14,165,233,.10), transparent 62%),
    radial-gradient(900px 520px at 50% 92%, rgba(59,130,246,.08), transparent 64%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  overflow-x:hidden;
  -webkit-text-size-adjust: 100%;
  text-rendering: optimizeLegibility;
}
.aurora{
  position:fixed; inset:-30%;
  background:
    radial-gradient(900px 500px at 25% 30%, rgba(37,99,235,.12), transparent 66%),
    radial-gradient(900px 520px at 75% 25%, rgba(14,165,233,.10), transparent 68%),
    radial-gradient(860px 540px at 55% 75%, rgba(59,130,246,.08), transparent 70%);
  filter: blur(50px); opacity:.85; animation: drift 14s ease-in-out infinite;
  pointer-events:none; z-index:-3;
  transform: translateZ(0);
}
@keyframes drift{
  0%,100%{transform:translate3d(0,0,0) scale(1);}
  50%{transform:translate3d(3%,-2%,0) scale(1.06);}
}
.noise{
  position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.06; mix-blend-mode:multiply;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
}
.shell{ width: var(--shellW); margin: 0 auto; padding: 12px 10px 18px; }

/* HERO */
.hero{
  border-radius: 22px; border:1px solid var(--stroke);
  overflow:hidden; position:relative; box-shadow: var(--shadow);
  background: rgba(255,255,255,.62);
}
.heroMedia{ height: var(--heroH); position:relative; overflow:hidden; background: rgba(255,255,255,.62); }
.heroMedia img{ width:100%; height:100%; object-fit:cover; display:block; transform: translateZ(0); }
.heroMedia::after{
  content:""; position:absolute; inset:0;
  background: linear-gradient(90deg, rgba(255,255,255,.28), rgba(255,255,255,.10), rgba(255,255,255,.24));
  pointer-events:none;
}
.heroBar{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding: 12px 14px;
  background: rgba(255,255,255,.66);
  border-top:1px solid rgba(10,30,60,.14);
  backdrop-filter: blur(14px);
}
.heroBrand{ display:flex; align-items:center; gap:12px; min-width:0; }
.logo{
  width:56px; height:56px; border-radius:16px;
  background: rgba(255,255,255,.78);
  border:1px solid rgba(10,30,60,.16);
  display:grid; place-items:center; overflow:hidden;
  box-shadow: 0 14px 34px rgba(10,30,60,.12);
  flex:0 0 auto;
}
.logo img{ width:100%; height:100%; object-fit:cover; display:block; }
.brandText{ min-width:0; }
.heroTitle{
  margin:0;
  font-size: clamp(16px, 2.1vw, 22px);
  letter-spacing:.14em; text-transform: uppercase;
  font-weight: 1000; color: rgba(10,30,60,.96);
  line-height: 1.1;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.heroSub{
  margin:7px 0 0;
  font-size: 12px; color: rgba(10,30,60,.70);
  letter-spacing:.08em; text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.heroRight{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; flex:0 0 auto; }
.chip{
  border:1px solid rgba(10,30,60,.18);
  background: rgba(255,255,255,.62);
  color: rgba(10,30,60,.82);
  border-radius: 999px;
  padding: 8px 10px;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing:.10em;
  display:inline-flex; align-items:center; gap:10px;
  cursor:pointer; user-select:none;
  box-shadow: 0 10px 24px rgba(10,30,60,.10);
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
}
.chip.primary{
  border-color: rgba(37,99,235,.40);
  background: rgba(37,99,235,.16);
  color: rgba(10,30,60,.92);
  font-weight: 950;
}

/* MAIN LAYOUT */
.main{
  display:grid;
  grid-template-columns: 22% 53% 25%;
  gap: var(--gap);
  margin-top: 12px;
  align-items: stretch;
  min-width:0;
}
.pane{
  border: 1px solid var(--stroke);
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.56));
  box-shadow: var(--shadow);
  backdrop-filter: blur(14px);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  min-width: 0;
  min-height: 0;
  height: calc(100vh - 24px);
  min-height: 640px;
  max-height: 920px;
}
.paneHdr{
  padding: 10px 12px;
  border-bottom:1px solid rgba(10,30,60,.14);
  display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
  background: rgba(255,255,255,.62);
}
.paneHdr .t{ margin:0; font-size:11px; letter-spacing:.18em; text-transform: uppercase; font-weight: 950; }
.paneHdr .s{ font-size:10.5px; color:var(--muted); letter-spacing:.10em; text-transform: uppercase; }

/* LEFT */
.sideInner{
  padding: 12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:0;
  overflow:auto;
  -webkit-overflow-scrolling: touch;
}
.sideCard{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.62);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 12px 36px rgba(10,30,60,.10);
}
.field label{
  display:block; font-size: 10.5px; color: var(--muted);
  text-transform: uppercase; letter-spacing:.12em; margin:0 0 6px 2px;
}
input, select{
  width:100%; padding: 10px 10px; border-radius: 12px;
  border: 1px solid rgba(10,30,60,.18);
  background: rgba(255,255,255,.82);
  color: rgba(10,30,60,.92);
  outline:none; font-size: 13px;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}
input:focus, select:focus{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.16); }
.btnRow{ display:flex; gap:8px; margin-top:8px; }
.btn{
  flex:1; padding: 10px 10px; border-radius: 12px;
  border: 1px solid rgba(37,99,235,.30);
  background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(14,165,233,.72));
  color:#fff; font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
  cursor:pointer; font-size: 11px;
  box-shadow: 0 14px 34px rgba(37,99,235,.18);
  -webkit-tap-highlight-color: transparent;
}
.btn.secondary{
  border: 1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  color: rgba(10,30,60,.86);
  box-shadow: 0 10px 24px rgba(10,30,60,.10);
}
.pills{ display:flex; flex-wrap:wrap; gap:7px; margin-top:10px; }
.pill{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.62);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10.5px;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.78);
  display:inline-flex; align-items:center; gap:8px;
}
.pill b{ color: rgba(10,30,60,.92); letter-spacing:.06em; }

/* LEFT: ALL PACKAGES */
.otherWrap{ flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
.otherHdr{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.62);
  border-radius: 14px;
  padding: 10px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  box-shadow: 0 10px 24px rgba(10,30,60,.10);
}
.otherHdr .h{ font-size: 11px; font-weight: 950; letter-spacing:.14em; text-transform: uppercase; }
.otherHdr .xBtn{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  color: rgba(10,30,60,.86);
  border-radius: 12px;
  padding: 7px 10px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  cursor:pointer;
  user-select:none;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
}
.otherList{
  flex:1; min-height:0; overflow:auto;
  -webkit-overflow-scrolling: touch;
  padding: 2px;
  display:flex; flex-direction:column; gap:8px;
}
.otherHint{
  border:1px dashed rgba(10,30,60,.20);
  background: rgba(255,255,255,.58);
  border-radius: 14px;
  padding: 10px;
  color: rgba(10,30,60,.72);
  font-size: 11px;
  letter-spacing:.02em;
  line-height: 1.35;
}
.pkgSide{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.70);
  border-radius: 14px;
  padding: 10px;
  box-shadow: 0 10px 20px rgba(10,30,60,.08);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  gap:8px;
  -webkit-tap-highlight-color: transparent;
}
.pkgSide.active{
  border-color: rgba(37,99,235,.40);
  box-shadow: 0 0 0 3px rgba(37,99,235,.14);
  background: rgba(37,99,235,.10);
}
.pkgSideTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
.pkgSideTop .t1{
  font-size: 10.5px;
  font-weight: 1000;
  letter-spacing:.12em;
  text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.pkgSideTop .badge{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.76);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
  white-space: nowrap;
  flex:0 0 auto;
}
.pkgSideTop .badge.blue{ border-color: rgba(37,99,235,.32); background: rgba(37,99,235,.12); }
.pkgSideRow{
  display:flex; gap:8px; flex-wrap:wrap;
  font-size: 10px;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.72);
}
.pkgSideRow span{
  border:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.66);
  border-radius: 999px;
  padding: 6px 8px;
  white-space: nowrap;
}
.pkgSidePrice{
  font-size: 11px;
  font-weight: 1000;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.92);
}

/* CENTER */
.centerInner{ display:flex; flex-direction:column; min-height:0; flex:1; }
.districtBar{
  display:flex; flex-wrap:nowrap; gap:8px;
  padding:10px 12px;
  border-bottom:1px solid rgba(10,30,60,.14);
  overflow-x:auto; -webkit-overflow-scrolling: touch;
  background: rgba(255,255,255,.62);
}
.pkgList{
  flex:1;
  min-height:0;
  overflow:auto;
  padding: 10px 12px;
  background: rgba(255,255,255,.52);
  -webkit-overflow-scrolling: touch;
}

/* âœ… BAR TYPE LIST (MAX INFO) */
.barList{ display:flex; flex-direction:column; gap:10px; }
.pkgBar{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.72);
  border-radius: 18px;
  overflow:hidden;
  box-shadow: 0 14px 36px rgba(10,30,60,.10);
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
}
.pkgBar:hover{
  transform: translateY(-2px);
  box-shadow: 0 26px 80px rgba(10,30,60,.14);
  border-color: rgba(37,99,235,.26);
}
.pkgBarTop{
  display:grid;
  grid-template-columns: 160px 1fr;
  gap:12px;
  padding: 10px;
  align-items: stretch;
}
@media (max-width: 980px){
  .pkgBarTop{ grid-template-columns: 140px 1fr; }
}
@media (max-width: 520px){
  .pkgBarTop{ grid-template-columns: 120px 1fr; }
}
.barThumb{
  border-radius: 16px;
  overflow:hidden;
  border:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.82);
  position:relative;
  min-height: 110px;
}
.barThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
.badgeRow{
  position:absolute; left:10px; top:10px; right:10px;
  display:flex; justify-content:space-between; align-items:center; gap:8px;
  pointer-events:none;
}
.bChip{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.84);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
  backdrop-filter: blur(12px);
  white-space: nowrap;
}
.bChip.blue{ border-color: rgba(37,99,235,.34); background: rgba(37,99,235,.16); }

.barInfo{
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding-right: 6px;
}
.barTitleRow{
  display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
}
.barTitle{
  margin:0;
  font-size: 12px;
  font-weight: 1000;
  letter-spacing:.12em;
  text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.openTag{
  border:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.80);
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 10px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
  white-space: nowrap;
  flex:0 0 auto;
}
.metaRow{
  display:flex; flex-wrap:wrap; gap:8px;
}
.mChip{
  border:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.72);
  border-radius: 999px;
  padding: 6px 9px;
  font-size: 10px;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.74);
  white-space: nowrap;
}
.mChip b{ color: rgba(10,30,60,.92); letter-spacing:.06em; }

.barMini{
  font-size: 11px;
  color: rgba(10,30,60,.74);
  line-height: 1.28;
}
.barMini b{ color: rgba(10,30,60,.92); }

.pkgSolo{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.74);
  border-radius: 18px;
  overflow:hidden;
  box-shadow: 0 14px 36px rgba(10,30,60,.10);
}
.soloHead{
  padding: 10px 12px;
  border-bottom:1px solid rgba(10,30,60,.12);
  display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
  background: rgba(255,255,255,.70);
}
.soloHead .ttl{
  min-width:0;
}
.soloHead h2{
  margin:0;
  font-size: 13px;
  font-weight: 1000;
  letter-spacing:.12em;
  text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.soloHead .sub{
  margin-top:6px;
  font-size: 11px;
  color: rgba(10,30,60,.72);
  letter-spacing:.06em;
  line-height: 1.25;
}
.soloActions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
.sBtn{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.82);
  border-radius: 999px;
  padding: 9px 12px;
  font-size: 10.5px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
  cursor:pointer;
  box-shadow: 0 10px 22px rgba(10,30,60,.08);
  -webkit-tap-highlight-color: transparent;
}
.sBtn.primary{
  border-color: rgba(37,99,235,.34);
  background: rgba(37,99,235,.16);
}
.soloBody{
  padding: 12px;
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 12px;
}
@media (max-width: 980px){ .soloBody{ grid-template-columns: 1fr; } }
.soloGallery{
  border:1px solid rgba(10,30,60,.14);
  border-radius: 16px;
  overflow:hidden;
  background: rgba(255,255,255,.72);
}
.soloGalleryGrid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  grid-template-rows: 1fr 1fr;
  gap: 8px;
  padding: 10px;
}
.soloCell{
  border:1px solid rgba(10,30,60,.14);
  background: rgba(255,255,255,.82);
  border-radius: 14px;
  overflow:hidden;
  min-height: 150px;
}
.soloCell img{ width:100%; height:100%; object-fit:cover; display:block; }
.soloBig{ grid-row: 1 / -1; min-height: 308px; }
@media (max-width: 520px){
  .soloGalleryGrid{ grid-template-columns: 1fr; grid-template-rows: auto; }
  .soloBig{ grid-row:auto; min-height: 200px; }
  .soloCell{ min-height: 150px; }
}

.soloPanel{
  border:1px solid rgba(10,30,60,.14);
  border-radius: 16px;
  background: rgba(255,255,255,.72);
  padding: 12px;
  min-width:0;
}
.pTitle{
  margin:0 0 10px;
  font-size: 11px;
  font-weight: 1000;
  letter-spacing:.14em;
  text-transform: uppercase;
}
.timeline{ display:flex; flex-direction:column; gap:8px; }
.dayRow{
  display:flex; gap:10px;
  border:1px solid rgba(10,30,60,.12);
  background: rgba(255,255,255,.82);
  border-radius: 14px;
  padding: 8px 10px;
}
.dayDot{
  width: 26px; height:26px; border-radius:999px;
  border:1px solid rgba(37,99,235,.30);
  background: rgba(37,99,235,.14);
  display:grid; place-items:center;
  font-size: 10px; font-weight: 1000;
  flex:0 0 auto;
}
.dayText{ min-width:0; }
.dayText .t{ font-size: 11px; font-weight: 950; letter-spacing:.06em; }
.dayText .s{ margin-top:3px; font-size: 10.5px; color: rgba(10,30,60,.72); line-height:1.25; }
.costLine{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border:1px solid rgba(10,30,60,.12);
  background: rgba(255,255,255,.82);
  border-radius: 14px;
  padding: 8px 10px;
  font-size: 11px;
}
.mutedMini{ color: rgba(10,30,60,.70); font-size: 10.5px; line-height:1.25; margin-top:8px; }
.soloBottom{
  padding: 12px;
  border-top:1px solid rgba(10,30,60,.12);
  background: rgba(255,255,255,.70);
}
.bigWA{
  width:100%;
  border:1px solid rgba(37,99,235,.30);
  background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(14,165,233,.72));
  color:#fff;
  border-radius: 16px;
  padding: 14px 14px;
  font-size: 12px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 1000;
  cursor:pointer;
  box-shadow: 0 16px 40px rgba(37,99,235,.18);
  -webkit-tap-highlight-color: transparent;
}

/* MAP RIGHT */
.mapPane{
  position: sticky;
  top: 12px;
  height: calc(100vh - 24px);
  min-height: 640px;
  max-height: 920px;
  display:flex;
  flex-direction:column;
  min-height:0;
}
#map{
  width:100%;
  flex:1;
  min-height: 520px;
  background: rgba(255,255,255,.62);
  border-radius: 14px;
}
.mapTools{
  padding: 10px 12px;
  border-top:1px solid rgba(10,30,60,.14);
  display:flex; gap:8px; flex-wrap:wrap;
  background: rgba(255,255,255,.62);
}
.toolBtn{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  color: rgba(10,30,60,.86);
  border-radius: 12px;
  padding: 9px 10px;
  font-size: 10.5px;
  letter-spacing:.12em;
  text-transform: uppercase;
  cursor:pointer;
  display:inline-flex; align-items:center; gap:10px;
  user-select:none; white-space: nowrap; text-decoration:none;
  box-shadow: 0 10px 20px rgba(10,30,60,.08);
  -webkit-tap-highlight-color: transparent;
}

/* WHATSAPP FLOAT */
.waFloat{
  position:fixed; right: 14px; bottom: 14px; z-index: 10000;
  display:flex; align-items:center; gap:10px; padding: 12px 14px;
  border-radius: 999px; border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.74);
  backdrop-filter: blur(14px);
  box-shadow: 0 26px 70px rgba(10,30,60,.16);
  color: rgba(10,30,60,.92); text-decoration:none; user-select:none; -webkit-tap-highlight-color: transparent;
}
.waIcon{ width:40px; height:40px; border-radius: 999px; display:grid; place-items:center; background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.30); flex:0 0 auto; }
.waText{ display:flex; flex-direction:column; line-height:1.1; min-width:0; }
.waText .t1{ font-size: 12px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase; white-space:nowrap; }
.waText .t2{ margin-top:4px; font-size: 11px; color: rgba(10,30,60,.70); letter-spacing:.04em; white-space:nowrap; }
.waClose{
  width:34px; height:34px; border-radius: 999px;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.78);
  color: rgba(10,30,60,.86);
  display:grid; place-items:center;
  cursor:pointer; flex:0 0 auto; user-select:none;
}

/* BOT TOAST */
.botToast{
  position:fixed; left: 14px; bottom: 14px; z-index: 9999;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.74);
  border-radius: 14px;
  padding: 10px 12px;
  color: rgba(10,30,60,.86);
  font-size: 11px;
  letter-spacing:.08em;
  box-shadow: 0 26px 70px rgba(10,30,60,.16);
  display:none;
  max-width: min(520px, calc(100vw - 28px));
}
.botToast.show{ display:block; }

/* PLACE MODAL (kept) */
.placeModal{
  position:fixed; inset:0; z-index: 20000;
  background: rgba(10,30,60,.35);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 14px;
}
.placeModal.show{ display:flex; }
.placeCard{
  width:min(980px, 100%);
  border-radius: 18px;
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.92);
  box-shadow: 0 30px 90px rgba(10,30,60,.26);
  overflow:hidden;
}
.placeCardTop{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 12px;
  border-bottom:1px solid rgba(10,30,60,.12);
  background: rgba(255,255,255,.80);
}
.placeCardTop .ttl{
  font-size: 12px; font-weight: 1000; letter-spacing:.14em; text-transform: uppercase;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  max-width: calc(100% - 100px);
}
.placeClose{
  border:1px solid rgba(10,30,60,.16);
  background:#fff;
  border-radius: 12px;
  padding: 7px 10px;
  cursor:pointer;
  font-size: 11px;
  letter-spacing:.12em;
  text-transform: uppercase;
  font-weight: 950;
}
.placeBody{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 12px;
  padding: 12px;
}
@media (max-width: 900px){ .placeBody{ grid-template-columns: 1fr; } }
.placeGallery{
  border:1px solid rgba(10,30,60,.14);
  border-radius: 16px;
  overflow:hidden;
  background: rgba(255,255,255,.72);
}
.placeGallery img{ width:100%; height: 340px; object-fit:cover; display:block; }
.placeText{
  border:1px solid rgba(10,30,60,.14);
  border-radius: 16px;
  background: rgba(255,255,255,.72);
  padding: 12px;
  min-width:0;
}

/* FOOTER (your existing) */
footer{
  margin-top: 12px;
  border:1px solid rgba(10,30,60,.16);
  border-radius: 18px;
  background: rgba(255,255,255,.62);
  box-shadow: var(--shadow);
  backdrop-filter: blur(14px);
  overflow:hidden;
}
.footInner{ padding: 14px 16px; display:flex; flex-direction:column; gap:12px; }
.footTopRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
.footLeft{
  font-size: 11px;
  letter-spacing:.10em;
  text-transform: uppercase;
  color: rgba(10,30,60,.70);
}
.footLinks{ display:flex; gap:10px; flex-wrap:wrap; }
.footLinks a{
  font-size: 11px;
  letter-spacing:.10em;
  text-transform: uppercase;
  text-decoration:none;
  color: rgba(10,30,60,.86);
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  padding: 8px 10px;
  border-radius: 999px;
  box-shadow: 0 10px 22px rgba(10,30,60,.08);
  -webkit-tap-highlight-color: transparent;
}
.footerFancyGrid{
  display:grid;
  grid-template-columns: 1fr 24%;
  gap: 14px;
  border-top: 1px solid rgba(10,30,60,.12);
  padding-top: 12px;
  align-items: stretch;
}
.footerAboutGrid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  min-width:0;
}
.footerBox{
  border:1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 14px 36px rgba(10,30,60,.10);
  min-width:0;
}
.footerTitle{
  font-size: 11px;
  font-weight: 1000;
  letter-spacing:.14em;
  text-transform: uppercase;
  margin: 0 0 10px;
}
.footerDistrictBox{
  border:1px solid rgba(10,30,60,.16);
  background: linear-gradient(180deg, rgba(255,255,255,.68), rgba(255,255,255,.56));
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 14px 36px rgba(10,30,60,.10);
  min-width:0;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  gap:10px;
}
.footerDistrictBox select{
  width: 100%;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(10,30,60,.16);
  background: rgba(255,255,255,.66);
  color: rgba(10,30,60,.90);
  font-size: 11px;
  letter-spacing:.08em;
  text-transform: uppercase;
  font-weight: 900;
  cursor: pointer;
}

/* RESPONSIVE */
@media (max-width: 1200px){
  .main{ grid-template-columns: 1fr; }
  .mapPane{ position:relative; top:auto; height:520px; max-height:none; min-height:520px; }
  #map{ min-height: 420px; }
  .pane{ height:auto; max-height:none; min-height:unset; }
  .heroBar{ flex-direction: column; align-items: stretch; }
  .heroRight{ justify-content:flex-start; }
  .footerFancyGrid{ grid-template-columns: 1fr; }
  .footerAboutGrid{ grid-template-columns: 1fr; }
}
@media (max-width: 520px){
  .shell{ padding: 10px 8px 16px; }
  .heroBar{ padding: 10px 10px; }
  .logo{ width:52px; height:52px; border-radius: 16px; }
  .chip{ padding: 8px 9px; font-size: 10.5px; }
  .waText{ display:none; }
  .waFloat{ padding: 10px; }
  .waClose{ display:none; }
  .footTopRow{ flex-direction:column; align-items:flex-start; }
}
@media (prefers-reduced-motion: reduce){
  .aurora{ animation:none; }
}
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="noise"></div>

  <!-- WhatsApp Floating CTA -->
  <a
    class="waFloat"
    id="waFloat"
    href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
    target="_blank" rel="noopener"
    aria-label="Chat on WhatsApp with Chandan Panwar"
  >
    <div class="waIcon" aria-hidden="true">
      <svg width="22" height="22" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M16 3C9.1 3 3.5 8.3 3.5 14.9c0 2.5.8 4.8 2.2 6.7L4 29l7.6-1.9c1.8 1 3.9 1.6 6.4 1.6 6.9 0 12.5-5.3 12.5-11.9S22.9 3 16 3z" fill="rgba(10,30,60,.10)"/>
        <path d="M16.1 6.1c-5.1 0-9.2 3.9-9.2 8.8 0 1.9.6 3.6 1.7 5.1l-1.1 4 4.2-1.1c1.4.8 3.1 1.3 4.9 1.3 5.1 0 9.2-3.9 9.2-8.8s-4.1-8.8-9.2-8.8z" fill="rgba(10,30,60,.12)"/>
        <path d="M23 19.1c-.3.8-1.6 1.5-2.2 1.6-.6.1-1.3.2-2.2-.1-.5-.2-1.2-.4-2-.8-3.5-1.9-5.7-5-5.9-5.3-.2-.3-1.4-1.8-1.4-3.5 0-1.7.9-2.5 1.2-2.9.3-.3.7-.4.9-.4h.7c.2 0 .5-.1.7.5.2.6.9 2.1 1 2.3.1.2.1.5 0 .7-.1.2-.2.4-.4.6-.2.2-.3.3-.5.5-.2.2-.4.4-.2.8.2.4.8 1.3 1.7 2.1 1.2 1.1 2.2 1.4 2.6 1.6.3.2.6.1.8-.1.2-.2 1-1.1 1.2-1.5.2-.4.5-.3.8-.2.3.1 2 .9 2.3 1 .3.1.5.2.6.4.1.1.1.8-.2 1.6z" fill="#0a1e3c" opacity=".92"/>
      </svg>
    </div>
    <div class="waText">
      <div class="t1">WhatsApp</div>
      <div class="t2">Chat for booking</div>
    </div>
    <div class="waClose" id="waClose" title="Hide" aria-label="Hide WhatsApp button">âœ•</div>
  </a>

  <div class="shell">
    <!-- HERO -->
    <div class="hero">
      <div class="heroMedia">
        <img src="./style/vivek-kumar-7k1IKQZikSc-unsplash.jpg" alt="Himachal Explorer" onerror="this.style.display='none';">
      </div>

      <div class="heroBar">
        <div class="heroBrand">
          <div class="logo">
            <img src="./style/logo.png" alt="Himachal Explorer Logo" onerror="this.remove(); this.parentNode.textContent='HP';">
          </div>
          <div class="brandText">
            <div class="heroTitle">Himachal Explorer Portal</div>
            <div class="heroSub" id="statusLine">Loadingâ€¦</div>
          </div>
        </div>

        <div class="heroRight">
          <div class="chip primary" id="mintLoginBtn">Mint Login</div>
          <div class="chip" id="refreshBtn">Refresh</div>
          <div class="chip" id="fitMapBtn">Fit Route</div>
          <div class="chip" id="clearRouteBtn">Clear</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- LEFT -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Trip Filters</p>
            <div class="s">Start + days + category</div>
          </div>
          <div class="s" id="leftHint">Auto loaded</div>
        </div>

        <div class="sideInner">
          <div class="sideCard">
            <div class="field">
              <label>Start City / Pickup</label>
              <input id="startInp" list="startList" placeholder="E.g. SHIMLA / CHANDIGARH / DELHI" autocomplete="off">
              <datalist id="startList"></datalist>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Package Category</label>
              <select id="visitType">
                <option value="budget">BUDGET</option>
                <option value="premium">PREMIUM</option>
                <option value="luxury">LUXURY</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Trip Duration (Days)</label>
              <select id="daysSel">
                <option value="">ANY</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                <option>11</option><option>12</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Travellers (Pax)</label>
              <select id="paxSel">
                <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
              </select>
            </div>

            <div class="btnRow">
              <button class="btn secondary" id="resetBtn" type="button">Reset Filters</button>
              <button class="btn" id="genBtn" type="button">Show Packages</button>
            </div>

            <div class="pills" id="pills"></div>
          </div>

          <div class="otherWrap">
            <div class="otherHdr">
              <div class="h">Other Packages</div>
              <div class="xBtn" id="closeSelectedBtn" title="Close selected package">Close</div>
            </div>
            <div class="otherList" id="otherPkgList">
              <div class="otherHint">
                Select any package â€” it will open in center. <br>
                Only 1 package stays in center, rest come here.
              </div>
            </div>
          </div>

          <div class="sideCard">
            <div class="pill" style="text-transform:none;letter-spacing:.02em;">
              Tip: Start can be selected here, or passed from index.
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Packages</p>
            <div class="s" id="centerHint">Bar type â€¢ max info â€¢ open one package</div>
          </div>
          <div class="s" id="pkgCount">â€”</div>
        </div>

        <div class="centerInner">
          <div class="districtBar" id="districtBar"></div>
          <div class="pkgList" id="pkgList">
            <div class="pill"><b>Loadingâ€¦</b></div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="pane mapPane">
        <div class="paneHdr">
          <div>
            <p class="t">Live Route Map</p>
            <div class="s">OSRM road polyline + day-wise pins</div>
          </div>
          <div class="s" id="kmBadge">â€”</div>
        </div>

        <div id="map"></div>

        <div class="mapTools">
          <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
          <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
          <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      <div class="footInner">
        <div class="footTopRow">
          <div class="footLeft">Â© <span id="yy"></span> Himachal Explorer Portal</div>
          <div class="footLinks">
            <a href="#" id="topLink">Top</a>
            <a href="./index.html">Change Mode</a>
            <a href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
               target="_blank" rel="noopener">WhatsApp</a>
          </div>
        </div>

        <div class="footerFancyGrid">
          <div class="footerAboutGrid">
            <div class="footerBox">
              <div class="footerTitle">About Website</div>
              <ul>
                <li>Route map + stop markers (OSRM)</li>
                <li>Day-wise itinerary with place popups</li>
                <li>Pricing from Firebase (dashboard loads directly)</li>
                <li>Instant WhatsApp booking query</li>
                <li>District guide integration</li>
              </ul>
            </div>

            <div class="footerBox">
              <div class="footerTitle">About Us</div>
              <ul>
                <li>Comfort-focused travel planning</li>
                <li>Verified hotel coordination</li>
                <li>Family & elder-friendly route design</li>
                <li>Clear communication & honest pricing</li>
                <li>We are new â€” but quality is non-negotiable</li>
              </ul>
            </div>
          </div>

          <div class="footerDistrictBox">
            <div class="footerTitle">Explore District</div>
            <select id="districtSelect">
              <option value="">Select District</option>
              <option value="./districts/bilaspur.html">Bilaspur</option>
              <option value="./districts/chamba.html">Chamba</option>
              <option value="./districts/hamirpur.html">Hamirpur</option>
              <option value="./districts/kangra.html">Kangra</option>
              <option value="./districts/kinnaur.html">Kinnaur</option>
              <option value="./districts/kullu.html">Kullu</option>
              <option value="./districts/lahaul-spiti.html">Lahaul & Spiti</option>
              <option value="./districts/mandi.html">Mandi</option>
              <option value="./districts/shimla.html">Shimla</option>
              <option value="./districts/sirmaur.html">Sirmaur</option>
              <option value="./districts/solan.html">Solan</option>
              <option value="./districts/una.html">Una</option>
            </select>
          </div>
        </div>
      </div>
    </footer>
  </div><!-- /shell -->

  <div class="botToast" id="botToast">ðŸ‘‹ Welcome! Loadingâ€¦</div>

  <div class="placeModal" id="placeModal" role="dialog" aria-modal="true">
    <div class="placeCard">
      <div class="placeCardTop">
        <div class="ttl" id="pmTitle">PLACE</div>
        <button class="placeClose" id="pmClose" type="button">Close</button>
      </div>
      <div class="placeBody">
        <div class="placeGallery">
          <img id="pmImg" src="" alt="Place photo" onerror="this.style.display='none'">
        </div>
        <div class="placeText">
          <div class="k">Overview</div>
          <div class="v" id="pmDesc">â€”</div>
          <div style="height:10px"></div>
          <div class="k">Details</div>
          <div class="v" id="pmMeta">â€”</div>
          <div class="placeActions" id="pmActions"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FIREBASE LOADER (MODULE) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    async function fetchNode(path){
      const snap = await get(child(ref(db), path));
      return snap.exists() ? snap.val() : {};
    }

    window.hxFetchFirebaseAndCache = async function(){
      const NODE_TEMPLATES  = "templates";
      const NODE_PLACES     = "places";
      const NODE_COSTS      = "package_cost_breakdown";

      const [templates, places, costs] = await Promise.all([
        fetchNode(NODE_TEMPLATES),
        fetchNode(NODE_PLACES),
        fetchNode(NODE_COSTS)
      ]);

      sessionStorage.setItem("HX_TEMPLATES", JSON.stringify(templates || {}));
      sessionStorage.setItem("HX_PLACES", JSON.stringify(places || {}));
      sessionStorage.setItem("HX_COSTS", JSON.stringify(costs || {}));
      return { templates, places, costs };
    };
  </script>

  <script>
  /* =========================
     BAR LIST + SINGLE PACKAGE VIEW âœ…
     ========================= */

  let TOUR_MODE = null; // "outside" | "intercity"
  function initModeFromLanding(){
    const qs = new URLSearchParams(location.search);
    const modeQS = (qs.get("mode") || "").toLowerCase();
    const modeLS = (localStorage.getItem("travel_origin") || "").toLowerCase();
    const origin = modeQS || modeLS || "within";
    TOUR_MODE = (origin === "outside") ? "outside" : "intercity";
    showBot(`âœ… Mode: ${TOUR_MODE === "outside" ? "Outside Himachal" : "Within Himachal"} selected`);
  }

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg){ $("statusLine").textContent = msg; }
  function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function slugifyName(name){
    return String(name||"")
      .trim().toLowerCase()
      .replace(/&/g," and ")
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }

  function showBot(msg){
    const el = $("botToast");
    if(!el) return;
    el.innerHTML = msg || "ðŸ‘‹ Welcome!";
    el.classList.add("show");
    clearTimeout(showBot._t);
    showBot._t = setTimeout(()=> el.classList.remove("show"), 3600);
  }

  /* PLACE MODAL */
  function closePlaceModal(){ $("placeModal")?.classList.remove("show"); }

  /* MAP */
  let map, tile, tileDark, markersLayer;
  let tilesDark = false;
  function invalidateMapSoon(){
    try{
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 60);
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 260);
    }catch(e){}
  }
  function initMap(){
    map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
    tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    tile.addTo(map);
    tileDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 });
    markersLayer = L.layerGroup().addTo(map);
    invalidateMapSoon();
    window.addEventListener("resize", invalidateMapSoon, { passive:true });
  }

  /* DATA */
  let TEMPLATES = {};
  let PLACES = {};
  let COSTS = {};
  let ACTIVE_TEMPLATES = [];
  let STARTS = [];
  let CURRENT_TEMPLATE_KEY = "";    // selected package
  let CURRENT_FILTERED = [];        // current list after filters

  function isLocalComputed(tpl){
    const routeId = String(tpl.route_id || "").toUpperCase().trim();
    const regionStyle = String(tpl.region_style || "").toLowerCase().trim();
    const pkgId = String(tpl.package_id || tpl.key || "").toLowerCase();
    return regionStyle === "local" || routeId.endsWith("-LCL") || pkgId.includes("-local");
  }

  function buildStartList(templates){
    const counts = new Map();
    templates.forEach(t=>{
      const s = String(t.start_point || t.start || t.start_city || "").trim();
      if(!s) return;
      counts.set(s.toUpperCase(), true);
    });
    STARTS = Array.from(counts.keys()).sort((a,b)=>a.localeCompare(b));
    const dl = $("startList");
    dl.innerHTML = "";
    STARTS.forEach(x=>{
      const opt = document.createElement("option");
      opt.value = x;
      dl.appendChild(opt);
    });
  }

  function normalizeStartInput(){
    const typed = String($("startInp").value || "").trim().toUpperCase();
    if(!typed) return "";
    const exact = STARTS.find(s => s === typed);
    if(exact) return exact;
    const partial = STARTS.find(s => s.startsWith(typed));
    if(partial) return partial;
    return typed;
  }

  function loadFromIndexStorage(){
    try{
      const t = sessionStorage.getItem("HX_TEMPLATES");
      const p = sessionStorage.getItem("HX_PLACES");
      const c = sessionStorage.getItem("HX_COSTS");
      if(!t || !p || !c) return false;
      TEMPLATES = JSON.parse(t) || {};
      PLACES = JSON.parse(p) || {};
      COSTS = JSON.parse(c) || {};
      return true;
    }catch(e){
      console.warn(e);
      return false;
    }
  }

  async function loadAll(){
    setStatus("Loading dataâ€¦");
    let ok = loadFromIndexStorage();

    if(!ok){
      try{
        setStatus("Fetching from Firebaseâ€¦");
        if(typeof window.hxFetchFirebaseAndCache === "function"){
          await window.hxFetchFirebaseAndCache();
          ok = loadFromIndexStorage();
        }
      }catch(e){
        console.error("Firebase fetch failed:", e);
        ok = false;
      }
    }

    if(!ok){
      setStatus("Data not found");
      $("pkgList").innerHTML = `<div class="pill"><b>Data not found</b></div>`;
      showBot("âŒ Firebase not loading. Check DB rules.");
      return;
    }

    const arr = Object.entries(TEMPLATES||{}).map(([k,v])=>({ key:k, ...(v||{}) }));
    ACTIVE_TEMPLATES = arr;

    initModeFromLanding();
    buildStartList(arr);

    const qs = new URLSearchParams(location.search);
    const startQS = (qs.get("start") || "").trim();
    if(startQS) $("startInp").value = String(startQS).toUpperCase();

    setStatus("Ready");
    showBot("âœ… Data loaded successfully");

    applyAndRender();
  }

  /* ======= TEMPLATE READERS ======= */
  function getTplKey(t){ return String(t.key || t.package_id || slugifyName(getTplName(t))); }
  function getTplName(t){
    return String(t.package_name || t.name || t.title || t.route_name || t.key || "PACKAGE").trim();
  }
  function getTplDays(t){ return Number(t.days || t.duration_days || t.trip_days || t.total_days || 0) || 0; }
  function getTplStart(t){ return String(t.start_point || t.start || t.start_city || "").trim().toUpperCase(); }
  function getTplDistrict(t){ return String(t.district || t.region || t.route_district || "â€”").trim().toUpperCase(); }
  function getTplCategory(t){
    const v = String(t.category || t.package_category || t.type || "").trim();
    return v ? v.toUpperCase() : "BUDGET";
  }
  function getTplRouteId(t){ return String(t.route_id || t.routeId || "").trim().toUpperCase(); }
  function getTplImages3(t){
    const arr = [];
    const imgs = Array.isArray(t.images) ? t.images : null;
    if(imgs && imgs.length){
      imgs.forEach(x=>{ if(x && String(x).trim()) arr.push(String(x).trim()); });
    }else{
      const a = String(t.cover || t.image || t.banner || "").trim();
      const b = String(t.image2 || t.gallery2 || "").trim();
      const c = String(t.image3 || t.gallery3 || "").trim();
      if(a) arr.push(a);
      if(b) arr.push(b);
      if(c) arr.push(c);
    }
    while(arr.length < 3) arr.push(arr[0] || "");
    return arr.slice(0,3);
  }

  function getCostForPackage(t){
    const keyA = String(t.package_id || t.key || "").trim();
    const keyB = String(getTplKey(t)).trim();
    const c = COSTS?.[keyA] || COSTS?.[keyA.toLowerCase()] || COSTS?.[keyB] || COSTS?.[keyB.toLowerCase()] || null;
    return c || null;
  }
  function pickTotal(costObj){
    if(!costObj) return "";
    return costObj.total || costObj.grand_total || costObj.total_price || costObj.totalAmount || costObj.amount || "";
  }
  function costLines(costObj){
    if(!costObj) return [];
    const lines = [];
    const maybe = [
      ["Hotel", costObj.hotel || costObj.hotels || costObj.hotel_cost],
      ["Cab", costObj.cab || costObj.transport || costObj.cab_cost],
      ["Meals", costObj.meals || costObj.food],
      ["Guide", costObj.guide],
      ["Activities", costObj.activities],
      ["Total", pickTotal(costObj)]
    ];
    maybe.forEach(([k,v])=>{
      if(v !== undefined && v !== null && String(v).trim() !== "") lines.push([k, String(v)]);
    });
    return lines.slice(0,6);
  }

  function itinPreview(t){
    const days = getTplDays(t) || 0;
    const itin = t.itinerary || t.day_wise || t.dayWise || null;
    if(Array.isArray(itin) && itin.length){
      return itin.slice(0, Math.min(5, itin.length)).map((d,i)=>{
        const ttl = d.title || d.heading || `Day ${d.day || (i+1)}`;
        const stops = Array.isArray(d.stops) ? d.stops.join(" â€¢ ") : (d.stops || d.desc || "");
        return { day: (d.day || (i+1)), title: String(ttl), sub: String(stops || "Route + sightseeing") };
      });
    }
    const guess = Math.min(5, Math.max(1, days || 5));
    return Array.from({length: guess}).map((_,i)=>({
      day: i+1,
      title: `Day ${i+1} Plan`,
      sub: "Day-wise locations (connect itinerary data)"
    }));
  }

  /* ======= FILTER + RENDER ======= */
  function applyAndRender(){
    if(!ACTIVE_TEMPLATES?.length){
      $("pkgList").innerHTML = `<div class="pill"><b>No templates loaded</b></div>`;
      return;
    }

    const start = normalizeStartInput();
    const daysWant = Number($("daysSel").value || 0);
    const cat = safeLower($("visitType").value);

    let base = ACTIVE_TEMPLATES.filter(t=>{
      const isLocal = isLocalComputed(t);
      return (TOUR_MODE === "outside") ? !isLocal : isLocal;
    });

    if(start) base = base.filter(t => getTplStart(t) === start);
    if(daysWant) base = base.filter(t => getTplDays(t) === daysWant);

    base = base.filter(t=>{
      const c = safeLower(t.category || t.package_category || t.type || "");
      if(!c) return true;
      return c === cat;
    });

    CURRENT_FILTERED = base;

    // if selected package no longer in filtered list, clear selection
    if(CURRENT_TEMPLATE_KEY && !base.some(t => getTplKey(t) === CURRENT_TEMPLATE_KEY)){
      CURRENT_TEMPLATE_KEY = "";
    }

    $("pkgCount").textContent = `${base.length} packages`;
    setStatus(base.length ? "Ready" : "No packages match filters");

    renderCenter(base);
    renderSidebar(base);
  }

  function renderCenter(list){
    if(!list.length){
      $("pkgList").innerHTML = `<div class="pill"><b>No packages found</b> â€” change filters</div>`;
      return;
    }

    // âœ… If selected -> show ONLY ONE package in center (with itinerary + costing + WA button)
    if(CURRENT_TEMPLATE_KEY){
      const t = list.find(x => getTplKey(x) === CURRENT_TEMPLATE_KEY);
      if(!t){
        $("pkgList").innerHTML = `<div class="pill"><b>No selected package</b></div>`;
        return;
      }

      const title = escapeHtml(getTplName(t));
      const start = escapeHtml(getTplStart(t));
      const dist  = escapeHtml(getTplDistrict(t));
      const days  = getTplDays(t);
      const nights = days ? Math.max(0, days-1) : 0;
      const cat   = escapeHtml(getTplCategory(t));
      const rid   = escapeHtml(getTplRouteId(t) || "â€”");
      const modeLabel = escapeHtml(TOUR_MODE === "outside" ? "INTERCITY" : "LOCAL");
      const imgs = getTplImages3(t);
      const cObj = getCostForPackage(t);
      const total = escapeHtml(pickTotal(cObj) || "â€”");
      const lines = costLines(cObj);
      const itin = itinPreview(t);

      $("pkgList").innerHTML = `
        <div class="pkgSolo">
          <div class="soloHead">
            <div class="ttl">
              <h2>${title}</h2>
              <div class="sub">
                <b>${modeLabel}</b> â€¢ <b>${cat}</b> â€¢ <b>${days || "â€”"}</b> Days / <b>${nights}</b> Nights
                <br>
                Start: <b>${start || "â€”"}</b> â€¢ District: <b>${dist || "â€”"}</b> â€¢ Route ID: <b>${rid}</b>
                <br>
                Estimated Total: <b>${total}</b>
              </div>
            </div>

            <div class="soloActions">
              <button class="sBtn" type="button" onclick="window.__backToList()">All Packages</button>
              <button class="sBtn primary" type="button" onclick="window.__askWhatsApp('${escapeHtml(getTplKey(t))}')">WhatsApp</button>
            </div>
          </div>

          <div class="soloBody">
            <div class="soloGallery">
              <div class="soloGalleryGrid">
                <div class="soloCell soloBig">
                  <img src="${escapeHtml(imgs[0] || './style/n1.jpg')}" alt="${title}" onerror="this.src='./style/n1.jpg'">
                </div>
                <div class="soloCell">
                  <img src="${escapeHtml(imgs[1] || imgs[0] || './style/n1.jpg')}" alt="${title}" onerror="this.src='./style/n1.jpg'">
                </div>
                <div class="soloCell">
                  <img src="${escapeHtml(imgs[2] || imgs[0] || './style/n1.jpg')}" alt="${title}" onerror="this.src='./style/n1.jpg'">
                </div>
              </div>
            </div>

            <div class="soloPanel">
              <div class="pTitle">Day-wise Itinerary</div>
              <div class="timeline">
                ${itin.map(r=>`
                  <div class="dayRow">
                    <div class="dayDot">${r.day}</div>
                    <div class="dayText">
                      <div class="t">${escapeHtml(r.title)}</div>
                      <div class="s">${escapeHtml(r.sub)}</div>
                    </div>
                  </div>
                `).join("")}
                <div class="mutedMini">Tip: connect full itinerary + place popups from Firebase itinerary data.</div>
              </div>

              <div style="height:12px"></div>

              <div class="pTitle">Cost Breakdown</div>
              ${
                lines.length ? `
                  ${lines.map(([k,v])=>`
                    <div class="costLine"><span>${escapeHtml(k)}</span><b>${escapeHtml(v)}</b></div>
                  `).join("")}
                  <div class="mutedMini">Data: <b>package_cost_breakdown</b> (Firebase)</div>
                ` : `
                  <div class="mutedMini">Costing not available for this package. Add in <b>package_cost_breakdown</b>.</div>
                `
              }
            </div>
          </div>

          <div class="soloBottom">
            <button class="bigWA" type="button" onclick="window.__askWhatsApp('${escapeHtml(getTplKey(t))}')">
              Query this package on WhatsApp
            </button>
          </div>
        </div>
      `;
      return;
    }

    // âœ… No selection -> show BAR LIST with MAX INFO
    $("pkgList").innerHTML = `
      <div class="barList">
        ${list.map(t=>{
          const key = getTplKey(t);
          const title = escapeHtml(getTplName(t));
          const start = escapeHtml(getTplStart(t));
          const dist  = escapeHtml(getTplDistrict(t));
          const days  = getTplDays(t);
          const nights = days ? Math.max(0, days-1) : 0;
          const cat   = escapeHtml(getTplCategory(t));
          const rid   = escapeHtml(getTplRouteId(t) || "â€”");
          const modeLabel = escapeHtml(TOUR_MODE === "outside" ? "INTERCITY" : "LOCAL");
          const imgs = getTplImages3(t);
          const cObj = getCostForPackage(t);
          const total = escapeHtml(pickTotal(cObj) || "â€”");

          return `
            <div class="pkgBar" onclick="window.__openPkg('${escapeHtml(key)}')">
              <div class="pkgBarTop">
                <div class="barThumb">
                  <img src="${escapeHtml(imgs[0] || './style/n1.jpg')}" alt="${title}" onerror="this.src='./style/n1.jpg'">
                  <div class="badgeRow">
                    <div class="bChip blue">${modeLabel}</div>
                    <div class="bChip">${cat}</div>
                  </div>
                </div>

                <div class="barInfo">
                  <div class="barTitleRow">
                    <h3 class="barTitle">${title}</h3>
                    <div class="openTag">OPEN</div>
                  </div>

                  <div class="metaRow">
                    <div class="mChip"><b>${days || "â€”"}</b> Days</div>
                    <div class="mChip"><b>${nights}</b> Nights</div>
                    <div class="mChip">Start: <b>${start || "â€”"}</b></div>
                    <div class="mChip">District: <b>${dist || "â€”"}</b></div>
                    <div class="mChip">Route: <b>${rid}</b></div>
                    <div class="mChip">Total: <b>${total}</b></div>
                  </div>

                  <div class="barMini">
                    <b>Tap</b> to open full itinerary + costing below.
                    WhatsApp query button will appear at bottom of the opened package.
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
  }

  // âœ… Sidebar shows all other packages as tiles when one is selected, else shows same list too
  function renderSidebar(list){
    const wrap = $("otherPkgList");
    if(!list.length){
      wrap.innerHTML = `<div class="otherHint">No packages match current filters.</div>`;
      return;
    }

    const others = CURRENT_TEMPLATE_KEY
      ? list.filter(t => getTplKey(t) !== CURRENT_TEMPLATE_KEY)
      : list;

    wrap.innerHTML = others.map(t=>{
      const key = getTplKey(t);
      const title = escapeHtml(getTplName(t));
      const days = getTplDays(t);
      const start = escapeHtml(getTplStart(t));
      const dist = escapeHtml(getTplDistrict(t));
      const cObj = getCostForPackage(t);
      const total = escapeHtml(pickTotal(cObj) || "â€”");
      const active = (CURRENT_TEMPLATE_KEY === key) ? "active" : "";

      return `
        <div class="pkgSide ${active}" onclick="window.__openPkg('${escapeHtml(key)}')">
          <div class="pkgSideTop">
            <div class="t1">${title}</div>
            <div class="badge blue">${days || "â€”"}D</div>
          </div>
          <div class="pkgSideRow">
            <span>${start || "â€”"}</span>
            <span>${dist || "â€”"}</span>
            <span>Total: ${total}</span>
          </div>
          <div class="pkgSidePrice">Tap to open</div>
        </div>
      `;
    }).join("");

    if(CURRENT_TEMPLATE_KEY){
      wrap.insertAdjacentHTML("afterbegin", `
        <div class="otherHint" style="border-style:solid;">
          <b>Selected package is open in center.</b><br>
          These are the remaining packages.
        </div>
      `);
    }
  }

  /* ======= ACTIONS ======= */
  window.__openPkg = function(key){
    CURRENT_TEMPLATE_KEY = key;
    renderCenter(CURRENT_FILTERED);
    renderSidebar(CURRENT_FILTERED);
    showBot("âœ… Package opened in center (only one visible)");
  };

  window.__backToList = function(){
    CURRENT_TEMPLATE_KEY = "";
    renderCenter(CURRENT_FILTERED);
    renderSidebar(CURRENT_FILTERED);
    showBot("ðŸ“¦ Showing all packages (bar list)");
  };

  window.__askWhatsApp = function(pkgKey){
    const t = (CURRENT_FILTERED || []).find(x => getTplKey(x) === pkgKey) || null;
    const title = t ? getTplName(t) : pkgKey;
    const start = t ? getTplStart(t) : "";
    const days  = t ? getTplDays(t) : "";
    const dist  = t ? getTplDistrict(t) : "";
    const cat   = t ? getTplCategory(t) : "";
    const cObj  = t ? getCostForPackage(t) : null;
    const total = pickTotal(cObj) || "";

    const msg = encodeURIComponent(
      `Hi Chandan, I want to query this package:\n` +
      `Package: ${title}\n` +
      (cat ? `Category: ${cat}\n` : "") +
      (start ? `Start: ${start}\n` : "") +
      (dist ? `District: ${dist}\n` : "") +
      (days ? `Days: ${days}\n` : "") +
      (total ? `Estimated Total: ${total}\n` : "") +
      `Please share best quote + hotel options.`
    );

    window.open(`https://wa.me/917018138847?text=${msg}`, "_blank", "noopener");
  };

  /* ======= UI WIRING ======= */
  function wireUI(){
    $("yy").textContent = new Date().getFullYear();

    $("pmClose").onclick = closePlaceModal;
    $("placeModal").addEventListener("click", (e)=>{
      if(e.target === $("placeModal")) closePlaceModal();
    });

    $("waClose").onclick = (e)=>{
      e.preventDefault(); e.stopPropagation();
      $("waFloat").style.display = "none";
      showBot("âœ… WhatsApp button hidden");
    };

    $("districtSelect").onchange = (e)=>{
      const v = e.target.value; if(v) location.href = v;
    };

    // buttons
    $("genBtn").onclick = ()=> applyAndRender();
    $("resetBtn").onclick = ()=>{
      $("visitType").value = "budget";
      $("daysSel").value = "";
      $("paxSel").value = "2";
      applyAndRender();
    };

    // auto render on change
    $("startInp").addEventListener("change", ()=> applyAndRender());
    $("visitType").addEventListener("change", ()=> applyAndRender());
    $("daysSel").addEventListener("change", ()=> applyAndRender());
    $("paxSel").addEventListener("change", ()=> applyAndRender());

    $("closeSelectedBtn").onclick = ()=>{
      CURRENT_TEMPLATE_KEY = "";
      renderCenter(CURRENT_FILTERED);
      renderSidebar(CURRENT_FILTERED);
      showBot("âœ… Closed selected package");
    };

    $("toggleTilesBtn").onclick = ()=>{
      tilesDark = !tilesDark;
      if(tilesDark){
        if(map.hasLayer(tile)) map.removeLayer(tile);
        tileDark.addTo(map);
      }else{
        if(map.hasLayer(tileDark)) map.removeLayer(tileDark);
        tile.addTo(map);
      }
      invalidateMapSoon();
    };

    $("topLink").onclick = (e)=>{ e.preventDefault(); window.scrollTo({ top:0, behavior:"smooth" }); };

    // optional (kept)
    $("fitMapBtn").onclick = ()=> showBot("ðŸ—ºï¸ Fit route: connect OSRM polyline logic here");
    $("clearRouteBtn").onclick = ()=> showBot("ðŸ§¹ Clear: connect route clear logic here");
    $("refreshBtn").onclick = async ()=>{
      showBot("ðŸ”„ Refreshingâ€¦");
      sessionStorage.removeItem("HX_TEMPLATES");
      sessionStorage.removeItem("HX_PLACES");
      sessionStorage.removeItem("HX_COSTS");
      await loadAll();
    };
    $("showAllStopsBtn").onclick = ()=> showBot("ðŸ“ Stops: connect day-wise pins from itinerary");
    $("showStartEndBtn").onclick = ()=> showBot("ðŸ Start/End: connect start & last stop markers");
  }

  document.addEventListener("DOMContentLoaded", async ()=>{
    try{
      wireUI();
      initMap();
      initModeFromLanding();
      await loadAll();
    }catch(err){
      console.error(err);
      setStatus("Error loading");
      showBot("âŒ Error. Check console.");
    }
  });
  </script>
</body>
</html>