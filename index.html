<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer â€¢ District Guide</title>
  <style>
    :root{
      --bg:#070B15;--text:#ECF2FF;--muted:rgba(236,242,255,.78);
      --stroke:rgba(255,255,255,.12);--panel:rgba(255,255,255,.07);
      --brand:#FF7A18;--chip:rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .app{display:flex;min-height:100vh}

    /* âœ… Sidebar only district list */
    .side{
      width:20%;min-width:260px;max-width:360px;border-right:1px solid var(--stroke);
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
      padding:14px;overflow:auto
    }
    .main{flex:1;min-width:0;padding:14px}

    .brand{display:flex;gap:10px;align-items:center;padding:10px;border-radius:16px;border:1px solid var(--stroke);background:rgba(0,0,0,.22)}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--brand);box-shadow:0 0 18px rgba(255,122,24,.75)}
    .title{font-weight:950}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .search{
      width:100%;margin-top:12px;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.14);
      outline:none;background:rgba(0,0,0,.18);color:var(--text);font-weight:850
    }
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .d{
      border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);
      padding:10px;cursor:pointer;transition:.12s transform ease,.12s border-color ease
    }
    .d:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.20)}
    .d.active{border-color:rgba(255,122,24,.45);box-shadow:0 0 0 1px rgba(255,122,24,.22) inset}
    .d b{display:block}
    .d small{color:var(--muted);font-weight:900;line-height:1.35}

    .hero{border-radius:24px;border:1px solid var(--stroke);overflow:hidden;background:rgba(255,255,255,.06)}
    .heroTop{padding:14px;background:rgba(0,0,0,.22);border-bottom:1px solid rgba(255,255,255,.10)}
    .heroTop h1{margin:0;font-size:clamp(22px,3vw,38px)}
    .heroTop p{margin:6px 0 0;color:rgba(236,242,255,.86);line-height:1.45}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .btn{
      border:0;cursor:pointer;padding:10px 12px;border-radius:14px;font-weight:950;
      color:#0b1220;background:linear-gradient(135deg,var(--brand),#ff9a4a)
    }
    .btnGhost{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:var(--text)}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{
      padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);
      background:var(--chip);color:rgba(236,242,255,.9);font-weight:950;font-size:12px;cursor:pointer;user-select:none
    }
    .chip.active{background:rgba(255,122,24,.20);border-color:rgba(255,122,24,.35)}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;padding:14px}
    .panel{
      border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.16);
      overflow:hidden
    }
    .panelHead{padding:12px;border-bottom:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
    .panelHead b{font-size:14px}
    .panelBody{padding:12px;color:rgba(236,242,255,.92);line-height:1.5}

    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .card{border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);overflow:hidden}
    .thumb{height:120px;background:rgba(255,255,255,.08);background-size:cover;background-position:center}
    .pad{padding:10px}
    .pad b{display:block}
    .meta{margin-top:4px;color:var(--muted);font-weight:900;font-size:12px;line-height:1.35}

    .empty{
      padding:18px;border-radius:18px;border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.14);color:rgba(236,242,255,.9);font-weight:950
    }

    @media(max-width:980px){
      .app{display:block}
      .side{width:auto;max-width:none;border-right:0;border-bottom:1px solid var(--stroke)}
      .cards{grid-template-columns:repeat(2,1fr)}
    }
    @media(max-width:520px){ .cards{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Himachal Explorer</div>
          <div class="sub">Select a district to see guide + how to reach</div>
        </div>
      </div>

      <input id="q" class="search" placeholder="Search districtâ€¦"/>

      <div class="list" id="districtList">
        <div class="d"><b>Loading districtsâ€¦</b><small>Please wait</small></div>
      </div>
    </aside>

    <main class="main">
      <section class="hero">
        <div class="heroTop">
          <h1 id="hTitle">Himachal Pradesh</h1>
          <p id="hSub">Pick a district from left sidebar. Youâ€™ll see brief description, how to reach, and top places.</p>

          <div class="toolbar">
            <button class="btn btnGhost" id="btnOpenMap" disabled>Open Map (2nd priority)</button>
            <button class="btn btnGhost" id="btnCopyDistrictJson" disabled>Copy District JSON</button>
          </div>

          <div class="chipRow" id="typeChips" style="display:none">
            <div class="chip active" data-type="all">All</div>
            <div class="chip" data-type="destinations">Destinations</div>
            <div class="chip" data-type="lakes">Lakes</div>
            <div class="chip" data-type="temples">Temples</div>
            <div class="chip" data-type="treks">Treks</div>
            <div class="chip" data-type="hotels">Hotels</div>
          </div>
        </div>

        <div class="grid">
          <div class="panel">
            <div class="panelHead"><b>District Brief</b></div>
            <div class="panelBody" id="briefBox">
              <div class="empty">Select a district to load details.</div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead"><b>How to Reach</b></div>
            <div class="panelBody" id="reachBox">
              <div class="empty">Select a district to load travel info.</div>
            </div>
          </div>

          <div class="panel">
            <div class="panelHead"><b>Top Places</b></div>
            <div class="panelBody" id="cardsWrap">
              <div class="empty">Select a district to see places.</div>
            </div>
          </div>

          <div class="panel" style="display:none">
            <div class="panelHead"><b>Raw JSON</b></div>
            <div class="panelBody"><pre id="raw" style="margin:0;white-space:pre-wrap"></pre></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";

    // âœ… Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const db = getDatabase(app);

    const ROOT = "tourism/hp/districts";
    const TYPES = ["destinations","lakes","temples","treks","hotels"];

    // UI
    const qEl = document.getElementById("q");
    const districtList = document.getElementById("districtList");

    const hTitle = document.getElementById("hTitle");
    const hSub = document.getElementById("hSub");

    const briefBox = document.getElementById("briefBox");
    const reachBox = document.getElementById("reachBox");
    const cardsWrap = document.getElementById("cardsWrap");

    const typeChips = document.getElementById("typeChips");
    const btnOpenMap = document.getElementById("btnOpenMap");
    const btnCopyDistrictJson = document.getElementById("btnCopyDistrictJson");
    const raw = document.getElementById("raw");

    // state
    let DISTRICTS = [];
    let ACTIVE_DIST = "";
    let ACTIVE_TYPE = "all";
    let ACTIVE_NODE = null;

    const safeObj = (x)=> (x && typeof x==="object") ? x : {};
    const norm = (s)=> String(s ?? "").trim();
    const low = (s)=> norm(s).toLowerCase();

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function extractPhotos(item){
      const a = [];
      const pushArr = (x)=> { if(Array.isArray(x)) x.forEach(u=>{ if(norm(u)) a.push(norm(u)); }); };
      pushArr(item.photos); pushArr(item.images); pushArr(item.gallery);
      if(norm(item.photoUrl)) a.push(norm(item.photoUrl));
      if(norm(item.imageUrl)) a.push(norm(item.imageUrl));
      if(norm(item.cover)) a.push(norm(item.cover));
      if(norm(item.photo)) a.push(norm(item.photo)); // legacy
      return Array.from(new Set(a));
    }

    function pickTitle(it){
      return it.name || it.title || it.place || it.placeName || it.locationName || "Untitled";
    }

    function flattenSegments(node){
      const seg = safeObj(node.segments);
      const out = [];
      for(const t of TYPES){
        const bucket = safeObj(seg[t]);
        for(const id of Object.keys(bucket)){
          const it = safeObj(bucket[id]);
          out.push({
            id, type:t,
            title: pickTitle(it),
            photos: extractPhotos(it),
            notes: it.notes || it.description || "",
            raw: it
          });
        }
      }
      return out;
    }

    function defaultBrief(d){
      return `â€¢ ${d} is one of the key districts of Himachal Pradesh with scenic viewpoints, culture, food and local markets.\nâ€¢ Best time depends on season â€“ summers for pleasant weather, winters for snow in higher areas.\nâ€¢ Explore: temples, treks, lakes, and local stays.`;
    }

    function defaultHowToReach(d){
      return `ðŸ›£ï¸ By Road: ${d} is well-connected by road from nearby districts.\nðŸš† By Train: Use nearest major railway station (varies by route).\nâœˆï¸ By Air: Use nearest airport for your district region.\n\nTip: Open Map to calculate live distance & route.`;
    }

    function renderDistrictList(){
      const q = low(qEl.value);
      const filtered = DISTRICTS.filter(d => !q || low(d).includes(q));

      districtList.innerHTML = (filtered.length ? filtered : [""]).map(d=>{
        if(!d) return `<div class="d"><b>No district found</b><small>Try a different search</small></div>`;
        const active = (ACTIVE_DIST === d) ? "active" : "";
        return `
          <div class="d ${active}" data-d="${escapeHtml(d)}">
            <b>${escapeHtml(d)}</b>
            <small>Click to open guide</small>
          </div>
        `;
      }).join("");

      [...districtList.querySelectorAll(".d[data-d]")].forEach(el=>{
        el.addEventListener("click", ()=> openDistrict(el.getAttribute("data-d")));
      });
    }

    function setActiveType(t){
      ACTIVE_TYPE = t;
      [...typeChips.querySelectorAll(".chip")].forEach(c=>{
        c.classList.toggle("active", c.getAttribute("data-type")===t);
      });
      renderCards();
    }

    function renderCards(){
      if(!ACTIVE_NODE){
        cardsWrap.innerHTML = `<div class="empty">Select a district to see places.</div>`;
        return;
      }

      const items = flattenSegments(ACTIVE_NODE);
      const filtered = items.filter(x => ACTIVE_TYPE==="all" ? true : x.type===ACTIVE_TYPE);

      if(!filtered.length){
        cardsWrap.innerHTML = `<div class="empty">No items in this category.</div>`;
        return;
      }

      cardsWrap.innerHTML = `
        <div class="cards">
          ${filtered.slice(0,60).map(x=>{
            const thumb = x.photos[0] ? `style="background-image:url('${x.photos[0].replaceAll("'", "%27")}')"` : "";
            return `
              <div class="card">
                <div class="thumb" ${thumb}></div>
                <div class="pad">
                  <b>${escapeHtml(x.title)}</b>
                  <div class="meta">Type: ${escapeHtml(x.type)} â€¢ ID: ${escapeHtml(x.id)}</div>
                  ${x.notes ? `<div class="meta">${escapeHtml(x.notes).slice(0,120)}${x.notes.length>120?"â€¦":""}</div>` : ""}
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    async function openDistrict(d){
      ACTIVE_DIST = d;
      ACTIVE_NODE = null;

      hTitle.textContent = d;
      hSub.textContent = "Loading district guideâ€¦";

      typeChips.style.display = "none";
      btnOpenMap.disabled = true;
      btnCopyDistrictJson.disabled = true;

      briefBox.innerHTML = `<div class="empty">Loadingâ€¦</div>`;
      reachBox.innerHTML = `<div class="empty">Loadingâ€¦</div>`;
      cardsWrap.innerHTML = `<div class="empty">Loadingâ€¦</div>`;

      renderDistrictList();

      try{
        const snap = await get(ref(db, `${ROOT}/${d}`));
        if(!snap.exists()){
          hSub.textContent = "No district data found.";
          briefBox.innerHTML = `<div>${escapeHtml(defaultBrief(d)).replaceAll("\n","<br/>")}</div>`;
          reachBox.innerHTML = `<div>${escapeHtml(defaultHowToReach(d)).replaceAll("\n","<br/>")}</div>`;
          cardsWrap.innerHTML = `<div class="empty">No places found in database for this district.</div>`;
          return;
        }

        ACTIVE_NODE = safeObj(snap.val());

        // Optional fields if you later add:
        // districtInfo: { brief, howToReach }
        const info = safeObj(ACTIVE_NODE.districtInfo);
        const brief = norm(info.brief) || defaultBrief(d);
        const reach = norm(info.howToReach) || defaultHowToReach(d);

        briefBox.innerHTML = `<div>${escapeHtml(brief).replaceAll("\n","<br/>")}</div>`;
        reachBox.innerHTML = `<div>${escapeHtml(reach).replaceAll("\n","<br/>")}</div>`;

        typeChips.style.display = "flex";
        setActiveType("all");

        btnOpenMap.disabled = false;
        btnCopyDistrictJson.disabled = false;
        hSub.textContent = "Guide loaded âœ… (Map is optional)";

        raw.textContent = JSON.stringify(ACTIVE_NODE, null, 2);
      }catch(e){
        console.error(e);
        hSub.textContent = "Load failed (rules/config?)";
        briefBox.innerHTML = `<div class="empty">Firebase read failed. Check rules/config.</div>`;
        reachBox.innerHTML = `<div class="empty">Firebase read failed. Check rules/config.</div>`;
        cardsWrap.innerHTML = `<div class="empty">Firebase read failed. Check rules/config.</div>`;
      }
    }

    // Buttons
    btnOpenMap.addEventListener("click", ()=>{
      if(!ACTIVE_DIST) return;
      location.href = `map.html#district=${encodeURIComponent(ACTIVE_DIST)}`;
    });

    btnCopyDistrictJson.addEventListener("click", async ()=>{
      if(!ACTIVE_NODE) return;
      await navigator.clipboard.writeText(JSON.stringify(ACTIVE_NODE, null, 2));
      alert("District JSON copied âœ…");
    });

    typeChips.addEventListener("click", (e)=>{
      const chip = e.target.closest(".chip");
      if(!chip) return;
      setActiveType(chip.getAttribute("data-type"));
    });

    qEl.addEventListener("input", renderDistrictList);

    // Auto load district list on open
    async function init(){
      const snap = await get(ref(db, ROOT));
      const root = snap.exists() ? safeObj(snap.val()) : {};
      DISTRICTS = Object.keys(root).sort((a,b)=>a.localeCompare(b));

      renderDistrictList();
      hSub.textContent = "Select a district from left sidebar.";

      // if URL has #district=Kullu
      const m = (location.hash || "").match(/district=([^&]+)/i);
      if(m){
        const d = decodeURIComponent(m[1]);
        if(DISTRICTS.includes(d)) openDistrict(d);
      }
    }

    init().catch(()=>{
      districtList.innerHTML = `<div class="d"><b>Firebase not configured</b><small>Check rules/config</small></div>`;
    });
  </script>
</body>
</html>
