<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Packages Grid + Road KM + Per Person</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#f6f8ff;
      --stroke: rgba(12,18,40,.10);
      --muted: rgba(12,18,40,.66);
      --text: #0b1220;
      --card: rgba(255,255,255,.90);
      --shadow: 0 18px 55px rgba(12,18,40,.12);
      --radius: 18px;
      --accent: #2563eb;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    /* ✅ LIGHT PREMIUM BACKGROUND (NSO STYLE) */
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg0);
      color:var(--text);
      overflow-x:hidden;
    }
    .bg{
      position:fixed; inset:0; z-index:-4;
      background:
        radial-gradient(1200px 560px at 18% 12%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(1100px 580px at 82% 18%, rgba(16,185,129,.14), transparent 60%),
        radial-gradient(900px 520px at 50% 86%, rgba(167,139,250,.10), transparent 65%),
        linear-gradient(180deg, #f2f6ff, #ffffff);
    }
    .noise{
      position:fixed; inset:0; z-index:-3;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
      opacity:.08;
      mix-blend-mode:overlay;
      pointer-events:none;
    }
    .blob{
      position:fixed;
      width:420px; height:420px;
      border-radius:50%;
      filter: blur(55px);
      opacity:.14;
      z-index:-2;
      animation: float 9s ease-in-out infinite;
      pointer-events:none;
    }
    .b1{ left:-120px; top:80px;  background: rgba(37,99,235,.95); }
    .b2{ right:-160px; top:140px; background: rgba(16,185,129,.90); animation-duration: 11s; }
    .b3{ left:38%; bottom:-220px; background: rgba(167,139,250,.90); animation-duration: 13s; }
    @keyframes float{
      0%,100%{ transform: translate(0,0) scale(1); }
      50%{ transform: translate(26px,-18px) scale(1.07); }
    }
    #fx{
      position:fixed; inset:0; z-index:-1;
      pointer-events:none;
      opacity:.55;
    }

    .wrap{ max-width: 1400px; margin: 0 auto; padding: 16px; }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .pad{ padding: 14px; }
    .hrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .title{ font-size: 18px; font-weight: 900; letter-spacing: .2px; text-transform: uppercase; }
    .sub{ color: var(--muted); font-size: 12.5px; line-height:1.35; text-transform: uppercase; }

    .hero{
      padding: 18px 16px;
      background:
        linear-gradient(135deg, rgba(37,99,235,.10), rgba(16,185,129,.07)),
        radial-gradient(900px 350px at 20% -20%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(700px 300px at 95% 0%, rgba(16,185,129,.12), transparent 60%);
      border-bottom: 1px solid var(--stroke);
    }

    /* ✅ Logo row */
    .hero-top{
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:14px;
    }
    .site-logo{
      height:72px;
      width:auto;
      background:white;
      padding:8px;
      border-radius:18px;
      box-shadow:0 12px 35px rgba(0,0,0,.18);
    }
    .hero-text h1{ margin:0; font-size: 22px; text-transform: uppercase; }
    .hero-text p{ margin:6px 0 0; color:var(--muted); font-size: 13px; max-width: 1050px; text-transform:none; }

    @media(max-width:780px){
      .hero-top{ flex-direction:column; text-align:center; }
      .site-logo{ height:56px; }
    }

    /* Main layout: left + map */
    .layout{ display:grid; grid-template-columns: 72% 28%; gap: 14px; align-items:start; margin-top:14px; }
    @media (max-width: 980px){ .layout{ grid-template-columns: 1fr; } }

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap:10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){ .controls{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .field label{ display:block; font-size:11px; color:var(--muted); margin:0 0 6px 2px; text-transform: uppercase; }
    select, input{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.96);
      outline:none;
      color: var(--text);
      text-transform: uppercase;
    }
    select:focus, input:focus{ border-color: rgba(37,99,235,.35); box-shadow: 0 0 0 3px rgba(37,99,235,.12); }

    .btn{
      appearance:none; border:0; border-radius: 12px; padding: 10px 12px;
      cursor:pointer; font-weight:900; background: var(--accent); color:white;
      box-shadow: 0 12px 30px rgba(37,99,235,.20);
      transition: transform .12s ease, filter .12s ease; width:100%;
      text-transform: uppercase;
    }
    .btn.secondary{
      background: rgba(255,255,255,.96);
      color: var(--text);
      border: 1px solid var(--stroke);
      box-shadow:none;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(0); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      font-size: 12px; color: var(--muted);
      margin: 6px 6px 0 0; white-space: nowrap;
      text-transform: uppercase;
    }
    .pill b{ color: var(--text); }

    /* ✅ Packages grid: 3 columns desktop */
    .pkgGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 1100px){ .pkgGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 780px){ .pkgGrid{ grid-template-columns: 1fr; } }

    .pkg{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,.95);
      padding: 12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      position: relative;
      overflow:hidden;
    }
    .pkg:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.28); }
    .pkg.active{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.10); }
    .pkgTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .pkgName{ font-weight: 950; font-size: 13.5px; line-height:1.25; text-transform: uppercase; }
    .badge{
      font-size: 11px; padding: 5px 8px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(16,185,129,.10);
      color: rgba(16,185,129,1);
      white-space: nowrap;
      text-transform: uppercase;
      font-weight: 900;
    }
    .badge.warn{ background: rgba(245,158,11,.12); color: rgba(245,158,11,1); }
    .badge.bad{ background: rgba(239,68,68,.12); color: rgba(239,68,68,1); }

    .pkgMeta{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      text-transform: uppercase;
    }
    .pkgMeta b{ color: var(--text); }

    .pkgMiniPrice{
      margin-top: 10px;
      border-top: 1px dashed var(--stroke);
      padding-top: 10px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      text-transform: uppercase;
    }
    .pkgMiniPrice .pp{ font-weight: 950; }
    .pkgMiniPrice .save{
      font-size: 11px;
      font-weight: 950;
      color: rgba(16,185,129,1);
      background: rgba(16,185,129,.10);
      border: 1px solid rgba(16,185,129,.25);
      border-radius: 999px;
      padding: 5px 8px;
      white-space: nowrap;
    }

    /* Places */
    .placesWrap{ margin-top: 12px; border-top: 1px solid var(--stroke); padding-top: 12px; }
    .placesHdr{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
    .count{ font-size:12px; color: var(--muted); text-transform: uppercase; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .placeBtns{
      display:flex; gap:8px; flex-wrap:wrap; max-height: 280px; overflow:auto; padding: 2px;
    }

    .place-btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.96);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
      transition: transform .12s ease, border-color .12s ease;
      text-transform: uppercase;
    }
    .place-btn:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.28); }
    .place-btn.active{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.10); }

    .thumb{
      width:46px; height:46px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      overflow:hidden;
      flex: 0 0 auto;
      background: linear-gradient(135deg, rgba(37,99,235,.16), rgba(16,185,129,.12));
      display:grid; place-items:center;
      font-weight:950;
      color: rgba(12,18,40,.55);
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .pinfo{ display:flex; flex-direction:column; gap:2px; min-width: 0; }
    .pname{ font-weight:950; font-size: 12.8px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .pmeta{ font-size:11px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .ord{
      width:22px; height:22px; display:inline-grid; place-items:center;
      border-radius: 50%;
      font-weight: 950;
      background: rgba(37,99,235,.10);
      color: rgba(37,99,235,1);
      flex: 0 0 auto;
      margin-left:auto;
    }

    .detail{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      padding: 12px;
      min-height: 120px;
    }
    .detail h3{ margin:0 0 4px; font-size: 15.5px; text-transform: uppercase; }
    .detail .meta{ font-size:12px; color:var(--muted); margin-bottom: 8px; text-transform: uppercase; }
    .detail .desc{ font-size:13px; color:var(--text); line-height: 1.35; text-transform:none; }

    /* Cost box */
    .costBox{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,.92);
      padding: 12px;
    }
    .costRow{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; font-size:13px; text-transform: uppercase; }
    .costRow span{ color: var(--muted); }
    .costRow b{ color: var(--text); }
    .costTotal{
      margin-top:8px;
      border-top:1px solid var(--stroke);
      padding-top:10px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      text-transform: uppercase;
    }
    .costTotal .big{ font-size:18px; font-weight:950; }
    .saveTag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
      color: rgba(16,185,129,1);
      font-size: 12px;
      font-weight: 950;
      white-space: nowrap;
      text-transform: uppercase;
    }

    /* Map */
    .mapCard .pad{ padding: 10px; }
    #map{
      width:100%;
      height: calc(100vh - 140px);
      min-height: 520px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      overflow:hidden;
    }
    @media (max-width: 980px){ #map{ height: 420px; min-height: 420px; } }

    .toast{
      position: fixed; left: 16px; bottom: 16px;
      background: rgba(255,255,255,.96);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      color: var(--muted);
      font-size: 12.5px;
      display:none;
      max-width: 560px;
      z-index: 9999;
      text-transform: uppercase;
      font-weight: 800;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <!-- ✅ PREMIUM BACKGROUND LAYER -->
  <div class="bg"></div>
  <canvas id="fx"></canvas>
  <div class="noise"></div>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <div class="wrap">
    <div class="card">
      <div class="hero">

        <!-- ✅ LOGO + TITLE -->
        <div class="hero-top">
          <!-- change to logo.jpg if your file is jpg -->
          <img src="logo.png" class="site-logo" alt="Himachal Explorer Logo">
          <div class="hero-text">
            <h1>Himachal Explorer — Packages Grid + Road KM + Per Person</h1>
            <p>
              Select <b>START</b> → shows packages in <b>3-column grid</b>. Click package → map draws <b>actual road route</b>
              & shows <b>road KM</b>. Prices show <b>PER PERSON</b> and are <b>6–10% cheaper</b>.
            </p>
          </div>
        </div>

        <div class="hrow">
          <div class="sub" id="dataStatus">LOADING TEMPLATES…</div>
        </div>

        <div class="controls">
          <div class="field" style="grid-column: span 3;">
            <label>START</label>
            <select id="startSel"><option value="">LOADING…</option></select>
          </div>

          <div class="field" style="grid-column: span 2;">
            <label>DAYS (FILTER)</label>
            <select id="daysSel">
              <option value="">ANY</option>
              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              <option value="7">7</option><option value="8">8</option><option value="9">9</option>
            </select>
          </div>

          <div class="field" style="grid-column: span 2;">
            <label>PEOPLE (PAX)</label>
            <select id="paxSel">
              <option value="2">2</option><option value="3">3</option><option value="4">4</option>
              <option value="5">5</option><option value="6">6</option><option value="7">7</option>
              <option value="8">8</option><option value="9">9</option><option value="10">10</option>
              <option value="11">11</option><option value="12">12</option>
            </select>
          </div>

          <div class="field" style="grid-column: span 2;">
            <label>VEHICLE (FILTER)</label>
            <select id="vehSel">
              <option value="any">ANY</option>
              <option value="tempo">TEMPO TRAVELLER ONLY</option>
            </select>
          </div>

          <div class="field" style="grid-column: span 2;">
            <label>SEARCH (ROUTE/END)</label>
            <input id="searchInp" placeholder="E.G. KUFRI, MANALI, R1, SHIMLA"/>
          </div>

          <div class="field" style="grid-column: span 1;">
            <label>&nbsp;</label>
            <button class="btn secondary" id="resetBtn">RESET</button>
          </div>
        </div>

        <div class="pad" style="padding-left:0; padding-right:0;">
          <div class="title">PACKAGES</div>
          <div class="sub">DUPLICATES REMOVED BY ROUTE CONTENT. GRID VIEW (3 COLUMNS). CLICK A CARD TO OPEN FULL ROAD ROUTE + PRICING.</div>
          <div id="summaryPills"></div>

          <div class="pkgGrid" id="pkgGrid">
            <div class="sub">SELECT START TO LOAD PACKAGES…</div>
          </div>
        </div>

        <div class="placesWrap">
          <div class="placesHdr">
            <div style="display:flex;gap:8px;align-items:baseline;flex-wrap:wrap;">
              <div class="title">ESSENTIAL PLACES</div>
              <div class="count" id="placesCount">—</div>
            </div>
            <div class="btnRow">
              <button class="btn secondary" id="fitBtn" style="width:auto;">FIT MAP</button>
              <button class="btn secondary" id="clearBtn" style="width:auto;">CLEAR ROUTE</button>
            </div>
          </div>

          <div class="placeBtns" id="placesButtons">
            <span class="sub">CLICK A PACKAGE TO SHOW PLACES…</span>
          </div>

          <div class="layout" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px;">
            <div class="detail" id="placeDetail">
              <h3>PLACE DETAILS</h3>
              <div class="meta">CLICK ANY PLACE TO SEE DETAILS.</div>
              <div class="desc" id="placeDesc">—</div>
            </div>

            <div class="costBox">
              <div class="title">PRICING</div>
              <div class="sub">USES OSRM ROAD KM. THEN APPLIES 6–10% DISCOUNT. SHOWS PER PERSON.</div>
              <div id="costRows"></div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="layout">
      <div class="card pad">
        <div class="title">RULE</div>
        <div class="sub" style="text-transform:none;">
          ✅ NO AERIAL DISTANCE. ROAD KM & ROAD LINE ONLY (OSRM).<br/>
          ✅ PLACE NAMES IN CAPS.<br/>
          ✅ PER PERSON PRICE SHOWN.
        </div>
      </div>

      <div class="card mapCard">
        <div class="pad">
          <div class="title">MAP</div>
          <div class="sub">ACTUAL ROAD ROUTE LINE</div>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/***********************
 * ✅ BACKGROUND PARTICLES (LIGHT)
 ***********************/
(function(){
  const c = document.getElementById('fx');
  const ctx = c.getContext('2d');
  let W, H, particles = [];

  function resize(){
    W = c.width = window.innerWidth;
    H = c.height = window.innerHeight;
    particles = Array.from({length: 70}, () => ({
      x: Math.random()*W,
      y: Math.random()*H,
      r: Math.random()*1.6 + 0.4,
      vx: (Math.random()*0.6 + 0.2) * (Math.random()<0.5?-1:1),
      vy: (Math.random()*0.6 + 0.2) * (Math.random()<0.5?-1:1),
      a: Math.random()*0.22 + 0.10
    }));
  }
  window.addEventListener('resize', resize);
  resize();

  function draw(){
    ctx.clearRect(0,0,W,H);

    for(const p of particles){
      p.x += p.vx; p.y += p.vy;
      if(p.x < -20) p.x = W+20;
      if(p.x > W+20) p.x = -20;
      if(p.y < -20) p.y = H+20;
      if(p.y > H+20) p.y = -20;

      ctx.beginPath();
      ctx.globalAlpha = p.a;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle = "#0b1b3a";
      ctx.fill();
    }

    for(let i=0;i<particles.length;i++){
      for(let j=i+1;j<particles.length;j++){
        const a = particles[i], b = particles[j];
        const dx = a.x-b.x, dy = a.y-b.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < 140){
          ctx.globalAlpha = (1 - dist/140) * 0.10;
          ctx.strokeStyle = "#2563eb";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(a.x,a.y);
          ctx.lineTo(b.x,b.y);
          ctx.stroke();
        }
      }
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(draw);
  }
  draw();
})();

/***********************
 * ✅ YOUR FIREBASE CONFIG
 ***********************/
const firebaseConfig = {
  apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
  authDomain: "revnue-records.firebaseapp.com",
  databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "revnue-records",
  storageBucket: "revnue-records.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:0000000000000000000000",
  measurementId: "G-0000000000"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/***********************
 * ✅ MAP
 ***********************/
const map = L.map('map', { zoomControl: true }).setView([31.1048, 77.1734], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

let markersLayer = L.layerGroup().addTo(map);
let routeLine = null;

function clearMap(){
  markersLayer.clearLayers();
  if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
}

/***********************
 * ✅ HELPERS
 ***********************/
const $ = (id)=>document.getElementById(id);
function setStatus(msg){ $("dataStatus").textContent = msg; }
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
function pill(label, value){
  const div = document.createElement("div");
  div.className = "pill";
  div.innerHTML = `${escapeHtml(label)}: <b>${escapeHtml(value)}</b>`;
  return div;
}
function initials(name){
  const parts = String(name||"").trim().split(/\s+/).slice(0,2);
  const ini = parts.map(x=>x[0]).join("").toUpperCase();
  return ini || "HP";
}
function rupees(n){
  return "₹" + Math.round(Number(n)||0).toLocaleString("en-IN");
}

/***********************
 * ✅ DATA
 ***********************/
let LOCS = {};
let TEMPLATES = {};
let ACTIVE_TEMPLATES = [];
let ACTIVE_TEMPLATE_KEY = null;
let CURRENT_STOPS = [];
let CURRENT_ROAD_KM = 0;

/***********************
 * ✅ LOAD
 ***********************/
async function loadAll(){
  setStatus("LOADING /templates & /locations…");
  const [tplSnap, locSnap] = await Promise.all([
    db.ref("templates").once("value"),
    db.ref("locations").once("value"),
  ]);
  TEMPLATES = tplSnap.val() || {};
  LOCS = locSnap.val() || {};

  ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
    .map(([key, obj]) => ({ key, ...(obj||{}) }))
    .filter(t => {
      const st = safeLower(t.status || "active");
      return st === "active" || st === "enabled" || st === "true";
    });

  fillStartDropdown(ACTIVE_TEMPLATES);
  setStatus(`LOADED ${ACTIVE_TEMPLATES.length} TEMPLATES • ${Object.keys(LOCS).length} LOCATIONS`);
}

function fillStartDropdown(templates){
  const startSel = $("startSel");
  startSel.innerHTML = "";
  startSel.appendChild(new Option("SELECT START", ""));
  const starts = new Set();
  templates.forEach(t=>{
    const s = String(t.start_point || "").trim();
    if(s) starts.add(s);
  });
  Array.from(starts).sort((a,b)=>a.localeCompare(b))
    .forEach(s => startSel.appendChild(new Option(String(s).toUpperCase(), s)));
}

/***********************
 * ✅ STOPS IN ROUTE ORDER (DAY-WISE)
 ***********************/
function stopsFromTemplate(tpl){
  const days = Number(tpl.days || 1);
  const out = [];
  const seen = new Set();

  for(let d=1; d<=Math.min(9, Math.max(1, days)); d++){
    const k = `day${d}_place_ids`;
    const raw = String(tpl[k] || "").trim();
    if(!raw) continue;
    raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
      if(seen.has(pid)) return;
      seen.add(pid);
      out.push(pid);
    });
  }

  if(!out.length){
    const raw = String(tpl.major_place_ids || "").trim();
    raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>out.push(pid));
  }
  return out;
}

/***********************
 * ✅ DEDUPE BY ROUTE CONTENT (FIX FOR YOUR ISSUE)
 ***********************/
function normalizeStopsSignature(t){
  const rp = String(t.route_path || "").trim();
  if(rp){
    return rp.toLowerCase().replace(/\s+/g,"").replace(/>>+/g,">").replace(/^>+|>+$/g,"");
  }
  const stops = stopsFromTemplate(t).map(s=>String(s).trim().toLowerCase()).filter(Boolean);
  return stops.join(">");
}

function dedupeTemplates(list){
  const sorted = [...list].sort((a,b)=>{
    const pa = Number(a.priority ?? 999);
    const pb = Number(b.priority ?? 999);
    const ka = Number(a.total_km_est ?? a.estimated_drive_km ?? 1e9);
    const kb = Number(b.total_km_est ?? b.estimated_drive_km ?? 1e9);
    return (pa-pb) || (ka-kb);
  });

  const seen = new Map();
  for(const t of sorted){
    const sig = [
      safeLower(t.start_point),
      safeLower(t.end_point),
      String(Number(t.days||0)),
      normalizeStopsSignature(t)
    ].join("|");

    if(!seen.has(sig)) seen.set(sig, t);
  }
  return Array.from(seen.values());
}

/***********************
 * ✅ PLACE THUMB (ONE PIC)
 ***********************/
function getPlaceThumbUrl(p){
  p = p || {};
  const p1 = p["photo 1"] || p.photo1 || p.photo_1 || p.photo || "";
  if(p1 && String(p1).trim()) return String(p1).trim();
  if(Array.isArray(p.photos) && p.photos[0]) return String(p.photos[0]).trim();
  if(Array.isArray(p.images) && p.images[0]) return String(p.images[0]).trim();
  const p2 = p["photo 2"] || p.photo2 || "";
  if(p2 && String(p2).trim()) return String(p2).trim();
  return "";
}

/***********************
 * ✅ VEHICLE BY PAX (FOR PRICING)
 ***********************/
function pickVehicleByPax(pax){
  if(pax <= 4) return "sedan";
  if(pax <= 6) return "suv";
  return "tempo";
}

/***********************
 * ✅ PRICE ENGINE (6–10% CHEAPER)
 ***********************/
function discountedCost(marketCost){
  const discount = 0.06 + Math.random()*0.04; // 6%..10%
  const finalCost = Math.round(marketCost * (1 - discount));
  return { final: finalCost, discountPercent: Math.round(discount*100) };
}

function estimateMarketCost({ km=0, days=3, pax=2, vehicle="sedan" }){
  const ratePerKm = { sedan:16, suv:20, tempo:28 }[vehicle] || 16;
  const driverPerDay = (vehicle==="tempo") ? 1300 : 1000;

  const minKm = Math.max(60, km || 0);
  const transport = Math.round(minKm * ratePerKm);
  const driver = Math.round(days * driverPerDay);

  // stay placeholder
  const rooms = Math.ceil(pax / 2);
  const stayPerRoomNight = 1800;
  const stay = Math.round(rooms * stayPerRoomNight * Math.max(1, (days - 1)));

  const service = Math.round((transport + driver + stay) * 0.08);
  const marketTotal = transport + driver + stay + service;

  return { transport, driver, stay, service, marketTotal };
}

function renderCostBox({status="idle", km=0, days=3, pax=2}){
  const box = $("costRows");

  if(status === "idle"){
    box.innerHTML = `<div class="sub" style="margin-top:8px;">SELECT A PACKAGE TO CALCULATE COST.</div>`;
    return;
  }
  if(status === "error"){
    box.innerHTML = `<div class="sub" style="margin-top:8px;">COST NOT AVAILABLE (ROAD KM NOT READY).</div>`;
    return;
  }

  const vehicle = pickVehicleByPax(pax);
  const mk = estimateMarketCost({ km, days, pax, vehicle });
  const disc = discountedCost(mk.marketTotal);
  const perPerson = Math.ceil(disc.final / Math.max(1, pax));

  box.innerHTML = `
    <div class="costRow"><span>ROAD KM</span><b>${km.toFixed(1)} KM</b></div>
    <div class="costRow"><span>DAYS</span><b>${days}</b></div>
    <div class="costRow"><span>PEOPLE</span><b>${pax}</b></div>
    <div class="costRow"><span>VEHICLE</span><b>${vehicle.toUpperCase()}</b></div>

    <div class="costRow"><span>TRANSPORT (MARKET)</span><b>${rupees(mk.transport)}</b></div>
    <div class="costRow"><span>DRIVER</span><b>${rupees(mk.driver)}</b></div>
    <div class="costRow"><span>STAY</span><b>${rupees(mk.stay)}</b></div>
    <div class="costRow"><span>SERVICE / MARGIN</span><b>${rupees(mk.service)}</b></div>

    <div class="costTotal">
      <div>
        <div class="sub">OUR TOTAL PRICE</div>
        <div class="big">${rupees(disc.final)}</div>
        <div class="sub" style="margin-top:6px;">PER PERSON</div>
        <div class="big">${rupees(perPerson)}</div>
      </div>
      <div class="saveTag">CHEAPER BY ${disc.discountPercent}%</div>
    </div>
  `;
}

/***********************
 * ✅ ROAD ROUTE + ROAD KM (OSRM)
 ***********************/
async function drawRoadRouteFromPlaces(placeIds){
  clearMap();
  CURRENT_ROAD_KM = 0;

  const coords = [];
  const validPlaceIds = [];

  placeIds.forEach(pid=>{
    const p = LOCS[pid] || {};
    const lat = Number(p.Latitude ?? p.lat);
    const lng = Number(p.Longitude ?? p.lng);
    if(isFinite(lat) && isFinite(lng)){
      coords.push([lng,lat]);
      validPlaceIds.push(pid);
    }
  });

  if(coords.length < 2){
    toast("NOT ENOUGH COORDINATES FOR ROAD ROUTE");
    return { ok:false, km:0 };
  }

  try{
    const maxPts = 25;
    let used = coords;

    if(coords.length > maxPts){
      const step = Math.ceil(coords.length / maxPts);
      used = coords.filter((_,i)=> i % step === 0 || i === coords.length-1);
    }

    const url =
      "https://router.project-osrm.org/route/v1/driving/" +
      used.map(c=>c.join(",")).join(";") +
      "?overview=full&geometries=geojson&steps=false";

    const res = await fetch(url);
    const data = await res.json();

    if(!data.routes?.length){
      toast("ROAD ROUTE NOT AVAILABLE");
      return { ok:false, km:0 };
    }

    const route = data.routes[0];
    const latlngs = route.geometry.coordinates.map(c=>[c[1],c[0]]);
    routeLine = L.polyline(latlngs, { weight: 5, opacity: .95 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[20,20] });

    coords.forEach((c,i)=>{
      const pid = validPlaceIds[i] || placeIds[i];
      const p = LOCS[pid] || {};
      const name = (p["Location Name"] || p.name || pid).toUpperCase();
      L.marker([c[1], c[0]]).addTo(markersLayer).bindPopup(`<b>${i+1}. ${escapeHtml(name)}</b>`);
    });

    const km = Number(route.distance / 1000);
    CURRENT_ROAD_KM = km;
    return { ok:true, km };

  }catch(err){
    console.error(err);
    toast("ROAD ROUTE ERROR");
    return { ok:false, km:0 };
  }
}

function fitMap(){
  if(routeLine){ map.fitBounds(routeLine.getBounds(), { padding:[18,18] }); return; }
  const all=[];
  markersLayer.eachLayer(l=>{ if(l.getLatLng) all.push(l.getLatLng()); });
  if(all.length) map.fitBounds(L.latLngBounds(all), { padding:[18,18] });
}

/***********************
 * ✅ PLACES UI
 ***********************/
function renderPlaceButtons(placeIds){
  const box = $("placesButtons");
  box.innerHTML = "";

  if(!placeIds.length){
    box.innerHTML = `<span class="sub">NO PLACES FOUND IN THIS PACKAGE.</span>`;
    $("placesCount").textContent = "0 PLACES";
    return;
  }
  $("placesCount").textContent = `${placeIds.length} PLACES`;

  placeIds.forEach((pid, idx)=>{
    const p = LOCS[pid] || {};
    const name = (p["Location Name"] || p.name || pid).toUpperCase();
    const seg  = String(p["Segment Type"] || p.segment || "—").toUpperCase();
    const url = getPlaceThumbUrl(p);

    const btn = document.createElement("button");
    btn.className = "place-btn";
    btn.innerHTML = `
      <div class="thumb">
        ${url ? `<img src="${escapeHtml(url)}" alt="${escapeHtml(name)}" loading="lazy"
                 onerror="this.remove(); this.parentNode.textContent='${escapeHtml(initials(name))}';">`
              : `${escapeHtml(initials(name))}`}
      </div>
      <div class="pinfo">
        <div class="pname">${escapeHtml(name)}</div>
        <div class="pmeta">${escapeHtml(seg)}</div>
      </div>
      <span class="ord">${idx+1}</span>
    `;
    btn.onclick = ()=>selectPlace(pid, idx+1);
    box.appendChild(btn);
  });
}

function highlightActiveButton(index1based){
  const btns = $("placesButtons").querySelectorAll(".place-btn");
  btns.forEach(b=>b.classList.remove("active"));
  const target = btns[index1based-1];
  if(target) target.classList.add("active");
}

function selectPlace(placeId, order){
  highlightActiveButton(order);

  const p = LOCS[placeId] || {};
  const name = (p["Location Name"] || p.name || placeId).toUpperCase();
  const seg  = String(p["Segment Type"] || p.segment || "—").toUpperCase();
  const typ  = String(p["Location Type"] || p.type || "—").toUpperCase();
  const short= String(p["Short Description"] || p.short || "");
  const ov   = String(p["Overview"] || p.overview || "");
  const how  = String(p["How to Reach"] || p.how || "");

  $("placeDetail").querySelector("h3").textContent = name;
  $("placeDetail").querySelector(".meta").textContent = `${seg} • ${typ}`;
  $("placeDesc").innerHTML =
    `<div class="sub" style="margin-bottom:6px;"><b>HOW TO REACH:</b> ${escapeHtml(how||"—").toUpperCase()}</div>` +
    `<div class="desc">${escapeHtml((short || ov || "—"))}</div>`;

  const lat = Number(p.Latitude ?? p.lat);
  const lng = Number(p.Longitude ?? p.lng);
  if(isFinite(lat) && isFinite(lng)){
    map.setView([lat,lng], Math.max(map.getZoom(), 12));
  }
}

/***********************
 * ✅ PACKAGES GRID RENDER
 ***********************/
function applyFilters(){
  const start = $("startSel").value.trim();
  const daysF = $("daysSel").value.trim();
  const vehF  = $("vehSel").value;
  const q     = $("searchInp").value.trim().toLowerCase();

  $("summaryPills").innerHTML = "";
  $("pkgGrid").innerHTML = `<div class="sub">SELECT START TO LOAD PACKAGES…</div>`;
  $("placesButtons").innerHTML = `<span class="sub">CLICK A PACKAGE TO SHOW PLACES…</span>`;
  $("placesCount").textContent = "—";
  renderCostBox({status:"idle"});
  clearMap();
  ACTIVE_TEMPLATE_KEY = null;
  CURRENT_STOPS = [];
  CURRENT_ROAD_KM = 0;

  if(!start) return;

  let list = ACTIVE_TEMPLATES.filter(t => String(t.start_point||"").trim() === start);

  if(daysF) list = list.filter(t => Number(t.days||0) === Number(daysF));
  if(vehF === "tempo") list = list.filter(t => t.tempo_ok === true || safeLower(t.tempo_ok) === "true");

  if(q){
    list = list.filter(t=>{
      const name = safeLower(t.route_name || t.title || "");
      const end  = safeLower(t.end_point || "");
      const rid  = safeLower(t.route_id || "");
      const reg  = safeLower(t.region_style || "");
      return (name.includes(q) || end.includes(q) || rid.includes(q) || reg.includes(q));
    });
  }

  list = dedupeTemplates(list);

  list.sort((a,b)=>{
    const pa = Number(a.priority ?? 999);
    const pb = Number(b.priority ?? 999);
    const ka = Number(a.total_km_est ?? a.estimated_drive_km ?? 1e9);
    const kb = Number(b.total_km_est ?? b.estimated_drive_km ?? 1e9);
    return (pa-pb) || (ka-kb);
  });

  $("summaryPills").appendChild(pill("START", String(start).toUpperCase()));
  $("summaryPills").appendChild(pill("PACKAGES", String(list.length)));
  $("summaryPills").appendChild(pill("PAX", String($("paxSel").value)));

  renderPackagesGrid(list);
}

function renderPackagesGrid(list){
  const grid = $("pkgGrid");
  grid.innerHTML = "";

  if(!list.length){
    grid.innerHTML = `<div class="sub">NO PACKAGES FOUND FOR THIS START (WITH CURRENT FILTERS).</div>`;
    return;
  }

  const pax = Number($("paxSel").value || 2);

  list.forEach(t=>{
    const key = t.key;
    const name = String(t.route_name || t.title || t.package_id || key).toUpperCase();
    const end  = String(t.end_point || "—").toUpperCase();
    const days = Number(t.days || 0) || 0;
    const tempoOk = (t.tempo_ok === true || safeLower(t.tempo_ok)==="true");
    const estKm = Number(t.total_km_est ?? t.estimated_drive_km ?? 0);

    const vehicle = pickVehicleByPax(pax);
    const mk = estimateMarketCost({ km: estKm || 0, days: days || Number($("daysSel").value||3) || 3, pax, vehicle });
    const disc = discountedCost(mk.marketTotal);
    const perPerson = Math.ceil(disc.final / Math.max(1, pax));

    const card = document.createElement("div");
    card.className = "pkg";
    card.dataset.key = key;

    card.innerHTML = `
      <div class="pkgTop">
        <div class="pkgName">${escapeHtml(name)}</div>
        <div class="badge ${tempoOk ? "" : "warn"}">${tempoOk ? "TEMPO OK" : "TEMPO RISK"}</div>
      </div>
      <div class="pkgMeta">
        <b>END:</b> ${escapeHtml(end)}<br/>
        <b>DAYS:</b> ${days || "—"} &nbsp;•&nbsp;
        <b>TEMPLATE KM:</b> ${isFinite(estKm) && estKm ? estKm : "—"}<br/>
        <b>ROUTE ID:</b> ${escapeHtml(String(t.route_id||"—").toUpperCase())}
      </div>
      <div class="pkgMiniPrice">
        <div>
          <div class="sub">PER PERSON (EST)</div>
          <div class="pp">${rupees(perPerson)}</div>
        </div>
        <div class="save">CHEAPER ${disc.discountPercent}%</div>
      </div>
    `;

    card.onclick = async ()=>{
      document.querySelectorAll(".pkg").forEach(x=>x.classList.remove("active"));
      card.classList.add("active");
      await openTemplate(key);
    };

    grid.appendChild(card);
  });
}

/***********************
 * ✅ OPEN PACKAGE
 ***********************/
async function openTemplate(key){
  const tpl = TEMPLATES[key];
  if(!tpl){ toast("PACKAGE NOT FOUND"); return; }

  ACTIVE_TEMPLATE_KEY = key;

  const stops = stopsFromTemplate(tpl);
  CURRENT_STOPS = stops;

  renderPlaceButtons(stops);
  if(stops.length) selectPlace(stops[0], 1);

  renderCostBox({status:"idle"});
  const rr = await drawRoadRouteFromPlaces(stops);

  const days = Number(tpl.days || $("daysSel").value || 3);
  const pax = Number($("paxSel").value || 2);

  if(rr.ok){
    $("summaryPills").appendChild(pill("ROAD KM", rr.km.toFixed(1)));
    renderCostBox({status:"ok", km: rr.km, days, pax});
    toast("ROAD ROUTE LOADED");
  }else{
    renderCostBox({status:"error"});
  }
}

/***********************
 * ✅ EVENTS
 ***********************/
$("startSel").addEventListener("change", applyFilters);
$("daysSel").addEventListener("change", applyFilters);
$("vehSel").addEventListener("change", applyFilters);

$("searchInp").addEventListener("input", ()=>{
  window.__t && clearTimeout(window.__t);
  window.__t = setTimeout(applyFilters, 180);
});

$("paxSel").addEventListener("change", applyFilters);

$("resetBtn").addEventListener("click", ()=>{
  $("startSel").value = "";
  $("daysSel").value = "";
  $("vehSel").value = "any";
  $("searchInp").value = "";
  $("paxSel").value = "2";

  $("summaryPills").innerHTML = "";
  $("pkgGrid").innerHTML = `<div class="sub">SELECT START TO LOAD PACKAGES…</div>`;
  $("placesButtons").innerHTML = `<span class="sub">CLICK A PACKAGE TO SHOW PLACES…</span>`;
  $("placesCount").textContent = "—";
  renderCostBox({status:"idle"});

  $("placeDetail").querySelector("h3").textContent = "PLACE DETAILS";
  $("placeDetail").querySelector(".meta").textContent = "CLICK ANY PLACE TO SEE DETAILS.";
  $("placeDesc").textContent = "—";

  clearMap();
  ACTIVE_TEMPLATE_KEY = null;
  CURRENT_STOPS = [];
  CURRENT_ROAD_KM = 0;

  toast("RESET DONE");
});

$("fitBtn").addEventListener("click", fitMap);
$("clearBtn").addEventListener("click", ()=>{
  clearMap();
  toast("ROUTE CLEARED");
});

/***********************
 * ✅ INIT
 ***********************/
renderCostBox({status:"idle"});
loadAll().catch(err=>{
  console.error(err);
  setStatus("ERROR LOADING FIREBASE DATA");
  toast("FIREBASE LOAD ERROR (CHECK RULES / NODE NAMES)");
});
</script>
</body>
</html>