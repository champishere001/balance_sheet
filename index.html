<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer ‚Äî Segments First + AI Master Planner + Smart Packages</title>

  <!-- Leaflet (no API key needed) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat RTDB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

  <style>
    :root{
      --bg0:#050815; --bg1:#0b1022;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --brand:#6d7cff;
      --brand2:#2de2c4;
      --warn:#ffcf5a;
      --bad:#ff6b6b;
      --ok:#49f2c2;
      --r:18px; --r2:26px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 10% 15%, rgba(109,124,255,.30), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(45,226,196,.18), transparent 55%),
        radial-gradient(850px 650px at 65% 85%, rgba(255,207,90,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{max-width: 1280px;margin: 0 auto;padding: 18px 14px 34px;}
    a{color:inherit}

    /* ===== TOPBAR ===== */
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      position: sticky; top: 10px; z-index: 60;
      flex-wrap: wrap;
    }
    .brand{display:flex;align-items:center;gap:12px;min-width: 280px;}
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.92), transparent 60%),
        linear-gradient(135deg, rgba(109,124,255,.98), rgba(45,226,196,.72));
      box-shadow: 0 18px 40px rgba(109,124,255,.25);
      border:1px solid rgba(255,255,255,.20);
      flex:0 0 auto;
    }
    .brand h1{margin:0;font-size:16px;line-height:1.1}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .pills{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
      user-select:none;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
    .tabBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .tabBtn:hover{transform: translateY(-1px)}
    .tabBtn.active{
      background: linear-gradient(135deg, rgba(109,124,255,.92), rgba(45,226,196,.65));
      border: 1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.95);
      font-weight: 900;
    }

    /* ===== LAYOUT ===== */
    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 65% 35%;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .topbar{position:relative; top:auto}
      .layout{grid-template-columns: 1fr;}
      .tabs{justify-content:flex-start}
    }

    /* ===== HERO ===== */
    .hero{
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-height: 520px;
    }
    .heroBg{
      position:absolute; inset:0;
      background:
        radial-gradient(700px 500px at 15% 15%, rgba(109,124,255,.28), transparent 60%),
        radial-gradient(650px 480px at 75% 20%, rgba(45,226,196,.18), transparent 60%),
        radial-gradient(700px 520px at 60% 85%, rgba(255,207,90,.10), transparent 65%);
      opacity:.95;
      pointer-events:none;
    }
    .heroBgImg{
      position:absolute; inset:0;
      background-size: cover;
      background-position:center;
      filter: saturate(1.05) contrast(1.05);
      opacity:.16;
      transform: scale(1.02);
      mix-blend-mode: screen;
    }
    .heroInner{position:relative;padding: 18px 18px 18px;display:grid;grid-template-rows: auto auto 1fr;gap:12px;}
    .heroTag{
      display:inline-flex;align-items:center;gap:10px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--muted);font-size:12px;width: fit-content;
    }
    .heroTitle{font-size: 34px;line-height: 1.08;margin: 0;letter-spacing: -0.02em;}
    .heroTitle span{
      background: linear-gradient(135deg, rgba(109,124,255,1), rgba(45,226,196,1));
      -webkit-background-clip: text;background-clip:text;color: transparent;
    }
    .heroDesc{margin:0;color: var(--muted);font-size: 14px;line-height: 1.55;max-width: 78ch;}

    /* Quotes */
    .quoteGrid{margin-top: 8px;display:grid;grid-template-columns: repeat(3, 1fr);gap: 10px;}
    @media (max-width: 820px){.quoteGrid{grid-template-columns: 1fr}.hero{min-height:auto}}
    .quoteCard{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px 12px;
      overflow:hidden;
      position:relative;
      min-height: 120px;
      backdrop-filter: blur(10px);
    }
    .quoteCard::after{
      content:"";
      position:absolute; inset:auto -40px -40px auto;
      width:120px;height:120px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(109,124,255,.30), transparent 60%);
      opacity:.6;
    }
    .quoteTxt{position:relative;margin:0;color: rgba(255,255,255,.90);font-size: 13px;line-height: 1.5;}
    .quoteBy{position:relative;margin-top: 8px;font-size: 12px;color: var(--muted2);}
    .fade{animation: fadeIn .35s ease;}
    @keyframes fadeIn{from{opacity:.0; transform: translateY(4px)}to{opacity:1; transform: translateY(0)}}

    /* ===== PLANNER ===== */
    .plannerCol{display:grid;gap:14px;}
    .planner{
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
      position: sticky;
      top: 86px;
      backdrop-filter: blur(12px);
    }
    @media (max-width: 980px){.planner{position:relative; top:auto}}
    .plannerHead{
      padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .plannerHead h2{margin:0;font-size:14px}
    .plannerHead .sub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.35}
    .plannerBody{padding:12px 14px}

    .form{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    .form .full{grid-column: 1 / -1;}
    @media (max-width: 980px){.form{grid-template-columns: 1fr}}
    label{display:block;font-size:12px;color: var(--muted);margin:0 0 6px;}
    input,select,button,textarea{
      width:100%;
      padding:10px 11px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font: inherit;
    }
    textarea{min-height: 96px; resize: vertical;}
    input::placeholder{color: rgba(255,255,255,.45)}
    select option{color:#111}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap;margin-top:10px;}
    button{
      cursor:pointer;
      border:none;
      background: linear-gradient(135deg, rgba(109,124,255,.98), rgba(45,226,196,.75));
      box-shadow: 0 16px 40px rgba(109,124,255,.18);
      font-weight: 900;
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      font-weight: 800;
    }
    button.ghost{
      background: transparent;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      font-weight: 800;
    }

    .kpis{margin-top:12px;display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    .kpi{border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);border-radius: 18px;padding:10px 12px;}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:14px;font-weight:900;margin-top:4px}
    .mutedSmall{font-size:12px;color:var(--muted);line-height:1.4}
    .hr{height:1px;background:rgba(255,255,255,.10); margin:10px 0}
    .hidden{display:none !important;}

    /* Results */
    .results{border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.05);border-radius: var(--r2);overflow:hidden;}
    .resultsHead{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .resultsHead b{font-size:13px}
    .resultsBody{padding:10px 12px; display:grid; gap:10px}
    .pkg{border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);border-radius: 18px;padding:10px 10px;}
    .pkgTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .pkg h3{margin:0;font-size:13px}
    .pkg .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .price{white-space:nowrap;font-weight: 900;font-size: 13px;background: rgba(0,0,0,.20);border: 1px solid rgba(255,255,255,.10);padding:6px 8px;border-radius: 999px;}
    .chips{margin-top:8px;display:flex; gap:6px; flex-wrap:wrap;}
    .chip{font-size:12px;padding:6px 8px;border-radius: 999px;background: rgba(109,124,255,.16);border: 1px solid rgba(109,124,255,.22);color: rgba(255,255,255,.88);}
    .chip2{background: rgba(45,226,196,.14);border: 1px solid rgba(45,226,196,.20);}
    .chip3{background: rgba(255,207,90,.12);border: 1px solid rgba(255,207,90,.18);}

    /* ===== EXPLORE ===== */
    .below{margin-top: 14px;border:1px solid rgba(255,255,255,.12);background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));border-radius: var(--r2);box-shadow: var(--shadow);overflow:hidden;}
    .belowHead{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex; align-items:center; justify-content:space-between; gap:10px;flex-wrap: wrap;}
    .belowHead .title{display:flex; flex-direction:column; gap:4px;}
    .belowHead .title b{font-size:14px}
    .belowHead .title span{font-size:12px;color:var(--muted)}
    .belowBody{padding:12px 14px;}
    .split{display:grid;grid-template-columns: 1.2fr .8fr;gap:12px;align-items:start;}
    @media (max-width: 980px){.split{grid-template-columns: 1fr}}
    .panel{border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.05);border-radius: 20px;overflow:hidden;}
    .panelHead{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .panelHead b{font-size:13px}
    .panelBody{padding:10px 12px}
    .filters{display:grid;grid-template-columns: 1fr 1fr;gap:10px;}
    .filters .full{grid-column: 1 / -1;}
    .grid{display:grid;grid-template-columns: repeat(3, 1fr);gap:10px;}
    @media (max-width: 980px){.grid{grid-template-columns: repeat(2, 1fr)}}
    @media (max-width: 560px){.grid{grid-template-columns: 1fr}}

    /* Segment cards (main screen) */
    .segCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px 12px;
      cursor:pointer;
      transition: transform .12s ease;
      position:relative;
      overflow:hidden;
      min-height: 120px;
    }
    .segCard:hover{transform: translateY(-2px)}
    .segCard::after{
      content:"";
      position:absolute; inset:auto -50px -50px auto;
      width:160px;height:160px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(45,226,196,.20), transparent 60%);
      opacity:.7;
    }
    .segCard b{position:relative; display:block; font-size:13px;}
    .segCard .sub{position:relative; margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}
    .segCard .count{position:relative; margin-top:10px; font-size:12px; font-weight:900; display:inline-flex; gap:8px; align-items:center;}
    .pillTiny{width:auto; padding:6px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.18);}

    /* Place cards */
    .card{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease;
      display:grid;
      grid-template-rows: 128px auto;
      min-height: 230px;
      position:relative;
    }
    .card:hover{transform: translateY(-2px)}
    .thumb{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(160px 120px at 20% 20%, rgba(109,124,255,.30), transparent 60%),
        radial-gradient(140px 120px at 80% 25%, rgba(45,226,196,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;opacity:.92;filter:saturate(1.05) contrast(1.05);}
    .thumb .tag{
      position:absolute; left:10px; top:10px;
      font-size:12px;padding:6px 8px;border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
    }
    .cardBody{padding:10px 10px;}
    .cardBody b{display:block;font-size:13px;line-height:1.25}
    .cardBody .sub{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.35}
    .row{margin-top:8px;display:flex; gap:6px; flex-wrap:wrap;}
    .mini{font-size:12px;padding:5px 7px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.05);color: rgba(255,255,255,.84);}

    /* Map */
    #map{width:100%;height: 360px;border-radius: 20px;border:1px solid rgba(255,255,255,.12);overflow:hidden;}
    .mapHint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.4}

    /* Modal */
    .modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,.55);
      z-index: 1000;
    }
    .modal.show{display:flex}
    .modalCard{
      width:min(980px, 96vw);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(20,24,48,.92), rgba(10,12,28,.92));
      box-shadow: 0 30px 120px rgba(0,0,0,.75);
      overflow:hidden;
      backdrop-filter: blur(14px);
    }
    .modalTop{display:flex; align-items:center; justify-content:space-between; gap:10px;padding: 12px 14px;border-bottom:1px solid rgba(255,255,255,.10);}
    .modalTop b{font-size:14px}
    .closeBtn{
      width:auto;padding:8px 10px;border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;font-weight: 900;
    }
    .modalBody{padding: 12px 14px;display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 900px){.modalBody{grid-template-columns: 1fr}}
    .modalImg{
      border-radius: 20px;overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      height: 260px; position:relative;
    }
    .modalImg img{width:100%;height:100%;object-fit:cover;display:block;opacity:.95}
    .modalImg .overlay{
      position:absolute; inset:0;
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.35));
      pointer-events:none;
    }
    .modalBlock{border:1px solid rgba(255,255,255,.10);background: rgba(255,255,255,.05);border-radius: 20px;padding: 10px 12px;}
    .modalBlock .h{font-size:12px;color:var(--muted)}
    .modalBlock .v{margin-top:6px;font-size:13px;line-height:1.45}
    .modalActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}

    /* AI Master Planner */
    .aiBox{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 20px;
      overflow:hidden;
    }
    .aiHead{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;gap:10px;align-items:center;}
    .aiHead b{font-size:13px}
    .aiBody{padding:10px 12px;display:grid;gap:10px;}
    .aiMsg{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 10px 10px;
      font-size: 13px;
      line-height: 1.45;
    }
    .aiMsg small{display:block;color:rgba(255,255,255,.55);margin-top:6px}
    .aiRow{display:grid;grid-template-columns: 1fr auto; gap:10px; align-items:stretch;}
    @media (max-width: 980px){.aiRow{grid-template-columns:1fr}}
    .aiBtn{width:auto; padding:10px 14px; border-radius:14px; font-weight:900;}
    .toast{
      position: fixed; right: 16px; bottom: 16px; z-index: 2000;
      display:none; min-width: 260px; max-width: 360px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(15,18,40,.86);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.92);
      border-radius: 18px;
      box-shadow: 0 20px 80px rgba(0,0,0,.6);
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.35;
    }
    .toast.show{display:block; animation: toastIn .2s ease}
    @keyframes toastIn{from{opacity:0; transform: translateY(6px)}to{opacity:1; transform: translateY(0)}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Himachal Explorer</h1>
          <p>Main screen shows only <b>Segments</b> (NOT others) ‚Ä¢ Click a segment ‚Üí places ‚Ä¢ Planner + AI master plan</p>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="tabExplore">Explore</button>
        <button class="tabBtn" data-tab="tabPackages">Packages</button>
        <button class="tabBtn" data-tab="tabAI">AI Master Planner</button>
      </div>

      <div class="pills">
        <div class="pill"><span id="dbDot" class="dot"></span><span id="dbText">Connecting‚Ä¶</span></div>
        <div class="pill">Loaded <b id="loadedCount" style="margin-left:6px">0</b></div>
      </div>
    </div>

    <!-- ===== PACKAGES TAB ===== -->
    <div class="layout hidden" id="tabPackages">
      <section class="hero">
        <div class="heroBg"></div>
        <div class="heroBgImg" id="heroBgImg"></div>

        <div class="heroInner">
          <div class="heroTag">
            <span style="width:8px;height:8px;border-radius:999px;background:var(--brand2)"></span>
            <span>Route-friendly travel planning</span>
          </div>

          <h2 class="heroTitle">Build a <span>Smart Package</span> ‚Äî realistic distance, real cost</h2>

          <p class="heroDesc">
            Select Start ‚Üí End. We pick places near your travel corridor so you don‚Äôt get far-away locations in one package.
            Images from your Firebase places are also used as subtle background.
          </p>

          <div class="quoteGrid" id="quoteGrid"></div>
        </div>
      </section>

      <aside class="plannerCol">
        <div class="planner">
          <div class="plannerHead">
            <div>
              <h2>Smart Package Planner</h2>
              <div class="sub">Start ‚Üí End, days, people, preference. Uses /locations lat/lng.</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div style="font-size:12px;color:var(--muted)">Mode</div>
              <div style="font-size:12px;font-weight:900" id="modeText">Auto package</div>
            </div>
          </div>

          <div class="plannerBody">
            <div class="form">
              <div class="full">
                <label>Start (Where to begin)</label>
                <select id="startPlace"><option value="">Loading‚Ä¶</option></select>
              </div>
              <div class="full">
                <label>End (Where to finish)</label>
                <select id="endPlace"><option value="">Loading‚Ä¶</option></select>
              </div>

              <div>
                <label>Days</label>
                <select id="days">
                  <option>1</option><option selected>2</option><option>3</option><option>4</option>
                  <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                </select>
              </div>

              <div>
                <label>People</label>
                <select id="pax">
                  <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
                  <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
                </select>
              </div>

              <div>
                <label>Vehicle (Auto/Manual)</label>
                <select id="vehicle">
                  <option value="auto" selected>Auto</option>
                  <option value="bike">Bike</option>
                  <option value="car">Car</option>
                  <option value="suv">SUV</option>
                  <option value="tempo">Tempo Traveller</option>
                </select>
              </div>

              <div>
                <label>Auto-generate best package?</label>
                <select id="autoGen">
                  <option value="yes" selected>Yes</option>
                  <option value="no">No (I will click Generate)</option>
                </select>
              </div>

              <div class="full">
                <label>Preference</label>
                <select id="preference">
                  <option value="balanced" selected>Balanced</option>
                  <option value="temples">Temples / Culture</option>
                  <option value="treks">Treks / Adventure</option>
                  <option value="lakes">Lakes / Nature</option>
                  <option value="relax">Relax / Scenic</option>
                </select>
              </div>

              <div class="full">
                <label>Search keyword (optional)</label>
                <input id="kw" placeholder="e.g., Shimla, temple, trek, lake‚Ä¶"/>
              </div>
            </div>

            <div class="btnRow">
              <button id="btnGenerate" type="button">Generate Packages</button>
              <button class="secondary" id="btnReset" type="button">Reset</button>
            </div>

            <div class="kpis">
              <div class="kpi"><div class="t">Suggested vehicle</div><div class="v" id="kVeh">‚Äî</div></div>
              <div class="kpi"><div class="t">Estimated range</div><div class="v" id="kCost">‚Äî</div></div>
              <div class="kpi"><div class="t">Places in plan</div><div class="v" id="kPlaces">‚Äî</div></div>
              <div class="kpi"><div class="t">Route corridor</div><div class="v" id="kCorridor">‚Äî</div></div>
            </div>

            <div class="hr"></div>
            <div class="mutedSmall" id="breakdown">Cost breakdown will appear here.</div>

            <div class="hr"></div>
            <div class="btnRow">
              <button class="ghost" id="btnUseBest" type="button">Use Best Package ‚Üí Explore Map</button>
              <button class="ghost" id="btnAskAIFromBest" type="button">Ask AI to refine Best Package</button>
            </div>
          </div>
        </div>

        <div class="results">
          <div class="resultsHead">
            <b>Recommended Packages</b>
            <span style="font-size:12px;color:var(--muted)" id="pkgCount">0</span>
          </div>
          <div class="resultsBody" id="pkgList">
            <div class="mutedSmall">Generate to see route-friendly packages.</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- ===== AI TAB ===== -->
    <div class="layout hidden" id="tabAI">
      <section class="hero">
        <div class="heroBg"></div>
        <div class="heroBgImg" id="aiBgImg"></div>

        <div class="heroInner">
          <div class="heroTag">
            <span style="width:8px;height:8px;border-radius:999px;background:var(--brand)"></span>
            <span>AI Master Planner (on-device logic)</span>
          </div>
          <h2 class="heroTitle">Ask the <span>AI Trip Expert</span> ‚Äî it recommends packages + explains why</h2>
          <p class="heroDesc">
            This AI module works without any external API. It reads your Firebase data, understands your inputs,
            and generates a master plan with 3 package options + day-wise schedule.
          </p>

          <div class="aiBox">
            <div class="aiHead">
              <b>AI Chat</b>
              <span class="mutedSmall" id="aiStatus">Ready</span>
            </div>
            <div class="aiBody">
              <div class="aiMsg" id="aiOut">
                Hi üëã Tell me: Start, End, Days, People, interest (temples/treks/lakes/relax) and budget range.
                <small>Example: ‚ÄúStart Shimla, end Manali, 4 days, 2 people, relax + nature, budget 25k.‚Äù</small>
              </div>
              <div class="aiRow">
                <textarea id="aiIn" placeholder="Type your request..."></textarea>
                <button class="aiBtn" id="aiSend" type="button">Generate Plan</button>
              </div>
              <div class="btnRow">
                <button class="ghost" id="aiUsePlanner" type="button">Apply to Planner (Start/End/Days/Pax)</button>
                <button class="secondary" id="aiClear" type="button">Clear</button>
              </div>
            </div>
          </div>

        </div>
      </section>

      <aside class="plannerCol">
        <div class="planner">
          <div class="plannerHead">
            <div>
              <h2>AI Summary</h2>
              <div class="sub">Key decisions + constraints (distance, season, tempo feasibility)</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div style="font-size:12px;color:var(--muted)">Confidence</div>
              <div style="font-size:12px;font-weight:900" id="aiConf">‚Äî</div>
            </div>
          </div>
          <div class="plannerBody">
            <div class="mutedSmall" id="aiSummary">No plan yet.</div>
            <div class="hr"></div>
            <div class="mutedSmall" id="aiPackages">‚Äî</div>
          </div>
        </div>

        <div class="results">
          <div class="resultsHead"><b>AI Suggested Places</b><span class="mutedSmall" id="aiPlaceCount">0</span></div>
          <div class="resultsBody" id="aiPlaceList">
            <div class="mutedSmall">Generate a plan to see suggested places here.</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- ===== EXPLORE TAB (SEGMENTS FIRST) ===== -->
    <section class="below" id="tabExplore">
      <div class="belowHead">
        <div class="title">
          <b>Explore (Segments first)</b>
          <span>Main screen shows ONLY <b>Segment Types</b>. Click a segment to view places under it.</span>
        </div>
        <div class="mutedSmall" id="exploreBreadcrumb">Showing: <b>All Segments</b></div>
      </div>

      <div class="belowBody">
        <div class="split">
          <!-- Left: segments OR places -->
          <div class="panel">
            <div class="panelHead">
              <b id="leftTitle">Segment Types</b>
              <span class="mutedSmall">Showing <b id="showCount">0</b></span>
            </div>

            <div class="panelBody">
              <!-- SEGMENTS MODE -->
              <div id="segmentsMode">
                <div class="filters">
                  <div class="full">
                    <label>Search Segment</label>
                    <input id="qSeg" placeholder="e.g., Destination, Temple, Trek, Lake‚Ä¶"/>
                  </div>
                  <div class="full btnRow">
                    <button class="ghost" id="btnClearSegSearch" type="button">Clear</button>
                  </div>
                </div>
                <div class="hr"></div>
                <div class="grid" id="segGrid"></div>
              </div>

              <!-- PLACES MODE -->
              <div id="placesMode" class="hidden">
                <div class="filters">
                  <div class="full">
                    <label>Search inside this segment</label>
                    <input id="qPlace" placeholder="Search name, district, type, details‚Ä¶"/>
                  </div>
                  <div>
                    <label>District</label>
                    <select id="fDistrict"><option value="">All</option></select>
                  </div>
                  <div>
                    <label>Location Type</label>
                    <select id="fType"><option value="">All</option></select>
                  </div>
                  <div class="full btnRow">
                    <button class="ghost" id="btnBackToSeg" type="button">‚Üê Back to Segments</button>
                    <button class="ghost" id="btnFitAll" type="button">Fit Map to Results</button>
                    <button class="ghost" id="btnSendToPlanner" type="button">Use Selected as Start/End</button>
                  </div>
                </div>
                <div class="hr"></div>
                <div class="grid" id="placeGrid"></div>
                <div class="mutedSmall" style="margin-top:10px">
                  Tip: Open a place ‚Üí Set as Start / End (for package planner).
                </div>
              </div>
            </div>
          </div>

          <!-- Right: map -->
          <div class="panel">
            <div class="panelHead">
              <b>Map</b>
              <span class="mutedSmall">Markers update for current view</span>
            </div>
            <div class="panelBody">
              <div id="map"></div>
              <div class="mapHint">
                ‚úÖ Images are also used in backgrounds (Hero). Click a marker / card for full details.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- ===== MODAL ===== -->
  <div class="modal" id="modal">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Place details">
      <div class="modalTop">
        <b id="mTitle">Place</b>
        <button class="closeBtn" id="mClose" type="button">Close</button>
      </div>
      <div class="modalBody">
        <div class="modalImg" id="mImgWrap"></div>

        <div style="display:grid; gap:10px;">
          <div class="modalBlock">
            <div class="h">Overview</div>
            <div class="v" id="mAbout">‚Äî</div>
          </div>

          <div class="modalBlock">
            <div class="h">Details (new column)</div>
            <div class="v" id="mDetails">‚Äî</div>
          </div>

          <div class="modalBlock">
            <div class="h">How to Reach</div>
            <div class="v" id="mReach">‚Äî</div>
          </div>

          <div class="modalBlock">
            <div class="h">Best Time / Key Features</div>
            <div class="v" id="mExtra">‚Äî</div>
          </div>

          <div class="modalActions">
            <button id="mSetStart" type="button">Set as Start</button>
            <button class="ghost" id="mSetEnd" type="button">Set as End</button>
          </div>

          <div class="mutedSmall" id="mMeta">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ===========================
       ‚úÖ YOUR FIREBASE CONFIG
       (converted to compat object)
    =========================== */
    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.appspot.com",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    /* ===========================
       QUOTES
    =========================== */
    const QUOTES = [
      { q: "In Himachal, every road is a story ‚Äî written in pine, snow, and sunlight.", by: "Himachal Explorer" },
      { q: "Take fewer places, take them deeper ‚Äî that‚Äôs the real plan.", by: "Himachal Explorer" },
      { q: "The best itinerary is the one that leaves you time to breathe.", by: "Himachal Explorer" },
      { q: "Temples on ridges, lakes in silence ‚Äî calm without words.", by: "Himachal Explorer" },
      { q: "Adventure here isn‚Äôt just speed ‚Äî it‚Äôs altitude and wonder.", by: "Himachal Explorer" },
      { q: "Your best trip is the one that stays realistic on the ground.", by: "Himachal Explorer" }
    ];
    let quoteIndex = 0;

    /* ===========================
       HELPERS
    =========================== */
    const $ = (id)=>document.getElementById(id);
    const dbDot = $("dbDot"), dbText = $("dbText"), loadedCount = $("loadedCount");
    const toast = $("toast");

    let ALL = [];
    let MAP = null;
    let MARKERS_LAYER = null;

    // Explore state
    let CURRENT_SEG = "";
    let SEG_LIST = [];       // {seg, count}
    let SEG_PLACES = [];
    let VIEW_PLACES = [];
    let SELECTED_KEYS = [];  // allow picking 2 places quickly

    // Packages state
    let LAST_PACKAGES = [];
    let LAST_BEST = null;

    // AI state
    let AI_LAST = null;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>toast.classList.remove("show"), 2200);
    }
    function setDbStatus(ok, msg){
      dbDot.classList.remove("ok","bad");
      dbDot.classList.add(ok ? "ok" : "bad");
      dbText.textContent = msg;
    }
    function safeStr(v){ return (v===undefined||v===null) ? "" : String(v); }
    function escapeHtml(s){
      return safeStr(s).replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      })[c]);
    }
    function toNum(v){
      const n = parseFloat(String(v||"").replace(/[^\d.\-]/g,""));
      return Number.isFinite(n) ? n : null;
    }
    function pickPhoto(p){
      return p["photo 1"] || p["Photo 1"] || p["photo1"] || p["Image"] || p["image"] || "";
    }

    /* ===========================
       ‚úÖ Normalize + NO "Other bucket"
       If segment missing => make it "Destination" (better than Other)
    =========================== */
    function normalizeRecord(key, raw){
      const p = raw || {};
      const seg =
        safeStr(p["Segment Type"] || p["segment type"] || p["segment"] || "").trim() ||
        "Destination";
      const type =
        safeStr(p["Location Type"] || p["location type"] || p["type"] || "").trim() ||
        "Point of Interest";

      return {
        key,
        name: safeStr(p["Location Name"] || p["name"] || p["Name"] || key),
        district: safeStr(p["District"] || p["district"] || ""),
        segment: seg,
        type: type,
        short: safeStr(p["Short Description"] || p["short description"] || ""),
        overview: safeStr(p["Overview"] || p["overview"] || ""),
        reach: safeStr(p["How to Reach"] || p["how to reach"] || ""),
        bestTime: safeStr(p["Best Time to Visit"] || p["best time to visit"] || ""),
        keyFeatures: safeStr(p["Key Features"] || p["key features"] || ""),
        details: safeStr(p["Details"] || p["details"] || p["Place Details"] || p["place_details"] || ""),
        lat: toNum(p["Latitude"] ?? p["latitude"]),
        lng: toNum(p["Longitude"] ?? p["longitude"]),
        photo: safeStr(pickPhoto(p))
      };
    }

    function uniq(arr){ return Array.from(new Set(arr.filter(Boolean))); }
    function byAZ(a,b){ return (a||"").localeCompare(b||""); }
    function getPlaceByKey(key){ return ALL.find(p=>p.key===key) || null; }

    /* ===========================
       Tabs
    =========================== */
    function activateTab(tabId){
      ["tabExplore","tabPackages","tabAI"].forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.classList.toggle("hidden", id !== tabId);
      });
      document.querySelectorAll(".tabBtn").forEach(b=>{
        b.classList.toggle("active", b.getAttribute("data-tab") === tabId);
      });
      if(tabId === "tabExplore" && MAP){
        setTimeout(()=>MAP.invalidateSize(), 80);
      }
    }

    /* ===========================
       Quotes
    =========================== */
    function renderQuotes(){
      const grid = $("quoteGrid");
      if(!grid) return;
      grid.innerHTML = "";
      for(let i=0;i<3;i++){
        const idx = (quoteIndex + i) % QUOTES.length;
        const qc = document.createElement("div");
        qc.className = "quoteCard fade";
        qc.innerHTML = `
          <p class="quoteTxt">‚Äú${escapeHtml(QUOTES[idx].q)}‚Äù</p>
          <div class="quoteBy">‚Äî ${escapeHtml(QUOTES[idx].by)}</div>
        `;
        grid.appendChild(qc);
      }
      quoteIndex = (quoteIndex + 1) % QUOTES.length;
    }
    setInterval(renderQuotes, 5000);

    /* ===========================
       Map
    =========================== */
    function initMap(){
      MAP = L.map("map", { zoomControl: true });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(MAP);

      MARKERS_LAYER = L.layerGroup().addTo(MAP);
      MAP.setView([31.6, 77.2], 8);
    }

    function renderMarkers(list){
      if(!MAP || !MARKERS_LAYER) return;
      MARKERS_LAYER.clearLayers();
      const pts = [];
      list.forEach(p=>{
        if(p.lat==null || p.lng==null) return;
        pts.push([p.lat, p.lng]);
        const m = L.marker([p.lat, p.lng]).addTo(MARKERS_LAYER);
        m.bindPopup(`<b>${escapeHtml(p.name)}</b><br/><span style="color:#333">${escapeHtml(p.district||"")}</span>`);
        m.on("click", ()=>openPlaceModal(p.key));
      });
      if(pts.length){
        const b = L.latLngBounds(pts);
        MAP.fitBounds(b, {padding:[22,22]});
      }
    }

    /* ===========================
       Background images (hero)
       - pick random photos from ALL
    =========================== */
    function refreshHeroBackground(){
      const photos = ALL.filter(p=>p.photo).map(p=>p.photo);
      if(!photos.length) return;

      const pick = ()=>photos[Math.floor(Math.random()*photos.length)];
      const p1 = pick();
      $("heroBgImg").style.backgroundImage = `url("${p1}")`;

      const p2 = pick();
      $("aiBgImg").style.backgroundImage = `url("${p2}")`;
    }
    setInterval(()=>{ if(ALL.length) refreshHeroBackground(); }, 8000);

    /* ===========================
       EXPLORE: SEGMENTS FIRST
       (Main screen shows ONLY Segment Types)
    =========================== */
    function buildSegmentList(){
      const groups = new Map();
      for(const p of ALL){
        const s = (p.segment || "Destination").trim() || "Destination";
        if(!groups.has(s)) groups.set(s, {seg:s, count:0});
        groups.get(s).count++;
      }
      SEG_LIST = Array.from(groups.values()).sort((a,b)=>b.count - a.count);
    }

    function showSegmentsScreen(){
      CURRENT_SEG = "";
      SELECTED_KEYS = [];
      $("exploreBreadcrumb").innerHTML = `Showing: <b>All Segments</b>`;
      $("leftTitle").textContent = "Segment Types";
      $("segmentsMode").classList.remove("hidden");
      $("placesMode").classList.add("hidden");

      const q = ($("qSeg").value||"").trim().toLowerCase();
      const list = q ? SEG_LIST.filter(x=>x.seg.toLowerCase().includes(q)) : SEG_LIST;

      $("showCount").textContent = String(list.length);
      const grid = $("segGrid");
      grid.innerHTML = "";

      if(!list.length){
        grid.innerHTML = `<div class="mutedSmall">No segments found.</div>`;
        renderMarkers([]);
        return;
      }

      list.forEach(item=>{
        const div = document.createElement("div");
        div.className = "segCard";
        div.innerHTML = `
          <b>${escapeHtml(item.seg)}</b>
          <div class="sub">Click to explore places under this segment.</div>
          <div class="count">
            <span class="pillTiny">${item.count} places</span>
            <span class="pillTiny">Click ‚Üí</span>
          </div>
        `;
        div.addEventListener("click", ()=>openSegment(item.seg));
        grid.appendChild(div);
      });

      // IMPORTANT: do not show all markers together
      renderMarkers([]);
    }

    function fillFilterSelect(sel, values){
      const prev = sel.value;
      sel.innerHTML = `<option value="">All</option>`;
      values.forEach(v=>{
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      });
      if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }

    function openSegment(segName){
      CURRENT_SEG = segName;
      SELECTED_KEYS = [];
      $("exploreBreadcrumb").innerHTML = `Showing: <b>${escapeHtml(segName)}</b>`;
      $("leftTitle").textContent = `Places ‚Äî ${segName}`;
      $("segmentsMode").classList.add("hidden");
      $("placesMode").classList.remove("hidden");

      SEG_PLACES = ALL.filter(p => (p.segment || "Destination") === segName);

      fillFilterSelect($("fDistrict"), uniq(SEG_PLACES.map(x=>x.district)).sort(byAZ));
      fillFilterSelect($("fType"), uniq(SEG_PLACES.map(x=>x.type)).sort(byAZ));

      $("qPlace").value = "";
      $("fDistrict").value = "";
      $("fType").value = "";

      applyPlaceFilters();
      showToast(`Segment opened: ${segName}`);
    }

    function applyPlaceFilters(){
      const q = ($("qPlace").value||"").trim().toLowerCase();
      const d = $("fDistrict").value;
      const t = $("fType").value;

      VIEW_PLACES = SEG_PLACES.filter(p=>{
        if(d && p.district !== d) return false;
        if(t && p.type !== t) return false;
        if(q){
          const hay = `${p.name} ${p.district} ${p.segment} ${p.type} ${p.short} ${p.overview} ${p.details} ${p.keyFeatures}`.toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      $("showCount").textContent = String(VIEW_PLACES.length);
      renderPlaceCards(VIEW_PLACES);
      renderMarkers(VIEW_PLACES);
    }

    function renderPlaceCards(list){
      const grid = $("placeGrid");
      grid.innerHTML = "";
      if(!list.length){
        grid.innerHTML = `<div class="mutedSmall">No places found. Clear filters.</div>`;
        return;
      }

      list.slice(0,60).forEach(p=>{
        const c = document.createElement("div");
        c.className = "card";
        const tag = escapeHtml(p.type || "Point of Interest");
        const img = p.photo ? `<img src="${escapeHtml(p.photo)}" alt="${escapeHtml(p.name)}" onerror="this.remove();"/>` : "";
        const preview = (p.details || p.short || p.overview || "").slice(0, 92);

        const isSel = SELECTED_KEYS.includes(p.key);
        c.style.outline = isSel ? "2px solid rgba(45,226,196,.55)" : "none";

        c.innerHTML = `
          <div class="thumb">
            ${img}
            <div class="tag">${tag}</div>
          </div>
          <div class="cardBody">
            <b>${escapeHtml(p.name)}</b>
            <div class="sub">${escapeHtml(p.district || "‚Äî")} ‚Ä¢ ${escapeHtml(p.segment || "Destination")}</div>
            <div class="sub" style="margin-top:8px;color:rgba(255,255,255,.78)">${escapeHtml(preview)}${preview.length>=92?"‚Ä¶":""}</div>
            <div class="row">
              <span class="mini">${escapeHtml(p.bestTime || "Year-round")}</span>
              <span class="mini">${p.lat!=null && p.lng!=null ? "Map ‚úì" : "No coords"}</span>
              <span class="mini">${isSel ? "Selected ‚úì" : "Tap to select"}</span>
            </div>
          </div>
        `;

        // Tap card => select up to 2 (start/end quick)
        c.addEventListener("click", (e)=>{
          // If long press / want modal: double click opens modal
          if(e.detail === 2){
            openPlaceModal(p.key);
            return;
          }
          toggleSelect(p.key);
        });

        // Right click / longpress not reliable on mobile; add context: hold to open modal via marker or double tap
        grid.appendChild(c);
      });

      if(list.length > 60){
        const more = document.createElement("div");
        more.className = "mutedSmall";
        more.textContent = `Showing 60 of ${list.length}. Use filters to narrow.`;
        grid.appendChild(more);
      }
    }

    function toggleSelect(key){
      const idx = SELECTED_KEYS.indexOf(key);
      if(idx >= 0){
        SELECTED_KEYS.splice(idx,1);
      } else {
        if(SELECTED_KEYS.length >= 2) SELECTED_KEYS.shift();
        SELECTED_KEYS.push(key);
      }
      renderPlaceCards(VIEW_PLACES);
      showToast(SELECTED_KEYS.length === 1 ? "Selected 1 place" : "Selected 2 places");
    }

    /* ===========================
       Modal
    =========================== */
    let MODAL_PLACE_KEY = null;
    function openPlaceModal(key){
      const p = getPlaceByKey(key);
      if(!p) return;
      MODAL_PLACE_KEY = key;

      $("mTitle").textContent = p.name || "Place";
      $("mAbout").textContent = p.overview || p.short || "‚Äî";
      $("mDetails").textContent = p.details || "‚Äî";
      $("mReach").textContent = p.reach || "‚Äî";
      $("mExtra").innerHTML = `
        <b>Best time:</b> ${escapeHtml(p.bestTime || "‚Äî")}<br/>
        <b>Key features:</b> ${escapeHtml(p.keyFeatures || "‚Äî")}
      `;

      const img = p.photo
        ? `<img src="${escapeHtml(p.photo)}" alt="${escapeHtml(p.name)}" onerror="this.parentNode.innerHTML='<div style=&quot;padding:10px;color:rgba(255,255,255,.7);font-size:12px&quot;>Image not available</div>'"/><div class="overlay"></div>`
        : `<div style="padding:10px;color:rgba(255,255,255,.7);font-size:12px">No photo provided</div>`;
      $("mImgWrap").innerHTML = img;

      const meta = [
        p.district ? `District: <b>${escapeHtml(p.district)}</b>` : "",
        p.segment ? `Segment: <b>${escapeHtml(p.segment)}</b>` : "",
        p.type ? `Type: <b>${escapeHtml(p.type)}</b>` : "",
        (p.lat!=null && p.lng!=null) ? `Coords: <b>${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</b>` : "Coords: <b>missing</b>"
      ].filter(Boolean).join(" ‚Ä¢ ");
      $("mMeta").innerHTML = meta || "‚Äî";

      $("modal").classList.add("show");
    }
    function closeModal(){ $("modal").classList.remove("show"); MODAL_PLACE_KEY=null; }

    /* ===========================
       PLANNER + PACKAGES
    =========================== */
    function haversineKm(a,b){
      const R=6371;
      const toRad = (x)=>x*Math.PI/180;
      const dLat = toRad(b.lat-a.lat);
      const dLng = toRad(b.lng-a.lng);
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const q = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(q)));
    }
    function distPointToSegmentKm(P,A,B){
      const meanLat = ((A.lat + B.lat)/2) * Math.PI/180;
      const kx = 111.320 * Math.cos(meanLat);
      const ky = 110.574;

      const ax = A.lng*kx, ay = A.lat*ky;
      const bx = B.lng*kx, by = B.lat*ky;
      const px = P.lng*kx, py = P.lat*ky;

      const ABx = bx-ax, ABy = by-ay;
      const APx = px-ax, APy = py-ay;
      const ab2 = ABx*ABx + ABy*ABy || 1e-9;
      let t = (APx*ABx + APy*ABy)/ab2;
      t = Math.max(0, Math.min(1, t));
      const cx = ax + t*ABx, cy = ay + t*ABy;
      const dx = px - cx, dy = py - cy;
      return Math.sqrt(dx*dx + dy*dy);
    }
    function suggestVehicle(pax, chosen){
      if(chosen && chosen !== "auto") return chosen;
      if(pax <= 2) return "bike";
      if(pax <= 4) return "car";
      if(pax <= 6) return "suv";
      return "tempo";
    }
    function vehicleLabel(v){
      return ({auto:"Auto", bike:"Bike", car:"Car", suv:"SUV", tempo:"Tempo Traveller"})[v] || v;
    }
    function formatINR(n){
      try{
        return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(n);
      }catch(e){ return "‚Çπ" + Math.round(n); }
    }
    function estimateCost({days, pax, vehicle, driveKm}){
      const vehicleBasePerDay = { bike:1200, car:3200, suv:4500, tempo:7500 };
      const fuelPerKm         = { bike:3.0,  car:6.5,  suv:8.5,  tempo:12.0 };
      const driverPerDay = { bike:0, car:900, suv:950, tempo:1100 };
      const driverNightAllowance = { bike:0, car:350, suv:400, tempo:450 };
      const stayPerPersonPerNight = 950;
      const foodPerPersonPerDay   = 550;

      const nights = Math.max(0, days-1);
      const vDay = vehicleBasePerDay[vehicle] ?? 3500;
      const fuel = (fuelPerKm[vehicle] ?? 7.0) * Math.max(20, driveKm);

      const transport = vDay * days + fuel;
      const stay = pax * stayPerPersonPerNight * nights;
      const food = pax * foodPerPersonPerDay * days;
      const driver = (driverPerDay[vehicle] ?? 900) * days + (driverNightAllowance[vehicle] ?? 350) * nights;

      const subtotal = transport + stay + food + driver;
      return { transport, stay, food, driver, low: Math.round(subtotal*0.88), high: Math.round(subtotal*1.12) };
    }

    function scorePlace(p, pref){
      const seg = (p.segment||"").toLowerCase();
      const type = (p.type||"").toLowerCase();
      let s = 0;
      const temple = seg.includes("temple") || type.includes("temple");
      const trek   = seg.includes("trek")   || type.includes("trek") || seg.includes("adventure");
      const lake   = seg.includes("lake")   || type.includes("lake");
      const relax  = seg.includes("destination") || seg.includes("scenic") || type.includes("view");

      if(pref === "temples") s += temple ? 22 : 0;
      if(pref === "treks")   s += trek ? 22 : 0;
      if(pref === "lakes")   s += lake ? 22 : 0;
      if(pref === "relax")   s += relax ? 18 : 0;

      if(pref === "balanced"){
        if(temple) s += 6;
        if(trek)   s += 6;
        if(lake)   s += 6;
        if(relax)  s += 5;
      }

      if(p.details) s += 2;
      if(p.photo) s += 2;
      if(p.short) s += 2;
      if(p.overview) s += 1;
      if(p.reach) s += 1;
      return s;
    }

    function buildPackages({start, end, days, pax, vehicle, pref, keyword}){
      const corridorKm = Math.min(85, Math.max(18, 18 + (days-1)*12));
      $("kCorridor").textContent = `¬±${Math.round(corridorKm)} km`;

      const kw = (keyword||"").trim().toLowerCase();
      const inKw = (p)=>{
        if(!kw) return true;
        const hay = `${p.name} ${p.district} ${p.segment} ${p.type} ${p.short} ${p.overview} ${p.details} ${p.keyFeatures}`.toLowerCase();
        return hay.includes(kw);
      };

      let pool = ALL.filter(p=>{
        if(p.lat==null || p.lng==null) return false;
        if(!inKw(p)) return false;
        const d = distPointToSegmentKm({lat:p.lat,lng:p.lng}, start, end);
        return d <= corridorKm;
      });

      if(pool.length < 6){
        const wider = corridorKm + 25;
        pool = ALL.filter(p=>{
          if(p.lat==null || p.lng==null) return false;
          if(!inKw(p)) return false;
          const d = distPointToSegmentKm({lat:p.lat,lng:p.lng}, start, end);
          return d <= wider;
        });
      }

      const scored = pool.map(p=>{
        const dLine = distPointToSegmentKm({lat:p.lat,lng:p.lng}, start, end);
        const score = scorePlace(p, pref) - (dLine * 0.35);
        return {p, score, dLine};
      }).sort((a,b)=>b.score - a.score);

      const maxN = Math.min(10, Math.max(4, 3 + days));

      function pickSet(mode){
        const picked = [];
        const used = new Set();
        const usedSeg = new Set();
        const usedType = new Set();

        for(const item of scored){
          if(picked.length >= maxN) break;
          const p = item.p;
          if(used.has(p.key)) continue;

          if(mode === "compact"){
            if(item.dLine > (corridorKm * 0.75)) continue;
          }
          if(mode === "scenic"){
            const seg = (p.segment || "Destination");
            if(usedSeg.size < 4 && usedSeg.has(seg)) continue;
            const t = (p.type || "Point of Interest");
            if(usedType.size < 4 && usedType.has(t)) continue;
          }

          picked.push(p);
          used.add(p.key);
          usedSeg.add(p.segment || "Destination");
          usedType.add(p.type || "Point of Interest");
        }

        if(picked.length < Math.min(4, maxN)){
          for(const item of scored){
            if(picked.length >= maxN) break;
            if(used.has(item.p.key)) continue;
            picked.push(item.p);
            used.add(item.p.key);
          }
        }
        return picked;
      }

      const bestValue = pickSet("best");
      const scenic    = pickSet("scenic");
      const compact   = pickSet("compact");

      function estimateDriveKm(places){
        const pts = places.filter(x=>x.lat!=null && x.lng!=null).map(x=>({lat:x.lat,lng:x.lng}));
        if(!pts.length) return haversineKm(start, end) * 1.25;
        let max = 0;
        for(const pt of pts){
          max = Math.max(max, haversineKm(start, pt), haversineKm(end, pt));
        }
        return (haversineKm(start, end) * 1.35) + (max * 0.9);
      }

      function makePkg(title, places){
        const driveKm = Math.max(35, estimateDriveKm(places));
        const cost = estimateCost({days, pax, vehicle, driveKm});
        return { title, places, driveKm, cost, hint: `${places.length} places ‚Ä¢ ~${Math.round(driveKm)} km driving` };
      }

      return [
        makePkg("Best Value (recommended)", bestValue),
        makePkg("Scenic & Variety", scenic),
        makePkg("Compact & Efficient", compact)
      ].filter(x=>x.places.length >= 3);
    }

    function renderPackageList(pkgs){
      const list = $("pkgList");
      list.innerHTML = "";
      $("pkgCount").textContent = String(pkgs.length);
      LAST_PACKAGES = pkgs;
      LAST_BEST = pkgs[0] || null;

      if(!pkgs.length){
        list.innerHTML = `<div class="mutedSmall">Not enough places found on that corridor. Try different start/end or increase days.</div>`;
        return;
      }

      const best = pkgs[0];
      $("kPlaces").textContent = best.places.length;
      $("kCost").textContent = `${formatINR(best.cost.low)} ‚Äì ${formatINR(best.cost.high)}`;
      $("breakdown").innerHTML = `
        <div class="mutedSmall">
          <b>Cost breakdown (Best Value):</b><br/>
          ‚Ä¢ Transport: <b>${formatINR(best.cost.transport)}</b><br/>
          ‚Ä¢ Stay: <b>${formatINR(best.cost.stay)}</b><br/>
          ‚Ä¢ Food: <b>${formatINR(best.cost.food)}</b><br/>
          ‚Ä¢ Driver: <b>${formatINR(best.cost.driver)}</b><br/>
          <span style="color:rgba(255,255,255,.55)">Range includes ¬±12% (season/traffic/tolls).</span>
        </div>
      `;

      pkgs.forEach((pkg, idx)=>{
        const div = document.createElement("div");
        div.className = "pkg";
        div.innerHTML = `
          <div class="pkgTop">
            <div>
              <h3>${escapeHtml(pkg.title)}</h3>
              <div class="meta">${escapeHtml(pkg.hint)}</div>
            </div>
            <div class="price">${formatINR(pkg.cost.low)} ‚Äì ${formatINR(pkg.cost.high)}</div>
          </div>
          <div class="chips">
            ${pkg.places.slice(0,10).map((p,i)=>`
              <span class="chip ${i%3===1?'chip2':(i%3===2?'chip3':'')}">${escapeHtml(p.name)}</span>
            `).join("")}
          </div>
          <div class="mutedSmall" style="margin-top:8px">
            Segments: ${escapeHtml(uniq(pkg.places.map(x=>x.segment)).slice(0,4).join(", "))}
          </div>
          <div class="btnRow" style="margin-top:10px">
            <button class="ghost" type="button" data-use-pkg="${idx}">Use this package ‚Üí Explore</button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("[data-use-pkg]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i = parseInt(btn.getAttribute("data-use-pkg"),10);
          const pkg = LAST_PACKAGES[i];
          if(!pkg) return;
          activateTab("tabExplore");
          renderMarkers(pkg.places);
          showToast("Package shown on map");
        });
      });
    }

    function fillPlaceSelect(sel, places){
      const prev = sel.value;
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select a place‚Ä¶";
      sel.appendChild(opt0);

      places.slice().sort((a,b)=>(a.district+a.name).localeCompare(b.district+b.name)).forEach(p=>{
        const o = document.createElement("option");
        o.value = p.key;
        o.textContent = `${p.name}${p.district ? " ‚Äî "+p.district : ""}`;
        sel.appendChild(o);
      });

      if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }

    function runPlanner(){
      const sKey = $("startPlace").value;
      const eKey = $("endPlace").value;
      const days = parseInt($("days").value,10);
      const pax  = parseInt($("pax").value,10);
      const chosenVehicle = $("vehicle").value;
      const pref = $("preference").value;
      const keyword = $("kw").value;

      if(!sKey || !eKey){
        $("pkgList").innerHTML = `<div class="mutedSmall">Please select both <b>Start</b> and <b>End</b>.</div>`;
        $("pkgCount").textContent = "0";
        return;
      }

      const s = getPlaceByKey(sKey);
      const e = getPlaceByKey(eKey);
      if(!s || !e || s.lat==null || s.lng==null || e.lat==null || e.lng==null){
        $("pkgList").innerHTML = `<div class="mutedSmall">Start/End must have Latitude & Longitude in Firebase.</div>`;
        $("pkgCount").textContent = "0";
        return;
      }

      const vehicle = suggestVehicle(pax, chosenVehicle);
      $("kVeh").textContent = vehicleLabel(vehicle);

      const pkgs = buildPackages({
        start:{lat:s.lat,lng:s.lng},
        end:{lat:e.lat,lng:e.lng},
        days, pax, vehicle, pref, keyword
      });

      renderPackageList(pkgs);
    }

    function resetPlanner(){
      $("startPlace").value = "";
      $("endPlace").value = "";
      $("days").value = "2";
      $("pax").value = "2";
      $("vehicle").value = "auto";
      $("autoGen").value = "yes";
      $("preference").value = "balanced";
      $("kw").value = "";
      $("modeText").textContent = "Auto package";
      $("kVeh").textContent = "‚Äî";
      $("kCost").textContent = "‚Äî";
      $("kPlaces").textContent = "‚Äî";
      $("kCorridor").textContent = "‚Äî";
      $("breakdown").textContent = "Cost breakdown will appear here.";
      $("pkgCount").textContent = "0";
      $("pkgList").innerHTML = `<div class="mutedSmall">Generate to see route-friendly packages.</div>`;
      LAST_PACKAGES = [];
      LAST_BEST = null;
    }

    function setModeText(){
      const auto = $("autoGen").value === "yes";
      $("modeText").textContent = auto ? "Auto package" : "Manual generate";
    }

    function maybeAutoRun(){
      if($("autoGen").value !== "yes") return;
      if($("startPlace").value && $("endPlace").value) runPlanner();
    }

    function attachAutoHandlers(){
      const ids = ["startPlace","endPlace","days","pax","vehicle","preference","kw"];
      for(const id of ids){
        const el = $(id);
        const clone = el.cloneNode(true);
        el.parentNode.replaceChild(clone, el);
      }

      $("btnGenerate").onclick = runPlanner;
      $("btnReset").onclick = resetPlanner;

      $("autoGen").onchange = ()=>{ setModeText(); attachAutoHandlers(); if($("autoGen").value==="yes") maybeAutoRun(); };

      if($("autoGen").value === "yes"){
        ["change","input"].forEach(evt=>{
          $("startPlace").addEventListener(evt, maybeAutoRun);
          $("endPlace").addEventListener(evt, maybeAutoRun);
          $("days").addEventListener(evt, maybeAutoRun);
          $("pax").addEventListener(evt, maybeAutoRun);
          $("vehicle").addEventListener(evt, maybeAutoRun);
          $("preference").addEventListener(evt, maybeAutoRun);
          $("kw").addEventListener(evt, ()=>{
            clearTimeout(window.__kwT);
            window.__kwT = setTimeout(maybeAutoRun, 350);
          });
        });
      }
    }

    /* ===========================
       AI MASTER PLANNER (no API)
       - Parses user text
       - Creates 3 package options using same corridor logic
       - Outputs day-wise rough schedule
    =========================== */
    function parseAI(text){
      const t = (text||"").toLowerCase();
      const pref =
        t.includes("temple") ? "temples" :
        (t.includes("trek") || t.includes("adventure")) ? "treks" :
        t.includes("lake") ? "lakes" :
        (t.includes("relax") || t.includes("scenic")) ? "relax" :
        "balanced";

      const daysMatch = t.match(/(\d+)\s*day/);
      const paxMatch = t.match(/(\d+)\s*(people|pax|persons|person)/);
      const budgetMatch = t.match(/(\d+)\s*(k|000)/);

      let days = daysMatch ? Math.max(1, Math.min(10, parseInt(daysMatch[1],10))) : 3;
      let pax  = paxMatch ? Math.max(1, Math.min(30, parseInt(paxMatch[1],10))) : 2;

      let budget = null;
      if(budgetMatch){
        const n = parseInt(budgetMatch[1],10);
        budget = budgetMatch[2] === "k" ? n*1000 : n;
      }

      // Try to detect start/end by matching place names
      // (simple fuzzy: checks if name appears in text)
      const names = ALL.map(p=>p.name).filter(Boolean);
      let startKey = null, endKey = null;

      // prefer exact contains
      for(const p of ALL){
        const nm = (p.name||"").toLowerCase();
        if(!nm || nm.length < 4) continue;
        if(t.includes("start "+nm) || t.includes("from "+nm)) startKey = p.key;
        if(t.includes("end "+nm) || t.includes("to "+nm)) endKey = p.key;
      }
      // fallback: first two name hits
      if(!startKey || !endKey){
        const hits = [];
        for(const p of ALL){
          const nm = (p.name||"").toLowerCase();
          if(!nm || nm.length < 4) continue;
          if(t.includes(nm)) hits.push(p.key);
          if(hits.length >= 3) break;
        }
        if(!startKey && hits[0]) startKey = hits[0];
        if(!endKey && hits[1]) endKey = hits[1];
      }

      return {pref, days, pax, budget, startKey, endKey};
    }

    function aiGenerate(text){
      const parsed = parseAI(text);
      const {pref, days, pax, budget} = parsed;

      // choose start/end:
      // if user selected 2 places in Explore, use them
      let startKey = parsed.startKey;
      let endKey = parsed.endKey;

      if(SELECTED_KEYS.length === 2){
        startKey = SELECTED_KEYS[0];
        endKey   = SELECTED_KEYS[1];
      }

      // fallback: use first two usable places
      const usable = ALL.filter(p=>p.lat!=null && p.lng!=null);
      if(!startKey) startKey = usable[0]?.key || null;
      if(!endKey)   endKey   = usable[1]?.key || null;

      const s = getPlaceByKey(startKey);
      const e = getPlaceByKey(endKey);
      if(!s || !e || s.lat==null || s.lng==null || e.lat==null || e.lng==null){
        return { ok:false, msg:"AI needs Start/End with Latitude & Longitude. Select 2 places in Explore, then try again." };
      }

      const vehicle = suggestVehicle(pax, "auto");
      const pkgs = buildPackages({
        start:{lat:s.lat,lng:s.lng},
        end:{lat:e.lat,lng:e.lng},
        days, pax, vehicle, pref,
        keyword: "" // AI master doesn't force keyword unless user typed it; keep open
      });

      if(!pkgs.length){
        return { ok:false, msg:"I couldn't find enough corridor places. Try increasing days or change start/end." };
      }

      // pick best package
      const best = pkgs[0];
      const cost = best.cost;

      // day-wise schedule (simple distribute)
      const perDay = Math.max(1, Math.ceil(best.places.length / days));
      const planDays = [];
      let idx = 0;
      for(let d=1; d<=days; d++){
        const picks = best.places.slice(idx, idx+perDay);
        idx += perDay;
        if(!picks.length) continue;
        planDays.push({day:d, places:picks});
      }

      // confidence heuristic
      const conf = best.places.length >= (2+days) ? "High" : "Medium";

      // budget note
      let budgetNote = "";
      if(budget){
        const mid = Math.round((cost.low + cost.high)/2);
        budgetNote = mid <= budget ? `‚úÖ Budget looks ok (mid ~${formatINR(mid)}).`
                                   : `‚ö†Ô∏è Budget may be short (mid ~${formatINR(mid)}). Try fewer days/places.`;
      }

      return {
        ok:true,
        parsed:{pref, days, pax, vehicle, startKey, endKey, budget},
        pkgs,
        best,
        planDays,
        conf,
        budgetNote
      };
    }

    function renderAI(result){
      if(!result.ok){
        $("aiOut").innerHTML = `${escapeHtml(result.msg)}<small>Tip: In Explore tab, select 2 places (tap cards) to set Start/End quickly.</small>`;
        $("aiConf").textContent = "‚Äî";
        $("aiSummary").textContent = "No plan generated.";
        $("aiPackages").textContent = "‚Äî";
        $("aiPlaceCount").textContent = "0";
        $("aiPlaceList").innerHTML = `<div class="mutedSmall">‚Äî</div>`;
        AI_LAST = null;
        return;
      }

      AI_LAST = result;

      const s = getPlaceByKey(result.parsed.startKey);
      const e = getPlaceByKey(result.parsed.endKey);

      $("aiConf").textContent = result.conf;

      const intro = `
        <b>Master Plan:</b> ${escapeHtml(s?.name||"Start")} ‚Üí ${escapeHtml(e?.name||"End")} ‚Ä¢
        <b>${result.parsed.days} days</b> ‚Ä¢ <b>${result.parsed.pax} people</b> ‚Ä¢
        Preference: <b>${escapeHtml(result.parsed.pref)}</b> ‚Ä¢ Vehicle: <b>${escapeHtml(vehicleLabel(result.parsed.vehicle))}</b><br/>
        Estimated range: <b>${formatINR(result.best.cost.low)} ‚Äì ${formatINR(result.best.cost.high)}</b><br/>
        ${result.budgetNote ? `<span>${escapeHtml(result.budgetNote)}</span><br/>` : ""}
      `;

      const dayWise = result.planDays.map(d=>{
        return `Day ${d.day}: ${d.places.map(p=>p.name).join(" ‚Ä¢ ")}`;
      }).join("<br/>");

      $("aiOut").innerHTML = `${intro}<small>${dayWise}</small>`;

      $("aiSummary").innerHTML = `
        ‚Ä¢ Corridor logic used (near Start‚ÜíEnd).<br/>
        ‚Ä¢ Preference boosts matching segments/types.<br/>
        ‚Ä¢ Avoids far-off places in one package.<br/>
        ‚Ä¢ Uses your new <b>Details</b> field for better relevance.
      `;

      $("aiPackages").innerHTML = result.pkgs.map(p=>{
        return `‚Ä¢ <b>${escapeHtml(p.title)}</b> ‚Äî ${escapeHtml(p.hint)} ‚Äî <b>${formatINR(p.cost.low)}‚Äì${formatINR(p.cost.high)}</b>`;
      }).join("<br/>");

      $("aiPlaceCount").textContent = String(result.best.places.length);

      // render AI places list (chips + click to open modal)
      const box = $("aiPlaceList");
      box.innerHTML = "";
      result.best.places.forEach((p,i)=>{
        const div = document.createElement("div");
        div.className = "pkg";
        div.innerHTML = `
          <div class="pkgTop">
            <div>
              <h3>${escapeHtml(p.name)}</h3>
              <div class="meta">${escapeHtml(p.district||"")} ‚Ä¢ ${escapeHtml(p.segment||"")}</div>
            </div>
            <div class="price">${escapeHtml(p.type||"")}</div>
          </div>
          <div class="mutedSmall" style="margin-top:8px">${escapeHtml((p.details||p.short||p.overview||"").slice(0,160))}${(p.details||"").length>160?"‚Ä¶":""}</div>
          <div class="btnRow" style="margin-top:10px">
            <button class="ghost" type="button" data-open="${escapeHtml(p.key)}">Open</button>
            <button class="ghost" type="button" data-map="${escapeHtml(p.key)}">Map</button>
          </div>
        `;
        div.querySelector("[data-open]").addEventListener("click", ()=>openPlaceModal(p.key));
        div.querySelector("[data-map]").addEventListener("click", ()=>{
          activateTab("tabExplore");
          renderMarkers([p]);
          showToast("Showing on map");
        });
        box.appendChild(div);
      });

      showToast("AI master plan generated");
    }

    /* ===========================
       Events / Boot
    =========================== */
    function boot(){
      // tabs
      document.querySelectorAll(".tabBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>activateTab(btn.getAttribute("data-tab")));
      });

      initMap();
      renderQuotes();

      // modal events
      $("mClose").addEventListener("click", closeModal);
      $("modal").addEventListener("click", (e)=>{ if(e.target === $("modal")) closeModal(); });
      document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

      $("mSetStart").addEventListener("click", ()=>{
        if(!MODAL_PLACE_KEY) return;
        $("startPlace").value = MODAL_PLACE_KEY;
        closeModal();
        showToast("Set as Start");
      });
      $("mSetEnd").addEventListener("click", ()=>{
        if(!MODAL_PLACE_KEY) return;
        $("endPlace").value = MODAL_PLACE_KEY;
        closeModal();
        showToast("Set as End");
      });

      // explore events
      $("btnClearSegSearch").addEventListener("click", ()=>{
        $("qSeg").value = "";
        showSegmentsScreen();
      });
      $("qSeg").addEventListener("input", ()=>{
        clearTimeout(window.__segT);
        window.__segT = setTimeout(showSegmentsScreen, 140);
      });

      $("btnBackToSeg").addEventListener("click", showSegmentsScreen);

      $("qPlace").addEventListener("input", ()=>{
        clearTimeout(window.__placeT);
        window.__placeT = setTimeout(applyPlaceFilters, 160);
      });
      $("fDistrict").addEventListener("change", applyPlaceFilters);
      $("fType").addEventListener("change", applyPlaceFilters);
      $("btnFitAll").addEventListener("click", ()=>renderMarkers(VIEW_PLACES));

      $("btnSendToPlanner").addEventListener("click", ()=>{
        if(SELECTED_KEYS.length !== 2){
          showToast("Select 2 places (Start then End)");
          return;
        }
        $("startPlace").value = SELECTED_KEYS[0];
        $("endPlace").value = SELECTED_KEYS[1];
        activateTab("tabPackages");
        showToast("Start/End applied to Planner");
      });

      // planner events
      $("btnGenerate").addEventListener("click", runPlanner);
      $("btnReset").addEventListener("click", resetPlanner);
      ["change","input"].forEach(evt=>{
        $("autoGen").addEventListener(evt, ()=>{
          setModeText();
          attachAutoHandlers();
          if($("autoGen").value==="yes") maybeAutoRun();
        });
      });
      setModeText();
      resetPlanner();

      $("btnUseBest").addEventListener("click", ()=>{
        if(!LAST_BEST){ showToast("Generate packages first"); return; }
        activateTab("tabExplore");
        renderMarkers(LAST_BEST.places);
        showToast("Best package shown on map");
      });

      $("btnAskAIFromBest").addEventListener("click", ()=>{
        if(!LAST_BEST){
          showToast("Generate packages first");
          return;
        }
        const sKey = $("startPlace").value, eKey = $("endPlace").value;
        const days = $("days").value, pax = $("pax").value;
        const pref = $("preference").value;
        const msg = `Start ${getPlaceByKey(sKey)?.name||""}, end ${getPlaceByKey(eKey)?.name||""}, ${days} days, ${pax} people, ${pref}. Refine best package.`;
        $("aiIn").value = msg;
        activateTab("tabAI");
        const res = aiGenerate(msg);
        renderAI(res);
      });

      // AI events
      $("aiSend").addEventListener("click", ()=>{
        const txt = $("aiIn").value;
        const res = aiGenerate(txt);
        renderAI(res);
      });
      $("aiClear").addEventListener("click", ()=>{
        $("aiIn").value = "";
        $("aiOut").innerHTML = `Hi üëã Tell me: Start, End, Days, People, interest and budget. <small>Example: ‚ÄúStart Shimla, end Manali, 4 days, 2 people, relax + nature, budget 25k.‚Äù</small>`;
        $("aiSummary").textContent = "No plan yet.";
        $("aiPackages").textContent = "‚Äî";
        $("aiPlaceList").innerHTML = `<div class="mutedSmall">Generate a plan to see suggested places here.</div>`;
        $("aiPlaceCount").textContent = "0";
        $("aiConf").textContent = "‚Äî";
        AI_LAST = null;
      });
      $("aiUsePlanner").addEventListener("click", ()=>{
        if(!AI_LAST || !AI_LAST.ok){
          showToast("Generate AI plan first");
          return;
        }
        $("startPlace").value = AI_LAST.parsed.startKey;
        $("endPlace").value = AI_LAST.parsed.endKey;
        $("days").value = String(AI_LAST.parsed.days);
        $("pax").value = String(AI_LAST.parsed.pax);
        activateTab("tabPackages");
        showToast("Applied AI plan to Planner");
      });

      // Firebase init
      try{
        firebase.initializeApp(firebaseConfig);
        setDbStatus(true, "Connected");
      }catch(e){
        console.error(e);
        setDbStatus(false, "Config error");
        showToast("Firebase config error");
        return;
      }

     async function loadAllData(){

  const db = firebase.database();

  try{

    const [locSnap, routeSnap, hotelSnap, vehSnap, staySnap] =
      await Promise.all([
        db.ref("locations").once("value"),
        db.ref("routes").once("value"),
        db.ref("hotels").once("value"),
        db.ref("pricing_transport").once("value"),
        db.ref("stay_rate_rules").once("value")
      ]);

    const locations = locSnap.val() || {};
    const routes = routeSnap.val() || {};
    const hotels = hotelSnap.val() || {};
    const vehicles = vehSnap.val() || {};
    const stayRules = staySnap.val() || {};

    // ---- NORMALIZE PLACES (supports old & new keys)
    ALL = Object.entries(locations).map(([key,p={}] )=>({
        key,
        place_id: p.place_id || key,
        name: p.name || p["Location Name"] || "",
        segment: p.segment || p["Segment Type"] || "Other",
        category: p.category || p["Location Type"] || "",
        short_desc: p.short_desc || p["Short Description"] || "",
        details: p.details_about_place || p.details || "",
        lat: parseFloat(p.lat ?? p["Latitude"]),
        lng: parseFloat(p.lng ?? p["Longitude"]),
        photo: p.photo_1 || p["photo 1"] || ""
    }));

    // ---- SAVE OTHER DATA FOR PLANNER / COST / AI
    window.ROUTES = Object.values(routes);
    window.HOTELS = Object.values(hotels);
    window.VEHICLES = Object.values(vehicles);
    window.STAY_RULES = Object.values(stayRules);

    // ---- UI UPDATE (same as your original)
    loadedCount.textContent = String(ALL.length);
    setDbStatus(true,"Live");

    const usable = ALL.filter(p=>p.lat!=null && p.lng!=null);
    fillPlaceSelect($("startPlace"), usable);
    fillPlaceSelect($("endPlace"), usable);

    buildSegmentList();
    showSegmentsScreen();
    refreshHeroBackground();
    attachAutoHandlers();

  }catch(err){
    console.error(err);
    setDbStatus(false,"Rules / Network");
    showToast("Firebase load failed");
  }
}

// run loader
loadAllData();

      // default tab
      activateTab("tabExplore");
    }

    boot();
  </script>
</body>
</html>
