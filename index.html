<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer ‚Äî Light Premium</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      /* Light premium palette */
      --bg0:#f7f9ff;
      --bg1:#ffffff;
      --card:rgba(255,255,255,.86);
      --card2:rgba(255,255,255,.72);
      --stroke:rgba(10,18,40,.10);
      --text:#0b1220;
      --muted:rgba(11,18,32,.64);
      --shadow: 0 20px 55px rgba(15,23,42,.10);
      --shadow2: 0 14px 28px rgba(15,23,42,.08);
      --r:18px; --r2:26px;
      --a:#2563eb; /* blue */
      --b:#7c3aed; /* violet */
      --c:#16a34a; /* green */
      --d:#f59e0b; /* amber */
      --max:1400px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 600px at 12% 10%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(900px 600px at 86% 16%, rgba(124,58,237,.14), transparent 60%),
        radial-gradient(900px 600px at 56% 92%, rgba(22,163,74,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--stroke);
    }
    .inner{
      width:min(92vw, var(--max));
      margin:0 auto;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(124,58,237,.92));
      box-shadow: 0 12px 26px rgba(37,99,235,.18);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .logo img{width:100%; height:100%; object-fit:cover; display:block}
    .brand h1{margin:0; font-size:14px; line-height:1.1; letter-spacing:.2px}
    .brand small{display:block; color:var(--muted); font-weight:650; margin-top:2px}

    .nav{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.75);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      font-weight:850; font-size:12px;
      transition:.18s ease;
      cursor:pointer;
    }
    .pill:hover{transform: translateY(-1px)}
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: linear-gradient(135deg, var(--a), var(--b));
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:11px 14px; border-radius:14px;
      color:#fff;
      background: linear-gradient(135deg, rgba(37,99,235,.96), rgba(124,58,237,.92));
      box-shadow: 0 18px 42px rgba(37,99,235,.20);
      font-weight:900; font-size:12px;
      transition:.18s ease;
      display:inline-flex; align-items:center; gap:10px;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.ghost{
      color: var(--text);
      background: rgba(255,255,255,.78);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }

    .wrap{
      width:min(92vw, var(--max));
      margin:0 auto;
      padding:18px 16px 44px;
    }

    /* HERO LAYOUT */
    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:stretch;
      margin-top:10px;
    }
    @media(max-width:900px){ .hero{ grid-template-columns:1fr; } }

    /* HERO CARD */
    .heroCard{
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-height:360px;
    }
    .heroCard::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(700px 420px at 20% 30%, rgba(37,99,235,.12), transparent 62%),
        radial-gradient(700px 420px at 78% 30%, rgba(124,58,237,.10), transparent 62%);
      mix-blend-mode:multiply;
      opacity:.85;
      pointer-events:none;
    }
    .heroInner{
      position:relative;
      padding:26px;
      display:flex;
      flex-direction:column;
      height:100%;
      justify-content:space-between;
      gap:16px;
      background:
        linear-gradient(120deg, rgba(255,255,255,.92), rgba(255,255,255,.60)),
        url("./Kee_monastery.jpg") center/cover no-repeat;
      border-radius: var(--r2);
    }
    .heroTitle{
      margin:0;
      font-size: clamp(28px,3.2vw,48px);
      letter-spacing:-.6px;
      line-height:1.05;
    }
    .heroSub{
      margin:10px 0 0;
      color: rgba(11,18,32,.70);
      font-weight:700;
      max-width:70ch;
    }

    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .chip{
      padding:8px 11px;
      border-radius:999px;
      background: rgba(255,255,255,.80);
      border:1px solid var(--stroke);
      font-weight:850;
      font-size:12px;
      box-shadow: var(--shadow2);
    }
    .chip i{
      font-style:normal;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(37,99,235,.10);
      margin-right:8px;
    }

    .finder{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 170px 170px 160px;
      gap:10px;
      align-items:end;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:11px; color:var(--muted); font-weight:900; letter-spacing:.25px}
    .input, .select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      color:var(--text);
      outline:none;
      font-weight:800;
      box-shadow: var(--shadow2);
    }
    .input::placeholder{color:rgba(11,18,32,.45)}
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    /* Right: Trip Builder */
    .panel{
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.80);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
    }
    .panelHead h3{margin:0; font-size:13px}
    .panelHead small{color:var(--muted); font-weight:800}

    .builder{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .bRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .helper{
      padding:12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: rgba(245,247,255,.75);
      color: rgba(11,18,32,.78);
      font-weight:750;
      font-size:12px;
      line-height:1.45;
    }
    .primaryLine{
      padding:12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(124,58,237,.08));
      font-weight:900;
      font-size:12px;
    }

    /* Packages UI */
    .pkgCard{
      border:1px solid var(--stroke);
      border-radius:18px;
      background: rgba(255,255,255,.92);
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .pkgTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .pkgTitle{margin:0; font-weight:950; font-size:13px}
    .pkgMeta{margin:6px 0 0; color:rgba(11,18,32,.72); font-weight:750; font-size:12px; line-height:1.35}
    .pricePill{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(124,58,237,.08));
      font-weight:950; font-size:12px;
      white-space:nowrap;
    }
    .pkgTiles{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .pkgTile{
      display:flex; gap:10px; align-items:center;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:10px;
      background: rgba(245,247,255,.80);
      cursor:pointer;
      transition:.15s ease;
    }
    .pkgTile:hover{transform: translateY(-1px)}
    .pkgThumb{
      width:54px; height:44px; border-radius:14px;
      overflow:hidden; border:1px solid var(--stroke);
      background: rgba(255,255,255,.7);
      flex:0 0 auto;
    }
    .pkgThumb img{width:100%; height:100%; object-fit:cover; display:block}
    .pkgTile b{display:block; font-size:12px}
    .pkgTile span{display:block; font-size:11px; color:rgba(11,18,32,.68); font-weight:800}

    /* Sections */
    .section{margin-top:18px; display:grid; grid-template-columns:1fr; gap:14px}
    .sectionTitle{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:8px 0 0;
    }
    .sectionTitle h2{margin:0; font-size:16px}
    .sectionTitle p{margin:0; color:var(--muted); font-weight:800; font-size:12px}

    /* Explore layout: sidebar + list + (map hidden) */
    .exploreGrid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){
      .exploreGrid{grid-template-columns:1fr}
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:78px;
      max-height: calc(100vh - 96px);
      overflow:auto;
    }
    .sideHead{
      padding:14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75));
    }
    .sideHead h3{margin:0; font-size:13px}
    .segBox{padding:12px; display:grid; gap:10px}
    .segRow{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      border-radius:18px;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .segTop{
      padding:12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .segTop b{font-size:12px}
    .segTop span{font-size:12px; color:rgba(11,18,32,.62); font-weight:850}
    .chev{font-weight:950; opacity:.7}
    .segList{
      display:none;
      border-top:1px solid var(--stroke);
      padding:10px;
      background: rgba(245,247,255,.70);
    }
    .segBtn{
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      cursor:pointer;
      font-weight:900;
      margin-bottom:8px;
      box-shadow: var(--shadow2);
    }
    .segBtn span{font-size:12px}
    .segBtn small{font-size:11px; opacity:.75}
    .segBtn:hover{transform: translateY(-1px)}

    /* List */
    .results{min-height:460px; display:flex; flex-direction:column}
    .list{
      padding:14px;
      display:grid;
      gap:10px;
      overflow:auto;
      max-height: 720px;
    }
    .place{
      display:grid;
      grid-template-columns: 96px 1fr;
      gap:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      cursor:pointer;
      transition:.16s ease;
      box-shadow: var(--shadow2);
    }
    .place:hover{transform: translateY(-1px)}
    .thumb{
      width:96px; height:74px;
      border-radius:16px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(124,58,237,.08));
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .pTitle{margin:0; font-size:13px; font-weight:950}
    .pSub{margin:6px 0 0; color:var(--muted); font-weight:750; font-size:12px; line-height:1.35}
    .badges{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    .badge{
      font-size:11px; font-weight:950;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
    }

    /* Map panel stays hidden until click */
    .mapPanel{display:none; margin-top:14px}
    #map{
      width:100%;
      height: 460px;
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Mobile sidebar drawer */
    .sideMobileWrap{
      position:fixed; inset:0;
      background: rgba(15,23,42,.35);
      display:none;
      align-items:stretch;
      justify-content:flex-start;
      z-index:80;
      backdrop-filter: blur(6px);
    }
    .sideMobile{
      width:min(420px, 92vw);
      height:100%;
      background: rgba(255,255,255,.95);
      border-right: 1px solid var(--stroke);
      box-shadow: 0 30px 110px rgba(15,23,42,.20);
      display:flex; flex-direction:column;
    }
    .sideMobileTop{
      padding:14px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.88));
    }
    .closeX{
      width:42px; height:42px; border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      cursor:pointer;
      color:var(--text);
      font-weight:950;
      box-shadow: var(--shadow2);
    }

    /* AI Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(15,23,42,.35);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      z-index:70;
      backdrop-filter: blur(6px);
    }
    .modal{
      width:min(840px, 100%);
      border-radius: 26px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      box-shadow: 0 30px 110px rgba(15,23,42,.20);
      overflow:hidden;
    }
    .modalHead{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.88));
    }
    .modalHead h3{margin:0; font-size:14px}
    .chat{
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
      max-height: 62vh;
      overflow:auto;
    }
    .msg{
      max-width: 86%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(245,247,255,.80);
      color:var(--text);
      font-weight:750;
      line-height:1.45;
      font-size:12.5px;
      white-space:pre-wrap;
      box-shadow: var(--shadow2);
    }
    .msg.me{
      margin-left:auto;
      background: linear-gradient(135deg, rgba(37,99,235,.12), rgba(124,58,237,.10));
    }
    .composer{
      padding:12px 14px 14px;
      display:flex;
      gap:10px;
      border-top:1px solid var(--stroke);
    }
    .composer input{
      flex:1;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.90);
      color:var(--text);
      outline:none;
      font-weight:800;
      box-shadow: var(--shadow2);
    }

    @media (max-width: 980px){
      .finder{grid-template-columns:1fr 1fr}
      .finder .field:nth-child(1){grid-column:1/-1}
      .finder .field:nth-child(4){grid-column:1/-1}
      #map{height:380px}
      .bRow{grid-template-columns:1fr}
      .pkgTiles{grid-template-columns:1fr}
      .sidebar{display:none;}
      .nav .pill.sideOpen{display:inline-flex;}
    }
     .packageCard .pcMedia{
  background: linear-gradient(135deg, rgba(99,102,241,.25), rgba(16,185,129,.18));
}
.packageTop .btn{
  padding:10px 12px; border-radius:12px;
  border:1px solid rgba(0,0,0,.08);
  background:#fff; cursor:pointer;
}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo">
          <img src="./logo.png" alt="Himachal Explorer" onerror="this.remove()">
        </div>
        <div>
          <h1>Himachal Explorer</h1>
          <small>Light premium ‚Ä¢ fast search ‚Ä¢ type sidebar</small>
        </div>
      </div>

      <div class="nav">
        <span class="pill sideOpen" id="openSideMobile" style="display:none"><span class="dot"></span>Types</span>
        <a class="pill" href="#explore"><span class="dot"></span>Explore</a>
        <button class="btn ghost" id="openAI">AI Planner</button>
        <button class="btn" id="openAdmin">Admin</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <section class="hero">
      <!-- LEFT -->
      <div class="heroCard">
        <div class="heroInner">
          <div>
            <h2 class="heroTitle">Plan Himachal like a pro ‚Äî without clutter.</h2>
            <p class="heroSub">
              Search + filters + <b>Type sidebar</b>. Map loads only when you click <b>Show Map</b>.
            </p>

            <div class="chips">
              <div class="chip"><i>Clean</i>Light premium theme</div>
              <div class="chip"><i>Smart</i>Type-based sidebar</div>
              <div class="chip"><i>Fast</i>Map on demand</div>
            </div>

            <div class="finder">
              <div class="field">
                <label>Search (place / temple / lake / trek)</label>
                <input class="input" id="q" placeholder="Example: Triund, Manimahesh, Kufri, Chandratal‚Ä¶"/>
              </div>

              <div class="field">
                <label>District</label>
                <select class="select" id="district">
                  <option value="all">All</option>
                </select>
              </div>

              <div class="field">
                <label>Type</label>
                <select class="select" id="type">
                  <option value="all">All</option>
                  <option value="Destination">Destination</option>
                  <option value="Temple">Temple</option>
                  <option value="Lake">Lake</option>
                  <option value="Trek">Trek</option>
                  <option value="Hotel">Hotel</option>
                  <option value="Activity">Activity</option>
                </select>
              </div>

              <div class="field">
                <label>Trip Days</label>
                <select class="select" id="days">
                  <option value="0">Any</option>
                  <option value="1">1‚Äì2 days</option>
                  <option value="3">3‚Äì4 days</option>
                  <option value="5">5‚Äì7 days</option>
                  <option value="8">8‚Äì12 days</option>
                </select>
              </div>
            </div>

            <div class="heroActions">
              <button class="btn" id="apply">Explore Now</button>
              <button class="btn ghost" id="nearby">Nearby</button>
              <button class="btn ghost" id="reset">Reset</button>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap">
            <small style="color:rgba(11,18,32,.65); font-weight:800">
              Tip: Sidebar Type ‚Üí middle list updates instantly.
            </small>
            <small id="status" style="color:rgba(11,18,32,.65); font-weight:900">Loading‚Ä¶</small>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <div class="panelHead">
          <h3>Trip Builder</h3>
          <small>live packages</small>
        </div>
        <div class="builder">
          <div class="primaryLine" id="builderLine">Pick your preferences ‚Üí we‚Äôll suggest 3‚Äì4 packages.</div>

          <div class="bRow">
            <div class="field">
              <label>People</label>
              <select class="select" id="people">
                <option value="solo">Solo</option>
                <option value="couple">Couple</option>
                <option value="family">Family</option>
                <option value="group">Group</option>
              </select>
            </div>
            <div class="field">
              <label>Budget (‚Çπ)</label>
              <select class="select" id="budget">
                <option value="low">Low</option>
                <option value="mid" selected>Mid</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>

          <div class="bRow">
            <div class="field">
              <label>Interest</label>
              <select class="select" id="interest">
                <option value="nature" selected>Nature + Views</option>
                <option value="temples">Temples + Culture</option>
                <option value="adventure">Adventure + Treks</option>
                <option value="relax">Relax + Cafes</option>
              </select>
            </div>
            <button class="btn" id="makePackages">Get Packages</button>
          </div>

          <div class="helper" id="packagesBox">
            Click <b>Get Packages</b> ‚Äî you‚Äôll see 3‚Äì4 options here (rates + tiles).
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <a class="pill" href="#explore"><span class="dot"></span><span id="activeFilters">No filters</span></a>
            <div class="pill" style="cursor:pointer" data-quick="Trek"><span class="dot"></span>Top Treks</div>
            <div class="pill" style="cursor:pointer" data-quick="Lake"><span class="dot"></span>Lakes</div>
            <div class="pill" style="cursor:pointer" data-quick="Temple"><span class="dot"></span>Temples</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="explore">
      <div class="sectionTitle">
        <div>
          <h2>Explore results</h2>
          <p>Type sidebar (left) ‚Üí list (middle). Map stays hidden until ‚ÄúShow Map‚Äù.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <span class="pill"><span class="dot"></span><span id="count">0</span></span>
        </div>
      </div>

      <div class="exploreGrid">
        <!-- LEFT SIDEBAR (Desktop) -->
        <div class="panel sidebar">
          <div class="sideHead">
            <h3>Types</h3>
            <button class="btn ghost" id="collapseAll">Collapse</button>
          </div>
          <div class="segBox" id="segBox"></div>
        </div>

        <!-- MIDDLE: LIST + MAP -->
        <div>
          <div class="panel results">
            <div class="panelHead">
              <h3>Places</h3>
              <small>click to open (place.html)</small>
            </div>
            <div class="list" id="list"></div>
          </div>

          <div class="panel mapPanel" id="mapPanel">
            <div class="panelHead">
              <h3>Map</h3>
              <small id="mapHint">Loads after click</small>
            </div>
            <div style="padding:14px">
              <div id="map"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- MOBILE SIDEBAR DRAWER -->
  <div class="sideMobileWrap" id="sideMobileWrap" aria-modal="true" role="dialog">
    <div class="sideMobile">
      <div class="sideMobileTop">
        <div>
          <b>Types</b><br/>
          <small style="color:rgba(11,18,32,.65); font-weight:850">Tap type ‚Üí list updates</small>
        </div>
        <button class="closeX" id="closeSideMobile">‚úï</button>
      </div>
      <div class="segBox" id="segBoxMobile" style="flex:1; overflow:auto;"></div>
    </div>
  </div>

  <!-- AI MODAL -->
  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>AI Trip Planner</h3>
          <small style="color:rgba(11,18,32,.65); font-weight:850">Days + people + interests ‚Üí suggestions</small>
        </div>
        <button class="closeX" id="closeAI">‚úï</button>
      </div>
      <div class="chat" id="chat"></div>
      <div class="composer">
        <input id="chatInput" placeholder="Example: 4 days, couple, nature + temples, starting Shimla"/>
        <button class="btn" id="sendChat">Send</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   FIREBASE
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
  authDomain: "revnue-records.firebaseapp.com",
  databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "revnue-records",
  storageBucket: "revnue-records.firebasestorage.app",
  messagingSenderId: "182348503564",
  appId: "1:182348503564:web:480085405b09177245ac29",
  measurementId: "G-MGTDBCG896"
};
const dbPath = "locations";

/* =========================
   STATE
========================= */
const $ = (id)=>document.getElementById(id);
let allPlaces = [];
let shownPlaces = [];
let map = null;
let markerLayer = null;
let mapReady = false;
let myPos = null;

/* =========================
   HELPERS
========================= */
function safeText(v){ return (v ?? "").toString().trim(); }
function escapeHtml(str){
  return safeText(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function normalizeType(t){
  t = safeText(t);
  if(!t) return "Destination";
  const low = t.toLowerCase();
  if(low.includes("temple") || low.includes("mandir")) return "Temple";
  if(low.includes("lake")) return "Lake";
  if(low.includes("trek") || low.includes("trail")) return "Trek";
  if(low.includes("hotel") || low.includes("stay")) return "Hotel";
  if(low.includes("activity") || low.includes("adventure")) return "Activity";
  if(low.includes("dest") || low.includes("place")) return "Destination";
  return t[0].toUpperCase() + t.slice(1);
}
function parseLatLngFromMapUrl(url){
  url = safeText(url);
  if(!url) return {lat:null,lng:null};
  const q = url.match(/q=([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(q) return {lat:Number(q[1])||null, lng:Number(q[2])||null};
  const at = url.match(/@([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(at) return {lat:Number(at[1])||null, lng:Number(at[2])||null};
  return {lat:null,lng:null};
}
function typeBg(type){
  switch(type){
    case "Trek": return "rgba(37,99,235,.10)";
    case "Lake": return "rgba(22,163,74,.10)";
    case "Temple": return "rgba(245,158,11,.12)";
    case "Hotel": return "rgba(124,58,237,.10)";
    case "Activity": return "rgba(37,99,235,.08)";
    default: return "rgba(255,255,255,.86)";
  }
}
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = (d)=> d * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function pickRate(p, people){
  const r = p.rates || {};
  const solo = r.solo ?? p.Rate_Solo ?? null;
  const couple = r.couple ?? p.Rate_Couple ?? null;
  const family = r.family ?? p.Rate_Family ?? null;
  const group = r.group ?? p.Rate_Group ?? null;
  if(people==="solo") return solo;
  if(people==="couple") return couple;
  if(people==="family") return family;
  if(people==="group") return group;
  return null;
}
function getImagesFromObj(o){
  const arr = [];
  if(Array.isArray(o.images)) arr.push(...o.images);
  const p1 = safeText(o["photo 1"] || o.photo1 || o["photo1"]);
  const p2 = safeText(o["photo 2"] || o.photo2 || o["photo2"]);
  const p3 = safeText(o["photo 3"] || o.photo3 || o["photo3"]);
  if(p1) arr.push(p1);
  if(p2) arr.push(p2);
  if(p3) arr.push(p3);
  return arr.filter(Boolean);
}
function bestThumb(p){
  const imgs = (p.images || []).filter(Boolean);
  return imgs[0] || "";
}
function rateLabel(people){
  if(people==="solo") return "Solo";
  if(people==="couple") return "Couple";
  if(people==="family") return "Family";
  return "Group";
}
function currency(n){
  if(n==null || !Number.isFinite(Number(n))) return null;
  return "‚Çπ" + Number(n).toLocaleString("en-IN");
}

/* =========================
   MAP (lazy init)
========================= */
function ensureMap(){
  if(mapReady) return;
  $("mapPanel").style.display = "block";

  map = L.map('map', {zoomControl:true}).setView([31.9, 77.2], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);

  mapReady = true;
  setTimeout(()=> map.invalidateSize(), 120);
}
function clearMarkers(){
  if(!mapReady) return;
  markerLayer.clearLayers();
}
function addMarkers(list){
  if(!mapReady) return;
  clearMarkers();
  list.forEach((p)=>{
    if(!p.lat || !p.lng) return;
    const m = L.marker([p.lat, p.lng]).addTo(markerLayer);
    m.bindPopup(`<b>${escapeHtml(p.name)}</b><br/><span style="opacity:.75">${escapeHtml(p.district)} ‚Ä¢ ${escapeHtml(p.type)}</span>`);
    m.on('click', ()=> openPlacePage(p.id));
  });
}

/* =========================
   FIREBASE LOAD
========================= */
async function loadPlaces(){
  try{
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const snap = await db.ref(dbPath).once("value");
    const val = snap.val() || {};

    allPlaces = Object.entries(val).map(([id, o])=>{
      o = o || {};
      const name = safeText(o["Location Name"] || o.name || o.title || id);
      const district = safeText(o["District"] || o.district || "Unknown");
      const segment = safeText(o["Segment Type"] || o.segment || "Destination");
      const locationType = safeText(o["Location Type"] || o.type || "");
      const overview = safeText(o["Overview"] || o.overview || "");
      const short = safeText(o["Short Description"] || o.short || "");
      const keyFeatures = safeText(o["Key Features"] || o.features || "");
      const how = safeText(o["How to Reach"] || o.how || "");
      const mapUrl = safeText(o["Map"] || o.map || "");
      const {lat, lng} = parseLatLngFromMapUrl(mapUrl);

      const type = normalizeType(segment);
      const brief = overview || short || keyFeatures || "Explore this place in Himachal Pradesh.";
      const images = getImagesFromObj(o);

      const rates = o.rates || {
        solo: o.Rate_Solo ?? null,
        couple: o.Rate_Couple ?? null,
        family: o.Rate_Family ?? null,
        group: o.Rate_Group ?? null
      };
      const tdMin = o.TripDays_Min ?? null;
      const tdMax = o.TripDays_Max ?? null;

      return { id, name, district, type, segment, locationType, brief, how, mapUrl, lat, lng, images, rates, TripDays_Min: tdMin, TripDays_Max: tdMax };
    }).filter(p=>p.name);
  }catch(e){
    console.error("Firebase load failed:", e);
    allPlaces = [];
  }
}
async function fetchPlaceById(id){
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const snap = await db.ref(`${dbPath}/${id}`).once("value");
  const o = snap.val();
  if(!o) return null;

  const name = safeText(o["Location Name"] || o.name || id);
  const district = safeText(o["District"] || o.district || "Unknown");
  const segment = safeText(o["Segment Type"] || o.segment || "Destination");
  const locationType = safeText(o["Location Type"] || o.type || "");
  const overview = safeText(o["Overview"] || o.overview || "");
  const short = safeText(o["Short Description"] || o.short || "");
  const keyFeatures = safeText(o["Key Features"] || o.features || "");
  const how = safeText(o["How to Reach"] || o.how || "");
  const mapUrl = safeText(o["Map"] || o.map || "");
  const {lat, lng} = parseLatLngFromMapUrl(mapUrl);
  const images = getImagesFromObj(o);
  const type = normalizeType(segment);
  const brief = overview || short || keyFeatures || "Explore this place in Himachal Pradesh.";
  const rates = o.rates || {
    solo: o.Rate_Solo ?? null,
    couple: o.Rate_Couple ?? null,
    family: o.Rate_Family ?? null,
    group: o.Rate_Group ?? null
  };
  const tdMin = o.TripDays_Min ?? null;
  const tdMax = o.TripDays_Max ?? null;

  return { id, name, district, type, segment, locationType, brief, how, mapUrl, lat, lng, images, rates, TripDays_Min: tdMin, TripDays_Max: tdMax, raw:o };
}

/* =========================
   DROPDOWNS + FILTERS
========================= */
function buildDistrictDropdown(){
  const distSel = $("district");
  const districts = [...new Set(allPlaces.map(p=>p.district).filter(Boolean))].sort();
  distSel.innerHTML = `<option value="all">All</option>` + districts.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
}
function updateActiveFilters(){
  const parts = [];
  const d = $("district").value;
  const t = $("type").value;
  const q = safeText($("q").value);
  const days = Number($("days").value||0);
  if(d !== "all") parts.push(d);
  if(t !== "all") parts.push(t);
  if(days) parts.push(`${days}+ days`);
  if(q) parts.push(`‚Äú${q}‚Äù`);
  $("activeFilters").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "No filters";
}
function applyFilters(scrollToList=false){
  const q = safeText($("q").value).toLowerCase();
  const d = $("district").value;
  const t = $("type").value;
  const days = Number($("days").value||0);

  shownPlaces = allPlaces.filter(p=>{
    if(d !== "all" && p.district !== d) return false;
    if(t !== "all" && p.type !== t) return false;
    if(q){
      const hay = `${p.name} ${p.district} ${p.type} ${p.brief} ${p.how} ${p.locationType} ${p.segment}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    if(days){
      if(days <= 2 && p.type === "Trek") return false;
    }
    return true;
  });

  renderList(shownPlaces);
  $("count").textContent = `${shownPlaces.length} results`;
  updateActiveFilters();
  renderTypeSidebar(); // important
  if(scrollToList) $("list").scrollTo({top:0, behavior:"smooth"});
}

/* =========================
   LIST RENDER
========================= */
function renderList(list){
  const box = $("list");
  if(!list.length){
    box.innerHTML = `<div style="padding:14px; color:rgba(11,18,32,.70); font-weight:850">
      No results. Try changing filters or search.
    </div>`;
    return;
  }

  box.innerHTML = list.map((p, idx)=>{
    const thumb = bestThumb(p);
    const brief = safeText(p.brief);
    const meta = `${safeText(p.district)} ‚Ä¢ ${safeText(p.type)}${p.locationType ? " ‚Ä¢ " + p.locationType : ""}`;
    const km = (myPos && p.lat && p.lng) ? haversine(myPos.lat, myPos.lng, p.lat, p.lng) : null;

    return `
      <div class="place" data-i="${idx}">
        <div class="thumb">
          ${thumb ? `<img src="${thumb}" alt="${escapeHtml(p.name)}" loading="lazy" onerror="this.remove()">` : ``}
        </div>
        <div>
          <p class="pTitle">${escapeHtml(p.name)}</p>
          <p class="pSub">${escapeHtml(meta)} ‚Äî ${escapeHtml(brief)}</p>
          <div class="badges">
            <span class="badge" style="background:${typeBg(p.type)}">${escapeHtml(p.type)}</span>
            <span class="badge">${escapeHtml(p.district)}</span>
            ${km ? `<span class="badge">üìç ${km.toFixed(1)} km</span>` : ``}
          </div>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll(".place").forEach(el=>{
    el.addEventListener("click", async ()=>{
      const i = Number(el.getAttribute("data-i"));
      const p = list[i];
      $("status").textContent = "Opening‚Ä¶";
      const full = await fetchPlaceById(p.id);
      openPlacePage((full && full.id) ? full.id : p.id);
    });
  });
}
function openPlacePage(id){
  window.location.href = `place.html?id=${encodeURIComponent(id)}`;
}

/* =========================
   TYPE SIDEBAR (FIXED)
========================= */
const TYPE_ORDER = ["Destination","Temple","Lake","Trek","Hotel","Activity"];

function typeCountsFrom(list){
  const counts = {};
  list.forEach(p=>{
    const t = p.type || "Destination";
    counts[t] = (counts[t]||0) + 1;
  });
  return counts;
}

function renderTypeSidebar(){
  const base = shownPlaces.length ? shownPlaces : allPlaces;
  const counts = typeCountsFrom(base);
  TYPE_ORDER.forEach(t=>{ if(counts[t]==null) counts[t]=0; });

  const rows = TYPE_ORDER
    .sort((a,b)=> (counts[b]||0) - (counts[a]||0))
    .map(t=>{
      return `
        <div class="segRow">
          <div class="segTop" data-toggle-type="${escapeHtml(t)}">
            <div>
              <b>${escapeHtml(t)}</b>
              <span> ‚Ä¢ ${counts[t]||0}</span>
            </div>
            <div class="chev" data-chev-type="${escapeHtml(t)}">‚ñæ</div>
          </div>

          <div class="segList" id="typelist-${escapeHtml(t)}">
            <button class="segBtn" data-type-pick="${escapeHtml(t)}">
              <span>Show all ${escapeHtml(t)}</span>
              <small>${counts[t]||0}</small>
            </button>

            ${base.filter(p=>p.type===t).slice(0,8).map(p=>`
              <button class="segBtn" data-open-place="${escapeHtml(p.id)}">
                <span>${escapeHtml(p.name)}</span>
                <small>${escapeHtml(p.district)}</small>
              </button>
            `).join("")}
          </div>
        </div>
      `;
    }).join("");

  const html =
    rows +
    `
    <div class="segRow">
      <div class="segTop" data-toggle-type="__quick__">
        <div><b>Quick</b><span> ‚Ä¢ tools</span></div>
        <div class="chev" data-chev-type="__quick__">‚ñæ</div>
      </div>
      <div class="segList" id="typelist-__quick__">
        <button class="segBtn" data-reset-all="1">
          <span>Show All Places</span>
          <small>${base.length}</small>
        </button>
      </div>
    </div>
    `;

  $("segBox").innerHTML = html;
  $("segBoxMobile").innerHTML = html;

  function bind(root){
    root.querySelectorAll("[data-toggle-type]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-toggle-type");
        const list = root.querySelector("#typelist-"+CSS.escape(key));
        const chev = root.querySelector(`[data-chev-type="${CSS.escape(key)}"]`);
        const open = (list.style.display === "block");
        list.style.display = open ? "none" : "block";
        if(chev) chev.textContent = open ? "‚ñæ" : "‚ñ¥";
      });
    });

    root.querySelectorAll("[data-type-pick]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const t = b.getAttribute("data-type-pick");
        $("type").value = t;
        applyFilters(true);
        location.hash = "#explore";
        closeSidebarMobile();
      });
    });

    root.querySelectorAll("[data-open-place]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-open-place");
        openPlacePage(id);
      });
    });

    root.querySelectorAll("[data-reset-all]").forEach(b=>{
      b.addEventListener("click", ()=>{
        $("q").value = "";
        $("district").value = "all";
        $("type").value = "all";
        $("days").value = "0";
        applyFilters(true);
        location.hash = "#explore";
        closeSidebarMobile();
      });
    });
  }

  bind($("segBox"));
  bind($("segBoxMobile"));
}

function collapseAllTypes(){
  ["segBox","segBoxMobile"].forEach(id=>{
    const root = $(id);
    if(!root) return;
    root.querySelectorAll(".segList").forEach(el=> el.style.display="none");
    root.querySelectorAll("[data-chev-type]").forEach(el=> el.textContent="‚ñæ");
  });
}

/* =========================
   MOBILE SIDEBAR
========================= */
function openSidebarMobile(){ $("sideMobileWrap").style.display="flex"; }
function closeSidebarMobile(){ $("sideMobileWrap").style.display="none"; }
$("openSideMobile").addEventListener("click", openSidebarMobile);
$("closeSideMobile").addEventListener("click", closeSidebarMobile);
$("sideMobileWrap").addEventListener("click",(e)=>{ if(e.target === $("sideMobileWrap")) closeSidebarMobile(); });

/* =========================
   NEARBY
========================= */
$("nearby").onclick = ()=>{
  if(!navigator.geolocation){ alert("GPS not supported."); return; }
  $("status").textContent = "Getting your location‚Ä¶";
  navigator.geolocation.getCurrentPosition((pos)=>{
    myPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    $("status").textContent = "Nearby enabled. Distances shown.";
    renderList(shownPlaces);
  }, ()=>{
    $("status").textContent = "GPS permission denied.";
    alert("Allow location permission for Nearby.");
  }, {enableHighAccuracy:true, timeout:12000});
};

/* =========================
   PACKAGES (LIVE)
========================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function pickPackageSpots(baseList, count, wantsType){
  const list = baseList.slice();
  const typed = list.filter(p => !wantsType || p.type === wantsType);
  const pool = typed.length ? typed : list;
  return shuffle(pool).slice(0, count);
}
function packageTitle(interest){
  if(interest==="temples") return "Culture + Temples";
  if(interest==="adventure") return "Adventure Mix";
  if(interest==="relax") return "Easy + Relax";
  return "Nature + Views";
}
function interestTypeHint(interest){
  if(interest==="temples") return "Temple";
  if(interest==="adventure") return "Trek";
  if(interest==="relax") return "Destination";
  return null;
}

async function buildPackages(){
  const people = $("people").value;
  const interest = $("interest").value;
  const budget = $("budget").value;
  const days = Number($("days").value||0);
  const district = $("district").value !== "all" ? $("district").value : null;

  let base = shownPlaces.slice();
  if(district) base = base.filter(p=>p.district===district);

  if(!base.length){
    $("packagesBox").innerHTML = `<b>No matches for packages.</b><br/>Try relaxing filters.`;
    return;
  }

  base.sort((a,b)=>{
    const ra = pickRate(a, people);
    const rb = pickRate(b, people);
    const A = ra==null ? 1e18 : ra;
    const B = rb==null ? 1e18 : rb;
    if(budget==="low") return A-B;
    if(budget==="high") return B-A;
    return 0;
  });

  const hintType = interestTypeHint(interest);

  const pkgs = [
    {name:`Package A (${days?days:"3"}D)`, mood: packageTitle(interest), spots: pickPackageSpots(base, 4, hintType)},
    {name:`Package B (${days?days:"3"}D)`, mood:"Scenic + Photos", spots: pickPackageSpots(base, 4, null)},
    {name:`Package C (${days?days:"3"}D)`, mood:"Local + Food", spots: pickPackageSpots(base, 4, "Destination")},
    {name:`Package D (${days?days:"3"}D)`, mood:"Mix + Nearby", spots: pickPackageSpots(base, 4, null)}
  ];

  const daysFactor = days ? Math.max(1, Math.min(4, Math.ceil(days/3))) : 1;

  const html = pkgs.map(pkg=>{
    const rates = pkg.spots.map(p=>pickRate(p, people)).filter(n=>n!=null);
    const avg = rates.length ? Math.round(rates.reduce((s,x)=>s+Number(x),0)/rates.length) : null;
    const total = avg!=null ? avg*daysFactor : null;

    const priceText = total!=null
      ? `${currency(total)} / ${rateLabel(people)}`
      : `Rate missing`;

    const tiles = pkg.spots.map(p=>{
      const thumb = bestThumb(p);
      return `
        <div class="pkgTile" data-open="${escapeHtml(p.id)}">
          <div class="pkgThumb">${thumb ? `<img src="${thumb}" loading="lazy" onerror="this.remove()">` : ``}</div>
          <div>
            <b>${escapeHtml(p.name)}</b>
            <span>${escapeHtml(p.district)} ‚Ä¢ ${escapeHtml(p.type)}</span>
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="pkgCard">
        <div class="pkgTop">
          <div>
            <p class="pkgTitle">${escapeHtml(pkg.name)} ‚Ä¢ ${escapeHtml(pkg.mood)}</p>
            <p class="pkgMeta">People: <b>${escapeHtml(rateLabel(people))}</b> ‚Ä¢ Budget: <b>${escapeHtml(budget)}</b> ‚Ä¢ Interest: <b>${escapeHtml(interest)}</b></p>
          </div>
          <div class="pricePill">${priceText}</div>
        </div>
        <div class="pkgTiles">${tiles}</div>
      </div>
    `;
  }).join("<div style='height:10px'></div>");

  $("packagesBox").innerHTML = html;

  $("packagesBox").querySelectorAll("[data-open]").forEach(el=>{
    el.addEventListener("click", async ()=>{
      const id = el.getAttribute("data-open");
      $("status").textContent = "Opening‚Ä¶";
      const full = await fetchPlaceById(id);
      openPlacePage((full && full.id) ? full.id : id);
    });
  });
}
$("makePackages").onclick = buildPackages;

/* =========================
   QUICK TYPE PILLS
========================= */
document.querySelectorAll("[data-quick]").forEach(el=>{
  el.addEventListener("click", ()=>{
    $("type").value = el.getAttribute("data-quick");
    applyFilters(true);
    location.hash="#explore";
  });
});

/* =========================
   AI MODAL
========================= */
function openAI(){ $("modalWrap").style.display="flex"; seedChat(); }
function closeAI(){ $("modalWrap").style.display="none"; }
$("openAI").onclick = openAI;
$("closeAI").onclick = closeAI;
$("modalWrap").addEventListener("click",(e)=>{ if(e.target === $("modalWrap")) closeAI(); });

function pushMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = "msg " + (who==="me" ? "me" : "");
  div.textContent = text;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}
function seedChat(){
  $("chat").innerHTML = "";
  pushMsg("Tell me: days + people + interests (trek/lake/temple/relax) + starting district.", "bot");
  pushMsg("Example: 4 days, couple, nature + temples, starting Shimla", "bot");
}
function aiSuggest(userText){
  const t = userText.toLowerCase();
  let days = 0;
  const m = t.match(/(\d+)\s*(day|days|d)/);
  if(m) days = Number(m[1]);

  const wants = {
    trek: /trek|hike|trail|adventure/.test(t),
    lake: /lake|chandratal|prashar|rewalsar|manimahesh/.test(t),
    temple: /temple|mandir|devi|mahadev|monastery/.test(t),
    relax: /relax|peace|family|easy/.test(t),
  };

  let districtHint = null;
  const districts = [...new Set(allPlaces.map(p=>p.district))];
  for(const d of districts){ if(t.includes(d.toLowerCase())) { districtHint = d; break; } }

  const scored = allPlaces.map(p=>{
    let s=0;
    if(districtHint && p.district===districtHint) s += 3;
    if(wants.trek && p.type==="Trek") s += 3;
    if(wants.lake && p.type==="Lake") s += 3;
    if(wants.temple && p.type==="Temple") s += 3;
    if(wants.relax && p.type!=="Trek") s += 1;
    return {p, s};
  }).sort((a,b)=>b.s-a.s);

  const cap = days ? Math.max(3, Math.min(8, Math.ceil(days*1.3))) : 6;
  const pick = scored.filter(x=>x.s>0).slice(0, cap).map(x=>x.p);
  const fallback = allPlaces.slice(0,6);

  const list = (pick.length ? pick : fallback)
    .map((p,i)=>`${i+1}. ${p.name} (${p.district} ‚Ä¢ ${p.type})`)
    .join("\n");

  return `Suggestions:\n${list}\n\nTip: pick Type from sidebar to refine.`;
}
$("sendChat").onclick = ()=>{
  const v = safeText($("chatInput").value);
  if(!v) return;
  pushMsg(v, "me");
  $("chatInput").value = "";
  pushMsg(aiSuggest(v), "bot");
};
$("chatInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("sendChat").click(); });

/* =========================
   ACTIONS
========================= */
$("apply").onclick = ()=>{ applyFilters(true); location.hash="#explore"; };
$("reset").onclick = ()=>{
  $("q").value = "";
  $("district").value="all";
  $("type").value="all";
  $("days").value="0";
  applyFilters(true);
};
$("openAdmin").onclick = ()=>{ window.location.href = "admin.html"; };
$("collapseAll").onclick = collapseAllTypes;

$("district").addEventListener("change", ()=> $("builderLine").textContent = "District updated. Click Get Packages.");
$("type").addEventListener("change", ()=> $("builderLine").textContent = "Type updated. Click Get Packages.");
$("days").addEventListener("change", ()=> $("builderLine").textContent = "Days updated. Click Get Packages.");

/* =========================
   INIT
========================= */
(async function init(){
  await loadPlaces();
  buildDistrictDropdown();

  $("status").textContent = allPlaces.length
    ? `Loaded ${allPlaces.length} places from Firebase /${dbPath}`
    : "No data loaded. Check RTDB rules + path.";

  shownPlaces = allPlaces.slice();
  applyFilters(false);

  // show mobile button only on small screens (CSS hides sidebar, but we also toggle this)
  const mq = window.matchMedia("(max-width: 980px)");
  function syncMobileBtn(){
    $("openSideMobile").style.display = mq.matches ? "inline-flex" : "none";
  }
  mq.addEventListener?.("change", syncMobileBtn);
  syncMobileBtn();
})();
</script>
</body>
</html>