<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Packages (Value Planner)</title>

  <!-- Leaflet (optional; map can be enabled later) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:rgba(11,18,32,.64);
      --stroke:rgba(11,18,32,.10);
      --shadow:0 14px 40px rgba(10,20,40,.10);
      --r:18px;
      --brand:#4f46e5;
      --brand2:#06b6d4;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;

      --sidebarW:300px;
      --topH:66px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(79,70,229,.10), transparent 55%),
                  radial-gradient(900px 700px at 85% 10%, rgba(6,182,212,.10), transparent 52%),
                  var(--bg);
    }

    /* Top bar */
    .topbar{
      height:var(--topH);
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      background:rgba(246,247,251,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:200px;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(79,70,229,.95), rgba(6,182,212,.85));
      box-shadow:0 12px 26px rgba(79,70,229,.20);
      display:grid; place-items:center;
      color:#fff; font-weight:900;
    }
    .brand h1{
      font-size:14px; margin:0; line-height:1.1;
      font-weight:900;
    }
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .tabs{
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.7);
      padding:10px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      display:flex; align-items:center; gap:8px;
      box-shadow:0 10px 25px rgba(10,20,40,.06);
    }
    .pill.active{
      border-color: rgba(79,70,229,.35);
      background: rgba(79,70,229,.10);
      color: #1a1a3d;
    }
    .pillDot{
      width:9px; height:9px; border-radius:99px;
      background: rgba(11,18,32,.25);
    }
    .pill.active .pillDot{ background: var(--brand); }

    .rightTools{
      display:flex; align-items:center; gap:8px;
    }
    .btn{
      border:1px solid var(--stroke);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      box-shadow:0 10px 25px rgba(10,20,40,.06);
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(79,70,229,.95), rgba(6,182,212,.85));
      border: none;
      color:#fff;
    }

    /* Layout */
    .wrap{
      display:grid;
      grid-template-columns: var(--sidebarW) 1fr;
      gap:14px;
      padding:14px;
      max-width:1300px;
      margin:0 auto;
    }

    /* Sidebar */
    .sidebar{
      background:rgba(255,255,255,.75);
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:12px;
      position:sticky;
      top: calc(var(--topH) + 14px);
      height: calc(100vh - var(--topH) - 28px);
      overflow:auto;
    }
    .sideHead{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; padding:8px 6px 12px;
    }
    .sideHead .title{
      font-weight:900;
      font-size:14px;
    }
    .search{
      width:100%;
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      background:rgba(255,255,255,.85);
      font-weight:650;
    }
    .section{
      margin-top:10px;
      border-top:1px solid var(--stroke);
      padding-top:10px;
    }
    .section h3{
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:.3px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .filterRow{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .chip{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.8);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:750;
      cursor:pointer;
      user-select:none;
    }
    .chip.on{
      border-color: rgba(79,70,229,.35);
      background: rgba(79,70,229,.10);
    }

    /* Main panel */
    .main{
      background:rgba(255,255,255,.75);
      border:1px solid var(--stroke);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: calc(100vh - var(--topH) - 28px);
    }
    .mainHead{
      padding:14px 14px 10px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--stroke);
      background:rgba(255,255,255,.65);
      backdrop-filter: blur(10px);
    }
    .mainHeadLeft{
      display:flex; flex-direction:column; gap:4px;
    }
    .mainTitle{
      font-weight:950;
      font-size:16px;
      margin:0;
    }
    .mainHint{
      font-size:12px;
      color:var(--muted);
      margin:0;
    }
    .badge{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.8);
      font-weight:850;
      font-size:12px;
      white-space:nowrap;
    }
    .badgeDot{
      width:9px; height:9px; border-radius:999px;
      background:var(--brand2);
      box-shadow:0 0 0 4px rgba(6,182,212,.15);
    }

    .list{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Cards (packages + places) */
    .card{
      display:grid;
      grid-template-columns: 74px 1fr;
      gap:12px;
      padding:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.86);
      border-radius:18px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .card:hover{
      transform: translateY(-1px);
      box-shadow:0 18px 44px rgba(10,20,40,.10);
      border-color: rgba(79,70,229,.22);
    }
    .media{
      width:74px; height:74px;
      border-radius:18px;
      background: linear-gradient(135deg, rgba(79,70,229,.22), rgba(6,182,212,.18));
      border:1px solid rgba(79,70,229,.12);
    }
    .body{
      display:flex; flex-direction:column; gap:6px;
      min-width:0;
    }
    .titleRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .title{
      font-weight:950;
      font-size:15px;
      line-height:1.2;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      font-weight:750;
      white-space:nowrap;
    }
    .desc{
      font-size:13px;
      color: rgba(11,18,32,.78);
      font-weight:650;
      line-height:1.35;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:2px;
    }
    .tag{
      font-size:12px;
      font-weight:850;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(11,18,32,.04);
      border:1px solid var(--stroke);
    }
    .tag.good{ background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.25); }
    .tag.mid{ background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.25); }
    .tag.high{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); }

    /* Package header in detail view */
    .detailTop{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .detailRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .detailRow .left{
      display:flex; flex-direction:column; gap:3px;
      min-width:0;
    }
    .detailTitle{
      font-size:16px;
      font-weight:950;
      margin:0;
    }
    .detailSub{
      font-size:12px;
      color:var(--muted);
      font-weight:750;
      margin:0;
    }

    /* Mobile: sidebar becomes drawer */
    .menuBtn{ display:none; }
    .drawerOverlay{
      position:fixed; inset:0; z-index:90;
      background:rgba(0,0,0,.35);
      display:none;
    }
    .drawer{
      position:fixed;
      top:0; left:0;
      height:100%;
      width:min(92vw, 360px);
      z-index:95;
      transform: translateX(-110%);
      transition: transform .18s ease;
      background:rgba(255,255,255,.92);
      border-right:1px solid var(--stroke);
      box-shadow:0 18px 70px rgba(0,0,0,.25);
      padding:12px;
      overflow:auto;
    }
    .drawer.open{ transform: translateX(0); }
    .drawerOverlay.show{ display:block; }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
      .menuBtn{ display:inline-flex; }
      .brand p{ display:none; }
      .tabs{ display:none; } /* keep clean on mobile */
    }
    @media (max-width: 520px){
      .card{ grid-template-columns: 64px 1fr; }
      .media{ width:64px; height:64px; border-radius:16px; }
      .title{ font-size:14px; }
    }
  </style>
</head>

<body>
  <!-- Mobile drawer -->
  <div id="overlay" class="drawerOverlay" onclick="closeDrawer()"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="sideHead">
      <div class="title">Filters</div>
      <button class="btn" onclick="closeDrawer()">Close</button>
    </div>
    <input id="q_m" class="search" placeholder="Search (package/place)…" oninput="onSearch(this.value)" />
    <div class="section">
      <h3>District focus</h3>
      <div id="districtChips_m" class="filterRow"></div>
    </div>
    <div class="section">
      <h3>Trip length</h3>
      <div id="daysChips_m" class="filterRow"></div>
    </div>
    <div class="section">
      <h3>Budget</h3>
      <div id="budgetChips_m" class="filterRow"></div>
    </div>
  </aside>

  <!-- Top bar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">HP</div>
      <div>
        <h1>Himachal Explorer</h1>
        <p>Value packages • fast search • mobile friendly</p>
      </div>
    </div>

    <div class="tabs">
      <div class="pill active"><span class="pillDot"></span> Explore</div>
      <div class="pill"><span class="pillDot"></span> AI Planner</div>
      <div class="pill"><span class="pillDot"></span> Admin</div>
    </div>

    <div class="rightTools">
      <button class="btn menuBtn" onclick="openDrawer()">☰ Filters</button>
      <button class="btn" onclick="resetAll()">Reset</button>
      <button class="btn primary" onclick="goAdmin()">Admin</button>
    </div>
  </header>

  <!-- Main grid -->
  <main class="wrap">
    <!-- Desktop sidebar -->
    <aside class="sidebar">
      <div class="sideHead">
        <div class="title">Filters</div>
        <span class="badge"><span class="badgeDot"></span><span id="statusText">Loading…</span></span>
      </div>

      <input id="q" class="search" placeholder="Search (package/place)…" oninput="onSearch(this.value)" />

      <div class="section">
        <h3>District focus</h3>
        <div id="districtChips" class="filterRow"></div>
      </div>

      <div class="section">
        <h3>Trip length</h3>
        <div id="daysChips" class="filterRow"></div>
      </div>

      <div class="section">
        <h3>Budget</h3>
        <div id="budgetChips" class="filterRow"></div>
      </div>

      <div class="section">
        <h3>Quick</h3>
        <div class="filterRow">
          <span class="chip" onclick="setPreset('weekend')">Weekend</span>
          <span class="chip" onclick="setPreset('family')">Family</span>
          <span class="chip" onclick="setPreset('adventure')">Adventure</span>
          <span class="chip" onclick="setPreset('culture')">Culture</span>
        </div>
      </div>
    </aside>

    <!-- Main panel -->
    <section class="main">
      <div class="mainHead">
        <div class="mainHeadLeft">
          <h2 id="mainTitle" class="mainTitle">Packages</h2>
          <p id="mainHint" class="mainHint">Click a package to view covered locations (then click a location to open place.html)</p>
        </div>
        <div class="badge">
          <span class="badgeDot"></span>
          <span id="countText">0</span>
        </div>
      </div>

      <div id="list" class="list"></div>
    </section>
  </main>

<script>
/* ==========================
   CONFIG (EDIT THESE)
========================== */

// If you already use Firebase config in your project, paste it here.
// Otherwise leave empty {} and it will use sample data.
const FIREBASE_CONFIG = {
  // apiKey: "...",
  // authDomain: "...",
  // databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
  // projectId: "...",
};

// If your databaseURL is set in FIREBASE_CONFIG, choose your node here:
const FIREBASE_NODE = "locations";

/* ==========================
   SAMPLE DATA (fallback)
========================== */
const SAMPLE_PLACES = [
  { "Location Name":"Annandale", District:"Shimla", Type:"Destination", "Brief Description":"Historic playground and open ground." },
  { "Location Name":"Kufri", District:"Shimla", Type:"Activity", "Brief Description":"Snow views, horse rides, family fun." },
  { "Location Name":"Naldehra", District:"Shimla", Type:"Destination", "Brief Description":"Golf course, forest walks." },
  { "Location Name":"Mashobra", District:"Shimla", Type:"Destination", "Brief Description":"Quiet hills near Shimla." },

  { "Location Name":"Manali", District:"Kullu", Type:"Destination", "Brief Description":"Classic mountain town, cafes, views." },
  { "Location Name":"Solang Valley", District:"Kullu", Type:"Activity", "Brief Description":"Adventure sports and snow activities." },
  { "Location Name":"Kasol", District:"Kullu", Type:"Destination", "Brief Description":"Riverside cafes, base for treks." },
  { "Location Name":"Naggar Castle", District:"Kullu", Type:"Destination", "Brief Description":"Heritage + views + culture." },

  { "Location Name":"McLeod Ganj", District:"Kangra", Type:"Destination", "Brief Description":"Tibetan culture, cafes, views." },
  { "Location Name":"Dharamshala", District:"Kangra", Type:"Destination", "Brief Description":"Cricket, monasteries, calm vibe." },
  { "Location Name":"Kangra Fort", District:"Kangra", Type:"Destination", "Brief Description":"Historic fort with panoramic views." },

  { "Location Name":"Dalhousie", District:"Chamba", Type:"Destination", "Brief Description":"Colonial charm + scenic walks." },
  { "Location Name":"Khajjiar", District:"Chamba", Type:"Lake", "Brief Description":"Mini Switzerland meadows + lake." },

  { "Location Name":"Kaza", District:"Lahaul and Spiti", Type:"Destination", "Brief Description":"Spiti base town for monasteries." },
  { "Location Name":"Key Monastery", District:"Lahaul and Spiti", Type:"Temple", "Brief Description":"Iconic monastery with valley views." },
  { "Location Name":"Kibber", District:"Lahaul and Spiti", Type:"Destination", "Brief Description":"High village, wildlife, views." },
];

/* ==========================
   PACKAGES (4–5 default)
========================== */
const DEFAULT_PACKAGES = [
  {
    id: "pkg_weekend_shimla",
    title: "Weekend Shimla Value Pack",
    subtitle: "2 Days • ₹₹ • Best for quick escape",
    days: 2,
    budget: "₹₹",
    districts: ["Shimla", "Solan"],
    includeTypes: ["Destination", "Temple", "Activity", "Lake"],
    mustHave: ["Shimla", "Kufri", "Naldehra", "Mashobra"],
    limit: 10,
    hero: "Fast • Budget-friendly • Family friendly"
  },
  {
    id: "pkg_kullu_manali",
    title: "Kullu–Manali Classic Saver",
    subtitle: "3 Days • ₹₹₹ • Mountains + activities",
    days: 3,
    budget: "₹₹₹",
    districts: ["Kullu"],
    includeTypes: ["Destination", "Activity", "Temple", "Trek"],
    mustHave: ["Manali", "Solang", "Naggar", "Kasol"],
    limit: 12,
    hero: "Adventure • Cafes • Great value route"
  },
  {
    id: "pkg_kangra_dharamshala",
    title: "Dharamshala–Kangra Culture Pack",
    subtitle: "3 Days • ₹₹ • Monasteries + heritage",
    days: 3,
    budget: "₹₹",
    districts: ["Kangra"],
    includeTypes: ["Temple", "Destination", "Activity", "Lake"],
    mustHave: ["Dharamshala", "McLeod", "Kangra Fort"],
    limit: 12,
    hero: "Culture • Calm • Best budget experience"
  },
  {
    id: "pkg_chamba_dalhousie",
    title: "Dalhousie–Chamba Scenic Pack",
    subtitle: "3 Days • ₹₹ • Nature + viewpoints",
    days: 3,
    budget: "₹₹",
    districts: ["Chamba"],
    includeTypes: ["Destination", "Lake", "Temple", "Activity"],
    mustHave: ["Dalhousie", "Khajjiar"],
    limit: 12,
    hero: "Scenic • Relaxed pace • Value stay"
  },
  {
    id: "pkg_spiti_starter",
    title: "Spiti Starter (Smart Budget)",
    subtitle: "5 Days • ₹₹₹₹ • High altitude highlights",
    days: 5,
    budget: "₹₹₹₹",
    districts: ["Lahaul and Spiti"],
    includeTypes: ["Destination", "Temple", "Trek", "Lake"],
    mustHave: ["Kaza", "Key", "Kibber"],
    limit: 10,
    hero: "Unique landscapes • Minimal rush • Iconic spots"
  }
];

/* ==========================
   STATE
========================== */
const state = {
  allPlaces: [],
  search: "",
  selDistrict: "",   // one district at a time for simplicity
  selDays: "",       // "2", "3", "5"
  selBudget: "",     // "₹₹", "₹₹₹", "₹₹₹₹"
  view: "packages",  // "packages" | "packageDetail"
  activePkg: null,
  activeCovered: [],
};

/* ==========================
   UTILS
========================== */
function norm(s){ return String(s||"").trim().toLowerCase(); }
function getName(p){ return p["Location Name"] || p.Name || p.name || p.title || "Untitled"; }
function getDistrict(p){ return p.District || p.district || ""; }
function getType(p){ return p.Type || p.type || p.Category || p.category || ""; }
function getDesc(p){ return p["Brief Description"] || p.Description || p.description || ""; }

function budgetClass(b){
  if(b==="₹₹") return "good";
  if(b==="₹₹₹") return "mid";
  return "high";
}

/* ==========================
   FIREBASE LOAD (optional)
========================== */
async function loadPlaces(){
  try{
    if(!FIREBASE_CONFIG || !FIREBASE_CONFIG.databaseURL){
      setStatus("Using sample data");
      return SAMPLE_PLACES.slice();
    }
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();
    const snap = await db.ref(FIREBASE_NODE).once("value");
    const val = snap.val();
    if(!val){
      setStatus("Firebase empty → sample data");
      return SAMPLE_PLACES.slice();
    }

    // If your data is keyed object {key:{...}, key2:{...}}
    const arr = Array.isArray(val) ? val : Object.values(val);
    const clean = arr.filter(Boolean);

    setStatus("Loaded from Firebase");
    return clean.length ? clean : SAMPLE_PLACES.slice();
  }catch(e){
    console.warn(e);
    setStatus("Firebase error → sample data");
    return SAMPLE_PLACES.slice();
  }
}

/* ==========================
   PACKAGE PICKER
========================== */
function pickPlacesForPackage(allPlaces, pkg){
  const districtsWanted = (pkg.districts||[]).map(norm);
  const typesWanted = (pkg.includeTypes||[]).map(norm);

  let candidates = allPlaces.filter(p=>{
    const d = norm(getDistrict(p));
    const t = norm(getType(p));
    const okDistrict = !districtsWanted.length || districtsWanted.includes(d);
    const okType = !typesWanted.length || typesWanted.includes(t);
    return okDistrict && okType;
  });

  const must = (pkg.mustHave||[]).map(norm);
  const mustHits = [];
  const rest = [];

  for(const p of candidates){
    const n = norm(getName(p));
    if(must.some(m => n.includes(m))) mustHits.push(p);
    else rest.push(p);
  }

  // variety-ish: group by type, then interleave
  const buckets = {};
  for(const p of rest){
    const t = norm(getType(p) || "other");
    (buckets[t] ||= []).push(p);
  }
  const types = Object.keys(buckets).sort();
  const interleaved = [];
  let added = true;
  while(added){
    added = false;
    for(const t of types){
      if(buckets[t].length){
        interleaved.push(buckets[t].shift());
        added = true;
      }
    }
  }

  const merged = [...mustHits, ...interleaved];

  const unique = [];
  const seen = new Set();
  for(const p of merged){
    const key = norm(getName(p));
    if(seen.has(key)) continue;
    seen.add(key);
    unique.push(p);
    if(unique.length >= (pkg.limit||10)) break;
  }
  return unique;
}

/* ==========================
   FILTER CHIPS
========================== */
function uniqueDistricts(places){
  const s = new Set();
  places.forEach(p=>{ const d=getDistrict(p); if(d) s.add(d); });
  return Array.from(s).sort((a,b)=>a.localeCompare(b));
}
function renderChips(){
  const dList = uniqueDistricts(state.allPlaces).slice(0, 18); // keep tidy

  const districtsTargets = [
    {id:"districtChips", list:dList},
    {id:"districtChips_m", list:dList},
  ];
  districtsTargets.forEach(({id,list})=>{
    const el = document.getElementById(id);
    el.innerHTML = "";
    const any = document.createElement("span");
    any.className = "chip " + (state.selDistrict==="" ? "on": "");
    any.textContent = "Any";
    any.onclick = ()=>{ state.selDistrict=""; rerender(); };
    el.appendChild(any);

    list.forEach(d=>{
      const c = document.createElement("span");
      c.className = "chip " + (state.selDistrict===d ? "on" : "");
      c.textContent = d;
      c.onclick = ()=>{ state.selDistrict = (state.selDistrict===d ? "" : d); rerender(); };
      el.appendChild(c);
    });
  });

  const days = ["2","3","5"];
  const daysTargets = [
    {id:"daysChips", list:days},
    {id:"daysChips_m", list:days},
  ];
  daysTargets.forEach(({id,list})=>{
    const el = document.getElementById(id);
    el.innerHTML = "";
    ["Any", ...list].forEach(v=>{
      const key = (v==="Any") ? "" : v;
      const c = document.createElement("span");
      c.className = "chip " + (state.selDays===key ? "on" : "");
      c.textContent = (v==="Any") ? "Any" : (v+" Days");
      c.onclick = ()=>{ state.selDays = (state.selDays===key ? "" : key); rerender(); };
      el.appendChild(c);
    });
  });

  const budgets = ["₹₹","₹₹₹","₹₹₹₹"];
  const budgetTargets = [
    {id:"budgetChips", list:budgets},
    {id:"budgetChips_m", list:budgets},
  ];
  budgetTargets.forEach(({id,list})=>{
    const el = document.getElementById(id);
    el.innerHTML = "";
    ["Any", ...list].forEach(v=>{
      const key = (v==="Any") ? "" : v;
      const c = document.createElement("span");
      c.className = "chip " + (state.selBudget===key ? "on" : "");
      c.textContent = (v==="Any") ? "Any" : v;
      c.onclick = ()=>{ state.selBudget = (state.selBudget===key ? "" : key); rerender(); };
      el.appendChild(c);
    });
  });
}

/* ==========================
   RENDER PACKAGES
========================== */
function filteredPackages(){
  let pkgs = DEFAULT_PACKAGES.slice();

  if(state.selDays){
    pkgs = pkgs.filter(p => String(p.days) === String(state.selDays));
  }
  if(state.selBudget){
    pkgs = pkgs.filter(p => p.budget === state.selBudget);
  }
  if(state.selDistrict){
    pkgs = pkgs.filter(p => (p.districts||[]).some(d=>norm(d)===norm(state.selDistrict)));
  }
  if(state.search){
    const q = norm(state.search);
    pkgs = pkgs.filter(p =>
      norm(p.title).includes(q) ||
      norm(p.subtitle).includes(q) ||
      norm((p.districts||[]).join(" ")).includes(q)
    );
  }
  return pkgs;
}

function renderPackagesView(){
  state.view = "packages";
  state.activePkg = null;
  state.activeCovered = [];

  document.getElementById("mainTitle").textContent = "Packages";
  document.getElementById("mainHint").textContent = "Click a package to view covered locations (then click a location to open place.html)";

  const list = document.getElementById("list");
  list.innerHTML = "";

  const pkgs = filteredPackages();

  document.getElementById("countText").textContent = pkgs.length + " packages";

  if(!pkgs.length){
    list.innerHTML = `<div class="detailTop">
      <div style="font-weight:900;">No packages match your filters.</div>
      <div style="color:var(--muted);font-weight:700;">Try Reset or select “Any”.</div>
    </div>`;
    return;
  }

  pkgs.forEach(pkg=>{
    const covered = pickPlacesForPackage(state.allPlaces, pkg);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="media"></div>
      <div class="body">
        <div class="titleRow">
          <div class="title">${pkg.title}</div>
          <div class="meta">${pkg.days}D</div>
        </div>
        <p class="desc">${pkg.hero}</p>
        <div class="chips">
          <span class="tag ${budgetClass(pkg.budget)}">${pkg.budget}</span>
          <span class="tag">${(pkg.districts||[]).join(", ")}</span>
          <span class="tag">Covers ${covered.length} places</span>
        </div>
      </div>
    `;
    card.onclick = ()=> openPackageDetail(pkg, covered);
    list.appendChild(card);
  });
}

/* ==========================
   PACKAGE DETAIL VIEW
========================== */
function openPackageDetail(pkg, covered){
  state.view = "packageDetail";
  state.activePkg = pkg;
  state.activeCovered = covered;

  document.getElementById("mainTitle").textContent = "Package Plan";
  document.getElementById("mainHint").textContent = "Covered locations (click any location to open place.html)";

  const list = document.getElementById("list");
  list.innerHTML = "";

  const top = document.createElement("div");
  top.className = "detailTop";
  top.innerHTML = `
    <div class="detailRow">
      <div class="left">
        <h3 class="detailTitle">${pkg.title}</h3>
        <p class="detailSub">${pkg.subtitle} • Districts: ${(pkg.districts||[]).join(", ")}</p>
      </div>
      <button class="btn" onclick="renderPackagesView()">← Back</button>
    </div>
    <div class="chips">
      <span class="tag ${budgetClass(pkg.budget)}">${pkg.budget}</span>
      <span class="tag">${pkg.days} Days</span>
      <span class="tag">Places: ${covered.length}</span>
    </div>
  `;
  list.appendChild(top);

  document.getElementById("countText").textContent = covered.length + " places";

  // Apply search filter on covered list (optional)
  let shown = covered;
  if(state.search){
    const q = norm(state.search);
    shown = covered.filter(p =>
      norm(getName(p)).includes(q) ||
      norm(getDistrict(p)).includes(q) ||
      norm(getType(p)).includes(q)
    );
  }

  if(!shown.length){
    const empty = document.createElement("div");
    empty.className = "detailTop";
    empty.innerHTML = `<div style="font-weight:900;">No covered places match search.</div>`;
    list.appendChild(empty);
    return;
  }

  shown.forEach(p=>{
    const name = getName(p);
    const district = getDistrict(p);
    const type = getType(p);
    const desc = getDesc(p);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="media"></div>
      <div class="body">
        <div class="titleRow">
          <div class="title">${name}</div>
          <div class="meta">${district || ""}</div>
        </div>
        <p class="desc">${desc || "Click to open details page."}</p>
        <div class="chips">
          <span class="tag">${type || "Place"}</span>
          ${district ? `<span class="tag">${district}</span>` : ``}
        </div>
      </div>
    `;
    card.onclick = ()=>{
      const q = encodeURIComponent(name);
      window.location.href = `place.html?name=${q}`;
    };
    document.getElementById("list").appendChild(card);
  });
}

/* ==========================
   EVENTS / ACTIONS
========================== */
function setStatus(text){
  const el = document.getElementById("statusText");
  if(el) el.textContent = text;
}
function onSearch(v){
  state.search = v || "";
  // keep desktop + mobile in sync
  const q = document.getElementById("q");
  const qm = document.getElementById("q_m");
  if(document.activeElement !== q && q) q.value = state.search;
  if(document.activeElement !== qm && qm) qm.value = state.search;
  rerender();
}

function rerender(){
  renderChips();
  if(state.view === "packageDetail" && state.activePkg){
    // rebuild covered using latest places (safe)
    const covered = pickPlacesForPackage(state.allPlaces, state.activePkg);
    openPackageDetail(state.activePkg, covered);
  }else{
    renderPackagesView();
  }
}

function resetAll(){
  state.search = "";
  state.selDistrict = "";
  state.selDays = "";
  state.selBudget = "";
  const q = document.getElementById("q");
  const qm = document.getElementById("q_m");
  if(q) q.value = "";
  if(qm) qm.value = "";
  renderPackagesView();
  renderChips();
}

function setPreset(preset){
  // quick presets: adjust filters
  if(preset==="weekend"){
    state.selDays = "2";
    state.selBudget = "₹₹";
  }
  if(preset==="family"){
    state.selBudget = "₹₹";
  }
  if(preset==="adventure"){
    state.selBudget = "₹₹₹";
  }
  if(preset==="culture"){
    state.selDistrict = "Kangra";
  }
  rerender();
}

function goAdmin(){
  // change if your admin page is different
  window.location.href = "admin.html";
}

/* Drawer (mobile) */
function openDrawer(){
  document.getElementById("overlay").classList.add("show");
  document.getElementById("drawer").classList.add("open");
}
function closeDrawer(){
  document.getElementById("overlay").classList.remove("show");
  document.getElementById("drawer").classList.remove("open");
}

/* ==========================
   INIT
========================== */
(async function init(){
  setStatus("Loading…");
  const places = await loadPlaces();
  state.allPlaces = (places || []).filter(Boolean);

  setStatus(`Ready • ${state.allPlaces.length} places`);
  renderChips();
  renderPackagesView();
})();
</script>

</body>
</html>