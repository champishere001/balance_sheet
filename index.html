<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer ‚Ä¢ Premium District Guide</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050712;
      --bg1:#080B18;
      --ink:#ECF2FF;
      --muted:rgba(236,242,255,.72);
      --muted2:rgba(236,242,255,.56);
      --stroke:rgba(255,255,255,.12);
      --glass:rgba(255,255,255,.06);
      --glass2:rgba(0,0,0,.28);
      --brand:#FF7A18;
      --brand2:#FFB04A;
      --aqua:#00D2FF;
      --violet:#786EFF;
      --shadow: 0 28px 80px rgba(0,0,0,.62);
      --shadow2: 0 14px 30px rgba(0,0,0,.48);
      --r12:12px; --r16:16px; --r20:20px; --r24:24px; --r28:28px;
      --blur: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Manrope",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 900px at 18% 8%, rgba(255,122,24,.18), transparent 60%),
        radial-gradient(900px 700px at 92% 18%, rgba(120,110,255,.16), transparent 55%),
        radial-gradient(900px 700px at 70% 96%, rgba(0,210,255,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Subtle animated grain */
    body:before{
      content:"";
      position:fixed; inset:-40%;
      background-image:url("https://www.transparenttextures.com/patterns/asfalt-light.png");
      opacity:.06;
      transform:rotate(6deg);
      pointer-events:none;
      z-index:0;
      animation: grain 10s infinite linear;
    }
    @keyframes grain{
      0%{transform:translate3d(-2%, -1%, 0) rotate(6deg)}
      50%{transform:translate3d(2%, 1%, 0) rotate(6deg)}
      100%{transform:translate3d(-2%, -1%, 0) rotate(6deg)}
    }

    /* Layout */
    .shell{
      position:relative;
      z-index:1;
      padding:16px;
      max-width: 1320px;
      margin: 0 auto;
    }

    /* HERO (cinematic) */
    .hero{
      border-radius: 34px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background:rgba(255,255,255,.04);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      position:relative;
      isolation:isolate;
    }
    .heroBg{
      position:absolute; inset:0;
      background-size:cover;
      background-position:center;
      transform:scale(1.06);
      filter:saturate(1.1) contrast(1.06);
      opacity:.62;
      z-index:0;
    }
    .heroShade{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 500px at 18% 20%, rgba(255,122,24,.20), transparent 60%),
        radial-gradient(700px 420px at 85% 30%, rgba(0,210,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(5,7,18,.10), rgba(5,7,18,.82) 55%, rgba(5,7,18,.96));
      z-index:1;
    }
    .heroInner{
      position:relative;
      z-index:2;
      padding: 20px;
    }

    .topBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow2);
    }
    .brandDot{
      width:10px; height:10px; border-radius:50%;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 0 24px rgba(255,122,24,.55);
    }
    .brandTitle{font-weight:950; letter-spacing:-.2px}
    .brandSub{font-size:12px; color:var(--muted); font-weight:800}

    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      padding:10px 12px;
      color:rgba(236,242,255,.92);
      font-weight:900;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
    }
    .pill b{font-size:12px}
    .search{
      min-width: 260px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.24);
      padding:12px 14px;
      color: var(--ink);
      outline:none;
      font-weight:850;
      box-shadow: 0 10px 20px rgba(0,0,0,.28);
    }
    .search:focus{
      border-color: rgba(255,122,24,.45);
      box-shadow: 0 0 0 5px rgba(255,122,24,.12), 0 10px 20px rgba(0,0,0,.28);
    }

    .heroGrid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.45fr 1fr;
      gap:14px;
    }

    .headline{
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding:18px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .headline:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(500px 200px at 20% 0%, rgba(255,122,24,.18), transparent 60%),
        radial-gradient(450px 200px at 90% 10%, rgba(120,110,255,.16), transparent 60%),
        radial-gradient(600px 240px at 55% 105%, rgba(0,210,255,.10), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .headlineInner{position:relative}
    .kicker{
      font-size:12px;
      color: rgba(236,242,255,.76);
      font-weight:950;
      letter-spacing:.22em;
      text-transform:uppercase;
    }
    .h1{
      margin:8px 0 0;
      font-size: clamp(26px, 3.2vw, 44px);
      font-weight:950;
      letter-spacing:-.5px;
      line-height:1.08;
    }
    .h1 span{
      background: linear-gradient(135deg, rgba(255,122,24,.95), rgba(255,176,74,.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .desc{
      margin:10px 0 0;
      color: rgba(236,242,255,.82);
      line-height:1.6;
      font-weight:650;
      max-width: 60ch;
    }

    .quoteCard{
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding:18px;
      box-shadow: var(--shadow2);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:12px;
    }
    .quote{
      margin:0;
      font-weight:950;
      font-size: 15px;
      line-height:1.55;
    }
    .quoteBy{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      color: var(--muted);
      font-weight:850;
      font-size:12px;
    }
    .glowBtn{
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(236,242,255,.92);
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
      transition:.18s transform ease, .18s border-color ease, .18s background ease;
    }
    .glowBtn:hover{
      transform: translateY(-2px);
      border-color: rgba(255,122,24,.45);
      background: rgba(255,122,24,.14);
      box-shadow: 0 0 0 4px rgba(255,122,24,.10);
    }

    /* District Cards: THE WOW GRID */
    .districtStrip{
      margin-top: 14px;
      border-radius: 34px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .stripHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .stripHead b{font-weight:950; letter-spacing:.2px}
    .hint{color:var(--muted); font-weight:800; font-size:12px}

    .districtGrid{
      padding:16px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:14px;
    }
    .dCard{
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      cursor:pointer;
      position:relative;
      box-shadow: 0 16px 36px rgba(0,0,0,.42);
      transition: .22s transform ease, .22s border-color ease, .22s box-shadow ease;
      transform: translateZ(0);
    }
    .dCard:hover{
      transform: translateY(-6px) scale(1.01);
      border-color: rgba(255,255,255,.22);
      box-shadow: 0 22px 50px rgba(0,0,0,.54);
    }
    .dCard.active{
      border-color: rgba(255,122,24,.52);
      box-shadow: 0 0 0 1px rgba(255,122,24,.22) inset, 0 22px 50px rgba(0,0,0,.58);
    }
    .dThumb{
      height: 120px;
      background-size:cover;
      background-position:center;
      position:relative;
    }
    .dThumb:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.68));
    }
    .dMeta{
      padding:14px 14px 14px;
      background: rgba(0,0,0,.22);
    }
    .dName{
      font-weight: 950;
      letter-spacing:-.2px;
    }
    .dLine{
      margin-top:6px;
      color: var(--muted);
      font-weight:850;
      font-size:12px;
      line-height:1.35;
      min-height: 34px;
    }
    .dBadges{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:900;
      font-size:11px;
      color: rgba(236,242,255,.92);
    }
    .chip.hot{
      border-color: rgba(255,122,24,.32);
      background: rgba(255,122,24,.12);
    }

    /* Content area: map + story */
    .content{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:14px;
      align-items:start;
    }

    /* Story panel */
    .story{
      border-radius: 34px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .storyCover{
      position:absolute; inset:0;
      background-size:cover;
      background-position:center;
      filter: blur(22px) saturate(1.05);
      transform: scale(1.08);
      opacity:.22;
      pointer-events:none;
    }
    .storyTop{
      position:relative;
      padding:16px;
      background: rgba(0,0,0,.22);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .storyTitle{
      margin:0;
      font-size: clamp(20px, 2.2vw, 34px);
      font-weight: 950;
      letter-spacing:-.4px;
    }
    .storySub{
      margin:10px 0 0;
      color: rgba(236,242,255,.84);
      line-height: 1.6;
      font-weight:650;
    }
    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .pillMini{
      padding:8px 11px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      font-weight:900;
      font-size:12px;
      color: rgba(236,242,255,.92);
    }

    .block{
      padding: 14px 16px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .blockHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .blockHead b{font-size:13px; letter-spacing:.2px}
    .count{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-weight:900;
      font-size:12px;
    }
    .text{
      margin-top:12px;
      color: rgba(236,242,255,.92);
      line-height:1.75;
      font-weight:650;
    }

    /* Place cards */
    .section{
      margin-top:12px;
    }
    .placesGrid{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    .pCard{
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      cursor:pointer;
      transition:.20s transform ease, .20s border-color ease, .20s box-shadow ease;
      box-shadow: 0 12px 22px rgba(0,0,0,.28);
    }
    .pCard:hover{
      transform: translateY(-4px);
      border-color: rgba(255,255,255,.20);
      box-shadow: 0 18px 32px rgba(0,0,0,.38);
    }
    .pThumb{
      height: 132px;
      background-size:cover;
      background-position:center;
      position:relative;
    }
    .pThumb:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.62));
    }
    .pBadge{
      position:absolute;
      top:10px; left:10px;
      z-index:2;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
      font-size:11px;
      font-weight:950;
    }
    .pBody{padding:12px}
    .pTitle{font-weight:950}
    .pMeta{
      margin-top:6px;
      color: var(--muted);
      font-weight:850;
      font-size:12px;
      line-height:1.35;
    }
    .empty{
      margin-top:12px;
      padding:16px;
      border-radius: 20px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: rgba(236,242,255,.88);
      font-weight:850;
    }

    /* Map column (secondary) */
    .map{
      position: sticky;
      top: 16px;
      height: calc(100vh - 32px);
      border-radius: 34px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .mapHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .mapHead b{font-size:13px; letter-spacing:.2px}
    .mapHead .mHint{
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      line-height:1.35;
      max-width: 220px;
      text-align:right;
    }
    .mapFrame{flex:1; min-height:0}
    iframe{width:100%; height:100%; border:0; background:rgba(0,0,0,.2)}

    /* Floating district dock (shows when scrolled) */
    .dockBtn{
      position:fixed;
      left:16px; bottom:16px;
      z-index:1000;
      display:none;
      padding:12px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(16px);
      color: rgba(236,242,255,.92);
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(0,0,0,.55);
      transition:.18s transform ease, .18s border-color ease;
    }
    .dockBtn:hover{transform:translateY(-2px); border-color: rgba(255,122,24,.45)}
    .dock{
      position:fixed;
      left:16px; right:16px; bottom:70px;
      z-index:1000;
      display:none;
      max-height: 66vh;
      overflow:auto;
      border-radius: 28px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(18px);
      box-shadow: 0 28px 80px rgba(0,0,0,.65);
      padding: 14px;
    }
    .dockTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .dockTop b{font-weight:950}
    .closeBtn{
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color: rgba(236,242,255,.92);
      font-weight:950;
      cursor:pointer;
    }
    .dockGrid{grid-template-columns: repeat(3, minmax(0,1fr)); padding:0}

    /* Responsive */
    @media(max-width:1200px){
      .districtGrid{grid-template-columns: repeat(3, minmax(0, 1fr))}
      .placesGrid{grid-template-columns: repeat(2, minmax(0,1fr))}
      .content{grid-template-columns: 1fr}
      .map{position:relative; height:520px}
    }
    @media(max-width:620px){
      .heroGrid{grid-template-columns: 1fr}
      .districtGrid{grid-template-columns: repeat(2, minmax(0, 1fr))}
      .placesGrid{grid-template-columns: 1fr}
      .search{min-width: 0; width:100%}
    }

    /* motion */
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; animation:none !important}
    }
  </style>
</head>
<body>
  <div class="shell">
    <section class="hero" id="hero">
      <div class="heroBg" id="heroBg"></div>
      <div class="heroShade"></div>

      <div class="heroInner">
        <div class="topBar">
          <div class="brand">
            <div class="brandDot"></div>
            <div>
              <div class="brandTitle">Himachal Explorer</div>
              <div class="brandSub">A premium district guide ‚Ä¢ stories ‚Ä¢ curated places</div>
            </div>
          </div>

          <div class="actions">
            <div class="pill">‚ú® <b id="liveTitle">Select a district</b></div>
            <input class="search" id="q" placeholder="Search district‚Ä¶ (e.g., Shimla, Kullu, Kangra)">
          </div>
        </div>

        <div class="heroGrid">
          <div class="headline">
            <div class="headlineInner">
              <div class="kicker">HIMACHAL PRADESH</div>
              <div class="h1">Feel the <span>Himalayan calm</span> ‚Äî district by district.</div>
              <div class="desc">
                Tap a district card to open its story: brief, how to reach, and stunning places in categories.
                Map stays secondary ‚Äî but always ready.
              </div>
            </div>
          </div>

          <div class="quoteCard">
            <p class="quote" id="quote">‚ÄúWhere mountains whisper and rivers sing ‚Äî welcome to Himachal.‚Äù</p>
            <div class="quoteBy">
              <span id="quoteBy">‚Äî Himachal Explorer</span>
              <button class="glowBtn" id="newQuote">New quote</button>
            </div>
          </div>
        </div>

        <div class="districtStrip" id="districtStrip">
          <div class="stripHead">
            <b>Districts</b>
            <span class="hint">Cinematic cards ‚Ä¢ click to open story</span>
          </div>
          <div class="districtGrid" id="districtGrid">
            <div class="dCard">
              <div class="dThumb" style="background:#111"></div>
              <div class="dMeta">
                <div class="dName">Loading‚Ä¶</div>
                <div class="dLine">Fetching from Firebase‚Ä¶</div>
                <div class="dBadges"><span class="chip">Please wait</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="content">
          <div class="story" id="story">
            <div class="storyCover" id="storyCover"></div>

            <div class="storyTop">
              <h2 class="storyTitle" id="sTitle">Pick a district to begin</h2>
              <div class="storySub" id="sSub">
                Your visitor experience starts here ‚Äî district story, reach info, then curated categories.
              </div>
              <div class="pillRow" id="pillRow"></div>
            </div>

            <div class="block">
              <div class="blockHead"><b>District Brief</b><span class="count" id="briefTag">‚Äî</span></div>
              <div class="text" id="briefBox"><div class="empty">Select any district card above.</div></div>
            </div>

            <div class="block">
              <div class="blockHead"><b>How to Reach</b><span class="count" id="reachTag">‚Äî</span></div>
              <div class="text" id="reachBox"><div class="empty">We‚Äôll show road / rail / air guidance.</div></div>
            </div>

            <div class="block">
              <div class="blockHead"><b>Curated Places</b><span class="count" id="placesTag">‚Äî</span></div>
              <div id="placesWrap" class="text">
                <div class="empty">Destinations ‚Ä¢ Lakes ‚Ä¢ Temples ‚Ä¢ Treks ‚Ä¢ Hotels ‚Äî shown beautifully.</div>
              </div>
            </div>
          </div>

          <aside class="map">
            <div class="mapHead">
              <div>
                <b>Map (Secondary)</b>
              </div>
              <div class="mHint" id="mapHint">Tap a place card to focus the map.</div>
            </div>
            <div class="mapFrame">
              <iframe id="mapFrame" src="map.html" title="HP Map"></iframe>
            </div>
          </aside>
        </div>
      </div>
    </section>
  </div>

  <!-- Dock -->
  <button class="dockBtn" id="dockBtn">‚ò∞ Districts</button>
  <div class="dock" id="dock">
    <div class="dockTop">
      <b>Districts</b>
      <button class="closeBtn" id="dockClose">Close</button>
    </div>
    <input class="search" id="q2" placeholder="Search district‚Ä¶">
    <div class="districtGrid dockGrid" id="districtGrid2"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const db = getDatabase(app);

    const ROOT = "tourism/hp/districts";
    const TYPES = ["destinations","lakes","temples","treks","hotels"];
    const TYPE_LABEL = {
      destinations:"Destinations",
      lakes:"Lakes",
      temples:"Temples",
      treks:"Treks",
      hotels:"Hotels"
    };

    // Himachal-ish hero backgrounds
    const HERO = [
      "https://source.unsplash.com/1900x1100/?Himachal,Mountains",
      "https://source.unsplash.com/1900x1100/?Spiti,Valley",
      "https://source.unsplash.com/1900x1100/?Manali,Snow",
      "https://source.unsplash.com/1900x1100/?Dharamshala,Mountains",
      "https://source.unsplash.com/1900x1100/?Himachal,Lake",
      "https://source.unsplash.com/1900x1100/?Himalaya,Forest"
    ];

    const QUOTES = [
      {q:"Where mountains whisper and rivers sing ‚Äî welcome to Himachal.", by:"Himachal Explorer"},
      {q:"In Himachal, every bend of the road is a postcard.", by:"Travel Note"},
      {q:"Breathe deeper ‚Äî the Himalayas keep secrets in pine-scented air.", by:"Himalayan Diaries"},
      {q:"Chai tastes warmer when the view is colder.", by:"Hill Station Mood"},
      {q:"Let the peaks reset your mind.", by:"Slow Travel"},
      {q:"Some places don‚Äôt just look beautiful ‚Äî they heal you. Himachal does.", by:"Wander Lines"}
    ];

    // UI
    const heroBg = document.getElementById("heroBg");
    const storyCover = document.getElementById("storyCover");
    const q = document.getElementById("q");
    const q2 = document.getElementById("q2");
    const districtGrid = document.getElementById("districtGrid");
    const districtGrid2 = document.getElementById("districtGrid2");
    const dockBtn = document.getElementById("dockBtn");
    const dock = document.getElementById("dock");
    const dockClose = document.getElementById("dockClose");

    const liveTitle = document.getElementById("liveTitle");
    const quote = document.getElementById("quote");
    const quoteBy = document.getElementById("quoteBy");
    const newQuoteBtn = document.getElementById("newQuote");

    const sTitle = document.getElementById("sTitle");
    const sSub = document.getElementById("sSub");
    const pillRow = document.getElementById("pillRow");

    const briefBox = document.getElementById("briefBox");
    const reachBox = document.getElementById("reachBox");
    const placesWrap = document.getElementById("placesWrap");

    const briefTag = document.getElementById("briefTag");
    const reachTag = document.getElementById("reachTag");
    const placesTag = document.getElementById("placesTag");

    const mapFrame = document.getElementById("mapFrame");
    const mapHint = document.getElementById("mapHint");

    // State
    let ROOT_SNAP = {};
    let DISTRICTS = [];
    let PREVIEW = {};  // district -> top destinations names
    let COVER = {};    // district -> cover url
    let COUNT = {};    // district -> total count
    let ACTIVE = "";

    const safeObj = (x)=> (x && typeof x==="object") ? x : {};
    const norm = (s)=> String(s ?? "").trim();
    const low = (s)=> norm(s).toLowerCase();

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function normalizeType(t){
      const s = low(t);
      if(!s) return "";
      if(s==="destination" || s==="dest") return "destinations";
      if(s==="lake") return "lakes";
      if(s==="temple") return "temples";
      if(s==="trek") return "treks";
      if(s==="hotel") return "hotels";
      return s;
    }

    function extractPhotos(item){
      const a = [];
      const pushArr = (x)=> { if(Array.isArray(x)) x.forEach(u=>{ if(norm(u)) a.push(norm(u)); }); };
      pushArr(item.photos); pushArr(item.images); pushArr(item.gallery);
      if(norm(item.photoUrl)) a.push(norm(item.photoUrl));
      if(norm(item.imageUrl)) a.push(norm(item.imageUrl));
      if(norm(item.cover)) a.push(norm(item.cover));
      if(norm(item.photo)) a.push(norm(item.photo));
      if(norm(item.photo) && String(item.photo).includes("|")){
        String(item.photo).split("|").map(x=>x.trim()).filter(Boolean).forEach(u=>a.push(u));
      }
      return Array.from(new Set(a)).filter(Boolean);
    }

    function pickTitle(it){
      return it.name || it.title || it.place || it.placeName || it.locationName || "Untitled";
    }

    function countDistrict(dNode){
      const seg = safeObj(dNode?.segments);
      let total=0;
      for(const k of Object.keys(seg)){
        const t = normalizeType(k);
        if(!TYPES.includes(t)) continue;
        total += Object.keys(safeObj(seg[k])).length;
      }
      return total;
    }

    function computePreview(dNode){
      const seg = safeObj(dNode?.segments);
      const bucket = safeObj(seg?.destinations);
      const arr = Object.keys(bucket).map(id=>{
        const it = safeObj(bucket[id]);
        return {
          title: pickTitle(it),
          pop: Number(it.popularityScore ?? it.popularity ?? 0) || 0,
          rating: Number(it.rating ?? 0) || 0
        };
      });
      arr.sort((a,b)=> (b.pop-a.pop) || (b.rating-a.rating) || String(a.title).localeCompare(String(b.title)));
      return arr.slice(0,3).map(x=>x.title).filter(Boolean);
    }

    function pickCover(dNode){
      const info = safeObj(dNode?.districtInfo);
      const arr = [];
      if(Array.isArray(info.coverPhotos)) arr.push(...info.coverPhotos);
      if(norm(info.coverPhoto)) arr.push(info.coverPhoto);
      if(norm(info.cover)) arr.push(info.cover);

      const seg = safeObj(dNode?.segments);
      for(const k of Object.keys(seg)){
        const t = normalizeType(k);
        if(!TYPES.includes(t)) continue;
        const bucket = safeObj(seg[k]);
        for(const id of Object.keys(bucket)){
          const it = safeObj(bucket[id]);
          const pics = extractPhotos(it);
          if(pics[0]) { arr.push(pics[0]); break; }
        }
        if(arr.length) break;
      }
      return norm(arr[0]) || HERO[(Math.random()*HERO.length)|0];
    }

    function setHero(url){
      heroBg.style.backgroundImage = url ? `url('${String(url).replaceAll("'","%27")}')` : "none";
    }

    function setStoryCover(url){
      storyCover.style.backgroundImage = url ? `url('${String(url).replaceAll("'","%27")}')` : "none";
    }

    function randomQuote(){
      const x = QUOTES[(Math.random()*QUOTES.length)|0];
      quote.textContent = `‚Äú${x.q}‚Äù`;
      quoteBy.textContent = `‚Äî ${x.by}`;
    }
    newQuoteBtn.addEventListener("click", randomQuote);

    function focusDistrictOnMap(d){
      mapHint.textContent = `Map focus: ${d}`;
      mapFrame.src = `map.html#district=${encodeURIComponent(d)}&t=${Date.now()}`;
      setTimeout(()=> mapFrame.contentWindow?.postMessage({ type:"FOCUS_DISTRICT", district:d }, "*"), 450);
    }
    function focusPlaceOnMap(payload){
      mapFrame.contentWindow?.postMessage({ type:"FOCUS_PLACE", ...payload }, "*");
    }

    function renderDistricts(targetEl, query){
      const qv = low(query);
      const list = DISTRICTS.filter(d => !qv || low(d).includes(qv));

      targetEl.innerHTML = (list.length ? list : [""]).map(d=>{
        if(!d) return `
          <div class="dCard">
            <div class="dThumb" style="background:#111"></div>
            <div class="dMeta">
              <div class="dName">No match</div>
              <div class="dLine">Try another keyword.</div>
              <div class="dBadges"><span class="chip">Search</span></div>
            </div>
          </div>
        `;
        const active = (ACTIVE===d) ? "active" : "";
        const cover = COVER[d] || HERO[0];
        const pv = PREVIEW[d] || [];
        const line = pv.length ? pv.map(escapeHtml).join(" ‚Ä¢ ") : "‚Äî";
        const cnt = COUNT[d] ?? 0;

        return `
          <div class="dCard ${active}" data-d="${escapeHtml(d)}">
            <div class="dThumb" style="background-image:url('${String(cover).replaceAll("'","%27")}')"></div>
            <div class="dMeta">
              <div class="dName">${escapeHtml(d)}</div>
              <div class="dLine">${line}</div>
              <div class="dBadges">
                <span class="chip hot">${cnt} places</span>
                <span class="chip">Story</span>
                <span class="chip">Map</span>
              </div>
            </div>
          </div>
        `;
      }).join("");

      [...targetEl.querySelectorAll(".dCard[data-d]")].forEach(el=>{
        el.addEventListener("click", ()=> openDistrict(el.getAttribute("data-d")));
      });
    }

    function defaultBrief(d){
      return `‚Ä¢ ${d} is one of Himachal‚Äôs most loved regions.\n‚Ä¢ Explore curated categories below (Destinations, Lakes, Temples, Treks, Hotels).\n‚Ä¢ Tap any card to focus on map (when lat/lng exists).`;
    }
    function defaultReach(d){
      return `üõ£Ô∏è Road: well-connected by highway + scenic hill roads.\nüöÜ Rail: nearest railhead depends on route.\n‚úàÔ∏è Air: nearest airport depends on region.\n\nTip: Tap a place card to focus on map.`;
    }

    function flattenDistrict(dNode){
      const seg = safeObj(dNode?.segments);
      const out = [];
      for(const k of Object.keys(seg)){
        const type = normalizeType(k);
        if(!TYPES.includes(type)) continue;
        const bucket = safeObj(seg[k]);
        for(const id of Object.keys(bucket)){
          const it = safeObj(bucket[id]);
          out.push({
            id,
            type,
            title: pickTitle(it),
            photos: extractPhotos(it),
            notes: it.notes || it.description || "",
            rating: Number(it.rating ?? "") || null,
            popularity: Number(it.popularityScore ?? it.popularity ?? "") || null,
            entryFee: Number(it.entryFee ?? "") || null,
            lat: Number(it.lat ?? it.latitude ?? ""),
            lng: Number(it.lng ?? it.longitude ?? "")
          });
        }
      }
      return out;
    }

    function sectionHTML(type, items){
      const label = TYPE_LABEL[type] || type;
      const top = items.slice(0, 12);
      return `
        <div class="section">
          <div class="blockHead"><b>${escapeHtml(label)}</b><span class="count">${items.length}</span></div>
          ${items.length ? `
            <div class="placesGrid">
              ${top.map(placeCard).join("")}
            </div>
            ${items.length>12 ? `<div class="pMeta" style="margin-top:10px">Showing top 12. Add more items in Firebase to expand.</div>` : ""}
          ` : `<div class="empty">No records in this category.</div>`}
        </div>
      `;
    }

    function placeCard(p){
      const photo = (p.photos && p.photos[0]) ? p.photos[0] : `https://source.unsplash.com/1200x800/?Himachal,travel`;
      const mapOk = Number.isFinite(p.lat) && Number.isFinite(p.lng);
      const extra = [
        Number.isFinite(p.rating) ? `‚≠ê ${p.rating}` : "",
        Number.isFinite(p.popularity) ? `üî• ${p.popularity}` : "",
        Number.isFinite(p.entryFee) ? `‚Çπ${p.entryFee}` : "",
        mapOk ? "üìç Map" : ""
      ].filter(Boolean).join(" ‚Ä¢ ");

      return `
        <div class="pCard" data-id="${escapeHtml(p.id)}">
          <div class="pThumb" style="background-image:url('${String(photo).replaceAll("'","%27")}')">
            <div class="pBadge">${escapeHtml(TYPE_LABEL[p.type] || p.type)}</div>
          </div>
          <div class="pBody">
            <div class="pTitle">${escapeHtml(p.title)}</div>
            <div class="pMeta">${escapeHtml(extra || "Tap to open on map (if location exists)")}</div>
            ${p.notes ? `<div class="pMeta">${escapeHtml(p.notes).slice(0,100)}${p.notes.length>100?"‚Ä¶":""}</div>` : ""}
          </div>
        </div>
      `;
    }

    function bindPlaceClicks(itemsById){
      [...document.querySelectorAll(".pCard[data-id]")].forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          const p = itemsById.get(id);
          if(!p) return;

          if(Number.isFinite(p.lat) && Number.isFinite(p.lng)){
            focusPlaceOnMap({
              district: ACTIVE,
              title: p.title,
              lat: p.lat,
              lng: p.lng,
              type: p.type
            });
          }else{
            focusDistrictOnMap(ACTIVE);
          }
        });
      });
    }

    function pill(text){
      return `<span class="pillMini">${escapeHtml(text)}</span>`;
    }

    async function openDistrict(d){
      ACTIVE = d;
      liveTitle.textContent = d;

      renderDistricts(districtGrid, q.value);
      renderDistricts(districtGrid2, q2.value);

      const node = ROOT_SNAP[d];
      const info = safeObj(node?.districtInfo);
      const cover = COVER[d] || HERO[0];

      setHero(cover);
      setStoryCover(cover);

      sTitle.textContent = d;
      sSub.textContent = "A district story ‚Äî then curated categories in a premium grid.";
      briefTag.textContent = "Story";
      reachTag.textContent = "Reach";
      placesTag.textContent = `${COUNT[d] ?? 0} items`;

      const brief = norm(info.brief) || defaultBrief(d);
      const reach = norm(info.howToReach) || defaultReach(d);

      briefBox.innerHTML = `<div>${escapeHtml(brief).replaceAll("\n","<br/>")}</div>`;
      reachBox.innerHTML = `<div>${escapeHtml(reach).replaceAll("\n","<br/>")}</div>`;

      const all = flattenDistrict(node);

      // group by type
      const byType = {};
      for(const t of TYPES) byType[t] = [];
      all.forEach(x=> byType[x.type].push(x));

      // sort: popularity > rating > name
      for(const t of TYPES){
        byType[t].sort((a,b)=>{
          const pa = Number.isFinite(a.popularity)?a.popularity:-1e18;
          const pb = Number.isFinite(b.popularity)?b.popularity:-1e18;
          const ra = Number.isFinite(a.rating)?a.rating:-1e18;
          const rb = Number.isFinite(b.rating)?b.rating:-1e18;
          return (pb-pa) || (rb-ra) || String(a.title).localeCompare(String(b.title));
        });
      }

      // pills
      const pills = [];
      if(norm(info.bestSeason)) pills.push(pill(`Best: ${info.bestSeason}`));
      if(norm(info.districtHQ)) pills.push(pill(`HQ: ${info.districtHQ}`));
      pills.push(pill(`Total: ${COUNT[d] ?? all.length}`));
      pillRow.innerHTML = pills.join("");

      // build sections
      placesWrap.innerHTML =
        sectionHTML("destinations", byType.destinations) +
        sectionHTML("lakes", byType.lakes) +
        sectionHTML("temples", byType.temples) +
        sectionHTML("treks", byType.treks) +
        sectionHTML("hotels", byType.hotels);

      // bind map clicks
      const mapById = new Map(all.map(x=>[x.id,x]));
      bindPlaceClicks(mapById);

      // focus map
      focusDistrictOnMap(d);

      // close dock
      dock.style.display = "none";

      // nice scroll
      document.getElementById("story").scrollIntoView({behavior:"smooth", block:"start"});
    }

    function setupDock(){
      const strip = document.getElementById("districtStrip");
      const onScroll = ()=>{
        const r = strip.getBoundingClientRect();
        dockBtn.style.display = (r.bottom < 36) ? "block" : "none";
      };
      window.addEventListener("scroll", onScroll, {passive:true});
      onScroll();

      dockBtn.addEventListener("click", ()=>{
        dock.style.display = (dock.style.display === "block") ? "none" : "block";
      });
      dockClose.addEventListener("click", ()=> dock.style.display="none");
    }

    async function init(){
      setHero(HERO[0]);
      randomQuote();

      q.addEventListener("input", ()=> renderDistricts(districtGrid, q.value));
      q2.addEventListener("input", ()=> renderDistricts(districtGrid2, q2.value));

      setupDock();

      const snap = await get(ref(db, ROOT));
      ROOT_SNAP = snap.exists() ? safeObj(snap.val()) : {};
      DISTRICTS = Object.keys(ROOT_SNAP).sort((a,b)=>a.localeCompare(b));

      PREVIEW = {};
      COVER = {};
      COUNT = {};

      for(const d of DISTRICTS){
        const node = ROOT_SNAP[d];
        PREVIEW[d] = computePreview(node);
        COVER[d] = pickCover(node);
        COUNT[d] = countDistrict(node);
      }

      renderDistricts(districtGrid, "");
      renderDistricts(districtGrid2, "");

      // hash open
      const m = (location.hash||"").match(/district=([^&]+)/i);
      if(m){
        const d = decodeURIComponent(m[1]);
        if(DISTRICTS.includes(d)) openDistrict(d);
      }
    }

    init().catch((e)=>{
      console.error(e);
      districtGrid.innerHTML = `
        <div class="dCard">
          <div class="dThumb" style="background:#111"></div>
          <div class="dMeta">
            <div class="dName">Firebase not loading</div>
            <div class="dLine">Check rules / config / path: ${escapeHtml(ROOT)}</div>
            <div class="dBadges"><span class="chip hot">Fix rules</span><span class="chip">Try again</span></div>
          </div>
        </div>
      `;
      districtGrid2.innerHTML = districtGrid.innerHTML;
    });
  </script>
</body>
</html>