<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Himachal Explorer â€” Firebase Places + Packages + Route Planner</title>

  <style>
    :root{
      --bg:#070a12; --stroke: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92); --muted: rgba(255,255,255,.72);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 18px; --r2: 26px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(120,120,255,.18), transparent 60%),
                  radial-gradient(1200px 800px at 80% 30%, rgba(0,255,200,.10), transparent 55%),
                  var(--bg);
      overflow-x:hidden;
    }

    /* âœ… multi-image background */
    .bg{
      position:fixed; inset:0; z-index:-2;
      background-size:cover; background-position:center;
      filter:saturate(1.08) contrast(1.05);
      animation:bgSlide 18s infinite;
    }
    .bg::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(5,8,16,.62), rgba(5,8,16,.86));
    }
    @keyframes bgSlide{
      0%,30%   { background-image:url("201-himalaya.jpg"); }
      35%,65%  { background-image:url("Dark.jpg"); }
      70%,100% { background-image:url("Travelers.jpg"); }
    }

    /* âœ… Splash + Onboarding */
    .hidden{display:none !important}

    .splash{
      position:fixed; inset:0; z-index:9999;
      display:grid; place-items:center;
      background: radial-gradient(1200px 800px at 20% 10%, rgba(120,120,255,.18), transparent 55%),
                  linear-gradient(180deg, rgba(7,10,18,.92), rgba(5,8,16,.98));
    }
    .splashCard{
      width:min(520px, 92vw);
      padding:28px 22px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      box-shadow:0 24px 80px rgba(0,0,0,.55);
      text-align:center;
    }
    .splashLogo{
      width:92px;height:92px;object-fit:contain;
      display:block;margin:6px auto 12px;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.45));
    }
    .loaderLine{
      height:3px; border-radius:999px;
      background:rgba(255,255,255,.12);
      overflow:hidden; margin:14px 0 10px;
      position:relative;
    }
    .loaderLine::after{
      content:""; position:absolute; inset:0;
      width:35%;
      background:rgba(255,255,255,.65);
      animation:line 1.2s infinite ease-in-out;
    }
    @keyframes line{
      0%{transform:translateX(-120%)}
      100%{transform:translateX(320%)}
    }
    .splashText{color:rgba(255,255,255,.85); font-size:14px}

    .onboarding{
      position:fixed; inset:0; z-index:9000;
      display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(7,10,18,.80), rgba(5,8,16,.94));
    }
    .obCard{
      width:min(980px, 94vw);
      border-radius:26px;
      padding:26px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      box-shadow:0 24px 80px rgba(0,0,0,.55);
      color:rgba(255,255,255,.92);
    }
    .obTop h1{margin:0;font-size:26px}
    .obTop p{margin:8px 0 0;color:rgba(255,255,255,.72);max-width:70ch;line-height:1.45}
    .obGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top:16px;
    }
    @media(max-width:680px){ .obGrid{grid-template-columns:1fr} }
    .obBtn{
      text-align:left;
      padding:16px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.07);
      color:rgba(255,255,255,.92);
      cursor:pointer;
      transition:transform .15s ease, background .15s ease;
    }
    .obBtn:hover{transform:translateY(-2px); background:rgba(255,255,255,.10)}
    .obBtn b{display:block; font-size:16px; margin-bottom:4px}
    .obBtn span{display:block; color:rgba(255,255,255,.72); font-size:13px}
    .obFooter{
      margin-top:14px;
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      color:rgba(255,255,255,.75); font-size:13px;
    }
    .remember{display:flex;gap:10px;align-items:center}
    .remember input{width:auto}

    /* App layout */
    .wrap{display:grid; grid-template-columns: 330px 1fr; gap:18px; padding:18px; min-height:100vh;}

    .side{
      position:sticky; top:18px; align-self:start; height: calc(100vh - 36px);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      backdrop-filter: blur(14px);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding:18px; overflow:auto;
    }
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .logoBox{
      width:46px;height:46px;border-radius:16px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,.06));
      border:1px solid var(--stroke); display:grid; place-items:center;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
      overflow:hidden;
    }
    .logoBox img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:15px;letter-spacing:.3px;line-height:1.15}
    .brand p{margin:2px 0 0 0;font-size:12px;color:var(--muted)}

    .modeBar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18); padding:10px; margin:10px 0 12px;
    }
    .modeBar b{font-size:12px}
    .modeBar span{font-size:12px;color:var(--muted)}
    .modeBar button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color:var(--text);
      padding:9px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:850;
      transition:.2s ease;
    }
    .modeBar button:hover{background: rgba(255,255,255,.14);transform:translateY(-1px)}

    .panelTitle{
      margin:14px 0 8px; font-size:12px; letter-spacing:.28em;
      text-transform:uppercase; color:rgba(255,255,255,.70);
    }
    .field{display:grid;gap:8px;margin-bottom:12px}
    label{font-size:12px;color:rgba(255,255,255,.76)}
    input, select{
      width:100%; padding:12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(8,12,20,.55);
      color:var(--text); outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.55)}

    .chipRow{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      padding:8px 10px; border-radius:999px;
      cursor:pointer; font-size:12px; transition:.2s ease; user-select:none;
    }
    .chip:hover{background: rgba(255,255,255,.10);transform:translateY(-1px)}
    .chip.on{background: rgba(255,255,255,.14);border-color: rgba(255,255,255,.22)}

    .miniCard{
      margin-top:12px; border-radius: var(--r);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:12px;
    }
    .miniCard p{margin:6px 0 0 0;color:var(--muted);font-size:12px;line-height:1.45}

    .btn{
      width:100%; margin-top:10px; padding:12px;
      border-radius:14px; border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.12); color:var(--text);
      cursor:pointer; transition:.2s ease; font-weight:650;
    }
    .btn:hover{transform:translateY(-1px);background: rgba(255,255,255,.18)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .toggleRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .toggleRow input{width:auto}

    .hint{
      margin-top:10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      white-space:pre-wrap;
    }

    /* Main */
    .main{
      border-radius: var(--r2);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
      min-height: calc(100vh - 36px);
    }
    .hero{
      padding:20px 20px 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .heroTop{display:flex;gap:12px;justify-content:space-between;align-items:flex-end;flex-wrap:wrap}
    .hero h2{margin:0;font-size:26px;line-height:1.15}
    .hero p{margin:8px 0 0;color:var(--muted);max-width:72ch;line-height:1.5}
    .searchBar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:14px}
    .searchBar input{flex:1 1 320px;min-width:240px;background: rgba(0,0,0,.28)}
    .ghost{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color:var(--text);
      padding:11px 12px; border-radius:14px;
      cursor:pointer; font-weight:800; transition:.2s ease;
    }
    .ghost:hover{background: rgba(255,255,255,.14);transform:translateY(-1px)}

    .split{display:grid; grid-template-columns: 1.35fr .85fr; gap:14px; padding:14px; flex:1; min-height:0;}
    .leftPane, .rightPane{
      border-radius: 22px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18); overflow:hidden; min-height:0;
    }
    .paneHead{
      padding:12px; border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.05);
    }
    .paneHead strong{font-size:13px}
    .paneHead small{color:var(--muted)}
    .paneBody{padding:12px; overflow:auto; height:100%}

    .grid{display:grid;grid-template-columns: repeat(3, minmax(0,1fr));gap:12px}
    .card{
      border-radius: 22px; overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 55px rgba(0,0,0,.30);
      cursor:pointer;
      transition: transform .22s ease, background .22s ease, border-color .22s ease;
      min-height: 280px;
      position:relative;
    }
    .card:hover{transform:translateY(-3px);background: rgba(255,255,255,.10);border-color: rgba(255,255,255,.20)}
    .thumb{height:170px;background-size:cover;background-position:center;position:relative}
    .thumb:after{content:"";position:absolute;inset:0;background: linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.65))}
    .badge{
      position:absolute; left:12px; top:12px;
      padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
      font-size:12px; z-index:1; backdrop-filter: blur(10px);
    }
    .cardBody{padding:12px 12px 14px;display:grid;gap:8px}
    .titleRow{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .card h3{margin:0;font-size:15px;line-height:1.2}
    .meta{margin:0;color:var(--muted);font-size:12px;line-height:1.35}
    .pill{font-size:11px;padding:7px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background: rgba(255,255,255,.06)}
    .submeta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .subpill{font-size:11px;padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background: rgba(0,0,0,.16);color:rgba(255,255,255,.88)}
    .miniAdd{
      margin-left:auto;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      padding:7px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .miniAdd:hover{background: rgba(255,255,255,.18)}
    .miniAdd.disabled{opacity:.55; cursor:not-allowed}

    .routeStats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .stat{border-radius:16px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);padding:10px}
    .stat b{display:block;font-size:13px}
    .stat span{color:var(--muted);font-size:12px}
    #map{
      height:260px; border-radius:18px; border:1px solid rgba(255,255,255,.12);
      background:#0b1220; overflow:hidden; display:grid; place-items:center;
      color:rgba(255,255,255,.75); font-size:12px; text-align:center; padding:10px;
    }

    .routeList{display:grid;gap:10px;margin-top:10px}
    .routeItem{border-radius:18px;border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);overflow:hidden}
    .routeItemHead{padding:10px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .routeItemHead b{font-size:13px;line-height:1.2}
    .routeItemHead p{margin:4px 0 0;color:var(--muted);font-size:12px}
    .routeBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .tiny{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      transition:.2s ease;
      font-size:12px; line-height:1; user-select:none;
    }
    .tiny:hover{background: rgba(255,255,255,.16);transform:translateY(-1px)}

    .itinerary{
      margin-top:12px;border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18); padding:10px;
    }
    .itinerary h4{margin:0 0 8px;font-size:13px}
    .itinerary .day{
      border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding:10px;margin-bottom:8px;
    }
    .itinerary .day:last-child{margin-bottom:0}
    .itinerary .day b{font-size:12px}
    .itinerary .day p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.4}
    .pkgCard{
      border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:12px; margin-top:10px;
    }
    .pkgCard h5{margin:0;font-size:13px}
    .pkgCard p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.4}
    .pkgRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .pkgPill{font-size:11px;padding:7px 9px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background: rgba(0,0,0,.18)}
    .pkgActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pkgActions .tiny{padding:9px 10px}

    @media (max-width: 1180px){ .split{grid-template-columns:1fr} .grid{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media (max-width: 1050px){ .wrap{grid-template-columns:1fr} .side{position:relative;height:auto} }
    @media (max-width: 620px){ .wrap{padding:12px} .grid{grid-template-columns:1fr} .hero h2{font-size:22px} #map{height:240px} }
  </style>
</head>

<body>
  <div class="bg"></div>

  <!-- âœ… Splash while DB + Maps load -->
  <div id="splash" class="splash">
    <div class="splashCard">
      <img src="logo.png" class="splashLogo" alt="Logo" onerror="this.style.display='none'">
      <div style="font-weight:900; font-size:18px; letter-spacing:.4px;">Himachal Explorer</div>
      <div class="loaderLine"></div>
      <div class="splashText" id="splashText">Loadingâ€¦</div>
    </div>
  </div>

  <!-- âœ… Role selection -->
  <div id="onboarding" class="onboarding hidden">
    <div class="obCard">
      <div class="obTop">
        <h1>Welcome ðŸ‘‹</h1>
        <p>Select your purpose â€” weâ€™ll personalize your experience. You wonâ€™t see all locations until you choose a mode.</p>
      </div>

      <div class="obGrid">
        <button class="obBtn" data-mode="tourist">
          <b>Tourist</b><span>Highlights + easy explore</span>
        </button>

        <button class="obBtn" data-mode="tracker">
          <b>Tourist Tracker</b><span>Routes + budget + optimized order</span>
        </button>

        <button class="obBtn" data-mode="researcher">
          <b>Researcher</b><span>Data focused browsing (no route tools)</span>
        </button>

        <button class="obBtn" data-mode="packages">
          <b>Packages</b><span>Answer 2â€“3 questions â†’ 2â€“3 packages</span>
        </button>
      </div>

      <div class="obFooter">
        <label class="remember">
          <input type="checkbox" id="rememberMode" checked>
          Remember my choice
        </label>
        <span style="opacity:.85">You can change mode anytime.</span>
      </div>
    </div>
  </div>

  <div class="wrap hidden" id="appWrap">
    <aside class="side">
      <div class="brand">
        <div class="logoBox" aria-hidden="true">
          <img src="logo.png" alt="" onerror="this.remove()">
        </div>
        <div>
          <h1>Himachal Explorer</h1>
          <p id="modeLabel">Mode: â€”</p>
        </div>
      </div>

      <div class="modeBar">
        <div>
          <b>Experience</b><br>
          <span id="modeSub">Choose mode to start</span>
        </div>
        <button id="changeModeBtn">Change</button>
      </div>

      <!-- âœ… Package Wizard is visible ONLY in Packages mode -->
      <div class="miniCard hidden" id="pkgWizard" style="margin-top:0;">
        <b style="font-size:13px;">Package Builder</b>
        <p>Answer 2â€“3 questions â†’ weâ€™ll generate 2â€“3 best packages.</p>

        <div class="field" style="margin-top:10px;">
          <label>Start (type or write GPS)</label>
          <input id="pkgStart" placeholder="Shimla / Manali / GPS"/>
        </div>

        <div class="row2">
          <div class="field" style="margin:0;">
            <label>Days</label>
            <input id="pkgDays" type="number" value="3" min="1" max="10"/>
          </div>
          <div class="field" style="margin:0;">
            <label>People</label>
            <input id="pkgPeople" type="number" value="2" min="1" max="20"/>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Budget (â‚¹) optional</label>
          <input id="pkgBudget" type="number" value="15000" min="0"/>
        </div>

        <div class="panelTitle" style="margin-top:10px;">Interests</div>
        <div class="chipRow" id="pkgChips">
          <div class="chip on" data-i="nature">Nature</div>
          <div class="chip" data-i="adventure">Adventure</div>
          <div class="chip" data-i="spiritual">Spiritual</div>
          <div class="chip" data-i="heritage">Heritage</div>
          <div class="chip" data-i="family">Family</div>
        </div>

        <button class="btn" id="genPkgsBtn">Generate 2â€“3 Packages</button>
      </div>

      <!-- Filters -->
      <div class="panelTitle">Filters</div>
      <div class="field">
        <label>District</label>
        <select id="district"><option value="all">All Himachal</option></select>
      </div>
      <div class="field">
        <label>Search</label>
        <input id="q" placeholder="The Ridge, Jakhu..." />
      </div>

      <div class="panelTitle">Quick Tags (optional)</div>
      <div class="chipRow" id="chipsSide">
        <div class="chip" data-chip="family">Family</div>
        <div class="chip" data-chip="nature">Nature</div>
        <div class="chip" data-chip="spiritual">Spiritual</div>
        <div class="chip" data-chip="heritage">Heritage</div>
        <div class="chip" data-chip="adventure">Adventure</div>
      </div>

      <!-- Route blocks (hidden for Tourist/Researcher, shown for Tracker/Packages) -->
      <div class="miniCard" id="blockStart">
        <b style="font-size:13px;">Start location</b>
        <p>GPS start or manual start. Route updates automatically.</p>

        <div class="field" style="margin-top:10px;">
          <label>Start (manual)</label>
          <input id="startInput" placeholder="e.g., Shimla, HP"/>
        </div>

        <div class="toggleRow">
          <label style="margin:0;">Return to Start</label>
          <input id="loopToggle" type="checkbox"/>
        </div>

        <button class="btn" id="gpsBtn">Use Current Location (GPS)</button>
      </div>

      <div class="miniCard" id="blockAutoRoute">
        <b style="font-size:13px;">Auto route</b>
        <p>Auto-optimize route order with Google.</p>

        <div class="toggleRow" style="margin-top:10px;">
          <label style="margin:0;">Auto optimize</label>
          <input id="autoOpt" type="checkbox" checked/>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Travel cost rate (â‚¹/km)</label>
          <input id="ratePerKm" type="number" value="12" min="0"/>
        </div>
      </div>

      <div class="miniCard" id="blockBudget">
        <b style="font-size:13px;">Trip Budget</b>
        <p>Distance updates travel cost automatically.</p>

        <div class="panelTitle" style="margin-top:12px;">Expense Calculator</div>
        <div class="row2">
          <div class="field" style="margin:0;">
            <label>Days</label><input id="days" type="number" value="3" min="1"/>
          </div>
          <div class="field" style="margin:0;">
            <label>People</label><input id="people" type="number" value="2" min="1"/>
          </div>
        </div>
        <div class="row2">
          <div class="field" style="margin:0;">
            <label>Stay/day (â‚¹)</label><input id="stay" type="number" value="1800" min="0"/>
          </div>
          <div class="field" style="margin:0;">
            <label>Food/day (â‚¹)</label><input id="food" type="number" value="700" min="0"/>
          </div>
        </div>
        <div class="field" style="margin:0;">
          <label>Travel total (â‚¹)</label><input id="travel" type="number" value="0" min="0"/>
        </div>
        <button class="btn" id="calcBtn">Calculate Total</button>
        <p id="calcOut" style="margin-top:8px; font-weight:750;">Total: â‚¹ â€”</p>
      </div>

      <div class="hint" id="firebaseStatus">Firebase: loadingâ€¦</div>
      <div class="hint" id="debugOut">Debug: â€”</div>
      <div class="hint"><b>Data Path:</b> <span style="opacity:.95">/locations</span></div>
    </aside>

    <main class="main">
      <section class="hero">
        <div class="heroTop">
          <div>
            <h2 id="heroTitle">Himachal Explorer</h2>
            <p id="heroDesc">Choose a mode to begin.</p>
          </div>
          <button class="ghost" id="resetBtn">Reset</button>
        </div>

        <div class="searchBar">
          <input id="qMain" placeholder="Search places..." />
          <button class="ghost" id="clearGridBtn">Clear Results</button>
        </div>
      </section>

      <section class="split">
        <div class="leftPane">
          <div class="paneHead">
            <strong id="placesHead">Places</strong>
            <small id="countOut">0 results</small>
          </div>
          <div class="paneBody">
            <div id="packageResults" class="itinerary hidden">
              <h4>Recommended Packages</h4>
              <div class="day"><b>Generate packages</b><p>Use Package Builder on the left.</p></div>
            </div>
            <div class="grid" id="grid"></div>
          </div>
        </div>

        <div class="rightPane" id="routePane">
          <div class="paneHead">
            <strong>Route Planner</strong>
            <small id="routeStatus">Waiting for Mapsâ€¦</small>
          </div>
          <div class="paneBody">
            <div class="routeStats">
              <div class="stat"><b id="stopsOut">0</b><span>Stops</span></div>
              <div class="stat"><b id="distanceOut">â€”</b><span>Distance</span></div>
              <div class="stat"><b id="durationOut">â€”</b><span>Duration</span></div>
              <div class="stat"><b id="totalOut">â‚¹ â€”</b><span>Total trip est.</span></div>
            </div>

            <div id="map">Google Maps loadingâ€¦</div>

            <div class="routeList" id="routeList"></div>

            <div class="itinerary" id="itinerary">
              <h4>Day-wise Itinerary</h4>
              <div class="day"><b>Day 1</b><p>Add stops to auto-fill itinerary.</p></div>
            </div>

            <button class="btn" id="clearRouteBtn" style="margin-top:12px;">Clear Route</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    /***********************
     * CONFIG
     ***********************/
    const GOOGLE_MAPS_API_KEY = "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug";
    const FIREBASE_LOCATIONS_PATH = "/locations";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.appspot.com",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ad"
    };

    /***********************
     * UI refs
     ***********************/
    const splash = document.getElementById("splash");
    const splashText = document.getElementById("splashText");
    const onboarding = document.getElementById("onboarding");
    const appWrap = document.getElementById("appWrap");
    const rememberMode = document.getElementById("rememberMode");

    const modeLabel = document.getElementById("modeLabel");
    const modeSub = document.getElementById("modeSub");
    const changeModeBtn = document.getElementById("changeModeBtn");

    const heroTitle = document.getElementById("heroTitle");
    const heroDesc = document.getElementById("heroDesc");
    const routePane = document.getElementById("routePane");

    const pkgWizard = document.getElementById("pkgWizard");
    const packageResults = document.getElementById("packageResults");

    const grid = document.getElementById("grid");
    const countOut = document.getElementById("countOut");
    const districtSel = document.getElementById("district");
    const qSide = document.getElementById("q");
    const qMain = document.getElementById("qMain");
    const chipsSide = document.getElementById("chipsSide");
    const firebaseStatus = document.getElementById("firebaseStatus");
    const debugOut = document.getElementById("debugOut");

    const routeListEl = document.getElementById("routeList");
    const routeStatus = document.getElementById("routeStatus");
    const stopsOut = document.getElementById("stopsOut");
    const distanceOut = document.getElementById("distanceOut");
    const durationOut = document.getElementById("durationOut");
    const totalOut = document.getElementById("totalOut");
    const itineraryEl = document.getElementById("itinerary");

    const startInput = document.getElementById("startInput");
    const loopToggle = document.getElementById("loopToggle");
    const autoOpt = document.getElementById("autoOpt");
    const ratePerKmEl = document.getElementById("ratePerKm");

    const blockStart = document.getElementById("blockStart");
    const blockAutoRoute = document.getElementById("blockAutoRoute");
    const blockBudget = document.getElementById("blockBudget");

    const clearGridBtn = document.getElementById("clearGridBtn");

    let sideTags = new Set();
    let places = [];

    const ROUTE_LS_KEY = "hp_route_v1";
    const MODE_LS_KEY = "hp_mode_v1";
    let route = loadRouteFromLS();

    let startMode = "manual";
    let startLatLng = null;

    let map = null, directionsService = null, directionsRenderer = null;
    let lastDirections = null;
    let routeTimer = null;
    let applyingOptimizedOrder = false;

    let mapsLoaded = false;
    let dbLoaded = false;
    let currentMode = null;

    /***********************
     * Firebase init + auth
     ***********************/
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    async function ensureAuth(){
      try{ if(!auth.currentUser) await signInAnonymously(auth); }catch(e){
        debugOut.textContent = "Debug: Auth failed (ok if rules are public): " + (e?.message || e);
      }
    }

    /***********************
     * Helpers
     ***********************/
    function pick(p, keys, fallback=""){
      for(const k of keys){
        if(p && p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== "") return p[k];
      }
      return fallback;
    }
    function parseLatLng(p){
      const lat = Number(p?.lat ?? p?.latitude ?? p?.Latitude);
      const lng = Number(p?.lng ?? p?.longitude ?? p?.Longitude);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat, lng};

      const m = String(p?.Map ?? p?.map ?? "").trim();
      const mm = m.match(/(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)/);
      if(mm) return { lat: Number(mm[1]), lng: Number(mm[3]) };

      return {lat: NaN, lng: NaN};
    }
    function normalizePlace(id, p){
      const {lat, lng} = parseLatLng(p);

      const name = String(pick(p, ["Location Name","locationName","name"], id)).trim();
      const district = String(pick(p, ["District","district"], "")).trim();
      const segmentType = String(pick(p, ["Segment Type","segmentType"], "Place")).trim();
      const locationType = String(pick(p, ["Location Type","locationType"], "â€”")).trim();

      const overview = String(pick(p, ["Overview","overview"], "")).trim();
      const shortDescription = String(pick(p, ["Short Description","shortDescription"], "")).trim();
      const howToReach = String(pick(p, ["How to Reach","howToReach"], "")).trim();
      const keyFeatures = String(pick(p, ["Key Features","keyFeatures"], "")).trim();
      const bestTimeToVisit = String(pick(p, ["Best Time to Visit","bestTimeToVisit"], "")).trim();
      const taskForLocation = String(pick(p, ["Task for Location","taskForLocation"], "")).trim();
      const distFromHQ = String(pick(p, ["Dist from HQ","Dist From HQ"], "")).trim();
      const mapUrl = String(pick(p, ["Map","mapUrl"], "")).trim();

      const tags = new Set();
      const s = (segmentType+" "+locationType+" "+overview+" "+shortDescription+" "+keyFeatures+" "+taskForLocation).toLowerCase();
      if(/temple|mandir|devi|mahadev|shiva|shiv/.test(s)) tags.add("spiritual");
      if(/lake|river|waterfall|forest|valley|meadow|peak|mount|snow|nature|view|sunset/.test(s)) tags.add("nature");
      if(/trek|hike|trail|camp|adventure|paragliding|rafting|ski/.test(s)) tags.add("adventure");
      if(/heritage|colonial|fort|palace|museum|monastery|old/.test(s)) tags.add("heritage");
      if(/family|kids|picnic|easy/.test(s)) tags.add("family");

      return { id, name, district, segmentType, locationType, overview, shortDescription, howToReach,
        keyFeatures, bestTimeToVisit, taskForLocation, distFromHQ, mapUrl, lat, lng, tags:[...tags] };
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function escapeAttr(s){ return String(s).replace(/'/g, "%27"); }

    function updateSplash(){
      const parts = [];
      parts.push(dbLoaded ? "Database âœ…" : "Databaseâ€¦");
      parts.push(mapsLoaded ? "Maps âœ…" : "Mapsâ€¦");
      splashText.textContent = "Loading: " + parts.join(" â€¢ ");
    }
    function maybeHideSplash(){
      updateSplash();
      if(dbLoaded && mapsLoaded){
        splash.classList.add("hidden");
        const saved = localStorage.getItem(MODE_LS_KEY);
        if(saved){
          setMode(saved, {skipOnboarding:true});
        }else{
          onboarding.classList.remove("hidden");
        }
      }
    }

    /***********************
     * Load from RTDB (/locations)
     ***********************/
    async function loadPlacesFromFirebase(){
      firebaseStatus.textContent = "Firebase: loadingâ€¦";
      debugOut.textContent = "Debug: connectingâ€¦";
      await ensureAuth();

      try{
        const snap = await get(ref(db, FIREBASE_LOCATIONS_PATH));
        const data = snap.exists() ? snap.val() : null;

        if(!data || typeof data !== "object"){
          firebaseStatus.textContent = "Firebase: /locations returned null âŒ";
          debugOut.textContent = "Debug: No data at " + FIREBASE_LOCATIONS_PATH + "\nCheck that your node is exactly: /locations";
          places = [];
          return;
        }

        const out = [];
        for(const [id, p] of Object.entries(data || {})){
          if(p && typeof p === "object") out.push(normalizePlace(id, p));
        }

        out.sort((a,b)=>
          (a.district||"").localeCompare(b.district||"") ||
          (a.segmentType||"").localeCompare(b.segmentType||"") ||
          (a.name||"").localeCompare(b.name||"")
        );

        places = out;

        const districtNames = [...new Set(places.map(p => p.district).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
        districtSel.innerHTML = `<option value="all">All Himachal</option>` +
          districtNames.map(d=>`<option value="${escapeAttr(d)}">${escapeHtml(d)}</option>`).join("");

        firebaseStatus.textContent = `Firebase: loaded ${places.length} places âœ…`;
        debugOut.textContent = `Debug:\nPath: ${FIREBASE_LOCATIONS_PATH}\nKeys sample: ${Object.keys(data).slice(0,10).join(", ")}`;

      }catch(e){
        const msg = (e?.message || String(e));
        firebaseStatus.textContent = "Firebase: error âŒ " + msg;
        debugOut.textContent = "Debug error:\n" + msg + "\n\nIf Permission denied â†’ allow read in RTDB rules.";
      }
    }

    /***********************
     * MODE SYSTEM
     ***********************/
    function setMode(mode, opts={}){
      currentMode = mode;

      const nice = ({
        tourist: "Tourist",
        tracker: "Tourist Tracker",
        researcher: "Researcher",
        packages: "Packages"
      })[mode] || mode;

      modeLabel.textContent = "Mode: " + nice;
      modeSub.textContent = ({
        tourist: "Highlights + easy explore",
        tracker: "Routes + budget + optimized order",
        researcher: "Data focused browsing",
        packages: "Answer 2â€“3 questions â†’ 2â€“3 packages"
      })[mode] || "Personalized view";

      heroTitle.textContent = "Himachal Explorer â€” " + nice;
      heroDesc.textContent = ({
        tourist: "Browse and open details pages. Route tools hidden.",
        tracker: "Build routes, optimize order, track distance and trip cost.",
        researcher: "Data focused browsing. Route panel hidden.",
        packages: "Use Package Builder on the left to generate 2â€“3 itineraries."
      })[mode] || "Welcome";

      // show package wizard only in packages mode
      if(mode === "packages"){
        pkgWizard.classList.remove("hidden");
        packageResults.classList.remove("hidden");
      }else{
        pkgWizard.classList.add("hidden");
        packageResults.classList.add("hidden");
      }

      // route visibility by mode
      if(mode === "researcher" || mode === "tourist"){
        routePane.classList.add("hidden");
        blockStart.classList.add("hidden");
        blockAutoRoute.classList.add("hidden");
        blockBudget.classList.add("hidden");
      }else{
        routePane.classList.remove("hidden");
        blockStart.classList.remove("hidden");
        blockAutoRoute.classList.remove("hidden");
        blockBudget.classList.remove("hidden");
      }

      onboarding.classList.add("hidden");
      appWrap.classList.remove("hidden");

      if(!opts.skipOnboarding && rememberMode.checked){
        localStorage.setItem(MODE_LS_KEY, mode);
      }

      // IMPORTANT: don't show everything instantly
      clearGrid();
      toast("Mode set: " + nice + " âœ…");
    }

    document.querySelectorAll(".obBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const mode = btn.dataset.mode;
        if(rememberMode.checked) localStorage.setItem(MODE_LS_KEY, mode);
        setMode(mode);
      });
    });

    changeModeBtn.addEventListener("click", ()=>{
      appWrap.classList.add("hidden");
      onboarding.classList.remove("hidden");
    });

    /***********************
     * FILTERS + RENDER
     ***********************/
    function matches(p){
      const d = districtSel.value;
      const q = (qMain.value || qSide.value || "").trim().toLowerCase();
      const byDistrict = (d === "all") ? true : (p.district === d);

      const hay = (
        p.name + " " + p.district + " " + p.segmentType + " " + p.locationType + " " +
        (p.shortDescription||"") + " " + (p.overview||"") + " " +
        (p.keyFeatures||"") + " " + (p.howToReach||"") + " " +
        (p.taskForLocation||"") + " " + (p.bestTimeToVisit||"") + " " +
        (p.tags||[]).join(" ")
      ).toLowerCase();

      const byQuery = !q ? true : hay.includes(q);
      const bySideTags = (sideTags.size === 0) ? true : [...sideTags].some(t => (p.tags || []).includes(t));
      return byDistrict && byQuery && bySideTags;
    }

    function fallbackImgFor(p){
      const seed = encodeURIComponent(`${p.segmentType} ${p.locationType} ${p.district} himachal`);
      return `https://source.unsplash.com/1200x800/?${seed}`;
    }

    function renderPlaces(customList=null){
      const list = (customList ? customList : places.filter(matches));
      countOut.textContent = `${list.length} results`;
      grid.innerHTML = "";

      list.forEach(p=>{
        const el = document.createElement("div");
        el.className = "card";
        const img = fallbackImgFor(p);
        const best = p.bestTimeToVisit ? `Best: ${p.bestTimeToVisit}` : "";
        const lt = p.locationType && p.locationType !== "â€”" ? p.locationType : "";
        const hasCoords = Number.isFinite(p.lat) && Number.isFinite(p.lng);

        const canAdd = (currentMode === "tracker" || currentMode === "packages") && hasCoords;

        el.innerHTML = `
          <div class="thumb" style="background-image:url('${escapeAttr(img)}')">
            <div class="badge">${escapeHtml(p.segmentType || "Place")}</div>
          </div>
          <div class="cardBody">
            <div class="titleRow">
              <h3>${escapeHtml(p.name)}</h3>
              <span class="pill">${escapeHtml(p.district || "â€”")}</span>
            </div>
            <p class="meta">${escapeHtml(p.shortDescription || p.overview || "")}</p>
            <div class="submeta">
              ${lt ? `<span class="subpill">${escapeHtml(lt)}</span>` : ``}
              ${best ? `<span class="subpill">${escapeHtml(best)}</span>` : ``}
              <span class="subpill">${hasCoords ? "Coords âœ“" : "No coords"}</span>
              ${(currentMode === "tracker" || currentMode === "packages")
                ? `<span class="miniAdd ${canAdd ? "" : "disabled"}" data-add="1">+ Add</span>`
                : ``}
            </div>
          </div>
        `;

        el.addEventListener("click", (ev)=>{
          const addBtn = ev.target?.closest?.("[data-add='1']");
          if(addBtn){
            ev.stopPropagation();
            if(!canAdd){ toast("Can't add (coords missing or mode not allowed)."); return; }
            addToRoute(p);
            return;
          }
          window.location.href = `location.html?id=${encodeURIComponent(p.id)}`;
        });

        grid.appendChild(el);
      });

      if(list.length === 0){
        grid.innerHTML = `<div style="opacity:.85; padding:12px;">No results. Try different filters.</div>`;
      }
    }

    function clearGrid(){
      grid.innerHTML = `<div style="opacity:.85; padding:12px;">Use search / filters or Package Builder to show relevant places.</div>`;
      countOut.textContent = `0 results`;
    }
    clearGridBtn.addEventListener("click", clearGrid);

    // Only render when user searches/filters (not immediately)
    qMain.addEventListener("input", ()=> renderPlaces());
    qSide.addEventListener("input", ()=> renderPlaces());
    districtSel.addEventListener("change", ()=> renderPlaces());

    chipsSide.addEventListener("click", (e)=>{
      const c = e.target.closest(".chip");
      if(!c) return;
      const key = c.dataset.chip;
      if(c.classList.contains("on")){
        c.classList.remove("on"); sideTags.delete(key);
      }else{
        c.classList.add("on"); sideTags.add(key);
      }
      renderPlaces();
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      qMain.value=""; qSide.value="";
      districtSel.value="all";
      sideTags = new Set();
      [...chipsSide.querySelectorAll(".chip")].forEach(x=>x.classList.remove("on"));
      clearGrid();
      toast("Reset done");
    });

    /***********************
     * ROUTE (LS)
     ***********************/
    function loadRouteFromLS(){
      try{
        const raw = localStorage.getItem(ROUTE_LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveRouteToLS(){ localStorage.setItem(ROUTE_LS_KEY, JSON.stringify(route)); }

    function addToRoute(p){
      if(route.find(x=>x.id===p.id)){ toast("Already in route"); return; }
      route.push({ id:p.id, name:p.name, district:p.district, segmentType:p.segmentType, lat:p.lat, lng:p.lng });
      saveRouteToLS();
      renderRoute();
      scheduleRoute(true);
      toast("Added: " + p.name);
    }
    function move(i, dir){
      const j = i + dir;
      if(j < 0 || j >= route.length) return;
      [route[i], route[j]] = [route[j], route[i]];
      saveRouteToLS(); renderRoute(); scheduleRoute(true);
    }
    function removeStop(i){
      route.splice(i,1);
      saveRouteToLS(); renderRoute(); scheduleRoute(true);
    }
    document.getElementById("clearRouteBtn").addEventListener("click", ()=>{
      route = []; saveRouteToLS(); renderRoute(); scheduleRoute(false);
      toast("Route cleared");
    });

    function renderRoute(){
      if(routePane.classList.contains("hidden")) return;

      routeListEl.innerHTML = "";
      route.forEach((p,i)=>{
        const item = document.createElement("div");
        item.className = "routeItem";
        item.innerHTML = `
          <div class="routeItemHead">
            <div>
              <b>${i+1}. ${escapeHtml(p.name)}</b>
              <p>${escapeHtml(p.district || "â€”")} â€¢ ${escapeHtml(p.segmentType || "Place")}</p>
            </div>
            <div class="routeBtns">
              <button class="tiny">â†‘</button>
              <button class="tiny">â†“</button>
              <button class="tiny">âœ•</button>
            </div>
          </div>
        `;
        const [up, down, del] = item.querySelectorAll("button");
        up.addEventListener("click", ()=>move(i,-1));
        down.addEventListener("click", ()=>move(i,+1));
        del.addEventListener("click", ()=>removeStop(i));
        routeListEl.appendChild(item);
      });

      if(route.length === 0){
        routeListEl.innerHTML = `<div style="opacity:.85; padding:10px;">No stops yet. Use <b>+ Add</b> on cards.</div>`;
      }
      stopsOut.textContent = String(route.length);
      renderItinerary();
    }

    function renderItinerary(){
      const days = Math.max(1, +document.getElementById("days").value || 1);
      const buckets = Array.from({length: days}, ()=>[]);
      route.forEach((p, idx)=> buckets[idx % days].push(p));

      itineraryEl.innerHTML = `<h4>Day-wise Itinerary</h4>`;
      for(let d=0; d<days; d++){
        const stops = buckets[d];
        const text = stops.length
          ? stops.map((s,i)=> `${i+1}) ${escapeHtml(s.name)}`).join(" â€¢ ")
          : "No stops planned for this day.";
        const el = document.createElement("div");
        el.className = "day";
        el.innerHTML = `<b>Day ${d+1}</b><p>${text}</p>`;
        itineraryEl.appendChild(el);
      }
    }

    /***********************
     * BUDGET
     ***********************/
    function calcBudget(){
      const days = +document.getElementById("days").value || 0;
      const people = +document.getElementById("people").value || 1;
      const stay = +document.getElementById("stay").value || 0;
      const food = +document.getElementById("food").value || 0;
      const travel = +document.getElementById("travel").value || 0;
      const total = (days * (stay + food) * people) + travel;
      return {total};
    }
    function updateTotalOnly(){
      const {total} = calcBudget();
      totalOut.textContent = "â‚¹ " + total.toLocaleString("en-IN");
    }
    document.getElementById("calcBtn").addEventListener("click", ()=>{
      const {total} = calcBudget();
      document.getElementById("calcOut").textContent = "Total: â‚¹ " + total.toLocaleString("en-IN");
      updateTotalOnly();
    });
    ["days","people","stay","food","travel"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>{
        updateTotalOnly();
        renderItinerary();
      });
    });

    /***********************
     * Start location
     ***********************/
    document.getElementById("gpsBtn").addEventListener("click", ()=>{
      if(!navigator.geolocation){ toast("Geolocation not supported."); return; }
      routeStatus.textContent = "Getting GPSâ€¦";
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          startMode = "gps";
          startLatLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          routeStatus.textContent = "GPS start set";
          toast("Start set to current location.");
          scheduleRoute(true);
        },
        ()=>{
          routeStatus.textContent = "GPS blocked";
          toast("GPS permission denied.");
        },
        { enableHighAccuracy:true, timeout:10000 }
      );
    });

    function getOrigin(){
      if(startMode === "gps" && startLatLng) return startLatLng;
      const manual = (startInput.value || "").trim();
      if(manual) return manual;
      return "Shimla, Himachal Pradesh";
    }

    /***********************
     * Google routing
     ***********************/
    function mapsReady(){
      return !!(window.google && google.maps && directionsService && directionsRenderer);
    }
    function scheduleRoute(shouldOptimize){
      if(routePane.classList.contains("hidden")) return;
      const doOpt = !!autoOpt.checked && !!shouldOptimize;
      clearTimeout(routeTimer);
      routeTimer = setTimeout(()=> computeDirections(doOpt), 650);
      routeStatus.textContent = mapsReady() ? (doOpt ? "Auto-optimizingâ€¦" : "Auto-routingâ€¦") : "Maps not ready";
    }
    startInput.addEventListener("input", ()=> scheduleRoute(true));
    loopToggle.addEventListener("change", ()=> scheduleRoute(true));
    autoOpt.addEventListener("change", ()=> scheduleRoute(false));
    ratePerKmEl.addEventListener("input", ()=> recalcFromLastDirections());

    async function computeDirections(allowOptimize){
      if(!mapsReady()) return;

      if(route.length === 0){
        directionsRenderer.set("directions", null);
        distanceOut.textContent = "â€”";
        durationOut.textContent = "â€”";
        document.getElementById("travel").value = 0;
        updateTotalOnly();
        routeStatus.textContent = "Ready";
        return;
      }

      const loop = !!loopToggle.checked;
      const origin = getOrigin();

      let destination, waypoints;
      if(loop){
        destination = origin;
        waypoints = route.map(p => ({ location: {lat:p.lat, lng:p.lng}, stopover:true }));
      }else{
        destination = {lat: route[route.length-1].lat, lng: route[route.length-1].lng};
        waypoints = route.slice(0, -1).map(p => ({ location: {lat:p.lat, lng:p.lng}, stopover:true }));
      }

      const request = {
        origin,
        destination,
        waypoints,
        optimizeWaypoints: !!allowOptimize,
        travelMode: google.maps.TravelMode.DRIVING
      };

      try{
        const res = await directionsService.route(request);
        lastDirections = res;
        directionsRenderer.setDirections(res);

        if(allowOptimize && !applyingOptimizedOrder){
          const order = res.routes?.[0]?.waypoint_order || [];
          applyingOptimizedOrder = true;

          if(loop){
            const newRoute = order.map(idx => route[idx]).filter(Boolean);
            if(newRoute.length === route.length) route = newRoute;
          } else {
            const head = order.map(idx => route[idx]).filter(Boolean);
            const dest = route[route.length-1];
            route = [...head, dest];
          }

          saveRouteToLS();
          renderRoute();
          applyingOptimizedOrder = false;
        }

        updateStatsFromDirections(res);
        routeStatus.textContent = allowOptimize ? "Auto-optimized âœ…" : "Auto-routed âœ…";
      }catch(err){
        console.error(err);
        routeStatus.textContent = "Routing failed";
        toast("Routing failed. Check Google key/billing/APIs/referrer.");
      }
    }

    function updateStatsFromDirections(res){
      const legs = res.routes?.[0]?.legs || [];
      let meters = 0, seconds = 0;
      legs.forEach(l=>{
        meters += (l.distance?.value || 0);
        seconds += (l.duration?.value || 0);
      });

      const km = meters / 1000;
      distanceOut.textContent = km ? `${km.toFixed(1)} km` : "â€”";

      const mins = Math.round(seconds / 60);
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      durationOut.textContent = mins ? (h>0 ? `${h}h ${m}m` : `${m}m`) : "â€”";

      const ratePerKm = Math.max(0, +ratePerKmEl.value || 0);
      const travelCost = Math.round(km * ratePerKm);
      document.getElementById("travel").value = isFinite(travelCost) ? travelCost : 0;
      updateTotalOnly();
    }
    function recalcFromLastDirections(){
      if(!lastDirections) return;
      updateStatsFromDirections(lastDirections);
      routeStatus.textContent = "Cost updated";
    }

    function showMapsFixMessage(){
      const mapEl = document.getElementById("map");
      mapEl.textContent =
        "Google Maps not loaded.\n\nFix:\n1) Enable Billing\n2) Enable: Maps JavaScript API + Directions API\n3) API Key â†’ HTTP referrers add:\n   https://champishere001.github.io/*\n4) Wait 5 min, reload";
      routeStatus.textContent = "Maps failed";
    }

    function loadGoogleMaps(){
      return new Promise((resolve, reject)=>{
        if(!GOOGLE_MAPS_API_KEY){ reject(new Error("Missing key")); return; }
        const s = document.createElement("script");
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_MAPS_API_KEY)}&callback=__initMap`;
        s.async = true; s.defer = true;
        window.__initMap = () => resolve();
        s.onerror = () => reject(new Error("Failed to load Google Maps script"));
        document.head.appendChild(s);
      });
    }

    function initMap(){
      const mapEl = document.getElementById("map");
      mapEl.textContent = "";
      map = new google.maps.Map(mapEl, {
        center: {lat:31.9, lng:77.2},
        zoom: 7,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });
      routeStatus.textContent = "Ready";
    }

    /***********************
     * PACKAGE BUILDER (2â€“3 packages)
     ***********************/
    const pkgStartEl = document.getElementById("pkgStart");
    const pkgDaysEl = document.getElementById("pkgDays");
    const pkgPeopleEl = document.getElementById("pkgPeople");
    const pkgBudgetEl = document.getElementById("pkgBudget");
    const pkgChips = document.getElementById("pkgChips");
    const genPkgsBtn = document.getElementById("genPkgsBtn");

    let pkgInterests = new Set(["nature"]);

    pkgChips?.addEventListener("click", (e)=>{
      const c = e.target.closest(".chip");
      if(!c) return;
      const k = c.dataset.i;
      if(c.classList.contains("on")){
        c.classList.remove("on");
        pkgInterests.delete(k);
      }else{
        c.classList.add("on");
        pkgInterests.add(k);
      }
      if(pkgInterests.size === 0){
        const first = pkgChips.querySelector(".chip[data-i='nature']");
        first.classList.add("on");
        pkgInterests.add("nature");
      }
    });

    genPkgsBtn?.addEventListener("click", ()=>{
      if(!places || places.length === 0){
        toast("Database not loaded yet.");
        return;
      }
      const days = Math.max(1, Math.min(10, +pkgDaysEl.value || 3));
      const people = Math.max(1, +pkgPeopleEl.value || 2);
      const budget = Math.max(0, +pkgBudgetEl.value || 0);

      const startText = (pkgStartEl.value || "").trim();
      const start = startText.toLowerCase() === "gps" ? getOrigin() : (startText || "Shimla, Himachal Pradesh");

      const interests = [...pkgInterests];

      const pkgs = generatePackages({ start, days, people, budget, interests }, places);
      renderPackages(pkgs);
      toast("Packages generated âœ…");
    });

    function scorePlaceForInterests(p, interests){
      const tags = p.tags || [];
      let s = 0;
      for(const i of interests){
        if(tags.includes(i)) s += 4;
      }
      if((p.segmentType||"").toLowerCase() === "destination") s += 1;
      if((p.locationType||"").toLowerCase().includes("lake")) s += 1;
      if((p.locationType||"").toLowerCase().includes("trek")) s += 2;
      return s;
    }

    function generatePackages(inputs, allPlaces){
      const { days, interests } = inputs;
      const candidates = allPlaces.filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng));
      const scored = candidates
        .map(p => ({ p, s: scorePlaceForInterests(p, interests) }))
        .filter(x => x.s > 0)
        .sort((a,b)=> b.s - a.s);

      const fallback = candidates
        .filter(p => (p.segmentType||"").toLowerCase() !== "hotel")
        .slice(0, 120)
        .map(p => ({p, s: 1}));

      const pool = scored.length >= 25 ? scored : [...scored, ...fallback];

      const stopsLight = Math.max(3, Math.min(12, days * 2));
      const stopsHeavy = Math.max(4, Math.min(16, days * 3));

      const pickUnique = (n, mustTag=null) => {
        const out = [];
        const seenDistrict = new Set();
        for(const x of pool){
          if(out.length >= n) break;
          const p = x.p;
          if(mustTag && !(p.tags||[]).includes(mustTag)) continue;
          if(seenDistrict.has(p.district) && Math.random() < 0.65) continue;
          seenDistrict.add(p.district);
          out.push(p);
        }
        if(out.length < n){
          for(const x of pool){
            if(out.length >= n) break;
            const p = x.p;
            if(out.find(z=>z.id===p.id)) continue;
            out.push(p);
          }
        }
        return out.slice(0,n);
      };

      const pkg1Stops = pickUnique(stopsLight);
      const pkg2Stops = pickUnique(stopsLight, interests[0] || null);
      const pkg3Stops = pickUnique(stopsHeavy);

      return [
        buildPkg("Balanced Explorer", "Balanced sights + comfort pace", inputs, pkg1Stops),
        buildPkg("Interest Focused", `More ${interests.join(" + ")} places`, inputs, pkg2Stops),
        buildPkg("Packed Adventure", "Maximum coverage for energetic trips", inputs, pkg3Stops),
      ];
    }

    function buildPkg(title, subtitle, inputs, stops){
      const days = Math.max(1, +inputs.days || 1);
      const buckets = Array.from({length: days}, ()=>[]);
      stops.forEach((p, idx)=> buckets[idx % days].push(p));

      const estKm = Math.round(stops.length * 35);
      const rate = Math.max(0, +document.getElementById("ratePerKm").value || 12);
      const travelCost = estKm * rate;

      const stay = Math.max(0, +document.getElementById("stay").value || 0);
      const food = Math.max(0, +document.getElementById("food").value || 0);
      const people = Math.max(1, +inputs.people || 1);
      const total = (days * (stay + food) * people) + travelCost;

      return { title, subtitle, buckets, estKm, travelCost, total, stops };
    }

    function renderPackages(pkgs){
      packageResults.classList.remove("hidden");
      packageResults.innerHTML = `<h4>Recommended Packages (2â€“3)</h4>`;

      pkgs.slice(0,3).forEach((pkg, idx)=>{
        const daysHtml = pkg.buckets.map((arr, i)=>{
          const list = arr.length ? arr.map(x=>escapeHtml(x.name)).join(" â€¢ ") : "Rest / Buffer day";
          return `<div class="day"><b>Day ${i+1}</b><p>${list}</p></div>`;
        }).join("");

        const box = document.createElement("div");
        box.className = "pkgCard";
        box.innerHTML = `
          <h5>${idx+1}. ${escapeHtml(pkg.title)}</h5>
          <p>${escapeHtml(pkg.subtitle)}</p>
          <div class="pkgRow">
            <span class="pkgPill">Est. Distance: ~${pkg.estKm} km</span>
            <span class="pkgPill">Travel: â‚¹ ${pkg.travelCost.toLocaleString("en-IN")}</span>
            <span class="pkgPill">Total: â‚¹ ${pkg.total.toLocaleString("en-IN")}</span>
          </div>
          <div class="pkgActions">
            <button class="tiny" data-act="show">Show these places</button>
            <button class="tiny" data-act="route">Build route</button>
          </div>
          <div class="itinerary" style="margin-top:10px;">
            <h4>Day-wise Plan</h4>
            ${daysHtml}
          </div>
        `;

        const btnShow = box.querySelector("[data-act='show']");
        const btnRoute = box.querySelector("[data-act='route']");

        btnShow.addEventListener("click", ()=>{
          renderPlaces(pkg.stops);
          toast("Showing package places âœ…");
        });

        btnRoute.addEventListener("click", ()=>{
          route = pkg.stops.slice(0, 12).map(p=>({id:p.id,name:p.name,district:p.district,segmentType:p.segmentType,lat:p.lat,lng:p.lng}));
          saveRouteToLS();
          renderRoute();
          scheduleRoute(true);
          toast("Route built from package âœ…");
        });

        packageResults.appendChild(box);
      });
    }

    /***********************
     * BOOT
     ***********************/
    async function boot(){
      updateSplash();
      await loadPlacesFromFirebase();
      dbLoaded = true;
      updateSplash();

      // default empty grid (no mass listing)
      clearGrid();
      updateTotalOnly();
      renderRoute();
      scheduleRoute(false);

      maybeHideSplash();
    }

    (async ()=>{
      try{
        await loadGoogleMaps();
        initMap();
        mapsLoaded = true;
      }catch(e){
        console.warn(e);
        showMapsFixMessage();
        mapsLoaded = true; // allow app without maps
      }
      await boot();
    })();

    /***********************
     * Toast
     ***********************/
    let toastTimer = null;
    function toast(msg){
      let t = document.getElementById("toast");
      if(!t){
        t = document.createElement("div");
        t.id="toast";
        t.style.cssText = `
          position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
          background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.16);
          color:white; padding:10px 12px; border-radius:999px; backdrop-filter: blur(10px);
          box-shadow: 0 20px 60px rgba(0,0,0,.55); z-index:999; font-weight:750;
          transition: opacity .2s ease;
          max-width:min(92vw, 900px);
          text-align:center;
        `;
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity="1";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ t.style.opacity="0"; }, 1800);
    }
  </script>
</body>
</html>