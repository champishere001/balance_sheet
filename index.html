<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>

  <title>Himachal Tour Packages | Himachal Explorer Portal</title>
  <meta name="description" content="Explore Himachal tour packages with live road route maps, day-wise itineraries, places, and instant WhatsApp enquiry." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <link rel="canonical" href="https://himachalexplorer.in/" />
  <meta name="theme-color" content="#070A12" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Himachal Explorer Portal â€“ Tour Packages">
  <meta property="og:description" content="Live route map, day-wise itinerary, and WhatsApp enquiry for Himachal tour packages.">
  <meta property="og:url" content="https://himachalexplorer.in/">
  <meta property="og:image" content="https://himachalexplorer.in/og.jpg">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Himachal Explorer Portal â€“ Tour Packages">
  <meta name="twitter:description" content="Live route map, itinerary and WhatsApp enquiry for Himachal tour packages.">
  <meta name="twitter:image" content="https://himachalexplorer.in/og.jpg">

  <!-- Structured data -->
  <script type="application/ld+json">
  {"@context":"https://schema.org","@type":"WebSite","name":"Himachal Explorer Portal","url":"https://himachalexplorer.in/"}
  </script>

  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://router.project-osrm.org" crossorigin>
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg0:#070A12; --bg1:#0B1220; --stroke:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.65); --text:rgba(255,255,255,.92);
      --shadow: 0 18px 70px rgba(0,0,0,.55); --radius: 16px; --acc:#7C3AED;
      --gap: 10px; --shellW: min(92vw, 1500px);
      --good: rgba(34,197,94,.18);
      --warn: rgba(245,158,11,.16);
    }
    *{ box-sizing:border-box; }
    html,body{ height:auto; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 13px;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 520px at 50% 90%, rgba(6,182,212,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:auto;
    }
    .aurora{ position:fixed; inset:-30%;
      background:
        radial-gradient(900px 500px at 25% 30%, rgba(124,58,237,.22), transparent 65%),
        radial-gradient(900px 520px at 75% 25%, rgba(34,197,94,.18), transparent 66%),
        radial-gradient(860px 540px at 55% 75%, rgba(6,182,212,.14), transparent 66%);
      filter: blur(45px); opacity:.9; animation: drift 14s ease-in-out infinite;
      pointer-events:none; z-index:-3;
    }
    @keyframes drift{0%,100%{transform:translate3d(0,0,0) scale(1);}50%{transform:translate3d(3%,-2%,0) scale(1.06);}}
    .noise{ position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.12; mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }
    .shell{ width: var(--shellW); margin: 0 auto; padding: 12px 10px 18px; }
    .app{ width:100%; display:flex; flex-direction:column; gap: var(--gap); }

    /* Top */
    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding: 10px 10px; border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(14px); gap: 10px; flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width: 240px; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: rgba(255,255,255,.10);
      border:1px solid var(--stroke);
      display:grid; place-items:center; overflow:hidden;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      flex:0 0 auto;
      font-weight:950; letter-spacing:.12em;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brand p{ margin:3px 0 0; font-size:11px; color:var(--muted); line-height:1.25; }

    .actions{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.08em;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer; user-select:none; backdrop-filter: blur(12px); white-space: nowrap;
    }
    .chip:hover{ background: rgba(255,255,255,.08); color: rgba(255,255,255,.82); }
    .chip.primary{
      border-color: rgba(124,58,237,.55);
      background: rgba(124,58,237,.14);
      color:#fff; font-weight:900;
    }
    .chip.good{
      border-color: rgba(34,197,94,.40);
      background: rgba(34,197,94,.16);
      color:#fff; font-weight:900;
    }

    /* âœ… NEW: Visitor friendly package mode toggle */
    .modeBar{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius);
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      backdrop-filter: blur(12px);
    }
    .modeLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 260px;
    }
    .modeTitle{
      font-weight: 950;
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .modeHelp{
      color: var(--muted);
      font-size: 11px;
      letter-spacing:.02em;
      text-transform: none;
      line-height: 1.3;
    }
    .seg{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .segBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
      border-radius: 999px;
      padding: 9px 11px;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .segBtn.active{
      border-color: rgba(124,58,237,.70);
      background: rgba(124,58,237,.16);
      box-shadow: 0 0 0 3px rgba(124,58,237,.12);
      color:#fff;
      font-weight: 950;
    }
    .segBadge{
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.82);
    }

    .main{ display:grid; grid-template-columns: 0.34fr 0.30fr 0.36fr; gap: var(--gap); align-items:start; }

    .pane{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      display:flex; flex-direction:column; overflow:hidden;
      height: auto; min-height: 540px;
    }
    .pane.mapPane{ position: sticky; top: 12px; height: calc(100vh - 170px); min-height: 560px; max-height: 860px; }

    .paneHdr{
      padding: 10px 10px 8px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex:0 0 auto;
    }
    .paneHdr .t{ font-size:11px; letter-spacing:.18em; text-transform: uppercase; margin:0; }
    .paneHdr .s{ font-size:10.5px; color:var(--muted); letter-spacing:.08em; text-transform: uppercase; }

    .filters{
      padding: 10px; border-bottom:1px solid var(--stroke);
      display:grid; grid-template-columns: 1fr; gap:8px;
      background: rgba(0,0,0,.18); backdrop-filter: blur(10px);
      flex:0 0 auto; position:relative; z-index:20;
    }
    .field label{
      display:block; font-size: 10.5px; color: var(--muted);
      text-transform: uppercase; letter-spacing:.12em; margin:0 0 6px 2px;
    }
    input, select{
      width:100%; padding: 10px 10px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25); color: rgba(255,255,255,.92);
      outline:none; position:relative; z-index:30; font-size: 13px;
    }
    input:focus, select:focus{ border-color: rgba(124,58,237,.55); box-shadow: 0 0 0 3px rgba(124,58,237,.16); }

    .btnRow{ display:flex; gap:8px; }
    .btn{
      flex:1; padding: 10px 10px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.65));
      color:#fff; font-weight: 900; letter-spacing:.10em; text-transform: uppercase;
      cursor:pointer; font-size: 11px;
    }
    .btn.secondary{ background: rgba(255,255,255,.06); color: rgba(255,255,255,.85); }

    .metaPills{
      padding: 0 10px 10px; display:flex; flex-wrap:wrap; gap:7px;
      background: rgba(0,0,0,.18); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke); flex:0 0 auto;
    }
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10.5px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      display:inline-flex; align-items:center; gap:8px;
    }
    .pill b{ color:#fff; letter-spacing:.06em; }
    .pill.pillHint{ text-transform:none; letter-spacing:.02em; font-size:10.5px; padding:6px 10px; line-height:1.2; justify-content:center; opacity:.9; }

    .pkgLayout{ flex:1; min-height:0; display:flex; flex-direction:column; overflow:hidden; background: rgba(0,0,0,.18); }

    .districtBar{
      display:flex; flex-wrap:nowrap; gap:8px; padding:9px 10px;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.08);
      overflow-x:auto; -webkit-overflow-scrolling: touch;
      background: rgba(0,0,0,.12);
    }
    .distItem{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.86);
      border-radius: 999px;
      padding:8px 10px;
      font-size: 10.5px;
      letter-spacing:.10em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .distItem.active{ border-color: rgba(124,58,237,.70); box-shadow: 0 0 0 3px rgba(124,58,237,.16); background: rgba(124,58,237,.12); }

    .pkgListWrap{ flex:1; min-height:0; display:flex; flex-direction:column; overflow:hidden; }

    .pkgListHdr{
      flex:0 0 auto; display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      backdrop-filter: blur(10px);
    }
    .pkgListTitle{
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 11px;
    }
    .pkgListTitle .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(124,58,237,.9);
      box-shadow: 0 0 0 4px rgba(124,58,237,.18);
    }
    .pkgListMeta{
      font-size:10.5px;
      color: rgba(255,255,255,.72);
      letter-spacing:.10em;
      text-transform: uppercase;
      padding:6px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      white-space: nowrap;
    }

    /* âœ… Easy-to-understand "Visitor" list: big, simple cards */
    .pkgList{
      padding: 10px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      background: rgba(0,0,0,.10);
      flex:1;
    }

    .pkgExplain{
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px;
      color: rgba(255,255,255,.82);
      font-size: 12px;
      line-height: 1.45;
    }
    .pkgExplain b{ color:#fff; }

    .pkgW{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .pkgW:hover{
      transform: translateY(-1px);
      border-color: rgba(124,58,237,.45);
      background: rgba(0,0,0,.28);
    }
    .pkgW.active{
      border-color: rgba(124,58,237,.75);
      box-shadow: 0 0 0 3px rgba(124,58,237,.18);
    }
    .pkgWTop{
      display:flex;
      gap:12px;
      padding:12px;
      align-items:stretch;
    }
    .pkgThumb{
      width:92px; height:92px;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.12), rgba(124,58,237,.18));
      flex: 0 0 auto;
      display:grid; place-items:center;
    }
    .pkgThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pkgThumb .ini{ font-weight:950; letter-spacing:.08em; }

    .pkgWBody{ flex:1; min-width:0; display:flex; flex-direction:column; justify-content:space-between; gap:10px; }

    .pkgWTitle{
      display:flex; align-items:center; gap:10px;
      min-width:0;
      flex-wrap:wrap;
    }
    .pkgWTitle .mainT{
      font-size: 13px;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      flex:1;
      min-width: 180px;
    }
    .pkgBadge{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.86);
      white-space: nowrap;
    }
    .pkgBadge.purple{ border-color: rgba(124,58,237,.45); background: rgba(124,58,237,.14); color:#fff; }
    .pkgBadge.green{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.14); color:#fff; }
    .pkgBadge.orange{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.14); color:#fff; }

    .pkgWMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pkgChip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .pkgChip b{ color:#fff; letter-spacing:.06em; }
    .pkgChip .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* âœ… visitor CTA row */
    .pkgWBottom{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
    }
    .pkgHint{
      font-size: 11px;
      color: rgba(255,255,255,.72);
      letter-spacing:.02em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      flex:1;
      min-width:0;
    }
    .pkgCTA{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 950;
      white-space: nowrap;
      display:flex; gap:8px; align-items:center;
    }
    .pkgCTA.primary{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.18);
    }

    #map{ width:100%; flex:1; min-height: 360px; background: rgba(255,255,255,.04); border-radius: var(--radius); overflow:hidden; }
    .mapTools{
      padding: 9px 10px; border-top:1px solid var(--stroke);
      display:flex; gap:8px; flex-wrap:wrap; flex:0 0 auto; background: rgba(0,0,0,.14);
    }
    .toolBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.88);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none; white-space: nowrap; text-decoration:none;
    }

    .itWrap{
      padding: 10px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;
      min-height:0; flex:1; -webkit-overflow-scrolling: touch; background: rgba(0,0,0,.18);
    }
    .heroCard{ border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.22); border-radius: 14px; padding: 10px; }
    .bigTitle{ margin:0; font-size: 12px; letter-spacing:.18em; text-transform: uppercase; color:#fff; }
    .muted{ color: var(--muted); font-size: 10.8px; letter-spacing:.08em; text-transform: uppercase; line-height:1.35; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:9px; }
    .tabBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.82);
      border-radius: 999px;
      padding: 7px 9px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
    }
    .tabBtn.active{ border-color: rgba(124,58,237,.70); background: rgba(124,58,237,.14); color:#fff; box-shadow: 0 0 0 3px rgba(124,58,237,.14); }
    .tabPanel{ display:none; }
    .tabPanel.active{ display:block; }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .mini{ border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); border-radius: 14px; padding: 9px; }
    .mini .k{ font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(255,255,255,.70); }
    .mini .v{ margin-top:5px; font-size: 13px; font-weight: 950; letter-spacing:.06em; color:#fff; }
    .mini .v small{ font-size: 10.5px; color: rgba(255,255,255,.72); font-weight: 800; }

    .enqRow{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .enqBtn{
      flex:1;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.18);
      color:#fff;
      border-radius: 14px;
      padding: 10px 10px;
      text-decoration:none;
      text-transform: uppercase;
      letter-spacing:.10em;
      font-weight: 950;
      font-size: 11px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
    }
    .enqBtn.disabled{
      opacity:.45;
      pointer-events:none;
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }

    .daysList{ display:flex; flex-direction:column; gap:9px; }
    .dayCard{ border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.22); border-radius: 14px; padding: 10px; }
    .dayTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 7px; }
    .dayTop .d{ font-size: 11px; font-weight: 950; letter-spacing:.18em; text-transform: uppercase; }

    .placeLine{
      display:flex; align-items:center; gap:9px;
      padding: 7px 9px; border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 12px; margin-top: 7px; cursor:pointer;
    }
    .thumb{
      width:36px; height:36px; border-radius: 11px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), rgba(6,182,212,.18));
      flex:0 0 auto; display:grid; place-items:center; font-weight:950; color: rgba(255,255,255,.9); font-size: 11px;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pinfo{ min-width:0; flex:1; }
    .pname{ font-size: 11px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .pmeta{ margin-top:3px; font-size: 10px; letter-spacing:.12em; text-transform: uppercase; color: rgba(255,255,255,.68); white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }

    .placeDetail{ border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.22); border-radius: 14px; padding: 10px; overflow:hidden; }
    .placeHero{
      width:100%; height:150px; border-radius: 12px; overflow:hidden;
      border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); position:relative;
    }
    .placeHero img{ width:100%; height:100%; object-fit:cover; display:block; }
    .galBtn{
      position:absolute; top:50%; transform:translateY(-50%);
      border:1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.45); color:#fff;
      border-radius: 10px; padding: 6px 9px; cursor:pointer; user-select:none;
    }
    .galBtn.left{ left:8px; } .galBtn.right{ right:8px; }
    .dots{ display:flex; gap:6px; justify-content:center; margin-top:8px; }
    .dot{ width:7px; height:7px; border-radius:50%; background: rgba(255,255,255,.35); cursor:pointer; }
    .dot.active{ background:#fff; }

    .toast{
      position:fixed; left: 14px; bottom: 14px; z-index: 9999;
      border:1px solid rgba(255,255,255,.14); background: rgba(10,14,24,.88);
      border-radius: 14px; padding: 9px 10px;
      color: rgba(255,255,255,.82); font-size: 10.5px;
      letter-spacing:.12em; text-transform: uppercase;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      display:none; max-width: 560px;
    }
    .toast.show{ display:block; }

    /* âœ… Cost breakdown is fully hidden now (button + card) */
    #toggleBreakdownBtn{ display:none !important; }
    #breakdownCard{ display:none !important; }
    #priceDebug{ display:none !important; }

    .nearWrap{ border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.22); border-radius: 14px; padding: 10px; }
    .nearGrid{ display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling: touch; padding-bottom:4px; }
    .nearCard{ width: 112px; flex: 0 0 auto; cursor:pointer; user-select:none; }
    .nearSquare{
      width:112px; height:112px; border-radius: 14px; overflow:hidden;
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05);
      display:grid; place-items:center; position:relative;
    }
    .nearSquare img{ width:100%; height:100%; object-fit:cover; display:block; }
    .nearName{
      margin-top:8px; font-size:10.5px; font-weight:950; letter-spacing:.06em; text-transform: uppercase;
      color: rgba(255,255,255,.90); line-height:1.2; text-align:center; max-width:112px;
      white-space:nowrap; overflow:hidden; text-overflow: ellipsis;
    }
    .nearMeta{
      margin-top:4px; font-size:10px; color: rgba(255,255,255,.65); letter-spacing:.08em; text-transform: uppercase;
      text-align:center; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; max-width:112px;
    }

    .footer{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding: 10px 12px;
      color: rgba(255,255,255,.70);
      font-size: 10.5px;
      letter-spacing:.06em;
      text-transform: uppercase;
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .footer a{ color:#fff; text-decoration:none; font-weight:900; }
    .footer a:hover{ text-decoration:underline; }

    /* WhatsApp Floating CTA */
    .waFloat{
      position:fixed; right: 14px; bottom: 14px; z-index: 10000;
      display:flex; align-items:center; gap:10px; padding: 12px 14px;
      border-radius: 999px; border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.55); backdrop-filter: blur(14px);
      box-shadow: 0 28px 90px rgba(0,0,0,.65);
      color:#fff; text-decoration:none; user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .waFloat:hover{ filter: brightness(1.06); transform: translateY(-1px); }
    .waIcon{
      width:40px; height:40px; border-radius: 999px; display:grid; place-items:center;
      background: rgba(34,197,94,.22); border:1px solid rgba(34,197,94,.35); flex:0 0 auto;
    }
    .waText{ display:flex; flex-direction:column; line-height:1.1; min-width:0; }
    .waText .t1{ font-size: 12px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase; white-space:nowrap; }
    .waText .t2{ margin-top:4px; font-size: 11px; color: rgba(255,255,255,.80); letter-spacing:.04em; white-space:nowrap; }
    .waClose{
      width:34px; height:34px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.9);
      display:grid; place-items:center;
      cursor:pointer; flex:0 0 auto; user-select:none;
    }
    @media (max-width: 420px){ .waText{ display:none; } .waFloat{ padding: 10px; } .waClose{ display:none; } }

    @media (max-width: 1100px){
      .shell{ width: 100%; padding: 10px 10px 16px; }
      .main{ grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
      .pane{ min-height: unset; }
      .pane.mapPane{ position: relative; top: auto; height: 520px; max-height: none; }
      #map{ min-height: 320px; }
      .row2{ grid-template-columns: 1fr; }
      .pkgThumb{ width:86px; height:86px; }
    }

    /* âœ… Personal Guide Bot */
    #guideFab{
      position:fixed; right: 14px; bottom: 78px; z-index: 10001;
      width:56px; height:56px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
      box-shadow: 0 28px 90px rgba(0,0,0,.55);
      display:grid; place-items:center;
      cursor:pointer; user-select:none;
      font-size: 22px;
    }
    #guideFab:hover{ transform: translateY(-1px); }

    .gb{
      position:fixed; right:14px; bottom:148px; z-index: 10002;
      width: min(390px, calc(100vw - 28px));
      height: 520px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(7,10,18,.92);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .gb.hidden{ display:none; }
    .gbHead{
      padding:12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .gbTitle{ display:flex; gap:10px; align-items:center; }
    .gbTitle .dot2{
      width:10px; height:10px; border-radius: 999px;
      background:#22c55e; box-shadow: 0 0 16px rgba(34,197,94,.55);
    }
    .gbTitle .t1{ font-weight:950; letter-spacing:.10em; text-transform:uppercase; font-size: 11px; }
    .gbTitle .t2{ color: rgba(255,255,255,.65); font-size: 11px; margin-top:2px; text-transform:none; letter-spacing:.02em; }
    .gbClose{
      width:36px; height:36px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
    }
    .gbBody{
      padding:12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      max-width: 92%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      font-size: 13px;
      line-height: 1.35;
    }
    .msg.bot{ align-self:flex-start; background: rgba(255,255,255,.06); color: rgba(255,255,255,.92); }
    .msg.user{ align-self:flex-end; background: rgba(124,58,237,.22); border-color: rgba(124,58,237,.35); color:#fff; }
    .gbChips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chipBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .chipBtn:hover{ background: rgba(255,255,255,.10); }
    .gbFoot{
      padding:10px;
      display:flex;
      gap:8px;
      border-top:1px solid rgba(255,255,255,.10);
    }
    #gbInput{
      flex:1;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding: 10px 10px;
      outline:none;
    }
    #gbSend{
      width:88px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(34,197,94,.16);
      color:#fff;
      cursor:pointer;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      font-size: 11px;
    }
    #gbSend:hover{ background: rgba(34,197,94,.22); }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="noise"></div>

  <!-- WhatsApp Floating CTA -->
  <a
    class="waFloat"
    id="waFloat"
    href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
    target="_blank" rel="noopener"
    aria-label="Chat on WhatsApp with Chandan Panwar"
  >
    <div class="waIcon" aria-hidden="true">
      <svg width="22" height="22" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M16 3C9.1 3 3.5 8.3 3.5 14.9c0 2.5.8 4.8 2.2 6.7L4 29l7.6-1.9c1.8 1 3.9 1.6 6.4 1.6 6.9 0 12.5-5.3 12.5-11.9S22.9 3 16 3z" fill="rgba(255,255,255,.18)"/>
        <path d="M16.1 6.1c-5.1 0-9.2 3.9-9.2 8.8 0 1.9.6 3.6 1.7 5.1l-1.1 4 4.2-1.1c1.4.8 3.1 1.3 4.9 1.3 5.1 0 9.2-3.9 9.2-8.8s-4.1-8.8-9.2-8.8z" fill="rgba(255,255,255,.22)"/>
        <path d="M23 19.1c-.3.8-1.6 1.5-2.2 1.6-.6.1-1.3.2-2.2-.1-.5-.2-1.2-.4-2-.8-3.5-1.9-5.7-5-5.9-5.3-.2-.3-1.4-1.8-1.4-3.5 0-1.7.9-2.5 1.2-2.9.3-.3.7-.4.9-.4h.7c.2 0 .5-.1.7.5.2.6.9 2.1 1 2.3.1.2.1.5 0 .7-.1.2-.2.4-.4.6-.2.2-.3.3-.5.5-.2.2-.4.4-.2.8.2.4.8 1.3 1.7 2.1 1.2 1.1 2.2 1.4 2.6 1.6.3.2.6.1.8-.1.2-.2 1-1.1 1.2-1.5.2-.4.5-.3.8-.2.3.1 2 .9 2.3 1 .3.1.5.2.6.4.1.1.1.8-.2 1.6z" fill="white" opacity=".92"/>
      </svg>
    </div>
    <div class="waText">
      <div class="t1">WhatsApp</div>
      <div class="t2">Chat for booking</div>
    </div>
    <div class="waClose" id="waClose" title="Hide" aria-label="Hide WhatsApp button">âœ•</div>
  </a>

  <!-- âœ… Personal Guide Bot -->
  <div id="guideFab" title="Need help?">ðŸ’¬</div>
  <div id="guideBot" class="gb hidden" aria-live="polite">
    <div class="gbHead">
      <div class="gbTitle">
        <div class="dot2"></div>
        <div>
          <div class="t1">Guide Bot</div>
          <div class="t2">Iâ€™ll guide you step-by-step</div>
        </div>
      </div>
      <button class="gbClose" id="gbCloseBtn">âœ•</button>
    </div>
    <div class="gbBody" id="gbBody"></div>
    <div class="gbFoot">
      <input id="gbInput" placeholder="Type: Delhi, 5 days, inter, Shimla..." />
      <button id="gbSend">Send</button>
    </div>
  </div>

  <div class="shell">
    <div class="app">

      <div class="top">
        <div class="brand">
          <div class="logo" id="logoBox">
            <img src="logo.png" alt="Himachal Explorer Logo" onerror="this.remove(); document.getElementById('logoBox').textContent='HP';">
          </div>
          <div>
            <div style="margin:0;font-size:13px;letter-spacing:.18em;text-transform:uppercase;font-weight:900;">Himachal Explorer Portal</div>
            <p id="statusLine">Loadingâ€¦</p>
          </div>
        </div>

        <div class="actions">
          <div class="chip primary" id="mintLoginBtn">Mint Login</div>
          <div class="chip" id="fitMapBtn">Fit Route</div>
          <div class="chip" id="clearRouteBtn">Clear</div>
          <div class="chip" id="refreshBtn">Refresh</div>
          <div class="chip good" id="openBotBtn">Guide Bot</div>
        </div>
      </div>

      <!-- âœ… NEW visitor friendly mode bar -->
      <div class="modeBar">
        <div class="modeLeft">
          <div class="modeTitle">Choose Package Type</div>
          <div class="modeHelp">
            <b>Within District</b> = local trips (1â€“3 days).<br/>
            <b>Inter-District</b> = complete tours across districts (3â€“12 days).
          </div>
        </div>

        <div class="seg" aria-label="package type toggle">
          <button class="segBtn active" id="modeAll" type="button">All <span class="segBadge" id="badgeAll">â€”</span></button>
          <button class="segBtn" id="modeInter" type="button">Inter-District <span class="segBadge" id="badgeInter">â€”</span></button>
          <button class="segBtn" id="modeLocal" type="button">Within District <span class="segBadge" id="badgeLocal">â€”</span></button>
        </div>
      </div>

      <div class="main">
        <!-- LEFT -->
        <div class="pane">
          <div class="paneHdr">
            <div>
              <p class="t">Package Finder</p>
              <div class="s">Templates: <b>/templates</b> â€¢ Places: <b>/places_in_packages</b></div>
            </div>
            <div class="s" id="leftHint">Start + Days selection</div>
          </div>

          <div class="filters">
            <div class="field">
              <label>Start (Required)</label>
              <input id="startInp" list="startList" placeholder="E.g. AMRITSAR / DELHI / CHANDIGARH" autocomplete="off">
              <datalist id="startList"></datalist>
            </div>

            <div class="field">
              <label>Visit Type</label>
              <select id="visitType">
                <option value="budget">BUDGET</option>
                <option value="premium">PREMIUM</option>
                <option value="luxury">LUXURY</option>
              </select>
            </div>

            <div class="field">
              <label>Days (Optional)</label>
              <select id="daysSel">
                <option value="">ANY</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                <option>11</option><option>12</option>
              </select>
            </div>

            <div class="field">
              <label>Pax</label>
              <select id="paxSel">
                <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
              </select>
            </div>

            <div class="btnRow">
              <button class="btn secondary" id="resetBtn" type="button">Reset</button>
              <button class="btn" id="genBtn" type="button">Generate</button>
            </div>
          </div>

          <div class="metaPills" id="pills"></div>

          <div class="pkgLayout">
            <div class="districtBar" id="districtBar"></div>

            <div class="pkgListWrap">
              <div class="pkgListHdr">
                <div class="pkgListTitle"><span class="dot"></span>Packages</div>
                <div class="pkgListMeta" id="pkgCount">â€”</div>
              </div>

              <div class="pkgList" id="pkgList">
                <div class="pkgExplain">
                  <b>How to book:</b><br/>
                  1) Select <b>Start</b> â†’ click <b>Generate</b><br/>
                  2) Choose a package (Local / Inter-district)<br/>
                  3) Check itinerary & map â†’ click <b>WhatsApp</b> to finalize.
                </div>
                <div class="pill pillHint"><span>Type Start & click</span> <b>Generate</b></div>
              </div>
            </div>
          </div>
        </div>

        <!-- MID (MAP) -->
        <div class="pane mapPane">
          <div class="paneHdr">
            <div>
              <p class="t">Live Route Map</p>
              <div class="s">OSRM road polyline + markers</div>
            </div>
            <div class="s" id="kmBadge">â€”</div>
          </div>

          <div id="map"></div>

          <div class="mapTools">
            <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
            <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
            <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="pane">
          <div class="paneHdr">
            <div>
              <p class="t">Itinerary</p>
              <div class="s">Day-wise + nearby shown below</div>
            </div>
            <div class="s" id="activePkgName">â€”</div>
          </div>

          <div class="itWrap">
            <div class="heroCard">
              <h3 class="bigTitle" id="itTitle">Select a package</h3>
              <div class="muted" id="itMeta">Day-wise details will appear here</div>

              <div class="enqRow">
                <a id="waEnquiryBtn" class="enqBtn disabled" href="#" target="_blank" rel="noopener">
                  Send Query on WhatsApp
                </a>
              </div>

              <div class="tabs">
                <div class="tabBtn active" id="tabItinBtn">Itinerary</div>
                <div class="tabBtn" id="tabLocBtn">Location</div>
                <div class="tabBtn" id="tabHomeBtn">Home</div>
              </div>
            </div>

            <div class="row2">
              <div class="mini">
                <div class="k">Total (est.)</div>
                <div class="v" id="priceTotal">â€” <small></small></div>
              </div>
              <div class="mini">
                <div class="k">Per Person</div>
                <div class="v" id="pricePer">â€” <small></small></div>
              </div>
            </div>

            <div class="mini">
              <div class="k">Pax used in price</div>
              <div class="v" id="paxUsed">â€” <small></small></div>
            </div>

            <div class="heroCard">
              <div class="muted" style="margin-bottom:8px;">Package includes / excludes</div>
              <div class="muted" id="incExc">â€”</div>
            </div>

            <div class="tabPanel active" id="itinPanel">
              <div class="daysList" id="daysList"></div>
            </div>

            <div class="tabPanel" id="locPanel">
              <div class="placeDetail" id="placeDetail">
                <div class="muted">Tap any place from itinerary to see history + photos here.</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="footer">
        <div>Â© <span id="yr"></span> Himachal Explorer Portal</div>
        <div>
          FIT: <b>Chandan Panwar</b> â€¢
          <a href="tel:+917018138847">7018138847</a> â€¢
          <a href="mailto:chandanpanwar001@gmail.com">chandanpanwar001@gmail.com</a> â€¢
          <a href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package." target="_blank" rel="noopener">WhatsApp</a>
        </div>
      </div>

      <div class="toast" id="toast"></div>
    </div>
  </div>

  <script>
    /* Floating WhatsApp: hide/show preference */
    (function(){
      const KEY = "wa_float_hidden_v1";
      function apply(){
        const hidden = localStorage.getItem(KEY) === "1";
        const el = document.getElementById("waFloat");
        if(el) el.style.display = hidden ? "none" : "flex";
      }
      window.addEventListener("DOMContentLoaded", ()=>{
        const close = document.getElementById("waClose");
        if(close){
          close.addEventListener("click", (e)=>{
            e.preventDefault(); e.stopPropagation();
            localStorage.setItem(KEY, "1");
            apply();
          });
        }
        apply();
      });
    })();
  </script>

  <script>
  /* ===============================
     Firebase Config (FIXED 2 APPs)
     =============================== */

  // âœ… MAIN DB (revnue-records) - templates, places, pricing
  const firebaseConfig = {
    apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
    authDomain: "revnue-records.firebaseapp.com",
    databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "revnue-records",
    storageBucket: "revnue-records.firebasestorage.app",
    messagingSenderId: "182348503564",
    appId: "1:182348503564:web:480085405b09177245ac29",
    measurementId: "G-MGTDBCG896"
  };

  // âœ… IMAGES DB (garg-enterprise) - place_images/{place_id}/{n}/url
  const firebaseConfigImages = {
    apiKey: "AIzaSyBmJDsXvokR8kYs_yoLPau1DqANPBBORJY",
    authDomain: "garg-enterprise.firebaseapp.com",
    databaseURL: "https://garg-enterprise-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "garg-enterprise",
    storageBucket: "garg-enterprise.firebasestorage.app",
    messagingSenderId: "1097408452571",
    appId: "1:1097408452571:web:4e6806326b47ebb0b5b9fe",
    measurementId: "G-S2S0MYT39W"
  };

  const NODE_TEMPLATES    = "templates";
  const NODE_PLACES       = "places_in_packages";
  const NODE_TRANSPORT    = "pricing_transport";
  const NODE_HOTEL        = "rate_hotel";
  const NODE_STAYRULES    = "stay_rate_rules";
  const NODE_PLACE_IMAGES = "place_images"; // âœ… garg DB node

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = String(msg||"");
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }
  function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function normCaps(x){ return String(x||"").trim().toUpperCase().replace(/\s+/g," "); }
  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).slice(0,2);
    const ini = parts.map(x=>x[0]).join("").toUpperCase();
    return ini || "HP";
  }
  function rupees(n){ return "â‚¹" + Math.round(Number(n)||0).toLocaleString("en-IN"); }
  function slugifyName(name){
    return String(name||"")
      .trim().toLowerCase()
      .replace(/&/g," and ")
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }
  function setStatus(msg){ $("statusLine").textContent = msg; }

  function placeIdAny(p, key){ return String(p?.place_id || p?.id || key || "").trim(); }
  function placeNameAny(p, key){
    return String(p?.name || p?.["Location Name"] || p?.title || key || "PLACE").trim();
  }
  function latAny(p){ return Number(p?.latitude ?? p?.lat ?? p?.Latitude); }
  function lngAny(p){ return Number(p?.longitude ?? p?.lng ?? p?.Longitude); }
  function districtAny(p){ return String(p?.district || p?.District || "").trim().toUpperCase(); }

  function toBullets(val){
    if(!val) return [];
    if(Array.isArray(val)) return val.filter(Boolean).slice(0,12);
    return String(val)
      .split(/\n|\||,/g)
      .map(x=>x.trim())
      .filter(Boolean)
      .slice(0,12);
  }

  /* ===============================
     âœ… PLACE IMAGES FROM GARG DB
     place_images/{placeId}/{n}/url
     =============================== */
  let PLACE_IMAGES = {};
  let imagesDb = null;

  function normalizePlaceImages(raw){
    const out = {};
    if(!raw || typeof raw !== "object") return out;

    for(const [placeId, node] of Object.entries(raw)){
      const urls = [];
      const pushUrl = (u)=>{
        const s = String(u||"").trim();
        if(/^https?:\/\//i.test(s)) urls.push(s);
      };

      if(typeof node === "string"){
        pushUrl(node);
      }else if(Array.isArray(node)){
        node.forEach(v=>{
          if(typeof v === "string") pushUrl(v);
          else if(v && typeof v === "object"){
            if(v.url) pushUrl(v.url);
            if(v.imageUrl) pushUrl(v.imageUrl);
            if(v.image) pushUrl(v.image);
          }
        });
      }else if(node && typeof node === "object"){
        Object.values(node).forEach(v=>{
          if(typeof v === "string") pushUrl(v);
          else if(v && typeof v === "object"){
            if(v.url) pushUrl(v.url);
            if(v.imageUrl) pushUrl(v.imageUrl);
            if(v.image) pushUrl(v.image);
          }
        });
      }

      out[String(placeId).trim()] = [...new Set(urls)];
    }
    return out;
  }

  async function loadPlaceImagesFromGarg(){
    if(!imagesDb) return {};
    try{
      const snap = await imagesDb.ref(NODE_PLACE_IMAGES).once("value");
      PLACE_IMAGES = normalizePlaceImages(snap.val() || {});
      return PLACE_IMAGES;
    }catch(e){
      console.error("garg place_images load error:", e);
      PLACE_IMAGES = {};
      return {};
    }
  }

  /* ===============================
     âœ… GITHUB / SITE IMAGE FETCH (place_id wise)
     =============================== */
  const SITE_IMAGES_BASE = "/images";
  const GITHUB_USER = "champishere001";
  const GITHUB_REPO = "Himachal_Explorer";
  const GITHUB_BRANCH = "main";

  const GITHUB_RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/images`;
  const JSDELIVR_BASE   = `https://cdn.jsdelivr.net/gh/${GITHUB_USER}/${GITHUB_REPO}@${GITHUB_BRANCH}/images`;

  function imageBasesInOrder(){
    return [SITE_IMAGES_BASE, JSDELIVR_BASE, GITHUB_RAW_BASE].filter(Boolean);
  }
  function githubFolderCandidates(placeId){
    const id = String(placeId || "").trim();
    if(!id) return [];
    const nums = [1,2,3,4];
    const exts = ["jpg","jpeg","png","webp"];
    const urls = [];
    const bases = imageBasesInOrder();
    for(const base of bases){
      for(const n of nums){
        for(const ext of exts){
          urls.push(`${base}/${id}/${n}.${ext}`);
        }
      }
    }
    return [...new Set(urls)];
  }
  function setImgWithFallback(imgEl, urls){
    let i = 0;
    const list = (urls||[]).filter(Boolean);
    function tryNext(){
      if(i >= list.length){
        imgEl.remove();
        return;
      }
      imgEl.src = list[i++];
    }
    imgEl.onerror = tryNext;
    tryNext();
  }

  /* âœ… NEW: package-friendly photo picking */
  let PLACES = {};
  function pickAllPhotos(p, pid){
    const isValid = (u)=> typeof u==="string" && /^https?:\/\//i.test(u.trim());
    let arr = [];

    if(isValid(p?.imageUrl)) arr.push(p.imageUrl.trim());
    if(isValid(p?.image)) arr.push(p.image.trim());
    if(isValid(p?.img)) arr.push(p.img.trim());

    if(Array.isArray(p?.images)){
      arr.push(...p.images.filter(isValid).map(x=>x.trim()));
    }else if(p?.images && typeof p.images === "object"){
      arr.push(...Object.values(p.images).filter(isValid).map(x=>x.trim()));
    }

    const id = String(pid || p?.place_id || p?.id || "").trim();
    if(id && PLACE_IMAGES[id]?.length) arr.push(...PLACE_IMAGES[id]);

    if(id && (!PLACE_IMAGES[id] || !PLACE_IMAGES[id].length)){
      const nm = placeNameAny(p, id);
      const slug = slugifyName(nm);
      if(slug && PLACE_IMAGES[slug]?.length) arr.push(...PLACE_IMAGES[slug]);
    }

    if(id) arr.push(...githubFolderCandidates(id));
    return [...new Set(arr)];
  }
  function pickThumbPlaceId(routeIds){
    for(const pid of (routeIds||[])){
      if(pid && PLACES[pid]) return pid;
    }
    return (routeIds && routeIds[0]) ? routeIds[0] : "";
  }
  function pickPackagePhotosFromRoute(routeIds){
    const out = [];
    const seen = new Set();
    for(const pid of (routeIds||[])){
      if(!pid || seen.has(pid)) continue;
      seen.add(pid);
      const p = PLACES[pid] || {};
      const imgs = pickAllPhotos(p, pid);
      for(const u of imgs){
        if(out.length >= 4) break;
        out.push(u);
      }
      if(out.length >= 4) break;
    }
    return out;
  }

  /* Tabs */
  function setActiveTab(which){
    const itinBtn = $("tabItinBtn");
    const locBtn  = $("tabLocBtn");
    const itinP   = $("itinPanel");
    const locP    = $("locPanel");
    if(which === "loc"){
      itinBtn.classList.remove("active");
      locBtn.classList.add("active");
      itinP.classList.remove("active");
      locP.classList.add("active");
    }else{
      locBtn.classList.remove("active");
      itinBtn.classList.add("active");
      locP.classList.remove("active");
      itinP.classList.add("active");
    }
  }

  /* Place Details */
  let ACTIVE_PLACE_GALLERY = { pid:"", idx:0, imgs:[] };
  function renderPlaceDetails(pid){
    const p = PLACES[pid] || {};
    const name = placeNameAny(p, pid);
    const dist = districtAny(p) || "";
    const hist = String(p.history_tagline || p.history || "").trim();
    const bullets = toBullets(p.what_you_find || p.whatYouFind);
    const imgs = pickAllPhotos(p, pid);

    ACTIVE_PLACE_GALLERY = { pid, idx:0, imgs };

    const hero = imgs.length ? `
      <div class="placeHero">
        <img id="placeHeroImg" alt="${escapeHtml(name)}" loading="lazy" referrerpolicy="no-referrer">
        ${imgs.length>1 ? `<div class="galBtn left" id="galPrev">â€¹</div><div class="galBtn right" id="galNext">â€º</div>`:""}
      </div>
      ${imgs.length>1 ? `
        <div class="dots" id="galDots">
          ${imgs.map((_,i)=>`<div class="dot ${i===0?'active':''}" data-i="${i}"></div>`).join("")}
        </div>
      `:""}
    ` : `
      <div class="placeHero" style="display:grid;place-items:center;">
        <div class="muted">No photo available</div>
      </div>
    `;

    $("placeDetail").innerHTML = `
      ${hero}
      <div style="margin-top:10px;">
        <div style="font-weight:950; font-size:13px;">${escapeHtml(name)}</div>
        ${dist ? `<div style="opacity:.8; font-size:11px; margin-top:2px;">${escapeHtml(dist)}</div>` : ``}
      </div>

      ${hist ? `
        <div style="margin-top:12px; font-weight:950; letter-spacing:.10em; text-transform:uppercase; font-size:10.5px; opacity:.95;">History</div>
        <div style="margin-top:6px; font-size:12px; opacity:.9; line-height:1.5;">${escapeHtml(hist)}</div>
      ` : ``}

      ${bullets.length ? `
        <div style="margin-top:12px; font-weight:950; letter-spacing:.10em; text-transform:uppercase; font-size:10.5px; opacity:.95;">What you can find</div>
        <ul style="margin:8px 0 0 18px; padding:0;">
          ${bullets.map(b=>`<li style="margin:5px 0; font-size:12px; opacity:.92;">${escapeHtml(b)}</li>`).join("")}
        </ul>
      ` : ``}
    `;

    const heroImg = document.getElementById("placeHeroImg");
    if(heroImg && imgs.length) setImgWithFallback(heroImg, imgs);

    if(imgs.length > 1){
      $("galPrev").onclick = ()=>galleryStep(-1);
      $("galNext").onclick = ()=>galleryStep(1);
      $("galDots").querySelectorAll(".dot").forEach(dot=>{
        dot.onclick = ()=>{ const i = Number(dot.dataset.i || 0); galleryGo(i); };
      });
    }
    setActiveTab("loc");
  }
  function galleryGo(i){
    const g = ACTIVE_PLACE_GALLERY;
    if(!g.imgs.length) return;
    g.idx = (i + g.imgs.length) % g.imgs.length;
    const img = $("placeHeroImg");
    if(img){
      const rotated = g.imgs.slice(g.idx).concat(g.imgs.slice(0,g.idx));
      setImgWithFallback(img, rotated);
    }
    const dots = $("galDots");
    if(dots){
      dots.querySelectorAll(".dot").forEach((d,ix)=>d.classList.toggle("active", ix===g.idx));
    }
  }
  function galleryStep(delta){ const g = ACTIVE_PLACE_GALLERY; galleryGo(g.idx + delta); }

  /* Distance */
  function haversineKm(aLat,aLng,bLat,bLng){
    const R = 6371;
    const toRad = (x)=> x * Math.PI/180;
    const dLat = toRad(bLat-aLat);
    const dLng = toRad(bLng-aLng);
    const s1 = Math.sin(dLat/2);
    const s2 = Math.sin(dLng/2);
    const q = s1*s1 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*s2*s2;
    return 2 * R * Math.asin(Math.min(1, Math.sqrt(q)));
  }

  /* Day-wise Nearby */
  function getNearbyForDay(dayPlaceIds, opts){
    const { limit=6, radiusKm=15, excludeSet=new Set(), preferSameDistrict=true } = (opts||{});
    const used = new Set([...(dayPlaceIds||[]).filter(Boolean)]);
    for(const x of excludeSet) used.add(x);

    const anchors = (dayPlaceIds||[])
      .map(id => ({ id, p: PLACES[id] }))
      .filter(x => x.p && isFinite(latAny(x.p)) && isFinite(lngAny(x.p)));
    if(!anchors.length) return [];

    const anchorDistricts = new Set(anchors.map(a=>districtAny(a.p)).filter(Boolean));
    const candidatesSame = [];
    const candidatesAny  = [];

    for(const [pid, p] of Object.entries(PLACES)){
      if(used.has(pid)) continue;
      const lat = latAny(p), lng = lngAny(p);
      if(!isFinite(lat) || !isFinite(lng)) continue;

      let best = Infinity;
      for(const a of anchors){
        const d = haversineKm(latAny(a.p), lngAny(a.p), lat, lng);
        if(d < best) best = d;
      }
      if(best > radiusKm) continue;

      const dist = districtAny(p);
      const item = { pid, bestKm: best };
      if(preferSameDistrict && dist && anchorDistricts.has(dist)) candidatesSame.push(item);
      else candidatesAny.push(item);
    }

    candidatesSame.sort((a,b)=>a.bestKm-b.bestKm);
    candidatesAny.sort((a,b)=>a.bestKm-b.bestKm);

    const out = [];
    for(const it of candidatesSame){ out.push(it); if(out.length>=limit) break; }
    if(out.length<limit){
      for(const it of candidatesAny){ out.push(it); if(out.length>=limit) break; }
    }
    return out;
  }

  function renderNearbyRow(containerEl, dayPlaceIds, excludeSet){
    const near = getNearbyForDay(dayPlaceIds, { limit:6, radiusKm:15, excludeSet, preferSameDistrict:true });
    if(!near.length) return;

    const wrap = document.createElement("div");
    wrap.style.marginTop = "10px";
    wrap.innerHTML = `
      <div class="muted" style="margin-top:10px; margin-bottom:8px;">Nearby (close to todayâ€™s location)</div>
      <div class="nearGrid"></div>
    `;
    const grid = wrap.querySelector(".nearGrid");

    near.forEach(({pid, bestKm})=>{
      const p = PLACES[pid] || {};
      const nm = placeNameAny(p, pid);
      const dist = districtAny(p) || "";
      const urls = pickAllPhotos(p, pid);

      const card = document.createElement("div");
      card.className = "nearCard";
      card.innerHTML = `
        <div class="nearSquare">
          ${urls.length ? `<img data-npid="${escapeHtml(pid)}" alt="${escapeHtml(nm)}" loading="lazy" referrerpolicy="no-referrer">`
                        : `<div style="font-weight:950;opacity:.9;">${escapeHtml(initials(nm))}</div>`}
        </div>
        <div class="nearName" title="${escapeHtml(nm)}">${escapeHtml(nm)}</div>
        <div class="nearMeta" title="${escapeHtml(dist)}">${escapeHtml(dist || (bestKm?bestKm.toFixed(1)+" km":""))}</div>
      `;
      const img = card.querySelector("img[data-npid]");
      if(img) setImgWithFallback(img, urls);

      card.onclick = ()=>{
        renderPlaceDetails(pid);
        const lat = latAny(p), lng = lngAny(p);
        if(isFinite(lat) && isFinite(lng) && window.map){
          map.setView([lat,lng], Math.max(map.getZoom(), 12), { animate:true });
          invalidateMapSoon();
        }
      };
      grid.appendChild(card);
    });

    containerEl.appendChild(wrap);
    near.forEach(n=>excludeSet.add(n.pid));
  }

  /* Map */
  let map, tile, markersLayer, routeLine;
  let showMode = "all";
  let tilesDark = false;

  function invalidateMapSoon(){
    try{
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 60);
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 260);
    }catch(e){}
  }

  function initMap(){
    map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
    tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    tile.addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    invalidateMapSoon();
    window.addEventListener("resize", invalidateMapSoon);
  }
  function clearMap(){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    $("kmBadge").textContent = "â€”";
    invalidateMapSoon();
  }
  function fitRoute(){ if(routeLine) map.fitBounds(routeLine.getBounds(), { padding:[22,22] }); }

  /* Data */
  let db, analytics, auth;
  let TEMPLATES = {};
  let ACTIVE_TEMPLATES = [];
  let NAME_TO_ID = new Map();
  let STARTS = [];

  let INTER_ALL = [];
  let DISTRICT_KEYS = [];
  let ACTIVE_DISTRICT = "ALL";

  let CURRENT_TEMPLATE_KEY = "";
  let CURRENT_ROUTE_KM = 0;

  let pricing_transport = {};
  let rate_hotel = {};
  let stay_rate_rules = {};
  let PRICING_READY = false;

  const CACHE_KEY = "hp_portal_cache_v19_visitor_easy";
  const CACHE_TTL_MS = 1000 * 60 * 30;

  /* âœ… WhatsApp Finalize */
  const WHATSAPP_NUMBER = "917018138847";
  function setWhatsAppEnquiryEnabled(enabled, url){
    const btn = $("waEnquiryBtn");
    if(!btn) return;
    if(enabled){
      btn.classList.remove("disabled");
      btn.href = url || "#";
    }else{
      btn.classList.add("disabled");
      btn.href = "#";
    }
  }

  function buildWhatsAppMessage({tpl, startName, endKey, pax, tier, km, total, perPerson}){
    const days = Number(tpl?.days || 0) || 0;
    const code = String(tpl?.route_id || "â€”");
    const route = String(tpl?.route_path || "").trim();
    const includes = String(tpl?.includes || tpl?.inclusions || "").trim();

    const pkgType = isLocalComputed(tpl) ? "WITHIN DISTRICT (LOCAL)" : "INTER-DISTRICT TOUR";

    const lines = [
      "Hi Chandan, I want to finalize this package:",
      "",
      `Package Type: ${pkgType}`,
      `Start: ${String(startName||"").toUpperCase()}`,
      `Destination: ${String(endKey||"").toUpperCase()}`,
      `Days: ${days}`,
      `Plan: ${String(tier||"").toUpperCase()}`,
      `Pax: ${pax}`,
      `Route KM (est.): ${isFinite(km)?Number(km).toFixed(1):"â€”"}`,
      `Total (est.): ${isFinite(total)?rupees(total):"â€”"}`,
      `Per Person (est.): ${isFinite(perPerson)?rupees(perPerson):"â€”"}`,
      `Code: ${code}`,
      route ? `Route: ${route}` : "",
      includes ? `Includes: ${includes}` : "",
      "",
      "Please confirm final price and availability."
    ].filter(Boolean);

    return lines.join("\n");
  }

  function updateWhatsAppForCurrent(){
    try{
      if(!CURRENT_TEMPLATE_KEY){ setWhatsAppEnquiryEnabled(false); return; }
      const tpl = TEMPLATES?.[CURRENT_TEMPLATE_KEY];
      if(!tpl){ setWhatsAppEnquiryEnabled(false); return; }

      const start = normalizeStartInput() || (tpl.start_point || tpl.start || "");
      const endKey = endKeyFromRoutePath(tpl);
      const pax = getSelectedPax();
      const tier = String($("visitType")?.value || "budget");
      const km = Number(CURRENT_ROUTE_KM || 0) || Number(tpl.total_km_est || tpl.estimated_drive_km || tpl.total_km || 0);

      const est = estimateTotalCost({ km, days: Number(tpl.days||3), pax, tpl });
      const total = est.total;
      const perPerson = isFinite(total) ? (total/pax) : NaN;

      const msg = buildWhatsAppMessage({tpl, startName:start, endKey, pax, tier, km, total, perPerson});
      const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
      setWhatsAppEnquiryEnabled(true, url);
    }catch(e){
      console.error(e);
      setWhatsAppEnquiryEnabled(false);
    }
  }

  function loadCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return false;
      const parsed = JSON.parse(raw);
      if(!parsed?.ts) return false;
      if(Date.now() - parsed.ts > CACHE_TTL_MS) return false;

      PLACES = parsed.places || {};
      TEMPLATES = parsed.templates || {};
      pricing_transport = parsed.pricing_transport || {};
      rate_hotel = parsed.rate_hotel || {};
      stay_rate_rules = parsed.stay_rate_rules || {};
      PLACE_IMAGES = parsed.place_images || {};
      PRICING_READY = true;

      ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
        .map(([key,obj])=>({key, ...(obj||{})}))
        .filter(t=>{ const st = safeLower(t.status || "active"); return st==="active" || st==="enabled" || st==="true"; });

      buildNameIndex();
      buildStartList(ACTIVE_TEMPLATES);

      setStatus(`Loaded from cache â€¢ ${ACTIVE_TEMPLATES.length} templates â€¢ ${Object.keys(PLACES).length} places`);
      return true;
    }catch(e){ return false; }
  }
  function saveCache(){
    try{
      localStorage.setItem(CACHE_KEY, JSON.stringify({
        ts: Date.now(),
        places: PLACES,
        templates: TEMPLATES,
        pricing_transport,
        rate_hotel,
        stay_rate_rules,
        place_images: PLACE_IMAGES
      }));
    }catch(e){}
  }

  function buildNameIndex(){
    NAME_TO_ID = new Map();
    for(const [key, p] of Object.entries(PLACES||{})){
      const id = placeIdAny(p, key);
      const nm = placeNameAny(p, id);
      if(id) NAME_TO_ID.set(String(id).toLowerCase(), id);
      if(nm) NAME_TO_ID.set(String(nm).toLowerCase(), id);
    }
  }

  function buildStartList(templates){
    const set = new Set();
    templates.forEach(t=>{
      const s = String(t.start_point || t.start || "").trim();
      if(s) set.add(s);
    });
    STARTS = Array.from(set).sort((a,b)=>a.localeCompare(b));
    const dl = $("startList");
    dl.innerHTML = "";
    STARTS.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = String(s).toUpperCase();
      dl.appendChild(opt);
    });
  }

  function normalizeStartInput(){
    const typed = String($("startInp").value || "").trim().toUpperCase();
    if(!typed) return "";
    const exact = STARTS.find(s => String(s).trim().toUpperCase() === typed);
    if(exact) return exact;
    const partial = STARTS.find(s => String(s).trim().toUpperCase().startsWith(typed));
    if(partial) return partial;
    return "";
  }

  function getPlaceIdByNameAny(name){
    const nm = String(name || "").trim();
    if(!nm) return "";
    const direct = NAME_TO_ID.get(nm.toLowerCase());
    if(direct && PLACES[direct]) return direct;
    const slug = slugifyName(nm);
    if(slug && PLACES[slug]) return slug;
    return "";
  }

  function stopsFromTemplate(tpl){
    const days = Number(tpl.days || 1);
    const out = [];
    const seen = new Set();

    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      if(!raw) continue;
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
        if(seen.has(pid)) return;
        seen.add(pid);
        out.push(pid);
      });
    }

    if(!out.length){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>out.push(pid));
    }
    return out;
  }

  function routeIdsFromTemplateIncludingStart(tpl){
    const baseStops = stopsFromTemplate(tpl);
    const startName = String(tpl?.start_point || tpl?.start || "").trim();
    const startPid = getPlaceIdByNameAny(startName);
    if(startPid){
      const filtered = baseStops.filter(x => x !== startPid);
      return [startPid, ...filtered];
    }
    return baseStops;
  }

  function getEndNameFromRoutePath(tpl){
    const start = String(tpl.start_point || tpl.start || "").trim().toLowerCase();
    const rpRaw = String(tpl.route_path || "").trim();
    if(!rpRaw) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";

    const tokens = rpRaw.replace(/->/g,"|").replace(/>/g,"|")
      .split("|").map(x=>String(x||"").trim()).filter(Boolean);
    if(!tokens.length) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";

    let end = tokens[tokens.length - 1];
    if(end && start && end.toLowerCase() === start && tokens.length >= 2) end = tokens[tokens.length - 2];
    return end || "UNKNOWN";
  }

  function endDistrictFromTemplate(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const pid = getPlaceIdByNameAny(endName);
    if(pid && PLACES[pid]){
      const d = districtAny(PLACES[pid]);
      if(d) return d;
    }
    const td = String(tpl.district || tpl.end_district || "").trim().toUpperCase();
    if(td) return td;
    return normCaps(endName || "UNKNOWN");
  }

  function endKeyFromRoutePath(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const pid = getPlaceIdByNameAny(endName);
    if(pid && PLACES[pid]){
      const d = districtAny(PLACES[pid]);
      return d || normCaps(endName);
    }
    return normCaps(endName);
  }

  function isLocalComputed(tpl){
    const routeId = String(tpl.route_id || "").toUpperCase().trim();
    const regionStyle = String(tpl.region_style || "").toLowerCase().trim();
    const pkgId = String(tpl.package_id || tpl.key || "").toLowerCase();
    return regionStyle === "local" || routeId.endsWith("-LCL") || pkgId.includes("-local");
  }

  /* âœ… NEW: Visitor mode filter */
  let VISITOR_MODE = "all"; // all | inter | local
  function matchesVisitorMode(tpl){
    const local = isLocalComputed(tpl);
    if(VISITOR_MODE === "local") return local;
    if(VISITOR_MODE === "inter") return !local;
    return true;
  }

  function matchesStart(tpl, startUpper){
    return String(tpl.start_point||tpl.start||"").trim().toUpperCase() === startUpper;
  }
  function matchesDaysOptional(tpl, daysFilter){
    if(!daysFilter) return true;
    return Number(tpl.days||0) === Number(daysFilter);
  }

  function highlightActiveCard(){
    document.querySelectorAll(".pkgW").forEach(x=>x.classList.toggle("active", x.dataset.key === CURRENT_TEMPLATE_KEY));
  }

  function approxKmFromTpl(t){
    const km = Number(t.total_km_est || t.estimated_drive_km || t.total_km || 0);
    return isFinite(km) && km>0 ? km : 0;
  }

  /* âœ… VISITOR-FRIENDLY CARD LABELS */
  function nicePackageTitle(tpl, startUpper){
    const days = Number(tpl.days||0) || 0;
    const local = isLocalComputed(tpl);
    if(local){
      const rp = String(tpl.route_path || tpl.route_name || tpl.package_id || "").trim();
      return rp ? rp : `Local Tour (${days} Days)`;
    }
    const district = endDistrictFromTemplate(tpl);
    return `${startUpper} â†’ ${district}`;
  }

  function renderVisitorCard(tpl, startUpper){
    const days = Number(tpl.days||0) || 0;
    const local = isLocalComputed(tpl);
    const km = approxKmFromTpl(tpl);
    const code = String(tpl.route_id || (local ? "LOCAL" : "â€”")).toUpperCase();
    const title = nicePackageTitle(tpl, startUpper);

    const routeIds = routeIdsFromTemplateIncludingStart(tpl);
    const thumbPid = pickThumbPlaceId(routeIds);
    const p0 = PLACES[thumbPid] || {};
    const nm0 = placeNameAny(p0, thumbPid);
    const ini = initials(nm0);

    const pkgPhotos = pickPackagePhotosFromRoute(routeIds);
    const thumbUrls = pkgPhotos.length ? pkgPhotos : pickAllPhotos(p0, thumbPid);

    const badgeType = local ? `<span class="pkgBadge green">WITHIN DISTRICT</span>` : `<span class="pkgBadge orange">INTER-DISTRICT</span>`;
    const badgeDays = `<span class="pkgBadge purple">${days} DAYS</span>`;

    const hint = String(tpl.route_path || "").trim() || (local ? "Local sightseeing & nearby spots" : "Complete tour across districts");

    const el = document.createElement("div");
    el.className = "pkgW";
    el.dataset.key = tpl.key;

    el.innerHTML = `
      <div class="pkgWTop">
        <div class="pkgThumb">
          ${thumbUrls.length
            ? `<img data-thumb="${escapeHtml(thumbPid||"")}" alt="Package thumbnail" loading="lazy" referrerpolicy="no-referrer">`
            : `<div class="ini">${escapeHtml(ini)}</div>`
          }
        </div>

        <div class="pkgWBody">
          <div class="pkgWTitle">
            <div class="mainT">${escapeHtml(title)}</div>
            ${badgeType}
            ${badgeDays}
          </div>

          <div class="pkgWMeta">
            <div class="pkgChip">KM <b>${km ? km.toFixed(0) : "â€”"}</b></div>
            <div class="pkgChip">Code <b class="mono">${escapeHtml(code)}</b></div>
            <div class="pkgChip">Tap to open itinerary</div>
          </div>
        </div>
      </div>

      <div class="pkgWBottom">
        <div class="pkgHint" title="${escapeHtml(hint)}">${escapeHtml(hint.slice(0, 110))}</div>
        <div class="pkgCTA primary">Open â†’</div>
      </div>
    `;

    const img = el.querySelector("img[data-thumb]");
    if(img) setImgWithFallback(img, thumbUrls);

    el.onclick = ()=>openTemplate(tpl.key, startUpper);
    return el;
  }

  function renderDistrictChips(){
    const bar = $("districtBar");
    if(!bar) return;

    const chips = ["ALL", ...DISTRICT_KEYS];
    if(!ACTIVE_DISTRICT || !chips.includes(ACTIVE_DISTRICT)) ACTIVE_DISTRICT = "ALL";

    bar.innerHTML = chips.map(d=>{
      const active = (d===ACTIVE_DISTRICT) ? "active" : "";
      const label = (d==="ALL") ? "ALL DESTINATIONS" : d;

      // Inter count respects visitor mode
      const base = INTER_ALL.filter(t=>matchesVisitorMode(t));
      const count = (d==="ALL") ? base.length : base.filter(t=>endDistrictFromTemplate(t)===d).length;

      return `<div class="distItem ${active}" data-d="${escapeHtml(d)}">${escapeHtml(label)} (${count})</div>`;
    }).join("");

    bar.querySelectorAll(".distItem").forEach(el=>{
      el.onclick = ()=>{ ACTIVE_DISTRICT = el.dataset.d || "ALL"; renderPackagesList(); };
    });
  }

  function renderPackagesList(){
    const box = $("pkgList");
    const start = normalizeStartInput() || "";
    const startUpper = String(start).trim().toUpperCase();
    const daysF = $("daysSel").value.trim();

    box.innerHTML = "";

    // help card always on top
    const help = document.createElement("div");
    help.className = "pkgExplain";
    help.innerHTML = `
      <b>Quick guide:</b> Select <b>Start</b> â†’ click <b>Generate</b> â†’ choose <b>Inter-District</b> or <b>Within District</b> â†’ open package â†’ click <b>WhatsApp</b>.
    `;
    box.appendChild(help);

    if(!startUpper){
      const pill = document.createElement("div");
      pill.className = "pill pillHint";
      pill.innerHTML = `<span>Type Start & click</span> <b>Generate</b>`;
      box.appendChild(pill);
      $("pkgCount").textContent = "â€”";
      return;
    }

    let shown = ACTIVE_TEMPLATES
      .filter(t => matchesStart(t, startUpper))
      .filter(t => matchesDaysOptional(t, daysF))
      .filter(t => matchesVisitorMode(t))
      .sort((a,b)=>{
        const la = isLocalComputed(a), lb = isLocalComputed(b);
        if(la !== lb) return la ? 1 : -1; // inter first then local (better for visitors)
        const da = Number(a.days||0), db = Number(b.days||0);
        if(da !== db) return da - db;
        const kmA = approxKmFromTpl(a) || 1e9;
        const kmB = approxKmFromTpl(b) || 1e9;
        return kmA - kmB;
      });

    // build inter list for district chips
    INTER_ALL = shown.filter(t => !isLocalComputed(t));
    const set = new Set();
    INTER_ALL.forEach(t => set.add(endDistrictFromTemplate(t)));
    DISTRICT_KEYS = Array.from(set).sort((a,b)=>a.localeCompare(b));
    if(!DISTRICT_KEYS.includes(ACTIVE_DISTRICT)) ACTIVE_DISTRICT = "ALL";
    renderDistrictChips();

    // Apply district filter only to inter-district packages
    if(ACTIVE_DISTRICT && ACTIVE_DISTRICT !== "ALL"){
      shown = shown.filter(t => {
        if(isLocalComputed(t)) return true;
        return endDistrictFromTemplate(t) === ACTIVE_DISTRICT;
      });
    }

    $("pkgCount").textContent = `${shown.length} Results`;

    // section headings
    const interHdr = document.createElement("div");
    interHdr.className = "pkgExplain";
    interHdr.innerHTML = `<b>Inter-District Tours</b> (full tour across Himachal)`;
    box.appendChild(interHdr);

    const inters = shown.filter(t => !isLocalComputed(t));
    if(!inters.length){
      const none = document.createElement("div");
      none.className = "pill";
      none.innerHTML = `<b>No inter-district package found</b>`;
      box.appendChild(none);
    }else{
      inters.forEach(t => box.appendChild(renderVisitorCard(t, startUpper)));
    }

    const localHdr = document.createElement("div");
    localHdr.className = "pkgExplain";
    localHdr.innerHTML = `<b>Within District</b> (local sightseeing, short trips)`;
    box.appendChild(localHdr);

    const locals = shown.filter(t => isLocalComputed(t));
    if(!locals.length){
      const none2 = document.createElement("div");
      none2.className = "pill";
      none2.innerHTML = `<b>No within-district package found</b>`;
      box.appendChild(none2);
    }else{
      locals.forEach(t => box.appendChild(renderVisitorCard(t, startUpper)));
    }

    highlightActiveCard();
  }

  function buildDayWise(tpl){
    const days = Number(tpl.days || 1);
    const blocks = [];
    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      blocks.push({ day:d, ids });
    }
    const anyHas = blocks.some(x=>x.ids.length);
    if(!anyHas){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      return [{ day:1, ids }];
    }
    return blocks.filter(x=>x.ids.length);
  }

  function renderItinerary(tpl, start, endKey){
    $("activePkgName").textContent = `${String(tpl.days||"â€”")}D`;
    $("itTitle").textContent = nicePackageTitle(tpl, (start||"START").toUpperCase());

    const metaParts = [];
    metaParts.push(isLocalComputed(tpl) ? "Within District (Local)" : "Inter-District Tour");
    if(tpl.route_id) metaParts.push(`Code: ${tpl.route_id}`);
    if(tpl.route_path) metaParts.push(`Route: ${tpl.route_path}`);
    $("itMeta").textContent = metaParts.join(" â€¢ ") || "â€”";

    const inc = String(tpl.includes || tpl.inclusions || "").trim();
    const exc = String(tpl.excludes || tpl.exclusions || "").trim();
    const note = String(tpl.important_notes || tpl.notes || "").trim();
    $("incExc").innerHTML =
      `<b style="color:#fff;letter-spacing:.12em;">INCLUDES:</b> ${escapeHtml(inc || "â€”")}<br><br>` +
      `<b style="color:#fff;letter-spacing:.12em;">EXCLUDES:</b> ${escapeHtml(exc || "â€”")}<br><br>` +
      `<b style="color:#fff;letter-spacing:.12em;">NOTES:</b> ${escapeHtml(note || "â€”")}`;

    const daysList = $("daysList");
    daysList.innerHTML = "";
    $("placeDetail").innerHTML = `<div class="muted">Tap any place from itinerary to see history + photos here.</div>`;

    const routeAll = routeIdsFromTemplateIncludingStart(tpl);
    const excludeSet = new Set(routeAll.filter(Boolean));

    const blocks = buildDayWise(tpl);
    blocks.forEach(block=>{
      const dayCard = document.createElement("div");
      dayCard.className = "dayCard";
      dayCard.innerHTML = `
        <div class="dayTop">
          <div class="d">Day ${block.day}</div>
          <div class="muted">${block.ids.length} places</div>
        </div>
        <div class="muted">Places</div>
        <div class="dayPlaces"></div>
      `;
      const cont = dayCard.querySelector(".dayPlaces");

      block.ids.forEach(pid=>{
        const p = PLACES[pid] || {};
        const name = placeNameAny(p, pid);
        const dist = districtAny(p) || "â€”";
        const urls = pickAllPhotos(p, pid);

        const line = document.createElement("div");
        line.className = "placeLine";
        line.innerHTML = `
          <div class="thumb">
            ${urls.length ? `<img data-plthumb="${escapeHtml(pid)}" alt="${escapeHtml(name)} photo" loading="lazy" referrerpolicy="no-referrer">`
                          : escapeHtml(initials(name))}
          </div>
          <div class="pinfo">
            <div class="pname">${escapeHtml(name)}</div>
            <div class="pmeta">${escapeHtml(dist)}</div>
          </div>
        `;
        const img = line.querySelector("img[data-plthumb]");
        if(img) setImgWithFallback(img, urls);

        line.onclick = ()=>{
          renderPlaceDetails(pid);
          const lat = latAny(p), lng = lngAny(p);
          if(isFinite(lat) && isFinite(lng)){
            map.setView([lat,lng], Math.max(map.getZoom(), 12), { animate:true });
            invalidateMapSoon();
          }
        };
        cont.appendChild(line);
      });

      renderNearbyRow(cont, block.ids, excludeSet);
      daysList.appendChild(dayCard);
    });
  }

  async function drawRoadRouteFromPlaces(placeIds){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }

    const pts = [];
    const validIds = [];
    for(const pid of placeIds){
      const p = PLACES[pid] || {};
      const lat = latAny(p);
      const lng = lngAny(p);
      if(isFinite(lat) && isFinite(lng)){
        pts.push([lng,lat]);
        validIds.push(pid);
      }
    }
    if(pts.length < 2){
      toast("Not enough coordinates for route");
      return { ok:false, km:0 };
    }

    const maxPts = 25;
    let used = pts;
    if(pts.length > maxPts){
      const step = Math.ceil(pts.length / maxPts);
      used = pts.filter((_,i)=> i%step===0 || i===pts.length-1);
    }

    try{
      const url =
        "https://router.project-osrm.org/route/v1/driving/" +
        used.map(c=>c.join(",")).join(";") +
        "?overview=full&geometries=geojson&steps=false";

      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes?.length){
        toast("Road route not available");
        return { ok:false, km:0 };
      }

      const r = data.routes[0];
      const latlngs = r.geometry.coordinates.map(c=>[c[1],c[0]]);
      routeLine = L.polyline(latlngs, { weight: 5, opacity: .95 }).addTo(map);
      fitRoute();
      invalidateMapSoon();

      const markIds = (showMode==="startend")
        ? [validIds[0], validIds[validIds.length-1]]
        : validIds;

      for(let i=0;i<markIds.length;i++){
        const pid = markIds[i];
        const p = PLACES[pid] || {};
        const lat = latAny(p);
        const lng = lngAny(p);
        if(!isFinite(lat)||!isFinite(lng)) continue;
        const mk = L.marker([lat,lng], { riseOnHover:true }).addTo(markersLayer);
        mk.on("click", ()=> renderPlaceDetails(pid));
      }

      const km = Number(r.distance/1000);
      $("kmBadge").textContent = km.toFixed(1) + " KM";
      return { ok:true, km };
    }catch(e){
      console.error(e);
      toast("Route error");
      return { ok:false, km:0 };
    }
  }

  /* Pricing (kept same as your original; breakdown removed from UI) */
  function pickStayRule(tier){
    const t = String(tier||"budget").toLowerCase();
    const key = (t==="premium") ? "r2" : (t==="luxury") ? "r3" : "r1";
    return stay_rate_rules?.[key] || {};
  }
  function pickVehicleByPax(pax){
    pax = Number(pax||2);
    if(pax <= 4) return "hatchback";
    if(pax <= 7) return "innova";
    return "luxury_suv";
  }
  function autoSeason(tpl){
    const text = String(tpl?.best_season || "").toLowerCase();
    if(/monsoon|rain|jul|aug/.test(text)) return "low";
    if(/winter|snow|snowfall|dec|jan/.test(text)) return "peak";
    if(/peak/.test(text)) return "peak";
    if(/low/.test(text)) return "low";
    if(/mid/.test(text)) return "mid";
    const m = new Date().getMonth() + 1;
    if([1,5,6,10,12].includes(m)) return "peak";
    if([2,7,8].includes(m)) return "low";
    return "mid";
  }
  function pickBaseRoomBySeason(rule, season){
    const s = String(season||"mid").toLowerCase();
    if(s === "low")  return Number(rule.base_rate_low || rule.base_rate_mid || rule.base_rate_peak || 0);
    if(s === "peak") return Number(rule.base_rate_peak || rule.base_rate_mid || rule.base_rate_low || 0);
    return Number(rule.base_rate_mid || rule.base_rate_low || rule.base_rate_peak || 0);
  }
  function computeSnowMultiplier(tpl, vehicle){
    const sr = String(tpl?.snow_risk || "").toLowerCase();
    const base = Number(vehicle?.snow_multiplier || 1);
    if(!isFinite(base) || base <= 0) return 1;
    if(sr.includes("high")) return base;
    if(sr.includes("medium")) return 1 + (base - 1) * 0.5;
    return 1;
  }
  function computeRoadMultiplier(tpl, vehicle){
    const rt = String(tpl?.road_type || "").toLowerCase();
    const dl = String(tpl?.drive_level || "").toLowerCase();
    const bad = Number(vehicle?.bad_road_multiplier || 1);
    const hill = Number(vehicle?.hill_multiplier || 1);
    let m = 1;
    if(rt.includes("bad") || rt.includes("mix")) m *= (isFinite(bad) && bad>0 ? bad : 1);
    if(dl.includes("high") || rt.includes("hill")) m *= (isFinite(hill) && hill>0 ? hill : 1);
    return m;
  }
  function estimateTotalCost({ km=0, days=3, pax=2, tpl=null }){
    km = Number(km||0);
    days = Number(days||0);
    pax = Math.max(1, Number(pax||1));
    const nights = Math.max(0, days-1);

    if(!PRICING_READY || !isFinite(km) || km<=0 || !days){
      return { total:NaN, perPerson:NaN, breakdown:null };
    }

    const tier   = String($("visitType")?.value || "budget").toLowerCase();
    const season = autoSeason(tpl);

    const vehicleKey = pickVehicleByPax(pax);
    const v = pricing_transport?.[vehicleKey] || {};

    const perKm = Number(v.per_km || 0);
    const driverPerDay = Number(v.driver_per_day || 0);
    const minKmPerDay = Number(v.min_km_per_day || 0);
    const nightCharge = Number(v.night_charge || 0);
    const tollPct = Number(v.parking_toll_buffer_pct || 0);

    const minBillKm = (isFinite(minKmPerDay) && minKmPerDay > 0) ? (days * minKmPerDay) : 0;
    const billedKm = Math.max(km, minBillKm);

    const roadMul = computeRoadMultiplier(tpl, v);
    const snowMul = computeSnowMultiplier(tpl, v);
    const bufferMul = 1 + (isFinite(tollPct) ? tollPct : 0) / 100;

    const transportKmCost = billedKm * perKm * roadMul * snowMul * bufferMul;
    const driverCost = days * driverPerDay;
    const nightCost = nights * nightCharge;

    const transport = transportKmCost + driverCost + nightCost;

    const rule = pickStayRule(tier);
    const baseRoom = pickBaseRoomBySeason(rule, season);
    const weekendMul = Number(rule.weekend_multiplier || 1);

    const rooms = Math.max(1, Math.ceil(pax / 2));
    const wkFactor = (nights >= 2) ? (isFinite(weekendMul) && weekendMul>0 ? weekendMul : 1) : 1;
    const hotel = nights * baseRoom * rooms * wkFactor;

    const total = transport + hotel;
    return { total, perPerson: total/pax };
  }
  function getSelectedPax(){
    const v = Number($("paxSel")?.value || 2);
    return (isFinite(v) && v > 0) ? v : 2;
  }
  function updatePriceBoxes(total, perPerson){
    const totalEl = $("priceTotal");
    const perEl   = $("pricePer");
    if(!isFinite(total)){
      totalEl.innerHTML = "â€” <small></small>";
      perEl.innerHTML = "â€” <small></small>";
      $("paxUsed").innerHTML = "â€” <small></small>";
      return;
    }
    totalEl.innerHTML = rupees(total) + ` <small>(${String($("visitType").value).toUpperCase()})</small>`;
    perEl.innerHTML = rupees(perPerson) + ` <small>per person</small>`;
  }

  function computePriceForCurrent(){
    try{
      if(!CURRENT_TEMPLATE_KEY) return;
      const tpl = TEMPLATES?.[CURRENT_TEMPLATE_KEY];
      if(!tpl) return;

      const pax = getSelectedPax();
      const days = Number(tpl.days || 3);
      let km = Number(CURRENT_ROUTE_KM || 0);
      if(!isFinite(km) || km <= 0){
        km = Number(tpl.total_km_est || tpl.estimated_drive_km || tpl.total_km || 0);
      }

      const est = estimateTotalCost({ km, days, pax, tpl });
      const total = est.total;
      const perPerson = isFinite(total) ? (total / pax) : NaN;

      $("paxUsed").innerHTML = `${pax} <small>selected</small>`;
      updatePriceBoxes(total, perPerson);
      updateWhatsAppForCurrent();
    }catch(e){
      console.error(e);
      $("paxUsed").innerHTML = "â€” <small></small>";
      updatePriceBoxes(NaN, NaN);
      setWhatsAppEnquiryEnabled(false);
    }
  }

  function clearRightPanel(){
    clearMap();
    $("activePkgName").textContent = "â€”";
    $("itTitle").textContent = "Select a package";
    $("itMeta").textContent = "Day-wise details will appear here";
    $("incExc").textContent = "â€”";
    $("daysList").innerHTML = "";
    $("placeDetail").innerHTML = `<div class="muted">Tap any place from itinerary to see history + photos here.</div>`;
    $("priceTotal").innerHTML = "â€” <small></small>";
    $("pricePer").innerHTML = "â€” <small></small>";
    $("paxUsed").innerHTML = "â€” <small></small>";
    CURRENT_TEMPLATE_KEY = "";
    CURRENT_ROUTE_KM = 0;
    setWhatsAppEnquiryEnabled(false);
    setActiveTab("itin");
  }

  function applyFilters(){
    const start = normalizeStartInput();
    const daysF = $("daysSel").value.trim();
    const pax   = getSelectedPax();
    const tier  = String($("visitType")?.value || "budget").toUpperCase();

    clearRightPanel();

    if(!start){
      toast("Start not found in templates");
      $("districtBar").innerHTML = "";
      $("pkgList").innerHTML = `<div class="pkgExplain"><b>Quick guide:</b> Type Start â†’ Generate â†’ Choose a package â†’ WhatsApp to book.</div><div class="pill"><b>Start not found</b></div>`;
      $("pkgCount").textContent = "0 Results";
      return;
    }

    const startUpper = String(start).trim().toUpperCase();

    // counts for visitor mode badges
    const allMatch = ACTIVE_TEMPLATES
      .filter(t => matchesStart(t, startUpper))
      .filter(t => matchesDaysOptional(t, daysF));

    const interCount = allMatch.filter(t => !isLocalComputed(t)).length;
    const localCount = allMatch.filter(t => isLocalComputed(t)).length;

    $("badgeAll").textContent = String(allMatch.length);
    $("badgeInter").textContent = String(interCount);
    $("badgeLocal").textContent = String(localCount);

    $("pills").innerHTML = "";
    const pillData = { START: startUpper, DAYS: (daysF ? daysF : "ANY"), TYPE: tier, PAX: pax };
    for(const [k,v] of Object.entries(pillData)){
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `${escapeHtml(k)} <b>${escapeHtml(String(v))}</b>`;
      $("pills").appendChild(div);
    }

    renderPackagesList();
    toast("Packages ready. Pick Inter-District or Within District.");
  }

  async function openTemplate(key, startUpper){
    const tpl = TEMPLATES[key];
    if(!tpl){ toast("Template not found"); return; }
    CURRENT_TEMPLATE_KEY = key;
    highlightActiveCard();

    const endKey = endKeyFromRoutePath(tpl);
    const routeIds = routeIdsFromTemplateIncludingStart(tpl);

    renderItinerary(tpl, startUpper, endKey);

    const rr = await drawRoadRouteFromPlaces(routeIds);
    CURRENT_ROUTE_KM = rr.ok ? rr.km : 0;

    computePriceForCurrent();
    updateWhatsAppForCurrent();
  }

  async function loadLive(){
    setStatus("Loading live from Firebaseâ€¦");

    const [tplSnap, placesSnap, tranSnap, hotelSnap, staySnap] = await Promise.all([
      db.ref(NODE_TEMPLATES).once("value"),
      db.ref(NODE_PLACES).once("value"),
      db.ref(NODE_TRANSPORT).once("value").catch(()=>({ val:()=>({}) })),
      db.ref(NODE_HOTEL).once("value").catch(()=>({ val:()=>({}) })),
      db.ref(NODE_STAYRULES).once("value").catch(()=>({ val:()=>({}) }))
    ]);

    TEMPLATES = tplSnap.val() || {};
    const rawPlaces = placesSnap.val() || {};

    PLACES = {};
    for(const [k,v] of Object.entries(rawPlaces)){
      if(v && typeof v === "object"){
        const pid = placeIdAny(v, k) || k;
        PLACES[pid] = { ...v, place_id: pid };
      }
    }

    pricing_transport = (tranSnap && typeof tranSnap.val==="function") ? (tranSnap.val() || {}) : {};
    rate_hotel = (hotelSnap && typeof hotelSnap.val==="function") ? (hotelSnap.val() || {}) : {};
    stay_rate_rules = (staySnap && typeof staySnap.val==="function") ? (staySnap.val() || {}) : {};
    PRICING_READY = true;

    ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
      .map(([key, obj]) => ({ key, ...(obj||{}) }))
      .filter(t => {
        const st = safeLower(t.status || "active");
        return st === "active" || st === "enabled" || st === "true";
      });

    buildNameIndex();
    buildStartList(ACTIVE_TEMPLATES);
  }

  async function refreshAll(){
    try{
      setStatus("Loading live from Firebaseâ€¦");

      await loadLive();
      await loadPlaceImagesFromGarg();

      saveCache();

      setStatus(`Loaded LIVE â€¢ ${ACTIVE_TEMPLATES.length} templates â€¢ ${Object.keys(PLACES).length} places`);
      toast("Refreshed from Firebase");
      invalidateMapSoon();

      // if filters already used, re-render
      if($("pills").children.length){
        applyFilters();
      }else{
        $("districtBar").innerHTML = "";
        $("pkgCount").textContent = "â€”";
        $("badgeAll").textContent = "â€”";
        $("badgeInter").textContent = "â€”";
        $("badgeLocal").textContent = "â€”";
      }
    }catch(err){
      console.error(err);
      setStatus("Firebase load error (check rules / node names)");
      toast("Firebase load error");
    }
  }

  async function mintLogin(){
    try{
      const u = auth.currentUser;
      if(u){
        await auth.signOut();
        $("mintLoginBtn").textContent = "Mint Login";
        toast("Logged out");
        return;
      }
      const email = prompt("Mint Login - Enter Email:");
      if(!email) return toast("Login cancelled");
      const pass = prompt("Enter Password:");
      if(!pass) return toast("Login cancelled");

      await auth.signInWithEmailAndPassword(email.trim(), pass);
      const user = auth.currentUser;
      $("mintLoginBtn").textContent = user ? "Logout" : "Mint Login";
      toast(user ? "Login successful" : "Logged in");
    }catch(e){
      console.error(e);
      toast(e?.message || "Login failed");
    }
  }

  /* âœ… Guide Bot */
  const bot = {
    fab: null, box:null, body:null, input:null, send:null, close:null
  };
  const botState = { step:0, start:"", days:"", mode:"" };

  function addBotMsg(text, who="bot", chips=[]){
    const d = document.createElement("div");
    d.className = `msg ${who}`;
    d.innerHTML = text;
    bot.body.appendChild(d);

    if(chips && chips.length){
      const row = document.createElement("div");
      row.className = "gbChips";
      chips.forEach(c=>{
        const b = document.createElement("button");
        b.className = "chipBtn";
        b.type = "button";
        b.textContent = c;
        b.onclick = ()=>handleBot(c, true);
        row.appendChild(b);
      });
      bot.body.appendChild(row);
    }
    bot.body.scrollTop = bot.body.scrollHeight;
  }

  function botStart(){
    botState.step = 1;
    botState.start = "";
    botState.days = "";
    botState.mode = "";
    bot.body.innerHTML = "";
    addBotMsg("Hi ðŸ‘‹ Iâ€™m your Himachal Guide Bot. I will help you book in 3 steps.");
    addBotMsg("Step 1: Choose your START city:", "bot", ["DELHI","CHANDIGARH","AMRITSAR","SHIMLA"]);
  }

  function handleBot(text, fromChip=false){
    const val = String(text || bot.input.value || "").trim();
    if(!val) return;
    if(!fromChip) addBotMsg(escapeHtml(val), "user");
    bot.input.value = "";

    if(/restart/i.test(val)){ botStart(); return; }

    if(botState.step === 1){
      botState.start = val.toUpperCase();
      $("startInp").value = botState.start;
      addBotMsg(`âœ… Start set: <b>${escapeHtml(botState.start)}</b>`);
      botState.step = 2;
      addBotMsg("Step 2: How many days?", "bot", ["3","4","5","6","7","8","10","12"]);
      return;
    }

    if(botState.step === 2){
      botState.days = val;
      $("daysSel").value = String(val).replace("+","");
      addBotMsg(`âœ… Days set: <b>${escapeHtml(botState.days)}</b>`);
      botState.step = 3;
      addBotMsg("Step 3: Choose Package Type", "bot", ["INTER-DISTRICT","WITHIN DISTRICT","ALL"]);
      return;
    }

    if(botState.step === 3){
      const up = val.toUpperCase();
      if(up.includes("INTER")) setMode("inter");
      else if(up.includes("WITHIN") || up.includes("LOCAL")) setMode("local");
      else setMode("all");

      addBotMsg("âœ… Done! I have filtered packages for you. Now tap any package card to open itinerary, then click WhatsApp to book.");
      applyFilters();
      return;
    }

    addBotMsg('Type "Restart" to begin again.', "bot", ["Restart"]);
  }

  function openBot(){
    bot.box.classList.remove("hidden");
    if(!bot.body.childElementCount) botStart();
  }

  /* âœ… Visitor mode toggle */
  function setMode(mode){
    VISITOR_MODE = mode;
    $("modeAll").classList.toggle("active", mode==="all");
    $("modeInter").classList.toggle("active", mode==="inter");
    $("modeLocal").classList.toggle("active", mode==="local");
    // refresh list if already generated
    if($("pills").children.length) renderPackagesList();
  }

  window.addEventListener("DOMContentLoaded", () => {
    $("yr").textContent = String(new Date().getFullYear());

    if(!firebase.apps.length){
      firebase.initializeApp(firebaseConfig);
    }else{
      try{ firebase.app(); }catch(_){ firebase.initializeApp(firebaseConfig); }
    }

    db = firebase.database();
    analytics = firebase.analytics();
    auth = firebase.auth();

    let imagesApp;
    try{ imagesApp = firebase.app("imagesApp"); }
    catch(e){ imagesApp = firebase.initializeApp(firebaseConfigImages, "imagesApp"); }
    imagesDb = firebase.database(imagesApp);

    auth.onAuthStateChanged((user)=>{
      $("mintLoginBtn").textContent = user ? "Logout" : "Mint Login";
      if(user) setStatus(`Logged in: ${user.email} â€¢ Loadingâ€¦`);
    });

    $("tabItinBtn").addEventListener("click", ()=>setActiveTab("itin"));
    $("tabLocBtn").addEventListener("click", ()=>setActiveTab("loc"));
    $("tabHomeBtn").addEventListener("click", ()=>{
      setActiveTab("itin");
      document.querySelector(".itWrap")?.scrollTo?.({ top: 0, behavior: "smooth" });
    });

    $("genBtn").addEventListener("click", applyFilters);
    $("startInp").addEventListener("keydown",(e)=>{ if(e.key==="Enter") applyFilters(); });

    $("resetBtn").addEventListener("click", ()=>{
      $("startInp").value="";
      $("visitType").value="budget";
      $("daysSel").value="";
      $("paxSel").value="2";
      $("pills").innerHTML="";
      $("districtBar").innerHTML = "";
      $("pkgCount").textContent="â€”";
      $("badgeAll").textContent = "â€”";
      $("badgeInter").textContent = "â€”";
      $("badgeLocal").textContent = "â€”";
      clearRightPanel();
      $("pkgList").innerHTML = `
        <div class="pkgExplain">
          <b>How to book:</b><br/>
          1) Select <b>Start</b> â†’ click <b>Generate</b><br/>
          2) Choose a package (Local / Inter-district)<br/>
          3) Click <b>WhatsApp</b> to finalize.
        </div>
        <div class="pill pillHint"><span>Type Start & click</span> <b>Generate</b></div>
      `;
      toast("Reset done");
      invalidateMapSoon();
    });

    $("fitMapBtn").addEventListener("click", ()=>{ fitRoute(); invalidateMapSoon(); });
    $("clearRouteBtn").addEventListener("click", ()=>{ clearMap(); toast("Cleared"); });
    $("refreshBtn").addEventListener("click", refreshAll);
    $("mintLoginBtn").addEventListener("click", mintLogin);

    $("showAllStopsBtn").addEventListener("click", async ()=>{
      showMode="all";
      toast("Markers: all stops");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const routeIds = routeIdsFromTemplateIncludingStart(tpl);
        const rr = await drawRoadRouteFromPlaces(routeIds);
        CURRENT_ROUTE_KM = rr.ok ? rr.km : CURRENT_ROUTE_KM;
        computePriceForCurrent();
      }
    });

    $("showStartEndBtn").addEventListener("click", async ()=>{
      showMode="startend";
      toast("Markers: start/end");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const routeIds = routeIdsFromTemplateIncludingStart(tpl);
        const rr = await drawRoadRouteFromPlaces(routeIds);
        CURRENT_ROUTE_KM = rr.ok ? rr.km : CURRENT_ROUTE_KM;
        computePriceForCurrent();
      }
    });

    $("toggleTilesBtn").addEventListener("click", ()=>{
      tilesDark = !tilesDark;
      try{
        map.removeLayer(tile);
        tile = tilesDark
          ? L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 })
          : L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
        tile.addTo(map);
      }catch(e){}
      toast(tilesDark ? "Dark tiles on" : "Light tiles on");
      invalidateMapSoon();
    });

    $("paxSel")?.addEventListener("change", ()=>{
      computePriceForCurrent();
      if($("pills").children.length) applyFilters();
    });

    $("visitType")?.addEventListener("change", ()=>{
      computePriceForCurrent();
      if($("pills").children.length) applyFilters();
    });

    $("daysSel")?.addEventListener("change", ()=>{
      if($("pills").children.length) applyFilters();
    });

    /* Mode toggle buttons */
    $("modeAll").addEventListener("click", ()=>setMode("all"));
    $("modeInter").addEventListener("click", ()=>setMode("inter"));
    $("modeLocal").addEventListener("click", ()=>setMode("local"));

    /* Bot */
    bot.fab = $("guideFab");
    bot.box = $("guideBot");
    bot.body = $("gbBody");
    bot.input = $("gbInput");
    bot.send = $("gbSend");
    bot.close = $("gbCloseBtn");

    bot.fab.addEventListener("click", ()=>{ openBot(); });
    $("openBotBtn").addEventListener("click", ()=>{ openBot(); });
    bot.close.addEventListener("click", ()=>bot.box.classList.add("hidden"));
    bot.send.addEventListener("click", ()=>handleBot());
    bot.input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") handleBot(); });

    initMap();

    const hadCache = loadCache();
    if(hadCache) toast("Loaded fast from cache");

    setWhatsAppEnquiryEnabled(false);
    refreshAll();
  });

  async function openTemplate(key, startUpper){
    const tpl = TEMPLATES[key];
    if(!tpl){ toast("Template not found"); return; }
    CURRENT_TEMPLATE_KEY = key;
    highlightActiveCard();

    const endKey = endKeyFromRoutePath(tpl);
    const routeIds = routeIdsFromTemplateIncludingStart(tpl);

    renderItinerary(tpl, startUpper, endKey);

    const rr = await drawRoadRouteFromPlaces(routeIds);
    CURRENT_ROUTE_KM = rr.ok ? rr.km : 0;

    computePriceForCurrent();
    updateWhatsAppForCurrent();
  }

  /* ========= existing WhatsApp + Pricing support from your original ========= */
  function pickStayRule(tier){
    const t = String(tier||"budget").toLowerCase();
    const key = (t==="premium") ? "r2" : (t==="luxury") ? "r3" : "r1";
    return stay_rate_rules?.[key] || {};
  }
  function pickVehicleByPax(pax){
    pax = Number(pax||2);
    if(pax <= 4) return "hatchback";
    if(pax <= 7) return "innova";
    return "luxury_suv";
  }
  function autoSeason(tpl){
    const text = String(tpl?.best_season || "").toLowerCase();
    if(/monsoon|rain|jul|aug/.test(text)) return "low";
    if(/winter|snow|snowfall|dec|jan/.test(text)) return "peak";
    if(/peak/.test(text)) return "peak";
    if(/low/.test(text)) return "low";
    if(/mid/.test(text)) return "mid";
    const m = new Date().getMonth() + 1;
    if([1,5,6,10,12].includes(m)) return "peak";
    if([2,7,8].includes(m)) return "low";
    return "mid";
  }
  function pickBaseRoomBySeason(rule, season){
    const s = String(season||"mid").toLowerCase();
    if(s === "low")  return Number(rule.base_rate_low || rule.base_rate_mid || rule.base_rate_peak || 0);
    if(s === "peak") return Number(rule.base_rate_peak || rule.base_rate_mid || rule.base_rate_low || 0);
    return Number(rule.base_rate_mid || rule.base_rate_low || rule.base_rate_peak || 0);
  }
  function computeSnowMultiplier(tpl, vehicle){
    const sr = String(tpl?.snow_risk || "").toLowerCase();
    const base = Number(vehicle?.snow_multiplier || 1);
    if(!isFinite(base) || base <= 0) return 1;
    if(sr.includes("high")) return base;
    if(sr.includes("medium")) return 1 + (base - 1) * 0.5;
    return 1;
  }
  function computeRoadMultiplier(tpl, vehicle){
    const rt = String(tpl?.road_type || "").toLowerCase();
    const dl = String(tpl?.drive_level || "").toLowerCase();
    const bad = Number(vehicle?.bad_road_multiplier || 1);
    const hill = Number(vehicle?.hill_multiplier || 1);
    let m = 1;
    if(rt.includes("bad") || rt.includes("mix")) m *= (isFinite(bad) && bad>0 ? bad : 1);
    if(dl.includes("high") || rt.includes("hill")) m *= (isFinite(hill) && hill>0 ? hill : 1);
    return m;
  }
  function estimateTotalCost({ km=0, days=3, pax=2, tpl=null }){
    km = Number(km||0);
    days = Number(days||0);
    pax = Math.max(1, Number(pax||1));
    const nights = Math.max(0, days-1);

    if(!PRICING_READY || !isFinite(km) || km<=0 || !days){
      return { total:NaN, perPerson:NaN, breakdown:null };
    }

    const tier   = String($("visitType")?.value || "budget").toLowerCase();
    const season = autoSeason(tpl);

    const vehicleKey = pickVehicleByPax(pax);
    const v = pricing_transport?.[vehicleKey] || {};

    const perKm = Number(v.per_km || 0);
    const driverPerDay = Number(v.driver_per_day || 0);
    const minKmPerDay = Number(v.min_km_per_day || 0);
    const nightCharge = Number(v.night_charge || 0);
    const tollPct = Number(v.parking_toll_buffer_pct || 0);

    const minBillKm = (isFinite(minKmPerDay) && minKmPerDay > 0) ? (days * minKmPerDay) : 0;
    const billedKm = Math.max(km, minBillKm);

    const roadMul = computeRoadMultiplier(tpl, v);
    const snowMul = computeSnowMultiplier(tpl, v);
    const bufferMul = 1 + (isFinite(tollPct) ? tollPct : 0) / 100;

    const transportKmCost = billedKm * perKm * roadMul * snowMul * bufferMul;
    const driverCost = days * driverPerDay;
    const nightCost = nights * nightCharge;

    const transport = transportKmCost + driverCost + nightCost;

    const rule = pickStayRule(tier);
    const baseRoom = pickBaseRoomBySeason(rule, season);
    const weekendMul = Number(rule.weekend_multiplier || 1);

    const rooms = Math.max(1, Math.ceil(pax / 2));
    const wkFactor = (nights >= 2) ? (isFinite(weekendMul) && weekendMul>0 ? weekendMul : 1) : 1;
    const hotel = nights * baseRoom * rooms * wkFactor;

    const total = transport + hotel;
    return { total, perPerson: total/pax };
  }
  </script>
</body>
</html>