<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer ‚Äî Ultra Pro</title>

  <!-- Leaflet (no API key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#05070d; --bg1:#070b15;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --r:18px; --r2:26px;
      --a:#67e8f9; --b:#a78bfa; --c:#34d399; --d:#ffcf5a;
      --max:1400px;            /* wider max */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow-x:hidden;

      /* full page bg */
      background-image:
        linear-gradient(180deg, rgba(5,7,13,.76), rgba(7,11,21,.88)),
        url("./Kee_monastery.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    }
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index:-1;
      background:
        radial-gradient(1200px 700px at 12% 10%, rgba(103,232,249,.18), transparent 55%),
        radial-gradient(1000px 700px at 82% 18%, rgba(167,139,250,.17), transparent 56%),
        radial-gradient(1000px 700px at 52% 92%, rgba(52,211,153,.12), transparent 55%);
      mix-blend-mode: screen;
    }

    a{color:inherit; text-decoration:none}

    /* ‚úÖ 90% screen width */
    .wrap{
      width:min(90vw, var(--max));
      margin:0 auto;
      padding:22px 16px 44px;
    }

    /* TOPBAR */
    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(5,7,13,.82), rgba(5,7,13,.40));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar .inner{
      width:min(90vw, var(--max));
      margin:0 auto;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:220px}
  .logo{
    width:46px; height:46px; border-radius:16px;
    background: #fff url("./logo.png") center/contain no-repeat;
    border:1px solid rgba(10,18,40,.12);
    box-shadow: 0 14px 30px rgba(15,23,42,.14);
    overflow:hidden;
  }

    .brand h1{font-size:14px; margin:0; letter-spacing:.2px; line-height:1.1}
    .brand small{display:block; color:var(--muted); font-weight:600; margin-top:2px}

    .nav{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      transition:.2s ease;
      font-weight:800; font-size:12px;
    }
    .pill:hover{transform: translateY(-1px); background:rgba(255,255,255,.08)}
    .pill .dot{
      width:8px; height:8px; border-radius:50%;
      background: linear-gradient(135deg, var(--a), var(--b));
      box-shadow: 0 0 0 4px rgba(103,232,249,.12);
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      color:var(--text);
      padding:11px 14px; border-radius:14px;
      background: linear-gradient(135deg, rgba(103,232,249,.18), rgba(167,139,250,.14));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      font-weight:900; font-size:12px;
      transition:.18s ease;
      display:inline-flex; align-items:center; gap:10px;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.ghost{background:rgba(255,255,255,.06); box-shadow:none}

    /* HERO */
    .hero{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
      align-items:stretch;
    }
    .heroMain{
      position:relative;
      overflow:hidden;
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      min-height: 380px;
      background-image:
        linear-gradient(120deg, rgba(0,0,0,.60), rgba(0,0,0,.10)),
        url("./Kee_monastery.jpg");
      background-position:center;
      background-size:cover;
      background-repeat:no-repeat;
    }
    .heroMain::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(700px 420px at 20% 35%, rgba(103,232,249,.14), transparent 62%),
        radial-gradient(700px 420px at 78% 30%, rgba(167,139,250,.16), transparent 62%);
      pointer-events:none;
      mix-blend-mode: screen;
    }
    .heroInner{
      position:relative;
      padding:22px;
      display:flex;
      flex-direction:column;
      height:100%;
      justify-content:space-between;
      gap:14px;
    }
    .heroTitle{margin:0; font-size: clamp(26px, 3vw, 44px); letter-spacing:-.4px; line-height:1.05}
    .heroSub{margin:10px 0 0 0; color:rgba(255,255,255,.82); max-width:64ch; font-weight:650}

    .finder{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 170px 170px 160px;
      gap:10px;
      align-items:end;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:11px; color:var(--muted); font-weight:900; letter-spacing:.25px}
    .input, .select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-weight:800;
    }
    .input::placeholder{color:rgba(255,255,255,.45)}
    .select{cursor:pointer}
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    /* Right panel */
    .panel{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--r2);
      box-shadow: 0 16px 60px rgba(0,0,0,.38);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .panelHead h3{margin:0; font-size:13px}
    .panelHead small{color:var(--muted); font-weight:800}

    .quickLinks{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .qcard{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      transition:.2s ease;
      cursor:pointer;
    }
    .qcard:hover{transform: translateY(-1px); background: rgba(255,255,255,.07)}
    .qcard b{display:block; font-size:12px}
    .qcard p{margin:6px 0 0; color:var(--muted); font-weight:750; font-size:12px; line-height:1.35}

    /* ‚úÖ Packages at start (instead of districts) */
    .packs{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .pack{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .pack h4{margin:0; font-size:12.5px}
    .pack small{display:block; color:var(--muted); font-weight:750; margin-top:6px; line-height:1.35}
    .pack .row{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    .badge{
      font-size:11px; font-weight:950;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }

    /* Sections */
    .section{margin-top:18px; display:grid; grid-template-columns: 1fr; gap:14px}
    .sectionTitle{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin:8px 0 0}
    .sectionTitle h2{margin:0; font-size:16px}
    .sectionTitle p{margin:0; color:var(--muted); font-weight:800; font-size:12px}

    /* EXPLORE (Map hidden until place click) */
    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      align-items:stretch;
    }

    .results{min-height:440px; display:flex; flex-direction:column}
    .list{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      overflow:auto;
      max-height: 580px;
    }
    .place{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap:12px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      transition:.18s ease;
    }
    .place:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .thumb{
      width:92px; height:72px;
      border-radius:16px;
      background: linear-gradient(135deg, rgba(103,232,249,.12), rgba(167,139,250,.10));
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .pTitle{margin:0; font-size:13px}
    .pSub{margin:6px 0 0; color:var(--muted); font-weight:750; font-size:12px; line-height:1.35}
    .pBadges{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}

    /* Map panel starts hidden */
    .mapPanel{display:none}
    .mapBox{min-height:440px}
    #map{
      width:100%; height:440px;
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    /* Drawer */
    .drawerWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:60;
    }
    .drawer{
      width:min(980px, 100%);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,12,20,.86);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
      overflow:hidden;
      max-height: 86vh;
      display:flex; flex-direction:column;
    }
    .drawerTop{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .drawerTop h3{margin:0; font-size:14px}
    .drawerBody{
      padding:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      overflow:auto;
    }
    .gallery{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    .gImg{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      aspect-ratio: 4/3;
    }
    .gImg img{width:100%; height:100%; object-fit:cover; display:block}
    .infoCard{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
    }
    .infoCard p{margin:0; color:var(--muted); font-weight:700; line-height:1.45; font-size:12px}
    .row2{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row2 .btn{flex:1}
    .closeX{
      width:42px; height:42px; border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      color:var(--text);
      font-weight:900;
    }

    /* AI Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:70;
    }
    .modal{
      width:min(820px, 100%);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,12,20,.90);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 120px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modalHead{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead h3{margin:0; font-size:14px}
    .chat{padding:14px; display:flex; flex-direction:column; gap:10px; max-height: 62vh; overflow:auto}
    .msg{
      max-width: 86%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:700;
      line-height:1.45;
      font-size:12.5px;
      white-space:pre-wrap;
    }
    .msg.me{margin-left:auto; background: linear-gradient(135deg, rgba(103,232,249,.14), rgba(167,139,250,.12))}
    .composer{padding:12px 14px 14px; display:flex; gap:10px; border-top:1px solid rgba(255,255,255,.10)}
    .composer input{
      flex:1;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-weight:800;
    }

    @media (max-width: 980px){
      .hero{grid-template-columns: 1fr}
      .finder{grid-template-columns: 1fr 1fr}
      .finder .field:nth-child(1){grid-column:1 / -1}
      .drawerBody{grid-template-columns: 1fr}
      .gallery{grid-template-columns: repeat(2, 1fr)}
      #map{height:380px}
    }
    @media (max-width: 520px){
      .heroMain{min-height: 340px}
      .list{max-height: 440px}
      .gallery{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Himachal Explorer</h1>
          <small>Find places ‚Ä¢ build routes ‚Ä¢ get packages</small>
        </div>
      </div>

      <div class="nav">
        <a class="pill" href="#explore"><span class="dot"></span>Explore</a>
        <button class="btn ghost" id="openAI">AI Planner</button>
        <button class="btn" id="openAdmin">Admin</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HERO -->
    <section class="hero" aria-label="hero">
      <div class="heroMain">
        <div class="heroInner">
          <div>
            <h2 class="heroTitle">Make your Himachal trip feel effortless.</h2>
            <p class="heroSub">
              Search places by <b>district</b>, <b>type</b> and <b>days</b>. Then click any place to open map + route.
            </p>

            <div class="finder" style="margin-top:16px">
              <div class="field">
                <label>Search (place / temple / lake / trek)</label>
                <input class="input" id="q" placeholder="Example: Triund, Manimahesh, Kufri, Chandratal..."/>
              </div>

              <div class="field">
                <label>District</label>
                <select class="select" id="district">
                  <option value="all">All</option>
                </select>
              </div>

              <div class="field">
                <label>Type</label>
                <select class="select" id="type">
                  <option value="all">All</option>
                  <option value="Destination">Destination</option>
                  <option value="Temple">Temple</option>
                  <option value="Lake">Lake</option>
                  <option value="Trek">Trek</option>
                  <option value="Hotel">Hotel</option>
                  <option value="Activity">Activity</option>
                </select>
              </div>

              <div class="field">
                <label>Trip Days</label>
                <select class="select" id="days">
                  <option value="0">Any</option>
                  <option value="1">1‚Äì2 days</option>
                  <option value="3">3‚Äì4 days</option>
                  <option value="5">5‚Äì7 days</option>
                  <option value="8">8‚Äì12 days</option>
                </select>
              </div>
            </div>

            <div class="heroActions">
              <button class="btn" id="apply">Explore Now</button>
              <button class="btn ghost" id="nearby">Show Nearby</button>
              <button class="btn ghost" id="reset">Reset</button>
            </div>
          </div>

          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
            <small style="color:rgba(255,255,255,.75); font-weight:800">
              Note: Map will appear only after you click a location.
            </small>
            <small id="status" style="color:rgba(255,255,255,.75); font-weight:900">Loading places‚Ä¶</small>
          </div>
        </div>
      </div>

      <!-- Right side: Packages at start -->
      <div class="panel">
        <div class="panelHead">
          <h3>Packages (Quick start)</h3>
          <small>3‚Äì4 options</small>
        </div>
        <div class="packs" id="packList">
          <div class="pack">
            <h4>Package A ‚Ä¢ Highlights (2D/1N)</h4>
            <small>Easy travel ‚Ä¢ 2‚Äì3 top spots ‚Ä¢ local food ‚Ä¢ sunset point</small>
            <div class="row">
              <span class="badge">Comfort</span><span class="badge">Family</span><span class="badge">Short trip</span>
            </div>
          </div>
          <div class="pack">
            <h4>Package B ‚Ä¢ Nature + Photos (3D/2N)</h4>
            <small>Scenic views ‚Ä¢ viewpoints ‚Ä¢ lake/valley ‚Ä¢ relaxed pace</small>
            <div class="row">
              <span class="badge">Nature</span><span class="badge">Photography</span><span class="badge">Balanced</span>
            </div>
          </div>
          <div class="pack">
            <h4>Package C ‚Ä¢ Temples + Culture (4D/3N)</h4>
            <small>Top temples ‚Ä¢ local markets ‚Ä¢ heritage spots ‚Ä¢ easy drives</small>
            <div class="row">
              <span class="badge">Culture</span><span class="badge">Temple</span><span class="badge">Easy</span>
            </div>
          </div>
          <div class="pack">
            <h4>Package D ‚Ä¢ Adventure Mix (5D/4N)</h4>
            <small>Trek/activity ‚Ä¢ waterfall/lake ‚Ä¢ sunrise point ‚Ä¢ more travel</small>
            <div class="row">
              <span class="badge">Adventure</span><span class="badge">Trek</span><span class="badge">Active</span>
            </div>
          </div>
        </div>

        <div class="panelHead" style="border-top:1px solid rgba(255,255,255,.10)">
          <h3>Quick Actions</h3>
          <small>one tap</small>
        </div>
        <div class="quickLinks">
          <div class="qcard" data-quick="Trek"><b>Top Treks</b><p>Triund, Prashar, Hampta‚Ä¶</p></div>
          <div class="qcard" data-quick="Lake"><b>Famous Lakes</b><p>Chandratal, Rewalsar‚Ä¶</p></div>
          <div class="qcard" data-quick="Temple"><b>Temples</b><p>Jwalamukhi, Bijli Mahadev‚Ä¶</p></div>
          <div class="qcard" data-quick="Destination"><b>Must Visit</b><p>Manali, Shimla, Spiti‚Ä¶</p></div>
        </div>
      </div>
    </section>

    <!-- EXPLORE (Districts not shown at start, map hidden until click) -->
    <section class="section" id="explore">
      <div class="sectionTitle">
        <div>
          <h2>Explore</h2>
          <p>List first. Map appears after you click a location.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <span class="pill"><span class="dot"></span><span id="activeFilters">No filters</span></span>
        </div>
      </div>

      <div class="grid2">
        <div class="panel results">
          <div class="panelHead">
            <h3>Places</h3>
            <small id="count">0</small>
          </div>
          <div class="list" id="list"></div>
        </div>

        <!-- hidden map panel -->
        <div class="panel mapPanel" id="mapPanel">
          <div class="panelHead">
            <h3>Map</h3>
            <small id="mapHint">Click a place to load map</small>
          </div>
          <div class="mapBox">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- PLACE DRAWER -->
  <div class="drawerWrap" id="drawerWrap" role="dialog" aria-modal="true" aria-label="Place details">
    <div class="drawer">
      <div class="drawerTop">
        <div>
          <h3 id="dTitle">Place</h3>
          <small id="dSub" style="color:var(--muted); font-weight:850">‚Äî</small>
        </div>
        <button class="closeX" id="closeDrawer">‚úï</button>
      </div>

      <div class="drawerBody">
        <div class="gallery" id="gallery"></div>

        <div class="infoCard">
          <p id="dDesc">‚Äî</p>
          <div class="row2" style="gap:8px">
            <span class="badge" id="dType">Type</span>
            <span class="badge" id="dDistrict">District</span>
            <span class="badge" id="dHow">How to reach</span>
          </div>
          <div class="row2">
            <button class="btn" id="routeBtn">Show Map + Route</button>
            <button class="btn ghost" id="pkgBtn">Packages</button>
            <button class="btn ghost" id="fullBtn">Open Full Page</button>
          </div>

          <div class="panel" style="margin-top:10px">
            <div class="panelHead">
              <h3>Suggested mini-plan</h3>
              <small>auto</small>
            </div>
            <div style="padding:12px">
              <p id="miniPlan" style="margin:0; color:var(--muted); font-weight:750; line-height:1.45; font-size:12px">‚Äî</p>
            </div>
          </div>

          <div class="panel" style="margin-top:10px">
            <div class="panelHead">
              <h3>Distance</h3>
              <small>nearby</small>
            </div>
            <div style="padding:12px">
              <p id="distInfo" style="margin:0; color:var(--muted); font-weight:750; line-height:1.45; font-size:12px">Turn on Nearby to see distance.</p>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- AI MODAL -->
  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true" aria-label="AI Trip Planner">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3>AI Trip Planner</h3>
          <small style="color:var(--muted); font-weight:850">Ask days, people, interests ‚Üí get suggestions</small>
        </div>
        <button class="closeX" id="closeAI">‚úï</button>
      </div>
      <div class="chat" id="chat"></div>
      <div class="composer">
        <input id="chatInput" placeholder="Example: 4 days, couple, nature + temples, starting Shimla"/>
        <button class="btn" id="sendChat">Send</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   FIREBASE
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
  authDomain: "revnue-records.firebaseapp.com",
  databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "revnue-records",
  storageBucket: "revnue-records.firebasestorage.app",
  messagingSenderId: "182348503564",
  appId: "1:182348503564:web:480085405b09177245ac29",
  measurementId: "G-MGTDBCG896"
};
const dbPath = "locations";

/* =========================
   HELPERS
   ========================= */
const $ = (id)=>document.getElementById(id);
let allPlaces = [];
let shownPlaces = [];
let map = null;
let markerLayer = null;
let currentPlace = null;
let myPos = null;
let mapReady = false;

function safeText(v){ return (v ?? "").toString().trim(); }
function escapeHtml(str){
  return safeText(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function normalizeType(t){
  t = safeText(t);
  if(!t) return "Destination";
  const low = t.toLowerCase();
  if(low.includes("temple") || low.includes("mandir")) return "Temple";
  if(low.includes("lake")) return "Lake";
  if(low.includes("trek") || low.includes("trail")) return "Trek";
  if(low.includes("hotel") || low.includes("stay")) return "Hotel";
  if(low.includes("activity") || low.includes("adventure")) return "Activity";
  if(low.includes("dest") || low.includes("place")) return "Destination";
  return t[0].toUpperCase() + t.slice(1);
}
function parseLatLngFromMapUrl(url){
  url = safeText(url);
  if(!url) return {lat:null,lng:null};
  const q = url.match(/q=([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(q) return {lat:Number(q[1])||null, lng:Number(q[2])||null};
  const at = url.match(/@([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(at) return {lat:Number(at[1])||null, lng:Number(at[2])||null};
  return {lat:null,lng:null};
}
function placeImages(p){
  if(Array.isArray(p.images) && p.images.length) return p.images.filter(Boolean);
  if(p.image) return [p.image];
  return [];
}
function typeBg(type){
  switch(type){
    case "Trek": return "rgba(103,232,249,.22)";
    case "Lake": return "rgba(52,211,153,.20)";
    case "Temple": return "rgba(255,207,90,.18)";
    case "Hotel": return "rgba(167,139,250,.18)";
    case "Activity": return "rgba(255,107,107,.16)";
    default: return "rgba(255,255,255,.10)";
  }
}
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = (d)=> d * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

/* =========================
   MAP (lazy init)
   ========================= */
function ensureMap(){
  if(mapReady) return;
  // show map panel
  $("mapPanel").style.display = "block";

  map = L.map('map', {zoomControl:true}).setView([31.9, 77.2], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);

  mapReady = true;

  // leaflet needs size invalidation when element becomes visible
  setTimeout(()=> map.invalidateSize(), 120);
}

function clearMarkers(){
  if(!mapReady) return;
  markerLayer.clearLayers();
}
function addMarkers(list){
  if(!mapReady) return;
  clearMarkers();

  list.forEach((p)=>{
    if(!p.lat || !p.lng) return;
    const m = L.marker([p.lat, p.lng]).addTo(markerLayer);
    m.bindPopup(`<b>${escapeHtml(p.name)}</b><br/><span style="opacity:.8">${escapeHtml(p.district)} ‚Ä¢ ${escapeHtml(p.type)}</span>`);
    m.on('click', ()=> openDrawer(p));
  });

  const pts = list.filter(p=>p.lat && p.lng).map(p=>[p.lat, p.lng]);
  if(pts.length >= 2) map.fitBounds(pts, {padding:[30,30]});
  else if(pts.length === 1) map.setView(pts[0], 11);
}

/* =========================
   LOAD DATA
   ========================= */
async function loadPlaces(){
  try{
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const snap = await db.ref(dbPath).once("value");
    const val = snap.val() || {};

    allPlaces = Object.entries(val).map(([id, o])=>{
      o = o || {};
      const name = safeText(o["Location Name"] || o.name || o.title || id);
      const district = safeText(o["District"] || o.district || "Unknown");
      const segment = safeText(o["Segment Type"] || o.segment || "Destination");
      const locationType = safeText(o["Location Type"] || o.type || "");
      const overview = safeText(o["Overview"] || o.overview || "");
      const short = safeText(o["Short Description"] || o.short || "");
      const keyFeatures = safeText(o["Key Features"] || o.features || "");
      const how = safeText(o["How to Reach"] || o.how || "");
      const mapUrl = safeText(o["Map"] || o.map || "");
      const {lat, lng} = parseLatLngFromMapUrl(mapUrl);

      const images = Array.isArray(o.images) ? o.images : (o.image ? [o.image] : []);
      const type = normalizeType(segment);
      const brief = overview || short || keyFeatures || "Explore this place in Himachal Pradesh.";

      return { id, name, district, type, segment, locationType, brief, how, mapUrl, lat, lng, images };
    }).filter(p=>p.name);

  }catch(e){
    console.error("Firebase load failed:", e);
    allPlaces = [];
  }
}

function buildDistrictDropdown(){
  const distSel = $("district");
  const districts = [...new Set(allPlaces.map(p=>p.district).filter(Boolean))].sort();
  distSel.innerHTML = `<option value="all">All</option>` + districts.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
}

function applyFilters(scrollToList=false){
  const q = safeText($("q").value).toLowerCase();
  const d = $("district").value;
  const t = $("type").value;
  const days = Number($("days").value||0);

  shownPlaces = allPlaces.filter(p=>{
    if(d !== "all" && p.district !== d) return false;
    if(t !== "all" && p.type !== t) return false;

    if(q){
      const hay = `${p.name} ${p.district} ${p.type} ${p.brief} ${p.how} ${p.locationType} ${p.segment}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }

    if(days){
      if(days <= 2 && p.type === "Trek") return false;
    }
    return true;
  });

  renderList(shownPlaces);

  // ‚úÖ DO NOT display map until click
  // so we do NOT call addMarkers here

  $("count").textContent = `${shownPlaces.length} shown`;
  updateActiveFilters();

  if(scrollToList) $("list").scrollTo({top:0, behavior:"smooth"});
}

function updateActiveFilters(){
  const parts = [];
  const d = $("district").value;
  const t = $("type").value;
  const q = safeText($("q").value);
  const days = Number($("days").value||0);

  if(d !== "all") parts.push(d);
  if(t !== "all") parts.push(t);
  if(days) parts.push(`${days}+ days`);
  if(q) parts.push(`‚Äú${q}‚Äù`);
  $("activeFilters").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "No filters";
}

function renderList(list){
  const box = $("list");
  if(!list.length){
    box.innerHTML = `<div style="padding:14px; color:rgba(255,255,255,.75); font-weight:850">
      No results. Try changing filters or search.
    </div>`;
    return;
  }

  box.innerHTML = list.map((p, idx)=>{
    const imgs = placeImages(p);
    const thumb = imgs[0] || "";
    const badgeBg = typeBg(p.type);
    const brief = safeText(p.brief) || "Explore this place in Himachal Pradesh.";
    const meta = `${safeText(p.district)} ‚Ä¢ ${safeText(p.type)}${p.locationType ? " ‚Ä¢ " + p.locationType : ""}`;
    const km = (myPos && p.lat && p.lng) ? haversine(myPos.lat, myPos.lng, p.lat, p.lng) : null;

    return `
      <div class="place" data-i="${idx}">
        <div class="thumb">
          ${thumb ? `<img src="${thumb}" alt="${escapeHtml(p.name)}" loading="lazy" onerror="this.remove()">` : ``}
        </div>
        <div>
          <p class="pTitle">${escapeHtml(p.name)}</p>
          <p class="pSub">${escapeHtml(meta)} ‚Äî ${escapeHtml(brief)}</p>
          <div class="pBadges">
            <span class="badge" style="background:${badgeBg}">${escapeHtml(p.type)}</span>
            <span class="badge">${escapeHtml(p.district)}</span>
            ${km ? `<span class="badge">üìç ${km.toFixed(1)} km from you</span>` : ``}
          </div>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll(".place").forEach(el=>{
    el.addEventListener("click", ()=>{
      const i = Number(el.getAttribute("data-i"));
      openDrawer(list[i]);
    });
  });
}

/* =========================
   DRAWER
   ========================= */
function buildMiniPlan(p){
  if(p.type === "Trek") return "Start early ‚Ä¢ carry water + warm layer ‚Ä¢ return before sunset ‚Ä¢ add viewpoint + caf√© stop.";
  if(p.type === "Lake") return "Sunrise/sunset best ‚Ä¢ buffer for roads ‚Ä¢ pair with temple/meadow ‚Ä¢ keep light snacks.";
  if(p.type === "Temple") return "Morning darshan + local market ‚Ä¢ add 1 nature spot nearby ‚Ä¢ relaxed pace.";
  if(p.type === "Hotel") return "Use as base ‚Ä¢ add 2 nearby spots + sunset point ‚Ä¢ evening walk + dinner.";
  return "1 main attraction + 2 nearby spots + food stop ‚Ä¢ keep time for photos.";
}

function openDrawer(p){
  currentPlace = p;
  $("dTitle").textContent = p.name;
  $("dSub").textContent = `${p.district} ‚Ä¢ ${p.type}${p.locationType ? " ‚Ä¢ " + p.locationType : ""}`;
  $("dDesc").textContent = safeText(p.brief) || "No description available yet.";
  $("dType").textContent = p.type;
  $("dDistrict").textContent = p.district;
  $("dHow").textContent = (safeText(p.how) ? `Reach: ${p.how}` : "Reach: ‚Äî");
  $("miniPlan").textContent = buildMiniPlan(p);

  // distance
  let distLine = "Turn on Nearby to see distance from you.";
  if(myPos && p.lat && p.lng){
    const km = haversine(myPos.lat, myPos.lng, p.lat, p.lng);
    distLine = `Approx distance from you: ${km.toFixed(1)} km.`;
  }
  $("distInfo").textContent = distLine;

  // Gallery max 6
  const imgs = placeImages(p).slice(0,6);
  const g = $("gallery");
  if(imgs.length){
    g.innerHTML = imgs.map(u=>`
      <div class="gImg"><img src="${u}" alt="${escapeHtml(p.name)}" loading="lazy" onerror="this.remove()"/></div>
    `).join("");
  }else{
    g.innerHTML = `
      <div class="gImg" style="display:flex; align-items:center; justify-content:center; padding:14px; color:rgba(255,255,255,.75); font-weight:850">
        No images yet (add images[] in Firebase)
      </div>`;
  }

  $("drawerWrap").style.display = "flex";
}

function closeDrawer(){
  $("drawerWrap").style.display = "none";
  currentPlace = null;
}
$("closeDrawer").onclick = closeDrawer;
$("drawerWrap").addEventListener("click", (e)=>{ if(e.target === $("drawerWrap")) closeDrawer(); });

/* ‚úÖ Show map ONLY after click (button) */
$("routeBtn").onclick = ()=>{
  if(!currentPlace) return;

  ensureMap();                       // init map now
  addMarkers([currentPlace]);        // show only selected
  if(currentPlace.lat && currentPlace.lng){
    map.setView([currentPlace.lat, currentPlace.lng], 12);
    $("mapHint").textContent = `${currentPlace.name} ‚Ä¢ ${currentPlace.district}`;
  }else{
    $("mapHint").textContent = "No lat/lng found for this place (add map link with q=lat,lng)";
  }

  closeDrawer();
  location.hash = "#explore";
};

$("pkgBtn").onclick = ()=>{
  if(!currentPlace) return;
  const base = currentPlace.name;
  const district = currentPlace.district;

  const pack = [
    `Package A: ${district} Highlights (2D/1N) ‚Äî ${base} + 2 nearby spots + local food.`,
    `Package B: Nature & Photos (3D/2N) ‚Äî ${base} + scenic points + relaxed pace.`,
    `Package C: Temples + Culture (4D/3N) ‚Äî ${base} + top temples + market + heritage.`,
    `Package D: Adventure Mix (5D/4N) ‚Äî ${base} + trek/activity + sunrise/sunset points.`
  ];
  alert(pack.join("\n\n"));
};

$("fullBtn").onclick = ()=>{
  if(!currentPlace) return;
  window.location.href = `place.html?id=${encodeURIComponent(currentPlace.id)}`;
};

/* =========================
   NEARBY
   ========================= */
$("nearby").onclick = ()=>{
  if(!navigator.geolocation){
    alert("GPS not supported.");
    return;
  }
  $("status").textContent = "Getting your location‚Ä¶";
  navigator.geolocation.getCurrentPosition((pos)=>{
    myPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    $("status").textContent = "Nearby ready. Distances shown in list.";
    // re-render list so distances appear
    renderList(shownPlaces);
  }, ()=>{
    $("status").textContent = "GPS permission denied.";
    alert("Allow location permission to use Nearby.");
  }, {enableHighAccuracy:true, timeout:12000});
};

/* =========================
   AI MODAL
   ========================= */
function openAI(){ $("modalWrap").style.display="flex"; seedChat(); }
function closeAI(){ $("modalWrap").style.display="none"; }
$("openAI").onclick = openAI;
$("closeAI").onclick = closeAI;
$("modalWrap").addEventListener("click",(e)=>{ if(e.target === $("modalWrap")) closeAI(); });

function pushMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = "msg " + (who==="me" ? "me" : "");
  div.textContent = text;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}
function seedChat(){
  $("chat").innerHTML = "";
  pushMsg("Tell me: days + people + interests (trek/lake/temple/snow/relax) + starting place/district.", "bot");
  pushMsg("Example: 4 days, couple, nature + temples, starting Shimla", "bot");
}
function aiSuggest(userText){
  const t = userText.toLowerCase();
  let days = 0;
  const m = t.match(/(\d+)\s*(day|days|d)/);
  if(m) days = Number(m[1]);

  const wants = {
    trek: /trek|hike|trail|adventure/.test(t),
    lake: /lake|chandratal|prashar|rewalsar|manimahesh/.test(t),
    temple: /temple|mandir|devi|mahadev|monastery/.test(t),
    relax: /relax|peace|family|easy/.test(t),
  };

  let districtHint = null;
  const districts = [...new Set(allPlaces.map(p=>p.district))];
  for(const d of districts){
    if(t.includes(d.toLowerCase())) { districtHint = d; break; }
  }

  const scored = allPlaces.map(p=>{
    let s=0;
    if(districtHint && p.district===districtHint) s += 3;
    if(wants.trek && p.type==="Trek") s += 3;
    if(wants.lake && p.type==="Lake") s += 3;
    if(wants.temple && p.type==="Temple") s += 3;
    if(wants.relax && p.type!=="Trek") s += 1;
    return {p, s};
  }).sort((a,b)=>b.s-a.s);

  const cap = days ? Math.max(3, Math.min(8, Math.ceil(days*1.3))) : 6;
  const pick = scored.filter(x=>x.s>0).slice(0, cap).map(x=>x.p);
  const fallback = allPlaces.slice(0,6);

  const list = (pick.length ? pick : fallback)
    .map((p,i)=>`${i+1}. ${p.name} (${p.district} ‚Ä¢ ${p.type})`)
    .join("\n");

  return `Based on your message, here are good picks:\n${list}\n\nTip: Use filters on home, then click a place to open map.`;
}
$("sendChat").onclick = ()=>{
  const v = safeText($("chatInput").value);
  if(!v) return;
  pushMsg(v, "me");
  $("chatInput").value = "";
  pushMsg(aiSuggest(v), "bot");
};
$("chatInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("sendChat").click(); });

/* =========================
   ACTIONS
   ========================= */
$("apply").onclick = ()=>{ applyFilters(true); location.hash="#explore"; };
$("reset").onclick = ()=>{
  $("q").value = ""; $("district").value="all"; $("type").value="all"; $("days").value="0";
  applyFilters(true);
};

document.querySelectorAll(".qcard").forEach(el=>{
  el.addEventListener("click", ()=>{
    $("type").value = el.getAttribute("data-quick");
    applyFilters(true);
    location.hash="#explore";
  });
});

$("openAdmin").onclick = ()=>{
  const go = confirm("Open admin page (admin.html)?");
  if(go) window.location.href = "admin.html";
};

/* =========================
   INIT
   ========================= */
(async function init(){
  await loadPlaces();
  buildDistrictDropdown();

  $("status").textContent = allPlaces.length
    ? `Loaded ${allPlaces.length} places from Firebase /${dbPath}`
    : "No data loaded. Check RTDB rules + path.";

  shownPlaces = allPlaces.slice();
  applyFilters(false);
})();
</script>
</body>
</html>
