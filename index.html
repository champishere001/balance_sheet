<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- ✅ SEO: Title + Description -->
  <title>Himachal Tour Packages | Himachal Explorer Portal (Routes, Maps, Day-wise Plans)</title>
  <meta name="description" content="Explore Himachal tour packages with live road route maps, day-wise itineraries, places, and package planner. Start from Delhi/Chandigarh/Amritsar or Himachal cities. Himachal Explorer Portal by Chandan Panwar." />
  <meta name="keywords" content="Himachal tour packages, Himachal itinerary, Himachal trip planner, Himachal explorer, Shimla Manali package, Spiti tour, Dharamshala Dalhousie, Kullu Kasol, road route map, Himachal travel" />
  <meta name="author" content="Himachal Explorer" />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1" />

  <!-- ✅ SEO: Canonical -->
  <link rel="canonical" href="https://himachalexplorer.in/" />

  <!-- ✅ Open Graph (Facebook/WhatsApp) -->
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="en_IN" />
  <meta property="og:title" content="Himachal Tour Packages | Himachal Explorer Portal" />
  <meta property="og:description" content="Live route map + packages + day-wise plans across Himachal. Find best routes, stops, and itineraries." />
  <meta property="og:url" content="https://himachalexplorer.in/" />
  <meta property="og:image" content="https://himachalexplorer.in/og-cover.jpg" />
  <meta property="og:site_name" content="Himachal Explorer" />

  <!-- ✅ Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Himachal Tour Packages | Himachal Explorer Portal" />
  <meta name="twitter:description" content="Live route map + packages + day-wise plans across Himachal." />
  <meta name="twitter:image" content="https://himachalexplorer.in/og-cover.jpg" />

  <!-- ✅ Theme / Icons -->
  <meta name="theme-color" content="#070A12" />
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  <!-- ✅ Performance: preconnect -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://router.project-osrm.org" crossorigin>

  <!-- ✅ FIXED: OSM tile hosts -->
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>

  <!-- ✅ Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "WebSite",
        "@id": "https://himachalexplorer.in/#website",
        "url": "https://himachalexplorer.in/",
        "name": "Himachal Explorer Portal",
        "description": "Himachal tour packages portal with live routes, itineraries, and places.",
        "inLanguage": "en-IN"
      },
      {
        "@type": "WebPage",
        "@id": "https://himachalexplorer.in/#webpage",
        "url": "https://himachalexplorer.in/",
        "name": "Himachal Tour Packages | Himachal Explorer Portal (Routes, Maps, Day-wise Plans)",
        "isPartOf": { "@id": "https://himachalexplorer.in/#website" },
        "about": { "@id": "https://himachalexplorer.in/#travelagency" },
        "inLanguage": "en-IN"
      },
      {
        "@type": "TravelAgency",
        "@id": "https://himachalexplorer.in/#travelagency",
        "name": "Himachal Explorer",
        "url": "https://himachalexplorer.in/",
        "telephone": "+91-7018138847",
        "email": "chandanpanwar001@gmail.com",
        "founder": "Chandan Panwar",
        "areaServed": "IN-HP",
        "priceRange": "₹₹",
        "image": "https://himachalexplorer.in/og-cover.jpg",
        "logo": "https://himachalexplorer.in/logo.png",
        "sameAs": [],
        "address": {
          "@type": "PostalAddress",
          "addressCountry": "IN",
          "addressRegion": "Himachal Pradesh"
        }
      },
      {
        "@type": "FAQPage",
        "@id": "https://himachalexplorer.in/#faq",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "How do I find tour packages on Himachal Explorer?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Type your start city (e.g. Delhi/Chandigarh/Amritsar) and press Generate. Choose a package to see day-wise itinerary and live road route map."
            }
          },
          {
            "@type": "Question",
            "name": "Do packages show real road distance?",
            "acceptedAnswer": {
              "@type": "Answer",
              "text": "Yes. The portal draws routes using OSRM road routing (not aerial distance) and displays total road kilometers."
            }
          }
        ]
      }
    ]
  }
  </script>

  <!-- ✅ Optional: Sitemap -->
  <link rel="sitemap" type="application/xml" title="Sitemap" href="https://himachalexplorer.in/sitemap.xml" />

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --pkgBg: url("kinnaur-kailash.webp");
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.65);
      --text:rgba(255,255,255,.92);
      --shadow: 0 24px 90px rgba(0,0,0,.55);
      --radius: 18px;

      --acc:#7C3AED;
      --acc2:#22C55E;
      --acc3:#06B6D4;
      --warn:#F59E0B;

      --topH: 92px;
      --gap: 14px;

      --leftPct: 36%;
      --mapPct: 24%;
      --rightPct: 40%;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 520px at 50% 90%, rgba(6,182,212,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    .aurora{
      position:fixed; inset:-30%;
      background:
        radial-gradient(900px 500px at 25% 30%, rgba(124,58,237,.22), transparent 65%),
        radial-gradient(900px 520px at 75% 25%, rgba(34,197,94,.18), transparent 66%),
        radial-gradient(860px 540px at 55% 75%, rgba(6,182,212,.14), transparent 66%);
      filter: blur(45px);
      opacity:.9;
      animation: drift 14s ease-in-out infinite;
      pointer-events:none;
      z-index:-3;
    }
    @keyframes drift{
      0%,100%{ transform: translate3d(0,0,0) scale(1); }
      50%{ transform: translate3d(3%, -2%, 0) scale(1.06); }
    }
    .noise{
      position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.12; mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }

    .app{ height:100%; display:grid; grid-template-rows: var(--topH) 1fr; }

    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(14px);
      gap: 12px;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .logo{
      width:54px; height:54px; border-radius:16px;
      background: rgba(255,255,255,.10);
      border:1px solid var(--stroke);
      display:grid; place-items:center;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brand p{ margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.25; }

    .quote{ flex:1; display:flex; justify-content:center; align-items:center; padding: 0 6px; min-width: 0; }
    .quoteBox{
      width:min(760px, 100%);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 10px 14px;
      display:flex; align-items:center; gap:10px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .spark{
      width:30px; height:30px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(124,58,237,.55));
      box-shadow: 0 0 0 6px rgba(124,58,237,.14);
      flex:0 0 auto;
    }
    .quoteText{
      font-size: 12.5px;
      color: rgba(255,255,255,.86);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .quoteText b{ color:#fff; }

    .actions{
      display:flex; gap:10px; align-items:center;
      min-width: 260px;
      justify-content:flex-end;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing:.08em;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(12px);
      white-space: nowrap;
    }
    .chip:hover{ background: rgba(255,255,255,.08); color: rgba(255,255,255,.82); }

    .main{
      height:100%;
      display:grid;
      grid-template-columns: var(--leftPct) var(--mapPct) var(--rightPct);
      gap: var(--gap);
      padding: 14px;
      overflow:hidden;
      padding-bottom:14px;
    }

    .pane{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .paneHdr{
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .paneHdr .t{
      font-size:12px;
      letter-spacing:.18em;
      text-transform: uppercase;
      margin:0;
    }
    .paneHdr .s{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform: uppercase;
    }

    .filters{
      padding: 12px;
      border-bottom:1px solid var(--stroke);
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .field label{
      display:block;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.12em;
      margin:0 0 6px 2px;
    }

    select{ text-transform: uppercase; }
    input{ text-transform: none; }

    input, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 3px rgba(124,58,237,.16);
    }
    .btnRow{ display:flex; gap:10px; }
    .btn{
      flex:1;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.65));
      color:#fff;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform: uppercase;
      cursor:pointer;
    }
    .btn.secondary{ background: rgba(255,255,255,.06); color: rgba(255,255,255,.85); }
    .btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }

    .metaPills{ padding: 0 12px 12px; display:flex; flex-wrap:wrap; gap:8px; }
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      display:inline-flex; align-items:center; gap:8px;
    }
    .pill b{ color:#fff; letter-spacing:.06em; }

    .pkgList{
      padding: 12px;
      overflow:auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .pkg{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 10px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex; gap:10px;
      min-width:0;
    }
    .pkg:hover{ transform: translateY(-1px); border-color: rgba(124,58,237,.35); background: rgba(0,0,0,.28); }
    .pkg.active{ border-color: rgba(124,58,237,.70); box-shadow: 0 0 0 3px rgba(124,58,237,.18); }

    .pkgPic{
      width:58px; height:58px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), rgba(124,58,237,.18));
      overflow:hidden;
      flex:0 0 auto;
      display:grid; place-items:center;
      font-weight: 950;
      color: rgba(255,255,255,.85);
    }
    .pkgPic img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pkgBody{ min-width:0; flex:1; }
    .pkgName{
      font-size: 12.5px;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }
    .pkgMeta{
      font-size: 11px;
      color: rgba(255,255,255,.72);
      letter-spacing:.08em;
      text-transform: uppercase;
      line-height: 1.35;
    }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      margin-top: 8px;
      width:fit-content;
    }
    .tag.ok{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); color: rgba(34,197,94,.98); }
    .tag.warn{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); color: rgba(245,158,11,.98); }

    #map{ width:100%; height:100%; background: rgba(255,255,255,.04); }
    .mapTools{
      padding: 10px 12px;
      border-top:1px solid var(--stroke);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .toolBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.88);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none;
      white-space: nowrap;
      text-decoration:none;
    }
    .toolBtn:hover{ background: rgba(255,255,255,.08); }

    .itWrap{
      padding: 12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .bigTitle{
      margin:0;
      font-size: 13px;
      letter-spacing:.18em;
      text-transform: uppercase;
      color:#fff;
    }
    .muted{ color: var(--muted); font-size: 11.5px; letter-spacing:.08em; text-transform: uppercase; line-height:1.35; }

    .heroCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .mini{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 10px;
    }
    .mini .k{ font-size: 10.5px; letter-spacing:.16em; text-transform: uppercase; color: rgba(255,255,255,.70); }
    .mini .v{ margin-top:6px; font-size: 14px; font-weight: 950; letter-spacing:.06em; color:#fff; }
    .mini .v small{ font-size: 11px; color: rgba(255,255,255,.72); font-weight: 800; }

    .contactCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius:16px;
      padding:12px;
    }
    .contactTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .contactLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .contactAvatar{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      display:grid; place-items:center;
      font-weight:950;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#fff;
      flex:0 0 auto;
    }
    .contactAvatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .contactName{
      font-size:12.5px;
      font-weight:950;
      letter-spacing:.12em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .contactMeta{
      margin-top:6px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:rgba(255,255,255,.70);
      line-height:1.35;
    }
    .contactActions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .motoLine{
      margin-top:10px;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:10px;
      font-size:11px;
      letter-spacing:.10em;
      opacity:.88;
      line-height:1.45;
      text-transform:none;
    }

    .daysList{ display:flex; flex-direction:column; gap:10px; }
    .dayCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px;
    }
    .dayTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .dayTop .d{
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.18em;
      text-transform: uppercase;
    }

    .placeLine{
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      margin-top: 8px;
      cursor:pointer;
    }
    .placeLine:hover{ background: rgba(255,255,255,.08); }

    .thumb{
      width:40px; height:40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), rgba(6,182,212,.18));
      flex:0 0 auto;
      display:grid; place-items:center;
      font-weight:950;
      color: rgba(255,255,255,.9);
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pinfo{ min-width:0; flex:1; }
    .pname{
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .pmeta{
      margin-top:3px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.68);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .toast{
      position:fixed;
      left: 14px;
      bottom: 14px;
      z-index: 9999;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,24,.88);
      border-radius: 16px;
      padding: 10px 12px;
      color: rgba(255,255,255,.82);
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      display:none;
      max-width: 560px;
    }
    .toast.show{ display:block; }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .app{ height:auto; min-height:100%; }
      .main{
        grid-template-columns: 1fr;
        grid-template-rows: auto 420px auto;
        overflow:visible;
      }
      .pane{ height:auto; }
      #map{ height: 420px; }
      .quote{ display:none; }
      .actions{ min-width:unset; }
    }

    .pane.pkgPane{
      position: relative;
      background:
        linear-gradient(180deg, rgba(10,14,24,.76), rgba(10,14,24,.88)),
        var(--pkgBg) center/cover no-repeat;
    }
    .pane.pkgPane::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 30% 20%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(900px 520px at 80% 30%, rgba(34,197,94,.16), transparent 62%),
        linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.55));
      pointer-events:none;
    }
    .pane.pkgPane > *{ position: relative; z-index: 2; }
    .pane.pkgPane .filters,
    .pane.pkgPane .metaPills,
    .pane.pkgPane .pkgList{
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }
    .pane.pkgPane .paneHdr{
      background: rgba(0,0,0,.20);
      backdrop-filter: blur(12px);
    }

    #placeModalBack{
      display:none; position:fixed; inset:0;
      background:rgba(0,0,0,.60);
      backdrop-filter:blur(10px);
      z-index:99999;
    }
    #placeModal{
      display:none; position:fixed; left:50%; top:8%;
      transform:translateX(-50%);
      width:min(860px, calc(100% - 24px));
      max-height:84vh; overflow:auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,14,24,.92);
      box-shadow:0 40px 120px rgba(0,0,0,.75);
      z-index:100000;
    }

    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }
  </style>
</head>

<body>
  <h1 class="sr-only">Himachal Tour Packages - Himachal Explorer Portal</h1>

  <noscript>
    <div style="padding:14px; margin:14px; border:1px solid rgba(255,255,255,.2); border-radius:14px; background:rgba(0,0,0,.35); color:#fff;">
      This portal needs JavaScript to load packages, maps, and itinerary details.
    </div>
  </noscript>

  <div class="aurora"></div>
  <div class="noise"></div>

  <div class="app">
    <div class="top">
      <div class="brand">
        <div class="logo">
          <img src="logo.png" alt="Himachal Explorer Logo" onerror="this.remove(); this.parentNode.textContent='HP';">
        </div>
        <div>
          <div style="margin:0;font-size:14px;letter-spacing:.18em;text-transform:uppercase;font-weight:900;">Himachal Explorer Portal</div>
          <p id="statusLine">Loading templates & places…</p>
        </div>
      </div>

      <div class="quote">
        <div class="quoteBox">
          <div class="spark"></div>
          <div class="quoteText" id="quoteText">“The mountains are calling…”</div>
        </div>
      </div>

      <div class="actions">
        <div class="chip" id="fitMapBtn">Fit Route</div>
        <div class="chip" id="clearRouteBtn">Clear</div>
      </div>
    </div>

    <div class="main">
      <div class="pane pkgPane">
        <div class="paneHdr">
          <div>
            <p class="t">Package Finder</p>
            <div class="s">End derived from route_path (Column G)</div>
          </div>
          <div class="s" id="pkgCount">—</div>
        </div>

        <div class="filters">
          <div class="field">
            <label>Start (Templates)</label>
            <input id="startInp" list="startList" placeholder="E.g. AMRITSAR / DELHI / CHANDIGARH" autocomplete="off">
            <datalist id="startList"></datalist>
          </div>

          <!-- ✅ NEW: Visit Type (Budget / Premium / Luxury) -->
          <div class="field">
            <label>Visit Type</label>
            <select id="visitType">
              <option value="budget">BUDGET</option>
              <option value="premium">PREMIUM</option>
              <option value="luxury">LUXURY</option>
            </select>
          </div>

          <div class="field">
            <label>Days (Optional)</label>
            <select id="daysSel">
              <option value="">ANY</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option>
            </select>
          </div>

          <div class="field">
            <label>Pax</label>
            <select id="paxSel">
              <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
              <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
            </select>
          </div>

          <div class="btnRow">
            <button class="btn secondary" id="resetBtn" type="button">Reset</button>
            <button class="btn" id="genBtn" type="button">Generate</button>
          </div>
        </div>

        <div class="metaPills" id="pills"></div>

        <div class="pkgList" id="pkgList">
          <div class="pill"><span>Type Start & click</span> <b>Generate</b></div>
        </div>
      </div>

      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Live Route Map</p>
            <div class="s">OSRM road polyline + markers</div>
          </div>
          <div class="s" id="kmBadge">—</div>
        </div>

        <div id="map"></div>

        <div class="mapTools">
          <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
          <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
          <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
        </div>
      </div>

      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Itinerary</p>
            <div class="s">Tap a place → popup details</div>
          </div>
          <div class="s" id="activePkgName">—</div>
        </div>

        <div class="itWrap">
          <div class="contactCard">
            <div class="contactTop">
              <div class="contactLeft">
                <div class="contactAvatar">
                  <img src="logo.png" alt="Himachal Explorer Logo" onerror="this.remove(); this.parentNode.textContent='CP';">
                </div>
                <div style="min-width:0;">
                  <div class="contactName">Chandan Panwar</div>
                  <div class="contactMeta">
                    <a class="toolBtn" style="padding:6px 10px; border-radius:12px;" href="tel:+917018138847">Call: +91 7018138847</a>
                    <a class="toolBtn" style="padding:6px 10px; border-radius:12px;" href="mailto:chandanpanwar001@gmail.com">Email</a>
                  </div>
                </div>
              </div>

              <div class="contactActions">
                <a class="toolBtn" href="https://wa.me/917018138847" target="_blank" rel="noopener">WhatsApp</a>
                <button class="toolBtn" type="button" id="copyContactBtn">Copy Details</button>
              </div>
            </div>

            <div class="motoLine">
              “Creating Memorable Journeys for Visitors — Revenue Comes After Trust.”
            </div>
          </div>

          <div class="heroCard">
            <h3 class="bigTitle" id="itTitle">Select a package</h3>
            <div class="muted" id="itMeta">Day-wise details will appear here</div>
            <div class="muted" id="itSanityNote" style="margin-top:8px; display:none;"></div>
          </div>

          <div class="row2">
            <div class="mini">
              <div class="k">Our Price (est.)</div>
              <div class="v" id="priceTotal">— <small></small></div>
            </div>
            <div class="mini">
              <div class="k">Per Person</div>
              <div class="v" id="pricePer">— <small></small></div>
            </div>
          </div>

          <div class="heroCard">
            <div class="muted" style="margin-bottom:8px;">Package includes / excludes</div>
            <div class="muted" id="incExc">—</div>
          </div>

          <div class="daysList" id="daysList"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div id="placeModalBack"></div>
  <div id="placeModal">
    <div style="padding:14px 14px 10px; border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
      <div style="min-width:0;">
        <div id="mTitle" style="font-weight:950; letter-spacing:.12em; text-transform:uppercase; font-size:14px; color:#fff;">
          PLACE
        </div>
        <div id="mMeta" style="margin-top:6px; color:rgba(255,255,255,.72); font-size:11px; letter-spacing:.10em; text-transform:uppercase;">
          —
        </div>
      </div>
      <button id="mClose" type="button" style="border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
        color:rgba(255,255,255,.85); border-radius:14px; padding:10px 12px; cursor:pointer;
        font-weight:900; letter-spacing:.10em; text-transform:uppercase;">Close</button>
    </div>

    <div style="padding:14px; display:grid; grid-template-columns: 220px 1fr; gap:14px; align-items:start;">
      <div style="border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25);
        border-radius:16px; overflow:hidden;">
        <div id="mPhoto" style="height:220px; display:grid; place-items:center; color:rgba(255,255,255,.75);
          font-weight:950; letter-spacing:.12em; text-transform:uppercase;">
          No Photo
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:12px;">
        <div style="border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05);
          border-radius:16px; padding:12px;">
          <div style="color:rgba(255,255,255,.70); font-size:11px; letter-spacing:.12em; text-transform:uppercase;">History / Tagline</div>
          <div id="mHistory" style="margin-top:8px; color:rgba(255,255,255,.92); line-height:1.45;">—</div>
        </div>

        <div style="border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05);
          border-radius:16px; padding:12px;">
          <div style="color:rgba(255,255,255,.70); font-size:11px; letter-spacing:.12em; text-transform:uppercase;">What you find</div>
          <div id="mFind" style="margin-top:8px; color:rgba(255,255,255,.92); line-height:1.45;">—</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="mFocus" type="button" style="border:1px solid rgba(255,255,255,.14); background:linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.65));
            color:#fff; border-radius:14px; padding:10px 12px; cursor:pointer; font-weight:900; letter-spacing:.10em; text-transform:uppercase;">
            Focus on Map
          </button>
          <button id="mCopy" type="button" style="border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
            color:rgba(255,255,255,.85); border-radius:14px; padding:10px 12px; cursor:pointer; font-weight:900; letter-spacing:.10em; text-transform:uppercase;">
            Copy Place ID
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /* ===============================
     ✅ Firebase Config
     =============================== */
  const firebaseConfig = {
    apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
    authDomain: "revnue-records.firebaseapp.com",
    databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "revnue-records",
    storageBucket: "revnue-records.firebasestorage.app",
    messagingSenderId: "182348503564",
    appId: "1:182348503564:web:480085405b09177245ac29",
    measurementId: "G-MGTDBCG896"
  };

  /* ===============================
     ✅ Helpers
     =============================== */
  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = String(msg||"");
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }
  function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function normCaps(x){ return String(x||"").trim().toUpperCase().replace(/\s+/g," "); }
  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).slice(0,2);
    const ini = parts.map(x=>x[0]).join("").toUpperCase();
    return ini || "HP";
  }
  function rupees(n){ return "₹" + Math.round(Number(n)||0).toLocaleString("en-IN"); }
  function slugifyName(name){
    return String(name||"")
      .trim().toLowerCase()
      .replace(/&/g," and ")
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }
  function cssEscapeSafe(sel){
    if(window.CSS && typeof CSS.escape === "function") return CSS.escape(sel);
    return String(sel).replace(/["\\]/g,"\\$&");
  }
  function setStatus(msg){ $("statusLine").textContent = msg; }

  /* ===============================
     ✅ Quotes
     =============================== */
  const QUOTES = [
    "Himachal is not a destination — it’s a <b>feeling</b>.",
    "Every turn in the mountains is a new <b>story</b>.",
    "Let your route be scenic, your pace be <b>human</b>.",
    "Collect moments, not things — especially in the <b>hills</b>.",
    "Snow, cedar, rivers — welcome to <b>Himachal</b>."
  ];
  let qIndex=0;

  /* ===============================
     ✅ Map
     =============================== */
  let map, tile, markersLayer, routeLine;
  let showMode = "all";
  let tilesDark = false;

  function initMap(){
    map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
    tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    tile.addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }
  function clearMap(){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    $("kmBadge").textContent = "—";
  }
  function fitRoute(){
    if(routeLine) map.fitBounds(routeLine.getBounds(), { padding:[22,22] });
  }

  /* ===============================
     ✅ Data
     =============================== */
  let db, storage, analytics;
  let LOCS = {};
  let TEMPLATES = {};
  let ACTIVE_TEMPLATES = [];
  let NAME_TO_ID = new Map();
  let STARTS = [];
  let CURRENT_LIST = [];
  let CURRENT_TEMPLATE_KEY = "";
  let CURRENT_ROUTE_KM = 0;

  function placeNameAny(p, id){
    return String(p?.["Location Name"] || p?.name || id || "PLACE").toUpperCase();
  }
  function pickPhotoAny(p){
    const p1 = p?.["photo 1"] || p?.photo1 || p?.photo_1 || p?.photo || "";
    if(p1 && String(p1).trim()) return String(p1).trim();
    if(Array.isArray(p?.photos) && p.photos[0]) return String(p.photos[0]).trim();
    if(Array.isArray(p?.images) && p.images[0]) return String(p.images[0]).trim();
    const p2 = p?.["photo 2"] || p?.photo2 || "";
    if(p2 && String(p2).trim()) return String(p2).trim();
    return "";
  }
  function latAny(p){ return Number(p?.Latitude ?? p?.latitude ?? p?.lat); }
  function lngAny(p){ return Number(p?.Longitude ?? p?.longitude ?? p?.lng); }
  function districtAny(p){ return String(p?.District || p?.district || "").toUpperCase(); }
  function segmentAny(p){ return String(p?.["Segment Type"] || p?.segment || "").toUpperCase(); }
  function categoryAny(p){ return String(p?.["Location Type"] || p?.category || "").toUpperCase(); }
  function regionAny(p){ return String(p?.region || "").toUpperCase(); }

  function isStartWithinHimachal(startStr){
    const s = String(startStr||"").trim().toUpperCase();
    if(!s) return false;

    const HP_STARTS = new Set([
      "SHIMLA","MANALI","KULLU","DHARAMSHALA","DALHOUSIE","CHAMBA",
      "KASOL","PALAMPUR","KANGRA","HAMIRPUR","UNA","MANDI","BILASPUR",
      "SOLAN","CHAIL","KUFRI","KINNAUR","KALPA","RECKONG PEO","SANGLA",
      "CHITKUL","SPITI","KAZA","KEYLONG","LAHAUL","NARKANDA","TIRTHAN","JIBHI"
    ]);

    if(HP_STARTS.has(s)) return true;

    const pid = NAME_TO_ID.get(s.toLowerCase());
    if(pid && LOCS[pid]){
      const d = districtAny(LOCS[pid]);
      const HP_DIST = new Set([
        "SHIMLA","KULLU","KANGRA","CHAMBA","MANDI","SOLAN","BILASPUR","HAMIRPUR",
        "UNA","KINNAUR","LAHAUL AND SPITI","LAHAUL & SPITI","SIRMAUR"
      ]);
      return HP_DIST.has(d);
    }
    return false;
  }

  async function loadAll(){
    setStatus("Loading /templates & /places…");

    const [tplSnap, placesSnap, locSnap] = await Promise.all([
      db.ref("templates").once("value"),
      db.ref("places").once("value"),
      db.ref("locations").once("value").catch(()=>({ val:()=>null }))
    ]);

    TEMPLATES = tplSnap.val() || {};
    const places = placesSnap.val() || {};
    const locations = (locSnap && typeof locSnap.val==="function") ? (locSnap.val() || {}) : {};

    LOCS = {};
    function ingestPlace(id, obj){
      if(!id || !obj) return;
      LOCS[id] = { ...obj, place_id: obj.place_id || id };
    }

    for(const [k,v] of Object.entries(places)){
      if(v && typeof v === "object" && (v.name || v.place_id || v.latitude || v.longitude || v.Latitude || v.Longitude)){
        ingestPlace(k, v);
      }else if(v && typeof v === "object"){
        for(const [k2,v2] of Object.entries(v)){
          if(v2 && typeof v2 === "object") ingestPlace(k2, v2);
        }
      }
    }

    if(Object.keys(LOCS).length === 0){
      for(const [k,v] of Object.entries(locations)){
        ingestPlace(k, v);
      }
    }

    ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
      .map(([key, obj]) => ({ key, ...(obj||{}) }))
      .filter(t => {
        const st = safeLower(t.status || "active");
        return st === "active" || st === "enabled" || st === "true";
      });

    buildNameIndex();
    buildStartList(ACTIVE_TEMPLATES);

    setStatus(`Loaded ${ACTIVE_TEMPLATES.length} templates • ${Object.keys(LOCS).length} places`);
  }

  function buildNameIndex(){
    NAME_TO_ID = new Map();
    for(const [pid, p] of Object.entries(LOCS)){
      const nm = String(p["Location Name"] || p.name || "").trim();
      if(nm) NAME_TO_ID.set(nm.toLowerCase(), pid);
    }
  }
  function buildStartList(templates){
    const set = new Set();
    templates.forEach(t=>{
      const s = String(t.start_point || "").trim();
      if(s) set.add(s);
    });
    STARTS = Array.from(set).sort((a,b)=>a.localeCompare(b));
    const dl = $("startList");
    dl.innerHTML = "";
    STARTS.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = String(s).toUpperCase();
      dl.appendChild(opt);
    });
  }

  function stopsFromTemplate(tpl){
    const days = Number(tpl.days || 1);
    const out = [];
    const seen = new Set();

    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      if(!raw) continue;
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
        if(seen.has(pid)) return;
        seen.add(pid);
        out.push(pid);
      });
    }

    if(!out.length){
      const raw = String(tpl.major_place_ids || "").trim();
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>out.push(pid));
    }
    return out;
  }
  function stopsCount(tpl){ return stopsFromTemplate(tpl).length; }

  function getEndNameFromColumnG(tpl){
    const start = String(tpl.start_point || "").trim().toLowerCase();
    const rpRaw = String(tpl.route_path || "").trim();
    if(!rpRaw) return String(tpl.end_point || "").trim() || "UNKNOWN";

    const tokens = rpRaw.replace(/->/g,">").split(">")
      .map(x=>String(x||"").trim()).filter(Boolean);

    if(!tokens.length) return String(tpl.end_point || "").trim() || "UNKNOWN";

    let end = tokens[tokens.length - 1];
    if(end && start && end.toLowerCase() === start && tokens.length >= 2){
      end = tokens[tokens.length - 2];
    }
    return end || "UNKNOWN";
  }

  function endKeyFromColumnG(tpl){
    const endName = getEndNameFromColumnG(tpl);
    const pidByName = NAME_TO_ID.get(String(endName).toLowerCase());

    if(pidByName){
      const p = LOCS[pidByName] || {};
      const d = districtAny(p);
      return d || normCaps(endName);
    }

    const slug = slugifyName(endName);
    if(LOCS[slug]){
      const p = LOCS[slug] || {};
      const d = districtAny(p);
      return d || normCaps(endName);
    }

    return normCaps(endName);
  }

  function normalizeStartInput(){
    const typed = String($("startInp").value || "").trim().toUpperCase();
    if(!typed) return "";

    const exact = STARTS.find(s => String(s).trim().toUpperCase() === typed);
    if(exact) return exact;

    const partial = STARTS.find(s => String(s).trim().toUpperCase().startsWith(typed));
    if(partial) return partial;

    return "";
  }

  function getPlaceIdByNameAny(name){
    const nm = String(name || "").trim();
    if(!nm) return "";
    const pid = NAME_TO_ID.get(nm.toLowerCase());
    if(pid && LOCS[pid]) return pid;
    const slug = slugifyName(nm);
    if(slug && LOCS[slug]) return slug;
    return "";
  }

  function routeIdsFromTemplateIncludingStart(tpl){
    const baseStops = stopsFromTemplate(tpl);
    const startName = String(tpl?.start_point || "").trim();
    const startPid = getPlaceIdByNameAny(startName);

    if(startPid){
      const filtered = baseStops.filter(x => x !== startPid);
      return [startPid, ...filtered];
    }
    return baseStops;
  }

  function sanitizeStopsForTemplate(tpl, ids, endDistrictKey){
    const out = [];
    const removed = [];

    const days = Number(tpl?.days || 0);
    const endD = String(endDistrictKey || "").trim().toUpperCase();

    const regionHint = String(tpl?.region_style || tpl?.region || tpl?.route_name || "").toUpperCase();
    const localHint = (regionHint.includes(endD) || regionHint.includes("LOCAL") || regionHint.includes("CORE"));
    const shouldStrict = (!!endD && (days > 0 && days <= 4 || localHint));

    if(!shouldStrict) return { ids, removed };

    for(const pid of (ids || [])){
      const p = LOCS[pid];
      if(!p){ out.push(pid); continue; }
      const d = districtAny(p);
      if(!d){ out.push(pid); continue; }
      if(d === endD) out.push(pid);
      else removed.push({ pid, name: placeNameAny(p, pid), district: d });
    }
    return { ids: out, removed };
  }

  function packageScore(tpl){
    const locs = stopsCount(tpl);
    const pri  = Number(tpl.priority ?? 999);
    const km   = Number(tpl.total_km_est ?? tpl.estimated_drive_km ?? 1e9);
    return { locs, pri, km };
  }

  function setPills(obj){
    const box = $("pills");
    box.innerHTML = "";
    for(const [k,v] of Object.entries(obj)){
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `${escapeHtml(k)} <b>${escapeHtml(String(v))}</b>`;
      box.appendChild(div);
    }
  }

  function renderPackages(list, start){
    const box = $("pkgList");
    box.innerHTML = "";
    $("pkgCount").textContent = `${list.length} Results`;

    if(!list.length){
      box.innerHTML = `<div class="pill">No packages for <b>${escapeHtml(String(start).toUpperCase())}</b></div>`;
      return;
    }

    list.forEach(t=>{
      const endKey = endKeyFromColumnG(t);
      const days = Number(t.days || 0) || 0;
      const tempoOk = (t.tempo_ok === true || safeLower(t.tempo_ok)==="true");

      const routeIds = routeIdsFromTemplateIncludingStart(t);
      let thumbUrl="", ini="HP";
      if(routeIds[0]){
        const p = LOCS[routeIds[0]] || {};
        const nm = placeNameAny(p, routeIds[0]);
        ini = initials(nm);
        thumbUrl = pickPhotoAny(p);
      }

      const el = document.createElement("div");
      el.className = "pkg";
      el.dataset.key = t.key;

      el.innerHTML = `
        <div class="pkgPic">
          ${thumbUrl
            ? `<img src="${escapeHtml(thumbUrl)}" alt="Package thumbnail" loading="lazy" referrerpolicy="no-referrer"
                  onerror="this.remove(); this.parentNode.textContent='${escapeHtml(ini)}';">`
            : escapeHtml(ini)
          }
        </div>
        <div class="pkgBody">
          <div class="pkgName">${escapeHtml(String(start).toUpperCase())} → ${escapeHtml(String(endKey).toUpperCase())}</div>
          <div class="pkgMeta">
            LOCATIONS: ${stopsCount(t)} • DAYS: ${days || "—"}<br/>
            ROUTE ID: ${escapeHtml(String(t.route_id||"—").toUpperCase())}
          </div>
          <div class="tag ${tempoOk ? "ok" : "warn"}">${tempoOk ? "TEMPO OK" : "TEMPO RISK"}</div>
        </div>
      `;
      el.onclick = ()=>openTemplate(t.key, start);
      box.appendChild(el);
    });
  }

  function buildDayWise(tpl){
    const days = Number(tpl.days || 1);
    const blocks = [];
    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      blocks.push({ day:d, ids });
    }
    const anyHas = blocks.some(x=>x.ids.length);
    if(!anyHas){
      const raw = String(tpl.major_place_ids || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      return [{ day:1, ids }];
    }
    return blocks.filter(x=>x.ids.length);
  }

  function renderItinerary(tpl, start, endKey, sanityRemoved){
    $("activePkgName").textContent = `${String(tpl.days||"—")}D`;
    $("itTitle").textContent = `${String(start).toUpperCase()} → ${String(endKey).toUpperCase()}`;

    const metaParts = [];
    if(tpl.route_path) metaParts.push(`Route: ${tpl.route_path}`);
    if(tpl.best_season) metaParts.push(`Season: ${tpl.best_season}`);
    if(tpl.ideal_for) metaParts.push(`Ideal: ${tpl.ideal_for}`);
    $("itMeta").textContent = metaParts.join(" • ") || "—";

    const noteEl = $("itSanityNote");
    if(sanityRemoved?.length){
      noteEl.style.display = "block";
      noteEl.innerHTML = `Auto-removed wrong-district places: <b style="color:#fff;">${sanityRemoved.map(x=>escapeHtml(x.name)).join(", ")}</b>`;
    }else{
      noteEl.style.display = "none";
      noteEl.textContent = "";
    }

    const inc = String(tpl.inclusions || "").trim();
    const exc = String(tpl.exclusions || "").trim();
    const note = String(tpl.important_notes || tpl.notes || "").trim();
    $("incExc").innerHTML =
      `<b style="color:#fff;letter-spacing:.12em;">INCLUDES:</b> ${escapeHtml(inc || "—")}<br><br>` +
      `<b style="color:#fff;letter-spacing:.12em;">EXCLUDES:</b> ${escapeHtml(exc || "—")}<br><br>` +
      `<b style="color:#fff;letter-spacing:.12em;">NOTES:</b> ${escapeHtml(note || "—")}`;

    const daysList = $("daysList");
    daysList.innerHTML = "";

    const removedSet = new Set((sanityRemoved || []).map(x=>x.pid));
    const blocks = buildDayWise(tpl).map(b=>({
      day: b.day,
      ids: (b.ids || []).filter(pid => !removedSet.has(pid))
    })).filter(b=>b.ids.length);

    blocks.forEach(block=>{
      const dayCard = document.createElement("div");
      dayCard.className = "dayCard";
      dayCard.innerHTML = `
        <div class="dayTop">
          <div class="d">Day ${block.day}</div>
          <div class="muted">${block.ids.length} places</div>
        </div>
        <div class="muted">Tap a place to open details popup</div>
        <div class="dayPlaces"></div>
      `;
      const cont = dayCard.querySelector(".dayPlaces");

      block.ids.forEach(pid=>{
        const p = LOCS[pid] || {};
        const name = placeNameAny(p, pid);
        const seg  = segmentAny(p) || "—";
        const dist = districtAny(p) || "—";
        const url = pickPhotoAny(p);

        const line = document.createElement("div");
        line.className = "placeLine";
        line.innerHTML = `
          <div class="thumb">
            ${url
              ? `<img src="${escapeHtml(url)}" alt="${escapeHtml(name)} photo" loading="lazy" referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentNode.textContent='${escapeHtml(initials(name))}';">`
              : escapeHtml(initials(name))
            }
          </div>
          <div class="pinfo">
            <div class="pname">${escapeHtml(name)}</div>
            <div class="pmeta">${escapeHtml(seg)} • ${escapeHtml(dist)}</div>
          </div>
        `;
        line.onclick = ()=>showPlacePopup(pid);
        cont.appendChild(line);
      });

      daysList.appendChild(dayCard);
    });
  }

  async function drawRoadRouteFromPlaces(placeIds){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }

    const pts = [];
    const validIds = [];
    for(const pid of placeIds){
      const p = LOCS[pid] || {};
      const lat = latAny(p);
      const lng = lngAny(p);
      if(isFinite(lat) && isFinite(lng)){
        pts.push([lng,lat]);
        validIds.push(pid);
      }
    }
    if(pts.length < 2){
      toast("Not enough coordinates for route");
      return { ok:false, km:0 };
    }

    const maxPts = 25;
    let used = pts;
    if(pts.length > maxPts){
      const step = Math.ceil(pts.length / maxPts);
      used = pts.filter((_,i)=> i%step===0 || i===pts.length-1);
    }

    try{
      const url =
        "https://router.project-osrm.org/route/v1/driving/" +
        used.map(c=>c.join(",")).join(";") +
        "?overview=full&geometries=geojson&steps=false";

      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes?.length){
        toast("Road route not available");
        return { ok:false, km:0 };
      }

      const r = data.routes[0];
      const latlngs = r.geometry.coordinates.map(c=>[c[1],c[0]]);
      routeLine = L.polyline(latlngs, { weight: 5, opacity: .95 }).addTo(map);
      fitRoute();

      const markIds = (showMode==="startend")
        ? [validIds[0], validIds[validIds.length-1]]
        : validIds;

      for(let i=0;i<markIds.length;i++){
        const pid = markIds[i];
        const p = LOCS[pid] || {};
        const lat = latAny(p);
        const lng = lngAny(p);
        if(!isFinite(lat)||!isFinite(lng)) continue;

        const nm = placeNameAny(p, pid);
        const isFirst = (i===0);
        L.marker([lat,lng]).addTo(markersLayer)
          .bindPopup(
            `<b>${escapeHtml(nm)}</b>` +
            (isFirst ? `<br><small style="opacity:.85;">START OF PACKAGE</small>` : `<br><small style="opacity:.8;">Tap marker to open details</small>`)
          )
          .on("click", ()=>showPlacePopup(pid));
      }

      const km = Number(r.distance/1000);
      $("kmBadge").textContent = km.toFixed(1) + " KM";
      return { ok:true, km };
    }catch(e){
      console.error(e);
      toast("Route error");
      return { ok:false, km:0 };
    }
  }

  function applyFilters(){
    const start = normalizeStartInput();
    const daysF = $("daysSel").value.trim();
    const pax   = Number($("paxSel").value || 2);
    const tier  = String($("visitType")?.value || "budget").toUpperCase();

    clearMap();
    $("activePkgName").textContent = "—";
    $("itTitle").textContent = "Select a package";
    $("itMeta").textContent = "Day-wise details will appear here";
    $("itSanityNote").style.display = "none";
    $("itSanityNote").textContent = "";
    $("incExc").textContent = "—";
    $("daysList").innerHTML = "";
    $("priceTotal").innerHTML = "— <small></small>";
    $("pricePer").innerHTML = "— <small></small>";
    CURRENT_TEMPLATE_KEY = "";
    CURRENT_ROUTE_KM = 0;

    if(!start){
      toast("Start not found in templates");
      return;
    }

    const startUpper = String(start).trim().toUpperCase();
    const startIsHP = isStartWithinHimachal(startUpper);

    let list = ACTIVE_TEMPLATES.filter(t =>
      String(t.start_point||"").trim().toUpperCase() === startUpper
    );

    if(startIsHP){
      list = list.filter(t => Number(t.days||0) > 0 && Number(t.days||0) <= 2);
    }else{
      if(daysF) list = list.filter(t => Number(t.days||0) === Number(daysF));
    }

    let finalList = [];
    if(startIsHP){
      finalList = list.sort((a,b)=>{
        const A = packageScore(a), B = packageScore(b);
        if(A.locs !== B.locs) return B.locs - A.locs;
        if(A.pri !== B.pri) return A.pri - B.pri;
        return A.km - B.km;
      });
    }else{
      const bestByEnd = new Map();
      const scByEnd = new Map();

      function isBetter(A,B){
        if(A.locs !== B.locs) return A.locs > B.locs;
        if(A.pri !== B.pri)   return A.pri < B.pri;
        return A.km < B.km;
      }

      for(const t of list){
        const endKey = endKeyFromColumnG(t);
        const sc = packageScore(t);
        if(!bestByEnd.has(endKey)){
          bestByEnd.set(endKey, t);
          scByEnd.set(endKey, sc);
        }else{
          const prev = scByEnd.get(endKey);
          if(isBetter(sc, prev)){
            bestByEnd.set(endKey, t);
            scByEnd.set(endKey, sc);
          }
        }
      }

      finalList = Array.from(bestByEnd.values()).sort((a,b)=>{
        const A = packageScore(a), B = packageScore(b);
        if(A.locs !== B.locs) return B.locs - A.locs;
        if(A.pri !== B.pri) return A.pri - B.pri;
        return A.km - B.km;
      });
    }

    CURRENT_LIST = finalList;

    setPills({
      START: startUpper,
      TYPE: tier,
      PACKAGES: finalList.length,
      PAX: pax,
      DAYS: startIsHP ? "MAX 2 (HP START)" : (daysF ? daysF : "ANY")
    });

    renderPackages(finalList, start);
    toast("Packages generated");
  }

  async function openTemplate(key, start){
    const tpl = TEMPLATES[key];
    if(!tpl){ toast("Package not found"); return; }
    CURRENT_TEMPLATE_KEY = key;

    document.querySelectorAll(".pkg").forEach(x=>x.classList.remove("active"));
    const node = document.querySelector(`.pkg[data-key="${cssEscapeSafe(key)}"]`);
    if(node) node.classList.add("active");

    const endKey = endKeyFromColumnG(tpl);
    const routeIdsRaw = routeIdsFromTemplateIncludingStart(tpl);
    const sanity = sanitizeStopsForTemplate(tpl, routeIdsRaw, endKey);
    const routeIds = sanity.ids;

    renderItinerary(tpl, start, endKey, sanity.removed);

    const rr = await drawRoadRouteFromPlaces(routeIds);
    if(rr.ok){
      CURRENT_ROUTE_KM = rr.km;
      computeDbPriceForCurrent();
      if(sanity.removed?.length) toast("Wrong-district place removed from this package");
    }else{
      CURRENT_ROUTE_KM = 0;
      computeDbPriceForCurrent(); // still compute using fallback km
    }
  }

  function openPlaceModal(){
    $("placeModalBack").style.display = "block";
    $("placeModal").style.display = "block";
  }
  function closePlaceModal(){
    $("placeModalBack").style.display = "none";
    $("placeModal").style.display = "none";
  }

  function metaFromAny(p){
    const bits = [districtAny(p), categoryAny(p), segmentAny(p), regionAny(p)].filter(Boolean);
    return bits.join(" • ") || "—";
  }
  function textAny(p, keys, fallback="—"){
    for(const k of keys){
      const v = p?.[k];
      if(v && String(v).trim()) return String(v).trim();
    }
    return fallback;
  }

  async function showPlacePopup(placeId){
    const p = LOCS[placeId];
    if(!p){
      toast("Place not found in loaded data");
      return;
    }

    const title = placeNameAny(p, placeId);
    $("mTitle").textContent = title;
    $("mMeta").textContent = metaFromAny(p);

    const history = textAny(p, ["history_tagline","History Tagline","Short Description","Overview"], "—");
    const find = textAny(p, ["what_you_find","What you find","Key Features"], "—");

    $("mHistory").textContent = history;
    $("mFind").textContent = find;

    const photo = pickPhotoAny(p);
    if(photo){
      $("mPhoto").innerHTML = `<img src="${escapeHtml(photo)}" style="width:100%;height:220px;object-fit:cover;display:block;"
        referrerpolicy="no-referrer"
        onerror="this.remove(); this.parentNode.textContent='NO PHOTO';">`;
    }else{
      $("mPhoto").textContent = "NO PHOTO";
    }

    const lat = latAny(p);
    const lng = lngAny(p);

    $("mFocus").onclick = ()=>{
      closePlaceModal();
      if(isFinite(lat) && isFinite(lng)){
        map.setView([lat,lng], Math.max(map.getZoom(), 12));
      }else{
        toast("No lat/long for this place");
      }
    };

    $("mCopy").onclick = async ()=>{
      try{ await navigator.clipboard.writeText(placeId); toast("Place ID copied"); }
      catch(e){ toast("Copy not allowed"); }
    };

    openPlaceModal();
  }

  /* ======================================================
     ✅ DB BASED COST CALCULATOR (MATCHES YOUR DB NODES)
     Nodes:
       pricing_transport/{vehicleKey}
       stay_rate_rules/{ruleKey}
     ====================================================== */
  let TRANSPORT = {};
  let STAYRULES = {};
  let PRICING_READY = false;

  async function loadPricingNodes(){
    try{
      const [tSnap, sSnap] = await Promise.all([
        db.ref("pricing_transport").once("value"),
        db.ref("stay_rate_rules").once("value")
      ]);
      TRANSPORT = tSnap.val() || {};
      STAYRULES = sSnap.val() || {};
      PRICING_READY = true;
    }catch(e){
      console.error(e);
      PRICING_READY = false;
      toast("Pricing nodes not readable");
    }
  }

  function getTier(){
    return String($("visitType")?.value || "budget").toLowerCase();
  }

  function vehicleKeyByPax(pax){
    pax = Number(pax || 2);
    let best=null;
    let smallest=999;
    for(const [k,v] of Object.entries(TRANSPORT||{})){
      if(String(v.status||"active").toLowerCase() !== "active") continue;
      const max=Number(v.max_pax||0);
      if(max>=pax && max<smallest){
        smallest=max;
        best=k;
      }
    }
    return best || Object.keys(TRANSPORT||{})[0] || "";
  }

  function stayRuleKeyDefault(){
    const tier = getTier();
    const map = {
      budget: ["budget"],
      premium:["midrange","family","superior"],
      luxury:["boutique","deluxe","premium","luxury"]
    };
    const wantCats = map[tier] || ["budget"];

    for(const [key,v] of Object.entries(STAYRULES||{})){
      if(String(v.status||"active").toLowerCase() !== "active") continue;
      const cat = String(v.category||"").toLowerCase();
      if(wantCats.includes(cat)) return key;
    }
    return Object.keys(STAYRULES||{})[0] || "";
  }

  function estimateTotalCostFromDb({ km=0, days=3, pax=2 }){
    km = Number(km||0);
    days = Number(days||0);
    pax = Math.max(1,Number(pax||1));
    const nights=Math.max(0,days-1);

    if(!PRICING_READY || !km || !days){
      return { total:NaN, perPerson:NaN };
    }

    // --- VEHICLE ---
    const vKey=vehicleKeyByPax(pax);
    const vehicle=TRANSPORT?.[vKey];
    if(!vehicle) return { total:NaN, perPerson:NaN };

    const perKm=Number(vehicle.per_km||0);
    const driver=Number(vehicle.driver_per_day||0);
    const nightCharge=Number(vehicle.night_charge||0);
    const bufferPct=Number(vehicle.parking_toll_buffer_pct||0);

    // --- HOTEL RULE (tier-based by category) ---
    const sKey=stayRuleKeyDefault();
    const stay=STAYRULES?.[sKey];
    if(!stay) return { total:NaN, perPerson:NaN };

    const roomRate = Number(stay.base_rate_mid || stay.base_rate_low || stay.base_rate_peak || 0);

    // ✅ Room capacity (default 2 pax/room). If later you add room_capacity in DB, it will auto-use.
    const roomCap = Math.max(1, Number(stay.room_capacity || 2));
    const rooms = Math.ceil(pax / roomCap);

    // --- TRANSPORT COST ---
    const transport =
      (km*perKm)+
      (days*driver)+
      (nights*nightCharge);

    // --- HOTEL COST ---
    const hotel =
      rooms*roomRate*nights;

    // --- BUFFER ---
    const buffer =
      (bufferPct>0)
        ? ((transport+hotel)*bufferPct/100)
        : 0;

    const total=transport+hotel+buffer;
    const perPerson=total/pax;

    return {
      total,
      perPerson,
      meta:{
        tier: getTier(),
        vehicle:vKey,
        stay:sKey,
        rooms,
        nights,
        kmUsed: km
      }
    };
  }

  function updatePriceBoxes(total, perPerson, meta){
    const totalEl = $("priceTotal");
    const perEl   = $("pricePer");
    if(!totalEl || !perEl) return;

    if(!isFinite(total)){
      totalEl.innerHTML = "— <small></small>";
      perEl.innerHTML = "— <small></small>";
      return;
    }

    const tier = String(meta?.tier || "").toUpperCase();
    const vKey  = String(meta?.vehicle || "").toUpperCase();
    const sKey  = String(meta?.stay || "").toUpperCase();
    totalEl.innerHTML = rupees(total) + ` <small>(${tier} • ${vKey} • ${sKey})</small>`;
    perEl.innerHTML = rupees(perPerson) + ` <small>per person</small>`;
  }

  function computeDbPriceForCurrent(){
    try{
      if(!CURRENT_TEMPLATE_KEY) return;
      const tpl = TEMPLATES?.[CURRENT_TEMPLATE_KEY];
      if(!tpl) return;

      const pax = Number($("paxSel")?.value || 2);
      const days = Number(tpl.days || $("daysSel")?.value || 3);

      // ✅ KM fallback: OSRM -> template total_km_est -> estimated_drive_km
      let km = Number(CURRENT_ROUTE_KM || 0);
      if(!isFinite(km) || km <= 0){
        km = Number(tpl.total_km_est || tpl.estimated_drive_km || 0);
      }

      const est = estimateTotalCostFromDb({ km, days, pax });
      updatePriceBoxes(est.total, est.perPerson, est.meta);

    }catch(e){
      console.error(e);
      updatePriceBoxes(NaN, NaN);
    }
  }

  /* ===============================
     ✅ Boot
     =============================== */
  window.addEventListener("DOMContentLoaded", () => {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    storage = firebase.storage();
    analytics = firebase.analytics();

    // Quote rotation
    setInterval(()=>{
      qIndex=(qIndex+1)%QUOTES.length;
      $("quoteText").innerHTML = "“" + QUOTES[qIndex] + "”";
    }, 5000);

    // Copy contact
    $("copyContactBtn")?.addEventListener("click", async ()=>{
      const txt =
`Himachal Explorer Portal
Chandan Panwar
+91 7018138847
chandanpanwar001@gmail.com
https://himachalexplorer.in/`;
      try{ await navigator.clipboard.writeText(txt); toast("Contact copied"); }
      catch(e){ toast("Copy not allowed"); }
    });

    // Modal events
    $("placeModalBack").addEventListener("click", closePlaceModal);
    $("mClose").addEventListener("click", closePlaceModal);
    window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closePlaceModal(); });

    // UI events
    $("genBtn").addEventListener("click", applyFilters);
    $("startInp").addEventListener("keydown",(e)=>{ if(e.key==="Enter") applyFilters(); });

    $("resetBtn").addEventListener("click", ()=>{
      $("startInp").value="";
      $("visitType").value="budget";
      $("daysSel").value="";
      $("paxSel").value="2";
      $("pills").innerHTML="";
      $("pkgList").innerHTML = `<div class="pill"><span>Type Start & click</span> <b>Generate</b></div>`;
      $("pkgCount").textContent="—";
      $("activePkgName").textContent="—";
      $("itTitle").textContent="Select a package";
      $("itMeta").textContent="Day-wise details will appear here";
      $("itSanityNote").style.display = "none";
      $("itSanityNote").textContent = "";
      $("incExc").textContent="—";
      $("daysList").innerHTML="";
      $("priceTotal").innerHTML="— <small></small>";
      $("pricePer").innerHTML="— <small></small>";
      clearMap();
      CURRENT_TEMPLATE_KEY = "";
      CURRENT_ROUTE_KM = 0;
      toast("Reset done");
    });

    $("fitMapBtn").addEventListener("click", fitRoute);
    $("clearRouteBtn").addEventListener("click", ()=>{ clearMap(); toast("Cleared"); });

    $("showAllStopsBtn").addEventListener("click", async ()=>{
      showMode="all";
      toast("Markers: all stops");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const endKey = endKeyFromColumnG(tpl);
        const routeIdsRaw = routeIdsFromTemplateIncludingStart(tpl);
        const sanity = sanitizeStopsForTemplate(tpl, routeIdsRaw, endKey);
        await drawRoadRouteFromPlaces(sanity.ids);
      }
    });

    $("showStartEndBtn").addEventListener("click", async ()=>{
      showMode="startend";
      toast("Markers: start/end");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const endKey = endKeyFromColumnG(tpl);
        const routeIdsRaw = routeIdsFromTemplateIncludingStart(tpl);
        const sanity = sanitizeStopsForTemplate(tpl, routeIdsRaw, endKey);
        await drawRoadRouteFromPlaces(sanity.ids);
      }
    });

    $("toggleTilesBtn").addEventListener("click", ()=>{
      tilesDark = !tilesDark;
      try{
        map.removeLayer(tile);
        tile = tilesDark
          ? L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 })
          : L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
        tile.addTo(map);
      }catch(e){}
      toast(tilesDark ? "Dark tiles on" : "Light tiles on");
    });

    // ✅ Recalculate cost on changes
    $("paxSel")?.addEventListener("change", computeDbPriceForCurrent);
    $("visitType")?.addEventListener("change", ()=>{
      computeDbPriceForCurrent();
      if($("pills").children.length){
        // refresh pills if already generated
        applyFilters();
      }
    });

    initMap();
    loadPricingNodes()
      .then(()=> loadAll())
      .then(()=> toast("Portal ready"))
      .catch(err=>{
        console.error(err);
        setStatus("Firebase load error (check rules / nodes)");
        toast("Firebase load error");
      });
  });
  </script>
</body>
</html>