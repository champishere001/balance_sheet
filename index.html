<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Packages Only</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#070a12;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --r: 18px; --r2: 26px;
      --accent:#7aa7ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.80)),
        url("Dark.jpg") center/cover no-repeat fixed;
      overflow-x:hidden;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px}

    .topBar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 0 6px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: rgba(255,255,255,.10) url("logo.png") center/cover no-repeat;
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .title{
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .title b{font-size:16px}
    .title span{font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      font-size:12px;
      color:var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:12px;
      margin-top:10px;
    }

    .card{
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead h3{margin:0; font-size:14px}
    .cardBody{padding:12px 14px}

    /* Planner */
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    select,input{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    .btn{
      margin-top:10px;
      width:100%;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(122,167,255,.35), rgba(122,167,255,.16));
      color: var(--text);
      font-weight:800;
      cursor:pointer;
    }
    .btn:active{transform: translateY(1px)}
    .note{font-size:12px; color:var(--muted); margin-top:8px}

    /* Map smaller */
    #map{height:260px; width:100%}

    /* Packages list */
    .pkgList{display:grid; grid-template-columns: 1fr; gap:10px}
    .pkg{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)),
        url("Travelers.jpg") center/cover no-repeat;
      background-blend-mode: overlay;
      box-shadow: 0 14px 50px rgba(0,0,0,.35);
      overflow:hidden;
      cursor:pointer;
      position:relative;
    }
    .pkg:before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.78));
    }
    .pkg > *{position:relative}
    .pkgBody{padding:12px}
    .pkgTitle{font-weight:900; margin:0 0 6px}
    .pkgMeta{font-size:12px; color:rgba(255,255,255,.78)}
    .pkgLine{margin-top:8px; font-size:12px; color:rgba(255,255,255,.86); line-height:1.45}
    .pkgBtn{
      margin-top:10px;
      display:inline-flex;
      gap:8px; align-items:center;
      padding:9px 11px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      font-size:12px;
    }
    .pkg.active{
      border-color: rgba(122,167,255,.6);
      box-shadow: 0 0 0 3px rgba(122,167,255,.18), 0 14px 50px rgba(0,0,0,.35);
    }

    /* Route details (day-wise) */
    .days{
      display:grid; grid-template-columns: 1fr; gap:10px;
    }
    .day{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .dayTop{
      padding:10px 12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .dayTop b{font-size:13px}
    .dayTop span{font-size:12px; color:var(--muted)}
    .dayPlaces{padding:10px 12px; display:flex; flex-wrap:wrap; gap:8px}
    .tag{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tag:hover{border-color: rgba(122,167,255,.45)}

    /* Taglines section */
    .taglines{
      display:grid; grid-template-columns: 1fr; gap:10px;
    }
    .tl{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)),
        url("201-himalaya.jpg") center/cover no-repeat;
      background-blend-mode: overlay;
      overflow:hidden;
      position:relative;
    }
    .tl:before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.85));
    }
    .tl > *{position:relative}
    .tlBody{padding:12px}
    .tlTitle{font-weight:900; margin:0 0 6px}
    .tlMeta{font-size:12px; color:rgba(255,255,255,.78)}
    .tlText{
      margin-top:8px;
      font-size:12px;
      line-height:1.55;
      color:rgba(255,255,255,.88);
      display:-webkit-box;
      -webkit-line-clamp:4;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      #map{height:240px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topBar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Himachal Explorer</b>
          <span>Packages • Route-wise plan • Taglines • Map</span>
        </div>
      </div>
      <div class="pill" id="statusPill">Loading Firebase…</div>
    </div>

    <div class="grid">
      <!-- LEFT: Planner + Packages -->
      <section class="card">
        <div class="cardHead">
          <h3>Package Planner</h3>
          <span class="pill" id="selPkgPill">No package selected</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div>
              <label>Start (district)</label>
              <select id="startSelect"></select>
            </div>
            <div>
              <label>End (district)</label>
              <select id="endSelect"></select>
            </div>
            <div>
              <label>Days</label>
              <input id="daysInput" type="number" min="1" max="15" value="3"/>
            </div>
            <div>
              <label>People</label>
              <input id="paxInput" type="number" min="1" max="24" value="4"/>
            </div>
          </div>
          <button class="btn" id="btnFindPkgs">Find Packages</button>
          <div class="note" id="plannerNote">Packages will appear below. Nothing else will show until you select one.</div>

          <div style="height:12px"></div>
          <div class="cardHead" style="border-radius:18px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.18)">
            <h3 style="margin:0">Packages</h3>
            <span class="pill" id="pkgCount">0</span>
          </div>
          <div style="height:10px"></div>
          <div class="pkgList" id="pkgList"></div>
        </div>
      </section>

      <!-- RIGHT: Map + Route details + Taglines -->
      <section style="display:grid; gap:12px">
        <div class="card">
          <div class="cardHead">
            <h3>Map (smaller)</h3>
            <span class="pill" id="mapPill">Select a package</span>
          </div>
          <div id="map"></div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h3>Route-wise details</h3>
            <span class="pill" id="routePill">Day-wise places</span>
          </div>
          <div class="cardBody">
            <div class="days" id="daysBox">
              <div class="note">Select a package to show day-wise route details here.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h3>Taglines (only selected package)</h3>
            <span class="pill" id="taglinePill">0</span>
          </div>
          <div class="cardBody">
            <div class="taglines" id="taglinesBox">
              <div class="note">After selecting a package, you will see place taglines here.</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    /************ Firebase Config (YOUR VALUES) ************/
    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /************ Utils ************/
    const $ = (id)=>document.getElementById(id);
    const safe = (v)=> (v===undefined || v===null) ? "" : String(v);

    function parsePlaceIds(val){
      if(!val) return [];
      return String(val).split(/[;,|]/).map(v=>v.trim()).filter(Boolean);
    }

    function uniq(arr){
      return [...new Set(arr.filter(Boolean))];
    }

    /************ Map ************/
    const map = L.map("map", { zoomControl:true }).setView([31.7, 77.2], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18, attribution: "&copy; OpenStreetMap"
    }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    function clearMap(){
      markersLayer.clearLayers();
    }

    function plotPlacesOnMap(places){
      clearMap();
      const bounds = [];
      places.forEach(p=>{
        const lat = Number(p.latitude), lng = Number(p.longitude);
        if(!isFinite(lat) || !isFinite(lng)) return;
        const m = L.marker([lat,lng]).addTo(markersLayer);
        m.bindPopup(`<b>${safe(p.name)}</b><br/><span style="color:#ccc">${safe(p.district)} • ${safe(p.segment)}</span>`);
        bounds.push([lat,lng]);
      });
      if(bounds.length){
        try{ map.fitBounds(bounds, {padding:[25,25]}); }catch(e){}
      }
    }

    /************ State ************/
    let PLACES_BY_ID = {};   // { place_id: placeObj }
    let TEMPLATES = [];      // templates array
    let SELECTED_PACKAGE_ID = "";

    /************ DOM ************/
    const statusPill = $("statusPill");
    const startSelect = $("startSelect");
    const endSelect = $("endSelect");
    const daysInput = $("daysInput");
    const paxInput = $("paxInput");
    const btnFindPkgs = $("btnFindPkgs");
    const pkgList = $("pkgList");
    const pkgCount = $("pkgCount");

    const selPkgPill = $("selPkgPill");
    const mapPill = $("mapPill");
    const routePill = $("routePill");
    const daysBox = $("daysBox");

    const taglinePill = $("taglinePill");
    const taglinesBox = $("taglinesBox");
    const plannerNote = $("plannerNote");

    /************ UI Helpers ************/
    function setSelectOptions(select, values){
      select.innerHTML = values.map(v=>`<option value="${v}">${v}</option>`).join("");
    }

    function templateScore(t){
      // simple "value" scoring: active + moderate days + shorter km
      const days = Number(t.days||0);
      const km = Number(t.total_km_est||0);
      const active = safe(t.status).toLowerCase() !== "inactive";
      let s = 0;
      s += active ? 50 : 0;
      if(days>=2 && days<=6) s += 25;
      if(isFinite(km) && km>0) s += Math.max(0, 35 - km/35);
      return s;
    }

    function renderPackageList(list){
      pkgCount.textContent = String(list.length);
      if(!list.length){
        pkgList.innerHTML = `<div class="note">No packages found for selected filters.</div>`;
        return;
      }
      // sorted best first
      const top = [...list].sort((a,b)=>templateScore(b)-templateScore(a)).slice(0,12);

      pkgList.innerHTML = top.map(t=>{
        const majors = parsePlaceIds(t.major_place_ids).slice(0,6).join(", ");
        return `
          <div class="pkg" data-id="${safe(t.package_id)}">
            <div class="pkgBody">
              <div class="pkgTitle">${safe(t.route_name || t.package_id)}</div>
              <div class="pkgMeta">${safe(t.days)} days • ${safe(t.total_km_est || "")} km • ${safe(t.best_season || "")}</div>
              <div class="pkgLine"><b>Major:</b> ${safe(majors || "—")}</div>
              <div class="pkgBtn">Select package →</div>
            </div>
          </div>
        `;
      }).join("");

      [...pkgList.querySelectorAll(".pkg")].forEach(el=>{
        el.addEventListener("click", ()=>{
          [...pkgList.querySelectorAll(".pkg")].forEach(x=>x.classList.remove("active"));
          el.classList.add("active");
          const id = el.getAttribute("data-id");
          selectPackage(id);
        });
      });
    }

    function renderRouteDetails(t, placesList){
      const days = Number(t.days || 0);
      const dayCols = ["day1_place_ids","day2_place_ids","day3_place_ids","day4_place_ids","day5_place_ids","day6_place_ids","day7_place_ids","day8_place_ids","day9_place_ids"];

      const html = [];
      for(let i=0; i<Math.min(9, Math.max(days, 1)); i++){
        const key = dayCols[i];
        const ids = parsePlaceIds(t[key]);
        if(!ids.length) continue;

        const tags = ids.map(pid=>{
          const p = PLACES_BY_ID[pid];
          const label = p ? safe(p.name) : pid;
          return `<div class="tag" data-pid="${pid}" title="${pid}">${label}</div>`;
        }).join("");

        html.push(`
          <div class="day">
            <div class="dayTop">
              <b>Day ${i+1}</b>
              <span>${ids.length} stops</span>
            </div>
            <div class="dayPlaces">${tags}</div>
          </div>
        `);
      }

      if(!html.length){
        daysBox.innerHTML = `<div class="note">No day-wise places found in this template. Check day1_place_ids… columns in Firebase.</div>`;
      }else{
        daysBox.innerHTML = html.join("");
        // click a place tag -> focus on map
        [...daysBox.querySelectorAll(".tag")].forEach(tag=>{
          tag.addEventListener("click", ()=>{
            const pid = tag.getAttribute("data-pid");
            const p = PLACES_BY_ID[pid];
            if(!p) return;
            const lat = Number(p.latitude), lng = Number(p.longitude);
            if(isFinite(lat) && isFinite(lng)){
              map.setView([lat,lng], 12);
            }
          });
        });
      }

      routePill.textContent = `${safe(t.route_name || t.package_id)} • ${safe(t.days)} days`;
    }

    function renderTaglines(placesList){
      const cards = placesList.slice(0, 18).map(p=>{
        const meta = [p.district, p.segment, p.category].filter(Boolean).join(" • ");
        const tl = safe(p.history_tagline || p.what_you_find || "");
        return `
          <div class="tl">
            <div class="tlBody">
              <div class="tlTitle">${safe(p.name)}</div>
              <div class="tlMeta">${safe(meta)}</div>
              <div class="tlText">${safe(tl || "—")}</div>
            </div>
          </div>
        `;
      }).join("");

      taglinePill.textContent = String(placesList.length);
      taglinesBox.innerHTML = cards || `<div class="note">No taglines found for this package places.</div>`;
    }

    /************ Package selection ************/
    function collectPackagePlaceIds(t){
      const ids = [];
      ids.push(...parsePlaceIds(t.major_place_ids));
      ids.push(...parsePlaceIds(t.day1_place_ids));
      ids.push(...parsePlaceIds(t.day2_place_ids));
      ids.push(...parsePlaceIds(t.day3_place_ids));
      ids.push(...parsePlaceIds(t.day4_place_ids));
      ids.push(...parsePlaceIds(t.day5_place_ids));
      ids.push(...parsePlaceIds(t.day6_place_ids));
      ids.push(...parsePlaceIds(t.day7_place_ids));
      ids.push(...parsePlaceIds(t.day8_place_ids));
      ids.push(...parsePlaceIds(t.day9_place_ids));
      return uniq(ids);
    }

    async function selectPackage(packageId){
      SELECTED_PACKAGE_ID = packageId;
      const t = TEMPLATES.find(x => safe(x.package_id) === safe(packageId));
      if(!t) return;

      selPkgPill.textContent = safe(t.route_name || t.package_id);
      mapPill.textContent = `Showing: ${safe(t.route_name || t.package_id)}`;

      // Load only package places (no all places anywhere)
      const ids = collectPackagePlaceIds(t);

      const placesList = [];
      const missing = [];

      ids.forEach(id=>{
        const p = PLACES_BY_ID[id];
        if(p) placesList.push(p);
        else missing.push(id);
      });

      // Fallback: if some ids missing, try to fetch directly
      if(missing.length){
        const snaps = await Promise.all(missing.slice(0,50).map(id => db.ref("places/"+id).get().catch(()=>null)));
        snaps.forEach((s,i)=>{
          if(s && s.exists()){
            const p = s.val() || {};
            p.place_id = missing[i];
            PLACES_BY_ID[p.place_id] = p;
            placesList.push(p);
          }
        });
      }

      renderRouteDetails(t, placesList);
      renderTaglines(placesList);
      plotPlacesOnMap(placesList);

      plannerNote.textContent = `Loaded package places only: ${placesList.length} places.`;
    }

    /************ Planner filtering ************/
    function filterPackagesByPlanner(){
      const start = startSelect.value;
      const end = endSelect.value;
      const days = Number(daysInput.value || 0);

      let list = [...TEMPLATES];

      if(days){
        list = list.filter(t => Number(t.days||0) === days);
      }

      // optional: match start/end in text fields
      list = list.filter(t=>{
        const txt = (safe(t.start_point) + " " + safe(t.end_point) + " " + safe(t.route_path)).toLowerCase();
        const okStart = !start || txt.includes(start.toLowerCase());
        const okEnd = !end || txt.includes(end.toLowerCase());
        return okStart && okEnd;
      });

      renderPackageList(list);
    }

    /************ Load Firebase ************/
    async function loadAll(){
      statusPill.textContent = "Connecting…";

      // places
      const placesSnap = await db.ref("places").get();
      if(!placesSnap.exists()){
        statusPill.textContent = "No /places found";
        return;
      }
      const placesObj = placesSnap.val() || {};
      PLACES_BY_ID = {};
      Object.keys(placesObj).forEach(k=>{
        PLACES_BY_ID[k] = { place_id:k, ...placesObj[k] };
      });

      // templates
      const tmplSnap = await db.ref("templates").get();
      const tmplObj = tmplSnap.exists() ? tmplSnap.val() : {};
      TEMPLATES = Object.keys(tmplObj).map(k => ({ package_id:k, ...tmplObj[k] }));

      // fill planner districts (from places)
      const districts = [...new Set(Object.values(PLACES_BY_ID).map(p=>safe(p.district)).filter(Boolean))].sort();
      if(!districts.length) districts.push("Shimla");
      setSelectOptions(startSelect, districts);
      setSelectOptions(endSelect, districts);
      startSelect.value = districts[0] || "";
      endSelect.value = districts[Math.min(2, districts.length-1)] || districts[0] || "";

      // start with packages list only (no places)
      renderPackageList(TEMPLATES);
      statusPill.textContent = "Firebase Loaded ✅";

      // Reset sections (no package selected)
      selPkgPill.textContent = "No package selected";
      mapPill.textContent = "Select a package";
      daysBox.innerHTML = `<div class="note">Select a package to show day-wise route details here.</div>`;
      taglinesBox.innerHTML = `<div class="note">After selecting a package, you will see place taglines here.</div>`;
      taglinePill.textContent = "0";
      clearMap();
    }

    btnFindPkgs.addEventListener("click", filterPackagesByPlanner);
    startSelect.addEventListener("change", filterPackagesByPlanner);
    endSelect.addEventListener("change", filterPackagesByPlanner);

    loadAll().catch(err=>{
      console.error(err);
      statusPill.textContent = "Firebase error (check rules)";
    });
  </script>
</body>
</html>