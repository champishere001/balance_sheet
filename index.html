<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>

  <title>Himachal Tour Packages | Himachal Explorer Portal</title>
  <meta name="description" content="Explore Himachal tour packages with live road route maps, day-wise itineraries, and instant price estimates." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <link rel="canonical" href="https://himachalexplorer.in/" />
  <meta name="theme-color" content="#070A12" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Himachal Explorer Portal – Tour Packages">
  <meta property="og:description" content="Live route map, day-wise itinerary, and price estimate for Himachal tour packages.">
  <meta property="og:url" content="https://himachalexplorer.in/">
  <meta property="og:image" content="https://himachalexplorer.in/og.jpg">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Himachal Explorer Portal – Tour Packages">
  <meta name="twitter:description" content="Live route map, itinerary and price estimate for Himachal tour packages.">
  <meta name="twitter:image" content="https://himachalexplorer.in/og.jpg">

  <!-- Structured data -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"Himachal Explorer Portal",
    "url":"https://himachalexplorer.in/",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"https://himachalexplorer.in/?q={search_term_string}",
      "query-input":"required name=search_term_string"
    }
  }
  </script>

  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://router.project-osrm.org" crossorigin>
  <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --stroke:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.65);
      --text:rgba(255,255,255,.92);
      --shadow: 0 24px 90px rgba(0,0,0,.55);
      --radius: 18px;
      --acc:#7C3AED;

      --topH: 92px;
      --gap: 14px;

      --leftPct: 36%;
      --mapPct: 24%;
      --rightPct: 40%;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(124,58,237,.18), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 520px at 50% 90%, rgba(6,182,212,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:auto;
    }

    .aurora{
      position:fixed; inset:-30%;
      background:
        radial-gradient(900px 500px at 25% 30%, rgba(124,58,237,.22), transparent 65%),
        radial-gradient(900px 520px at 75% 25%, rgba(34,197,94,.18), transparent 66%),
        radial-gradient(860px 540px at 55% 75%, rgba(6,182,212,.14), transparent 66%);
      filter: blur(45px);
      opacity:.9;
      animation: drift 14s ease-in-out infinite;
      pointer-events:none;
      z-index:-3;
    }
    @keyframes drift{
      0%,100%{ transform: translate3d(0,0,0) scale(1); }
      50%{ transform: translate3d(3%, -2%, 0) scale(1.06); }
    }
    .noise{
      position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.12; mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }

    .app{ min-height:100%; display:grid; grid-template-rows: var(--topH) 1fr; }

    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      backdrop-filter: blur(14px);
      gap: 12px;
    }

    .brand{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .logo{
      width:54px; height:54px; border-radius:16px;
      background: rgba(255,255,255,.10);
      border:1px solid var(--stroke);
      display:grid; place-items:center;
      overflow:hidden;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brand p{ margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.25; }

    .actions{
      display:flex; gap:10px; align-items:center;
      min-width: 260px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing:.08em;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer;
      user-select:none;
      backdrop-filter: blur(12px);
      white-space: nowrap;
    }
    .chip:hover{ background: rgba(255,255,255,.08); color: rgba(255,255,255,.82); }

    /* DESKTOP LOCKED GRID */
    .main{
      height: calc(100vh - var(--topH));
      display:grid;
      grid-template-columns: var(--leftPct) var(--mapPct) var(--rightPct);
      gap: var(--gap);
      padding: 14px;
      overflow: hidden;
      align-items: stretch;
    }

    .pane{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;

      display:flex;
      flex-direction:column;

      height:100%;
      min-height:0;
    }

    .paneHdr{
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .paneHdr .t{
      font-size:12px;
      letter-spacing:.18em;
      text-transform: uppercase;
      margin:0;
    }
    .paneHdr .s{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform: uppercase;
    }

    .filters{
      padding: 12px;
      border-bottom:1px solid var(--stroke);
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      flex:0 0 auto;
    }
    .field label{
      display:block;
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.12em;
      margin:0 0 6px 2px;
    }
    input, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.92);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 3px rgba(124,58,237,.16);
    }
    .btnRow{ display:flex; gap:10px; }
    .btn{
      flex:1;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.65));
      color:#fff;
      font-weight: 900;
      letter-spacing:.10em;
      text-transform: uppercase;
      cursor:pointer;
    }
    .btn.secondary{ background: rgba(255,255,255,.06); color: rgba(255,255,255,.85); }
    .btn:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); }

    .metaPills{
      padding: 0 12px 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke);
      flex:0 0 auto;
    }
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 11px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.78);
      display:inline-flex; align-items:center; gap:8px;
    }
    .pill b{ color:#fff; letter-spacing:.06em; }

    /* ✅ Smaller hint */
    .pill.pillHint{
      text-transform:none;
      letter-spacing:.02em;
      font-size:11px;
      padding:6px 10px;
      line-height:1.2;
      justify-content:center;
      opacity:.9;
    }
    .pill.pillHint span{ opacity:.85; }
    .pill.pillHint b{ letter-spacing:0; }

    .pkgLayout{
      flex:1;
      display:grid;
      grid-template-columns: 160px 1fr;
      min-height:0;
      overflow:hidden;
    }

    .districtBar{
      border-right:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:auto;
      padding:10px;
      min-height:0;
    }
    .distItem{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.86);
      border-radius: 14px;
      padding:10px 10px;
      font-size: 11px;
      letter-spacing:.10em;
      text-transform: uppercase;
      margin-bottom:10px;
      cursor:pointer;
      user-select:none;
    }
    .distItem:hover{ background: rgba(255,255,255,.08); }
    .distItem.active{
      border-color: rgba(124,58,237,.70);
      box-shadow: 0 0 0 3px rgba(124,58,237,.16);
      background: rgba(124,58,237,.12);
    }
    .distItem b{ color:#fff; }

    .pkgList{
      padding: 12px;
      overflow:auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      min-height:0;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
    }

    .pkgGroupHdr{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 10px;
    }
    .pkgGroupHdr .h1{
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.12em;
      text-transform: uppercase;
    }
    .pkgGroupHdr .h2{
      margin-top:6px;
      font-size: 11px;
      color: rgba(255,255,255,.75);
      letter-spacing:.08em;
      text-transform: uppercase;
      line-height: 1.35;
    }

    .pkg{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 10px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      display:flex; gap:10px;
      min-width:0;
    }
    .pkg:hover{ transform: translateY(-1px); border-color: rgba(124,58,237,.35); background: rgba(0,0,0,.28); }
    .pkg.active{ border-color: rgba(124,58,237,.70); box-shadow: 0 0 0 3px rgba(124,58,237,.18); }

    .pkgPic{
      width:58px; height:58px; border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), rgba(124,58,237,.18));
      overflow:hidden;
      flex:0 0 auto;
      display:grid; place-items:center;
      font-weight: 950;
      color: rgba(255,255,255,.85);
    }
    .pkgPic img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pkgBody{ min-width:0; flex:1; }
    .pkgName{
      font-size: 12.5px;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      margin-bottom: 6px;
    }
    .pkgMeta{
      font-size: 11px;
      color: rgba(255,255,255,.72);
      letter-spacing:.08em;
      text-transform: uppercase;
      line-height: 1.35;
    }
    .diffLine{
      margin-top:6px;
      font-size: 11px;
      color: rgba(255,255,255,.88);
      letter-spacing:.04em;
      text-transform:none;
      line-height:1.35;
      opacity:.98;
      white-space: normal;
      word-break: break-word;
    }

    #map{
      width:100%;
      height:100%;
      min-height:0;
      background: rgba(255,255,255,.04);
    }
    .mapTools{
      padding: 10px 12px;
      border-top:1px solid var(--stroke);
      display:flex; gap:10px; flex-wrap:wrap;
      flex:0 0 auto;
    }
    .toolBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.88);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none;
      white-space: nowrap;
      text-decoration:none;
    }
    .toolBtn:hover{ background: rgba(255,255,255,.08); }

    .itWrap{
      padding: 12px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
      flex:1;
    }
    .heroCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px;
    }
    .bigTitle{
      margin:0;
      font-size: 13px;
      letter-spacing:.18em;
      text-transform: uppercase;
      color:#fff;
    }
    .muted{ color: var(--muted); font-size: 11.5px; letter-spacing:.08em; text-transform: uppercase; line-height:1.35; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .mini{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 10px;
    }
    .mini .k{ font-size: 10.5px; letter-spacing:.16em; text-transform: uppercase; color: rgba(255,255,255,.70); }
    .mini .v{ margin-top:6px; font-size: 14px; font-weight: 950; letter-spacing:.06em; color:#fff; }
    .mini .v small{ font-size: 11px; color: rgba(255,255,255,.72); font-weight: 800; }

    .daysList{ display:flex; flex-direction:column; gap:10px; }

    .dayCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px;
    }
    .dayTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom: 8px;
    }
    .dayTop .d{
      font-size: 12px; font-weight: 950; letter-spacing:.18em; text-transform: uppercase;
    }

    .placeLine{
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      margin-top: 8px;
      cursor:pointer;
    }
    .placeLine:hover{ background: rgba(255,255,255,.08); }

    .thumb{
      width:40px; height:40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14), rgba(6,182,212,.18));
      flex:0 0 auto;
      display:grid; place-items:center;
      font-weight:950;
      color: rgba(255,255,255,.9);
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pinfo{ min-width:0; flex:1; }
    .pname{
      font-size: 12px;
      font-weight: 950;
      letter-spacing:.10em;
      text-transform: uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .pmeta{
      margin-top:3px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,.68);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .tabBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.82);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
    }
    .tabBtn.active{
      border-color: rgba(124,58,237,.70);
      background: rgba(124,58,237,.14);
      color:#fff;
      box-shadow: 0 0 0 3px rgba(124,58,237,.14);
    }
    .tabPanel{ display:none; }
    .tabPanel.active{ display:block; }

    .placeDetail{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px;
      overflow:hidden;
    }
    .placeHero{
      width:100%;
      height:160px;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      position:relative;
    }
    .placeHero img{ width:100%; height:100%; object-fit:cover; display:block; }
    .galBtn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.45);
      color:#fff;
      border-radius: 12px;
      padding: 6px 10px;
      cursor:pointer;
      user-select:none;
    }
    .galBtn.left{ left:8px; }
    .galBtn.right{ right:8px; }
    .dots{ display:flex; gap:6px; justify-content:center; margin-top:8px; }
    .dot{ width:7px; height:7px; border-radius:50%; background: rgba(255,255,255,.35); cursor:pointer; }
    .dot.active{ background:#fff; }

    .toast{
      position:fixed;
      left: 14px;
      bottom: 14px;
      z-index: 9999;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,24,.88);
      border-radius: 16px;
      padding: 10px 12px;
      color: rgba(255,255,255,.82);
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
      display:none;
      max-width: 560px;
    }
    .toast.show{ display:block; }

    /* Cost breakdown */
    .breakdown{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px;
    }
    .bdTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:950; letter-spacing:.12em; text-transform: uppercase; font-size:11px;
    }
    .bdGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .bdRow{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px;
    }
    .bdRow .k{ font-size:10px; letter-spacing:.14em; text-transform:uppercase; color:rgba(255,255,255,.72); }
    .bdRow .v{ margin-top:6px; font-size:13px; font-weight:950; }
    .bdSmall{
      margin-top:10px;
      font-size:11px;
      color: rgba(255,255,255,.74);
      line-height:1.45;
      letter-spacing:.02em;
      text-transform:none;
      white-space:pre-wrap;
    }

    /* hide debug */
    #priceDebug{ display:none !important; }

    /* =========================
       ✅ MOBILE FIX
       ========================= */
    @media (max-width: 1200px){
      html, body{
        height:auto !important;
        overflow:auto !important;
        overscroll-behavior:auto !important;
      }

      .app{
        min-height: 100vh !important;
        height:auto !important;
        grid-template-rows: auto 1fr !important;
      }

      .top{
        position: relative !important;
        padding: 10px 12px !important;
      }

      .logo{ width:44px; height:44px; border-radius:14px; }
      .brand{ min-width: unset !important; }
      .brand p{ font-size:11px; }

      .actions{
        min-width:unset !important;
        gap:8px !important;
      }
      .chip{
        padding:7px 10px !important;
        font-size:10px !important;
        letter-spacing:.06em !important;
      }

      .main{
        height:auto !important;
        overflow:visible !important;
        grid-template-columns: 1fr !important;
        grid-template-rows: auto auto auto !important;
        padding: 12px !important;
      }

      .pane{
        height:auto !important;
        min-height:unset !important;
      }

      .pkgLayout{ grid-template-columns: 1fr !important; }

      .districtBar{
        display:flex !important;
        flex-wrap:nowrap !important;
        gap:10px !important;
        border-right:none !important;
        border-bottom:1px solid rgba(255,255,255,.10) !important;
        overflow-x:auto !important;
        overflow-y:hidden !important;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 10px !important;
      }
      .distItem{ margin-bottom:0 !important; flex:0 0 auto !important; }

      .pkgList{
        overflow:auto !important;
        max-height: 56vh !important;
        -webkit-overflow-scrolling: touch;
      }

      .itWrap{
        overflow: visible !important;
        max-height: none !important;
      }

      #map{ height: 300px !important; }

      .mapTools{
        display:grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap:10px !important;
      }
      .toolBtn{ justify-content:center !important; }
    }

    @media (max-width: 420px){
      #map{ height: 280px !important; }
      .row2{ grid-template-columns: 1fr !important; }
      .bdGrid{ grid-template-columns: 1fr !important; }
      .pkgList{ max-height: 52vh !important; }
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="noise"></div>

  <div class="app">
    <div class="top">
      <div class="brand">
        <div class="logo">
          <img src="logo.png" alt="Himachal Explorer Logo" onerror="this.remove(); this.parentNode.textContent='HP';">
        </div>
        <div>
          <div style="margin:0;font-size:14px;letter-spacing:.18em;text-transform:uppercase;font-weight:900;">Himachal Explorer Portal</div>
          <p id="statusLine">Loading…</p>
        </div>
      </div>

      <div class="actions">
        <div class="chip" id="openCalcBtn">Calculator</div>
        <div class="chip" id="fitMapBtn">Fit Route</div>
        <div class="chip" id="clearRouteBtn">Clear</div>
        <div class="chip" id="refreshBtn">Refresh</div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Package Finder</p>
            <div class="s">Templates: <b>/templates</b> • Places: <b>/places_in_packages</b></div>
          </div>
          <div class="s" id="pkgCount">—</div>
        </div>

        <div class="filters">
          <div class="field">
            <label>Start</label>
            <input id="startInp" list="startList" placeholder="E.g. AMRITSAR / DELHI / CHANDIGARH" autocomplete="off">
            <datalist id="startList"></datalist>
          </div>

          <div class="field">
            <label>Visit Type</label>
            <select id="visitType">
              <option value="budget">BUDGET</option>
              <option value="premium">PREMIUM</option>
              <option value="luxury">LUXURY</option>
            </select>
          </div>

          <div class="field">
            <label>Days (Optional)</label>
            <select id="daysSel">
              <option value="">ANY</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              <option>11</option><option>12</option>
            </select>
          </div>

          <div class="field">
            <label>Pax</label>
            <select id="paxSel">
              <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
              <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
            </select>
          </div>

          <div class="btnRow">
            <button class="btn secondary" id="resetBtn" type="button">Reset</button>
            <button class="btn" id="genBtn" type="button">Generate</button>
          </div>
        </div>

        <div class="metaPills" id="pills"></div>

        <div class="pkgLayout">
          <div class="districtBar" id="districtBar"></div>
          <div class="pkgList" id="pkgList">
            <div class="pill pillHint"><span>Type Start & click</span> <b>Generate</b></div>
          </div>
        </div>
      </div>

      <!-- MID -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Live Route Map</p>
            <div class="s">OSRM road polyline + markers (no popups)</div>
          </div>
          <div class="s" id="kmBadge">—</div>
        </div>

        <div id="map"></div>

        <div class="mapTools">
          <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
          <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
          <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
          <div class="toolBtn" id="toggleBreakdownBtn">Cost Breakdown</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Itinerary</p>
            <div class="s">Place popup shown here (Location tab)</div>
          </div>
          <div class="s" id="activePkgName">—</div>
        </div>

        <div class="itWrap">
          <div class="heroCard">
            <h3 class="bigTitle" id="itTitle">Select a package</h3>
            <div class="muted" id="itMeta">Day-wise details will appear here</div>
            <div class="muted" id="priceDebug" style="margin-top:8px; text-transform:none; white-space:pre-wrap;"></div>

            <div class="tabs">
              <div class="tabBtn active" id="tabItinBtn">Itinerary</div>
              <div class="tabBtn" id="tabLocBtn">Location</div>
              <div class="tabBtn" id="tabHomeBtn">Home</div>
            </div>
          </div>

          <div class="row2">
            <div class="mini">
              <div class="k">Total (est.)</div>
              <div class="v" id="priceTotal">— <small></small></div>
            </div>
            <div class="mini">
              <div class="k">Per Person</div>
              <div class="v" id="pricePer">— <small></small></div>
            </div>
          </div>

          <div class="mini">
            <div class="k">Pax used in price</div>
            <div class="v" id="paxUsed">— <small></small></div>
          </div>

          <div class="breakdown" id="breakdownCard" style="display:none;">
            <div class="bdTitle">
              <div>Cost Breakdown</div>
              <div class="muted" id="bdMeta" style="text-transform:none;letter-spacing:.02em;">—</div>
            </div>
            <div class="bdGrid">
              <div class="bdRow">
                <div class="k">Transport</div>
                <div class="v" id="bdTransport">—</div>
              </div>
              <div class="bdRow">
                <div class="k">Hotel</div>
                <div class="v" id="bdHotel">—</div>
              </div>
              <div class="bdRow">
                <div class="k">Route KM (used)</div>
                <div class="v" id="bdKm">—</div>
              </div>
              <div class="bdRow">
                <div class="k">Rooms / Nights</div>
                <div class="v" id="bdRoomsNights">—</div>
              </div>
            </div>
            <div class="bdSmall" id="bdText">—</div>
          </div>

          <div class="heroCard">
            <div class="muted" style="margin-bottom:8px;">Package includes / excludes</div>
            <div class="muted" id="incExc">—</div>
          </div>

          <div class="tabPanel active" id="itinPanel">
            <div class="daysList" id="daysList"></div>
          </div>

          <div class="tabPanel" id="locPanel">
            <div class="placeDetail" id="placeDetail">
              <div class="muted">Tap any place from itinerary to see History + What you can find + Photos here.</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  /* ===============================
     ✅ Firebase Config
     =============================== */
  const firebaseConfig = {
    apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
    authDomain: "revnue-records.firebaseapp.com",
    databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "revnue-records",
    storageBucket: "revnue-records.firebasestorage.app",
    messagingSenderId: "182348503564",
    appId: "1:182348503564:web:480085405b09177245ac29",
    measurementId: "G-MGTDBCG896"
  };

  const NODE_TEMPLATES = "templates";
  const NODE_PLACES    = "places_in_packages";
  const NODE_TRANSPORT = "pricing_transport";
  const NODE_HOTEL     = "rate_hotel";
  const NODE_STAYRULES = "stay_rate_rules";

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = String(msg||"");
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2200);
  }
  function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function normCaps(x){ return String(x||"").trim().toUpperCase().replace(/\s+/g," "); }
  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).slice(0,2);
    const ini = parts.map(x=>x[0]).join("").toUpperCase();
    return ini || "HP";
  }
  function rupees(n){ return "₹" + Math.round(Number(n)||0).toLocaleString("en-IN"); }
  function slugifyName(name){
    return String(name||"")
      .trim().toLowerCase()
      .replace(/&/g," and ")
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }
  function setStatus(msg){ $("statusLine").textContent = msg; }

  /* ===============================
     ✅ Place mapping
     =============================== */
  function placeIdAny(p, key){ return String(p?.place_id || p?.id || key || "").trim(); }
  function placeNameAny(p, key){
    return String(p?.name || p?.["Location Name"] || p?.title || key || "PLACE").trim();
  }
  function latAny(p){ return Number(p?.latitude ?? p?.lat ?? p?.Latitude); }
  function lngAny(p){ return Number(p?.longitude ?? p?.lng ?? p?.Longitude); }
  function districtAny(p){ return String(p?.district || p?.District || "").trim().toUpperCase(); }

  function toBullets(val){
    if(!val) return [];
    if(Array.isArray(val)) return val.filter(Boolean).slice(0,12);
    return String(val)
      .split(/\n|\||,/g)
      .map(x=>x.trim())
      .filter(Boolean)
      .slice(0,12);
  }

  function pickAllPhotos(p){
    const isValid = (u)=> typeof u==="string" && /^https?:\/\//i.test(u.trim());
    let arr = [];
    if(isValid(p?.imageUrl)) arr.push(p.imageUrl.trim());
    if(isValid(p?.image)) arr.push(p.image.trim());
    if(isValid(p?.img)) arr.push(p.img.trim());

    if(Array.isArray(p?.images)){
      arr.push(...p.images.filter(isValid).map(x=>x.trim()));
    }else if(p?.images && typeof p.images === "object"){
      arr.push(...Object.values(p.images).filter(isValid).map(x=>x.trim()));
    }
    return [...new Set(arr)];
  }
  function pickPhotoAny(p){ return pickAllPhotos(p)[0] || ""; }

  /* ===============================
     ✅ Tabs
     =============================== */
  function setActiveTab(which){
    const itinBtn = $("tabItinBtn");
    const locBtn  = $("tabLocBtn");
    const itinP   = $("itinPanel");
    const locP    = $("locPanel");
    if(which === "loc"){
      itinBtn.classList.remove("active");
      locBtn.classList.add("active");
      itinP.classList.remove("active");
      locP.classList.add("active");
    }else{
      locBtn.classList.remove("active");
      itinBtn.classList.add("active");
      locP.classList.remove("active");
      itinP.classList.add("active");
    }
  }

  /* ===============================
     ✅ Place Details
     =============================== */
  let ACTIVE_PLACE_GALLERY = { pid:"", idx:0, imgs:[] };

  function renderPlaceDetails(pid){
    const p = PLACES[pid] || {};
    const name = placeNameAny(p, pid);
    const dist = districtAny(p) || "";
    const hist = String(p.history_tagline || p.history || "").trim();
    const bullets = toBullets(p.what_you_find || p.whatYouFind);
    const imgs = pickAllPhotos(p);

    ACTIVE_PLACE_GALLERY = { pid, idx:0, imgs };

    const hero = imgs.length ? `
      <div class="placeHero">
        <img id="placeHeroImg" src="${escapeHtml(imgs[0])}" alt="${escapeHtml(name)}" loading="lazy" referrerpolicy="no-referrer"
             onerror="this.remove();">
        ${imgs.length>1 ? `
          <div class="galBtn left" id="galPrev">‹</div>
          <div class="galBtn right" id="galNext">›</div>
        `:""}
      </div>
      ${imgs.length>1 ? `
        <div class="dots" id="galDots">
          ${imgs.map((_,i)=>`<div class="dot ${i===0?'active':''}" data-i="${i}"></div>`).join("")}
        </div>
      `:""}
    ` : `
      <div class="placeHero" style="display:grid;place-items:center;">
        <div class="muted">No photo available</div>
      </div>
    `;

    $("placeDetail").innerHTML = `
      ${hero}
      <div style="margin-top:10px;">
        <div style="font-weight:950; font-size:14px;">${escapeHtml(name)}</div>
        ${dist ? `<div style="opacity:.8; font-size:12px; margin-top:2px;">${escapeHtml(dist)}</div>` : ``}
      </div>

      ${hist ? `
        <div style="margin-top:12px; font-weight:950; letter-spacing:.10em; text-transform:uppercase; font-size:11px; opacity:.95;">History</div>
        <div style="margin-top:6px; font-size:12px; opacity:.9; line-height:1.5;">${escapeHtml(hist)}</div>
      ` : ``}

      ${bullets.length ? `
        <div style="margin-top:12px; font-weight:950; letter-spacing:.10em; text-transform:uppercase; font-size:11px; opacity:.95;">What you can find</div>
        <ul style="margin:8px 0 0 18px; padding:0;">
          ${bullets.map(b=>`<li style="margin:5px 0; font-size:12px; opacity:.92;">${escapeHtml(b)}</li>`).join("")}
        </ul>
      ` : ``}
    `;

    if(imgs.length > 1){
      $("galPrev").onclick = ()=>galleryStep(-1);
      $("galNext").onclick = ()=>galleryStep(1);
      $("galDots").querySelectorAll(".dot").forEach(dot=>{
        dot.onclick = ()=>{
          const i = Number(dot.dataset.i || 0);
          galleryGo(i);
        };
      });
    }

    setActiveTab("loc");
  }

  function galleryGo(i){
    const g = ACTIVE_PLACE_GALLERY;
    if(!g.imgs.length) return;
    g.idx = (i + g.imgs.length) % g.imgs.length;
    const img = $("placeHeroImg");
    if(img) img.src = g.imgs[g.idx];

    const dots = $("galDots");
    if(dots){
      dots.querySelectorAll(".dot").forEach((d,ix)=>d.classList.toggle("active", ix===g.idx));
    }
  }
  function galleryStep(delta){
    const g = ACTIVE_PLACE_GALLERY;
    galleryGo(g.idx + delta);
  }

  /* ===============================
     ✅ Map
     =============================== */
  let map, tile, markersLayer, routeLine;
  let showMode = "all";
  let tilesDark = false;

  function initMap(){
    map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
    tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    tile.addTo(map);
    markersLayer = L.layerGroup().addTo(map);
  }
  function clearMap(){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    $("kmBadge").textContent = "—";
  }
  function fitRoute(){
    if(routeLine) map.fitBounds(routeLine.getBounds(), { padding:[22,22] });
  }

  /* ===============================
     ✅ Data
     =============================== */
  let db, storage, analytics;

  let PLACES = {};
  let TEMPLATES = {};
  let ACTIVE_TEMPLATES = [];
  let NAME_TO_ID = new Map();
  let STARTS = [];

  // District view (interstate)
  let INTER_BY_DISTRICT = {};

  // ✅ Local packages (computed) grouped by route_id (location code)
  let LOCAL_BY_CODE = {};
  let LOCAL_CODES = [];
  let ACTIVE_DISTRICT = "";
  let CURRENT_TEMPLATE_KEY = "";
  let CURRENT_ROUTE_KM = 0;

  let pricing_transport = {};
  let rate_hotel = {};
  let stay_rate_rules = {};
  let PRICING_READY = false;

  /* ===============================
     ✅ Cache
     =============================== */
  const CACHE_KEY = "hp_portal_cache_v13_localcode";
  const CACHE_TTL_MS = 1000 * 60 * 30;

  function loadCache(){
    try{
      const raw = localStorage.getItem(CACHE_KEY);
      if(!raw) return false;
      const parsed = JSON.parse(raw);
      if(!parsed?.ts) return false;
      if(Date.now() - parsed.ts > CACHE_TTL_MS) return false;

      PLACES = parsed.places || {};
      TEMPLATES = parsed.templates || {};
      pricing_transport = parsed.pricing_transport || {};
      rate_hotel = parsed.rate_hotel || {};
      stay_rate_rules = parsed.stay_rate_rules || {};
      PRICING_READY = true;

      ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
        .map(([key,obj])=>({key, ...(obj||{})}))
        .filter(t=>{
          const st = safeLower(t.status || "active");
          return st==="active" || st==="enabled" || st==="true";
        });

      buildNameIndex();
      buildStartList(ACTIVE_TEMPLATES);
      rebuildLocalIndex($("daysSel")?.value?.trim() || "");

      setStatus(`Loaded from cache • ${ACTIVE_TEMPLATES.length} templates • ${Object.keys(PLACES).length} places`);
      return true;
    }catch(e){
      return false;
    }
  }
  function saveCache(){
    try{
      localStorage.setItem(CACHE_KEY, JSON.stringify({
        ts: Date.now(),
        places: PLACES,
        templates: TEMPLATES,
        pricing_transport,
        rate_hotel,
        stay_rate_rules
      }));
    }catch(e){}
  }

  function buildNameIndex(){
    NAME_TO_ID = new Map();
    for(const [key, p] of Object.entries(PLACES||{})){
      const id = placeIdAny(p, key);
      const nm = placeNameAny(p, id);
      if(id) NAME_TO_ID.set(String(id).toLowerCase(), id);
      if(nm) NAME_TO_ID.set(String(nm).toLowerCase(), id);
    }
  }

  function buildStartList(templates){
    const set = new Set();
    templates.forEach(t=>{
      const s = String(t.start_point || t.start || "").trim();
      if(s) set.add(s);
    });
    STARTS = Array.from(set).sort((a,b)=>a.localeCompare(b));
    const dl = $("startList");
    dl.innerHTML = "";
    STARTS.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = String(s).toUpperCase();
      dl.appendChild(opt);
    });
  }

  function normalizeStartInput(){
    const typed = String($("startInp").value || "").trim().toUpperCase();
    if(!typed) return "";
    const exact = STARTS.find(s => String(s).trim().toUpperCase() === typed);
    if(exact) return exact;
    const partial = STARTS.find(s => String(s).trim().toUpperCase().startsWith(typed));
    if(partial) return partial;
    return "";
  }

  function getPlaceIdByNameAny(name){
    const nm = String(name || "").trim();
    if(!nm) return "";
    const direct = NAME_TO_ID.get(nm.toLowerCase());
    if(direct && PLACES[direct]) return direct;
    const slug = slugifyName(nm);
    if(slug && PLACES[slug]) return slug;
    return "";
  }

  function stopsFromTemplate(tpl){
    const days = Number(tpl.days || 1);
    const out = [];
    const seen = new Set();

    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      if(!raw) continue;
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
        if(seen.has(pid)) return;
        seen.add(pid);
        out.push(pid);
      });
    }

    if(!out.length){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>out.push(pid));
    }
    return out;
  }

  function routeIdsFromTemplateIncludingStart(tpl){
    const baseStops = stopsFromTemplate(tpl);
    const startName = String(tpl?.start_point || tpl?.start || "").trim();
    const startPid = getPlaceIdByNameAny(startName);
    if(startPid){
      const filtered = baseStops.filter(x => x !== startPid);
      return [startPid, ...filtered];
    }
    return baseStops;
  }

  function getEndNameFromRoutePath(tpl){
    const start = String(tpl.start_point || tpl.start || "").trim().toLowerCase();
    const rpRaw = String(tpl.route_path || "").trim();
    if(!rpRaw) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";

    const tokens = rpRaw
      .replace(/->/g,"|").replace(/>/g,"|")
      .split("|")
      .map(x=>String(x||"").trim())
      .filter(Boolean);

    if(!tokens.length) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";

    let end = tokens[tokens.length - 1];
    if(end && start && end.toLowerCase() === start && tokens.length >= 2){
      end = tokens[tokens.length - 2];
    }
    return end || "UNKNOWN";
  }

  function endDistrictFromTemplate(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const pid = getPlaceIdByNameAny(endName);
    if(pid && PLACES[pid]){
      const d = districtAny(PLACES[pid]);
      if(d) return d;
    }
    const td = String(tpl.district || tpl.end_district || "").trim().toUpperCase();
    if(td) return td;
    return normCaps(endName || "UNKNOWN");
  }

  function endKeyFromRoutePath(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const pid = getPlaceIdByNameAny(endName);
    if(pid && PLACES[pid]){
      const d = districtAny(PLACES[pid]);
      return d || normCaps(endName);
    }
    return normCaps(endName);
  }

  function packageScore(tpl){
    const locs = stopsFromTemplate(tpl).length;
    const pri  = Number(tpl.priority ?? 999);
    const km   = Number(tpl.total_km_est ?? tpl.estimated_drive_km ?? tpl.total_km ?? 1e9);
    return { locs, pri, km };
  }
  function pickBestOne(list){
    if(!list || !list.length) return null;
    const arr = [...list];
    arr.sort((a,b)=>{
      const A = packageScore(a), B = packageScore(b);
      if(A.locs !== B.locs) return B.locs - A.locs;
      if(A.pri !== B.pri) return A.pri - B.pri;
      return A.km - B.km;
    });
    return arr[0];
  }

  /* ===============================
     ✅ NEW LOCAL RULE (Computed)
     - region_style = local OR
     - route_id ends with -LCL OR
     - package_id contains -local
     AND days <= 3
     =============================== */
  function isLocalComputed(tpl){
    const routeId = String(tpl.route_id || "").toUpperCase().trim();
    const regionStyle = String(tpl.region_style || "").toLowerCase().trim();
    const pkgId = String(tpl.package_id || tpl.key || "").toLowerCase();
    return regionStyle === "local" || routeId.endsWith("-LCL") || pkgId.includes("-local");
  }
  function isLocalComputedMax3(tpl){
    const d = Number(tpl.days || 0);
    return isLocalComputed(tpl) && d > 0 && d <= 3;
  }

  function matchesStart(tpl, startUpper){
    return String(tpl.start_point||tpl.start||"").trim().toUpperCase() === startUpper;
  }
  function matchesDaysOptional(tpl, daysFilter){
    if(!daysFilter) return true;
    return Number(tpl.days||0) === Number(daysFilter);
  }

  // ✅ Local grouped by location code (route_id)
  function rebuildLocalIndex(daysFilter=""){
    LOCAL_BY_CODE = {};
    ACTIVE_TEMPLATES.forEach(t=>{
      if(!matchesDaysOptional(t, daysFilter)) return;
      if(!isLocalComputedMax3(t)) return;

      const code = String(t.route_id || "").trim();
      const key = code ? code.toUpperCase() : "LOCAL";
      (LOCAL_BY_CODE[key] ||= []).push(t);
    });

    LOCAL_CODES = Object.keys(LOCAL_BY_CODE).sort((a,b)=>a.localeCompare(b));
  }

  /* ===============================
     ✅ LEFT BAR (districts from interstate packages)
     =============================== */
  let DISTRICT_KEYS = [];
  function rebuildDistrictKeysFromInter(){
    const allDistricts = new Set();
    Object.keys(INTER_BY_DISTRICT || {}).forEach(d=>allDistricts.add(d));
    DISTRICT_KEYS = Array.from(allDistricts).sort((a,b)=>a.localeCompare(b));
    if(!ACTIVE_DISTRICT || !DISTRICT_KEYS.includes(ACTIVE_DISTRICT)){
      ACTIVE_DISTRICT = DISTRICT_KEYS[0] || "";
    }
  }

  function renderDistrictBar(){
    const bar = $("districtBar");
    if(!DISTRICT_KEYS.length){
      bar.innerHTML = `<div class="pill"><b>No district</b></div>`;
      ACTIVE_DISTRICT = "";
      return;
    }

    let html = "";
    for(const d of DISTRICT_KEYS){
      const interCount = (INTER_BY_DISTRICT[d] || []).length;
      html += `
        <div class="distItem ${ACTIVE_DISTRICT===d ? "active":""}" data-d="${escapeHtml(d)}">
          <b>${escapeHtml(d)}</b> (${interCount})
        </div>`;
    }
    bar.innerHTML = html;

    bar.querySelectorAll(".distItem").forEach(el=>{
      el.onclick = ()=>{
        ACTIVE_DISTRICT = el.dataset.d;
        bar.querySelectorAll(".distItem").forEach(x=>x.classList.remove("active"));
        el.classList.add("active");
        renderPackagesForActiveDistrict();
      };
    });
  }

  function highlightActiveCard(){
    document.querySelectorAll(".pkg").forEach(x=>x.classList.toggle("active", x.dataset.key === CURRENT_TEMPLATE_KEY));
  }

  function renderInterCard(t, startUpper, district){
    const days = Number(t.days||0) || 0;
    const endKey = endKeyFromRoutePath(t);

    const routeIds = routeIdsFromTemplateIncludingStart(t);
    let thumbUrl="", ini="HP";
    if(routeIds[0]){
      const p = PLACES[routeIds[0]] || {};
      const nm = placeNameAny(p, routeIds[0]);
      ini = initials(nm);
      thumbUrl = pickPhotoAny(p);
    }

    const el = document.createElement("div");
    el.className = "pkg";
    el.dataset.key = t.key;

    el.innerHTML = `
      <div class="pkgPic">
        ${thumbUrl
          ? `<img src="${escapeHtml(thumbUrl)}" alt="Package thumbnail" loading="lazy" referrerpolicy="no-referrer"
              onerror="this.remove(); this.parentNode.textContent='${escapeHtml(ini)}';">`
          : escapeHtml(ini)
        }
      </div>
      <div class="pkgBody">
        <div class="pkgName">${escapeHtml(startUpper)} → ${escapeHtml(district)} • ${days ? `${days}D` : ""}</div>
        <div class="pkgMeta">
          END: ${escapeHtml(String(endKey||"—").toUpperCase())} • ID: ${escapeHtml(String(t.key||"—").toUpperCase())}
        </div>
      </div>
    `;
    el.onclick = ()=>openTemplate(t.key, startUpper);
    return el;
  }

  // ✅ Local packages card heading = ROUTE_PATH (root/route)
  function renderLocalCard(t){
    const days = Number(t.days||0) || 0;
    const heading = String(t.route_path || t.route_name || t.package_id || t.key || "Local Package").trim();

    // thumbnail from first stop (or fallback)
    const routeIds = stopsFromTemplate(t);
    let thumbUrl="", ini="HP";
    let pickId = routeIds[0] || "";
    if(pickId){
      const p = PLACES[pickId] || {};
      const nm = placeNameAny(p, pickId);
      ini = initials(nm);
      thumbUrl = pickPhotoAny(p);
    }

    const el = document.createElement("div");
    el.className = "pkg";
    el.dataset.key = t.key;

    el.innerHTML = `
      <div class="pkgPic">
        ${thumbUrl
          ? `<img src="${escapeHtml(thumbUrl)}" alt="Local package thumbnail" loading="lazy" referrerpolicy="no-referrer"
              onerror="this.remove(); this.parentNode.textContent='${escapeHtml(ini)}';">`
          : escapeHtml(ini)
        }
      </div>
      <div class="pkgBody">
        <div class="pkgName">${escapeHtml(heading)} ${days ? `• ${days}D` : ""}</div>
        <div class="pkgMeta">CODE: ${escapeHtml(String((t.route_id||"LOCAL")).toUpperCase())} • ID: ${escapeHtml(String(t.key||"—").toUpperCase())}</div>
      </div>
    `;
    el.onclick = ()=>openTemplate(t.key, normalizeStartInput() || "");
    return el;
  }

  function renderPackagesForActiveDistrict(){
    const start = normalizeStartInput() || "";
    const startUpper = String(start).trim().toUpperCase();
    const district = ACTIVE_DISTRICT;

    const box = $("pkgList");
    box.innerHTML = "";

    const interBest = (district && INTER_BY_DISTRICT[district])
      ? pickBestOne(INTER_BY_DISTRICT[district] || [])
      : null;

    // ✅ Local computed packages (≤ 3 days) grouped by location code
    // If district selected, show ALL local codes (computed) — because requirement is "with respect to location code"
    // (This keeps interstate logic unchanged.)
    const localCodes = LOCAL_CODES || [];
    let localTotal = 0;
    localCodes.forEach(c => localTotal += (LOCAL_BY_CODE[c] || []).length);

    const totalShown = (interBest ? 1 : 0) + localTotal;
    $("pkgCount").textContent = `${totalShown} Results`;

    // Section 1: Start -> District (one best) (UNCHANGED)
    const hdr1 = document.createElement("div");
    hdr1.className = "pkgGroupHdr";
    hdr1.innerHTML = `
      <div class="h1">${escapeHtml(startUpper || "START")} → ${escapeHtml(district || "DISTRICT")}</div>
      <div class="h2">Showing 1 best package for selected start → district (unchanged)</div>
    `;
    box.appendChild(hdr1);

    if(!startUpper){
      const warn = document.createElement("div");
      warn.className = "pill";
      warn.innerHTML = `<b>Type Start</b> (top) then Generate`;
      box.appendChild(warn);
    }else if(!district){
      const none = document.createElement("div");
      none.className = "pill";
      none.innerHTML = `<b>Select a district</b>`;
      box.appendChild(none);
    }else if(!interBest){
      const none = document.createElement("div");
      none.className = "pill";
      none.innerHTML = `<b>No Start → District package found</b>`;
      box.appendChild(none);
    }else{
      box.appendChild(renderInterCard(interBest, startUpper, district));
    }

    // Section 2: Local packages (computed ≤ 3 days) grouped by LOCATION CODE (route_id)
    const hdr2 = document.createElement("div");
    hdr2.className = "pkgGroupHdr";
    hdr2.style.marginTop = "8px";
    hdr2.innerHTML = `
      <div class="h1">Local packages (≤ 3 Days) • Grouped by Location Code</div>
      <div class="h2">Heading = ROUTE PATH (root) • Codes from route_id</div>
    `;
    box.appendChild(hdr2);

    if(!localCodes.length){
      const none2 = document.createElement("div");
      none2.className = "pill";
      none2.innerHTML = `<b>No local packages found</b>`;
      box.appendChild(none2);
    }else{
      // Render groups
      localCodes.forEach(code=>{
        const list = (LOCAL_BY_CODE[code] || []).slice().sort((a,b)=>(Number(a.days)||0)-(Number(b.days)||0));
        if(!list.length) return;

        const gh = document.createElement("div");
        gh.className = "pkgGroupHdr";
        gh.style.marginTop = "6px";
        gh.innerHTML = `
          <div class="h1">${escapeHtml(code)}</div>
          <div class="h2">${list.length} package(s) • 1D / 2D / 3D</div>
        `;
        box.appendChild(gh);

        list.forEach(t=>{
          // avoid duplicate if same key as interBest
          if(interBest && t.key === interBest.key) return;
          box.appendChild(renderLocalCard(t));
        });
      });
    }

    highlightActiveCard();
  }

  /* ===============================
     ✅ Itinerary
     =============================== */
  function buildDayWise(tpl){
    const days = Number(tpl.days || 1);
    const blocks = [];
    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      blocks.push({ day:d, ids });
    }
    const anyHas = blocks.some(x=>x.ids.length);
    if(!anyHas){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      return [{ day:1, ids }];
    }
    return blocks.filter(x=>x.ids.length);
  }

  function renderItinerary(tpl, start, endKey){
    $("activePkgName").textContent = `${String(tpl.days||"—")}D`;

    // Local heading behavior: show route_path if local computed
    const isLocalNow = isLocalComputedMax3(tpl) || isLocalComputed(tpl);
    if(isLocalNow){
      const head = String(tpl.route_path || tpl.route_name || tpl.package_id || "LOCAL").trim();
      $("itTitle").textContent = head;
    }else{
      const titleStart = start ? String(start).toUpperCase() : "START";
      $("itTitle").textContent = `${titleStart} → ${String(endKey).toUpperCase()}`;
    }

    const metaParts = [];
    if(tpl.route_id) metaParts.push(`Code: ${tpl.route_id}`);
    if(tpl.route_path) metaParts.push(`Route: ${tpl.route_path}`);
    if(tpl.best_season) metaParts.push(`Season: ${tpl.best_season}`);
    if(tpl.ideal_for) metaParts.push(`Ideal: ${tpl.ideal_for}`);
    $("itMeta").textContent = metaParts.join(" • ") || "—";

    const inc = String(tpl.includes || tpl.inclusions || "").trim();
    const exc = String(tpl.excludes || tpl.exclusions || "").trim();
    const note = String(tpl.important_notes || tpl.notes || "").trim();
    $("incExc").innerHTML =
      `<b style="color:#fff;letter-spacing:.12em;">INCLUDES:</b> ${escapeHtml(inc || "—")}<br><br>` +
      `<b style="color:#fff;letter-spacing:.12em;">EXCLUDES:</b> ${escapeHtml(exc || "—")}<br><br>` +
      `<b style="color:#fff;letter-spacing:.12em;">NOTES:</b> ${escapeHtml(note || "—")}`;

    const daysList = $("daysList");
    daysList.innerHTML = "";

    $("placeDetail").innerHTML = `<div class="muted">Tap any place from itinerary to see History + What you can find + Photos here.</div>`;

    const blocks = buildDayWise(tpl);
    blocks.forEach(block=>{
      const dayCard = document.createElement("div");
      dayCard.className = "dayCard";
      dayCard.innerHTML = `
        <div class="dayTop">
          <div class="d">Day ${block.day}</div>
          <div class="muted">${block.ids.length} places</div>
        </div>
        <div class="muted">Places</div>
        <div class="dayPlaces"></div>
      `;
      const cont = dayCard.querySelector(".dayPlaces");

      block.ids.forEach(pid=>{
        const p = PLACES[pid] || {};
        const name = placeNameAny(p, pid);
        const dist = districtAny(p) || "—";
        const url = pickPhotoAny(p);

        const line = document.createElement("div");
        line.className = "placeLine";
        line.innerHTML = `
          <div class="thumb">
            ${url
              ? `<img src="${escapeHtml(url)}" alt="${escapeHtml(name)} photo" loading="lazy" referrerpolicy="no-referrer"
                    onerror="this.remove(); this.parentNode.textContent='${escapeHtml(initials(name))}';">`
              : escapeHtml(initials(name))
            }
          </div>
          <div class="pinfo">
            <div class="pname">${escapeHtml(name)}</div>
            <div class="pmeta">${escapeHtml(dist)}</div>
          </div>
        `;

        line.onclick = ()=>{
          renderPlaceDetails(pid);
          const lat = latAny(p), lng = lngAny(p);
          if(isFinite(lat) && isFinite(lng)){
            map.setView([lat,lng], Math.max(map.getZoom(), 12), { animate:true });
          }
        };

        cont.appendChild(line);
      });

      daysList.appendChild(dayCard);
    });
  }

  /* ===============================
     ✅ Route draw (OSRM)
     =============================== */
  async function drawRoadRouteFromPlaces(placeIds){
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }

    const pts = [];
    const validIds = [];
    for(const pid of placeIds){
      const p = PLACES[pid] || {};
      const lat = latAny(p);
      const lng = lngAny(p);
      if(isFinite(lat) && isFinite(lng)){
        pts.push([lng,lat]);
        validIds.push(pid);
      }
    }
    if(pts.length < 2){
      toast("Not enough coordinates for route");
      return { ok:false, km:0 };
    }

    const maxPts = 25;
    let used = pts;
    if(pts.length > maxPts){
      const step = Math.ceil(pts.length / maxPts);
      used = pts.filter((_,i)=> i%step===0 || i===pts.length-1);
    }

    try{
      const url =
        "https://router.project-osrm.org/route/v1/driving/" +
        used.map(c=>c.join(",")).join(";") +
        "?overview=full&geometries=geojson&steps=false";

      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes?.length){
        toast("Road route not available");
        return { ok:false, km:0 };
      }

      const r = data.routes[0];
      const latlngs = r.geometry.coordinates.map(c=>[c[1],c[0]]);
      routeLine = L.polyline(latlngs, { weight: 5, opacity: .95 }).addTo(map);
      fitRoute();

      const markIds = (showMode==="startend")
        ? [validIds[0], validIds[validIds.length-1]]
        : validIds;

      for(let i=0;i<markIds.length;i++){
        const pid = markIds[i];
        const p = PLACES[pid] || {};
        const lat = latAny(p);
        const lng = lngAny(p);
        if(!isFinite(lat)||!isFinite(lng)) continue;

        const mk = L.marker([lat,lng], { riseOnHover:true }).addTo(markersLayer);
        mk.on("click", ()=> renderPlaceDetails(pid));
      }

      const km = Number(r.distance/1000);
      $("kmBadge").textContent = km.toFixed(1) + " KM";
      return { ok:true, km };
    }catch(e){
      console.error(e);
      toast("Route error");
      return { ok:false, km:0 };
    }
  }

  /* ===============================
     ✅ Pricing (UNCHANGED)
     =============================== */
  function pickStayRule(tier){
    const t = String(tier||"budget").toLowerCase();
    const key = (t==="premium") ? "r2" : (t==="luxury") ? "r3" : "r1";
    return stay_rate_rules?.[key] || {};
  }
  function pickVehicleByPax(pax){
    pax = Number(pax||2);
    if(pax <= 4) return "hatchback";
    if(pax <= 7) return "innova";
    return "luxury_suv";
  }
  function autoSeason(tpl){
    const text = String(tpl?.best_season || "").toLowerCase();
    if(/monsoon|rain|jul|aug/.test(text)) return "low";
    if(/winter|snow|snowfall|dec|jan/.test(text)) return "peak";
    if(/peak/.test(text)) return "peak";
    if(/low/.test(text)) return "low";
    if(/mid/.test(text)) return "mid";
    const m = new Date().getMonth() + 1;
    if([1,5,6,10,12].includes(m)) return "peak";
    if([2,7,8].includes(m)) return "low";
    return "mid";
  }
  function pickBaseRoomBySeason(rule, season){
    const s = String(season||"mid").toLowerCase();
    if(s === "low")  return Number(rule.base_rate_low || rule.base_rate_mid || rule.base_rate_peak || 0);
    if(s === "peak") return Number(rule.base_rate_peak || rule.base_rate_mid || rule.base_rate_low || 0);
    return Number(rule.base_rate_mid || rule.base_rate_low || rule.base_rate_peak || 0);
  }
  function computeSnowMultiplier(tpl, vehicle){
    const sr = String(tpl?.snow_risk || "").toLowerCase();
    const base = Number(vehicle?.snow_multiplier || 1);
    if(!isFinite(base) || base <= 0) return 1;
    if(sr.includes("high")) return base;
    if(sr.includes("medium")) return 1 + (base - 1) * 0.5;
    return 1;
  }
  function computeRoadMultiplier(tpl, vehicle){
    const rt = String(tpl?.road_type || "").toLowerCase();
    const dl = String(tpl?.drive_level || "").toLowerCase();
    const bad = Number(vehicle?.bad_road_multiplier || 1);
    const hill = Number(vehicle?.hill_multiplier || 1);
    let m = 1;
    if(rt.includes("bad") || rt.includes("mix")) m *= (isFinite(bad) && bad>0 ? bad : 1);
    if(dl.includes("high") || rt.includes("hill")) m *= (isFinite(hill) && hill>0 ? hill : 1);
    return m;
  }

  function estimateTotalCost({ km=0, days=3, pax=2, tpl=null }){
    km = Number(km||0);
    days = Number(days||0);
    pax = Math.max(1, Number(pax||1));
    const nights = Math.max(0, days-1);

    if(!PRICING_READY || !isFinite(km) || km<=0 || !days){
      return { total:NaN, perPerson:NaN, debug:"Pricing not ready OR km/days missing", breakdown:null };
    }

    const tier   = String($("visitType")?.value || "budget").toLowerCase();
    const season = autoSeason(tpl);

    const vehicleKey = pickVehicleByPax(pax);
    const v = pricing_transport?.[vehicleKey] || {};

    const perKm = Number(v.per_km || 0);
    const driverPerDay = Number(v.driver_per_day || 0);
    const minKmPerDay = Number(v.min_km_per_day || 0);
    const nightCharge = Number(v.night_charge || 0);
    const tollPct = Number(v.parking_toll_buffer_pct || 0);

    const minBillKm = (isFinite(minKmPerDay) && minKmPerDay > 0) ? (days * minKmPerDay) : 0;
    const billedKm = Math.max(km, minBillKm);

    const roadMul = computeRoadMultiplier(tpl, v);
    const snowMul = computeSnowMultiplier(tpl, v);
    const bufferMul = 1 + (isFinite(tollPct) ? tollPct : 0) / 100;

    const transportKmCost = billedKm * perKm * roadMul * snowMul * bufferMul;
    const driverCost = days * driverPerDay;
    const nightCost = nights * nightCharge;

    const transport = transportKmCost + driverCost + nightCost;

    const rule = pickStayRule(tier);
    const baseRoom = pickBaseRoomBySeason(rule, season);
    const weekendMul = Number(rule.weekend_multiplier || 1);

    const rooms = Math.max(1, Math.ceil(pax / 2));
    const wkFactor = (nights >= 2) ? (isFinite(weekendMul) && weekendMul>0 ? weekendMul : 1) : 1;
    const hotel = nights * baseRoom * rooms * wkFactor;

    const total = transport + hotel;

    const breakdown = {
      tier, season, vehicleKey,
      routeKm: km,
      billedKm,
      perKm, driverPerDay, minKmPerDay, nightCharge, tollPct,
      roadMul, snowMul, bufferMul,
      nights, rooms, baseRoom, wkFactor,
      transportKmCost, driverCost, nightCost,
      transport, hotel, total
    };

    return { total, perPerson: total/pax, debug:"", breakdown };
  }

  function updateBreakdownUI(bd, pax){
    if(!bd){
      $("bdMeta").textContent = "—";
      $("bdTransport").textContent = "—";
      $("bdHotel").textContent = "—";
      $("bdKm").textContent = "—";
      $("bdRoomsNights").textContent = "—";
      $("bdText").textContent = "—";
      return;
    }

    $("bdMeta").textContent = `${String(bd.tier).toUpperCase()} • ${bd.season.toUpperCase()} • ${bd.vehicleKey}`;
    $("bdTransport").textContent = rupees(bd.transport);
    $("bdHotel").textContent = rupees(bd.hotel);
    $("bdKm").textContent = `${bd.routeKm.toFixed(1)} km (billed ${bd.billedKm.toFixed(1)})`;
    $("bdRoomsNights").textContent = `${bd.rooms} rooms / ${bd.nights} nights`;

    const lines =
      `PAX=${pax} DAYS=${bd.nights+1} NIGHTS=${bd.nights}\n` +
      `ROUTE_KM=${bd.routeKm.toFixed(1)}  MIN_KM/DAY=${bd.minKmPerDay || 0}  BILLED_KM=${bd.billedKm.toFixed(1)}\n\n` +
      `TRANSPORT:\n` +
      `  KM_COST = billedKm(${bd.billedKm.toFixed(1)}) * per_km(${bd.perKm}) * road(${bd.roadMul.toFixed(2)}) * snow(${bd.snowMul.toFixed(2)}) * buffer(${bd.bufferMul.toFixed(2)})\n` +
      `         = ${Math.round(bd.transportKmCost)}\n` +
      `  DRIVER  = days * driver/day = ${Math.round(bd.driverCost)}\n` +
      `  NIGHT   = nights * night_charge = ${Math.round(bd.nightCost)}\n` +
      `  TRANSPORT_TOTAL = ${Math.round(bd.transport)}\n\n` +
      `HOTEL:\n` +
      `  baseRoom(${bd.baseRoom}) * nights(${bd.nights}) * rooms(${bd.rooms}) * wkFactor(${bd.wkFactor.toFixed(2)})\n` +
      `  HOTEL_TOTAL = ${Math.round(bd.hotel)}\n\n` +
      `TOTAL = ${Math.round(bd.total)}  |  PER_PERSON = ${Math.round(bd.total/pax)}`;

    $("bdText").textContent = lines;
  }

  function updatePriceBoxes(total, perPerson){
    const totalEl = $("priceTotal");
    const perEl   = $("pricePer");

    if(!isFinite(total)){
      totalEl.innerHTML = "— <small></small>";
      perEl.innerHTML = "— <small></small>";
      $("paxUsed").innerHTML = "— <small></small>";
      updateBreakdownUI(null, 0);
      return;
    }

    totalEl.innerHTML = rupees(total) + ` <small>(${String($("visitType").value).toUpperCase()})</small>`;
    perEl.innerHTML = rupees(perPerson) + ` <small>per person</small>`;
  }

  function getSelectedPax(){
    const v = Number($("paxSel")?.value || 2);
    return (isFinite(v) && v > 0) ? v : 2;
  }

  function computePriceForCurrent(){
    try{
      if(!CURRENT_TEMPLATE_KEY) return;
      const tpl = TEMPLATES?.[CURRENT_TEMPLATE_KEY];
      if(!tpl) return;

      const pax = getSelectedPax();
      const days = Number(tpl.days || 3);

      let km = Number(CURRENT_ROUTE_KM || 0);
      if(!isFinite(km) || km <= 0){
        km = Number(tpl.total_km_est || tpl.estimated_drive_km || tpl.total_km || 0);
      }

      const est = estimateTotalCost({ km, days, pax, tpl });
      const total = est.total;
      const perPerson = isFinite(total) ? (total / pax) : NaN;

      $("paxUsed").innerHTML = `${pax} <small>selected</small>`;
      updatePriceBoxes(total, perPerson);
      updateBreakdownUI(est.breakdown, pax);
    }catch(e){
      console.error(e);
      $("paxUsed").innerHTML = "— <small></small>";
      updatePriceBoxes(NaN, NaN);
      updateBreakdownUI(null, 0);
    }
  }

  function toggleBreakdown(){
    const el = $("breakdownCard");
    const showing = el.style.display !== "none";
    el.style.display = showing ? "none" : "block";
  }

  /* ===============================
     ✅ Generate
     =============================== */
  function applyFilters(){
    const start = normalizeStartInput();
    const daysF = $("daysSel").value.trim();
    const pax   = getSelectedPax();
    const tier  = String($("visitType")?.value || "budget").toUpperCase();

    clearMap();
    $("activePkgName").textContent = "—";
    $("itTitle").textContent = "Select a package";
    $("itMeta").textContent = "Day-wise details will appear here";
    $("incExc").textContent = "—";
    $("daysList").innerHTML = "";
    $("placeDetail").innerHTML = `<div class="muted">Tap any place from itinerary to see History + What you can find + Photos here.</div>`;
    $("priceTotal").innerHTML = "— <small></small>";
    $("pricePer").innerHTML = "— <small></small>";
    $("paxUsed").innerHTML = "— <small></small>";
    $("breakdownCard").style.display = "none";
    CURRENT_TEMPLATE_KEY = "";
    CURRENT_ROUTE_KM = 0;
    setActiveTab("itin");

    if(!start){
      toast("Start not found in templates");
      return;
    }

    const startUpper = String(start).trim().toUpperCase();

    // Interstate list (UNCHANGED)
    const interList = ACTIVE_TEMPLATES
      .filter(t => matchesStart(t, startUpper))
      .filter(t => matchesDaysOptional(t, daysF))
      // IMPORTANT: keep only NON-local computed subset here, so district list is purely interstate
      .filter(t => !isLocalComputedMax3(t));

    INTER_BY_DISTRICT = {};
    interList.forEach(t=>{
      const d = endDistrictFromTemplate(t);
      (INTER_BY_DISTRICT[d] ||= []).push(t);
    });

    rebuildDistrictKeysFromInter();
    renderDistrictBar();

    // Local computed index (≤3 days) grouped by route_id
    rebuildLocalIndex(daysF);

    const interCount = interList.length;
    const localCount = Object.values(LOCAL_BY_CODE).reduce((a,arr)=>a + (arr?.length||0), 0);

    $("pills").innerHTML = "";
    const pillData = {
      START: startUpper,
      TYPE: tier,
      INTER_PACKAGES: interCount,
      LOCAL_PACKAGES: localCount,
      PAX: pax,
      DAYS: (daysF ? daysF : "ANY")
    };
    for(const [k,v] of Object.entries(pillData)){
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `${escapeHtml(k)} <b>${escapeHtml(String(v))}</b>`;
      $("pills").appendChild(div);
    }

    renderPackagesForActiveDistrict();

    toast("District shows interstate • Local shown by location code (route_id)");
  }

  async function openTemplate(key, start){
    const tpl = TEMPLATES[key];
    if(!tpl){ toast("Template not found"); return; }
    CURRENT_TEMPLATE_KEY = key;
    highlightActiveCard();

    const endKey = endKeyFromRoutePath(tpl);
    const routeIds = routeIdsFromTemplateIncludingStart(tpl);

    renderItinerary(tpl, start, endKey);

    const rr = await drawRoadRouteFromPlaces(routeIds);
    CURRENT_ROUTE_KM = rr.ok ? rr.km : 0;

    computePriceForCurrent();
  }

  /* ===============================
     ✅ Load Live
     =============================== */
  async function loadLive(){
    setStatus("Loading live from Firebase…");

    const [tplSnap, placesSnap, tranSnap, hotelSnap, staySnap] = await Promise.all([
      db.ref(NODE_TEMPLATES).once("value"),
      db.ref(NODE_PLACES).once("value"),
      db.ref(NODE_TRANSPORT).once("value").catch(()=>({ val:()=>({}) })),
      db.ref(NODE_HOTEL).once("value").catch(()=>({ val:()=>({}) })),
      db.ref(NODE_STAYRULES).once("value").catch(()=>({ val:()=>({}) }))
    ]);

    TEMPLATES = tplSnap.val() || {};
    const rawPlaces = placesSnap.val() || {};

    PLACES = {};
    for(const [k,v] of Object.entries(rawPlaces)){
      if(v && typeof v === "object"){
        const pid = placeIdAny(v, k) || k;
        PLACES[pid] = { ...v, place_id: pid };
      }
    }

    pricing_transport = (tranSnap && typeof tranSnap.val==="function") ? (tranSnap.val() || {}) : {};
    rate_hotel = (hotelSnap && typeof hotelSnap.val==="function") ? (hotelSnap.val() || {}) : {};
    stay_rate_rules = (staySnap && typeof staySnap.val==="function") ? (staySnap.val() || {}) : {};
    PRICING_READY = true;

    ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
      .map(([key, obj]) => ({ key, ...(obj||{}) }))
      .filter(t => {
        const st = safeLower(t.status || "active");
        return st === "active" || st === "enabled" || st === "true";
      });

    buildNameIndex();
    buildStartList(ACTIVE_TEMPLATES);
    rebuildLocalIndex($("daysSel")?.value?.trim() || "");

    saveCache();
    setStatus(`Loaded LIVE • ${ACTIVE_TEMPLATES.length} templates • ${Object.keys(PLACES).length} places • pricing OK`);
  }

  async function refreshAll(){
    try{
      await loadLive();
      toast("Refreshed from Firebase");
      if($("pills").children.length){
        applyFilters();
      }else{
        // before generate, show empty district bar
        $("districtBar").innerHTML = `<div class="pill"><b>Type Start → Generate</b></div>`;
      }
    }catch(err){
      console.error(err);
      setStatus("Firebase load error (check rules / node names)");
      toast("Firebase load error");
    }
  }

  /* ===============================
     ✅ Boot
     =============================== */
  window.addEventListener("DOMContentLoaded", () => {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    storage = firebase.storage();
    analytics = firebase.analytics();

    $("tabItinBtn").addEventListener("click", ()=>setActiveTab("itin"));
    $("tabLocBtn").addEventListener("click", ()=>setActiveTab("loc"));

    $("tabHomeBtn").addEventListener("click", ()=>{
      setActiveTab("itin");
      document.querySelector(".itWrap")?.scrollTo?.({ top: 0, behavior: "smooth" });
    });

    $("genBtn").addEventListener("click", applyFilters);
    $("startInp").addEventListener("keydown",(e)=>{ if(e.key==="Enter") applyFilters(); });

    $("resetBtn").addEventListener("click", ()=>{
      $("startInp").value="";
      $("visitType").value="budget";
      $("daysSel").value="";
      $("paxSel").value="2";
      $("pills").innerHTML="";
      $("pkgList").innerHTML = `<div class="pill pillHint"><span>Type Start & click</span> <b>Generate</b></div>`;
      $("districtBar").innerHTML = "";
      $("pkgCount").textContent="—";
      $("activePkgName").textContent="—";
      $("itTitle").textContent="Select a package";
      $("itMeta").textContent="Day-wise details will appear here";
      $("incExc").textContent="—";
      $("daysList").innerHTML="";
      $("placeDetail").innerHTML = `<div class="muted">Tap any place from itinerary to see History + What you can find + Photos here.</div>`;
      $("priceTotal").innerHTML="— <small></small>";
      $("pricePer").innerHTML="— <small></small>";
      $("paxUsed").innerHTML="— <small></small>";
      $("breakdownCard").style.display="none";
      clearMap();
      CURRENT_TEMPLATE_KEY = "";
      CURRENT_ROUTE_KM = 0;

      ACTIVE_DISTRICT="";
      INTER_BY_DISTRICT = {};
      LOCAL_BY_CODE = {};
      LOCAL_CODES = [];
      DISTRICT_KEYS = [];
      setActiveTab("itin");
      toast("Reset done");
    });

    $("fitMapBtn").addEventListener("click", fitRoute);
    $("clearRouteBtn").addEventListener("click", ()=>{ clearMap(); toast("Cleared"); });
    $("refreshBtn").addEventListener("click", refreshAll);

    $("openCalcBtn")?.addEventListener("click", ()=>{
      window.location.href = "calculator.html";
    });

    $("showAllStopsBtn").addEventListener("click", async ()=>{
      showMode="all";
      toast("Markers: all stops");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const routeIds = routeIdsFromTemplateIncludingStart(tpl);
        const rr = await drawRoadRouteFromPlaces(routeIds);
        CURRENT_ROUTE_KM = rr.ok ? rr.km : CURRENT_ROUTE_KM;
        computePriceForCurrent();
      }
    });

    $("showStartEndBtn").addEventListener("click", async ()=>{
      showMode="startend";
      toast("Markers: start/end");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const routeIds = routeIdsFromTemplateIncludingStart(tpl);
        const rr = await drawRoadRouteFromPlaces(routeIds);
        CURRENT_ROUTE_KM = rr.ok ? rr.km : CURRENT_ROUTE_KM;
        computePriceForCurrent();
      }
    });

    $("toggleTilesBtn").addEventListener("click", ()=>{
      tilesDark = !tilesDark;
      try{
        map.removeLayer(tile);
        tile = tilesDark
          ? L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 })
          : L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
        tile.addTo(map);
      }catch(e){}
      toast(tilesDark ? "Dark tiles on" : "Light tiles on");
    });

    $("toggleBreakdownBtn").addEventListener("click", toggleBreakdown);

    $("paxSel")?.addEventListener("change", ()=>{
      computePriceForCurrent();
      if($("pills").children.length) applyFilters();
    });

    $("visitType")?.addEventListener("change", ()=>{
      computePriceForCurrent();
      if($("pills").children.length) applyFilters();
    });

    $("daysSel")?.addEventListener("change", ()=>{
      // Local index depends on days filter
      rebuildLocalIndex($("daysSel").value.trim());
      if($("pills").children.length) applyFilters();
    });

    initMap();

    const hadCache = loadCache();
    if(hadCache) toast("Loaded fast from cache");
    refreshAll();
  });
  </script>
</body>
</html>