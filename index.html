<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Himachal Explorer — Smart Planner (Routes)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg0:#f6f8ff; --bg1:#ffffff;
      --card:rgba(255,255,255,.92);
      --stroke:rgba(20,30,60,.12);
      --text:#0b1220;
      --muted:rgba(11,18,32,.66);
      --shadow:0 18px 50px rgba(20,30,60,.10);
      --r:16px; --r2:22px;
      --ok:#12a36d; --warn:#b88400;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(94,130,255,.18), transparent 60%),
        radial-gradient(900px 600px at 90% 15%, rgba(28,196,134,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* ✅ Perfect layout: left 72%, map 28% */
    .app{
      height:100vh;
      display:grid;
      grid-template-columns: 72% 28%;
      gap:14px;
      padding:14px;
    }

    .panel{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .head{
      padding:14px 16px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      background: rgba(255,255,255,.7);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px}
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg, rgba(94,130,255,1), rgba(28,196,134,1));
      box-shadow: 0 0 0 4px rgba(94,130,255,.16);
    }
    .sub{margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      color: var(--muted);
      font-size:12px; white-space:nowrap;
    }

    .controls{
      padding:12px 16px;
      border-bottom:1px solid var(--stroke);
      display:grid;
      gap:10px;
      background: rgba(255,255,255,.55);
    }

    /* ✅ Now includes ROUTE dropdown */
    .row{
      display:grid;
      grid-template-columns: 1.4fr 1.1fr 1.4fr .8fr .8fr;
      gap:10px;
    }

    label{font-size:11.5px; color:var(--muted); display:block; margin-bottom:6px}
    select,input{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.88);
      border:1px solid var(--stroke);
      color:var(--text);
      outline:none;
      font-size: 13px;
    }
    .btnRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.9);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 13px;
      box-shadow: 0 10px 24px rgba(20,30,60,.07);
    }
    button:hover{background:#fff}
    .primary{
      background: linear-gradient(135deg, rgba(94,130,255,.20), rgba(28,196,134,.14));
      border-color: rgba(94,130,255,.28);
    }
    .hint{font-size:12px; color:var(--muted)}
    .ok{color:var(--ok); font-weight:800}
    .warn{color:var(--warn); font-weight:800}

    .content{
      padding: 12px 16px 16px;
      overflow:auto;
      min-height:0;
    }
    .sectionHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin: 6px 0 10px;
    }
    .sectionTitle{font-weight:900; letter-spacing:.2px; font-size:13px}
    .countPill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.75);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .tile{
      position:relative;
      border:1px solid var(--stroke);
      border-radius: 16px;
      overflow:hidden;
      min-height: 112px;
      cursor:pointer;
      background: rgba(255,255,255,.9);
      box-shadow: 0 10px 26px rgba(20,30,60,.08);
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .tile:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(20,30,60,.12);
      border-color: rgba(94,130,255,.28);
    }
    .bg{
      position:absolute; inset:0;
      background-size: cover;
      background-position: center;
      transform: scale(1.02);
    }
    .shade{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.42));
    }
    .info{
      position:absolute; left:10px; right:10px; bottom:10px;
      display:grid; gap:4px;
      color:#fff;
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .name{font-weight:900; font-size:12.8px; line-height:1.1}
    .meta{display:flex; gap:6px; flex-wrap:wrap; font-size:11px}
    .chip{
      display:inline-flex; align-items:center;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(0,0,0,.22);
      font-size:10.6px;
      color:rgba(255,255,255,.92);
    }

    .mapWrap{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .mapHead{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.75);
    }
    #map{flex:1; min-height: 300px;}
    .mapHint{font-size:12px; color:var(--muted)}

    .modalBack{
      position:fixed; inset:0;
      background: rgba(20,30,60,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 9999;
    }
    .modal{
      width:min(820px, 100%);
      background:#fff;
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      background: rgba(246,248,255,.9);
    }
    .modalHead h2{margin:0; font-size:15px}
    .close{
      border-radius:999px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background: #fff;
      cursor:pointer;
    }
    .modalBody{padding:12px 14px 14px}
    .box{
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding:10px 12px;
      background: rgba(246,248,255,.65);
      margin-top:10px;
    }
    .boxTitle{font-weight:900; font-size:12.8px; margin-bottom:6px}
    .boxText{color:rgba(11,18,32,.78); font-size:12.4px; line-height:1.45}

    @media (max-width: 1100px){ .grid{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr; height:auto}
      .mapWrap{height: 44vh}
      .row{grid-template-columns: 1fr 1fr}
      .grid{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 420px){ .grid{grid-template-columns: 1fr} }
  </style>
</head>

<body>
  <div class="app">

    <section class="panel">
      <div class="head">
        <div>
          <div class="brand"><span class="dot"></span> Himachal Explorer — Smart Planner</div>
          <div class="sub">
            Routes (R1/R2/R3) are available for all Start locations. End list depends on (Start + Route).
          </div>
        </div>
        <div class="pill" id="statusPill">Loading…</div>
      </div>

      <div class="controls">
        <div class="row">
          <div>
            <label>Start (Templates)</label>
            <select id="startSelect"></select>
          </div>

          <div>
            <label>Route (R1 / R2 / R3)</label>
            <select id="routeSelect"></select>
          </div>

          <div>
            <label>End (Filtered by Start + Route)</label>
            <select id="endSelect"></select>
          </div>

          <div>
            <label>No. of days</label>
            <input id="daysInput" type="number" min="1" max="15" value="4"/>
          </div>

          <div>
            <label>No. of persons</label>
            <input id="paxInput" type="number" min="1" max="50" value="4"/>
          </div>
        </div>

        <div class="btnRow">
          <button class="primary" id="planBtn">Plan Package</button>
          <button id="swapBtn">Swap Start/End</button>
          <span class="hint" id="planHint">—</span>
        </div>
      </div>

      <div class="content">
        <div class="sectionHead">
          <div class="sectionTitle">Places in Plan</div>
          <div class="countPill"><span class="ok" id="planCount">0</span> places</div>
        </div>
        <div class="grid" id="planGrid"></div>

        <div class="sectionHead" style="margin-top:16px">
          <div class="sectionTitle">Suggested Nearby Places</div>
          <div class="countPill"><span class="warn" id="sugCount">0</span> places</div>
        </div>
        <div class="grid" id="sugGrid"></div>
      </div>
    </section>

    <aside class="mapWrap">
      <div class="mapHead">
        <div class="sectionTitle">Map</div>
        <div class="mapHint">Plan + Suggestions markers</div>
      </div>
      <div id="map"></div>
    </aside>

  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h2 id="modalTitle">Place</h2>
          <div class="sub" id="modalSub" style="margin-top:4px"></div>
        </div>
        <button class="close" id="modalClose">Close</button>
      </div>
      <div class="modalBody">
        <div class="box">
          <div class="boxTitle">History / Tagline</div>
          <div class="boxText" id="modalHistory">—</div>
        </div>
        <div class="box">
          <div class="boxTitle">What you can find</div>
          <div class="boxText" id="modalFind">—</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    let PLACES = {};
    let TEMPLATES = {};
    let placeNameToId = new Map();
    let map, layerPlan, layerSug;

    const $ = s => document.querySelector(s);
    const esc = (s)=> String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const norm = (s)=> String(s||"").trim().toLowerCase();

    function haversineKm(aLat,aLng,bLat,bLng){
      const R=6371, toRad=d=>d*Math.PI/180;
      const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
      const s1=Math.sin(dLat/2)**2;
      const s2=Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1+s2));
    }

    function getImg(p){
      if(!p) return "";
      if(Array.isArray(p.images) && p.images.length) return String(p.images[0]||"");
      if(p.photo_1) return String(p.photo_1||"");
      return "";
    }
    function tileBgStyle(p){
      const img = getImg(p);
      if(img) return `background-image:url('${esc(img)}')`;
      return `background-image:linear-gradient(135deg, rgba(94,130,255,.22), rgba(28,196,134,.16))`;
    }
    function placeLine(p){
      const a = p?.district || "";
      const b = p?.region || "";
      const c = p?.segment || "";
      return `${a}${a && b ? " · " : ""}${b}${c ? " · " + c : ""}`.trim();
    }

    function splitIdsOrNames(s){
      return String(s||"").split(/[;,|]/g).map(x=>x.trim()).filter(Boolean);
    }
    function getMajorPlacesString(t){
      return t.major_place_ids ?? t.major_places ?? t.major_place ?? t.major_pla ?? t.major_pl ?? "";
    }
    function findPlaceIdByNameOrId(token){
      if(!token) return null;
      const t = token.trim();
      if(PLACES[t]) return t;
      return placeNameToId.get(norm(t)) || null;
    }

    /* ===== Map ===== */
    function initMap(){
      map = L.map("map", { zoomControl:true, scrollWheelZoom:false }).setView([31.7, 77.2], 7);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:18 }).addTo(map);
      layerPlan = L.layerGroup().addTo(map);
      layerSug  = L.layerGroup().addTo(map);
    }
    function drawMap(planIds, sugIds){
      layerPlan.clearLayers(); layerSug.clearLayers();
      const bounds = [];

      const iconPlan = L.divIcon({ html:`<div style="width:12px;height:12px;border-radius:999px;background:rgba(18,163,109,.95);border:1px solid rgba(255,255,255,.9);box-shadow:0 0 0 4px rgba(18,163,109,.18)"></div>`, className:"", iconSize:[12,12], iconAnchor:[6,6]});
      const iconSug  = L.divIcon({ html:`<div style="width:12px;height:12px;border-radius:999px;background:rgba(94,130,255,.95);border:1px solid rgba(255,255,255,.9);box-shadow:0 0 0 4px rgba(94,130,255,.18)"></div>`, className:"", iconSize:[12,12], iconAnchor:[6,6]});

      for(const id of planIds){
        const p = PLACES[id];
        if(!p?.latitude || !p?.longitude) continue;
        const lat=Number(p.latitude), lng=Number(p.longitude);
        bounds.push([lat,lng]);
        const m = L.marker([lat,lng], {icon:iconPlan}).addTo(layerPlan);
        m.bindPopup(`<b>${esc(p.name||id)}</b><br>${esc(placeLine(p))}`);
        m.on("click", ()=> openModal(id));
      }
      for(const id of sugIds){
        const p = PLACES[id];
        if(!p?.latitude || !p?.longitude) continue;
        const lat=Number(p.latitude), lng=Number(p.longitude);
        bounds.push([lat,lng]);
        const m = L.marker([lat,lng], {icon:iconSug}).addTo(layerSug);
        m.bindPopup(`<b>${esc(p.name||id)}</b><br>${esc(placeLine(p))}`);
        m.on("click", ()=> openModal(id));
      }
      if(bounds.length) map.fitBounds(bounds, { padding:[18,18] });
    }

    /* ===== Modal ===== */
    function openModal(placeId){
      const p = PLACES[placeId];
      if(!p) return;
      $("#modalTitle").textContent = p.name || placeId;
      $("#modalSub").textContent = placeLine(p);
      $("#modalHistory").textContent = p.history_tagline || "—";
      $("#modalFind").textContent = p.what_you_find || "—";
      $("#modalBack").style.display = "flex";
    }
    function closeModal(){ $("#modalBack").style.display = "none"; }

    /* ===== Dropdowns ===== */
    function buildStartDropdown(){
      const startSel = $("#startSelect");
      startSel.innerHTML = "";

      const starts = new Set();
      for(const [,t] of Object.entries(TEMPLATES)){
        const sp = (t?.start_point || t?.start || "").trim();
        if(sp) starts.add(sp);
      }
      const list = Array.from(starts).sort((a,b)=>a.localeCompare(b));
      for(const sp of list){
        const o = document.createElement("option");
        o.value = sp; o.textContent = sp;
        startSel.appendChild(o);
      }
    }

    function buildRouteDropdownForStart(startPoint){
      const routeSel = $("#routeSelect");
      routeSel.innerHTML = "";

      const routes = new Set();
      for(const [,t] of Object.entries(TEMPLATES)){
        const sp = (t?.start_point || "").trim();
        const rid = String(t?.route_id || "").trim(); // R1/R2/R3
        if(!sp || !rid) continue;
        if(norm(sp) !== norm(startPoint)) continue;
        routes.add(rid);
      }

      // fallback if some rows miss route_id: show R1/R2/R3 anyway
      const list = routes.size ? Array.from(routes).sort((a,b)=>a.localeCompare(b)) : ["R1","R2","R3"];
      for(const r of list){
        const o = document.createElement("option");
        o.value = r; o.textContent = r;
        routeSel.appendChild(o);
      }
      routeSel.value = list[0];
    }

    function buildEndDropdown(startPoint, routeId){
      const endSel = $("#endSelect");
      endSel.innerHTML = "";

      const ends = new Set();
      for(const [,t] of Object.entries(TEMPLATES)){
        const sp = (t?.start_point || "").trim();
        const ep = (t?.end_point || "").trim();
        const rid = String(t?.route_id || "").trim();

        if(!sp || !ep) continue;
        if(norm(sp) !== norm(startPoint)) continue;

        // if template has route_id, match it.
        // if route_id is missing in template row, we allow it (so your old data still works)
        if(rid && rid !== routeId) continue;

        ends.add(ep);
      }

      const list = Array.from(ends).sort((a,b)=>a.localeCompare(b));
      for(const ep of list){
        const o = document.createElement("option");
        o.value = ep; o.textContent = ep;
        endSel.appendChild(o);
      }
      if(list.length) endSel.value = list[0];
    }

    /* ===== Planning ===== */
    function chooseBestTemplate(startPoint, routeId, endPoint, days){
      const candidates = [];
      for(const [id,t] of Object.entries(TEMPLATES)){
        const sp = (t?.start_point || "").trim();
        const ep = (t?.end_point || "").trim();
        const rid = String(t?.route_id || "").trim();

        if(norm(sp) !== norm(startPoint) || norm(ep) !== norm(endPoint)) continue;

        // strict route match when route_id exists
        if(rid && rid !== routeId) continue;

        const td = Number(t?.days || 0) || 0;
        const diff = Math.abs(td - days);
        candidates.push({ id, t, diff, td });
      }
      candidates.sort((a,b)=> a.diff - b.diff || a.td - b.td);
      return candidates[0] || null;
    }

    function planFromTemplate(best, startPoint, endPoint){
      const t = best.t;
      const startId = findPlaceIdByNameOrId(startPoint);
      const endId   = findPlaceIdByNameOrId(endPoint);

      const majors = splitIdsOrNames(getMajorPlacesString(t))
        .map(tok => findPlaceIdByNameOrId(tok))
        .filter(Boolean);

      const combined = [];
      if(startId) combined.push(startId);
      for(const id of majors) combined.push(id);
      if(endId) combined.push(endId);

      const seen = new Set();
      return combined.filter(id => (seen.has(id) ? false : (seen.add(id), true)));
    }

    function computeSuggestions(planIds, limit=12){
      const planSet = new Set(planIds);
      const points = planIds.map(id => PLACES[id]).filter(p=>p?.latitude && p?.longitude)
        .map(p=>({lat:Number(p.latitude), lng:Number(p.longitude)}));

      if(!points.length) return [];

      const candidates = [];
      for(const [id,p] of Object.entries(PLACES)){
        if(planSet.has(id)) continue;
        if(!(p?.latitude && p?.longitude)) continue;

        let best = Infinity;
        for(const q of points){
          const d = haversineKm(Number(p.latitude), Number(p.longitude), q.lat, q.lng);
          if(d < best) best = d;
        }
        if(best <= 18) candidates.push({id, d:best});
      }
      candidates.sort((a,b)=>a.d-b.d);
      return candidates.slice(0, limit).map(x=>x.id);
    }

    function makeTile(placeId, badge){
      const p = PLACES[placeId];
      if(!p) return null;

      const el = document.createElement("div");
      el.className = "tile";
      el.innerHTML = `
        <div class="bg" style="${tileBgStyle(p)}"></div>
        <div class="shade"></div>
        <div class="info">
          <div class="name">${esc(p.name || placeId)}</div>
          <div class="meta">
            <span class="chip">${esc(p.segment || "Place")}</span>
            ${badge ? `<span class="chip">${esc(badge)}</span>` : ""}
          </div>
          <div class="meta">${esc(placeLine(p) || "")}</div>
        </div>
      `;
      el.addEventListener("click", ()=> openModal(placeId));
      return el;
    }

    function renderGrid(gridEl, ids, type){
      gridEl.innerHTML = "";
      if(!ids.length){
        gridEl.innerHTML = `<div class="hint">No ${type} found.</div>`;
        return;
      }
      ids.forEach((id, idx)=>{
        const badge = type === "plan"
          ? (idx===0 ? "Start" : (idx===ids.length-1 ? "End" : `Stop ${idx}`))
          : "Suggested";
        const tile = makeTile(id, badge);
        if(tile) gridEl.appendChild(tile);
      });
    }

    function runPlanner(){
      const startPoint = $("#startSelect").value;
      const routeId    = $("#routeSelect").value;
      const endPoint   = $("#endSelect").value;
      const days       = Math.max(1, Number($("#daysInput").value || 1));
      const pax        = Math.max(1, Number($("#paxInput").value || 1));

      const best = chooseBestTemplate(startPoint, routeId, endPoint, days);
      if(!best){
        $("#planHint").innerHTML = `<span class="warn">No template</span> for ${esc(startPoint)} → ${esc(endPoint)} · route <b>${esc(routeId)}</b>`;
        renderGrid($("#planGrid"), [], "plan");
        renderGrid($("#sugGrid"), [], "suggested");
        $("#planCount").textContent = "0";
        $("#sugCount").textContent = "0";
        drawMap([], []);
        return;
      }

      const planIds = planFromTemplate(best, startPoint, endPoint).filter(id=>PLACES[id]);
      const sugIds  = computeSuggestions(planIds, 12);

      $("#planCount").textContent = String(planIds.length);
      $("#sugCount").textContent  = String(sugIds.length);

      const td = Number(best.t?.days || 0) || "?";
      $("#planHint").innerHTML =
        `Template <span class="ok">${esc(best.id)}</span> · days <span class="ok">${td}</span> · route <span class="ok">${esc(routeId)}</span> · pax <span class="ok">${pax}</span>`;

      renderGrid($("#planGrid"), planIds, "plan");
      renderGrid($("#sugGrid"), sugIds, "suggested");
      drawMap(planIds, sugIds);
    }

    async function loadAll(){
      $("#statusPill").textContent = "Loading…";

      const [placesSnap, templatesSnap] = await Promise.all([
        get(ref(db, "places")),
        get(ref(db, "templates"))
      ]);

      PLACES = placesSnap.exists() ? (placesSnap.val() || {}) : {};
      TEMPLATES = templatesSnap.exists() ? (templatesSnap.val() || {}) : {};

      placeNameToId = new Map();
      for(const [id,p] of Object.entries(PLACES)){
        const name = (p?.name || "").trim();
        if(name) placeNameToId.set(norm(name), id);
        const pid = (p?.place_id || "").trim();
        if(pid) placeNameToId.set(norm(pid), id);
      }

      $("#statusPill").textContent = `Loaded · ${Object.keys(PLACES).length} places · ${Object.keys(TEMPLATES).length} templates`;

      initMap();
      buildStartDropdown();

      const startPoint = $("#startSelect").value;
      buildRouteDropdownForStart(startPoint);
      buildEndDropdown(startPoint, $("#routeSelect").value);

      setTimeout(runPlanner, 150);
    }

    /* Events */
    $("#startSelect").addEventListener("change", ()=>{
      const sp = $("#startSelect").value;
      buildRouteDropdownForStart(sp);
      buildEndDropdown(sp, $("#routeSelect").value);
      runPlanner();
    });

    $("#routeSelect").addEventListener("change", ()=>{
      buildEndDropdown($("#startSelect").value, $("#routeSelect").value);
      runPlanner();
    });

    $("#endSelect").addEventListener("change", runPlanner);
    $("#daysInput").addEventListener("change", runPlanner);
    $("#paxInput").addEventListener("change", runPlanner);
    $("#planBtn").addEventListener("click", runPlanner);

    $("#swapBtn").addEventListener("click", ()=>{
      // swapping is tricky with dependent route/end, so we do a safe swap only when end exists in start list
      const s = $("#startSelect").value;
      const e = $("#endSelect").value;
      const startOptions = Array.from($("#startSelect").options).map(o=>o.value);
      if(startOptions.includes(e)){
        $("#startSelect").value = e;
        buildRouteDropdownForStart(e);
        buildEndDropdown(e, $("#routeSelect").value);
      }
      runPlanner();
    });

    $("#modalClose").addEventListener("click", closeModal);
    $("#modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    loadAll().catch(err=>{
      console.error(err);
      $("#statusPill").textContent = "Load failed";
      $("#planHint").textContent = "Check Firebase rules (read) and nodes /places and /templates.";
    });
  </script>
</body>
</html>