<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer ‚Äî Light Tourism Theme</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      /* Chandigarh-tourism inspired light beige */
      --bg:#f6f0e6;
      --paper:#fffaf2;
      --card:#ffffff;
      --stroke:rgba(60,42,18,.18);
      --stroke2:rgba(60,42,18,.12);
      --text:#1f2328;
      --muted:rgba(31,35,40,.68);
      --accent:#7c6b4f;  /* khaki */
      --accent2:#2f5f88; /* calm blue */
      --accent3:#2f7a57; /* green */
      --shadow:0 18px 40px rgba(40,25,10,.14);
      --shadow2:0 10px 22px rgba(40,25,10,.10);
      --r:16px; --r2:22px;
      --max:1400px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(47,95,136,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 20%, rgba(47,122,87,.10), transparent 60%),
        linear-gradient(180deg, var(--bg), #fdf8ef);
    }
    a{text-decoration:none; color:inherit}
    .wrap{width:min(92vw, var(--max)); margin:0 auto; padding:0 14px 50px}

    /* TOP GOV BAR */
    .govbar{
      background:#fbf4e8;
      border-bottom:1px solid var(--stroke2);
      font-size:12px;
      color:rgba(31,35,40,.78);
    }
    .govbar .inner{
      width:min(92vw, var(--max));
      margin:0 auto;
      padding:8px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .govbar .right{display:flex; gap:12px; align-items:center}
    .govlink{opacity:.9}
    .govlink:hover{opacity:1; text-decoration:underline}

    /* NAVBAR */
    .navbar{
      background: rgba(255,250,242,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke2);
      position:sticky; top:0; z-index:50;
    }
    .navbar .inner{
      width:min(92vw, var(--max));
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{
      width:46px; height:46px;
      border-radius:14px;
      background:#fff url("./logo.png") center/contain no-repeat;
      border:1px solid var(--stroke2);
      box-shadow: var(--shadow2);
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px}
    .brand small{display:block; margin-top:2px; color:var(--muted); font-weight:700}

    .nav{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .nav a, .nav button{
      font-weight:850;
      font-size:12px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.70);
      padding:10px 12px;
      box-shadow: var(--shadow2);
      cursor:pointer;
    }
    .nav a:hover, .nav button:hover{transform: translateY(-1px)}
    .btnPrimary{
      background: linear-gradient(180deg, rgba(124,107,79,.95), rgba(124,107,79,.82)) !important;
      color:#fff !important;
      border-color: rgba(124,107,79,.35) !important;
    }

    /* HERO BANNER (full width like Chandigarh site) */
    .heroBanner{
      margin-top:16px;
      border-radius: 26px;
      overflow:hidden;
      border:1px solid var(--stroke2);
      box-shadow: var(--shadow);
      background: #000;
      position:relative;
      min-height: 420px;
    }
   .heroBanner::before{
  content:"";
  position:absolute; inset:0;
  background:
    linear-gradient(90deg, rgba(0,0,0,.72) 0%, rgba(0,0,0,.45) 45%, rgba(0,0,0,.25) 100%),
    url("./Kee_monastery.jpg") center/cover no-repeat;
  transform: scale(1.02);
  filter: saturate(1.05) contrast(1.05);
}
    .heroOverlay{
      position:relative;
      padding:28px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:stretch;
      min-height: 420px;
    }
    .heroText{
      color:#fff;
      max-width: 72ch;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:14px;
    }
    .heroText h2{
      margin:0;
      font-size: clamp(30px, 3.2vw, 56px);
      line-height:1.02;
      letter-spacing:-.6px;
    }
    .heroText p{
      margin:10px 0 0;
      color: rgba(255,255,255,.86);
      font-weight:700;
      line-height:1.5;
    }
    .heroBadges{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .hb{
      padding:9px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.20);
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(6px);
    }

    /* right box inside hero */
    .heroBox{
      background: rgba(255,250,242,.92);
      border:1px solid rgba(255,255,255,.20);
      border-radius: 22px;
      box-shadow: 0 14px 40px rgba(0,0,0,.24);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .heroBox h3{margin:0; font-size:13px}
    .heroBox small{color:rgba(31,35,40,.70); font-weight:800}

    .gridForm{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:11px; color:rgba(31,35,40,.72); font-weight:900; letter-spacing:.2px}
    .input,.select{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight:800;
      color:var(--text);
    }
    .input::placeholder{color:rgba(31,35,40,.45)}
    .gridForm .wide{grid-column:1/-1}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:4px}
    .btn{
      border:0;
      cursor:pointer;
      padding:11px 12px;
      border-radius:14px;
      font-weight:950;
      background: rgba(255,255,255,.92);
      border:1px solid var(--stroke2);
      box-shadow: var(--shadow2);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(47,95,136,.96), rgba(47,95,136,.84));
      color:#fff;
      border-color: rgba(47,95,136,.35);
    }

    /* SECTION TITLES */
    .section{margin-top:18px}
    .sectionHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin:18px 0 10px;
    }
    .sectionHead h3{margin:0; font-size:18px}
    .sectionHead p{margin:0; color:var(--muted); font-weight:800; font-size:12px}

    /* MUST DO TILES like Chandigarh */
    .tiles{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:12px;
    }
    .tile{
      border-radius: 18px;
      overflow:hidden;
      border:1px solid var(--stroke2);
      box-shadow: var(--shadow2);
      background:#fff;
      cursor:pointer;
      min-height: 110px;
      position:relative;
      transition:.18s ease;
    }
    .tile:hover{transform: translateY(-2px)}
    .tile::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.45));
      z-index:1;
    }
    .tile img{
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:cover;
      transform: scale(1.02);
    }
    .tile span{
      position:absolute;
      left:10px; right:10px; bottom:10px;
      z-index:2;
      background: rgba(255,250,242,.92);
      border:1px solid rgba(255,255,255,.35);
      border-radius: 999px;
      padding:9px 10px;
      font-weight:950;
      font-size:12px;
      text-align:center;
    }

    /* EXPLORE LIST */
    .exploreGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .panel{
      background: rgba(255,250,242,.92);
      border:1px solid var(--stroke2);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--stroke2);
      background: rgba(255,255,255,.55);
    }
    .panelHead b{font-size:13px}
    .panelHead small{color:var(--muted); font-weight:850}

    .list{
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      max-height: 560px;
      overflow:auto;
    }
    .place{
      background: rgba(255,255,255,.92);
      border:1px solid var(--stroke2);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      padding:12px;
      display:grid;
      grid-template-columns: 98px 1fr;
      gap:12px;
      cursor:pointer;
      transition:.16s ease;
    }
    .place:hover{transform: translateY(-1px)}
    .thumb{
      border-radius: 16px;
      overflow:hidden;
      border:1px solid var(--stroke2);
      background: #f2e9db;
      height:76px;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .pTitle{margin:0; font-weight:950; font-size:13px}
    .pSub{margin:6px 0 0; color:var(--muted); font-weight:750; font-size:12px; line-height:1.35}
    .badges{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    .badge{
      background: rgba(246,240,230,.90);
      border:1px solid var(--stroke2);
      border-radius: 999px;
      padding:6px 9px;
      font-weight:950;
      font-size:11px;
    }

    /* MAP hidden until click */
    .mapPanel{display:none}
    #map{
      width:100%;
      height: 460px;
    }

    /* Drawer */
    .drawerWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:80;
      backdrop-filter: blur(4px);
    }
    .drawer{
      width:min(980px, 100%);
      max-height: 86vh;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      border-radius: 26px;
      background: rgba(255,250,242,.96);
      border:1px solid var(--stroke2);
      box-shadow: 0 30px 90px rgba(0,0,0,.25);
    }
    .drawerTop{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke2);
      background: rgba(255,255,255,.55);
    }
    .closeX{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:950;
    }
    .drawerBody{
      padding:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      overflow:auto;
    }
    .gallery{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .gImg{
      border-radius: 18px;
      overflow:hidden;
      border:1px solid var(--stroke2);
      background:#f2e9db;
      aspect-ratio: 4/3;
    }
    .gImg img{width:100%; height:100%; object-fit:cover; display:block}
    .infoCard{
      border-radius: 22px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .infoCard p{margin:0; color:var(--muted); font-weight:750; line-height:1.45; font-size:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row .btn{flex:1}

    /* AI Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:90;
      backdrop-filter: blur(4px);
    }
    .modal{
      width:min(860px, 100%);
      border-radius: 26px;
      background: rgba(255,250,242,.96);
      border:1px solid var(--stroke2);
      box-shadow: 0 30px 90px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHead{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke2);
      background: rgba(255,255,255,.55);
    }
    .chat{
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
      max-height: 62vh;
      overflow:auto;
    }
    .msg{
      max-width: 86%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.90);
      font-weight:750;
      font-size:12.5px;
      line-height:1.45;
      white-space:pre-wrap;
    }
    .msg.me{
      margin-left:auto;
      background: linear-gradient(180deg, rgba(47,95,136,.16), rgba(47,95,136,.10));
    }
    .composer{
      padding:12px 14px 14px;
      display:flex; gap:10px;
      border-top:1px solid var(--stroke2);
      background: rgba(255,255,255,.45);
    }
    .composer input{
      flex:1;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.92);
      outline:none;
      font-weight:800;
    }

    @media (max-width: 1100px){
      .heroOverlay{grid-template-columns: 1fr; min-height:auto}
      .heroBanner{min-height:auto}
      .tiles{grid-template-columns: repeat(3, 1fr)}
      .drawerBody{grid-template-columns: 1fr}
      .gallery{grid-template-columns: repeat(2,1fr)}
    }
    @media (max-width: 560px){
      .tiles{grid-template-columns: repeat(2,1fr)}
      .gridForm{grid-template-columns: 1fr}
      .gallery{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
  <!-- Slim top bar (gov style) -->
  <div class="govbar">
    <div class="inner">
      <div>Welcome to Himachal Explorer</div>
      <div class="right">
        <a class="govlink" href="#explore">Skip to content</a>
        <span class="govlink">A-</span><span class="govlink">A</span><span class="govlink">A+</span>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <div class="navbar">
    <div class="inner">
      <div class="brand">
        <div class="logo" title="logo.png"></div>
        <div>
          <h1>Himachal Explorer</h1>
          <small>Explore ‚Ä¢ route ‚Ä¢ packages ‚Ä¢ AI planner</small>
        </div>
      </div>

      <div class="nav">
        <a href="#mustdo">Must Do</a>
        <a href="#explore">Explore</a>
        <button id="openAI">AI Planner</button>
        <button class="btnPrimary" id="openAdmin">Admin</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- HERO FULL WIDTH -->
    <section class="heroBanner" aria-label="hero">
      <div class="heroOverlay">
        <div class="heroText">
          <div>
            <h2>Discover Himachal ‚Äî beautifully, simply.</h2>
            <p>
              Use filters to show only what visitor needs. Click any place to open details, packages and map.
              <b>Map stays hidden until a location is clicked.</b>
            </p>

            <div class="heroBadges">
              <span class="hb">Light Tourism Theme</span>
              <span class="hb">Smart Filters</span>
              <span class="hb">Packages</span>
              <span class="hb">AI Planner</span>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap">
            <span style="font-weight:850; color:rgba(255,255,255,.88)">Tip: Tap a category tile to filter instantly.</span>
            <span id="status" style="font-weight:950; color:rgba(255,255,255,.88)">Loading places‚Ä¶</span>
          </div>
        </div>

        <!-- FILTER BOX -->
        <div class="heroBox">
          <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:10px">
            <div>
              <h3 style="margin:0">Search & Build Packages</h3>
              <small>3‚Äì4 options based on filters</small>
            </div>
            <small><b id="statPlaces">‚Äî</b> places</small>
          </div>

          <div class="gridForm">
            <div class="field wide">
              <label>Search (place / temple / lake / trek)</label>
              <input class="input" id="q" placeholder="Example: Triund, Manimahesh, Kufri, Chandratal‚Ä¶"/>
            </div>

            <div class="field">
              <label>District</label>
              <select class="select" id="district"><option value="all">All</option></select>
            </div>

            <div class="field">
              <label>Type</label>
              <select class="select" id="type">
                <option value="all">All</option>
                <option value="Destination">Destination</option>
                <option value="Temple">Temple</option>
                <option value="Lake">Lake</option>
                <option value="Trek">Trek</option>
                <option value="Hotel">Hotel</option>
                <option value="Activity">Activity</option>
              </select>
            </div>

            <div class="field">
              <label>Trip Days</label>
              <select class="select" id="days">
                <option value="0">Any</option>
                <option value="1">1‚Äì2 days</option>
                <option value="3">3‚Äì4 days</option>
                <option value="5">5‚Äì7 days</option>
                <option value="8">8‚Äì12 days</option>
              </select>
            </div>

            <div class="field">
              <label>People</label>
              <select class="select" id="people">
                <option value="solo">Solo</option>
                <option value="couple" selected>Couple</option>
                <option value="family">Family</option>
                <option value="group">Group</option>
              </select>
            </div>

            <div class="actions wide">
              <button class="btn primary" id="apply">Explore</button>
              <button class="btn" id="makePackages">Get Packages</button>
              <button class="btn" id="nearby">Nearby</button>
              <button class="btn" id="reset">Reset</button>
            </div>

            <div class="field wide">
              <label>Packages (3‚Äì4)</label>
              <div id="packagesBox" class="input" style="height:auto; min-height:78px; font-weight:750; line-height:1.45; white-space:pre-wrap">
                Click <b>Get Packages</b> to generate.
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- MUST DO TILES -->
    <section class="section" id="mustdo">
      <div class="sectionHead">
        <div>
          <h3>Must do activities in Himachal</h3>
          <p>Tap a tile to filter instantly</p>
        </div>
        <div>
          <span class="badge" id="activeFilters">No filters</span>
        </div>
      </div>

      <div class="tiles">
        <div class="tile" data-quick="Destination">
          <img src="./201-himalaya.jpg" alt="Destinations" onerror="this.remove()">
          <span>Destinations</span>
        </div>
        <div class="tile" data-quick="Temple">
          <img src="./n1.jpg" alt="Temples" onerror="this.remove()">
          <span>Temples</span>
        </div>
        <div class="tile" data-quick="Lake">
          <img src="./Travelers.jpg" alt="Lakes" onerror="this.remove()">
          <span>Lakes</span>
        </div>
        <div class="tile" data-quick="Trek">
          <img src="./Dark.jpg" alt="Treks" onerror="this.remove()">
          <span>Treks</span>
        </div>
        <div class="tile" data-quick="Hotel">
          <img src="./Kee_monastery.jpg" alt="Hotels" onerror="this.remove()">
          <span>Stay / Hotels</span>
        </div>
        <div class="tile" data-quick="Activity">
          <img src="./201-himalaya.jpg" alt="Activities" onerror="this.remove()">
          <span>Activities</span>
        </div>
      </div>
    </section>

    <!-- EXPLORE -->
    <section class="section" id="explore">
      <div class="sectionHead">
        <div>
          <h3>Explore places</h3>
          <p>List first. Map only after you click a place.</p>
        </div>
        <div class="badge" id="count">0</div>
      </div>

      <div class="exploreGrid">
        <div class="panel">
          <div class="panelHead">
            <b>Places</b>
            <small>click for details</small>
          </div>
          <div class="list" id="list"></div>
        </div>

        <div class="panel mapPanel" id="mapPanel">
          <div class="panelHead">
            <b>Map</b>
            <small id="mapHint">opens after click</small>
          </div>
          <div style="padding:14px">
            <div id="map"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- PLACE DRAWER -->
  <div class="drawerWrap" id="drawerWrap" role="dialog" aria-modal="true">
    <div class="drawer">
      <div class="drawerTop">
        <div>
          <h3 id="dTitle" style="margin:0">Place</h3>
          <small id="dSub" style="color:var(--muted); font-weight:850">‚Äî</small>
        </div>
        <button class="closeX" id="closeDrawer">‚úï</button>
      </div>

      <div class="drawerBody">
        <div class="gallery" id="gallery"></div>
        <div class="infoCard">
          <p id="dDesc">‚Äî</p>
          <div class="row" style="gap:8px">
            <span class="badge" id="dType">Type</span>
            <span class="badge" id="dDistrict">District</span>
            <span class="badge" id="dHow">How</span>
          </div>
          <div class="row">
            <button class="btn primary" id="routeBtn">Show Map</button>
            <button class="btn" id="pkgBtn">Packages</button>
            <button class="btn" id="fullBtn">Open Full Page</button>
          </div>
          <div class="infoCard" style="background:rgba(255,255,255,.92)">
            <p style="margin:0; font-weight:950; color:var(--text)">Suggested mini-plan</p>
            <p id="miniPlan" style="margin:0">‚Äî</p>
          </div>
          <div class="infoCard" style="background:rgba(255,255,255,.92)">
            <p style="margin:0; font-weight:950; color:var(--text)">Distance</p>
            <p id="distInfo" style="margin:0">Turn on Nearby to see distance.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI MODAL -->
  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 style="margin:0">AI Trip Planner</h3>
          <small style="color:var(--muted); font-weight:850">Days + people + interests ‚Üí suggestions</small>
        </div>
        <button class="closeX" id="closeAI">‚úï</button>
      </div>
      <div class="chat" id="chat"></div>
      <div class="composer">
        <input id="chatInput" placeholder="Example: 4 days, couple, nature + temples, starting Shimla"/>
        <button class="btnPrimary" id="sendChat" style="border-radius:14px; padding:11px 14px; border:0; cursor:pointer">Send</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   FIREBASE
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
  authDomain: "revnue-records.firebaseapp.com",
  databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "revnue-records",
  storageBucket: "revnue-records.firebasestorage.app",
  messagingSenderId: "182348503564",
  appId: "1:182348503564:web:480085405b09177245ac29",
  measurementId: "G-MGTDBCG896"
};
const dbPath = "locations";

/* =========================
   STATE
   ========================= */
const $ = (id)=>document.getElementById(id);
let allPlaces = [];
let shownPlaces = [];
let map = null;
let markerLayer = null;
let mapReady = false;
let currentPlace = null;
let myPos = null;

/* =========================
   HELPERS
   ========================= */
function safeText(v){ return (v ?? "").toString().trim(); }
function escapeHtml(str){
  return safeText(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function normalizeType(t){
  t = safeText(t);
  if(!t) return "Destination";
  const low = t.toLowerCase();
  if(low.includes("temple") || low.includes("mandir")) return "Temple";
  if(low.includes("lake")) return "Lake";
  if(low.includes("trek") || low.includes("trail")) return "Trek";
  if(low.includes("hotel") || low.includes("stay")) return "Hotel";
  if(low.includes("activity") || low.includes("adventure")) return "Activity";
  if(low.includes("dest") || low.includes("place")) return "Destination";
  return t[0].toUpperCase() + t.slice(1);
}
function parseLatLngFromMapUrl(url){
  url = safeText(url);
  if(!url) return {lat:null,lng:null};
  const q = url.match(/q=([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(q) return {lat:Number(q[1])||null, lng:Number(q[2])||null};
  const at = url.match(/@([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(at) return {lat:Number(at[1])||null, lng:Number(at[2])||null};
  return {lat:null,lng:null};
}
function placeImages(p){
  if(Array.isArray(p.images) && p.images.length) return p.images.filter(Boolean);
  if(p.image) return [p.image];
  return [];
}
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = (d)=> d * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

/* =========================
   MAP (lazy init)
   ========================= */
function ensureMap(){
  if(mapReady) return;
  $("mapPanel").style.display = "block";
  map = L.map('map', {zoomControl:true}).setView([31.9, 77.2], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);
  mapReady = true;
  setTimeout(()=> map.invalidateSize(), 120);
}
function clearMarkers(){ if(mapReady) markerLayer.clearLayers(); }
function addMarkers(list){
  if(!mapReady) return;
  clearMarkers();
  list.forEach((p)=>{
    if(!p.lat || !p.lng) return;
    const m = L.marker([p.lat, p.lng]).addTo(markerLayer);
    m.bindPopup(`<b>${escapeHtml(p.name)}</b><br/><span style="opacity:.75">${escapeHtml(p.district)} ‚Ä¢ ${escapeHtml(p.type)}</span>`);
    m.on('click', ()=> openDrawer(p));
  });
}

/* =========================
   LOAD DATA
   ========================= */
async function loadPlaces(){
  try{
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const snap = await db.ref(dbPath).once("value");
    const val = snap.val() || {};

    allPlaces = Object.entries(val).map(([id, o])=>{
      o = o || {};
      const name = safeText(o["Location Name"] || o.name || o.title || id);
      const district = safeText(o["District"] || o.district || "Unknown");
      const segment = safeText(o["Segment Type"] || o.segment || "Destination");
      const locationType = safeText(o["Location Type"] || o.type || "");
      const overview = safeText(o["Overview"] || o.overview || "");
      const short = safeText(o["Short Description"] || o.short || "");
      const keyFeatures = safeText(o["Key Features"] || o.features || "");
      const how = safeText(o["How to Reach"] || o.how || "");
      const mapUrl = safeText(o["Map"] || o.map || "");
      const {lat, lng} = parseLatLngFromMapUrl(mapUrl);
      const images = Array.isArray(o.images) ? o.images : (o.image ? [o.image] : []);
      const type = normalizeType(segment);
      const brief = overview || short || keyFeatures || "Explore this place in Himachal Pradesh.";
      return { id, name, district, type, segment, locationType, brief, how, mapUrl, lat, lng, images };
    }).filter(p=>p.name);
  }catch(e){
    console.error("Firebase load failed:", e);
    allPlaces = [];
  }
}
function buildDistrictDropdown(){
  const distSel = $("district");
  const districts = [...new Set(allPlaces.map(p=>p.district).filter(Boolean))].sort();
  distSel.innerHTML = `<option value="all">All</option>` + districts.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
}

/* =========================
   FILTERS + LIST
   ========================= */
function updateActiveFilters(){
  const parts = [];
  const d = $("district").value;
  const t = $("type").value;
  const q = safeText($("q").value);
  const days = Number($("days").value||0);

  if(d !== "all") parts.push(d);
  if(t !== "all") parts.push(t);
  if(days) parts.push(`${days}+ days`);
  if(q) parts.push(`‚Äú${q}‚Äù`);

  $("activeFilters").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "No filters";
}

function applyFilters(scrollToList=false){
  const q = safeText($("q").value).toLowerCase();
  const d = $("district").value;
  const t = $("type").value;
  const days = Number($("days").value||0);

  shownPlaces = allPlaces.filter(p=>{
    if(d !== "all" && p.district !== d) return false;
    if(t !== "all" && p.type !== t) return false;

    if(q){
      const hay = `${p.name} ${p.district} ${p.type} ${p.brief} ${p.how} ${p.locationType} ${p.segment}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }

    if(days){
      if(days <= 2 && p.type === "Trek") return false;
    }
    return true;
  });

  renderList(shownPlaces);
  $("count").textContent = `${shownPlaces.length} results`;
  updateActiveFilters();

  if(scrollToList) $("list").scrollTo({top:0, behavior:"smooth"});
}

function renderList(list){
  const box = $("list");
  if(!list.length){
    box.innerHTML = `<div style="padding:14px; color:rgba(31,35,40,.75); font-weight:850">
      No results. Try changing filters or search.
    </div>`;
    return;
  }

  box.innerHTML = list.map((p, idx)=>{
    const imgs = placeImages(p);
    const thumb = imgs[0] || "";
    const meta = `${safeText(p.district)} ‚Ä¢ ${safeText(p.type)}${p.locationType ? " ‚Ä¢ " + p.locationType : ""}`;
    const km = (myPos && p.lat && p.lng) ? haversine(myPos.lat, myPos.lng, p.lat, p.lng) : null;

    return `
      <div class="place" data-i="${idx}">
        <div class="thumb">
          ${thumb ? `<img src="${thumb}" alt="${escapeHtml(p.name)}" loading="lazy" onerror="this.remove()">` : ``}
        </div>
        <div>
          <p class="pTitle">${escapeHtml(p.name)}</p>
          <p class="pSub">${escapeHtml(meta)} ‚Äî ${escapeHtml(p.brief)}</p>
          <div class="badges">
            <span class="badge">${escapeHtml(p.type)}</span>
            <span class="badge">${escapeHtml(p.district)}</span>
            ${km ? `<span class="badge">üìç ${km.toFixed(1)} km</span>` : ``}
          </div>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll(".place").forEach(el=>{
    el.addEventListener("click", ()=>{
      const i = Number(el.getAttribute("data-i"));
      openDrawer(list[i]);
    });
  });
}

/* =========================
   PACKAGES (3‚Äì4)
   ========================= */
function makePackageText(place=null){
  const d = $("district").value !== "all" ? $("district").value : (place ? place.district : "Himachal");
  const days = Number($("days").value||0);
  const people = $("people").value;
  const interest = $("type").value !== "all" ? $("type").value : "Mixed";

  const dayLabel = days ? (days<=2? "2D/1N" : days<=4? "4D/3N" : days<=7? "6D/5N" : "10D/9N") : "3D/2N";
  const base = place ? place.name : "Top spots";

  const p1 = `Package A (${dayLabel}) ‚Ä¢ ${d} Highlights ‚Äî ${base} + 2 nearby places + local food.`;
  const p2 = `Package B (${dayLabel}) ‚Ä¢ Scenic Relax ‚Äî viewpoints + cafes + easy transfers.`;
  const p3 = `Package C (${dayLabel}) ‚Ä¢ Culture + Local ‚Äî temples/monasteries + market + sunsets.`;
  const p4 = `Package D (${dayLabel}) ‚Ä¢ Adventure Mix ‚Äî trek/activity + lake/waterfall + early start plan.`;

  return [
    `People: ${people} ‚Ä¢ Interest: ${interest}`,
    "",
    p1, "",
    p2, "",
    p3, "",
    p4
  ].join("\n");
}

/* =========================
   DRAWER
   ========================= */
function buildMiniPlan(p){
  if(p.type === "Trek") return "Start early ‚Ä¢ water + warm layer ‚Ä¢ return before sunset ‚Ä¢ add viewpoint.";
  if(p.type === "Lake") return "Sunrise/sunset ‚Ä¢ road buffer ‚Ä¢ pair with meadow/temple ‚Ä¢ slow travel.";
  if(p.type === "Temple") return "Morning darshan ‚Ä¢ local market ‚Ä¢ add nature spot nearby ‚Ä¢ easy day.";
  if(p.type === "Hotel") return "Use as base ‚Ä¢ 2 nearby spots + sunset point ‚Ä¢ relaxed evening.";
  return "1 main spot + 2 nearby places + food stop ‚Ä¢ keep photo time.";
}

function openDrawer(p){
  currentPlace = p;
  $("dTitle").textContent = p.name;
  $("dSub").textContent = `${p.district} ‚Ä¢ ${p.type}${p.locationType ? " ‚Ä¢ " + p.locationType : ""}`;
  $("dDesc").textContent = safeText(p.brief) || "No description available yet.";
  $("dType").textContent = p.type;
  $("dDistrict").textContent = p.district;
  $("dHow").textContent = safeText(p.how) ? `Reach: ${p.how}` : "Reach: ‚Äî";
  $("miniPlan").textContent = buildMiniPlan(p);

  if(myPos && p.lat && p.lng){
    const km = haversine(myPos.lat, myPos.lng, p.lat, p.lng);
    $("distInfo").textContent = `Approx distance: ${km.toFixed(1)} km from you.`;
  }else{
    $("distInfo").textContent = "Turn on Nearby to see distance.";
  }

  const imgs = placeImages(p).slice(0,6);
  const g = $("gallery");
  if(imgs.length){
    g.innerHTML = imgs.map(u=>`<div class="gImg"><img src="${u}" alt="${escapeHtml(p.name)}" loading="lazy" onerror="this.remove()"/></div>`).join("");
  }else{
    g.innerHTML = `<div class="gImg" style="display:flex; align-items:center; justify-content:center; padding:14px; color:rgba(31,35,40,.72); font-weight:850">
      No images yet (add images[] in Firebase)
    </div>`;
  }

  $("drawerWrap").style.display = "flex";
}
function closeDrawer(){ $("drawerWrap").style.display = "none"; currentPlace = null; }
$("closeDrawer").onclick = closeDrawer;
$("drawerWrap").addEventListener("click",(e)=>{ if(e.target === $("drawerWrap")) closeDrawer(); });

$("routeBtn").onclick = ()=>{
  if(!currentPlace) return;
  ensureMap();
  addMarkers([currentPlace]);
  if(currentPlace.lat && currentPlace.lng){
    map.setView([currentPlace.lat, currentPlace.lng], 12);
    $("mapHint").textContent = `${currentPlace.name} ‚Ä¢ ${currentPlace.district}`;
  }else{
    $("mapHint").textContent = "No lat/lng found (add Map link with q=lat,lng).";
  }
  closeDrawer();
  location.hash = "#explore";
};

$("pkgBtn").onclick = ()=>{
  if(!currentPlace) return;
  $("packagesBox").textContent = makePackageText(currentPlace);
};

$("fullBtn").onclick = ()=>{
  if(!currentPlace) return;
  window.location.href = `place.html?id=${encodeURIComponent(currentPlace.id)}`;
};

/* =========================
   NEARBY
   ========================= */
$("nearby").onclick = ()=>{
  if(!navigator.geolocation){ alert("GPS not supported."); return; }
  $("status").textContent = "Getting your location‚Ä¶";
  navigator.geolocation.getCurrentPosition((pos)=>{
    myPos = {lat: pos.coords.latitude, lng: pos.coords.longitude};
    $("status").textContent = "Nearby enabled. Distances are shown.";
    renderList(shownPlaces);
  }, ()=>{
    $("status").textContent = "GPS permission denied.";
    alert("Allow location permission for Nearby.");
  }, {enableHighAccuracy:true, timeout:12000});
};

/* =========================
   AI MODAL (same logic)
   ========================= */
function openAI(){ $("modalWrap").style.display="flex"; seedChat(); }
function closeAI(){ $("modalWrap").style.display="none"; }
$("openAI").onclick = openAI;
$("closeAI").onclick = closeAI;
$("modalWrap").addEventListener("click",(e)=>{ if(e.target === $("modalWrap")) closeAI(); });

function pushMsg(text, who="bot"){
  const div = document.createElement("div");
  div.className = "msg " + (who==="me" ? "me" : "");
  div.textContent = text;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}
function seedChat(){
  $("chat").innerHTML = "";
  pushMsg("Tell me: days + people + interests (trek/lake/temple/relax) + starting place/district.", "bot");
  pushMsg("Example: 4 days, couple, nature + temples, starting Shimla", "bot");
}
function aiSuggest(userText){
  const t = userText.toLowerCase();
  let days = 0;
  const m = t.match(/(\d+)\s*(day|days|d)/);
  if(m) days = Number(m[1]);

  const wants = {
    trek: /trek|hike|trail|adventure/.test(t),
    lake: /lake|chandratal|prashar|rewalsar|manimahesh/.test(t),
    temple: /temple|mandir|devi|mahadev|monastery/.test(t),
    relax: /relax|peace|family|easy/.test(t),
  };

  let districtHint = null;
  const districts = [...new Set(allPlaces.map(p=>p.district))];
  for(const d of districts){ if(t.includes(d.toLowerCase())) { districtHint = d; break; } }

  const scored = allPlaces.map(p=>{
    let s=0;
    if(districtHint && p.district===districtHint) s += 3;
    if(wants.trek && p.type==="Trek") s += 3;
    if(wants.lake && p.type==="Lake") s += 3;
    if(wants.temple && p.type==="Temple") s += 3;
    if(wants.relax && p.type!=="Trek") s += 1;
    return {p, s};
  }).sort((a,b)=>b.s-a.s);

  const cap = days ? Math.max(3, Math.min(8, Math.ceil(days*1.3))) : 6;
  const pick = scored.filter(x=>x.s>0).slice(0, cap).map(x=>x.p);
  const fallback = allPlaces.slice(0,6);

  const list = (pick.length ? pick : fallback)
    .map((p,i)=>`${i+1}. ${p.name} (${p.district} ‚Ä¢ ${p.type})`)
    .join("\n");

  return `Suggestions:\n${list}\n\nTip: Apply filters ‚Üí click a place ‚Üí open map + route.`;
}
$("sendChat").onclick = ()=>{
  const v = safeText($("chatInput").value);
  if(!v) return;
  pushMsg(v, "me");
  $("chatInput").value = "";
  pushMsg(aiSuggest(v), "bot");
};
$("chatInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("sendChat").click(); });

/* =========================
   ACTIONS
   ========================= */
$("apply").onclick = ()=>{ applyFilters(true); location.hash="#explore"; };
$("reset").onclick = ()=>{
  $("q").value = ""; $("district").value="all"; $("type").value="all"; $("days").value="0";
  applyFilters(true);
};
$("makePackages").onclick = ()=>{ $("packagesBox").textContent = makePackageText(null); };

document.querySelectorAll(".tile").forEach(el=>{
  el.addEventListener("click", ()=>{
    $("type").value = el.getAttribute("data-quick");
    applyFilters(true);
    location.hash="#explore";
  });
});

$("openAdmin").onclick = ()=>{ window.location.href = "admin.html"; };

/* =========================
   INIT
   ========================= */
(async function init(){
  await loadPlaces();
  buildDistrictDropdown();

  $("statPlaces").textContent = allPlaces.length.toString();
  $("status").textContent = allPlaces.length
    ? `Loaded ${allPlaces.length} places from Firebase /${dbPath}`
    : "No data loaded. Check RTDB rules + path.";

  shownPlaces = allPlaces.slice();
  applyFilters(false);
})();
</script>
</body>
</html>
