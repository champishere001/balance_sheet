<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer ‚Ä¢ Stories by District</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#050712; --bg1:#080B18;
      --text:#ECF2FF; --muted:rgba(236,242,255,.74); --muted2:rgba(236,242,255,.60);
      --stroke:rgba(255,255,255,.12);
      --brand:#FF7A18; --brand2:#FFB04A;
      --blur:18px;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --shadow2: 0 10px 26px rgba(0,0,0,.45);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Manrope",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(255,122,24,.14), transparent 60%),
        radial-gradient(900px 700px at 90% 20%, rgba(120,110,255,.14), transparent 55%),
        radial-gradient(900px 700px at 70% 95%, rgba(0,210,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* layout */
    .app{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      padding:14px;
      min-height:100vh;
    }

    /* hero */
    .hero{
      grid-column: 1 / 2;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background:rgba(255,255,255,.05);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      position:relative;
      isolation:isolate;
    }
    .heroCover{
      position:absolute; inset:0;
      background-size:cover;
      background-position:center;
      filter: blur(26px) saturate(1.1) contrast(1.05);
      transform:scale(1.12);
      opacity:.58;
      z-index:0;
    }
    .heroOverlay{
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(5,7,18,.18), rgba(5,7,18,.82) 55%, rgba(5,7,18,.95));
      z-index:1;
    }
    .heroInner{position:relative; z-index:2; padding:18px;}
    .topRow{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      padding:12px 14px;border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(450px 120px at 20% 0%, rgba(255,122,24,.22), transparent 70%), rgba(0,0,0,.26);
      box-shadow: var(--shadow2);
    }
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 0 24px rgba(255,122,24,.55)
    }
    .title{font-weight:900; letter-spacing:-.2px}
    .sub{font-size:12px;color:var(--muted);font-weight:800;margin-top:2px}

    .quoteBox{
      flex:1;
      min-width: 260px;
      max-width: 620px;
      padding:14px 14px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      box-shadow: var(--shadow2);
    }
    .quote{
      font-weight:900;
      font-size:14px;
      line-height:1.5;
      margin:0;
    }
    .quoteSmall{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    /* districts grid (top) */
    .districtPanel{
      margin-top:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      overflow:hidden;
    }
    .districtHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      flex-wrap:wrap;
    }
    .districtHead b{letter-spacing:.2px}
    .search{
      min-width:220px;
      flex:1;
      padding:11px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      outline:none;
      color:var(--text);
      background:rgba(0,0,0,.22);
      font-weight:800;
    }
    .search:focus{
      border-color:rgba(255,122,24,.45);
      box-shadow:0 0 0 4px rgba(255,122,24,.12);
    }
    .grid{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
    }
    .dCard{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      padding:12px;
      cursor:pointer;
      transition:.18s transform ease, .18s border-color ease;
      position:relative;
      overflow:hidden;
    }
    .dCard:hover{transform:translateY(-3px); border-color:rgba(255,255,255,.22)}
    .dCard.active{border-color:rgba(255,122,24,.48); box-shadow:0 0 0 1px rgba(255,122,24,.24) inset, 0 12px 26px rgba(0,0,0,.45)}
    .dCard b{display:block; font-weight:950; font-size:14px}
    .dCard small{
      display:block;
      margin-top:8px;
      color:var(--muted);
      font-weight:800;
      font-size:11px;
      line-height:1.35;
      opacity:.95;
    }
    .miniTag{
      position:absolute;
      top:10px; right:10px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      font-weight:900;
      font-size:11px;
      color:rgba(236,242,255,.92);
    }

    /* story section */
    .story{
      margin-top:14px;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .storyTop{
      padding:16px;
      background:rgba(0,0,0,.20);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .storyTop h1{
      margin:0;
      font-size: clamp(22px, 2.6vw, 42px);
      font-weight:950;
      letter-spacing:-.4px;
    }
    .storyTop p{
      margin:10px 0 0;
      color:rgba(236,242,255,.86);
      line-height:1.55;
      font-weight:650;
    }
    .metaRow{
      margin-top:12px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{
      padding:8px 11px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      font-weight:900;
      font-size:12px;
      color:rgba(236,242,255,.92);
    }

    /* section headers + cards */
    .section{
      padding:14px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:0;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }
    .sectionTitle b{font-size:13px; letter-spacing:.2px}
    .countPill{
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-weight:900; font-size:12px;
    }

    .cards{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    .card{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      cursor:pointer;
      transition:.18s;
      box-shadow:0 10px 18px rgba(0,0,0,.24);
    }
    .card:hover{transform:translateY(-3px); border-color:rgba(255,255,255,.22); box-shadow:0 18px 34px rgba(0,0,0,.35)}
    .thumb{
      height:140px;
      background:rgba(255,255,255,.08);
      background-size:cover;
      background-position:center;
      position:relative;
    }
    .thumb:after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.55))}
    .badge{
      position:absolute; top:10px; left:10px; z-index:2;
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      font-weight:950;
      color:rgba(236,242,255,.95);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
    }
    .pad{padding:12px}
    .pad b{display:block; font-weight:950}
    .meta{margin-top:6px; color:var(--muted); font-weight:800; font-size:12px; line-height:1.35}
    .empty{
      padding:16px;
      border-radius:18px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.18);
      color:rgba(236,242,255,.88);
      font-weight:850;
      margin-top:12px;
    }

    /* map column (second priority) */
    .mapCol{
      position:sticky;
      top:14px;
      height: calc(100vh - 28px);
    }
    .mapShell{
      height:100%;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .mapHead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
    }
    .mapHead b{font-size:13px; letter-spacing:.3px}
    .mapHint{font-size:12px; color:var(--muted); font-weight:800; margin-top:4px}
    .mapFrameWrap{flex:1; min-height:0}
    iframe{width:100%; height:100%; border:0; background:rgba(0,0,0,.2)}

    /* floating districts button after scroll */
    .dockBtn{
      position:fixed;
      left:14px;
      bottom:14px;
      z-index:999;
      display:none;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      color:rgba(236,242,255,.92);
      font-weight:950;
      cursor:pointer;
      box-shadow: 0 16px 34px rgba(0,0,0,.45);
    }
    .dockBtn:hover{border-color:rgba(255,255,255,.24)}
    .dockSheet{
      position:fixed;
      left:14px;
      right:14px;
      bottom:64px;
      z-index:999;
      display:none;
      max-height: 62vh;
      overflow:auto;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(18px);
      box-shadow: 0 18px 50px rgba(0,0,0,.6);
      padding:12px;
    }
    .dockSheet .grid{padding:0; grid-template-columns: repeat(3, minmax(0,1fr));}
    .dockSheet .districtHead{padding:0 0 12px 0; background:transparent; border-bottom:0}
    .dockClose{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      color:rgba(236,242,255,.92);
      font-weight:950;
      padding:10px 12px;
      border-radius:16px;
      cursor:pointer;
    }

    @media(max-width:1200px){
      .grid{grid-template-columns: repeat(3, minmax(0,1fr));}
      .cards{grid-template-columns: repeat(2, minmax(0,1fr));}
      .app{grid-template-columns: 1fr}
      .mapCol{position:relative; height:520px}
    }
    @media(max-width:520px){
      .grid{grid-template-columns: repeat(2, minmax(0,1fr));}
      .cards{grid-template-columns: 1fr;}
    }
  </style>
</head>

<body>
  <div class="app">
    <section class="hero" id="hero">
      <div class="heroCover" id="heroCover"></div>
      <div class="heroOverlay"></div>
      <div class="heroInner">
        <div class="topRow">
          <div class="brand">
            <div class="dot"></div>
            <div>
              <div class="title">Himachal Explorer</div>
              <div class="sub">Stories by district ‚Ä¢ places ‚Ä¢ temples ‚Ä¢ lakes ‚Ä¢ treks ‚Ä¢ hotels</div>
            </div>
          </div>

          <div class="quoteBox">
            <p class="quote" id="quoteText">‚ÄúWhere mountains whisper and rivers sing ‚Äî welcome to Himachal.‚Äù</p>
            <div class="quoteSmall" id="quoteBy">‚Äî Himachal Explorer</div>
          </div>
        </div>

        <div class="districtPanel" id="districtPanel">
          <div class="districtHead">
            <b>Pick a District</b>
            <input id="q" class="search" placeholder="Search district‚Ä¶">
          </div>
          <div class="grid" id="districtGrid">
            <div class="dCard"><b>Loading‚Ä¶</b><small>Please wait</small></div>
          </div>
        </div>

        <div class="story" id="story">
          <div class="storyTop">
            <h1 id="hTitle">Himachal Pradesh</h1>
            <p id="hSub">Select any district above to read its story ‚Äî brief, how to reach, and curated places.</p>
            <div class="metaRow" id="metaRow"></div>
          </div>

          <div class="section">
            <div class="sectionTitle"><b>District Brief</b></div>
            <div id="briefBox" style="margin-top:12px;color:rgba(236,242,255,.92);line-height:1.7;font-weight:650">
              <div class="empty">Select a district to see a story-style overview‚Ä¶</div>
            </div>
          </div>

          <div class="section">
            <div class="sectionTitle"><b>How to Reach</b></div>
            <div id="reachBox" style="margin-top:12px;color:rgba(236,242,255,.92);line-height:1.7;font-weight:650">
              <div class="empty">Select a district to see roads, rail and airports guidance‚Ä¶</div>
            </div>
          </div>

          <div class="section" id="placesRoot">
            <!-- sections injected -->
          </div>
        </div>
      </div>
    </section>

    <aside class="mapCol">
      <div class="mapShell">
        <div class="mapHead">
          <b>Map</b>
          <div class="mapHint" id="mapHint">Map is secondary ‚Äî click a place to focus here.</div>
        </div>
        <div class="mapFrameWrap">
          <iframe id="mapFrame" title="District Map" src="map.html"></iframe>
        </div>
      </div>
    </aside>
  </div>

  <!-- floating districts -->
  <button class="dockBtn" id="dockBtn">‚ò∞ Districts</button>
  <div class="dockSheet" id="dockSheet">
    <div class="districtHead">
      <b>Districts</b>
      <button class="dockClose" id="dockClose">Close</button>
    </div>
    <input id="q2" class="search" placeholder="Search district‚Ä¶" style="margin-bottom:12px">
    <div class="grid" id="districtGrid2"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) {}
    const db = getDatabase(app);

    const ROOT = "tourism/hp/districts";

    // ‚úÖ canonical types
    const TYPES = ["destinations","lakes","temples","treks","hotels"];
    const TYPE_LABEL = {
      destinations:"Destinations",
      lakes:"Lakes",
      temples:"Temples",
      treks:"Treks",
      hotels:"Hotels"
    };

    // Himachal-ish fallback hero photos (safe, thematic)
    const HERO_FALLBACKS = [
      "https://source.unsplash.com/1600x1000/?Himachal,Mountains",
      "https://source.unsplash.com/1600x1000/?Spiti,Monastery",
      "https://source.unsplash.com/1600x1000/?Manali,Snow",
      "https://source.unsplash.com/1600x1000/?Dharamshala,Mountains",
      "https://source.unsplash.com/1600x1000/?Himachal,Lake",
      "https://source.unsplash.com/1600x1000/?Himalaya,Valley"
    ];

    const QUOTES = [
      {q:"Where mountains whisper and rivers sing ‚Äî welcome to Himachal.", by:"Himachal Explorer"},
      {q:"In Himachal, every bend of the road is a postcard.", by:"Travel Note"},
      {q:"Breathe deeper ‚Äî the Himalayas keep secrets in the pine-scented air.", by:"Himalayan Diaries"},
      {q:"Not all who wander are lost‚Ä¶ some are just in Himachal.", by:"Wander Quote"},
      {q:"Chai tastes warmer when the view is colder.", by:"Hill Station Mood"},
      {q:"Let the peaks reset your mind.", by:"Slow Travel"}
    ];

    // UI
    const heroCover = document.getElementById("heroCover");
    const quoteText = document.getElementById("quoteText");
    const quoteBy = document.getElementById("quoteBy");

    const q = document.getElementById("q");
    const districtGrid = document.getElementById("districtGrid");
    const q2 = document.getElementById("q2");
    const districtGrid2 = document.getElementById("districtGrid2");

    const hTitle = document.getElementById("hTitle");
    const hSub = document.getElementById("hSub");
    const metaRow = document.getElementById("metaRow");
    const briefBox = document.getElementById("briefBox");
    const reachBox = document.getElementById("reachBox");
    const placesRoot = document.getElementById("placesRoot");

    const mapHint = document.getElementById("mapHint");
    const mapFrame = document.getElementById("mapFrame");

    const dockBtn = document.getElementById("dockBtn");
    const dockSheet = document.getElementById("dockSheet");
    const dockClose = document.getElementById("dockClose");

    // state
    let ROOT_SNAPSHOT = {};
    let DISTRICTS = [];
    let PREVIEW = {}; // district -> 2-3 popular destination names
    let ACTIVE_DIST = "";

    const safeObj = (x)=> (x && typeof x==="object") ? x : {};
    const norm = (s)=> String(s ?? "").trim();
    const low = (s)=> norm(s).toLowerCase();

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function normalizeType(t){
      // ‚úÖ fix: if DB has lake/temple/destination etc
      const s = low(t);
      if(!s) return "";
      if(s==="destination" || s==="dest") return "destinations";
      if(s==="lake") return "lakes";
      if(s==="temple") return "temples";
      if(s==="trek") return "treks";
      if(s==="hotel") return "hotels";
      return s; // expects already plural
    }

    function extractPhotos(item){
      const a = [];
      const pushArr = (x)=> { if(Array.isArray(x)) x.forEach(u=>{ if(norm(u)) a.push(norm(u)); }); };
      pushArr(item.photos); pushArr(item.images); pushArr(item.gallery);
      if(norm(item.photoUrl)) a.push(norm(item.photoUrl));
      if(norm(item.imageUrl)) a.push(norm(item.imageUrl));
      if(norm(item.cover)) a.push(norm(item.cover));
      if(norm(item.photo)) a.push(norm(item.photo));
      // also support pipe-separated
      if(norm(item.photo) && String(item.photo).includes("|")){
        String(item.photo).split("|").map(x=>x.trim()).filter(Boolean).forEach(u=>a.push(u));
      }
      return Array.from(new Set(a)).filter(Boolean);
    }

    function pickTitle(it){
      return it.name || it.title || it.place || it.placeName || it.locationName || "Untitled";
    }

    function computePreviewNames(dNode){
      const seg = safeObj(dNode?.segments);
      // ‚úÖ preview ONLY from destinations
      const bucket = safeObj(seg?.destinations);
      const arr = Object.keys(bucket).map(id=>{
        const it = safeObj(bucket[id]);
        return {
          title: pickTitle(it),
          pop: Number(it.popularityScore ?? it.popularity ?? 0) || 0,
          rating: Number(it.rating ?? 0) || 0
        };
      });
      arr.sort((a,b)=> (b.pop-a.pop) || (b.rating-a.rating) || String(a.title).localeCompare(String(b.title)));
      return arr.slice(0,3).map(x=>x.title).filter(Boolean);
    }

    function pickDistrictCover(dNode){
      const info = safeObj(dNode?.districtInfo);
      const a = [];
      if(Array.isArray(info.coverPhotos)) a.push(...info.coverPhotos);
      if(norm(info.coverPhoto)) a.push(info.coverPhoto);
      if(norm(info.cover)) a.push(info.cover);
      // fallback from any place photo
      const seg = safeObj(dNode?.segments);
      for(const t of TYPES){
        const bucket = safeObj(seg[t]);
        for(const id of Object.keys(bucket)){
          const it = safeObj(bucket[id]);
          const pics = extractPhotos(it);
          if(pics[0]) { a.push(pics[0]); break; }
        }
        if(a.length) break;
      }
      const cover = a.map(norm).filter(Boolean)[0];
      return cover || HERO_FALLBACKS[(Math.random()*HERO_FALLBACKS.length)|0];
    }

    function setHeroImage(url){
      heroCover.style.backgroundImage = url ? `url('${String(url).replaceAll("'","%27")}')` : "none";
    }

    function rotateQuotes(){
      let i=0;
      const apply = ()=>{
        const x = QUOTES[i % QUOTES.length];
        quoteText.textContent = `‚Äú${x.q}‚Äù`;
        quoteBy.textContent = `‚Äî ${x.by}`;
        i++;
      };
      apply();
      setInterval(apply, 5200);
    }

    function renderDistrictCards(targetEl, queryStr){
      const query = low(queryStr);
      const list = DISTRICTS.filter(d => !query || low(d).includes(query));

      targetEl.innerHTML = (list.length ? list : [""]).map(d=>{
        if(!d) return `<div class="dCard"><b>No district found</b><small>Try another search</small></div>`;
        const active = (ACTIVE_DIST === d) ? "active" : "";
        const pv = PREVIEW[d] || [];
        const line = pv.length ? `<small>${pv.map(escapeHtml).join(" ‚Ä¢ ")}</small>` : `<small style="opacity:.65">‚Äî</small>`;
        const count = countDistrictItems(ROOT_SNAPSHOT[d]);
        return `
          <div class="dCard ${active}" data-d="${escapeHtml(d)}">
            <span class="miniTag">${count}</span>
            <b>${escapeHtml(d)}</b>
            ${line}
          </div>
        `;
      }).join("");

      [...targetEl.querySelectorAll(".dCard[data-d]")].forEach(el=>{
        el.addEventListener("click", ()=> openDistrict(el.getAttribute("data-d")));
      });
    }

    function countDistrictItems(dNode){
      const seg = safeObj(dNode?.segments);
      let total=0;
      for(const t of TYPES){
        total += Object.keys(safeObj(seg[t])).length;
      }
      return total;
    }

    function focusDistrictOnMap(d){
      mapHint.textContent = `Map focus: ${d}`;
      mapFrame.src = `map.html#district=${encodeURIComponent(d)}&t=${Date.now()}`;
      setTimeout(()=> mapFrame.contentWindow?.postMessage({ type:"FOCUS_DISTRICT", district:d }, "*"), 500);
    }
    function focusPlaceOnMap(payload){
      mapFrame.contentWindow?.postMessage({ type:"FOCUS_PLACE", ...payload }, "*");
    }

    function defaultBrief(d){
      return `‚Ä¢ ${d} is a beautiful district of Himachal Pradesh.\n‚Ä¢ Explore curated places section-wise below.\n‚Ä¢ Tap any card to focus on map (if location exists).`;
    }
    function defaultReach(d){
      return `üõ£Ô∏è Road: Well-connected by road from major towns.\nüöÜ Train: nearest railhead depends on route.\n‚úàÔ∏è Air: nearest airport depends on region.\n\nTip: Map panel will help you visualize distance.`;
    }

    function metaPills(info, total){
      const pills = [];
      if(norm(info.bestSeason)) pills.push(`Best season: ${norm(info.bestSeason)}`);
      if(norm(info.districtHQ)) pills.push(`HQ: ${norm(info.districtHQ)}`);
      if(Number.isFinite(Number(info.popularityScore))) pills.push(`Popularity: ${Number(info.popularityScore)}`);
      pills.push(`Records: ${total}`);
      return pills;
    }

    function makeSectionHTML(type, items){
      const label = TYPE_LABEL[type] || type;
      return `
        <div class="section">
          <div class="sectionTitle">
            <b>${escapeHtml(label)}</b>
            <span class="countPill">${items.length}</span>
          </div>
          ${items.length ? `
            <div class="cards">
              ${items.slice(0, 24).map(cardHTML).join("")}
            </div>
            ${items.length>24 ? `<div class="meta" style="margin-top:10px">Showing top 24. Add filters later if you want.</div>` : ""}
          ` : `<div class="empty">No records in this section.</div>`}
        </div>
      `;
    }

    function cardHTML(x){
      const photos = x.photos || [];
      const thumbUrl = photos[0] ? photos[0].replaceAll("'","%27") : "";
      const label = TYPE_LABEL[x.type] || x.type;
      const canMap = Number.isFinite(x.lat) && Number.isFinite(x.lng);

      const extra = [
        Number.isFinite(x.rating) ? `‚≠ê ${x.rating}` : "",
        Number.isFinite(x.popularity) ? `üî• ${x.popularity}` : "",
        Number.isFinite(x.entryFee) ? `‚Çπ${x.entryFee}` : ""
      ].filter(Boolean).join(" ‚Ä¢ ");

      return `
        <div class="card" data-id="${escapeHtml(x.id)}" data-type="${escapeHtml(x.type)}">
          <div class="thumb" style="${thumbUrl ? `background-image:url('${thumbUrl}')` : ""}">
            <div class="badge">${escapeHtml(label)}${canMap ? " ‚Ä¢ Map" : ""}</div>
          </div>
          <div class="pad">
            <b>${escapeHtml(x.title)}</b>
            <div class="meta">${escapeHtml(extra || "Tap to focus on map (if lat/lng available)")}</div>
            ${x.notes ? `<div class="meta">${escapeHtml(x.notes).slice(0,120)}${x.notes.length>120?"‚Ä¶":""}</div>` : ""}
          </div>
        </div>
      `;
    }

    function bindCardClicks(itemsById){
      [...document.querySelectorAll(".card[data-id]")].forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          const p = itemsById.get(id);
          if(!p) return;

          // ‚úÖ "place location not working" fix:
          // ensure we send numeric lat/lng & correct type
          if(Number.isFinite(p.lat) && Number.isFinite(p.lng)){
            focusPlaceOnMap({
              district: ACTIVE_DIST,
              title: p.title,
              lat: p.lat,
              lng: p.lng,
              type: p.type
            });
          } else {
            focusDistrictOnMap(ACTIVE_DIST);
          }
        });
      });
    }

    function flattenDistrict(dNode){
      const seg = safeObj(dNode?.segments);
      const out = [];
      for(const rawKey of Object.keys(seg)){
        const t = normalizeType(rawKey);
        if(!TYPES.includes(t)) continue;

        const bucket = safeObj(seg[rawKey]);
        for(const id of Object.keys(bucket)){
          const it = safeObj(bucket[id]);
          out.push({
            id,
            type: t,
            title: pickTitle(it),
            photos: extractPhotos(it),
            notes: it.notes || it.description || "",
            rating: Number(it.rating ?? "") || null,
            popularity: Number(it.popularityScore ?? it.popularity ?? "") || null,
            entryFee: Number(it.entryFee ?? "") || null,
            lat: Number(it.lat ?? it.latitude ?? ""),
            lng: Number(it.lng ?? it.longitude ?? "")
          });
        }
      }
      return out;
    }

    async function openDistrict(d){
      ACTIVE_DIST = d;

      // highlight
      renderDistrictCards(districtGrid, q.value);
      renderDistrictCards(districtGrid2, q2.value);

      const node = ROOT_SNAPSHOT[d];
      const info = safeObj(node?.districtInfo);
      const total = countDistrictItems(node);

      // hero
      setHeroImage(pickDistrictCover(node));

      // title + meta
      hTitle.textContent = d;
      hSub.textContent = "A short district story + curated sections below.";
      metaRow.innerHTML = metaPills(info, total).map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join("");

      // brief/how to reach
      const brief = norm(info.brief) || defaultBrief(d);
      const reach = norm(info.howToReach) || defaultReach(d);
      briefBox.innerHTML = `<div>${escapeHtml(brief).replaceAll("\n","<br/>")}</div>`;
      reachBox.innerHTML = `<div>${escapeHtml(reach).replaceAll("\n","<br/>")}</div>`;

      // places sections
      const all = flattenDistrict(node);
      const byType = {};
      for(const t of TYPES) byType[t] = [];
      all.forEach(x=> byType[x.type].push(x));

      // sort inside each type (popularity > rating > name)
      for(const t of TYPES){
        byType[t].sort((a,b)=>{
          const pa = Number.isFinite(a.popularity)?a.popularity:-1e18;
          const pb = Number.isFinite(b.popularity)?b.popularity:-1e18;
          const ra = Number.isFinite(a.rating)?a.rating:-1e18;
          const rb = Number.isFinite(b.rating)?b.rating:-1e18;
          return (pb-pa) || (rb-ra) || String(a.title).localeCompare(String(b.title));
        });
      }

      placesRoot.innerHTML =
        makeSectionHTML("destinations", byType.destinations) +
        makeSectionHTML("lakes", byType.lakes) +
        makeSectionHTML("temples", byType.temples) +
        makeSectionHTML("treks", byType.treks) +
        makeSectionHTML("hotels", byType.hotels);

      // card clicks -> map focus
      const mapById = new Map(all.map(x=>[x.id,x]));
      bindCardClicks(mapById);

      // map focus (district)
      focusDistrictOnMap(d);

      // smooth scroll to story
      document.getElementById("story").scrollIntoView({behavior:"smooth", block:"start"});

      // close dock if open
      dockSheet.style.display = "none";
    }

    function setupDock(){
      dockBtn.addEventListener("click", ()=>{
        dockSheet.style.display = (dockSheet.style.display === "block") ? "none" : "block";
      });
      dockClose.addEventListener("click", ()=> dockSheet.style.display="none");

      // show dock button after you scroll past district panel
      const districtPanel = document.getElementById("districtPanel");
      const onScroll = ()=>{
        const r = districtPanel.getBoundingClientRect();
        const shouldShow = r.bottom < 40;
        dockBtn.style.display = shouldShow ? "block" : "none";
      };
      window.addEventListener("scroll", onScroll, {passive:true});
      onScroll();
    }

    async function init(){
      rotateQuotes();
      setHeroImage(HERO_FALLBACKS[0]);

      const snap = await get(ref(db, ROOT));
      ROOT_SNAPSHOT = snap.exists() ? safeObj(snap.val()) : {};
      DISTRICTS = Object.keys(ROOT_SNAPSHOT).sort((a,b)=>a.localeCompare(b));

      PREVIEW = {};
      for(const d of DISTRICTS){
        PREVIEW[d] = computePreviewNames(ROOT_SNAPSHOT[d]);
      }

      renderDistrictCards(districtGrid, "");
      renderDistrictCards(districtGrid2, "");

      // searches
      q.addEventListener("input", ()=> renderDistrictCards(districtGrid, q.value));
      q2.addEventListener("input", ()=> renderDistrictCards(districtGrid2, q2.value));

      setupDock();

      // if URL has #district=Kullu
      const m = (location.hash || "").match(/district=([^&]+)/i);
      if(m){
        const d = decodeURIComponent(m[1]);
        if(DISTRICTS.includes(d)) openDistrict(d);
      }
    }

    init().catch((e)=>{
      console.error(e);
      districtGrid.innerHTML = `<div class="dCard"><b>Firebase not configured</b><small>Check config/rules/path</small></div>`;
      districtGrid2.innerHTML = districtGrid.innerHTML;
    });
  </script>
</body>
</html>