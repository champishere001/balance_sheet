<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>

  <title>Himachal Tour Packages | Himachal Explorer Portal</title>
  <meta name="description" content="Explore Himachal tour packages with live road route maps, day-wise itineraries, places, and instant price estimates." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <link rel="canonical" href="https://himachalexplorer.in/" />
  <meta name="theme-color" content="#F6F1E8" />
  <link rel="icon" href="./favicon.ico" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <style>
    :root{
      /* ‚úÖ Creamy white aurora theme */
      --bg0:#FBF6EE;
      --bg1:#F3EDE2;
      --card: rgba(255,255,255,.72);
      --card2: rgba(255,255,255,.62);
      --stroke: rgba(15, 23, 42, .12);
      --muted: rgba(15, 23, 42, .62);
      --text: rgba(15, 23, 42, .92);
      --shadow: 0 18px 70px rgba(2,6,23,.12);
      --shadow2: 0 16px 44px rgba(2,6,23,.10);
      --radius: 16px;
      --acc:#7C3AED;    /* purple */
      --acc2:#06B6D4;   /* cyan */
      --acc3:#22C55E;   /* green */
      --gap: 12px;

      --shellW: min(96vw, 1700px);
      --heroH: 230px;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(124,58,237,.16), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(900px 520px at 50% 90%, rgba(6,182,212,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:auto;
    }

    .aurora{
      position:fixed; inset:-30%;
      background:
        radial-gradient(900px 520px at 22% 30%, rgba(124,58,237,.22), transparent 66%),
        radial-gradient(900px 520px at 75% 22%, rgba(34,197,94,.18), transparent 66%),
        radial-gradient(860px 560px at 55% 76%, rgba(6,182,212,.18), transparent 66%);
      filter: blur(54px);
      opacity:.85;
      animation: drift 16s ease-in-out infinite;
      pointer-events:none;
      z-index:-3;
    }
    @keyframes drift{
      0%,100%{transform:translate3d(0,0,0) scale(1);}
      50%{transform:translate3d(2.5%,-1.8%,0) scale(1.05);}
    }

    .noise{
      position:fixed; inset:0; z-index:-2; pointer-events:none;
      opacity:.08; mix-blend-mode:multiply;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.20'/%3E%3C/svg%3E");
    }

    .shell{ width: var(--shellW); margin: 0 auto; padding: 12px 10px 18px; }

    .hero{
      height: var(--heroH);
      border-radius: 22px;
      border:1px solid var(--stroke);
      overflow:hidden;
      position:relative;
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.42);
    }
    .hero img{ width:100%; height:100%; object-fit:cover; display:block; filter:saturate(1.02) contrast(1.04); }
    .hero::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,.78), rgba(255,255,255,.52), rgba(255,255,255,.74));
      mix-blend-mode:screen;
      pointer-events:none;
    }
    .heroInner{
      position:absolute; inset:0;
      display:flex; align-items:flex-end; justify-content:space-between;
      padding: 14px 16px; gap:12px;
    }
    .heroBrand{ display:flex; align-items:center; gap:12px; min-width: 280px; }
    .logo{
      width:52px; height:52px; border-radius:16px;
      background: rgba(255,255,255,.72);
      border:1px solid var(--stroke);
      display:grid; place-items:center; overflow:hidden;
      box-shadow: var(--shadow2);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .heroTitle{ margin:0; font-size: 16px; letter-spacing:.18em; text-transform: uppercase; font-weight: 950; color: rgba(15,23,42,.95); }
    .heroSub{ margin:6px 0 0; font-size: 12px; color: var(--muted); letter-spacing:.06em; text-transform: uppercase; }

    .heroRight{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.62);
      color: rgba(15,23,42,.82);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing:.10em;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer; user-select:none;
      white-space: nowrap;
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
      backdrop-filter: blur(10px);
    }
    .chip:hover{ background: rgba(255,255,255,.78); }
    .chip.primary{
      border-color: rgba(124,58,237,.35);
      background: linear-gradient(135deg, rgba(124,58,237,.18), rgba(6,182,212,.10));
      color: rgba(15,23,42,.92);
      font-weight: 950;
    }

    .main{
      display:grid;
      grid-template-columns: 20% 55% 25%;
      gap: var(--gap);
      margin-top: 12px;
      align-items:start;
    }

    .pane{
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.62));
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 620px;
      display:flex;
      flex-direction:column;
    }
    .paneHdr{
      padding: 10px 12px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      background: rgba(255,255,255,.60);
    }
    .paneHdr .t{ margin:0; font-size:11px; letter-spacing:.18em; text-transform: uppercase; font-weight: 950; }
    .paneHdr .s{ font-size:10.5px; color:var(--muted); letter-spacing:.10em; text-transform: uppercase; }

    .sideInner{ padding: 12px; display:flex; flex-direction:column; gap:10px; min-height:0; }
    .sideCard{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.60);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 26px rgba(2,6,23,.08);
    }

    .field label{
      display:block; font-size: 10.5px; color: var(--muted);
      text-transform: uppercase; letter-spacing:.12em; margin:0 0 6px 2px;
    }
    input, select{
      width:100%; padding: 10px 10px; border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      color: rgba(15,23,42,.92);
      outline:none; font-size: 13px;
    }
    input:focus, select:focus{
      border-color: rgba(124,58,237,.45);
      box-shadow: 0 0 0 3px rgba(124,58,237,.12);
    }

    .btnRow{ display:flex; gap:8px; margin-top:8px; }
    .btn{
      flex:1; padding: 10px 10px; border-radius: 12px;
      border: 1px solid rgba(124,58,237,.25);
      background: linear-gradient(135deg, rgba(124,58,237,.20), rgba(6,182,212,.14));
      color: rgba(15,23,42,.92);
      font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
      cursor:pointer; font-size: 11px;
      box-shadow: 0 10px 26px rgba(2,6,23,.08);
    }
    .btn.secondary{
      border-color: var(--stroke);
      background: rgba(255,255,255,.70);
      color: rgba(15,23,42,.82);
    }

    .pills{ display:flex; flex-wrap:wrap; gap:7px; margin-top:10px; }
    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10.5px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(15,23,42,.72);
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: 0 8px 20px rgba(2,6,23,.06);
    }
    .pill b{ color: rgba(15,23,42,.95); letter-spacing:.06em; }

    .otherWrap{ flex:1; min-height:0; display:flex; flex-direction:column; gap:10px; }
    .otherHdr{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.62);
      border-radius: 14px;
      padding: 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .otherHdr .h{ font-size: 11px; font-weight: 950; letter-spacing:.14em; text-transform: uppercase; }
    .otherHdr .xBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      color: rgba(15,23,42,.90);
      border-radius: 12px;
      padding: 7px 10px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .otherList{
      flex:1; min-height:0; overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 2px;
      display:flex; flex-direction:column; gap:10px;
    }
    .otherHint{
      border:1px dashed rgba(15,23,42,.18);
      background: rgba(255,255,255,.66);
      border-radius: 14px;
      padding: 10px;
      color: rgba(15,23,42,.70);
      font-size: 11px;
      letter-spacing:.02em;
      line-height: 1.35;
    }

    .centerInner{ display:flex; flex-direction:column; min-height:0; flex:1; }
    .districtBar{
      display:flex; flex-wrap:nowrap; gap:8px;
      padding:10px 12px;
      border-bottom:1px solid var(--stroke);
      overflow-x:auto; -webkit-overflow-scrolling: touch;
      background: rgba(255,255,255,.58);
    }
    .distItem{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.74);
      color: rgba(15,23,42,.86);
      border-radius: 999px;
      padding:8px 10px;
      font-size: 10.5px;
      letter-spacing:.10em;
      text-transform: uppercase;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
      white-space:nowrap;
      box-shadow: 0 8px 18px rgba(2,6,23,.06);
    }
    .distItem.active{
      border-color: rgba(124,58,237,.35);
      box-shadow: 0 0 0 3px rgba(124,58,237,.10), 0 10px 22px rgba(2,6,23,.06);
      background: rgba(124,58,237,.10);
    }

    .centreHero{
      margin: 12px;
      border:1px solid var(--stroke);
      border-radius: 18px;
      overflow:hidden;
      position:relative;
      height: 250px;
      background: rgba(255,255,255,.60);
      box-shadow: var(--shadow);
    }
    .centreHero img{ width:100%; height:100%; object-fit:cover; display:block; filter:saturate(1.02) contrast(1.02); transition: opacity .5s ease; }
    .centreHero:before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.30), rgba(255,255,255,.78));
      z-index:2;
    }
    .centreHeroContent{
      position:absolute; inset:0; z-index:3;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      text-align:center; padding: 14px; gap:10px;
    }
    .centreHeroContent .h{
      font-size: 20px; font-weight: 950; letter-spacing:.14em; text-transform: uppercase;
      color: rgba(15,23,42,.95);
      text-shadow: 0 12px 36px rgba(2,6,23,.12);
    }
    .centreHeroContent .p{
      max-width: 520px; font-size: 12px;
      color: rgba(15,23,42,.74);
      letter-spacing:.08em; text-transform: uppercase; line-height: 1.5;
      text-shadow: 0 12px 36px rgba(2,6,23,.10);
    }
    .centreHeroContent .tag{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(15,23,42,.92);
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }

    .pkgList{
      padding: 12px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      background: rgba(255,255,255,.40);
      flex:1;
    }

    .pkgGroupHdr{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .pkgGroupHdr .h1{
      font-size: 11px;
      font-weight: 950;
      letter-spacing:.12em;
      text-transform: uppercase;
      display:flex; align-items:center; gap:10px;
    }
    .pkgGroupHdr .h1:before{
      content:"";
      width:10px; height:10px; border-radius: 999px;
      background: rgba(6,182,212,.75);
      box-shadow: 0 0 0 4px rgba(6,182,212,.10);
      display:inline-block;
    }
    .pkgGroupHdr .h2{
      margin-top:6px; font-size: 10.5px; color: rgba(15,23,42,.66);
      letter-spacing:.08em; text-transform: uppercase; line-height: 1.35;
    }

    .pkgW{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      border-radius: 16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      box-shadow: 0 12px 30px rgba(2,6,23,.08);
    }
    .pkgW:hover{
      transform: translateY(-1px);
      border-color: rgba(124,58,237,.30);
      background: rgba(255,255,255,.82);
    }
    .pkgW.active{
      border-color: rgba(124,58,237,.38);
      box-shadow: 0 0 0 3px rgba(124,58,237,.10), 0 14px 34px rgba(2,6,23,.10);
    }

    .pkgWTop{ display:flex; gap:10px; padding:10px; align-items:stretch; }
    .pkgThumb{
      width:86px; height:86px;
      border-radius: 14px; overflow:hidden;
      border:1px solid var(--stroke);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(124,58,237,.10));
      flex: 0 0 auto;
      display:grid; place-items:center;
      color: rgba(15,23,42,.92);
    }
    .pkgThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pkgThumb .ini{ font-weight:950; letter-spacing:.08em; }

    .pkgWBody{ flex:1; min-width:0; display:flex; flex-direction:column; justify-content:space-between; gap:8px; }
    .pkgWTitle{ display:flex; align-items:center; gap:8px; min-width:0; }
    .pkgWTitle .mainT{
      font-size: 12px; font-weight: 950;
      letter-spacing:.10em; text-transform: uppercase;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      flex:1;
      color: rgba(15,23,42,.95);
    }
    .pkgBadge{
      flex:0 0 auto;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(15,23,42,.80);
      white-space: nowrap;
    }
    .pkgBadge.purple{ border-color: rgba(124,58,237,.28); background: rgba(124,58,237,.10); }
    .pkgBadge.green{ border-color: rgba(34,197,94,.22); background: rgba(34,197,94,.10); }

    .pkgWMeta{ display:flex; gap:8px; flex-wrap:wrap; }
    .pkgChip{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      border-radius: 999px;
      padding: 6px 9px;
      font-size: 10px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(15,23,42,.70);
      display:inline-flex; gap:6px; align-items:center;
    }
    .pkgChip b{ color: rgba(15,23,42,.95); letter-spacing:.06em; }
    .pkgChip .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .pkgWBottom{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding: 9px 10px;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.62);
    }
    .pkgHint{
      font-size: 10.5px; color: rgba(15,23,42,.62);
      letter-spacing:.04em;
      white-space: nowrap; overflow:hidden; text-overflow: ellipsis;
      flex:1; min-width:0;
    }
    .pkgCTA{
      flex:0 0 auto;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      color: rgba(15,23,42,.92);
      border-radius: 12px;
      padding: 7px 10px;
      font-size: 10px;
      letter-spacing:.12em;
      text-transform: uppercase;
      font-weight: 950;
      white-space: nowrap;
      box-shadow: 0 10px 22px rgba(2,6,23,.06);
    }

    .pkgDetails{
      display:none;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.55);
      padding: 12px;
    }
    .pkgW.active .pkgDetails{ display:block; }

    .detailsGrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .detailsCard{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 12px 28px rgba(2,6,23,.06);
    }
    .bigTitle{ margin:0; font-size: 12px; letter-spacing:.18em; text-transform: uppercase; color: rgba(15,23,42,.95); }
    .muted{ color: var(--muted); font-size: 10.8px; letter-spacing:.08em; text-transform: uppercase; line-height:1.35; }
    .mini{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      border-radius: 14px;
      padding: 9px;
      box-shadow: 0 10px 24px rgba(2,6,23,.05);
    }
    .mini .k{ font-size: 10px; letter-spacing:.16em; text-transform: uppercase; color: rgba(15,23,42,.62); }
    .mini .v{ margin-top:5px; font-size: 13px; font-weight: 950; letter-spacing:.06em; color: rgba(15,23,42,.95); }
    .mini .v small{ font-size: 10.5px; color: rgba(15,23,42,.64); font-weight: 800; }

    .enqRow{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .enqBtn{
      flex:1;
      border:1px solid rgba(34,197,94,.25);
      background: rgba(34,197,94,.12);
      color: rgba(15,23,42,.92);
      border-radius: 14px;
      padding: 10px 10px;
      text-decoration:none;
      text-transform: uppercase;
      letter-spacing:.10em;
      font-weight: 950;
      font-size: 11px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      user-select:none;
      box-shadow: 0 12px 28px rgba(2,6,23,.06);
    }
    .enqBtn.disabled{
      opacity:.55;
      pointer-events:none;
      border-color: rgba(15,23,42,.14);
      background: rgba(255,255,255,.60);
    }

    .daysList{ display:flex; flex-direction:column; gap:9px; margin-top:10px; }
    .dayCard{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.74);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .dayTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom: 7px; }
    .dayTop .d{ font-size: 11px; font-weight: 950; letter-spacing:.18em; text-transform: uppercase; color: rgba(15,23,42,.95); }

    .placeLine{
      display:flex; align-items:center; gap:9px;
      padding: 7px 9px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.82);
      border-radius: 12px;
      margin-top: 7px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
    }
    .thumb{
      width:36px; height:36px; border-radius: 11px;
      border:1px solid var(--stroke);
      overflow:hidden;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(6,182,212,.10));
      flex:0 0 auto; display:grid; place-items:center;
      font-weight:950; color: rgba(15,23,42,.88); font-size: 11px;
    }
    .pinfo{ min-width:0; flex:1; }
    .pname{
      font-size: 11px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase;
      white-space:nowrap; overflow:hidden; text-overflow: ellipsis;
      color: rgba(15,23,42,.95);
    }
    .pmeta{
      margin-top:3px; font-size: 10px; letter-spacing:.12em; text-transform: uppercase;
      color: rgba(15,23,42,.62);
      white-space:nowrap; overflow:hidden; text-overflow: ellipsis;
    }

    .mapPane{ position: sticky; top: 12px; height: calc(100vh - 24px); min-height: 620px; max-height: 920px; }
    #map{
      width:100%;
      flex:1;
      min-height: 520px;
      background: rgba(255,255,255,.70);
    }
    .mapTools{
      padding: 10px 12px;
      border-top:1px solid var(--stroke);
      display:flex; gap:8px; flex-wrap:wrap;
      background: rgba(255,255,255,.60);
    }
    .toolBtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      color: rgba(15,23,42,.86);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 10.5px;
      letter-spacing:.12em;
      text-transform: uppercase;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none; white-space: nowrap; text-decoration:none;
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
    }

    .botToast{
      position:fixed; left: 14px; bottom: 14px; z-index: 9999;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.84);
      border-radius: 14px;
      padding: 10px 12px;
      color: rgba(15,23,42,.86);
      font-size: 11px;
      letter-spacing:.06em;
      box-shadow: 0 22px 70px rgba(2,6,23,.12);
      display:none;
      max-width: 560px;
    }
    .botToast.show{ display:block; }

    .waFloat{
      position:fixed; right: 14px; bottom: 14px; z-index: 10000;
      display:flex; align-items:center; gap:10px; padding: 12px 14px;
      border-radius: 999px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      box-shadow: 0 22px 70px rgba(2,6,23,.12);
      color: rgba(15,23,42,.92);
      text-decoration:none;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .waIcon{
      width:40px; height:40px; border-radius: 999px; display:grid; place-items:center;
      background: rgba(34,197,94,.14);
      border:1px solid rgba(34,197,94,.22);
      flex:0 0 auto;
    }
    .waText{ display:flex; flex-direction:column; line-height:1.1; min-width:0; }
    .waText .t1{ font-size: 12px; font-weight: 950; letter-spacing:.10em; text-transform: uppercase; white-space:nowrap; color: rgba(15,23,42,.92); }
    .waText .t2{ margin-top:4px; font-size: 11px; color: rgba(15,23,42,.68); letter-spacing:.04em; white-space:nowrap; }
    .waClose{
      width:34px; height:34px; border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.84);
      color: rgba(15,23,42,.9);
      display:grid; place-items:center;
      cursor:pointer; flex:0 0 auto; user-select:none;
    }
    @media (max-width: 460px){ .waText{ display:none; } .waFloat{ padding: 10px; } .waClose{ display:none; } }

    @media (max-width: 1200px){
      .main{ grid-template-columns: 1fr; }
      .mapPane{ position:relative; top:auto; height:520px; max-height:none; }
      #map{ min-height: 420px; }
      .pane{ min-height: unset; }
    }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="noise"></div>

  <!-- WhatsApp Floating CTA -->
  <a
    class="waFloat"
    id="waFloat"
    href="https://wa.me/917018138847?text=Hi%20Chandan%2C%20I%20want%20to%20book%20a%20Himachal%20tour%20package."
    target="_blank" rel="noopener"
    aria-label="Chat on WhatsApp with Chandan Panwar"
  >
    <div class="waIcon" aria-hidden="true">
      <svg width="22" height="22" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M16 3C9.1 3 3.5 8.3 3.5 14.9c0 2.5.8 4.8 2.2 6.7L4 29l7.6-1.9c1.8 1 3.9 1.6 6.4 1.6 6.9 0 12.5-5.3 12.5-11.9S22.9 3 16 3z" fill="rgba(34,197,94,.15)"/>
        <path d="M16.1 6.1c-5.1 0-9.2 3.9-9.2 8.8 0 1.9.6 3.6 1.7 5.1l-1.1 4 4.2-1.1c1.4.8 3.1 1.3 4.9 1.3 5.1 0 9.2-3.9 9.2-8.8s-4.1-8.8-9.2-8.8z" fill="rgba(34,197,94,.18)"/>
        <path d="M23 19.1c-.3.8-1.6 1.5-2.2 1.6-.6.1-1.3.2-2.2-.1-.5-.2-1.2-.4-2-.8-3.5-1.9-5.7-5-5.9-5.3-.2-.3-1.4-1.8-1.4-3.5 0-1.7.9-2.5 1.2-2.9.3-.3.7-.4.9-.4h.7c.2 0 .5-.1.7.5.2.6.9 2.1 1 2.3.1.2.1.5 0 .7-.1.2-.2.4-.4.6-.2.2-.3.3-.5.5-.2.2-.4.4-.2.8.2.4.8 1.3 1.7 2.1 1.2 1.1 2.2 1.4 2.6 1.6.3.2.6.1.8-.1.2-.2 1-1.1 1.2-1.5.2-.4.5-.3.8-.2.3.1 2 .9 2.3 1 .3.1.5.2.6.4.1.1.1.8-.2 1.6z" fill="rgba(15,23,42,.92)"/>
      </svg>
    </div>
    <div class="waText">
      <div class="t1">WhatsApp</div>
      <div class="t2">Chat for booking</div>
    </div>
    <div class="waClose" id="waClose" title="Hide" aria-label="Hide WhatsApp button">‚úï</div>
  </a>

  <div class="shell">
    <!-- HERO -->
    <div class="hero">
      <img src="./hero.jpg" alt="Himachal Explorer Hero" onerror="this.style.display='none';">
      <div class="heroInner">
        <div class="heroBrand">
          <div class="logo">
            <img src="logo.png" alt="Logo" onerror="this.remove(); this.parentNode.textContent='HP';">
          </div>
          <div>
            <div class="heroTitle">Himachal Explorer Portal</div>
            <div class="heroSub" id="statusLine">Loading‚Ä¶</div>
          </div>
        </div>

        <div class="heroRight">
          <div class="chip primary" id="mintLoginBtn">Mint Login</div>
          <div class="chip" id="refreshBtn">Refresh</div>
          <div class="chip" id="fitMapBtn">Fit Route</div>
          <div class="chip" id="clearRouteBtn">Clear</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <!-- LEFT -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Filters</p>
            <div class="s">Start + Days match</div>
          </div>
          <div class="s" id="leftHint">Quick selection</div>
        </div>

        <div class="sideInner">
          <div class="sideCard">
            <div class="field">
              <label>Start</label>
              <input id="startInp" list="startList" placeholder="E.g. AMRITSAR / DELHI / CHANDIGARH" autocomplete="off">
              <datalist id="startList"></datalist>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Visit Type</label>
              <select id="visitType">
                <option value="budget">BUDGET</option>
                <option value="premium">PREMIUM</option>
                <option value="luxury">LUXURY</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Days (Required for match)</label>
              <select id="daysSel">
                <option value="">ANY</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                <option>11</option><option>12</option>
              </select>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Pax</label>
              <select id="paxSel">
                <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
              </select>
            </div>

            <div class="btnRow">
              <button class="btn secondary" id="resetBtn" type="button">Reset</button>
              <button class="btn" id="genBtn" type="button">Generate</button>
            </div>

            <div class="pills" id="pills"></div>
          </div>

          <div class="otherWrap">
            <div class="otherHdr">
              <div class="h">Other Packages</div>
              <div class="xBtn" id="closeSelectedBtn" title="Close selected package">Close</div>
            </div>
            <div class="otherList" id="otherPkgList">
              <div class="otherHint">
                Select a package in the center. <br>
                After selection, all remaining packages will appear here (clickable).
              </div>
            </div>
          </div>

          <div class="sideCard">
            <div class="muted" style="text-transform:none;letter-spacing:.02em;">
              Tip: Select <b>Start</b>, optionally <b>Days</b>, then click <b>Generate</b>.
              Pricing is pulled from Firebase as per-person final amount and multiplied by Pax.
            </div>
          </div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="pane">
        <div class="paneHdr">
          <div>
            <p class="t">Packages</p>
            <div class="s" id="centerHint">Click a card ‚Üí details open under it</div>
          </div>
          <div class="s" id="pkgCount">‚Äî</div>
        </div>

        <div class="centerInner">
          <div class="districtBar" id="districtBar"></div>

          <div class="centreHero" id="centreHero">
            <img id="centreHeroImg" src="./kinnaur-kailash.webp" alt="Himachal Pradesh" onerror="this.src='./n1.jpg'">
            <div class="centreHeroContent">
              <div class="tag">Himachal Explorer Portal</div>
              <div class="h">Discover Himachal Pradesh</div>
              <div class="p">Mountains ‚Ä¢ Valleys ‚Ä¢ Temples ‚Ä¢ Treks ‚Ä¢ Hidden Places ‚Ä¢ Road Trips</div>
              <div class="tag">Select Start ‚Üí Generate ‚Üí Open any package</div>
            </div>
          </div>

          <div class="pkgList" id="pkgList">
            <div class="pill"><b>Type Start</b> then click <b>Generate</b></div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="pane mapPane">
        <div class="paneHdr">
          <div>
            <p class="t">Live Route Map</p>
            <div class="s">OSRM road polyline + markers</div>
          </div>
          <div class="s" id="kmBadge">‚Äî</div>
        </div>

        <div id="map"></div>

        <div class="mapTools">
          <div class="toolBtn" id="showAllStopsBtn">Show Stops</div>
          <div class="toolBtn" id="showStartEndBtn">Start/End Only</div>
          <div class="toolBtn" id="toggleTilesBtn">Toggle Tiles</div>
        </div>
      </div>
    </div>
  </div>

  <div class="botToast" id="botToast">üëã Welcome! Select your <b>Start</b> and click <b>Generate</b>. Then open any package to see details.</div>

  <script>
    (function(){
      const KEY = "wa_float_hidden_v1";
      function apply(){
        const hidden = localStorage.getItem(KEY) === "1";
        const el = document.getElementById("waFloat");
        if(el) el.style.display = hidden ? "none" : "flex";
      }
      window.addEventListener("DOMContentLoaded", ()=>{
        const close = document.getElementById("waClose");
        if(close){
          close.addEventListener("click", (e)=>{
            e.preventDefault(); e.stopPropagation();
            localStorage.setItem(KEY, "1");
            apply();
          });
        }
        apply();
      });
    })();
  </script>

  <script>
  /* ===============================
     Firebase Config (revnue-records)
     =============================== */
  const firebaseConfig = {
    apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
    authDomain: "revnue-records.firebaseapp.com",
    databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "revnue-records",
    storageBucket: "revnue-records.firebasestorage.app",
    messagingSenderId: "182348503564",
    appId: "1:182348503564:web:480085405b09177245ac29",
    measurementId: "G-MGTDBCG896"
  };

  const NODE_TEMPLATES  = "templates";
  const NODE_PLACES     = "places_in_packages";
  const NODE_COSTS      = "package_cost_breakdown";

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg){ $("statusLine").textContent = msg; }
  function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function initials(name){
    const parts = String(name||"").trim().split(/\s+/).slice(0,2);
    const ini = parts.map(x=>x[0]).join("").toUpperCase();
    return ini || "HP";
  }
  function rupees(n){ return "‚Çπ" + Math.round(Number(n)||0).toLocaleString("en-IN"); }
  function slugifyName(name){
    return String(name||"")
      .trim().toLowerCase()
      .replace(/&/g," and ")
      .replace(/['"]/g,"")
      .replace(/[^a-z0-9]+/g,"-")
      .replace(/-+/g,"-")
      .replace(/^-|-$/g,"");
  }

  function showBot(msg){
    const el = $("botToast");
    if(!el) return;
    el.innerHTML = msg || "üëã Welcome!";
    el.classList.add("show");
    setTimeout(()=> el.classList.remove("show"), 5200);
  }

  /* Centre hero slideshow */
  const CENTRE_HERO_IMAGES = ["./kinnaur-kailash.webp","./n1.jpg","./temple.jpg","./trek.jpeg"];
  let heroIdx = 0;
  function startCentreHero(){
    const img = $("centreHeroImg");
    if(!img) return;
    setInterval(()=>{
      heroIdx = (heroIdx + 1) % CENTRE_HERO_IMAGES.length;
      img.style.opacity = 0;
      setTimeout(()=>{
        img.src = CENTRE_HERO_IMAGES[heroIdx];
        img.style.opacity = 1;
      }, 250);
    }, 4200);
  }

  /* Places helpers */
  function placeIdAny(p, key){ return String(p?.place_id || p?.id || key || "").trim(); }
  function placeNameAny(p, key){ return String(p?.name || p?.["Location Name"] || p?.title || key || "PLACE").trim(); }
  function latAny(p){ return Number(p?.latitude ?? p?.lat ?? p?.Latitude); }
  function lngAny(p){ return Number(p?.longitude ?? p?.lng ?? p?.Longitude); }
  function districtAny(p){ return String(p?.district || p?.District || "").trim().toUpperCase(); }

  /* ‚úÖ FIX for ‚ÄúPlaces not loading‚Äù
     Your templates may store place IDs with different casing/spaces OR sometimes store place names.
     We build a strong index so any of these forms will resolve. */
  let PLACES = {};                 // canonical by place_id
  let PLACE_INDEX = new Map();     // lower token -> canonical place_id

  function idxAdd(token, pid){
    const t = String(token||"").trim().toLowerCase();
    if(!t) return;
    if(!PLACE_INDEX.has(t)) PLACE_INDEX.set(t, pid);
  }

  function buildPlaceIndex(){
    PLACE_INDEX = new Map();
    for(const [pid, p] of Object.entries(PLACES||{})){
      idxAdd(pid, pid);                              // exact id
      idxAdd(pid.replace(/\s+/g,""), pid);           // id without spaces
      idxAdd(slugifyName(pid), pid);                 // slug(id)
      idxAdd(placeIdAny(p, pid), pid);               // place_id field
      idxAdd(slugifyName(placeIdAny(p, pid)), pid);
      const nm = placeNameAny(p, pid);
      idxAdd(nm, pid);                               // name
      idxAdd(slugifyName(nm), pid);                  // slug(name)
      idxAdd(nm.replace(/\s+/g,""), pid);            // name without spaces
    }
  }

  function resolvePlaceId(anyIdOrName){
    const raw = String(anyIdOrName||"").trim();
    if(!raw) return "";
    const k1 = raw.toLowerCase();
    const k2 = raw.replace(/\s+/g,"").toLowerCase();
    const k3 = slugifyName(raw);
    return PLACE_INDEX.get(k1) || PLACE_INDEX.get(k2) || PLACE_INDEX.get(k3) || "";
  }

  function getPlace(anyIdOrName){
    const pid = resolvePlaceId(anyIdOrName);
    return pid ? { pid, p: PLACES[pid] } : { pid:"", p:null };
  }

  /* Map */
  let map, tile, markersLayer, routeLine;
  let showMode = "all";
  let tilesDark = false;

  function invalidateMapSoon(){
    try{
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 60);
      setTimeout(()=>{ map && map.invalidateSize && map.invalidateSize(true); }, 260);
    }catch(e){}
  }
  function initMap(){
    if(!window.L){
      setStatus("Leaflet not loaded (check network)");
      showBot("‚ùå Leaflet not loaded.");
      return;
    }
    map = L.map('map', { zoomControl:true }).setView([31.1048, 77.1734], 8);
    tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
    tile.addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    invalidateMapSoon();
    window.addEventListener("resize", invalidateMapSoon);
  }
  function clearMap(){
    markersLayer && markersLayer.clearLayers();
    if(routeLine && map){ map.removeLayer(routeLine); routeLine = null; }
    $("kmBadge").textContent = "‚Äî";
    invalidateMapSoon();
  }
  function fitRoute(){ if(routeLine && map) map.fitBounds(routeLine.getBounds(), { padding:[22,22] }); }

  /* Data */
  let db, analytics, auth;
  let TEMPLATES = {};
  let ACTIVE_TEMPLATES = [];
  let STARTS = [];

  let COSTS = {};
  let INTER_ALL = [];
  let DISTRICT_KEYS = [];
  let ACTIVE_DISTRICT = "ALL";
  let CURRENT_TEMPLATE_KEY = "";
  let CURRENT_ROUTE_KM = 0;

  const WHATSAPP_NUMBER = "917018138847";

  function setCentreHeroVisible(on){
    const hero = $("centreHero");
    if(!hero) return;
    hero.style.display = on ? "block" : "none";
  }

  function buildStartList(templates){
    const set = new Set();
    templates.forEach(t=>{
      const s = String(t.start_point || t.start || "").trim();
      if(s) set.add(s);
    });
    STARTS = Array.from(set).sort((a,b)=>a.localeCompare(b));
    const dl = $("startList");
    dl.innerHTML = "";
    STARTS.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = String(s).toUpperCase();
      dl.appendChild(opt);
    });
  }

  function normalizeStartInput(){
    const typed = String($("startInp").value || "").trim().toUpperCase();
    if(!typed) return "";
    const exact = STARTS.find(s => String(s).trim().toUpperCase() === typed);
    if(exact) return exact;
    const partial = STARTS.find(s => String(s).trim().toUpperCase().startsWith(typed));
    if(partial) return partial;
    return "";
  }

  function getSelectedPax(){
    const v = Number($("paxSel")?.value || 2);
    return (isFinite(v) && v > 0) ? v : 2;
  }

  function stopsFromTemplate(tpl){
    const days = Number(tpl.days || 1);
    const out = [];
    const seen = new Set();

    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      if(!raw) continue;
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
        const resolved = resolvePlaceId(pid) || pid; // ‚úÖ resolve to canonical if possible
        if(seen.has(resolved)) return;
        seen.add(resolved);
        out.push(resolved);
      });
    }
    if(!out.length){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
        const resolved = resolvePlaceId(pid) || pid;
        out.push(resolved);
      });
    }
    return out;
  }

  function routeIdsFromTemplateIncludingStart(tpl){
    const baseStops = stopsFromTemplate(tpl);

    // ‚úÖ Start can be saved as city name; resolve it too
    const startName = String(tpl?.start_point || tpl?.start || "").trim();
    const startPid = resolvePlaceId(startName);
    if(startPid){
      const filtered = baseStops.filter(x => x !== startPid);
      return [startPid, ...filtered];
    }
    return baseStops;
  }

  function getEndNameFromRoutePath(tpl){
    const start = String(tpl.start_point || tpl.start || "").trim().toLowerCase();
    const rpRaw = String(tpl.route_path || "").trim();
    if(!rpRaw) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";

    const tokens = rpRaw.replace(/->/g,"|").replace(/>/g,"|")
      .split("|").map(x=>String(x||"").trim()).filter(Boolean);
    if(!tokens.length) return String(tpl.end_point || tpl.end || "").trim() || "UNKNOWN";

    let end = tokens[tokens.length - 1];
    if(end && start && end.toLowerCase() === start && tokens.length >= 2) end = tokens[tokens.length - 2];
    return end || "UNKNOWN";
  }

  function endDistrictFromTemplate(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const { pid, p } = getPlace(endName);
    if(pid && p){
      const d = districtAny(p);
      if(d) return d;
    }
    const td = String(tpl.district || tpl.end_district || "").trim().toUpperCase();
    if(td) return td;
    return String(endName || "UNKNOWN").trim().toUpperCase();
  }

  function endKeyFromRoutePath(tpl){
    const endName = getEndNameFromRoutePath(tpl);
    const { pid, p } = getPlace(endName);
    if(pid && p){
      const d = districtAny(p);
      return d || String(endName).trim().toUpperCase();
    }
    return String(endName).trim().toUpperCase();
  }

  function isLocalComputed(tpl){
    const routeId = String(tpl.route_id || "").toUpperCase().trim();
    const regionStyle = String(tpl.region_style || "").toLowerCase().trim();
    const pkgId = String(tpl.package_id || tpl.key || "").toLowerCase();
    return regionStyle === "local" || routeId.endsWith("-LCL") || pkgId.includes("-local");
  }

  function matchesStart(tpl, startUpper){
    return String(tpl.start_point||tpl.start||"").trim().toUpperCase() === startUpper;
  }
  function matchesDaysOptional(tpl, daysFilter){
    if(!daysFilter) return true;
    return Number(tpl.days||0) === Number(daysFilter);
  }

  function renderDistrictChips(){
    const bar = $("districtBar");
    if(!bar) return;

    const chips = ["ALL", ...DISTRICT_KEYS];
    if(!ACTIVE_DISTRICT || !chips.includes(ACTIVE_DISTRICT)) ACTIVE_DISTRICT = "ALL";

    bar.innerHTML = chips.map(d=>{
      const active = (d===ACTIVE_DISTRICT) ? "active" : "";
      const label = (d==="ALL") ? "ALL DESTINATIONS" : d;
      const count = (d==="ALL") ? INTER_ALL.length : INTER_ALL.filter(t=>endDistrictFromTemplate(t)===d).length;
      return `<div class="distItem ${active}" data-d="${escapeHtml(d)}">${escapeHtml(label)} (${count})</div>`;
    }).join("");

    bar.querySelectorAll(".distItem").forEach(el=>{
      el.onclick = ()=>{ ACTIVE_DISTRICT = el.dataset.d || "ALL"; renderPanels(); };
    });
  }

  function highlightActiveCard(){
    document.querySelectorAll(".pkgW").forEach(x=>x.classList.toggle("active", x.dataset.key === CURRENT_TEMPLATE_KEY));
  }

  function approxKmFromTpl(t){
    const km = Number(t.total_km_est || t.estimated_drive_km || t.total_km || 0);
    return isFinite(km) && km>0 ? km : 0;
  }

  /* Final price (per person) */
  function getPerPersonPrice(tpl){
    const tier = String($("visitType")?.value || "budget").toLowerCase();
    const pid = String(tpl.package_id || tpl.key || "").trim();
    const node = COSTS?.[pid] || COSTS?.[String(pid).toLowerCase()] || null;
    const src = node || tpl || {};

    const b = Number(src.budget_price_per_person ?? src.budget ?? src.budget_pp ?? 0);
    const p = Number(src.premium_price_per_person ?? src.premium ?? src.premium_pp ?? 0);
    const l = Number(src.luxury_price_per_person ?? src.luxury ?? src.luxury_pp ?? 0);

    if(tier === "premium") return isFinite(p) && p>0 ? p : NaN;
    if(tier === "luxury")  return isFinite(l) && l>0 ? l : NaN;
    return isFinite(b) && b>0 ? b : NaN;
  }

  function buildWhatsAppMessage({tpl, startName, endKey, pax, tier, km, total, perPerson}){
    const days = Number(tpl?.days || 0) || 0;
    const code = String(tpl?.route_id || "‚Äî");
    const route = String(tpl?.route_path || "").trim();
    const includes = String(tpl?.includes || tpl?.inclusions || "").trim();

    const lines = [
      "Hi Chandan, I want to finalize this package:",
      "",
      `Start: ${String(startName||"").toUpperCase()}`,
      `Destination: ${String(endKey||"").toUpperCase()}`,
      `Days: ${days}`,
      `Type: ${String(tier||"").toUpperCase()}`,
      `Pax: ${pax}`,
      `Route KM (est.): ${isFinite(km)?Number(km).toFixed(1):"‚Äî"}`,
      `Per Person: ${isFinite(perPerson)?rupees(perPerson):"‚Äî"}`,
      `Total: ${isFinite(total)?rupees(total):"‚Äî"}`,
      `Code: ${code}`,
      route ? `Route: ${route}` : "",
      includes ? `Includes: ${includes}` : "",
      "",
      "Please confirm final price and availability."
    ].filter(Boolean);

    return lines.join("\n");
  }

  function setWhatsAppInline(btnEl, enabled, url){
    if(!btnEl) return;
    if(enabled){
      btnEl.classList.remove("disabled");
      btnEl.href = url || "#";
    }else{
      btnEl.classList.add("disabled");
      btnEl.href = "#";
    }
  }

  function buildDayWise(tpl){
    const days = Number(tpl.days || 1);
    const blocks = [];
    for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
      const k = `day${d}_place_ids`;
      const raw = String(tpl[k] || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      blocks.push({ day:d, ids });
    }
    const anyHas = blocks.some(x=>x.ids.length);
    if(!anyHas){
      const raw = String(tpl.major_place_ids || tpl.place_ids || "").trim();
      const ids = raw ? raw.split(",").map(x=>x.trim()).filter(Boolean) : [];
      return [{ day:1, ids }];
    }
    return blocks.filter(x=>x.ids.length);
  }

  function renderInlineDetails(detailsEl, tpl, startUpper, endKey, km){
    const pax = getSelectedPax();
    const tier = String($("visitType")?.value || "budget").toUpperCase();

    const perPerson = getPerPersonPrice(tpl);
    const total = isFinite(perPerson) ? (perPerson * pax) : NaN;

    const title = `${String(startUpper||"START").toUpperCase()} ‚Üí ${String(endKey||"").toUpperCase()}`;

    const metaParts = [];
    if(tpl.route_id) metaParts.push(`Code: ${tpl.route_id}`);
    if(tpl.route_path) metaParts.push(`Route: ${tpl.route_path}`);
    if(tpl.best_season) metaParts.push(`Season: ${tpl.best_season}`);
    if(tpl.ideal_for) metaParts.push(`Ideal: ${tpl.ideal_for}`);

    const inc = String(tpl.includes || tpl.inclusions || "").trim();
    const exc = String(tpl.excludes || tpl.exclusions || "").trim();
    const note = String(tpl.important_notes || tpl.notes || "").trim();

    const waBtnId = `wa_inline_${tpl.key}`;
    detailsEl.innerHTML = `
      <div class="detailsCard">
        <h3 class="bigTitle">${escapeHtml(title)}</h3>
        <div class="muted" style="margin-top:6px; text-transform:none; letter-spacing:.02em;">${escapeHtml(metaParts.join(" ‚Ä¢ ") || "‚Äî")}</div>

        <div class="enqRow">
          <a id="${waBtnId}" class="enqBtn disabled" href="#" target="_blank" rel="noopener">Send Query on WhatsApp</a>
        </div>
      </div>

      <div class="detailsGrid" style="margin-top:10px;">
        <div class="mini">
          <div class="k">Total (final)</div>
          <div class="v">${isFinite(total)?rupees(total):"‚Äî"} <small>(${escapeHtml(tier)})</small></div>
        </div>
        <div class="mini">
          <div class="k">Per Person (final)</div>
          <div class="v">${isFinite(perPerson)?rupees(perPerson):"‚Äî"} <small>per person</small></div>
        </div>
        <div class="mini">
          <div class="k">Pax used</div>
          <div class="v">${escapeHtml(String(pax))} <small>selected</small></div>
        </div>
        <div class="mini">
          <div class="k">Route KM</div>
          <div class="v">${isFinite(km)&&km>0?Number(km).toFixed(1):"‚Äî"} <small>estimated</small></div>
        </div>
      </div>

      <div class="detailsCard" style="margin-top:10px;">
        <div class="muted" style="margin-bottom:8px;">Package includes / excludes</div>
        <div class="muted" style="text-transform:none;letter-spacing:.02em;">
          <b style="color:rgba(15,23,42,.95);letter-spacing:.12em;">INCLUDES:</b> ${escapeHtml(inc || "‚Äî")}<br><br>
          <b style="color:rgba(15,23,42,.95);letter-spacing:.12em;">EXCLUDES:</b> ${escapeHtml(exc || "‚Äî")}<br><br>
          <b style="color:rgba(15,23,42,.95);letter-spacing:.12em;">NOTES:</b> ${escapeHtml(note || "‚Äî")}
        </div>
      </div>

      <div class="daysList" id="days_${tpl.key}" style="margin-top:10px;"></div>
    `;

    const startName = normalizeStartInput() || (tpl.start_point || tpl.start || startUpper || "");
    const msg = buildWhatsAppMessage({ tpl, startName, endKey, pax, tier, km, total, perPerson });
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
    setWhatsAppInline(document.getElementById(waBtnId), isFinite(perPerson), url);

    const daysWrap = document.getElementById(`days_${tpl.key}`);
    if(!daysWrap) return;

    const blocks = buildDayWise(tpl);
    blocks.forEach(block=>{
      const dayCard = document.createElement("div");
      dayCard.className = "dayCard";
      dayCard.innerHTML = `
        <div class="dayTop">
          <div class="d">Day ${block.day}</div>
          <div class="muted" style="text-transform:none;letter-spacing:.02em;">${block.ids.length} places</div>
        </div>
        <div class="muted" style="text-transform:none;letter-spacing:.02em;">Places</div>
        <div class="dayPlaces"></div>
      `;
      const cont = dayCard.querySelector(".dayPlaces");

      block.ids.forEach(rawPid=>{
        const { pid, p } = getPlace(rawPid); // ‚úÖ resolve id/name variations
        const name = p ? placeNameAny(p, pid) : String(rawPid || "Unknown").trim();
        const dist = p ? (districtAny(p) || "‚Äî") : "NOT FOUND IN PLACES DB";

        const line = document.createElement("div");
        line.className = "placeLine";
        line.innerHTML = `
          <div class="thumb">${escapeHtml(initials(name))}</div>
          <div class="pinfo">
            <div class="pname">${escapeHtml(name)}</div>
            <div class="pmeta">${escapeHtml(dist)}</div>
          </div>
        `;

        line.onclick = (e)=>{
          e.stopPropagation();
          if(!p) return showBot("‚ö†Ô∏è This place id/name is not found in places_in_packages. Check spelling / place_id.");
          const lat = latAny(p), lng = lngAny(p);
          if(isFinite(lat) && isFinite(lng) && map){
            map.setView([lat,lng], Math.max(map.getZoom(), 12), { animate:true });
            invalidateMapSoon();
          }
        };
        cont.appendChild(line);
      });

      daysWrap.appendChild(dayCard);
    });
  }

  function renderInterCard(t, startUpper){
    const days = Number(t.days||0) || 0;
    const endKey = endKeyFromRoutePath(t);
    const district = endDistrictFromTemplate(t);
    const code = String(t.route_id || "‚Äî").toUpperCase();
    const km = approxKmFromTpl(t);

    const el = document.createElement("div");
    el.className = "pkgW";
    el.dataset.key = t.key;

    el.innerHTML = `
      <div class="pkgWTop">
        <div class="pkgThumb"><div class="ini">${escapeHtml(initials(district))}</div></div>
        <div class="pkgWBody">
          <div class="pkgWTitle">
            <div class="mainT">${escapeHtml(startUpper)} ‚Üí ${escapeHtml(district)}</div>
            <div class="pkgBadge purple">${days}D</div>
            <div class="pkgBadge">${escapeHtml(String(endKey||"").toUpperCase())}</div>
          </div>

          <div class="pkgWMeta">
            <div class="pkgChip">Days <b>${days}</b></div>
            <div class="pkgChip">KM <b>${km ? km.toFixed(0) : "‚Äî"}</b></div>
            <div class="pkgChip">Code <b class="mono">${escapeHtml(code)}</b></div>
            <div class="pkgChip">ID <b class="mono">${escapeHtml(String(t.package_id || t.key || "‚Äî").toUpperCase())}</b></div>
          </div>
        </div>
      </div>

      <div class="pkgWBottom">
        <div class="pkgHint" title="${escapeHtml(String(t.route_path || ""))}">
          ${escapeHtml(String(t.route_path || "Tap to open details").slice(0, 90))}
        </div>
        <div class="pkgCTA">Open</div>
      </div>

      <div class="pkgDetails" id="details_${escapeHtml(t.key)}">
        <div class="pill"><b>Loading‚Ä¶</b></div>
      </div>
    `;

    el.onclick = ()=>toggleOpenTemplate(t.key);
    return el;
  }

  function renderLocalCard(t, startUpper){
    const days = Number(t.days||0) || 0;
    const heading = String(t.route_path || t.route_name || t.package_id || t.key || "Local Package").trim();
    const code = String(t.route_id || "LOCAL").toUpperCase();
    const km = approxKmFromTpl(t);

    const el = document.createElement("div");
    el.className = "pkgW";
    el.dataset.key = t.key;

    el.innerHTML = `
      <div class="pkgWTop">
        <div class="pkgThumb"><div class="ini">${escapeHtml(initials(heading))}</div></div>
        <div class="pkgWBody">
          <div class="pkgWTitle">
            <div class="mainT">${escapeHtml(heading)}</div>
            <div class="pkgBadge green">LOCAL</div>
            <div class="pkgBadge purple">${days}D</div>
          </div>

          <div class="pkgWMeta">
            <div class="pkgChip">Days <b>${days}</b></div>
            <div class="pkgChip">KM <b>${km ? km.toFixed(0) : "‚Äî"}</b></div>
            <div class="pkgChip">Code <b class="mono">${escapeHtml(code)}</b></div>
            <div class="pkgChip">ID <b class="mono">${escapeHtml(String(t.package_id || t.key || "‚Äî").toUpperCase())}</b></div>
          </div>
        </div>
      </div>

      <div class="pkgWBottom">
        <div class="pkgHint" title="${escapeHtml(String(t.route_path || ""))}">
          ${escapeHtml(String(t.route_path || "Tap to open details").slice(0, 90))}
        </div>
        <div class="pkgCTA">Open</div>
      </div>

      <div class="pkgDetails" id="details_${escapeHtml(t.key)}">
        <div class="pill"><b>Loading‚Ä¶</b></div>
      </div>
    `;

    el.onclick = ()=>toggleOpenTemplate(t.key);
    return el;
  }

  function getFilteredLists(){
    const start = normalizeStartInput() || "";
    const startUpper = String(start).trim().toUpperCase();
    const daysF = $("daysSel").value.trim();

    let shownInter = INTER_ALL.slice();
    if(ACTIVE_DISTRICT && ACTIVE_DISTRICT !== "ALL"){
      shownInter = shownInter.filter(t => endDistrictFromTemplate(t) === ACTIVE_DISTRICT);
    }

    const locals = ACTIVE_TEMPLATES
      .filter(t => isLocalComputed(t))
      .filter(t => matchesStart(t, startUpper))
      .filter(t => matchesDaysOptional(t, daysF))
      .filter(t => Number(t.days||0) > 0 && Number(t.days||0) <= 3)
      .sort((a,b)=>(Number(a.days)||0)-(Number(b.days)||0));

    return { startUpper, daysF, shownInter, locals };
  }

  function renderPanels(){
    const center = $("pkgList");
    const other = $("otherPkgList");

    const { startUpper, daysF, shownInter, locals } = getFilteredLists();
    const totalCount = shownInter.length + locals.length;
    $("pkgCount").textContent = `${totalCount} Results`;

    if(!startUpper){
      setCentreHeroVisible(true);
      CURRENT_TEMPLATE_KEY = "";
      center.innerHTML = `<div class="pill"><b>Type Start</b> then click <b>Generate</b></div>`;
      other.innerHTML = `
        <div class="otherHint">
          Select a package in the center. <br>
          After selection, all remaining packages will appear here (clickable).
        </div>`;
      return;
    }

    const allCards = [];
    shownInter.forEach(t => allCards.push({ t, kind:"inter" }));
    locals.forEach(t => allCards.push({ t, kind:"local" }));

    if(!CURRENT_TEMPLATE_KEY){
      setCentreHeroVisible(true);
      other.innerHTML = `<div class="otherHint">After you open a package, the remaining packages will move here.</div>`;

      center.innerHTML = "";
      const hdr1 = document.createElement("div");
      hdr1.className = "pkgGroupHdr";
      hdr1.innerHTML = `
        <div class="h1">${escapeHtml(startUpper)} ‚Ä¢ ${escapeHtml(daysF || "ANY")} DAYS</div>
        <div class="h2">Click a package ‚Üí per-person final price √ó pax shown inside.</div>
      `;
      center.appendChild(hdr1);

      if(!shownInter.length){
        const none = document.createElement("div");
        none.className = "pill";
        none.innerHTML = `<b>No inter-district package found for this Start + Days</b>`;
        center.appendChild(none);
      }else{
        shownInter.forEach(t => center.appendChild(renderInterCard(t, startUpper)));
      }

      if(locals.length){
        const hdr2 = document.createElement("div");
        hdr2.className = "pkgGroupHdr";
        hdr2.style.marginTop = "8px";
        hdr2.innerHTML = `
          <div class="h1">Local packages (‚â§ 3 Days)</div>
          <div class="h2">Short tours within district / nearby area</div>
        `;
        center.appendChild(hdr2);
        locals.forEach(t => center.appendChild(renderLocalCard(t, startUpper)));
      }

      highlightActiveCard();
      return;
    }

    setCentreHeroVisible(false);

    const selectedObj = allCards.find(x => x.t.key === CURRENT_TEMPLATE_KEY);
    const rest = allCards.filter(x => x.t.key !== CURRENT_TEMPLATE_KEY);

    center.innerHTML = "";
    if(!selectedObj){
      CURRENT_TEMPLATE_KEY = "";
      renderPanels();
      return;
    }

    const selHdr = document.createElement("div");
    selHdr.className = "pkgGroupHdr";
    selHdr.innerHTML = `
      <div class="h1">Selected Package</div>
      <div class="h2">Details stay here. Other packages moved to left panel.</div>
    `;
    center.appendChild(selHdr);

    const selCard = (selectedObj.kind === "local")
      ? renderLocalCard(selectedObj.t, startUpper)
      : renderInterCard(selectedObj.t, startUpper);

    selCard.classList.add("active");
    center.appendChild(selCard);

    other.innerHTML = "";
    if(!rest.length){
      other.innerHTML = `<div class="otherHint">No other packages in this filter.</div>`;
    }else{
      rest.forEach(obj=>{
        const c = (obj.kind === "local")
          ? renderLocalCard(obj.t, startUpper)
          : renderInterCard(obj.t, startUpper);
        other.appendChild(c);
      });
    }
    highlightActiveCard();
  }

  async function drawRoadRouteFromPlaces(placeIds){
    if(!markersLayer || !map) return { ok:false, km:0 };
    markersLayer.clearLayers();
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }

    const pts = [];
    const validIds = [];

    for(const raw of placeIds){
      const { pid, p } = getPlace(raw);
      if(!pid || !p) continue;
      const lat = latAny(p);
      const lng = lngAny(p);
      if(isFinite(lat) && isFinite(lng)){
        pts.push([lng,lat]);
        validIds.push(pid);
      }
    }

    if(pts.length < 2) return { ok:false, km:0 };

    const maxPts = 25;
    let used = pts;
    if(pts.length > maxPts){
      const step = Math.ceil(pts.length / maxPts);
      used = pts.filter((_,i)=> i%step===0 || i===pts.length-1);
    }

    try{
      const url =
        "https://router.project-osrm.org/route/v1/driving/" +
        used.map(c=>c.join(",")).join(";") +
        "?overview=full&geometries=geojson&steps=false";

      const res = await fetch(url);
      const data = await res.json();
      if(!data.routes?.length) return { ok:false, km:0 };

      const r = data.routes[0];
      const latlngs = r.geometry.coordinates.map(c=>[c[1],c[0]]);
      routeLine = L.polyline(latlngs, { weight: 5, opacity: .95 }).addTo(map);
      fitRoute();
      invalidateMapSoon();

      const markIds = (showMode==="startend")
        ? [validIds[0], validIds[validIds.length-1]]
        : validIds;

      for(const pid of markIds){
        const p = PLACES[pid];
        const lat = latAny(p);
        const lng = lngAny(p);
        if(!isFinite(lat)||!isFinite(lng)) continue;
        L.marker([lat,lng], { riseOnHover:true }).addTo(markersLayer);
      }

      const km = Number(r.distance/1000);
      $("kmBadge").textContent = km.toFixed(1) + " KM";
      return { ok:true, km };
    }catch(e){
      console.error(e);
      return { ok:false, km:0 };
    }
  }

  async function toggleOpenTemplate(key){
    const startUpper = String(normalizeStartInput() || "").toUpperCase();
    const same = (CURRENT_TEMPLATE_KEY === key);

    if(same){
      CURRENT_TEMPLATE_KEY = "";
      CURRENT_ROUTE_KM = 0;
      clearMap();
      setCentreHeroVisible(true);
      renderPanels();
      showBot("Closed package. Select another one.");
      return;
    }

    CURRENT_TEMPLATE_KEY = key;
    renderPanels();
    highlightActiveCard();

    const tpl = TEMPLATES[key];
    if(!tpl) return;

    const endKey = endKeyFromRoutePath(tpl);
    const routeIds = routeIdsFromTemplateIncludingStart(tpl);

    const detailsEl = document.getElementById(`details_${key}`);
    if(detailsEl){
      detailsEl.innerHTML = `<div class="pill"><b>Loading‚Ä¶</b> fetching road route + final price</div>`;
    }

    const rr = await drawRoadRouteFromPlaces(routeIds);
    CURRENT_ROUTE_KM = rr.ok ? rr.km : 0;

    let km = Number(CURRENT_ROUTE_KM || 0);
    if(!isFinite(km) || km <= 0){
      km = Number(tpl.total_km_est || tpl.estimated_drive_km || tpl.total_km || 0);
    }

    if(detailsEl){
      renderInlineDetails(detailsEl, tpl, startUpper, endKey, km);
    }

    const card = document.querySelector(`#pkgList .pkgW[data-key="${CSS.escape(key)}"]`);
    if(card) card.scrollIntoView({ behavior:"smooth", block:"start" });

    // ‚úÖ show diagnostics for places resolving
    const unresolved = routeIds.filter(x => !resolvePlaceId(x));
    if(unresolved.length){
      showBot(`‚ö†Ô∏è Some place ids/names not found in <b>places_in_packages</b>:<br>${escapeHtml(unresolved.slice(0,6).join(", "))}${unresolved.length>6?"‚Ä¶":""}`);
    }else{
      showBot("‚úÖ Places loaded + route drawn.");
    }
  }

  function applyFilters(){
    const start = normalizeStartInput();
    const daysF = $("daysSel").value.trim();
    const pax   = getSelectedPax();
    const tier  = String($("visitType")?.value || "budget").toUpperCase();

    clearMap();
    CURRENT_TEMPLATE_KEY = "";
    CURRENT_ROUTE_KM = 0;
    setCentreHeroVisible(true);

    if(!start){
      showBot("‚ö†Ô∏è Start not found. Please type a Start exactly as saved in templates.");
      $("pkgList").innerHTML = `<div class="pill"><b>Start not found</b></div>`;
      $("otherPkgList").innerHTML = `<div class="otherHint">Select a valid Start and Generate.</div>`;
      $("pkgCount").textContent = "0 Results";
      return;
    }

    const startUpper = String(start).trim().toUpperCase();

    INTER_ALL = ACTIVE_TEMPLATES
      .filter(t => matchesStart(t, startUpper))
      .filter(t => matchesDaysOptional(t, daysF))
      .filter(t => !isLocalComputed(t))
      .sort((a,b)=>{
        const da = Number(a.days||0), db = Number(b.days||0);
        if(da !== db) return da - db;
        const kmA = Number(a.total_km_est || a.estimated_drive_km || a.total_km || 1e9);
        const kmB = Number(b.total_km_est || b.estimated_drive_km || b.total_km || 1e9);
        return kmA - kmB;
      });

    const set = new Set();
    INTER_ALL.forEach(t => set.add(endDistrictFromTemplate(t)));
    DISTRICT_KEYS = Array.from(set).sort((a,b)=>a.localeCompare(b));
    ACTIVE_DISTRICT = "ALL";
    renderDistrictChips();

    $("pills").innerHTML = "";
    const pillData = { START: startUpper, DAYS: (daysF ? daysF : "ANY"), TYPE: tier, INTER: INTER_ALL.length, PAX: pax };
    for(const [k,v] of Object.entries(pillData)){
      const div = document.createElement("div");
      div.className = "pill";
      div.innerHTML = `${escapeHtml(k)} <b>${escapeHtml(String(v))}</b>`;
      $("pills").appendChild(div);
    }

    renderPanels();
    showBot(`‚úÖ Loaded ${INTER_ALL.length} packages. Places DB: <b>${Object.keys(PLACES).length}</b>`);
  }

  /* Firebase Load */
  async function refreshAll(){
    try{
      setStatus("Loading live from Firebase‚Ä¶");

      const [tplSnap, placesSnap, costsSnap] = await Promise.all([
        db.ref(NODE_TEMPLATES).once("value"),
        db.ref(NODE_PLACES).once("value"),
        db.ref(NODE_COSTS).once("value").catch(()=>({ val:()=>({}) }))
      ]);

      TEMPLATES = tplSnap.val() || {};
      const rawPlaces = placesSnap.val() || {};
      COSTS = (costsSnap && typeof costsSnap.val==="function") ? (costsSnap.val() || {}) : {};

      // ‚úÖ canonicalize places into PLACES[place_id]
      PLACES = {};
      for(const [k,v] of Object.entries(rawPlaces)){
        if(v && typeof v === "object"){
          const pid = placeIdAny(v, k) || k;
          PLACES[String(pid).trim()] = { ...v, place_id: String(pid).trim() };
        }
      }

      // ‚úÖ critical: build lookup index (fixes ‚Äúplaces not loading‚Äù)
      buildPlaceIndex();

      ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
        .map(([key, obj]) => ({ key, ...(obj||{}) }))
        .filter(t => {
          const st = safeLower(t.status || "active");
          return st === "active" || st === "enabled" || st === "true";
        });

      buildStartList(ACTIVE_TEMPLATES);

      setStatus(`Loaded LIVE ‚Ä¢ ${ACTIVE_TEMPLATES.length} templates ‚Ä¢ ${Object.keys(PLACES).length} places ‚Ä¢ ${Object.keys(COSTS).length} cost items`);
      invalidateMapSoon();

      if($("pills").children.length){
        applyFilters();
      }else{
        $("districtBar").innerHTML = `<div class="distItem active">ALL DESTINATIONS (0)</div>`;
        $("pkgCount").textContent = "‚Äî";
      }
    }catch(err){
      console.error(err);
      const msg = String(err?.message || err || "Unknown error");
      const isDenied = msg.toLowerCase().includes("permission");
      setStatus("Firebase load error (rules / node names)");
      showBot(isDenied
        ? "‚ùå Permission denied. Fix RTDB Rules or login.<br>Try opening nodes: <b>/templates</b>, <b>/places_in_packages</b>"
        : "‚ùå Firebase load error. Check node names + internet.");
    }
  }

  async function mintLogin(){
    try{
      const u = auth.currentUser;
      if(u){
        await auth.signOut();
        $("mintLoginBtn").textContent = "Mint Login";
        showBot("Logged out");
        return;
      }
      const email = prompt("Mint Login - Enter Email:");
      if(!email) return showBot("Login cancelled");
      const pass = prompt("Enter Password:");
      if(!pass) return showBot("Login cancelled");

      await auth.signInWithEmailAndPassword(email.trim(), pass);
      const user = auth.currentUser;
      $("mintLoginBtn").textContent = user ? "Logout" : "Mint Login";
      showBot(user ? "Login successful" : "Logged in");
    }catch(e){
      console.error(e);
      showBot(e?.message || "Login failed");
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    startCentreHero();
    showBot("üëã Welcome! Select Start and click Generate.");

    if(!window.firebase){
      setStatus("Firebase not loaded (check network)");
      showBot("‚ùå Firebase not loaded. Check console/network.");
      return;
    }

    if(!firebase.apps.length){
      firebase.initializeApp(firebaseConfig);
    }else{
      try{ firebase.app(); }catch(_){ firebase.initializeApp(firebaseConfig); }
    }

    db = firebase.database();
    try{ analytics = firebase.analytics(); } catch(e){ analytics = null; }
    auth = firebase.auth();

    auth.onAuthStateChanged((user)=>{
      $("mintLoginBtn").textContent = user ? "Logout" : "Mint Login";
      if(user) setStatus(`Logged in: ${user.email} ‚Ä¢ Loading‚Ä¶`);
    });

    $("genBtn").addEventListener("click", applyFilters);
    $("startInp").addEventListener("keydown",(e)=>{ if(e.key==="Enter") applyFilters(); });

    $("closeSelectedBtn").addEventListener("click", ()=>{
      if(CURRENT_TEMPLATE_KEY) toggleOpenTemplate(CURRENT_TEMPLATE_KEY);
      else showBot("No package selected.");
    });

    $("resetBtn").addEventListener("click", ()=>{
      $("startInp").value="";
      $("visitType").value="budget";
      $("daysSel").value="";
      $("paxSel").value="2";
      $("pills").innerHTML="";
      $("pkgList").innerHTML = `<div class="pill"><b>Type Start</b> then click <b>Generate</b></div>`;
      $("districtBar").innerHTML = "";
      $("pkgCount").textContent="‚Äî";
      $("otherPkgList").innerHTML = `
        <div class="otherHint">
          Select a package in the center. <br>
          After selection, all remaining packages will appear here (clickable).
        </div>`;
      clearMap();
      CURRENT_TEMPLATE_KEY = "";
      CURRENT_ROUTE_KM = 0;
      INTER_ALL = [];
      DISTRICT_KEYS = [];
      ACTIVE_DISTRICT = "ALL";
      setCentreHeroVisible(true);
      showBot("Reset done");
      invalidateMapSoon();
    });

    $("fitMapBtn").addEventListener("click", ()=>{ fitRoute(); invalidateMapSoon(); });
    $("clearRouteBtn").addEventListener("click", ()=>{ clearMap(); showBot("Route cleared"); });

    $("refreshBtn").addEventListener("click", refreshAll);
    $("mintLoginBtn").addEventListener("click", mintLogin);

    $("showAllStopsBtn").addEventListener("click", async ()=>{
      showMode="all";
      showBot("Markers: all stops");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const routeIds = routeIdsFromTemplateIncludingStart(tpl);
        const rr = await drawRoadRouteFromPlaces(routeIds);
        CURRENT_ROUTE_KM = rr.ok ? rr.km : CURRENT_ROUTE_KM;
      }
    });

    $("showStartEndBtn").addEventListener("click", async ()=>{
      showMode="startend";
      showBot("Markers: start/end");
      if(CURRENT_TEMPLATE_KEY){
        const tpl = TEMPLATES[CURRENT_TEMPLATE_KEY];
        const routeIds = routeIdsFromTemplateIncludingStart(tpl);
        const rr = await drawRoadRouteFromPlaces(routeIds);
        CURRENT_ROUTE_KM = rr.ok ? rr.km : CURRENT_ROUTE_KM;
      }
    });

    $("toggleTilesBtn").addEventListener("click", ()=>{
      tilesDark = !tilesDark;
      try{
        map.removeLayer(tile);
        tile = tilesDark
          ? L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 })
          : L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 });
        tile.addTo(map);
      }catch(e){}
      showBot(tilesDark ? "Dark tiles on" : "Light tiles on");
      invalidateMapSoon();
    });

    $("paxSel")?.addEventListener("change", ()=>{
      if(CURRENT_TEMPLATE_KEY){
        const k = CURRENT_TEMPLATE_KEY;
        toggleOpenTemplate(k);
        setTimeout(()=>toggleOpenTemplate(k), 80);
      }else if($("pills").children.length){
        applyFilters();
      }
    });

    $("visitType")?.addEventListener("change", ()=>{
      if(CURRENT_TEMPLATE_KEY){
        const k = CURRENT_TEMPLATE_KEY;
        toggleOpenTemplate(k);
        setTimeout(()=>toggleOpenTemplate(k), 80);
      }else if($("pills").children.length){
        applyFilters();
      }
    });

    $("daysSel")?.addEventListener("change", ()=>{
      if($("pills").children.length) applyFilters();
    });

    initMap();
    setCentreHeroVisible(true);
    refreshAll();
  });
  </script>
</body>
</html>