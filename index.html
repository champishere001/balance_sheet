<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Packages Only</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --stroke: rgba(255,255,255,.16);
      --card: rgba(255,255,255,.08);
      --shadow: 0 20px 70px rgba(0,0,0,.55);
      --r2: 26px;
      --accent:#7aa7ff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(0,0,0,.62), rgba(0,0,0,.80)),
        url("Dark.jpg") center/cover no-repeat fixed;
      overflow-x:hidden;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:16px}

    .topBar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 0 6px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: rgba(255,255,255,.10) url("logo.png") center/cover no-repeat;
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .title{display:flex; flex-direction:column; line-height:1.1}
    .title b{font-size:16px}
    .title span{font-size:12px; color:var(--muted)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 430px 1fr;
      gap:12px;
      margin-top:10px;
    }

    .card{
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead h3{margin:0; font-size:14px}
    .cardBody{padding:12px 14px}

    /* Planner */
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px}
    select,input{
      width:100%;
      padding:11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
    }
    .btn{
      margin-top:10px;
      width:100%;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background: linear-gradient(180deg, rgba(122,167,255,.35), rgba(122,167,255,.16));
      color: var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .btn:active{transform: translateY(1px)}
    .note{font-size:12px; color:var(--muted); margin-top:8px}

    /* Packages list */
    .pkgList{display:grid; grid-template-columns: 1fr; gap:10px; margin-top:12px}
    .pkg{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)),
        url("Travelers.jpg") center/cover no-repeat;
      background-blend-mode: overlay;
      box-shadow: 0 14px 50px rgba(0,0,0,.35);
      overflow:hidden;
      cursor:pointer;
      position:relative;
    }
    .pkg:before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.78));
    }
    .pkg > *{position:relative}
    .pkgBody{padding:12px}
    .pkgTitle{font-weight:900; margin:0 0 6px}
    .pkgMeta{font-size:12px; color:rgba(255,255,255,.78)}
    .pkgLine{margin-top:8px; font-size:12px; color:rgba(255,255,255,.86); line-height:1.45}
    .pkgBtn{
      margin-top:10px;
      display:inline-flex;
      gap:8px; align-items:center;
      padding:9px 11px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      font-size:12px;
    }
    .pkg.active{
      border-color: rgba(122,167,255,.6);
      box-shadow: 0 0 0 3px rgba(122,167,255,.18), 0 14px 50px rgba(0,0,0,.35);
    }

    /* Right column */
    .rightCol{display:grid; gap:12px}

    /* Map smaller */
    #map{height:250px; width:100%}

    /* Route summary */
    .summaryGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      padding:10px 12px;
      min-height: 52px;
    }
    .kv .k{font-size:12px; color:var(--muted)}
    .kv .v{margin-top:4px; font-size:13px}

    /* Day-wise route details */
    .days{display:grid; grid-template-columns: 1fr; gap:10px}
    .day{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .dayTop{
      padding:10px 12px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .dayTop b{font-size:13px}
    .dayTop span{font-size:12px; color:var(--muted)}
    .dayPlaces{padding:10px 12px; display:flex; flex-wrap:wrap; gap:8px}
    .tag{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tag:hover{border-color: rgba(122,167,255,.45)}

    /* Taglines */
    .taglines{display:grid; grid-template-columns: 1fr; gap:10px}
    .tl{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)),
        url("201-himalaya.jpg") center/cover no-repeat;
      background-blend-mode: overlay;
      overflow:hidden;
      position:relative;
    }
    .tl:before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.85));
    }
    .tl > *{position:relative}
    .tlBody{padding:12px}
    .tlTitle{font-weight:900; margin:0 0 6px}
    .tlMeta{font-size:12px; color:rgba(255,255,255,.78)}
    .tlText{
      margin-top:8px;
      font-size:12px;
      line-height:1.55;
      color:rgba(255,255,255,.88);
      display:-webkit-box;
      -webkit-line-clamp:4;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .summaryGrid{grid-template-columns:1fr}
      #map{height:240px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topBar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <b>Himachal Explorer</b>
          <span>Templates-driven planner • Route-wise details • Taglines • Map</span>
        </div>
      </div>
      <div class="pill" id="statusPill">Loading Firebase…</div>
    </div>

    <div class="grid">
      <!-- LEFT: Planner + Packages -->
      <section class="card">
        <div class="cardHead">
          <h3>Package Planner (from TEMPLATES)</h3>
          <span class="pill" id="selPkgPill">No package selected</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <div>
              <label>Start</label>
              <select id="startSelect"></select>
            </div>
            <div>
              <label>End (depends on Start)</label>
              <select id="endSelect"></select>
            </div>
            <div>
              <label>Days</label>
              <input id="daysInput" type="number" min="1" max="15" value="3"/>
            </div>
            <div>
              <label>People</label>
              <input id="paxInput" type="number" min="1" max="24" value="4"/>
            </div>
          </div>

          <button class="btn" id="btnFindPkgs">Find Packages</button>
          <div class="note" id="plannerNote">
            Packages list is based on your Template sheet. Select a package to load map + route plan + taglines.
          </div>

          <div class="pkgList" id="pkgList"></div>
        </div>
      </section>

      <!-- RIGHT: Map + Route details + Taglines -->
      <section class="rightCol">
        <div class="card">
          <div class="cardHead">
            <h3>Map (smaller)</h3>
            <span class="pill" id="mapPill">Select a package</span>
          </div>
          <div id="map"></div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h3>Route details (from template)</h3>
            <span class="pill" id="routePill">No package</span>
          </div>
          <div class="cardBody">
            <div class="summaryGrid" id="summaryGrid">
              <div class="note">Select a package to view route_name, route_path, km, risks, season, etc.</div>
            </div>

            <div style="height:12px"></div>

            <div class="days" id="daysBox">
              <div class="note">Day-wise route plan will appear here after selecting a package.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="cardHead">
            <h3>Taglines (only selected package)</h3>
            <span class="pill" id="taglinePill">0</span>
          </div>
          <div class="cardBody">
            <div class="taglines" id="taglinesBox">
              <div class="note">No places are shown until a package is selected.</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    /************ Firebase Config ************/
    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /************ Helpers ************/
    const $ = (id)=>document.getElementById(id);
    const safe = (v)=> (v===undefined || v===null) ? "" : String(v);

    function parsePlaceIds(val){
      if(!val) return [];
      return String(val).split(/[;,|]/).map(v=>v.trim()).filter(Boolean);
    }
    function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }

    /************ DOM ************/
    const statusPill = $("statusPill");
    const selPkgPill = $("selPkgPill");
    const mapPill = $("mapPill");
    const routePill = $("routePill");

    const startSelect = $("startSelect");
    const endSelect = $("endSelect");
    const daysInput = $("daysInput");
    const paxInput = $("paxInput");
    const btnFindPkgs = $("btnFindPkgs");
    const plannerNote = $("plannerNote");

    const pkgList = $("pkgList");
    const summaryGrid = $("summaryGrid");
    const daysBox = $("daysBox");

    const taglinePill = $("taglinePill");
    const taglinesBox = $("taglinesBox");

    /************ Map ************/
    const map = L.map("map", { zoomControl:true }).setView([31.7, 77.2], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18, attribution: "&copy; OpenStreetMap"
    }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    function clearMap(){ markersLayer.clearLayers(); }
    function plotPlacesOnMap(places){
      clearMap();
      const bounds = [];
      places.forEach(p=>{
        const lat = Number(p.latitude), lng = Number(p.longitude);
        if(!isFinite(lat) || !isFinite(lng)) return;
        const m = L.marker([lat,lng]).addTo(markersLayer);
        m.bindPopup(`<b>${safe(p.name)}</b><br/><span style="color:#ccc">${safe(p.district)} • ${safe(p.segment)}</span>`);
        bounds.push([lat,lng]);
      });
      if(bounds.length){
        try{ map.fitBounds(bounds, {padding:[25,25]}); }catch(e){}
      }
    }

    /************ Data State ************/
    let PLACES_BY_ID = {};   // place_id -> place
    let TEMPLATES = [];      // templates array
    let START_TO_ENDS = {};  // start -> Set(ends)

    /************ Template-driven dropdowns ************/
    function buildStartEndIndex(){
      START_TO_ENDS = {};
      TEMPLATES.forEach(t=>{
        const s = safe(t.start_point).trim();
        const e = safe(t.end_point).trim();
        if(!s || !e) return;
        if(!START_TO_ENDS[s]) START_TO_ENDS[s] = new Set();
        START_TO_ENDS[s].add(e);
      });
    }

    function fillStartOptions(){
      const starts = Object.keys(START_TO_ENDS).sort();
      startSelect.innerHTML = `<option value="">All Starts</option>` + starts.map(s=>`<option value="${s}">${s}</option>`).join("");
      if(starts.length) startSelect.value = starts[0];
    }

    function fillEndOptionsForStart(startVal){
      const endsSet = startVal && START_TO_ENDS[startVal] ? START_TO_ENDS[startVal] : null;
      let ends = [];
      if(endsSet){
        ends = [...endsSet].sort();
      }else{
        // If "All Starts", show all ends
        const all = new Set();
        Object.values(START_TO_ENDS).forEach(set=>set.forEach(v=>all.add(v)));
        ends = [...all].sort();
      }
      endSelect.innerHTML = `<option value="">All Ends</option>` + ends.map(e=>`<option value="${e}">${e}</option>`).join("");
      if(ends.length) endSelect.value = ends[0];
    }

    /************ Package scoring ************/
    function templateScore(t){
      const days = Number(t.days||0);
      const km = Number(t.total_km_est||0);
      const active = safe(t.status).toLowerCase() !== "inactive";
      let s = 0;
      s += active ? 50 : 0;
      if(days>=2 && days<=6) s += 25;
      if(isFinite(km) && km>0) s += Math.max(0, 35 - km/35);
      return s;
    }

    /************ Render packages ************/
    function renderPackageList(list){
      if(!list.length){
        pkgList.innerHTML = `<div class="note">No packages match your filters.</div>`;
        return;
      }

      const top = [...list].sort((a,b)=>templateScore(b)-templateScore(a)).slice(0,12);

      pkgList.innerHTML = top.map(t=>{
        const majors = parsePlaceIds(t.major_place_ids).slice(0,6).join(", ");
        return `
          <div class="pkg" data-id="${safe(t.package_id)}">
            <div class="pkgBody">
              <div class="pkgTitle">${safe(t.route_name || t.package_id)}</div>
              <div class="pkgMeta">${safe(t.days)} days • ${safe(t.total_km_est || "")} km • ${safe(t.best_season || "")}</div>
              <div class="pkgLine"><b>Start:</b> ${safe(t.start_point)} &nbsp; <b>End:</b> ${safe(t.end_point)}</div>
              <div class="pkgLine"><b>Major:</b> ${safe(majors || "—")}</div>
              <div class="pkgBtn">Select package →</div>
            </div>
          </div>
        `;
      }).join("");

      [...pkgList.querySelectorAll(".pkg")].forEach(el=>{
        el.addEventListener("click", ()=>{
          [...pkgList.querySelectorAll(".pkg")].forEach(x=>x.classList.remove("active"));
          el.classList.add("active");
          selectPackage(el.getAttribute("data-id"));
        });
      });
    }

    /************ Filter packages by template fields ************/
    function filterPackagesByPlanner(){
      const start = safe(startSelect.value).trim();
      const end   = safe(endSelect.value).trim();
      const days  = Number(daysInput.value || 0);

      let list = [...TEMPLATES];

      if(days) list = list.filter(t => Number(t.days || 0) === days);
      if(start) list = list.filter(t => safe(t.start_point).trim() === start);
      if(end)   list = list.filter(t => safe(t.end_point).trim() === end);

      renderPackageList(list);

      plannerNote.textContent =
        `Showing ${list.length} template packages for Start="${start||"Any"}" End="${end||"Any"}" Days="${days||"Any"}". Select one to load details.`;
    }

    /************ Package -> Place IDs ************/
    function collectPackagePlaceIds(t){
      const ids = [];
      ids.push(...parsePlaceIds(t.major_place_ids));
      ids.push(...parsePlaceIds(t.day1_place_ids));
      ids.push(...parsePlaceIds(t.day2_place_ids));
      ids.push(...parsePlaceIds(t.day3_place_ids));
      ids.push(...parsePlaceIds(t.day4_place_ids));
      ids.push(...parsePlaceIds(t.day5_place_ids));
      ids.push(...parsePlaceIds(t.day6_place_ids));
      ids.push(...parsePlaceIds(t.day7_place_ids));
      ids.push(...parsePlaceIds(t.day8_place_ids));
      ids.push(...parsePlaceIds(t.day9_place_ids));
      return uniq(ids);
    }

    async function resolvePlacesByIds(ids){
      const list = [];
      const missing = [];

      ids.forEach(id=>{
        const p = PLACES_BY_ID[id];
        if(p) list.push(p);
        else missing.push(id);
      });

      if(missing.length){
        const snaps = await Promise.all(missing.slice(0,60).map(id => db.ref("places/"+id).get().catch(()=>null)));
        snaps.forEach((s,i)=>{
          if(s && s.exists()){
            const p = s.val() || {};
            p.place_id = missing[i];
            PLACES_BY_ID[p.place_id] = p;
            list.push(p);
          }
        });
      }

      return list;
    }

    /************ Route details + day plan + taglines ************/
    function renderSummary(t){
      const rows = [
        ["Route", safe(t.route_name || t.package_id)],
        ["Route Path", safe(t.route_path || "—")],
        ["Start → End", `${safe(t.start_point)} → ${safe(t.end_point)}`],
        ["Days", safe(t.days || "—")],
        ["Total KM", safe(t.total_km_est || "—")],
        ["Drive Level", safe(t.drive_level || "—")],
        ["Road Type", safe(t.road_type || "—")],
        ["Snow Risk", safe(t.snow_risk || "—")],
        ["Tempo OK", safe(t.tempo_ok || "—")],
        ["Best Season", safe(t.best_season || "—")],
        ["Ideal For", safe(t.ideal_for || "—")],
        ["Region Style", safe(t.region_style || "—")],
        ["Night Plan", safe(t.night_plan || "—")],
        ["Notes", safe(t.notes || "—")]
      ];

      summaryGrid.innerHTML = rows.map(([k,v])=>`
        <div class="kv">
          <div class="k">${k}</div>
          <div class="v">${v || "—"}</div>
        </div>
      `).join("");
    }

    function renderDayPlan(t){
      const days = Number(t.days || 0);
      const cols = ["day1_place_ids","day2_place_ids","day3_place_ids","day4_place_ids","day5_place_ids","day6_place_ids","day7_place_ids","day8_place_ids","day9_place_ids"];

      const html = [];
      for(let i=0; i<Math.min(9, Math.max(days, 1)); i++){
        const ids = parsePlaceIds(t[cols[i]]);
        if(!ids.length) continue;

        html.push(`
          <div class="day">
            <div class="dayTop">
              <b>Day ${i+1}</b>
              <span>${ids.length} stops</span>
            </div>
            <div class="dayPlaces">
              ${ids.map(pid=>{
                const p = PLACES_BY_ID[pid];
                const label = p ? safe(p.name) : pid;
                return `<div class="tag" data-pid="${pid}" title="${pid}">${label}</div>`;
              }).join("")}
            </div>
          </div>
        `);
      }

      if(!html.length){
        daysBox.innerHTML = `<div class="note">No day-wise places found. Check day1_place_ids…day9_place_ids in template.</div>`;
      }else{
        daysBox.innerHTML = html.join("");
        [...daysBox.querySelectorAll(".tag")].forEach(tag=>{
          tag.addEventListener("click", ()=>{
            const pid = tag.getAttribute("data-pid");
            const p = PLACES_BY_ID[pid];
            if(!p) return;
            const lat = Number(p.latitude), lng = Number(p.longitude);
            if(isFinite(lat) && isFinite(lng)) map.setView([lat,lng], 12);
          });
        });
      }
    }

    function renderTaglines(placesList){
      taglinePill.textContent = String(placesList.length);
      taglinesBox.innerHTML = placesList.slice(0, 18).map(p=>{
        const meta = [p.district, p.segment, p.category].filter(Boolean).join(" • ");
        const tl = safe(p.history_tagline || p.what_you_find || "—");
        return `
          <div class="tl">
            <div class="tlBody">
              <div class="tlTitle">${safe(p.name)}</div>
              <div class="tlMeta">${safe(meta)}</div>
              <div class="tlText">${tl}</div>
            </div>
          </div>
        `;
      }).join("") || `<div class="note">No places/taglines loaded for this package.</div>`;
    }

    /************ Select package ************/
    async function selectPackage(packageId){
      const t = TEMPLATES.find(x => safe(x.package_id) === safe(packageId));
      if(!t) return;

      selPkgPill.textContent = safe(t.route_name || t.package_id);
      mapPill.textContent = `Showing: ${safe(t.route_name || t.package_id)}`;
      routePill.textContent = `${safe(t.start_point)} → ${safe(t.end_point)}`;

      renderSummary(t);

      // collect ids + load only those places
      const ids = collectPackagePlaceIds(t);
      const placesList = await resolvePlacesByIds(ids);

      // update day plan labels now that cache is improved
      renderDayPlan(t);

      // taglines + map
      renderTaglines(placesList);
      plotPlacesOnMap(placesList);
    }

    /************ Load Firebase ************/
    async function loadAll(){
      statusPill.textContent = "Connecting…";

      const placesSnap = await db.ref("places").get();
      if(!placesSnap.exists()){
        statusPill.textContent = "No /places found";
        return;
      }
      const placesObj = placesSnap.val() || {};
      PLACES_BY_ID = {};
      Object.keys(placesObj).forEach(k=>{
        PLACES_BY_ID[k] = { place_id:k, ...placesObj[k] };
      });

      const tmplSnap = await db.ref("templates").get();
      const tmplObj = tmplSnap.exists() ? tmplSnap.val() : {};
      TEMPLATES = Object.keys(tmplObj).map(k => ({ package_id:k, ...tmplObj[k] }));

      buildStartEndIndex();
      fillStartOptions();
      fillEndOptionsForStart(startSelect.value);

      // initial list based on dropdown defaults
      filterPackagesByPlanner();

      // Reset right side (no auto-select)
      selPkgPill.textContent = "No package selected";
      mapPill.textContent = "Select a package";
      routePill.textContent = "No package";
      summaryGrid.innerHTML = `<div class="note">Select a package to view route details.</div>`;
      daysBox.innerHTML = `<div class="note">Select a package to view day-wise route plan.</div>`;
      taglinesBox.innerHTML = `<div class="note">No places are shown until a package is selected.</div>`;
      taglinePill.textContent = "0";
      clearMap();

      statusPill.textContent = "Firebase Loaded ✅";
    }

    /************ Events ************/
    btnFindPkgs.addEventListener("click", filterPackagesByPlanner);

    startSelect.addEventListener("change", ()=>{
      // dependent end dropdown
      fillEndOptionsForStart(startSelect.value);
      filterPackagesByPlanner();
    });
    endSelect.addEventListener("change", filterPackagesByPlanner);
    daysInput.addEventListener("change", filterPackagesByPlanner);

    loadAll().catch(err=>{
      console.error(err);
      statusPill.textContent = "Firebase error (check rules)";
    });
  </script>
</body>
</html>