<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Light Premium (Tiles + Selected/Package Only)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#f7f9ff; --bg1:#ffffff;
      --stroke:rgba(10,18,40,.10);
      --text:#0b1220;
      --muted:rgba(11,18,32,.64);
      --shadow: 0 20px 55px rgba(15,23,42,.10);
      --shadow2: 0 14px 28px rgba(15,23,42,.08);
      --r:18px; --r2:26px;
      --a:#2563eb; --b:#7c3aed;
      --max:1400px;

      /* Section background images */
      --bg-body: url("./201-himalaya.jpg");
      --bg-hero: url("./Kee_monastery.jpg");
      --bg-builder: url("./Travelers.jpg");
      --bg-tiles: url("./kinnaur-kailash.webp");
      --bg-map: url("./Dark.jpg");
      --bg-modal: url("./n1.jpg");
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 600px at 12% 10%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(900px 600px at 86% 16%, rgba(124,58,237,.14), transparent 60%),
        radial-gradient(900px 600px at 56% 92%, rgba(22,163,74,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
      position:relative;
    }

    /* Full-page scenic background */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-2;
      background: var(--bg-body) center/cover no-repeat fixed;
      filter:saturate(1.05);
      opacity:.22;
    }
    body::after{
      content:"";
      position:fixed; inset:0; z-index:-1;
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,.18);
      pointer-events:none;
    }

    a{color:inherit; text-decoration:none}

    .topbar{
      position:sticky; top:0; z-index:50;
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(14px);
      border-bottom:1px solid var(--stroke);
    }
    .inner{
      width:min(92vw, var(--max));
      margin:0 auto;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(124,58,237,.92));
      box-shadow: 0 12px 26px rgba(37,99,235,.18);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .logo img{width:100%; height:100%; object-fit:cover; display:block}
    .brand h1{margin:0; font-size:14px; line-height:1.1; letter-spacing:.2px}
    .brand small{display:block; color:var(--muted); font-weight:650; margin-top:2px}

    .nav{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.75);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      font-weight:850; font-size:12px;
      transition:.18s ease;
      cursor:pointer;
    }
    .pill:hover{transform: translateY(-1px)}
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: linear-gradient(135deg, var(--a), var(--b));
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:11px 14px; border-radius:14px;
      color:#fff;
      background: linear-gradient(135deg, rgba(37,99,235,.96), rgba(124,58,237,.92));
      box-shadow: 0 18px 42px rgba(37,99,235,.20);
      font-weight:900; font-size:12px;
      transition:.18s ease;
      display:inline-flex; align-items:center; gap:10px;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.ghost{
      color: var(--text);
      background: rgba(255,255,255,.78);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
    }
    .btn.bad{
      background: linear-gradient(135deg, rgba(239,68,68,.95), rgba(244,63,94,.88));
      box-shadow: 0 18px 42px rgba(239,68,68,.20);
    }

    /* Image Type Dropdown */
    .typePick{position:relative}
    .typePickBtn{
      width:100%;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      cursor:pointer;
      font-weight:900;
    }
    .typePickBtn img{
      width:34px; height:26px;
      border-radius:10px;
      object-fit:cover;
      border:1px solid var(--stroke);
      background: rgba(245,247,255,.9);
    }
    .typePickChev{margin-left:auto; opacity:.7; font-weight:950}

    .typePickMenu{
      position:absolute; left:0; right:0; top:calc(100% + 8px);
      background: rgba(255,255,255,.97);
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index:99;
    }
    .typePickMenu.open{display:block}

    .typePickItem{
      width:100%;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      background:transparent;
      border:0;
      cursor:pointer;
      font-weight:900;
      text-align:left;
    }
    .typePickItem:hover{background: rgba(37,99,235,.08)}
    .typePickItem img{
      width:34px; height:26px;
      border-radius:10px;
      object-fit:cover;
      border:1px solid var(--stroke);
    }

    .wrap{
      width:min(92vw, var(--max));
      margin:0 auto;
      padding:18px 16px 44px;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:stretch;
      margin-top:10px;
    }
    @media(max-width:900px){ .hero{ grid-template-columns:1fr; } }

    .heroCard{
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-height:360px;
    }
    .heroCard::before{
      content:"";
      position:absolute; inset:0;
      background: var(--bg-hero) center/cover no-repeat;
      opacity:.18;
      transform: scale(1.02);
    }
    .heroCard::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(700px 420px at 20% 30%, rgba(37,99,235,.12), transparent 62%),
        radial-gradient(700px 420px at 78% 30%, rgba(124,58,237,.10), transparent 62%);
      mix-blend-mode:multiply;
      opacity:.85;
      pointer-events:none;
    }
    .heroInner{
      position:relative;
      padding:26px;
      display:flex;
      flex-direction:column;
      height:100%;
      justify-content:space-between;
      gap:16px;
      background:
        linear-gradient(120deg, rgba(255,255,255,.92), rgba(255,255,255,.60)),
        var(--bg-hero) center/cover no-repeat;
      border-radius: var(--r2);
    }
    .heroTitle{
      margin:0;
      font-size: clamp(28px,3.2vw,48px);
      letter-spacing:-.6px;
      line-height:1.05;
    }
    .heroSub{
      margin:10px 0 0;
      color: rgba(11,18,32,.70);
      font-weight:700;
      max-width:70ch;
    }

    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .chip{
      padding:8px 11px;
      border-radius:999px;
      background: rgba(255,255,255,.80);
      border:1px solid var(--stroke);
      font-weight:850;
      font-size:12px;
      box-shadow: var(--shadow2);
    }
    .chip i{
      font-style:normal;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(37,99,235,.10);
      margin-right:8px;
    }

    .finder{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 170px 170px 160px;
      gap:10px;
      align-items:end;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:11px; color:var(--muted); font-weight:900; letter-spacing:.25px}
    .input, .select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      color:var(--text);
      outline:none;
      font-weight:800;
      box-shadow: var(--shadow2);
    }
    .input::placeholder{color:rgba(11,18,32,.45)}
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    .panel{
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.80);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .panel.tripBuilder::before{
      content:"";
      position:absolute; inset:0;
      background: var(--bg-builder) center/cover no-repeat;
      opacity:.16;
      transform: scale(1.03);
      pointer-events:none;
    }
    .panelHead{
      position:relative;
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
    }
    .panelHead h3{margin:0; font-size:13px}
    .panelHead small{color:var(--muted); font-weight:800}

    .builder{
      position:relative;
      padding:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .bRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .helper{
      padding:12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: rgba(245,247,255,.75);
      color: rgba(11,18,32,.78);
      font-weight:750;
      font-size:12px;
      line-height:1.45;
    }
    .primaryLine{
      padding:12px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(124,58,237,.08));
      font-weight:900;
      font-size:12px;
    }

    /* Selected panel */
    .selectedPanel{
      padding:10px;
      border-radius:18px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.80);
      box-shadow: var(--shadow2);
    }
    .selTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .selChips{
      display:flex; gap:8px; flex-wrap:wrap;
      max-height:110px; overflow:auto;
      padding:4px;
    }
    .selChip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(245,247,255,.92);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:.14s ease;
    }
    .selChip:hover{transform: translateY(-1px)}
    .x{
      width:18px;height:18px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.85);
      font-weight:950;
      font-size:12px;
      opacity:.8;
    }

    .section{margin-top:18px; display:grid; grid-template-columns:1fr; gap:14px}
    .sectionTitle{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:8px 0 0;
    }
    .sectionTitle h2{margin:0; font-size:16px}
    .sectionTitle p{margin:0; color:var(--muted); font-weight:800; font-size:12px}

    .section.exploreBg{
      position:relative;
      border-radius: var(--r2);
      padding:2px;
    }
    .section.exploreBg::before{
      content:"";
      position:absolute; inset:0;
      background: var(--bg-tiles) center/cover no-repeat;
      opacity:.14;
      border-radius: var(--r2);
      pointer-events:none;
      transform: scale(1.01);
    }
    .section.exploreBg > *{ position:relative; }

    /* TYPE TILES */
    .typeTiles{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:1100px){ .typeTiles{grid-template-columns: repeat(4, minmax(0,1fr));} }
    @media(max-width:780px){ .typeTiles{grid-template-columns: repeat(2, minmax(0,1fr));} }
    .typeTile{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.86);
      border-radius: 20px;
      overflow:hidden;
      box-shadow: var(--shadow2);
      cursor:pointer;
      transition:.16s ease;
      position:relative;
    }
    .typeTile:hover{transform: translateY(-1px)}
    .typeTileImg{
      height:110px;
      width:100%;
      display:block;
      object-fit:cover;
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(124,58,237,.08));
    }
    .typeTileBody{
      padding:10px 12px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .typeTileBody b{font-size:12px}
    .typeTileBody span{font-size:12px; color:rgba(11,18,32,.62); font-weight:900}
    .typeTileHint{
      position:absolute; top:10px; left:10px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.88);
      font-weight:950;
      font-size:11px;
      box-shadow: var(--shadow2);
    }

    /* Map */
    .mapPanel{display:none; margin-top:14px; position:relative}
    .mapPanel::before{
      content:"";
      position:absolute; inset:0;
      background: var(--bg-map) center/cover no-repeat;
      opacity:.12;
      pointer-events:none;
      transform: scale(1.02);
    }
    #map{
      position:relative;
      width:100%;
      height: 460px;
      border-radius: var(--r2);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Modal */
    .modalWrap{
      display:none; position:fixed; inset:0;
      background:rgba(15,23,42,.35);
      backdrop-filter:blur(6px);
      padding:14px;
      z-index:70;
      align-items:center;
      justify-content:center;
    }
    .modalWrap::before{
      content:"";
      position:absolute; inset:0;
      background: var(--bg-modal) center/cover no-repeat;
      opacity:.10;
      pointer-events:none;
    }
    .modalWrap > *{position:relative}

    @media (max-width: 980px){
      .finder{grid-template-columns:1fr 1fr}
      .finder .field:nth-child(1){grid-column:1/-1}
      .finder .field:nth-child(4){grid-column:1/-1}
      #map{height:380px}
      .bRow{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <div class="logo">
          <img src="./logo.png" alt="Himachal Explorer" onerror="this.remove()">
        </div>
        <div>
          <h1>Himachal Explorer</h1>
          <small>selected/package only • tiles + map</small>
        </div>
      </div>

      <div class="nav">
        <a class="pill" href="#explore"><span class="dot"></span>Explore</a>
        <button class="btn ghost" id="openAI">AI Planner</button>
        <button class="btn" id="openAdmin">Admin</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <section class="hero">
      <div class="heroCard">
        <div class="heroInner">
          <div>
            <h2 class="heroTitle">Explore Himachal — Selected / Package only.</h2>
            <p class="heroSub">
              Nothing appears unless you <b>select places</b> or choose a <b>package</b>.
              Type tiles & map will show only those places.
            </p>

            <div class="chips">
              <div class="chip"><i>Control</i>Only selected/package</div>
              <div class="chip"><i>Fast</i>Firebase realtime</div>
              <div class="chip"><i>Clean</i>No long lists</div>
            </div>

            <div class="finder">
              <div class="field">
                <label>Search</label>
                <input class="input" id="q" placeholder="Example: Triund, Manimahesh, Kufri, Chandratal…"/>
              </div>

              <div class="field">
                <label>District</label>
                <select class="select" id="district">
                  <option value="all">All</option>
                </select>
              </div>

              <div class="field">
                <label>Type</label>
                <input type="hidden" id="type" value="all"/>

                <div class="typePick" id="typePick">
                  <button class="typePickBtn" id="typePickBtn" type="button">
                    <img id="typePickImg" src="./n1.jpg" alt="" />
                    <span id="typePickText">All</span>
                    <span class="typePickChev">▾</span>
                  </button>

                  <div class="typePickMenu" id="typePickMenu">
                    <button type="button" class="typePickItem" data-value="all" data-img="./n1.jpg">
                      <img src="./n1.jpg" alt="All"><span>All</span>
                    </button>
                    <button type="button" class="typePickItem" data-value="Destination" data-img="./Kee_monastery.jpg">
                      <img src="./Kee_monastery.jpg" alt="Destination"><span>Destination</span>
                    </button>
                    <button type="button" class="typePickItem" data-value="Temple" data-img="./temple.jpg">
                      <img src="./temple.jpg" alt="Temple"><span>Temple</span>
                    </button>
                    <button type="button" class="typePickItem" data-value="Lake" data-img="./201-himalaya.jpg">
                      <img src="./201-himalaya.jpg" alt="Lake"><span>Lake</span>
                    </button>
                    <button type="button" class="typePickItem" data-value="Trek" data-img="./trek.jpeg">
                      <img src="./trek.jpeg" alt="Trek"><span>Trek</span>
                    </button>
                    <button type="button" class="typePickItem" data-value="Hotel" data-img="./Travelers.jpg">
                      <img src="./Travelers.jpg" alt="Hotel"><span>Hotel</span>
                    </button>
                    <button type="button" class="typePickItem" data-value="Activity" data-img="./activity.jpg">
                      <img src="./activity.jpg" alt="Activity"><span>Activity</span>
                    </button>
                  </div>
                </div>
              </div>

              <div class="field">
                <label>Trip Days</label>
                <select class="select" id="days">
                  <option value="0">Any</option>
                  <option value="1">1–2 days</option>
                  <option value="3">3–4 days</option>
                  <option value="5">5–7 days</option>
                  <option value="8">8–12 days</option>
                </select>
              </div>
            </div>

            <div class="heroActions">
              <button class="btn" id="apply">Apply Filters</button>
              <button class="btn ghost" id="reset">Reset</button>
              <button class="btn ghost" id="showMapBtn">Show Map</button>
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap">
            <small style="color:rgba(11,18,32,.65); font-weight:800">Tip: click a Type tile to filter. Click chip to remove selection.</small>
            <small id="status" style="color:rgba(11,18,32,.65); font-weight:900">Loading…</small>
          </div>
        </div>
      </div>

      <div class="panel tripBuilder">
        <div class="panelHead">
          <h3>Trip Builder</h3>
          <small>packages + selections</small>
        </div>
        <div class="builder">
          <div class="primaryLine" id="builderLine">Pick preferences → Get Packages → Activate one → only those places show.</div>

          <div class="bRow">
            <div class="field">
              <label>People</label>
              <select class="select" id="people">
                <option value="solo">Solo</option>
                <option value="couple">Couple</option>
                <option value="family">Family</option>
                <option value="group">Group</option>
              </select>
            </div>
            <div class="field">
              <label>Budget</label>
              <select class="select" id="budget">
                <option value="low">Low</option>
                <option value="mid" selected>Mid</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>

          <div class="bRow">
            <div class="field">
              <label>Interest</label>
              <select class="select" id="interest">
                <option value="nature" selected>Nature + Views</option>
                <option value="temples">Temples + Culture</option>
                <option value="adventure">Adventure + Treks</option>
                <option value="relax">Relax + Stays</option>
              </select>
            </div>
            <button class="btn" id="makePackages">Get Packages</button>
          </div>

          <div class="helper" id="packagesBox">
            Click <b>Get Packages</b> — packages will appear here (click Activate).
          </div>

          <div class="selectedPanel">
            <div class="selTop">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
                <span class="pill"><span class="dot"></span><span id="activeFilters">No filters</span></span>
                <span class="pill"><span class="dot"></span><span id="count">0 results</span></span>
                <span class="pill"><span class="dot"></span><span id="selCount">0 selected</span></span>
              </div>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn ghost" id="btnClearPkg" type="button">Clear Package</button>
                <button class="btn bad" id="btnClearSel" type="button">Clear Selected</button>
              </div>
            </div>
            <div class="selChips" id="selectedChips">
              <span style="color:rgba(11,18,32,.70); font-weight:850; font-size:12px">
                No selections yet. Select from package list (below) or via AI suggestions.
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section exploreBg" id="explore">
      <div class="sectionTitle">
        <div>
          <h2>Browse by Type</h2>
          <p>Tiles reflect only visible places (selected/package).</p>
        </div>
      </div>

      <div class="panel" style="overflow:hidden">
        <div class="panelHead">
          <h3>Type Tiles</h3>
          <small>click tile to filter</small>
        </div>
        <div class="typeTiles" id="typeTiles"></div>
      </div>

      <div class="panel mapPanel" id="mapPanel">
        <div class="panelHead">
          <h3>Map</h3>
          <small id="mapHint">Loads after click</small>
        </div>
        <div style="padding:14px; position:relative">
          <div id="map"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- AI Modal -->
  <div class="modalWrap" id="modalWrap" role="dialog" aria-modal="true">
    <div class="panel" style="width:min(840px,100%); background:rgba(255,255,255,.92)">
      <div class="panelHead">
        <div>
          <h3>AI Trip Planner</h3>
          <small>days + interest → suggestions</small>
        </div>
        <button class="btn ghost" id="closeAI">✕</button>
      </div>
      <div id="chat" style="padding:14px; display:flex; flex-direction:column; gap:10px; max-height:62vh; overflow:auto;"></div>
      <div style="padding:12px 14px 14px; display:flex; gap:10px; border-top:1px solid var(--stroke);">
        <input id="chatInput" style="flex:1; padding:12px; border-radius:14px; border:1px solid var(--stroke); background:rgba(255,255,255,.9); font-weight:800"
               placeholder="Example: 4 days, couple, temples + lakes, starting Shimla"/>
        <button class="btn" id="sendChat">Send</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   FIREBASE
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
  authDomain: "revnue-records.firebaseapp.com",
  databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "revnue-records",
  storageBucket: "revnue-records.firebasestorage.app",
  messagingSenderId: "182348503564",
  appId: "1:182348503564:web:480085405b09177245ac29",
  measurementId: "G-MGTDBCG896"
};
const dbPath = "locations";

/* =========================
   STATE
========================= */
const $ = (id)=>document.getElementById(id);
let allPlaces = [];
let shownPlaces = [];
let map = null;
let markerLayer = null;
let mapReady = false;

/* ✅ NEW: selection + package state */
let selectedPlaceIds = new Set();       // user-selected places
let activePackageId = null;             // which package is active
let packagePlaceIds = new Set();        // places included in active package
const allowManualAlongWithPackage = true; // ✅ false => strict package-only

/* =========================
   HELPERS
========================= */
function safeText(v){ return (v ?? "").toString().trim(); }
function escapeHtml(str){
  return safeText(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function normalizeType(t){
  t = safeText(t);
  if(!t) return "Destination";
  const low = t.toLowerCase();
  if(low.includes("cave") || low.includes("gufa")) return "Destination";
  if(low.includes("temple") || low.includes("mandir")) return "Temple";
  if(low.includes("lake")) return "Lake";
  if(low.includes("trek") || low.includes("trail")) return "Trek";
  if(low.includes("hotel") || low.includes("stay")) return "Hotel";
  if(low.includes("activity") || low.includes("adventure")) return "Activity";
  if(low.includes("dest") || low.includes("place")) return "Destination";
  return t[0].toUpperCase() + t.slice(1);
}
function parseLatLngFromMapUrl(url){
  url = safeText(url);
  if(!url) return {lat:null,lng:null};
  const q = url.match(/q=([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(q) return {lat:Number(q[1])||null, lng:Number(q[2])||null};
  const at = url.match(/@([-0-9.]+)\s*,\s*([-0-9.]+)/i);
  if(at) return {lat:Number(at[1])||null, lng:Number(at[2])||null};
  return {lat:null,lng:null};
}
function getImagesFromObj(o){
  const arr = [];
  if(Array.isArray(o.images)) arr.push(...o.images);
  const single = safeText(o["Image"] || o.image || o["Cover"] || o["Cover Image"] || o["Photo"] || o.photo);
  const list = safeText(o["Images"] || o.imagesList || o["Pics"] || "");
  const p1 = safeText(o["photo 1"] || o.photo1 || o["Image 1"] || o.image1);
  const p2 = safeText(o["photo 2"] || o.photo2 || o["Image 2"] || o.image2);
  const p3 = safeText(o["photo 3"] || o.photo3 || o["Image 3"] || o.image3);

  if(single) arr.push(single);
  if(list) list.split(",").map(s=>s.trim()).filter(Boolean).forEach(u=>arr.push(u));
  if(p1) arr.push(p1); if(p2) arr.push(p2); if(p3) arr.push(p3);

  return [...new Set(arr.filter(Boolean))];
}
function bestThumb(p){ return ((p.images||[]).filter(Boolean)[0]) || ""; }

/* =========================
   VISIBILITY (Selected + Package)
========================= */
function getVisiblePlaces(baseList){
  // If package selected: show package places (+ optional manual selections)
  if(activePackageId){
    return baseList.filter(p => {
      const inPkg = packagePlaceIds.has(p.id);
      const manual = selectedPlaceIds.has(p.id);
      return allowManualAlongWithPackage ? (inPkg || manual) : inPkg;
    });
  }
  // No package: show only selected places
  return baseList.filter(p => selectedPlaceIds.has(p.id));
}

function toggleSelectPlace(placeId){
  if(selectedPlaceIds.has(placeId)) selectedPlaceIds.delete(placeId);
  else selectedPlaceIds.add(placeId);
  renderSelectedChips();
  applyFilters(true);
}
function clearSelections(){
  selectedPlaceIds.clear();
  renderSelectedChips();
  applyFilters(true);
}

function activatePackage(pkgId){
  activePackageId = pkgId || null;
  const ids = (window.__PKGS__ && window.__PKGS__[pkgId]) ? window.__PKGS__[pkgId] : [];
  packagePlaceIds = new Set(ids);
  $("builderLine").textContent = `Active Package: ${pkgId} • showing package places`;
  applyFilters(true);
}
function deactivatePackage(){
  activePackageId = null;
  packagePlaceIds = new Set();
  $("builderLine").textContent = "Pick preferences → Get Packages → Activate one → only those places show.";
  applyFilters(true);
}

/* =========================
   MAP (lazy init)
========================= */
function ensureMap(){
  if(mapReady) return;
  $("mapPanel").style.display = "block";

  map = L.map('map', {zoomControl:true}).setView([31.9, 77.2], 7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  markerLayer = L.layerGroup().addTo(map);
  mapReady = true;
  setTimeout(()=> map.invalidateSize(), 120);
}
function clearMarkers(){ if(mapReady) markerLayer.clearLayers(); }
function addMarkers(list){
  if(!mapReady) return;
  clearMarkers();
  list.forEach((p)=>{
    if(!p.lat || !p.lng) return;
    const m = L.marker([p.lat, p.lng]).addTo(markerLayer);
    m.bindPopup(`<b>${escapeHtml(p.name)}</b><br/><span style="opacity:.75">${escapeHtml(p.district)} • ${escapeHtml(p.type)}</span>`);
  });
}

/* =========================
   FIREBASE LOAD
========================= */
async function loadPlaces(){
  try{
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const snap = await db.ref(dbPath).once("value");
    const val = snap.val() || {};

    allPlaces = Object.entries(val).map(([id, o])=>{
      o = o || {};
      const name = safeText(o["Location Name"] || o.name || o.title || id);
      const district = safeText(o["District"] || o.district || "Unknown");
      const segment = safeText(o["Segment Type"] || o.segment || "Destination");
      const how = safeText(o["How to Reach"] || o.how || "");
      const mapUrl = safeText(o["Map"] || o.map || "");
      const {lat, lng} = parseLatLngFromMapUrl(mapUrl);
      const type = normalizeType(segment);
      const images = getImagesFromObj(o);

      return { id, name, district, type, how, mapUrl, lat, lng, images };
    }).filter(p=>p.name);
  }catch(e){
    console.error("Firebase load failed:", e);
    allPlaces = [];
  }
}

/* =========================
   FILTERS
========================= */
const TYPE_ORDER = ["Destination","Temple","Lake","Trek","Hotel","Activity"];
function typeCountsFrom(list){
  const counts = {};
  list.forEach(p=>{ counts[p.type||"Destination"] = (counts[p.type||"Destination"]||0)+1; });
  return counts;
}
function buildDistrictDropdown(){
  const distSel = $("district");
  const districts = [...new Set(allPlaces.map(p=>p.district).filter(Boolean))].sort();
  distSel.innerHTML = `<option value="all">All</option>` + districts.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
}
function updateActiveFilters(){
  const parts = [];
  const d = $("district").value, t = $("type").value, q = safeText($("q").value);
  const days = Number($("days").value||0);
  if(d !== "all") parts.push(d);
  if(t !== "all") parts.push(t);
  if(days) parts.push(`${days}+ days`);
  if(q) parts.push(`“${q}”`);
  const pkg = activePackageId ? `Package:${activePackageId}` : null;
  if(pkg) parts.push(pkg);
  $("activeFilters").textContent = parts.length ? parts.join(" • ") : "No filters";
}

function applyFilters(skipHash){
  const q = safeText($("q").value).toLowerCase();
  const d = $("district").value;
  const t = $("type").value;

  // Base list by normal filters
  const base = allPlaces.filter(p=>{
    if(d !== "all" && p.district !== d) return false;
    if(t !== "all" && p.type !== t) return false;
    if(q){
      const hay = `${p.name} ${p.district} ${p.type} ${p.how}`.toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  // ✅ Enforce: selected/package only
  shownPlaces = getVisiblePlaces(base);

  $("count").textContent = `${shownPlaces.length} results`;
  updateActiveFilters();
  renderTypeTiles();

  if(mapReady){
    addMarkers(shownPlaces);
    $("mapHint").textContent = "Markers loaded";
  }
}

/* =========================
   TYPE TILES
========================= */
function tileImageForType(type){
  const pool = shownPlaces.filter(p=>p.type===type);
  for(const p of pool){
    const t = bestThumb(p);
    if(t) return t;
  }
  // fallback by type using your local images
  if(type==="Temple") return "./temple.jpg";
  if(type==="Trek") return "./trek.jpeg";
  if(type==="Activity") return "./activity.jpg";
  if(type==="Hotel") return "./Travelers.jpg";
  if(type==="Lake") return "./201-himalaya.jpg";
  return "./Kee_monastery.jpg";
}
function renderTypeTiles(){
  const base = shownPlaces; // ✅ only visible places
  const counts = typeCountsFrom(base);
  const types = TYPE_ORDER
    .filter(t => (counts[t]||0) > 0)
    .sort((a,b)=> (counts[b]||0) - (counts[a]||0));

  const box = $("typeTiles");
  if(!box) return;

  if(!base.length){
    box.innerHTML = `
      <div style="grid-column:1/-1; padding:14px;">
        <div class="helper">
          <b>No places showing.</b><br/>
          Select places (from packages or AI suggestions), or activate a package.
        </div>
      </div>
    `;
    return;
  }

  box.innerHTML = types.map(t=>{
    const img = tileImageForType(t);
    return `
      <div class="typeTile" data-picktype="${escapeHtml(t)}">
        <span class="typeTileHint">Tap → filter</span>
        <img class="typeTileImg" src="${img}" alt="${escapeHtml(t)}" loading="lazy"
             onerror="this.src='./Kee_monastery.jpg'">
        <div class="typeTileBody">
          <b>${escapeHtml(t)}</b>
          <span>${counts[t]||0}</span>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll("[data-picktype]").forEach(el=>{
    el.addEventListener("click", ()=>{
      $("type").value = el.getAttribute("data-picktype");
      applyFilters(true);
      location.hash = "#explore";
    });
  });
}

/* =========================
   SELECTED CHIPS UI
========================= */
function renderSelectedChips(){
  const out = $("selectedChips");
  const ids = [...selectedPlaceIds];

  $("selCount").textContent = `${ids.length} selected`;

  if(!ids.length){
    out.innerHTML = `<span style="color:rgba(11,18,32,.70); font-weight:850; font-size:12px">
      No selections yet. Select from package list (below) or via AI suggestions.
    </span>`;
    return;
  }

  const mapById = new Map(allPlaces.map(p=>[p.id,p]));
  out.innerHTML = ids.map(id=>{
    const p = mapById.get(id);
    const label = p ? `${p.name}` : id;
    return `
      <span class="selChip" onclick="toggleSelectPlace('${escapeHtml(id)}')" title="Remove">
        ${escapeHtml(label)} <span class="x">×</span>
      </span>
    `;
  }).join("");
}

/* =========================
   PACKAGES (Clickable + Activate)
========================= */
function buildPackages(){
  const interest = $("interest").value;
  const days = Number($("days").value||0) || 3;

  const base = allPlaces.slice();
  if(!base.length){
    $("packagesBox").innerHTML = `<b>No data.</b>`;
    return;
  }

  const wantType =
    interest==="temples" ? "Temple" :
    interest==="adventure" ? "Trek" :
    interest==="relax" ? "Hotel" : "Destination";

  const pool = base.filter(p => wantType==="Destination" ? true : p.type===wantType);

  const sizeA = Math.min(4, pool.length);
  const sizeB = Math.min(6, pool.length);
  const sizeC = Math.min(Math.max(7, Math.ceil(days*1.5)), pool.length);

  const pkg1 = pool.slice(0, sizeA);
  const pkg2 = pool.slice(0, sizeB);
  const pkg3 = pool.slice(0, sizeC);

  const packages = [
    { id: "pkgA", title: `Quick ${days}D • ${wantType}`, items: pkg1 },
    { id: "pkgB", title: `Balanced ${days}D • ${wantType}`, items: pkg2 },
    { id: "pkgC", title: `Full ${days}D • ${wantType}`, items: pkg3 },
  ].filter(p => p.items.length);

  window.__PKGS__ = {};
  packages.forEach(pkg=>{
    window.__PKGS__[pkg.id] = pkg.items.map(x=>x.id);
  });

  $("packagesBox").innerHTML =
    `<div style="display:flex; gap:10px; flex-wrap:wrap">
      ${packages.map(pkg=>`
        <button class="btn ghost" style="border-radius:16px" onclick="activatePackage('${pkg.id}')">
          Activate: ${escapeHtml(pkg.title)}
        </button>
      `).join("")}
      <button class="btn ghost" style="border-radius:16px" onclick="deactivatePackage()">Clear Package</button>
    </div>
    <div style="margin-top:10px; line-height:1.6">
      ${packages.map(pkg=>`
        <div style="margin-top:10px; padding:10px; border:1px solid var(--stroke); border-radius:16px; background:rgba(255,255,255,.7)">
          <b>${escapeHtml(pkg.title)}</b>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            ${pkg.items.map((p,i)=>`
              <span style="display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border:1px solid var(--stroke);
                border-radius:999px; background:rgba(245,247,255,.90); font-weight:900; font-size:12px; cursor:pointer"
                onclick="toggleSelectPlace('${p.id}')"
                title="Click to add/remove selection">
                ${i+1}. ${escapeHtml(p.name)}
              </span>
            `).join("")}
          </div>
          <div style="margin-top:10px; color:rgba(11,18,32,.70); font-weight:850; font-size:12px">
            Tip: Click place chips to select. Activate package to show only its places.
          </div>
        </div>
      `).join("")}
    </div>`;
}

/* =========================
   AI (mini) + Select
========================= */
function pushMsg(text, who="bot"){
  const div = document.createElement("div");
  div.style.maxWidth = "86%";
  div.style.padding = "10px 12px";
  div.style.borderRadius = "16px";
  div.style.border = "1px solid var(--stroke)";
  div.style.background = (who==="me")
    ? "linear-gradient(135deg, rgba(37,99,235,.12), rgba(124,58,237,.10))"
    : "rgba(245,247,255,.80)";
  div.style.fontWeight = "750";
  div.style.fontSize = "12.5px";
  div.style.whiteSpace = "pre-wrap";
  if(who==="me") div.style.marginLeft = "auto";
  div.textContent = text;
  $("chat").appendChild(div);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function seedChat(){
  $("chat").innerHTML = "";
  pushMsg("Tell me: days + interest + district (optional). I’ll suggest places. Then you can select from packages.", "bot");
}

function aiSuggest(userText){
  const t = userText.toLowerCase();
  let days = 0;
  const m = t.match(/(\d+)\s*(day|days|d)/);
  if(m) days = Number(m[1]);

  const wants = {
    temple: /temple|mandir/.test(t),
    trek: /trek|hike/.test(t),
    lake: /lake/.test(t),
    hotel: /hotel|stay|relax/.test(t),
  };

  const scored = allPlaces.map(p=>{
    let s=0;
    if(wants.temple && p.type==="Temple") s+=3;
    if(wants.trek && p.type==="Trek") s+=3;
    if(wants.lake && p.type==="Lake") s+=3;
    if(wants.hotel && p.type==="Hotel") s+=3;
    if(!Object.values(wants).some(Boolean) && p.type==="Destination") s+=2;
    return {p,s};
  }).sort((a,b)=>b.s-a.s);

  const cap = days ? Math.max(4, Math.min(10, Math.ceil(days*1.6))) : 6;
  const pick = scored.filter(x=>x.s>0).slice(0,cap).map(x=>x.p);

  // Auto-select AI picks (so user immediately sees tiles/map)
  pick.forEach(p=> selectedPlaceIds.add(p.id));
  renderSelectedChips();
  applyFilters(true);

  return "Selected suggestions added.\nNow open Explore → tiles/map will show only selected/package places.";
}

/* =========================
   UI EVENTS
========================= */
$("apply").onclick = ()=>{ applyFilters(true); location.hash="#explore"; };
$("reset").onclick = ()=>{
  $("q").value = "";
  $("district").value="all";
  $("type").value="all";
  $("days").value="0";
  applyFilters(true);
};
$("showMapBtn").onclick = ()=>{
  ensureMap();
  addMarkers(shownPlaces);
  $("mapHint").textContent = "Markers loaded";
  location.hash = "#explore";
};
$("makePackages").onclick = buildPackages;

$("openAdmin").onclick = ()=>{ window.location.href = "admin.html"; };

$("btnClearPkg").onclick = deactivatePackage;
$("btnClearSel").onclick = clearSelections;

$("openAI").onclick = ()=>{
  $("modalWrap").style.display = "flex";
  seedChat();
};
$("closeAI").onclick = ()=>{ $("modalWrap").style.display = "none"; };
$("modalWrap").addEventListener("click",(e)=>{ if(e.target === $("modalWrap")) $("modalWrap").style.display="none"; });
$("sendChat").onclick = ()=>{
  const v = safeText($("chatInput").value);
  if(!v) return;
  pushMsg(v, "me");
  $("chatInput").value = "";
  pushMsg(aiSuggest(v), "bot");
};
$("chatInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("sendChat").click(); });

/* Type image dropdown logic */
(function initTypeImageDropdown(){
  const pick = document.getElementById("typePick");
  if(!pick) return;

  const btn = document.getElementById("typePickBtn");
  const menu = document.getElementById("typePickMenu");
  const img = document.getElementById("typePickImg");
  const text = document.getElementById("typePickText");
  const hidden = document.getElementById("type");

  function close(){ menu.classList.remove("open"); }

  btn.addEventListener("click", (e)=>{
    e.stopPropagation();
    menu.classList.toggle("open");
  });

  menu.querySelectorAll(".typePickItem").forEach(item=>{
    item.addEventListener("click", ()=>{
      const v = item.getAttribute("data-value");
      const im = item.getAttribute("data-img");
      hidden.value = v;
      text.textContent = v === "all" ? "All" : v;
      img.src = im;
      close();
      applyFilters(true);
    });
  });

  document.addEventListener("click", close);
})();

/* =========================
   INIT
========================= */
(async function init(){
  await loadPlaces();
  buildDistrictDropdown();

  $("status").textContent = allPlaces.length
    ? `Loaded ${allPlaces.length} places • select places or choose a package`
    : "No data loaded. Check RTDB rules + path.";

  // Start with nothing visible (per requirement)
  selectedPlaceIds = new Set();
  activePackageId = null;
  packagePlaceIds = new Set();

  renderSelectedChips();
  applyFilters(true);
})();
</script>
</body>
</html>