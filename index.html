<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Hero + Smart Package Planner</title>

  <!-- Firebase (Compat RTDB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#050815; --bg1:#0b1022;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --muted2: rgba(255,255,255,.55);
      --brand:#6d7cff;
      --brand2:#2de2c4;
      --warn:#ffcf5a;
      --bad:#ff6b6b;
      --ok:#49f2c2;
      --r:18px; --r2:26px;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 10% 15%, rgba(109,124,255,.30), transparent 55%),
        radial-gradient(900px 700px at 80% 10%, rgba(45,226,196,.18), transparent 55%),
        radial-gradient(850px 650px at 65% 85%, rgba(255,207,90,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 14px 30px;
    }

    /* ====== TOP BAR ====== */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 10px;
      z-index: 40;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
    }
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.92), transparent 60%),
        linear-gradient(135deg, rgba(109,124,255,.98), rgba(45,226,196,.72));
      box-shadow: 0 18px 40px rgba(109,124,255,.25);
      border:1px solid rgba(255,255,255,.20);
      flex:0 0 auto;
    }
    .brand h1{margin:0;font-size:16px;line-height:1.1}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .pills{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--warn)}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--bad)}

    /* ====== MAIN LAYOUT (LEFT 65%) ====== */
    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 65% 35%;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .topbar{position:relative; top:auto}
      .layout{grid-template-columns: 1fr; }
    }

    /* ====== HERO LEFT ====== */
    .hero{
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      min-height: 520px;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 500px at 15% 15%, rgba(109,124,255,.28), transparent 60%),
        radial-gradient(650px 480px at 75% 20%, rgba(45,226,196,.18), transparent 60%),
        radial-gradient(700px 520px at 60% 85%, rgba(255,207,90,.10), transparent 65%);
      filter: blur(0px);
      opacity: .95;
      pointer-events:none;
    }
    .heroInner{
      position:relative;
      padding: 18px 18px 18px;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:12px;
    }
    .heroTag{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:12px;
      width: fit-content;
    }
    .heroTitle{
      font-size: 34px;
      line-height: 1.08;
      margin: 0;
      letter-spacing: -0.02em;
    }
    .heroTitle span{
      background: linear-gradient(135deg, rgba(109,124,255,1), rgba(45,226,196,1));
      -webkit-background-clip: text;
      background-clip:text;
      color: transparent;
    }
    .heroDesc{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
      max-width: 72ch;
    }

    /* Quotes: multiple shown + rotate every 5s */
    .quoteGrid{
      margin-top: 8px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 820px){
      .quoteGrid{grid-template-columns: 1fr}
      .hero{min-height:auto}
    }
    .quoteCard{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px 12px;
      overflow:hidden;
      position:relative;
      min-height: 120px;
    }
    .quoteCard::after{
      content:"";
      position:absolute; inset:auto -40px -40px auto;
      width:120px;height:120px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(109,124,255,.30), transparent 60%);
      opacity:.6;
      filter: blur(0px);
    }
    .quoteTxt{
      position:relative;
      margin:0;
      color: rgba(255,255,255,.90);
      font-size: 13px;
      line-height: 1.5;
    }
    .quoteBy{
      position:relative;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted2);
    }
    .fade{
      animation: fadeIn .35s ease;
    }
    @keyframes fadeIn{
      from{opacity:.0; transform: translateY(4px)}
      to{opacity:1; transform: translateY(0)}
    }

    /* ====== PLANNER RIGHT (CENTER BOX FEEL) ====== */
    .plannerCol{
      display:grid;
      gap:14px;
    }
    .planner{
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
      position: sticky;
      top: 86px;
      backdrop-filter: blur(12px);
    }
    @media (max-width: 980px){
      .planner{position:relative; top:auto}
    }
    .plannerHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .plannerHead h2{margin:0;font-size:14px}
    .plannerHead .sub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.35}
    .plannerBody{padding:12px 14px}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .form .full{grid-column: 1 / -1;}
    @media (max-width: 980px){
      .form{grid-template-columns: 1fr}
    }
    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin:0 0 6px;
    }
    input,select,button{
      width:100%;
      padding:10px 11px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font: inherit;
    }
    input::placeholder{color: rgba(255,255,255,.45)}
    select option{color:#111}
    .row2{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
    }
    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      cursor:pointer;
      border:none;
      background: linear-gradient(135deg, rgba(109,124,255,.98), rgba(45,226,196,.75));
      box-shadow: 0 16px 40px rgba(109,124,255,.18);
      font-weight: 700;
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      font-weight: 600;
    }

    .kpis{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding:10px 12px;
    }
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:14px;font-weight:800;margin-top:4px}

    /* Package results */
    .results{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: var(--r2);
      overflow:hidden;
    }
    .resultsHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .resultsHead b{font-size:13px}
    .resultsBody{padding:10px 12px; display:grid; gap:10px}
    .pkg{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding:10px 10px;
    }
    .pkgTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .pkg h3{margin:0;font-size:13px}
    .pkg .meta{margin-top:6px;font-size:12px;color:var(--muted)}
    .price{
      white-space:nowrap;
      font-weight: 900;
      font-size: 13px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      padding:6px 8px;
      border-radius: 999px;
    }
    .chips{
      margin-top:8px;
      display:flex; gap:6px; flex-wrap:wrap;
    }
    .chip{
      font-size:12px;
      padding:6px 8px;
      border-radius: 999px;
      background: rgba(109,124,255,.16);
      border: 1px solid rgba(109,124,255,.22);
      color: rgba(255,255,255,.88);
    }
    .chip2{
      background: rgba(45,226,196,.14);
      border: 1px solid rgba(45,226,196,.20);
    }
    .chip3{
      background: rgba(255,207,90,.12);
      border: 1px solid rgba(255,207,90,.18);
    }
    .mutedSmall{font-size:12px;color:var(--muted);line-height:1.4}
    .hr{height:1px;background:rgba(255,255,255,.10); margin:10px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Himachal Explorer</h1>
          <p>Hero + quotes • Smart package planner • Firebase: /locations</p>
        </div>
      </div>
      <div class="pills">
        <div class="pill"><span id="dbDot" class="dot"></span><span id="dbText">Connecting…</span></div>
        <div class="pill">Loaded <b id="loadedCount" style="margin-left:6px">0</b></div>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT 65% HERO -->
      <section class="hero">
        <div class="heroInner">
          <div class="heroTag">
            <span style="width:8px;height:8px;border-radius:999px;background:var(--brand2)"></span>
            <span>Where mountains feel like home</span>
          </div>

          <h2 class="heroTitle">
            Discover <span>Himachal Pradesh</span> — nature, temples, treks, lakes & timeless valleys
          </h2>

          <p class="heroDesc">
            Himachal is a tapestry of cedar forests, snow-fed rivers, high-altitude passes, ancient temples,
            and small hillside towns where every turn reveals a new horizon. Plan a trip that stays realistic
            on the ground — nearby locations together, travel time that makes sense, and a cost that includes
            transport, stay, and driver expenses.
          </p>

          <div class="quoteGrid" id="quoteGrid">
            <!-- JS will render 3 quote cards here, and rotate every 5 seconds -->
          </div>
        </div>
      </section>

      <!-- RIGHT 35% PLANNER (CENTER BOX FEEL) -->
      <aside class="plannerCol">
        <div class="planner">
          <div class="plannerHead">
            <div>
              <h2>Package Planner</h2>
              <div class="sub">Choose start & end, days, people. Auto-generate the best route-friendly package.</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div style="font-size:12px;color:var(--muted)">Mode</div>
              <div style="font-size:12px;font-weight:800" id="modeText">Auto package</div>
            </div>
          </div>

          <div class="plannerBody">
            <div class="form">
              <div class="full">
                <label>Start (Where to begin)</label>
                <select id="startPlace">
                  <option value="">Loading…</option>
                </select>
              </div>

              <div class="full">
                <label>End (Where to finish)</label>
                <select id="endPlace">
                  <option value="">Loading…</option>
                </select>
              </div>

              <div>
                <label>Days</label>
                <select id="days">
                  <option>1</option><option selected>2</option><option>3</option><option>4</option>
                  <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                </select>
              </div>

              <div>
                <label>People</label>
                <select id="pax">
                  <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
                  <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
                </select>
              </div>

              <div>
                <label>Vehicle (Auto/Manual)</label>
                <select id="vehicle">
                  <option value="auto" selected>Auto</option>
                  <option value="bike">Bike</option>
                  <option value="car">Car</option>
                  <option value="suv">SUV</option>
                  <option value="tempo">Tempo Traveller</option>
                </select>
              </div>

              <div>
                <label>Auto-generate best package?</label>
                <select id="autoGen">
                  <option value="yes" selected>Yes</option>
                  <option value="no">No (I will click Generate)</option>
                </select>
              </div>

              <div class="full">
                <label>Preference (optional)</label>
                <select id="preference">
                  <option value="balanced" selected>Balanced</option>
                  <option value="temples">Temples / Culture</option>
                  <option value="treks">Treks / Adventure</option>
                  <option value="lakes">Lakes / Nature</option>
                  <option value="relax">Relax / Scenic</option>
                </select>
              </div>

              <div class="full">
                <label>Search keyword (optional)</label>
                <input id="kw" placeholder="e.g., Shimla, temple, trek, lake…"/>
              </div>
            </div>

            <div class="btnRow">
              <button id="btnGenerate">Generate Package</button>
              <button class="secondary" id="btnReset" type="button">Reset</button>
            </div>

            <div class="kpis">
              <div class="kpi">
                <div class="t">Suggested vehicle</div>
                <div class="v" id="kVeh">—</div>
              </div>
              <div class="kpi">
                <div class="t">Estimated range</div>
                <div class="v" id="kCost">—</div>
              </div>
              <div class="kpi">
                <div class="t">Places in plan</div>
                <div class="v" id="kPlaces">—</div>
              </div>
              <div class="kpi">
                <div class="t">Route corridor</div>
                <div class="v" id="kCorridor">—</div>
              </div>
            </div>

            <div class="hr"></div>
            <div class="mutedSmall" id="breakdown">
              Cost breakdown will appear here (transport + stay + driver).
            </div>
          </div>
        </div>

        <div class="results">
          <div class="resultsHead">
            <b>Recommended Packages</b>
            <span style="font-size:12px;color:var(--muted)" id="pkgCount">0</span>
          </div>
          <div class="resultsBody" id="pkgList">
            <div class="mutedSmall">Generate to see packages that fit between your start → end route.</div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    /* ===========================
       FIREBASE CONFIG (FILL THIS)
    =========================== */
    const firebaseConfig = {
      apiKey: "PASTE_YOUR_API_KEY",
      authDomain: "PASTE_YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "PASTE.appspot.com",
      messagingSenderId: "PASTE",
      appId: "PASTE"
    };

    /* ===========================
       QUOTES (rotate every 5s, show 3)
    =========================== */
    const QUOTES = [
      { q: "In Himachal, every road is a story — written in pine, snow, and sunlight.", by: "Himachal Explorer" },
      { q: "Let the mountains slow your mind and sharpen your senses.", by: "Himachal Explorer" },
      { q: "A day in the hills is a reset button you can actually feel.", by: "Himachal Explorer" },
      { q: "Temples on ridges, lakes in silence — Himachal teaches calm without words.", by: "Himachal Explorer" },
      { q: "Take fewer places, take them deeper — that’s the real Himachal plan.", by: "Himachal Explorer" },
      { q: "The best itinerary is the one that leaves you time to breathe.", by: "Himachal Explorer" },
      { q: "Chai tastes better when the valley is below and clouds are above.", by: "Himachal Explorer" },
      { q: "Adventure here isn’t just speed — it’s altitude, patience, and wonder.", by: "Himachal Explorer" }
    ];
    let quoteIndex = 0;
    function renderQuotes(){
      const grid = document.getElementById("quoteGrid");
      grid.innerHTML = "";
      // show 3 quotes at a time
      for(let i=0;i<3;i++){
        const idx = (quoteIndex + i) % QUOTES.length;
        const qc = document.createElement("div");
        qc.className = "quoteCard fade";
        qc.innerHTML = `
          <p class="quoteTxt">“${escapeHtml(QUOTES[idx].q)}”</p>
          <div class="quoteBy">— ${escapeHtml(QUOTES[idx].by)}</div>
        `;
        grid.appendChild(qc);
      }
      quoteIndex = (quoteIndex + 1) % QUOTES.length;
    }
    setInterval(renderQuotes, 5000);
    renderQuotes();

    /* ===========================
       DATA + HELPERS
    =========================== */
    const $ = (id)=>document.getElementById(id);
    const dbDot = $("dbDot"), dbText = $("dbText"), loadedCount = $("loadedCount");

    let ALL = []; // normalized places from /locations

    function setDbStatus(ok, msg){
      dbDot.classList.remove("ok","bad");
      dbDot.classList.add(ok ? "ok" : "bad");
      dbText.textContent = msg;
    }
    function safeStr(v){ return (v===undefined||v===null) ? "" : String(v); }
    function escapeHtml(s){
      return safeStr(s).replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      })[c]);
    }
    function toNum(v){
      const n = parseFloat(String(v||"").replace(/[^\d.\-]/g,""));
      return Number.isFinite(n) ? n : null;
    }
    function pickPhoto(p){
      return p["photo 1"] || p["Photo 1"] || p["photo1"] || p["Image"] || p["image"] || "";
    }
    function normalizeRecord(key, raw){
      const p = raw || {};
      return {
        key,
        name: safeStr(p["Location Name"] || p["name"] || p["Name"] || key),
        district: safeStr(p["District"] || p["district"] || ""),
        segment: safeStr(p["Segment Type"] || p["segment type"] || p["segment"] || "Other"),
        type: safeStr(p["Location Type"] || p["location type"] || p["type"] || ""),
        short: safeStr(p["Short Description"] || p["short description"] || ""),
        overview: safeStr(p["Overview"] || p["overview"] || ""),
        reach: safeStr(p["How to Reach"] || p["how to reach"] || ""),
        bestTime: safeStr(p["Best Time to Visit"] || p["best time to visit"] || ""),
        distHQ: safeStr(p["Dist from HQ"] || p["dist from hq"] || ""),
        keyFeatures: safeStr(p["Key Features"] || p["key features"] || ""),
        lat: toNum(p["Latitude"] ?? p["latitude"]),
        lng: toNum(p["Longitude"] ?? p["longitude"]),
        photo: safeStr(pickPhoto(p))
      };
    }
    function uniq(arr){
      return Array.from(new Set(arr.filter(Boolean)));
    }

    /* ===========================
       ROUTE-CORRIDOR SELECTION (no API)
       - choose places near the line Start -> End
       - width increases with days
    =========================== */
    function haversineKm(a,b){
      const R=6371;
      const toRad = (x)=>x*Math.PI/180;
      const dLat = toRad(b.lat-a.lat);
      const dLng = toRad(b.lng-a.lng);
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const q = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.min(1, Math.sqrt(q)));
    }
    // distance from point P to segment AB (approx using equirectangular projection)
    function distPointToSegmentKm(P,A,B){
      // convert to a flat plane around mean latitude
      const meanLat = ((A.lat + B.lat)/2) * Math.PI/180;
      const kx = 111.320 * Math.cos(meanLat);
      const ky = 110.574;

      const ax = A.lng*kx, ay = A.lat*ky;
      const bx = B.lng*kx, by = B.lat*ky;
      const px = P.lng*kx, py = P.lat*ky;

      const ABx = bx-ax, ABy = by-ay;
      const APx = px-ax, APy = py-ay;
      const ab2 = ABx*ABx + ABy*ABy || 1e-9;
      let t = (APx*ABx + APy*ABy)/ab2;
      t = Math.max(0, Math.min(1, t));
      const cx = ax + t*ABx, cy = ay + t*ABy;
      const dx = px - cx, dy = py - cy;
      return Math.sqrt(dx*dx + dy*dy);
    }

    function suggestVehicle(pax, chosen){
      if(chosen && chosen !== "auto") return chosen;
      if(pax <= 2) return "bike";
      if(pax <= 4) return "car";
      if(pax <= 6) return "suv";
      return "tempo";
    }
    function vehicleLabel(v){
      return ({auto:"Auto", bike:"Bike", car:"Car", suv:"SUV", tempo:"Tempo Traveller"})[v] || v;
    }
    function formatINR(n){
      try{
        return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(n);
      }catch(e){
        return "₹" + Math.round(n);
      }
    }

    /* ===========================
       COST MODEL (transport + stay + driver)
       - You can edit these numbers anytime
    =========================== */
    function estimateCost({days, pax, vehicle, driveKm}){
      const vehicleBasePerDay = { bike:1200, car:3200, suv:4500, tempo:7500 };
      const fuelPerKm         = { bike:3.0,  car:6.5,  suv:8.5,  tempo:12.0 };

      const driverPerDay = { bike:0, car:900, suv:950, tempo:1100 }; // driver expense/day
      const driverNightAllowance = { bike:0, car:350, suv:400, tempo:450 }; // per night

      const stayPerPersonPerNight = 950;   // stay
      const foodPerPersonPerDay   = 550;   // food

      const nights = Math.max(0, days-1);

      const vDay = vehicleBasePerDay[vehicle] ?? 3500;
      const fuel = (fuelPerKm[vehicle] ?? 7.0) * Math.max(20, driveKm);

      const transport = vDay * days + fuel;

      const stay = pax * stayPerPersonPerNight * nights;
      const food = pax * foodPerPersonPerDay * days;

      const driver = (driverPerDay[vehicle] ?? 900) * days + (driverNightAllowance[vehicle] ?? 350) * nights;

      const subtotal = transport + stay + food + driver;

      // range +/- 12%
      return {
        transport, stay, food, driver,
        low: Math.round(subtotal * 0.88),
        high: Math.round(subtotal * 1.12)
      };
    }

    /* ===========================
       PACKAGE BUILDING
       - Picks 3 packages:
         1) Best Value
         2) More Scenic
         3) Compact (closest)
       - Packages contain places near the chosen route corridor
    =========================== */
    function scorePlace(p, pref){
      const seg = (p.segment||"").toLowerCase();
      const type = (p.type||"").toLowerCase();
      let s = 0;

      // base preference by segment/type keywords
      const temple = seg.includes("temple") || type.includes("temple");
      const trek   = seg.includes("trek")   || type.includes("trek") || seg.includes("adventure");
      const lake   = seg.includes("lake")   || type.includes("lake");
      const relax  = seg.includes("destination") || seg.includes("scenic") || type.includes("view");

      if(pref === "temples") s += temple ? 20 : 0;
      if(pref === "treks")   s += trek ? 20 : 0;
      if(pref === "lakes")   s += lake ? 20 : 0;
      if(pref === "relax")   s += relax ? 18 : 0;

      // balanced gets a smaller bump for variety-friendly places
      if(pref === "balanced"){
        if(temple) s += 6;
        if(trek)   s += 6;
        if(lake)   s += 6;
        if(relax)  s += 5;
      }

      // small quality bump if it has description/photos
      if(p.photo) s += 2;
      if(p.short) s += 2;
      if(p.overview) s += 1;

      return s;
    }

    function buildPackages({start, end, days, pax, vehicle, pref, keyword}){
      // corridor width in km: more days => wider
      const corridorKm = Math.min(85, Math.max(18, 18 + (days-1)*12));
      $("kCorridor").textContent = `±${Math.round(corridorKm)} km`;

      // candidates: route corridor + mapped coords
      const kw = (keyword||"").trim().toLowerCase();
      const candidates = ALL.filter(p=>{
        if(p.lat==null || p.lng==null) return false;
        // keyword filter (optional)
        if(kw){
          const hay = `${p.name} ${p.district} ${p.segment} ${p.type} ${p.short} ${p.overview}`.toLowerCase();
          if(!hay.includes(kw)) return false;
        }
        const d = distPointToSegmentKm({lat:p.lat,lng:p.lng}, start, end);
        return d <= corridorKm;
      });

      // if corridor yields too few, fallback wider
      let pool = candidates;
      if(pool.length < 6){
        const wider = corridorKm + 25;
        pool = ALL.filter(p=>{
          if(p.lat==null || p.lng==null) return false;
          if(kw){
            const hay = `${p.name} ${p.district} ${p.segment} ${p.type} ${p.short} ${p.overview}`.toLowerCase();
            if(!hay.includes(kw)) return false;
          }
          const d = distPointToSegmentKm({lat:p.lat,lng:p.lng}, start, end);
          return d <= wider;
        });
      }

      // sort by preference score and closeness to corridor
      const scored = pool.map(p=>{
        const dLine = distPointToSegmentKm({lat:p.lat,lng:p.lng}, start, end);
        const score = scorePlace(p, pref) - (dLine * 0.35);
        return {p, score, dLine};
      }).sort((a,b)=>b.score - a.score);

      // choose places count based on days (feasible)
      const maxN = Math.min(10, Math.max(4, 3 + days)); // 2 days => 5, 5 days => 8, etc.

      // helper: pick with variety
      function pickSet(mode){
        const picked = [];
        const used = new Set();
        const usedSeg = new Set();

        for(const item of scored){
          if(picked.length >= maxN) break;
          const p = item.p;

          // avoid duplicates
          if(used.has(p.key)) continue;

          // mode-specific
          if(mode === "compact"){
            // prefer closest to corridor line (low dLine)
            if(item.dLine > (corridorKm * 0.75)) continue;
          }
          if(mode === "scenic"){
            // prefer variety segments
            const seg = (p.segment || "Other");
            if(usedSeg.size < 4 && usedSeg.has(seg)) continue;
          }

          picked.push(p);
          used.add(p.key);
          usedSeg.add(p.segment || "Other");
        }

        // if still short, fill
        if(picked.length < Math.min(4, maxN)){
          for(const item of scored){
            if(picked.length >= maxN) break;
            if(used.has(item.p.key)) continue;
            picked.push(item.p);
            used.add(item.p.key);
          }
        }

        return picked;
      }

      const bestValue = pickSet("best");
      const scenic    = pickSet("scenic");
      const compact   = pickSet("compact");

      // estimate driving km (simple): start->end + movements across selected places
      function estimateDriveKm(places){
        const pts = places.filter(x=>x.lat!=null && x.lng!=null).map(x=>({lat:x.lat,lng:x.lng}));
        if(!pts.length) return haversineKm(start, end) * 1.25;

        // rough: start->end plus average spread among places
        let max = 0;
        for(const pt of pts){
          max = Math.max(max, haversineKm(start, pt), haversineKm(end, pt));
        }
        // corridor travel increases driving
        return (haversineKm(start, end) * 1.35) + (max * 0.9);
      }

      function makePkg(title, places){
        const driveKm = Math.max(35, estimateDriveKm(places));
        const cost = estimateCost({days, pax, vehicle, driveKm});
        return {
          title,
          places,
          driveKm,
          cost,
          hint: `${places.length} places • ~${Math.round(driveKm)} km driving`
        };
      }

      const pkgs = [
        makePkg("Best Value (recommended)", bestValue),
        makePkg("Scenic & Variety", scenic),
        makePkg("Compact & Efficient", compact)
      ];

      // remove empty/very small sets
      return pkgs.filter(x=>x.places.length >= 3);
    }

    /* ===========================
       UI RENDER
    =========================== */
    function renderPackageList(pkgs){
      const list = $("pkgList");
      list.innerHTML = "";
      $("pkgCount").textContent = String(pkgs.length);

      if(!pkgs.length){
        list.innerHTML = `<div class="mutedSmall">Not enough places found on that route corridor. Try different start/end or increase days.</div>`;
        return;
      }

      // KPI from first package
      const best = pkgs[0];
      $("kPlaces").textContent = best.places.length;
      $("kCost").textContent = `${formatINR(best.cost.low)} – ${formatINR(best.cost.high)}`;

      // breakdown box (best package)
      $("breakdown").innerHTML = `
        <div class="mutedSmall">
          <b>Cost breakdown (Best Value):</b><br/>
          • Transport (vehicle + fuel): <b>${formatINR(best.cost.transport)}</b><br/>
          • Stay: <b>${formatINR(best.cost.stay)}</b><br/>
          • Food: <b>${formatINR(best.cost.food)}</b><br/>
          • Driver expenses: <b>${formatINR(best.cost.driver)}</b><br/>
          <span style="color:rgba(255,255,255,.55)">Range shown includes ±12% for season/traffic/tolls.</span>
        </div>
      `;

      for(const pkg of pkgs){
        const div = document.createElement("div");
        div.className = "pkg";
        div.innerHTML = `
          <div class="pkgTop">
            <div>
              <h3>${escapeHtml(pkg.title)}</h3>
              <div class="meta">${escapeHtml(pkg.hint)}</div>
            </div>
            <div class="price">${formatINR(pkg.cost.low)} – ${formatINR(pkg.cost.high)}</div>
          </div>
          <div class="chips">
            ${pkg.places.slice(0,10).map((p,i)=>`
              <span class="chip ${i%3===1?'chip2':(i%3===2?'chip3':'')}">${escapeHtml(p.name)}</span>
            `).join("")}
          </div>
          <div class="meta" style="margin-top:8px">
            Districts: ${escapeHtml(uniq(pkg.places.map(x=>x.district)).slice(0,4).join(", ") || "—")}
          </div>
        `;
        list.appendChild(div);
      }
    }

    /* ===========================
       FORM LOGIC
    =========================== */
    function fillPlaceSelect(sel, places){
      const prev = sel.value;
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select a place…";
      sel.appendChild(opt0);

      // sort by district then name
      places
        .slice()
        .sort((a,b)=>(a.district+a.name).localeCompare(b.district+b.name))
        .forEach(p=>{
          const o = document.createElement("option");
          o.value = p.key;
          o.textContent = `${p.name}${p.district ? " — "+p.district : ""}`;
          sel.appendChild(o);
        });

      // restore if possible
      if(prev && [...sel.options].some(o=>o.value===prev)) sel.value = prev;
    }

    function getPlaceByKey(key){
      return ALL.find(p=>p.key===key) || null;
    }

    function runPlanner(){
      const sKey = $("startPlace").value;
      const eKey = $("endPlace").value;
      const days = parseInt($("days").value,10);
      const pax  = parseInt($("pax").value,10);
      const chosenVehicle = $("vehicle").value;
      const pref = $("preference").value;
      const keyword = $("kw").value;

      if(!sKey || !eKey){
        $("pkgList").innerHTML = `<div class="mutedSmall">Please select both <b>Start</b> and <b>End</b>.</div>`;
        $("pkgCount").textContent = "0";
        return;
      }

      const s = getPlaceByKey(sKey);
      const e = getPlaceByKey(eKey);
      if(!s || !e || s.lat==null || s.lng==null || e.lat==null || e.lng==null){
        $("pkgList").innerHTML = `<div class="mutedSmall">Start/End must have Latitude & Longitude in Firebase.</div>`;
        $("pkgCount").textContent = "0";
        return;
      }

      const vehicle = suggestVehicle(pax, chosenVehicle);
      $("kVeh").textContent = vehicleLabel(vehicle);

      const pkgs = buildPackages({
        start:{lat:s.lat,lng:s.lng},
        end:{lat:e.lat,lng:e.lng},
        days, pax, vehicle, pref, keyword
      });

      renderPackageList(pkgs);
    }

    function resetPlanner(){
      $("startPlace").value = "";
      $("endPlace").value = "";
      $("days").value = "2";
      $("pax").value = "2";
      $("vehicle").value = "auto";
      $("autoGen").value = "yes";
      $("preference").value = "balanced";
      $("kw").value = "";
      $("modeText").textContent = "Auto package";
      $("kVeh").textContent = "—";
      $("kCost").textContent = "—";
      $("kPlaces").textContent = "—";
      $("kCorridor").textContent = "—";
      $("breakdown").textContent = "Cost breakdown will appear here (transport + stay + driver).";
      $("pkgCount").textContent = "0";
      $("pkgList").innerHTML = `<div class="mutedSmall">Generate to see packages that fit between your start → end route.</div>`;
    }

    function setModeText(){
      const auto = $("autoGen").value === "yes";
      $("modeText").textContent = auto ? "Auto package" : "Manual generate";
    }

    /* ===========================
       FIREBASE LOAD (/locations)
    =========================== */
    function boot(){
      try{
        firebase.initializeApp(firebaseConfig);
        setDbStatus(true, "Connected");
      }catch(e){
        console.error(e);
        setDbStatus(false, "Config error");
        return;
      }

      firebase.database().ref("locations").on("value", snap=>{
        const data = snap.val();
        if(!data){
          ALL = [];
          loadedCount.textContent = "0";
          setDbStatus(false, "No data at /locations");
          return;
        }
        ALL = Object.entries(data).map(([key, raw])=>normalizeRecord(key, raw));
        loadedCount.textContent = String(ALL.length);
        setDbStatus(true, "Live");

        // Only places with lat/lng are usable for route start/end
        const usable = ALL.filter(p=>p.lat!=null && p.lng!=null);

        fillPlaceSelect($("startPlace"), usable);
        fillPlaceSelect($("endPlace"), usable);

        // if auto gen, run when form changes and start/end are selected
        attachAutoHandlers();
      }, err=>{
        console.error(err);
        setDbStatus(false, "Rules / Network");
      });

      // buttons
      $("btnGenerate").addEventListener("click", runPlanner);
      $("btnReset").addEventListener("click", resetPlanner);

      // mode text
      ["change","input"].forEach(evt=>{
        $("autoGen").addEventListener(evt, ()=>{
          setModeText();
          attachAutoHandlers();
          // if switching to auto, run once
          if($("autoGen").value==="yes") maybeAutoRun();
        });
      });

      setModeText();
      resetPlanner();
    }

    function maybeAutoRun(){
      const auto = $("autoGen").value === "yes";
      if(!auto) return;
      // Run only when start & end selected
      if($("startPlace").value && $("endPlace").value) runPlanner();
    }

    function attachAutoHandlers(){
      // Remove existing handlers by cloning nodes (simple reliable approach)
      const ids = ["startPlace","endPlace","days","pax","vehicle","preference","kw"];
      for(const id of ids){
        const el = $(id);
        const clone = el.cloneNode(true);
        el.parentNode.replaceChild(clone, el);
      }

      // Rebind buttons (they got replaced if inside form). Rebind after clone.
      $("btnGenerate").onclick = runPlanner;
      $("btnReset").onclick = resetPlanner;

      // Mode text handler
      $("autoGen").onchange = ()=>{ setModeText(); attachAutoHandlers(); if($("autoGen").value==="yes") maybeAutoRun(); };

      // Auto handlers
      const auto = $("autoGen").value === "yes";
      if(auto){
        ["change","input"].forEach(evt=>{
          $("startPlace").addEventListener(evt, maybeAutoRun);
          $("endPlace").addEventListener(evt, maybeAutoRun);
          $("days").addEventListener(evt, maybeAutoRun);
          $("pax").addEventListener(evt, maybeAutoRun);
          $("vehicle").addEventListener(evt, maybeAutoRun);
          $("preference").addEventListener(evt, maybeAutoRun);
          $("kw").addEventListener(evt, ()=>{
            // debounce keyword a bit
            clearTimeout(window.__kwT);
            window.__kwT = setTimeout(maybeAutoRun, 350);
          });
        });
      }
    }

    boot();
  </script>
</body>
</html>