<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HP Tourism Portal â€” Single Page (Firebase)</title>

  <!-- Optional Map (works without key) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --text:#e9eefc; --muted:#b6c2e2;
      --line:rgba(255,255,255,.10); --pill:rgba(255,255,255,.10);
      --accent:#67e8f9; --accent2:#a78bfa;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(103,232,249,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(167,139,250,.18), transparent 60%),
        linear-gradient(180deg, #070b14, var(--bg));
    }
    a{color:inherit; text-decoration:none}
    img{max-width:100%; display:block}

    .topbar{
      position:sticky; top:0; z-index:40;
      backdrop-filter: blur(10px);
      background: rgba(7,11,20,.55);
      border-bottom:1px solid var(--line);
    }
    .topbar .inner{
      max-width:1220px; margin:0 auto; padding:10px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px}
    .brand .logo{
      width:38px; height:38px; border-radius:14px;
      background: linear-gradient(135deg, rgba(103,232,249,.9), rgba(167,139,250,.9));
      box-shadow: var(--shadow);
    }
    .nav{display:flex; gap:10px; flex-wrap:wrap}
    .nav a{
      padding:9px 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      color:var(--muted);
      font-weight:800;
    }
    .nav a:hover{
      color:var(--text);
      border-color: rgba(103,232,249,.35);
      box-shadow: 0 8px 24px rgba(103,232,249,.12);
    }

    .container{max-width:1220px; margin:0 auto; padding:18px}
    .row{display:flex; gap:18px}
    .sidebar{
      width:320px; flex:0 0 320px;
      border:1px solid var(--line);
      background: rgba(17,26,46,.50);
      border-radius: 22px;
      padding:14px;
      position:sticky;
      top:72px;
      height: calc(100vh - 96px);
      overflow:auto;
    }
    .content{flex:1}

    .hero{
      border:1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.60)),
        url("https://images.unsplash.com/photo-1524492412937-b28074a5d7da?auto=format&fit=crop&w=2400&q=70") center/cover;
      border-radius: 26px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .hero .wrap{padding:22px}
    .hero h1{margin:0; font-size:34px; line-height:1.1}
    .hero p{margin:10px 0 16px; color:rgba(233,238,252,.85); max-width:760px}

    .searchbar{
      display:grid;
      grid-template-columns: 1.1fr .8fr .9fr auto;
      gap:10px;
      background: rgba(17,26,46,.72);
      border:1px solid var(--line);
      padding:10px;
      border-radius: 18px;
    }
    .input{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(7,11,20,.35);
    }
    .input label{font-size:12px; color:var(--muted); display:block}
    .input select,.input input{
      width:100%;
      background:transparent;
      border:none;
      color:var(--text);
      outline:none;
      font-size:14px;
    }

    .btn{
      border:none;
      border-radius: 14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      color:#06101c;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 18px 40px rgba(103,232,249,.15);
    }
    .btn.ghost{
      background: rgba(255,255,255,.05);
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }

    .shell{margin-top:16px}
    .side-title{font-weight:900; font-size:14px; display:flex; justify-content:space-between; align-items:center}
    .small{font-size:12px; color:var(--muted)}
    .divider{height:1px; background:var(--line); margin:12px 0}
    .panel{
      border:1px solid var(--line);
      background: rgba(7,11,20,.35);
      border-radius: 18px;
      padding:12px;
    }
    .panel h3{margin:0 0 8px; font-size:15px}
    .note{color:rgba(233,238,252,.78); font-size:12px; line-height:1.4}

    .pills{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      padding:8px 10px;
      border-radius: 999px;
      background: var(--pill);
      border:1px solid var(--line);
      color:var(--muted);
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .pill.active{
      color:var(--text);
      border-color: rgba(103,232,249,.35);
      box-shadow: 0 10px 26px rgba(103,232,249,.10);
    }

    .sectionHead{display:flex; align-items:end; justify-content:space-between; gap:14px; margin:6px 0 10px}
    .sectionHead h2{margin:0; font-size:18px}
    .sectionHead .meta{color:var(--muted); font-size:12px}

    .cards{display:grid; grid-template-columns: repeat(3, 1fr); gap:16px}
    .card{
      border:1px solid var(--line);
      background: rgba(17,26,46,.45);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      cursor:pointer;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(103,232,249,.35);
      box-shadow: 0 20px 55px rgba(0,0,0,.30);
    }
    .card .img{height:175px; background:#0c1324; position:relative}
    .card .img img{width:100%; height:100%; object-fit:cover; transform:scale(1); transition: transform .25s ease}
    .card:hover .img img{transform:scale(1.05)}
    .badges{position:absolute; left:10px; bottom:10px; display:flex; gap:8px; flex-wrap:wrap}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(7,11,20,.55);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(233,238,252,.95);
      backdrop-filter: blur(8px);
    }
    .card .body{padding:12px 12px 13px}
    .card h3{margin:0; font-size:15px}
    .card p{margin:8px 0 0; color:rgba(233,238,252,.78); font-size:13px; line-height:1.35}
    .quickIcons{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .iconChip{
      font-size:12px; font-weight:900;
      padding:7px 9px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(7,11,20,.35);
      color:rgba(233,238,252,.9);
    }
    .footer{margin:20px 0 10px; color:var(--muted); font-size:12px; text-align:center; opacity:.9}

    /* Pages */
    .page{display:none}
    .page.active{display:block}
    .tabsTop{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 0}
    .tabsTop .pill{padding:10px 12px}

    /* Detail */
    .twoCol{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px}
    .kv{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .kv .item{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(255,255,255,.03);
    }
    .kv .item b{display:block; font-size:12px; color:var(--muted)}
    .kv .item span{display:block; margin-top:6px; font-weight:900}
    .formRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px}

    .mapBox{height:420px; border-radius:18px; overflow:hidden; border:1px solid rgba(255,255,255,.10); background:rgba(7,11,20,.35)}

    /* Modal */
    .hidden{display:none !important}
    .modalBack{
      position:fixed; inset:0; z-index:70;
      background: rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(760px, 100%);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,26,46,.95), rgba(7,11,20,.95));
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .top{
      padding:16px 16px 0;
      display:flex; justify-content:space-between; gap:12px; align-items:start;
    }
    .modal h3{margin:0; font-size:18px}
    .modal .x{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px; border-radius: 14px; cursor:pointer; font-weight:900;
    }
    .modal .body{padding:12px 16px 16px}
    .featureGrid{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px}
    .feature{
      border:1px solid var(--line);
      border-radius: 18px;
      padding:12px;
      background: rgba(255,255,255,.04);
    }
    .feature b{display:block; margin-bottom:6px}
    .feature span{color:rgba(233,238,252,.78); font-size:13px}

    .loadingBar{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background: rgba(17,26,46,.55);
      border-radius: 16px;
      padding:10px 12px;
      margin: 12px 0;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 30px rgba(103,232,249,.25);
      animation: pulse 1s infinite ease-in-out;
    }
    @keyframes pulse{0%{transform:scale(.9); opacity:.6}50%{transform:scale(1.15); opacity:1}100%{transform:scale(.9); opacity:.6}}

    @media (max-width: 1000px){
      .cards{grid-template-columns: repeat(2, 1fr)}
      .sidebar{position:relative; top:auto; height:auto; width:auto; flex:1}
      .row{flex-direction:column}
      .searchbar{grid-template-columns: 1fr 1fr}
      .twoCol{grid-template-columns:1fr}
    }
    @media (max-width: 560px){
      .cards{grid-template-columns: 1fr}
      .hero h1{font-size:26px}
      .featureGrid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="inner">
      <a class="brand" href="#" onclick="SPA.go('home'); return false;">
        <div class="logo"></div>
        <div>HP Tourism Portal</div>
      </a>

      <div class="nav">
        <a href="#" onclick="SPA.go('home');return false;">Home</a>
        <a href="#" onclick="SPA.go('districts');return false;">Districts</a>
        <a href="#" onclick="SPA.go('packages');return false;">Packages</a>
        <a href="#" onclick="SPA.go('list','hotel');return false;">Hotels</a>
        <a href="#" onclick="SPA.go('list','temple');return false;">Temples</a>
        <a href="#" onclick="SPA.go('list','trek');return false;">Treks</a>
        <a href="#" onclick="SPA.go('routes');return false;">Routes</a>
      </div>
    </div>
  </div>

  <div class="container">

    <div id="loading" class="loadingBar">
      <div class="dot"></div>
      <div>
        <b>Loading live data from Firebaseâ€¦</b>
        <div class="small" id="loadingMsg">tourism/hp/districts</div>
      </div>
    </div>

    <!-- HOME -->
    <section id="page-home" class="page active">
      <div class="hero">
        <div class="wrap">
          <h1>Explore Himachal â€” Photo first, District wise, Route ready</h1>
          <p>Single-page tourism portal: places, hotels, temples, treks, packages and routes â€” all in one.</p>

          <div class="searchbar">
            <div class="input">
              <div style="width:100%">
                <label>District</label>
                <select id="heroDistrict"></select>
              </div>
            </div>

            <div class="input">
              <div style="width:100%">
                <label>Category</label>
                <select id="heroCategory">
                  <option value="all">All</option>
                  <option value="place">Places</option>
                  <option value="hotel">Hotels</option>
                  <option value="temple">Temples</option>
                  <option value="trek">Treks</option>
                </select>
              </div>
            </div>

            <div class="input">
              <div style="width:100%">
                <label>Search</label>
                <input id="heroQuery" placeholder="Manali, Kufri, Triund..."/>
              </div>
            </div>

            <button class="btn" id="heroGo">Explore</button>
          </div>

          <div class="tabsTop">
            <div class="pill" onclick="SPA.go('districts')">Browse Districts</div>
            <div class="pill" onclick="SPA.go('packages')">View Packages</div>
            <div class="pill" onclick="SPA.openCapabilities()">Portal Capabilities</div>
          </div>
        </div>
      </div>

      <div class="shell row">
        <aside class="sidebar">
          <div class="side-title">Filters <span class="small">single page</span></div>
          <div class="divider"></div>

          <div class="small">District</div>
          <div id="districtPills" class="pills" style="margin-top:8px;"></div>

          <div class="divider"></div>
          <div class="small">Category</div>
          <div id="typePills" class="pills" style="margin-top:8px;"></div>

          <div class="divider"></div>
          <div class="small">Search</div>
          <div class="input" style="margin-top:8px;">
            <div style="width:100%">
              <label>Search anywhere</label>
              <input id="searchInput" placeholder="snow, heritage, monastery..."/>
            </div>
          </div>

          <div class="divider"></div>
          <div class="panel">
            <h3>Tip</h3>
            <div class="note">Click any card to open Place Detail inside this same page.</div>
          </div>
        </aside>

        <main class="content">
          <div class="sectionHead">
            <div>
              <h2>Featured results</h2>
              <div class="meta">All categories â€¢ photo-first tiles</div>
            </div>
            <div class="meta" id="cardsMeta"></div>
          </div>
          <div id="cardsWrap" class="cards"></div>
          <div class="footer">Â© HP Tourism Portal â€” Single page version</div>
        </main>
      </div>
    </section>

    <!-- DISTRICTS -->
    <section id="page-districts" class="page">
      <div class="sectionHead">
        <div>
          <h2>Districts of Himachal Pradesh</h2>
          <div class="meta">Tap a district to filter Home instantly</div>
        </div>
      </div>
      <div id="districtGrid" class="cards"></div>
      <div class="footer">Click a district â†’ back to Home with filter</div>
    </section>

    <!-- PACKAGES (Demo; you can later store packages in Firebase too) -->
    <section id="page-packages" class="page">
      <div class="sectionHead">
        <div>
          <h2>HP Packages (Demo)</h2>
          <div class="meta">Single page packages</div>
        </div>
        <div class="meta" id="pkgMeta"></div>
      </div>

      <div class="row">
        <aside class="sidebar">
          <div class="side-title">Package Filters <span class="small">HP</span></div>
          <div class="divider"></div>

          <div class="small">District</div>
          <select id="pkgDistrict" class="input" style="width:100%"></select>

          <div class="divider"></div>
          <div class="small">Search</div>
          <div class="input" style="margin-top:8px;">
            <div style="width:100%">
              <label>Search packages</label>
              <input id="pkgSearch" placeholder="Shimla, Manali..."/>
            </div>
          </div>

          <div class="divider"></div>
          <div class="panel">
            <h3>Next</h3>
            <div class="note">Packages à¤…à¤­à¥€ demo à¤¹à¥ˆà¤‚. à¤šà¤¾à¤¹à¥‹ à¤¤à¥‹ Firebase à¤®à¥‡à¤‚ à¤­à¥€ à¤¡à¤¾à¤² à¤¦à¥‡à¤‚à¤—à¥‡.</div>
          </div>
        </aside>

        <main class="content">
          <div id="pkgWrap" class="cards"></div>
        </main>
      </div>
    </section>

    <!-- LISTINGS -->
    <section id="page-list" class="page">
      <div class="sectionHead">
        <div>
          <h2 id="listTitle">Listing</h2>
          <div class="meta">Filter by district â€¢ photo cards</div>
        </div>
        <div class="meta" id="listMeta"></div>
      </div>

      <div class="row">
        <aside class="sidebar">
          <div class="side-title">Filters <span class="small" id="listTypeTag"></span></div>
          <div class="divider"></div>

          <div class="small">District</div>
          <select id="listDistrict" class="input" style="width:100%"></select>

          <div class="divider"></div>
          <div class="small">Search</div>
          <div class="input" style="margin-top:8px;">
            <div style="width:100%">
              <label>Search</label>
              <input id="listSearch" placeholder="budget, heritage, beginner..."/>
            </div>
          </div>

          <div class="divider"></div>
          <div class="panel">
            <h3>Tip</h3>
            <div class="note">Click any card â†’ Place Detail in same page.</div>
          </div>
        </aside>

        <main class="content">
          <div id="listWrap" class="cards"></div>
        </main>
      </div>
    </section>

    <!-- ROUTES (MAP) -->
    <section id="page-routes" class="page">
      <div class="sectionHead">
        <div>
          <h2>Routes & Map (OpenStreetMap)</h2>
          <div class="meta">Pins from Firebase coords (lat/lng)</div>
        </div>
      </div>

      <div class="panel">
        <h3>All Locations Map</h3>
        <div class="note">If coords missing, pin wonâ€™t show.</div>
        <div class="divider"></div>
        <div id="allMap" class="mapBox"></div>
      </div>

      <div class="footer">Map works without API key</div>
    </section>

    <!-- PLACE DETAIL -->
    <section id="page-detail" class="page">
      <div class="sectionHead">
        <div>
          <h2 id="detailTitle">Place Detail</h2>
          <div class="meta">Back to Home anytime</div>
        </div>
        <div style="display:flex; gap:10px">
          <button class="btn ghost" onclick="SPA.go('home')">â¬… Back</button>
        </div>
      </div>

      <div class="twoCol">
        <div class="panel">
          <h3 id="dName">Place</h3>
          <div class="note" id="dDesc"></div>

          <div class="divider"></div>
          <div class="kv">
            <div class="item"><b>District</b><span id="dDistrict">-</span></div>
            <div class="item"><b>Best time</b><span id="dBest">-</span></div>
          </div>

          <div class="divider"></div>
          <h3>Highlights</h3>
          <div id="dHighlights" class="pills"></div>

          <div class="divider"></div>
          <h3>Nearby</h3>
          <div id="dNearby" class="pills"></div>
        </div>

        <div class="panel">
          <h3>Map (if coords available)</h3>
          <div class="divider"></div>
          <div id="detailMap" class="mapBox" style="height:280px;"></div>

          <div class="divider"></div>
          <h3>Expenditure Calculator (Demo)</h3>
          <div class="formRow">
            <div class="input"><div style="width:100%"><label>Fuel â‚¹/L</label><input id="fuelCost" type="number" value="105"></div></div>
            <div class="input"><div style="width:100%"><label>Mileage km/L</label><input id="kmpl" type="number" value="14"></div></div>
            <div class="input"><div style="width:100%"><label>Toll â‚¹</label><input id="toll" type="number" value="300"></div></div>
            <div class="input"><div style="width:100%"><label>Days</label><input id="days" type="number" value="2"></div></div>
          </div>
          <div class="input" style="margin-top:10px;"><div style="width:100%"><label>Per day â‚¹</label><input id="perDay" type="number" value="1500"></div></div>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" onclick="SPA.calc()">Calculate</button>
            <button class="btn ghost" onclick="SPA.go('routes')">Open Routes</button>
          </div>

          <div class="divider"></div>
          <div id="calcOut" class="note">Calculate to see result.</div>
        </div>
      </div>
    </section>

  </div>

  <!-- CAPABILITIES MODAL -->
  <div id="capModal" class="modalBack hidden">
    <div class="modal">
      <div class="top">
        <div>
          <h3>Portal Capabilities</h3>
          <div class="small">Single-page version</div>
        </div>
        <button class="x" onclick="SPA.closeCapabilities()">âœ•</button>
      </div>
      <div class="body">
        <div class="featureGrid">
          <div class="feature"><b>All in one page</b><span>No multi-pages. Fast & simple.</span></div>
          <div class="feature"><b>District-wise browsing</b><span>Filter instantly.</span></div>
          <div class="feature"><b>Photo-first cards</b><span>Premium tourism feel.</span></div>
          <div class="feature"><b>Routes map</b><span>OpenStreetMap pins, no key.</span></div>
          <div class="feature"><b>Firebase live</b><span>Sheet â†’ Firebase â†’ Website</span></div>
          <div class="feature"><b>Place detail</b><span>Detail opens inside same page.</span></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
          <button class="btn ghost" onclick="SPA.closeCapabilities()">Close</button>
          <button class="btn" onclick="SPA.closeCapabilities(); SPA.go('home')">Start</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------
    // CONFIG: Your Firebase RTDB
    // -----------------------
    const FIREBASE_DB = "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app";

    // Your structure:
    // /tourism/hp/districts/{District}/segments/{destinations|hotels|temples|treks}/{itemKey}
    const SEGMENT_MAP = {
      destinations: "place",
      hotels: "hotel",
      temples: "temple",
      treks: "trek"
    };

    // -----------------------
    // UI helper (replacing assets/ui.js)
    // -----------------------
    const UI = {
      qs:(s,r=document)=>r.querySelector(s),
      qsa:(s,r=document)=>[...r.querySelectorAll(s)],
      fmtINR(n){
        try { return new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(n); }
        catch(e){ return "â‚¹"+Math.round(n||0); }
      }
    };

    function slug(s){
      return (s||"").toString().trim().toLowerCase()
        .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    }
    function titleFromSlug(s){
      return (s||"").toString().replace(/-/g," ").replace(/\b\w/g,c=>c.toUpperCase());
    }
    function parseTags(t){
      if(!t) return [];
      if(Array.isArray(t)) return t.map(x=>String(x).trim()).filter(Boolean);
      return String(t).split(/[,|]/).map(x=>x.trim()).filter(Boolean);
    }

    // Global data (replacing assets/data.js)
    let HP_DATA = { districts:[], items:[], packages:[] };

    // Demo packages (optional)
    HP_DATA.packages = [
      { id:"shimla-kufri-2d", name:"Shimla + Kufri (2 Days)", district:"shimla", days:2, priceFrom:4999,
        includes:["Mall Road","Jakhoo","Kufri points","Local sightseeing"],
        img:"https://images.unsplash.com/photo-1524492412937-b28074a5d7da?auto=format&fit=crop&w=1600&q=70"
      },
      { id:"manali-solang-3d", name:"Manali + Solang (3 Days)", district:"kullu", days:3, priceFrom:8999,
        includes:["Old Manali","Solang Valley","Atal Tunnel route","Cafe walk"],
        img:"https://images.unsplash.com/photo-1627920769842-6887c6df05ca?auto=format&fit=crop&w=1600&q=70"
      }
    ];

    async function loadHPDataFromFirebase(){
      UI.qs("#loadingMsg").textContent = "Fetching: /tourism/hp/districts";
      const res = await fetch(`${FIREBASE_DB}/tourism/hp/districts.json`, {cache:"no-store"});
      const districtsNode = await res.json();

      if(!districtsNode) throw new Error("No data found at /tourism/hp/districts");

      const districts = [];
      const items = [];

      for(const districtName of Object.keys(districtsNode)){
        const districtId = slug(districtName);
        districts.push({ id: districtId, name: districtName });

        const segments = districtsNode[districtName]?.segments || {};

        for(const segName of Object.keys(SEGMENT_MAP)){
          const segItems = segments?.[segName] || {};
          for(const key of Object.keys(segItems)){
            const r = segItems[key] || {};
            const lat = (r.lat!==undefined && r.lat!=="") ? Number(r.lat) : null;
            const lng = (r.lng!==undefined && r.lng!=="") ? Number(r.lng) : null;

            items.push({
              id: slug(r.name || key),
              name: (r.name || key || "Untitled").toString(),
              district: districtId,
              type: SEGMENT_MAP[segName],
              tags: parseTags(r.tags),
              short: (r.notes || "").toString(),
              img: (r.photo || "").toString() ||
                   "https://images.unsplash.com/photo-1482192596544-9eb780fc7f66?auto=format&fit=crop&w=1600&q=70",
              bestTime: (r.bestSeason || r.bestSeasonason || "").toString() || "-",
              rating: (r.rating!==undefined && r.rating!=="") ? Number(r.rating) : null,
              phone: (r.phone || "").toString(),
              coords: (lat && lng) ? [lat, lng] : null,
              entryFee: (r.entryFee || "").toString(),
              timing: (r.timing || "").toString(),
              priceMin: (r.priceMin!==undefined && r.priceMin!=="") ? Number(r.priceMin) : null,
              priceMax: (r.priceMax!==undefined && r.priceMax!=="") ? Number(r.priceMax) : null
            });
          }
        }
      }

      // sort districts
      districts.sort((a,b)=>a.name.localeCompare(b.name));

      // attach
      HP_DATA.districts = districts;
      HP_DATA.items = items;

      // hide loading bar
      UI.qs("#loading").classList.add("hidden");
    }

    // -----------------------
    // SPA Controller (replacing assets/app.js)
    // -----------------------
    const SPA = {
      state: { district:"all", type:"all", q:"", listType:"hotel", pkgDistrict:"all", pkgQ:"", selected:null },
      mapAll:null, mapDetail:null, allMarkers:[],

      go(page, param){
        UI.qsa(".page").forEach(p=>p.classList.remove("active"));
        UI.qs("#page-"+page).classList.add("active");

        if(page==="list" && param) { SPA.state.listType = param; SPA.renderList(); }
        if(page==="districts") SPA.renderDistricts();
        if(page==="packages") SPA.renderPackages();
        if(page==="routes") SPA.renderRoutesMap();
      },

      openCapabilities(){ UI.qs("#capModal").classList.remove("hidden"); },
      closeCapabilities(){ UI.qs("#capModal").classList.add("hidden"); },

      fillDistrictSelect(sel, all=true){
        const opts = (all?`<option value="all">All Districts</option>`:"") +
          (HP_DATA.districts||[]).map(d=>`<option value="${d.id}">${d.name}</option>`).join("");
        sel.innerHTML = opts;
      },

      init(){
        // HERO dropdown
        SPA.fillDistrictSelect(UI.qs("#heroDistrict"), true);

        // district pills
        const pills = UI.qs("#districtPills");
        pills.innerHTML = `<div class="pill active" data-d="all">All</div>` +
          (HP_DATA.districts||[]).map(d=>`<div class="pill" data-d="${d.id}">${d.name}</div>`).join("");

        pills.addEventListener("click", (e)=>{
          const p = e.target.closest(".pill"); if(!p) return;
          SPA.state.district = p.dataset.d;
          UI.qsa("#districtPills .pill").forEach(x=>x.classList.toggle("active", x.dataset.d===SPA.state.district));
          SPA.renderHomeCards();
        });

        // type pills
        const typePills = UI.qs("#typePills");
        typePills.innerHTML = `
          <div class="pill active" data-t="all">All</div>
          <div class="pill" data-t="place">Places</div>
          <div class="pill" data-t="hotel">Hotels</div>
          <div class="pill" data-t="temple">Temples</div>
          <div class="pill" data-t="trek">Treks</div>
        `;
        typePills.addEventListener("click",(e)=>{
          const p = e.target.closest(".pill"); if(!p) return;
          SPA.state.type = p.dataset.t;
          UI.qsa("#typePills .pill").forEach(x=>x.classList.toggle("active", x.dataset.t===SPA.state.type));
          SPA.renderHomeCards();
        });

        UI.qs("#searchInput").addEventListener("input", e=>{
          SPA.state.q = e.target.value.trim().toLowerCase();
          SPA.renderHomeCards();
        });

        UI.qs("#heroGo").addEventListener("click", ()=>{
          SPA.state.district = UI.qs("#heroDistrict").value;
          SPA.state.type = UI.qs("#heroCategory").value;
          SPA.state.q = UI.qs("#heroQuery").value.trim().toLowerCase();

          UI.qsa("#districtPills .pill").forEach(x=>x.classList.toggle("active", x.dataset.d===SPA.state.district));
          UI.qsa("#typePills .pill").forEach(x=>x.classList.toggle("active", x.dataset.t===SPA.state.type));
          SPA.renderHomeCards();
          window.scrollTo({top: 520, behavior:"smooth"});
        });

        SPA.renderHomeCards();
      },

      filterItems(typeOverride=null){
        const t = typeOverride ?? SPA.state.type;
        const q = SPA.state.q;
        return (HP_DATA.items||[]).filter(x=>{
          const okD = SPA.state.district==="all" || x.district===SPA.state.district;
          const okT = t==="all" || x.type===t;
          const okQ = !q || (x.name||"").toLowerCase().includes(q)
                         || (x.short||"").toLowerCase().includes(q)
                         || (x.tags||[]).join(" ").toLowerCase().includes(q);
          return okD && okT && okQ;
        });
      },

      cardHTML(item){
        const distName = HP_DATA.districts.find(d=>d.id===item.district)?.name || titleFromSlug(item.district);
        const icons = {place:"ðŸ“ Place", hotel:"ðŸ¨ Hotel", temple:"ðŸ›• Temple", trek:"ðŸ¥¾ Trek"};
        const chips = (item.tags||[]).slice(0,3).map(t=>`<div class="iconChip">${t}</div>`).join("");
        return `
          <div class="card" onclick="SPA.openDetail('${item.id}')">
            <div class="img">
              <img src="${item.img}" alt="${item.name}">
              <div class="badges">
                <div class="badge">${distName}</div>
                <div class="badge">${icons[item.type]||"Info"}</div>
              </div>
            </div>
            <div class="body">
              <h3>${item.name}</h3>
              <p>${item.short||""}</p>
              <div class="quickIcons">${chips}</div>
            </div>
          </div>
        `;
      },

      renderHomeCards(){
        const items = SPA.filterItems();
        UI.qs("#cardsMeta").textContent = `${items.length} results`;
        UI.qs("#cardsWrap").innerHTML = items.map(SPA.cardHTML).join("");
      },

      renderDistricts(){
        const wrap = UI.qs("#districtGrid");
        wrap.innerHTML = (HP_DATA.districts||[]).map(d=>`
          <div class="card" onclick="SPA.state.district='${d.id}'; SPA.go('home'); SPA.renderHomeCards();">
            <div class="img">
              <img src="https://images.unsplash.com/photo-1482192596544-9eb780fc7f66?auto=format&fit=crop&w=1600&q=70" alt="${d.name}">
              <div class="badges"><div class="badge">District</div></div>
            </div>
            <div class="body">
              <h3>${d.name}</h3>
              <p>Explore places, hotels, temples & treks in ${d.name}.</p>
              <div class="quickIcons">
                <div class="iconChip">Places</div>
                <div class="iconChip">Hotels</div>
                <div class="iconChip">Routes</div>
              </div>
            </div>
          </div>
        `).join("");
      },

      renderPackages(){
        SPA.fillDistrictSelect(UI.qs("#pkgDistrict"), true);
        const dd = UI.qs("#pkgDistrict");
        const q = UI.qs("#pkgSearch");
        dd.value = SPA.state.pkgDistrict;
        q.value = SPA.state.pkgQ;

        dd.onchange = ()=>{ SPA.state.pkgDistrict = dd.value; SPA.renderPackages(); };
        q.oninput = ()=>{ SPA.state.pkgQ = q.value.trim().toLowerCase(); SPA.renderPackages(); };

        const items = (HP_DATA.packages||[]).filter(p=>{
          const okD = SPA.state.pkgDistrict==="all" || p.district===SPA.state.pkgDistrict;
          const okQ = !SPA.state.pkgQ || p.name.toLowerCase().includes(SPA.state.pkgQ) || (p.includes||[]).join(" ").toLowerCase().includes(SPA.state.pkgQ);
          return okD && okQ;
        });

        UI.qs("#pkgMeta").textContent = `${items.length} packages`;
        UI.qs("#pkgWrap").innerHTML = items.map(p=>{
          const distName = HP_DATA.districts.find(d=>d.id===p.district)?.name || titleFromSlug(p.district);
          return `
            <div class="card">
              <div class="img">
                <img src="${p.img}" alt="${p.name}">
                <div class="badges">
                  <div class="badge">${distName}</div>
                  <div class="badge">${p.days} Days</div>
                </div>
              </div>
              <div class="body">
                <h3>${p.name}</h3>
                <p>Includes: ${(p.includes||[]).slice(0,3).join(", ")}...</p>
                <div class="quickIcons">
                  <div class="iconChip">From ${UI.fmtINR(p.priceFrom||0)}</div>
                  <div class="iconChip" onclick="SPA.state.district='${p.district}'; SPA.go('home'); SPA.renderHomeCards();">Explore District</div>
                </div>
              </div>
            </div>
          `;
        }).join("");
      },

      renderList(){
        SPA.fillDistrictSelect(UI.qs("#listDistrict"), true);

        const type = SPA.state.listType;
        UI.qs("#listTitle").textContent = type==="hotel"?"Hotels":type==="temple"?"Temples":"Treks";
        UI.qs("#listTypeTag").textContent = type;

        const dd = UI.qs("#listDistrict");
        const q = UI.qs("#listSearch");
        dd.value = SPA.state.district;

        dd.onchange = ()=>{ SPA.state.district = dd.value; SPA.renderList(); };
        q.oninput = ()=>{ SPA.state.q = q.value.trim().toLowerCase(); SPA.renderList(); };

        const items = SPA.filterItems(type);
        UI.qs("#listMeta").textContent = `${items.length} results`;
        UI.qs("#listWrap").innerHTML = items.map(SPA.cardHTML).join("");
      },

      openDetail(id){
        const item = (HP_DATA.items||[]).find(x=>x.id===id);
        if(!item){ alert("Not found"); return; }
        SPA.state.selected = item;

        const distName = HP_DATA.districts.find(d=>d.id===item.district)?.name || titleFromSlug(item.district);

        UI.qs("#dName").textContent = item.name;
        UI.qs("#detailTitle").textContent = item.name;
        UI.qs("#dDesc").textContent = item.short || "";
        UI.qs("#dDistrict").textContent = distName;
        UI.qs("#dBest").textContent = item.bestTime || "-";
        UI.qs("#dHighlights").innerHTML = (item.highlights||item.tags||[]).slice(0,6).map(x=>`<div class="pill active">${x}</div>`).join("");
        UI.qs("#dNearby").innerHTML = (item.nearby||[]).slice(0,6).map(x=>`<div class="pill">${x}</div>`).join("") || `<div class="note">No nearby data yet.</div>`;

        SPA.go("detail");
        setTimeout(()=>SPA.renderDetailMap(), 200);
      },

      renderRoutesMap(){
        if(!window.L){ return; }

        if(!SPA.mapAll){
          SPA.mapAll = L.map("allMap", {scrollWheelZoom:false}).setView([31.7,77.2], 7);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:18, attribution:"Â© OpenStreetMap"}).addTo(SPA.mapAll);
        }

        SPA.allMarkers.forEach(m=>SPA.mapAll.removeLayer(m));
        SPA.allMarkers = [];

        (HP_DATA.items||[]).forEach(it=>{
          if(!it.coords) return;
          const m = L.marker(it.coords).addTo(SPA.mapAll).bindPopup(`<b>${it.name}</b>`);
          SPA.allMarkers.push(m);
        });

        if(SPA.allMarkers.length){
          const group = L.featureGroup(SPA.allMarkers);
          SPA.mapAll.fitBounds(group.getBounds().pad(0.25));
        }
        setTimeout(()=>SPA.mapAll.invalidateSize(), 200);
      },

      renderDetailMap(){
        if(!window.L){ return; }
        const it = SPA.state.selected;
        const center = it?.coords || [31.7,77.2];

        const el = document.getElementById("detailMap");
        el.innerHTML = "";

        SPA.mapDetail = L.map("detailMap", {scrollWheelZoom:false}).setView(center, it?.coords ? 12 : 7);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:18, attribution:"Â© OpenStreetMap"}).addTo(SPA.mapDetail);
        if(it?.coords) L.marker(it.coords).addTo(SPA.mapDetail).bindPopup(`<b>${it.name}</b>`).openPopup();
        setTimeout(()=>SPA.mapDetail.invalidateSize(), 200);
      },

      calc(){
        const approxKm = 35; // demo
        const fuelCost = Number(UI.qs("#fuelCost").value||0);
        const kmpl = Math.max(1, Number(UI.qs("#kmpl").value||12));
        const toll = Number(UI.qs("#toll").value||0);
        const days = Math.max(1, Number(UI.qs("#days").value||1));
        const perDay = Number(UI.qs("#perDay").value||0);

        const fuelTotal = (approxKm / kmpl) * fuelCost;
        const stay = days * perDay;
        const total = fuelTotal + toll + stay;

        UI.qs("#calcOut").innerHTML = `
          <div class="kv">
            <div class="item"><b>Fuel</b><span>${UI.fmtINR(fuelTotal)}</span></div>
            <div class="item"><b>Toll</b><span>${UI.fmtINR(toll)}</span></div>
            <div class="item"><b>Stay+Food</b><span>${UI.fmtINR(stay)}</span></div>
            <div class="item"><b>Total</b><span>${UI.fmtINR(total)}</span></div>
          </div>
          <div class="note" style="margin-top:8px;">Demo estimate. Replace approxKm with real distance later.</div>
        `;
      }
    };

    // BOOT: Load Firebase first, then init SPA
    document.addEventListener("DOMContentLoaded", async ()=>{
      try{
        await loadHPDataFromFirebase();
        SPA.init();
      }catch(err){
        console.error(err);
        UI.qs("#loadingMsg").textContent = "ERROR: " + (err?.message || err);
        alert("Firebase data load failed. Check Rules (read=true) and path /tourism/hp/districts");
      }
    });
  </script>
</body>
</html>
