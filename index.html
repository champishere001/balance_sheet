<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer ‚Ä¢ District Guide</title>

  <style>
    :root{
      --bg0:#050812; --bg1:#070B17;
      --text:#F3F6FF;
      --muted: rgba(243,246,255,.74);
      --muted2: rgba(243,246,255,.58);

      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --stroke: rgba(255,255,255,.14);

      --brand:#FF7A18; --brand2:#FFC062;

      --r:14px; --r2:18px;
      --shadow: 0 10px 26px rgba(0,0,0,.40);
      --shadow2: 0 6px 16px rgba(0,0,0,.34);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 700px at 15% 10%, rgba(255,122,24,.10), transparent 60%),
        radial-gradient(800px 600px at 90% 20%, rgba(90,120,255,.10), transparent 60%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
      overflow-x:hidden;
    }

    /* Header */
    .topbar{
      position:sticky; top:0; z-index:30;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .topbarIn{
      max-width:1200px; margin:0 auto;
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 0 16px rgba(255,122,24,.40);
    }
    .brand b{display:block; font-size:14px; letter-spacing:.2px}
    .brand small{display:block; font-weight:700; color:var(--muted); margin-top:2px}

    .actions{display:flex; gap:8px; align-items:center}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:9px 10px;
      border-radius:999px;
      font-weight:850;
      cursor:pointer;
      font-size:12px;
    }
    .btnPrimary{
      border:0;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#0b1220;
      box-shadow: 0 10px 20px rgba(255,122,24,.16);
    }

    /* Layout */
    .wrap{max-width:1200px;margin:0 auto;padding:12px; display:grid; gap:12px;}
    .hero{
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r2);
      overflow:hidden;
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      position:relative;
    }
    .heroCover{
      position:absolute; inset:0;
      background-image:url("https://images.unsplash.com/photo-1548013146-72479768bada?auto=format&fit=crop&w=1600&q=70");
      background-size:cover; background-position:center;
      filter: blur(14px) saturate(1.05);
      opacity:.35;
      transform: scale(1.08);
    }
    .heroOverlay{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(5,8,18,.45), rgba(5,8,18,.92));
    }
    .heroIn{position:relative; padding:14px}
    .heroH{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    .heroTitle{margin:0; font-size:clamp(18px,2.2vw,30px); font-weight:950}
    .quote{
      margin-top:6px;
      color: rgba(243,246,255,.88);
      font-weight:650;
      line-height:1.45;
      font-size:13px;
      max-width:900px;
    }
    .miniRow{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px;
      font-weight:850;
      color: rgba(243,246,255,.92);
    }

    /* District Grid first */
    .panel{
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r2);
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .panelHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.18);
    }
    .panelHead b{font-size:12px; letter-spacing:.2px}
    .panelHead small{color:var(--muted); font-weight:800}
    .panelBody{padding:12px}

    .districtGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .dTile{
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      cursor:pointer;
      transition:.12s;
      box-shadow: var(--shadow2);
      min-height: 104px;
      position:relative;
    }
    .dTile:hover{transform: translateY(-2px); border-color:rgba(255,255,255,.22)}
    .dTile.active{border-color:rgba(255,122,24,.55); background:rgba(255,122,24,.08)}
    .dBg{
      position:absolute; inset:0;
      background-size:cover; background-position:center;
      filter: saturate(1.05);
      opacity:.35;
    }
    .dShade{position:absolute; inset:0; background: linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.72))}
    .dTxt{position:relative; padding:10px}
    .dTxt b{display:block; font-size:13px; font-weight:950}
    .dTxt small{display:block; margin-top:6px; font-size:11px; color:var(--muted); font-weight:750; line-height:1.25}

    /* Content + Map area */
    .contentGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr; /* map second priority */
      gap:12px;
      align-items:start;
    }
    .infoStack{display:grid; gap:12px}
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r2);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .boxHead{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .boxHead b{font-size:12px; letter-spacing:.2px}
    .boxBody{padding:12px; font-size:13px; line-height:1.55; color: rgba(243,246,255,.90); font-weight:650}
    .empty{
      padding:12px;
      border-radius:var(--r2);
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: rgba(243,246,255,.86);
      font-weight:850;
    }

    /* Tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{background: rgba(255,122,24,.16); border-color: rgba(255,122,24,.35)}
    .toolsRow{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    .input{
      flex:1; min-width:220px;
      padding:10px 12px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-weight:750;
    }
    .select{
      padding:10px 12px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-weight:850;
      cursor:pointer;
    }

    /* Cards */
    .cards{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:10px}
    .card{
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      overflow:hidden;
      cursor:pointer;
      transition:.12s;
      box-shadow: var(--shadow2);
    }
    .card:hover{transform: translateY(-2px); border-color: rgba(255,255,255,.22)}
    .thumb{height:118px; background-size:cover; background-position:center; position:relative}
    .thumb:after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.55))}
    .badge{
      position:absolute; top:10px; left:10px;
      padding:5px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.30);
    }
    .pad{padding:10px 12px}
    .pad b{display:block; font-weight:950; font-size:13px}
    .meta{margin-top:6px; color:var(--muted); font-weight:750; font-size:12px; line-height:1.25}
    .meta2{margin-top:6px; color:var(--muted2); font-weight:750; font-size:12px; line-height:1.25}
    .tagRow{margin-top:8px; display:flex; gap:6px; flex-wrap:wrap}
    .tag{
      font-size:11px; font-weight:850;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(243,246,255,.88);
    }

    /* Map box */
    .mapFrameWrap{height: 560px}
    iframe{width:100%; height:100%; border:0; background: rgba(0,0,0,.22)}

    /* Floating drawer for district list on scroll */
    .floatBtn{
      position:fixed; right:14px; bottom:14px; z-index:40;
      border:0;
      padding:12px 14px;
      border-radius:999px;
      font-weight:950;
      cursor:pointer;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#0b1220;
      box-shadow: 0 18px 40px rgba(255,122,24,.18);
      display:none;
    }
    .drawerMask{
      position:fixed; inset:0; background: rgba(0,0,0,.55);
      display:none; z-index:50;
    }
    .drawer{
      position:fixed; right:0; top:0; height:100vh; width:min(420px, 92vw);
      background: rgba(5,8,18,.92);
      border-left:1px solid rgba(255,255,255,.14);
      box-shadow: -10px 0 30px rgba(0,0,0,.55);
      display:none; z-index:60;
      padding:12px;
      overflow:auto;
    }
    .drawerHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .drawerHead b{font-size:13px}
    .xBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }

    /* Responsive */
    @media(max-width:980px){
      .districtGrid{grid-template-columns: repeat(2, minmax(0,1fr));}
      .contentGrid{grid-template-columns:1fr}
      .mapFrameWrap{height: 460px}
      .cards{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="topbarIn">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <b>Himachal Explorer</b>
          <small>District guide ‚Ä¢ routes on map ‚Ä¢ photo-first places</small>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnScrollDistricts">Districts</button>
        <button class="btn btnPrimary" id="btnOpenMap">Open Map</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- Hero -->
    <section class="hero">
      <div class="heroCover" id="heroCover"></div>
      <div class="heroOverlay"></div>
      <div class="heroIn">
        <div class="heroH">
          <div>
            <h1 class="heroTitle" id="heroTitle">Himachal Pradesh</h1>
            <div class="quote" id="heroQuote">
              ‚ÄúWhere every turn is a view, and every valley tells a story.‚Äù
            </div>
            <div class="miniRow" id="miniRow">
              <span class="pill" id="statDistricts">‚Äî districts</span>
              <span class="pill" id="statPlaces">‚Äî places</span>
              <span class="pill">Map is optional (2nd priority)</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- District grid FIRST (as you asked) -->
    <section class="panel" id="districtSection">
      <div class="panelHead">
        <b>Choose a District</b>
        <small id="dHint">Click a tile to load brief + how to reach + places</small>
      </div>
      <div class="panelBody">
        <div class="districtGrid" id="districtGrid">
          <div class="empty">Loading districts‚Ä¶</div>
        </div>
      </div>
    </section>

    <!-- Info first, Map second -->
    <section class="contentGrid">
      <div class="infoStack">
        <div class="box">
          <div class="boxHead"><b>District Brief</b></div>
          <div class="boxBody" id="briefBox"><div class="empty">Select a district to show information.</div></div>
        </div>

        <div class="box">
          <div class="boxHead"><b>How to Reach</b></div>
          <div class="boxBody" id="reachBox"><div class="empty">Select a district to show routes guidance.</div></div>
        </div>

        <div class="box">
          <div class="boxHead">
            <b id="placesTitle">Places</b>
            <div class="tabs" id="tabs" style="display:none">
              <div class="tab active" data-t="all">All</div>
              <div class="tab" data-t="destinations">Destinations</div>
              <div class="tab" data-t="lakes">Lakes</div>
              <div class="tab" data-t="temples">Temples</div>
              <div class="tab" data-t="treks">Treks</div>
              <div class="tab" data-t="hotels">Hotels</div>
            </div>
          </div>
          <div class="boxBody" id="placesBox">
            <div class="empty">Select a district‚Ä¶</div>
          </div>
        </div>
      </div>

      <div class="box">
        <div class="boxHead">
          <b>Map</b>
          <small class="muted" id="mapHint">Select district ‚Üí map auto centers</small>
        </div>
        <div class="boxBody" style="padding:0">
          <div class="mapFrameWrap">
            <iframe id="mapFrame" src="map.html" title="HP Map"></iframe>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Floating districts (shows on scroll) -->
  <button class="floatBtn" id="floatBtn">Districts</button>
  <div class="drawerMask" id="drawerMask"></div>
  <aside class="drawer" id="drawer">
    <div class="drawerHead">
      <b>Districts</b>
      <button class="xBtn" id="drawerClose">Close</button>
    </div>
    <input class="input" id="drawerSearch" placeholder="Search district‚Ä¶" style="margin-top:10px"/>
    <div style="margin-top:10px" id="drawerList"></div>
  </aside>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.firebasestorage.app",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ac29",
      measurementId: "G-MGTDBCG896"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const ROOT = "tourism/hp/districts";
    const TYPES = ["destinations","lakes","temples","treks","hotels"];
    const TYPE_LABEL = { destinations:"Destinations", lakes:"Lakes", temples:"Temples", treks:"Treks", hotels:"Hotels" };

    // UI refs
    const districtGrid = document.getElementById("districtGrid");
    const heroTitle = document.getElementById("heroTitle");
    const heroQuote = document.getElementById("heroQuote");
    const heroCover = document.getElementById("heroCover");
    const statDistricts = document.getElementById("statDistricts");
    const statPlaces = document.getElementById("statPlaces");

    const briefBox = document.getElementById("briefBox");
    const reachBox = document.getElementById("reachBox");
    const placesTitle = document.getElementById("placesTitle");
    const placesBox = document.getElementById("placesBox");
    const tabs = document.getElementById("tabs");

    const mapFrame = document.getElementById("mapFrame");
    const mapHint = document.getElementById("mapHint");

    // Drawer UI
    const floatBtn = document.getElementById("floatBtn");
    const drawer = document.getElementById("drawer");
    const drawerMask = document.getElementById("drawerMask");
    const drawerClose = document.getElementById("drawerClose");
    const drawerSearch = document.getElementById("drawerSearch");
    const drawerList = document.getElementById("drawerList");
    const btnScrollDistricts = document.getElementById("btnScrollDistricts");
    const btnOpenMap = document.getElementById("btnOpenMap");

    // State
    let DISTRICTS = [];
    let ROOT_CACHE = {};
    let ACTIVE_DIST = "";
    let ACTIVE_TYPE = "all";
    let ALL_ITEMS = [];
    let PLACE_QUERY = "";
    let PLACE_SORT = "popular_desc";
    let TOTAL_PLACES = 0;

    const QUOTES = [
      "‚ÄúWhere every turn is a view, and every valley tells a story.‚Äù",
      "‚ÄúHimachal: snow peaks, pine air, and quiet roads to wonder.‚Äù",
      "‚ÄúSlow down. The mountains are doing something beautiful.‚Äù",
      "‚ÄúA place where the sky feels closer and time feels softer.‚Äù"
    ];

    const safeObj = (x)=> (x && typeof x==="object") ? x : {};
    const safeArr = (x)=> Array.isArray(x) ? x : [];
    const norm = (s)=> String(s ?? "").trim();
    const low = (s)=> norm(s).toLowerCase();

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function normalizeType(t){
      t = low(t);
      if(t==="lake") return "lakes";
      if(t==="temple") return "temples";
      if(t==="trek") return "treks";
      if(t==="hotel") return "hotels";
      return t;
    }

    function extractPhotos(item){
      // supports: photo (string with |), photos/images arrays, cover
      const out = [];
      const push = (u)=> { u = norm(u); if(u) out.push(u); };

      const pipeSplit = (s)=>{
        s = norm(s);
        if(!s) return [];
        return s.split("|").map(x=>x.trim()).filter(Boolean);
      };

      safeArr(item.photos).forEach(push);
      safeArr(item.images).forEach(push);
      safeArr(item.gallery).forEach(push);
      pipeSplit(item.photo).forEach(push);
      push(item.cover);
      push(item.photoUrl);
      push(item.imageUrl);

      // remove duplicates
      return Array.from(new Set(out));
    }

    function pickTitle(it){
      return norm(it.name) || norm(it.title) || norm(it.place) || norm(it.placeName) || "Untitled";
    }

    function hasGeo(x){
      return Number.isFinite(Number(x.lat)) && Number.isFinite(Number(x.lng));
    }

    function flattenDistrict(node){
      const seg = safeObj(node.segments);
      const out = [];
      for(const rawType of Object.keys(seg)){
        const t = normalizeType(rawType);
        if(!TYPES.includes(t)) continue;
        const bucket = safeObj(seg[rawType]);
        for(const id of Object.keys(bucket)){
          const it = safeObj(bucket[id]);
          out.push({
            id,
            type: t,
            title: pickTitle(it),
            notes: norm(it.notes || it.description || ""),
            tags: norm(it.tags) ? norm(it.tags).split("|").map(s=>s.trim()).filter(Boolean) : safeArr(it.tags),
            photos: extractPhotos(it),
            rating: Number(it.rating ?? "") || null,
            popularity: Number(it.popularityScore ?? it.popularity ?? "") || null,
            entryFee: Number(it.entryFee ?? "") || null,
            phone: norm(it.phone || ""),
            bestSeason: norm(it.bestSeason || ""),
            timing: norm(it.timing || ""),
            lat: Number(it.lat ?? it.latitude ?? ""),
            lng: Number(it.lng ?? it.longitude ?? ""),
            raw: it
          });
        }
      }
      return out;
    }

    function defaultBrief(d){
      return `‚Ä¢ ${d} is a key district of Himachal Pradesh.\n‚Ä¢ Explore destinations, lakes, temples, treks and hotels.\n‚Ä¢ Click any place card to open it on the map.`;
    }
    function defaultHowToReach(d){
      return `üõ£Ô∏è Road: Well connected by road routes.\nüöÜ Train: Nearest station depends on the route.\n‚úàÔ∏è Air: Nearest airport depends on the region.\n\nTip: Map will auto-focus when you select a place.`;
    }

    function districtCoverFallback(d){
      // fixed & consistent covers (not random source.unsplash)
      const q = encodeURIComponent(`${d} Himachal Pradesh mountains`);
      return `https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1200&q=70`;
    }

    function setHero(d){
      if(!d){
        heroTitle.textContent = "Himachal Pradesh";
        heroQuote.textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)];
        heroCover.style.backgroundImage = `url("https://images.unsplash.com/photo-1548013146-72479768bada?auto=format&fit=crop&w=1600&q=70")`;
        return;
      }
      heroTitle.textContent = d;
      heroQuote.textContent = QUOTES[Math.floor(Math.random()*QUOTES.length)];
      heroCover.style.backgroundImage = `url("${districtCoverFallback(d)}")`;
    }

    function focusDistrictOnMap(d){
      mapHint.textContent = `Map focused: ${d}`;
      mapFrame.src = `map.html#district=${encodeURIComponent(d)}&t=${Date.now()}`;
      setTimeout(()=>{
        mapFrame.contentWindow?.postMessage({ type:"FOCUS_DISTRICT", district:d }, "*");
      }, 600);
    }

    function focusPlaceOnMap(place){
      if(!Number.isFinite(place.lat) || !Number.isFinite(place.lng)) return;
      mapFrame.contentWindow?.postMessage({
        type:"FOCUS_PLACE",
        district: ACTIVE_DIST,
        title: place.title,
        lat: place.lat,
        lng: place.lng,
        type: place.type
      }, "*");
    }

    function cardHtml(x){
      const thumb = x.photos?.[0] ? x.photos[0] : "";
      const badge = TYPE_LABEL[x.type] || x.type;
      const parts = [
        x.rating ? `‚≠ê ${x.rating}` : "",
        x.popularity ? `üî• ${x.popularity}` : "",
        Number.isFinite(x.entryFee) ? `‚Çπ${x.entryFee}` : ""
      ].filter(Boolean).join(" ‚Ä¢ ");

      const geo = (Number.isFinite(x.lat) && Number.isFinite(x.lng)) ? " ‚Ä¢ Map" : "";

      return `
        <div class="card" data-id="${escapeHtml(x.id)}">
          <div class="thumb" style="background-image:url('${escapeHtml(thumb || "")}')">
            <div class="badge">${escapeHtml(badge)}${geo}</div>
          </div>
          <div class="pad">
            <b>${escapeHtml(x.title)}</b>
            <div class="meta">${escapeHtml(parts || "Tap to open on map (if lat/lng available)")}</div>
            ${x.notes ? `<div class="meta2">${escapeHtml(x.notes).slice(0,120)}${x.notes.length>120?"‚Ä¶":""}</div>` : ""}
            ${x.tags?.length ? `<div class="tagRow">${x.tags.slice(0,4).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</div>` : ""}
          </div>
        </div>
      `;
    }

    function sortItems(items){
      const byName = (a,b)=> String(a.title||"").localeCompare(String(b.title||""), undefined, {sensitivity:"base"});
      const pop = (x)=> Number.isFinite(x.popularity) ? x.popularity : -Infinity;
      const rat = (x)=> Number.isFinite(x.rating) ? x.rating : -Infinity;

      if(PLACE_SORT==="rating_desc") return items.sort((a,b)=> rat(b)-rat(a) || pop(b)-pop(a) || byName(a,b));
      return items.sort((a,b)=> pop(b)-pop(a) || rat(b)-rat(a) || byName(a,b));
    }

    function renderPlaces(){
      if(!ACTIVE_DIST){
        placesBox.innerHTML = `<div class="empty">Select a district‚Ä¶</div>`;
        return;
      }

      let items = ALL_ITEMS.slice();
      if(ACTIVE_TYPE !== "all") items = items.filter(x=>x.type===ACTIVE_TYPE);

      const q = low(PLACE_QUERY);
      if(q){
        items = items.filter(x => (`${x.title} ${x.notes} ${x.type} ${(x.tags||[]).join(" ")}`.toLowerCase()).includes(q));
      }

      items = sortItems(items);

      placesTitle.textContent = `${ACTIVE_TYPE==="all" ? "Places" : (TYPE_LABEL[ACTIVE_TYPE]||ACTIVE_TYPE)} ‚Ä¢ ${ACTIVE_DIST}`;

      placesBox.innerHTML = `
        <div class="toolsRow">
          <input class="input" id="placeSearch" placeholder="Search places‚Ä¶" value="${escapeHtml(PLACE_QUERY)}"/>
          <select class="select" id="placeSort">
            <option value="popular_desc">Popularity</option>
            <option value="rating_desc">Rating</option>
          </select>
        </div>
        ${!items.length ? `<div class="empty" style="margin-top:10px">No places found.</div>` : `
          <div class="cards">
            ${items.slice(0,60).map(cardHtml).join("")}
          </div>
          ${items.length>60 ? `<div style="margin-top:10px;color:var(--muted2);font-weight:800;font-size:12px">Showing first 60 items.</div>` : ""}
        `}
      `;

      const s = document.getElementById("placeSearch");
      const so = document.getElementById("placeSort");
      if(so) so.value = PLACE_SORT;

      let t=null;
      s?.addEventListener("input", ()=>{
        clearTimeout(t);
        t=setTimeout(()=>{ PLACE_QUERY = s.value; renderPlaces(); },120);
      });
      so?.addEventListener("change", ()=>{
        PLACE_SORT = so.value; renderPlaces();
      });

      [...placesBox.querySelectorAll(".card[data-id]")].forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          const place = ALL_ITEMS.find(p=>p.id===id);
          if(place && Number.isFinite(place.lat) && Number.isFinite(place.lng)){
            focusPlaceOnMap(place);
          }else{
            focusDistrictOnMap(ACTIVE_DIST);
          }
        });
      });
    }

    function setActiveType(t){
      ACTIVE_TYPE = t;
      [...tabs.querySelectorAll(".tab")].forEach(tab=>{
        tab.classList.toggle("active", tab.getAttribute("data-t")===t);
      });
      renderPlaces();
    }

    function renderDistrictTiles(){
      districtGrid.innerHTML = DISTRICTS.map(d=>{
        const active = (d===ACTIVE_DIST) ? "active" : "";
        const bg = districtCoverFallback(d);
        const pv = (ROOT_CACHE[d]?.__preview || []).slice(0,3);
        const line = pv.length ? pv.join(" ‚Ä¢ ") : "Tap to explore";
        return `
          <div class="dTile ${active}" data-d="${escapeHtml(d)}">
            <div class="dBg" style="background-image:url('${escapeHtml(bg)}')"></div>
            <div class="dShade"></div>
            <div class="dTxt">
              <b>${escapeHtml(d)}</b>
              <small>${escapeHtml(line)}</small>
            </div>
          </div>
        `;
      }).join("");

      [...districtGrid.querySelectorAll(".dTile")].forEach(el=>{
        el.addEventListener("click", ()=> openDistrict(el.getAttribute("data-d")));
      });

      renderDrawerList(); // keep drawer in sync
    }

    function computePreview(node){
      // take top destinations only (as you wanted)
      const seg = safeObj(node?.segments);
      const dest = safeObj(seg?.destinations);
      const arr = Object.keys(dest).map(id=>{
        const it = safeObj(dest[id]);
        return {
          title: pickTitle(it),
          pop: Number(it.popularityScore ?? it.popularity ?? 0) || 0,
          rating: Number(it.rating ?? 0) || 0
        };
      });
      arr.sort((a,b)=> (b.pop-a.pop) || (b.rating-a.rating) || a.title.localeCompare(b.title));
      return arr.slice(0,3).map(x=>x.title).filter(Boolean);
    }

    async function openDistrict(d){
      ACTIVE_DIST = d;
      ACTIVE_TYPE = "all";
      PLACE_QUERY = "";
      PLACE_SORT = "popular_desc";

      // UI
      setHero(d);
      briefBox.innerHTML = `<div class="empty">Loading‚Ä¶</div>`;
      reachBox.innerHTML = `<div class="empty">Loading‚Ä¶</div>`;
      placesBox.innerHTML = `<div class="empty">Loading‚Ä¶</div>`;
      tabs.style.display = "flex";
      setActiveType("all");
      renderDistrictTiles();

      focusDistrictOnMap(d);

      try{
        const snap = await get(ref(db, `${ROOT}/${d}`));
        const node = snap.exists() ? safeObj(snap.val()) : null;

        const info = safeObj(node?.districtInfo);
        const brief = norm(info.brief) || defaultBrief(d);
        const reach = norm(info.howToReach) || defaultHowToReach(d);

        briefBox.innerHTML = escapeHtml(brief).replaceAll("\n","<br/>");
        reachBox.innerHTML = escapeHtml(reach).replaceAll("\n","<br/>");

        ALL_ITEMS = node ? flattenDistrict(node) : [];
        renderPlaces();

      }catch(e){
        console.error(e);
        briefBox.innerHTML = `<div class="empty">Firebase read failed (rules/config?).</div>`;
        reachBox.innerHTML = `<div class="empty">Firebase read failed (rules/config?).</div>`;
        placesBox.innerHTML = `<div class="empty">Firebase read failed (rules/config?).</div>`;
      }

      // close drawer if open
      closeDrawer();
    }

    // Drawer list
    function renderDrawerList(){
      const q = low(drawerSearch.value);
      const list = DISTRICTS.filter(d => !q || low(d).includes(q));
      drawerList.innerHTML = list.map(d=>{
        const active = (d===ACTIVE_DIST) ? `style="border-color:rgba(255,122,24,.55);background:rgba(255,122,24,.08)"` : "";
        return `
          <div class="dTile" ${active} data-d="${escapeHtml(d)}" style="min-height:86px;margin-bottom:10px">
            <div class="dBg" style="background-image:url('${escapeHtml(districtCoverFallback(d))}')"></div>
            <div class="dShade"></div>
            <div class="dTxt">
              <b>${escapeHtml(d)}</b>
              <small>${escapeHtml((ROOT_CACHE[d]?.__preview||[]).slice(0,3).join(" ‚Ä¢ ") || "Tap to explore")}</small>
            </div>
          </div>
        `;
      }).join("");
      [...drawerList.querySelectorAll(".dTile")].forEach(el=>{
        el.addEventListener("click", ()=> openDistrict(el.getAttribute("data-d")));
      });
    }

    function openDrawer(){
      drawerMask.style.display = "block";
      drawer.style.display = "block";
      renderDrawerList();
    }
    function closeDrawer(){
      drawerMask.style.display = "none";
      drawer.style.display = "none";
    }
    drawerMask.addEventListener("click", closeDrawer);
    drawerClose.addEventListener("click", closeDrawer);
    floatBtn.addEventListener("click", openDrawer);
    drawerSearch.addEventListener("input", renderDrawerList);

    // Buttons
    btnScrollDistricts.addEventListener("click", ()=>{
      document.getElementById("districtSection").scrollIntoView({behavior:"smooth", block:"start"});
    });
    btnOpenMap.addEventListener("click", ()=>{
      document.querySelector(".mapFrameWrap").scrollIntoView({behavior:"smooth", block:"start"});
    });

    // show floating districts button on scroll
    window.addEventListener("scroll", ()=>{
      const y = window.scrollY || 0;
      floatBtn.style.display = (y > 520) ? "block" : "none";
    });

    // Tabs
    tabs.addEventListener("click", (e)=>{
      const t = e.target.closest(".tab")?.getAttribute("data-t");
      if(!t) return;
      setActiveType(t);
    });

    // init
    async function init(){
      setHero("");
      const snap = await get(ref(db, ROOT));
      ROOT_CACHE = snap.exists() ? safeObj(snap.val()) : {};
      DISTRICTS = Object.keys(ROOT_CACHE).sort((a,b)=>a.localeCompare(b));

      // precompute previews + total places
      TOTAL_PLACES = 0;
      for(const d of DISTRICTS){
        const node = ROOT_CACHE[d];
        const pv = computePreview(node);
        ROOT_CACHE[d].__preview = pv;

        // count places quickly (all segment buckets)
        const seg = safeObj(node?.segments);
        for(const k of Object.keys(seg)){
          const b = safeObj(seg[k]);
          TOTAL_PLACES += Object.keys(b).length;
        }
      }

      statDistricts.textContent = `${DISTRICTS.length} districts`;
      statPlaces.textContent = `${TOTAL_PLACES} places`;

      renderDistrictTiles();

      // open district from URL
      const m = (location.hash||"").match(/district=([^&]+)/i);
      if(m){
        const d = decodeURIComponent(m[1]);
        if(DISTRICTS.includes(d)) openDistrict(d);
      }
    }

    init().catch(()=>{
      districtGrid.innerHTML = `<div class="empty">Firebase not configured / rules blocked.</div>`;
    });
  </script>
</body>
</html>