<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Live Package Generator (Start → End from Column G)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#f2f6ff;
      --stroke: rgba(12,18,40,.12);
      --muted: rgba(12,18,40,.66);
      --text: #0b1220;
      --card: rgba(255,255,255,.80);
      --shadow: 0 18px 55px rgba(12,18,40,.12);
      --radius: 18px;
      --accent: #2563eb;
      --ok:#10b981;
      --warn:#f59e0b;

      --mapW: 34%;
      --gap: 14px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text); overflow-x:hidden; background:var(--bg0); }

    /* Background FX (unchanged) */
    .bg{
      position:fixed; inset:0; z-index:-5;
      background:
        radial-gradient(1200px 560px at 18% 12%, rgba(37,99,235,.24), transparent 60%),
        radial-gradient(1100px 580px at 82% 18%, rgba(16,185,129,.22), transparent 60%),
        radial-gradient(900px 520px at 50% 86%, rgba(167,139,250,.18), transparent 65%),
        linear-gradient(180deg, #eef4ff, #ffffff);
    }
    .noise{
      position:fixed; inset:0; z-index:-4; pointer-events:none; opacity:.10; mix-blend-mode:overlay;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }
    .blob{ position:fixed; width:460px; height:460px; border-radius:50%; filter: blur(60px); opacity:.22; z-index:-3; pointer-events:none; animation: float 10s ease-in-out infinite; }
    .b1{ left:-140px; top:60px;  background: rgba(37,99,235,.95); }
    .b2{ right:-180px; top:140px; background: rgba(16,185,129,.92); animation-duration: 12s; }
    .b3{ left:36%; bottom:-240px; background: rgba(167,139,250,.92); animation-duration: 14s; }
    @keyframes float{ 0%,100%{ transform: translate(0,0) scale(1); } 50%{ transform: translate(28px,-20px) scale(1.08); } }
    #fx{ position:fixed; inset:0; z-index:-2; pointer-events:none; opacity:.90; }

    .wrap{ max-width: 1480px; margin: 0 auto; padding: 16px; }
    .card{ background: var(--card); border: 1px solid var(--stroke); box-shadow: var(--shadow); border-radius: var(--radius); overflow:hidden; backdrop-filter: blur(14px); }

    .hero{
      padding: 18px 16px; border-bottom: 1px solid var(--stroke);
      background:
        linear-gradient(135deg, rgba(37,99,235,.10), rgba(16,185,129,.08)),
        radial-gradient(900px 350px at 20% -20%, rgba(37,99,235,.20), transparent 60%),
        radial-gradient(700px 300px at 95% 0%, rgba(16,185,129,.18), transparent 60%);
    }
    .hero-top{ display:flex; align-items:center; gap:16px; margin-bottom:14px; }
    .site-logo{ height:68px; width:auto; background:white; padding:8px; border-radius:18px; box-shadow:0 12px 35px rgba(0,0,0,.16); }
    .hero-text h1{ margin:0; font-size: 22px; text-transform: uppercase; }
    .hero-text p{ margin:6px 0 0; color:var(--muted); font-size: 13px; max-width: 1100px; }

    .title{ font-size: 16px; font-weight: 950; letter-spacing: .2px; text-transform: uppercase; }
    .sub{ color: var(--muted); font-size: 12.5px; line-height:1.35; text-transform: uppercase; }

    .topbar{
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke);
      background: rgba(255,255,255,.55);
    }

    /* Controls Row (compact + single line on desktop) */
    .controls{
      display:grid;
      grid-template-columns: 2.2fr 1fr 1fr .8fr 1.2fr;
      gap:10px;
      align-items:end;
      margin-top: 10px;
    }
    .field label{ display:block; font-size:11px; color:var(--muted); margin:0 0 6px 2px; text-transform: uppercase; }
    select, input{
      width:100%; padding: 10px 10px; border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      outline:none; color: var(--text);
      text-transform: uppercase;
    }
    select:focus, input:focus{ border-color: rgba(37,99,235,.38); box-shadow: 0 0 0 3px rgba(37,99,235,.12); }

    .btn{
      appearance:none; border:0; border-radius: 12px; padding: 10px 12px;
      cursor:pointer; font-weight:950; background: var(--accent); color:white;
      box-shadow: 0 12px 30px rgba(37,99,235,.20);
      transition: transform .12s ease, filter .12s ease; width:100%;
      text-transform: uppercase;
    }
    .btn.secondary{ background: rgba(255,255,255,.92); color: var(--text); border: 1px solid var(--stroke); box-shadow:none; }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      font-size: 12px; color: var(--muted);
      margin: 6px 6px 0 0; white-space: nowrap;
      text-transform: uppercase;
      font-weight: 850;
    }
    .pill b{ color: var(--text); }

    /* ✅ NEW MAIN LAYOUT: results left, map right (sticky) */
    .main{
      display:grid;
      grid-template-columns: calc(100% - var(--mapW) - var(--gap)) var(--mapW);
      gap: var(--gap);
      padding: 14px;
      align-items:start;
    }

    .results{
      min-height: 60vh;
    }

    .mapPanel{
      position: sticky;
      top: 14px;
      align-self: start;
    }

    .panel{
      background: rgba(255,255,255,.72);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 12px;
    }

    .panel + .panel{ margin-top: 12px; }

    /* Packages grid */
    .pkgGrid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 10px; margin-top: 12px; }
    @media (max-width: 1250px){ .pkgGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 980px){ .pkgGrid{ grid-template-columns: 1fr; } }

    .pkg{
      border: 1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,.92);
      padding: 12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .pkg:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.28); }
    .pkg.active{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.10); }

    .pkgPic{
      width:74px; height:74px; border-radius:16px; overflow:hidden; flex:0 0 auto;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(16,185,129,.14));
      display:grid; place-items:center;
      font-weight:950; color: rgba(12,18,40,.55);
    }
    .pkgPic img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pkgBody{ min-width:0; flex:1; }
    .pkgTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .pkgName{ font-weight: 950; font-size: 13.5px; line-height:1.25; text-transform: uppercase; }
    .badge{
      font-size: 11px; padding: 5px 8px; border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(16,185,129,.10);
      color: rgba(16,185,129,1);
      white-space: nowrap; text-transform: uppercase; font-weight: 900;
    }
    .badge.warn{ background: rgba(245,158,11,.12); color: rgba(245,158,11,1); }
    .pkgMeta{ margin-top: 8px; font-size: 12px; color: var(--muted); line-height: 1.35; text-transform: uppercase; }
    .pkgMeta b{ color: var(--text); }

    /* Places list */
    .placesHdr{ display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
    .count{ font-size:12px; color: var(--muted); text-transform: uppercase; }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    .placeBtns{ display:flex; gap:8px; flex-wrap:wrap; max-height: 320px; overflow:auto; padding: 2px; }
    .place-btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 240px;
      transition: transform .12s ease, border-color .12s ease;
      text-transform: uppercase;
    }
    .place-btn:hover{ transform: translateY(-1px); border-color: rgba(37,99,235,.28); }
    .place-btn.active{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.10); }

    .thumb{
      width:46px; height:46px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      overflow:hidden;
      flex: 0 0 auto;
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(16,185,129,.14));
      display:grid; place-items:center;
      font-weight:950;
      color: rgba(12,18,40,.55);
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .pinfo{ display:flex; flex-direction:column; gap:2px; min-width: 0; }
    .pname{ font-weight:950; font-size: 12.8px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .pmeta{ font-size:11px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .ord{ width:22px; height:22px; display:inline-grid; place-items:center; border-radius: 50%; font-weight: 950;
      background: rgba(37,99,235,.10); color: rgba(37,99,235,1); margin-left:auto; }

    /* Detail + pricing as 2 cards */
    .twoCards{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:10px; }
    @media (max-width: 980px){ .twoCards{ grid-template-columns: 1fr; } }

    .detail{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,.88);
      padding: 12px;
      min-height: 120px;
    }
    .detail h3{ margin:0 0 4px; font-size: 15.5px; text-transform: uppercase; }
    .detail .meta{ font-size:12px; color:var(--muted); margin-bottom: 8px; text-transform: uppercase; }
    .detail .desc{ font-size:13px; color:var(--text); line-height: 1.35; text-transform:none; }

    .costBox{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      background: rgba(255,255,255,.88);
      padding: 12px;
    }
    .costRow{ display:flex; justify-content:space-between; gap:10px; padding:6px 0; font-size:13px; text-transform: uppercase; }
    .costRow span{ color: var(--muted); }
    .costRow b{ color: var(--text); }
    .costTotal{
      margin-top:8px;
      border-top:1px solid var(--stroke);
      padding-top:10px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      text-transform: uppercase;
    }
    .costTotal .big{ font-size:18px; font-weight:950; }
    .saveTag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
      color: rgba(16,185,129,1);
      font-size: 12px;
      font-weight: 950;
      white-space: nowrap;
      text-transform: uppercase;
    }

    /* Map */
    #map{
      width:100%;
      height: calc(100vh - 210px);
      min-height: 540px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      overflow:hidden;
      background: rgba(255,255,255,.40);
    }
    .mapHdr{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom: 10px;
      flex-wrap:wrap;
    }

    /* Responsive */
    @media (max-width: 1100px){
      :root{ --mapW: 40%; }
    }
    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr 1fr; }
      .main{ grid-template-columns: 1fr; }
      .mapPanel{ position: relative; top:auto; }
      #map{ height: 420px; min-height: 420px; }
    }

    .toast{
      position: fixed; left: 16px; bottom: 16px;
      background: rgba(255,255,255,.94);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      color: var(--muted);
      font-size: 12.5px;
      display:none;
      max-width: 560px;
      z-index: 9999;
      text-transform: uppercase;
      font-weight: 900;
    }
    .toast.show{ display:block; }

/* =========================
   ✅ OPTION A LAYOUT (NEW)
   Results Left (scroll) + Sticky Map Right
   ========================= */

:root{
  --gap: 14px;
  --mapW: 34%;
}

/* main shell inside card */
.shell{
  padding: 14px;
}

/* main two-column layout */
.mainA{
  display:grid;
  grid-template-columns: calc(100% - var(--mapW) - var(--gap)) var(--mapW);
  gap: var(--gap);
  align-items:start;
}

/* left results side */
.leftA{
  min-height: 60vh;
}

/* right sticky map side */
.rightA{
  position: sticky;
  top: 14px;
  align-self: start;
}

/* simple inner panels */
.panelA{
  background: rgba(255,255,255,.72);
  border: 1px solid var(--stroke);
  border-radius: 16px;
  padding: 12px;
}

/* spacing between panels */
.panelA + .panelA{ margin-top: 12px; }

/* map sizing (better) */
#map{
  width:100%;
  height: calc(100vh - 230px);
  min-height: 540px;
  border-radius: 14px;
  border: 1px solid var(--stroke);
  overflow:hidden;
  background: rgba(255,255,255,.40);
}

/* header row inside map */
.mapHdrA{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:10px;
  margin-bottom: 10px;
  flex-wrap:wrap;
}

/* controls row becomes compact */
.controls{
  display:grid;
  grid-template-columns: 2.2fr 1fr 1fr .8fr 1.2fr;
  gap:10px;
  align-items:end;
}

/* responsive */
@media (max-width: 1100px){
  :root{ --mapW: 40%; }
}
@media (max-width: 980px){
  .controls{ grid-template-columns: 1fr 1fr; }
  .mainA{ grid-template-columns: 1fr; }
  .rightA{ position: relative; top:auto; }
  #map{ height: 420px; min-height: 420px; }
}

  </style>
</head>

<body>
  <div class="bg"></div>
  <canvas id="fx"></canvas>
  <div class="noise"></div>
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>

  <div class="wrap">
    <div class="card">

      <!-- HERO -->
      <div class="hero">
        <div class="hero-top">
          <img src="logo.png" class="site-logo" alt="Himachal Explorer Logo">
          <div class="hero-text">
            <h1>Live Package Generator</h1>
            <p>
              Type <b>START</b> (must exist in your Templates DB). Optional <b>DAYS</b> and <b>PAX</b>.
              Result: <b>ONE BEST PACKAGE PER END</b> (best = maximum locations).<br/>
              ✅ Package name uses <b>START</b> and <b>END derived from Column G (route_path)</b>.
              If last point repeats START, system uses <b>second-last point</b> as END.
            </p>
            <div class="sub" id="dataStatus" style="margin-top:10px;">LOADING TEMPLATES…</div>
          </div>
        </div>
      </div>

      <!-- CONTROLS BAR -->
      <div class="topbar">
        <div class="controls">
          <div class="field">
            <label>START (TYPE OR PICK)</label>
            <input id="startInp" list="startList" placeholder="E.G. AMRITSAR / DELHI / CHANDIGARH"/>
            <datalist id="startList"></datalist>
          </div>

          <div class="field">
            <label>DAYS (OPTIONAL)</label>
            <select id="daysSel">
              <option value="">ANY</option>
              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              <option value="7">7</option><option value="8">8</option><option value="9">9</option>
              <option value="10">10</option><option value="11">11</option><option value="12">12</option>
            </select>
          </div>

          <div class="field">
            <label>PEOPLE (PAX)</label>
            <select id="paxSel">
              <option value="2">2</option><option value="3">3</option><option value="4">4</option>
              <option value="5">5</option><option value="6">6</option><option value="7">7</option>
              <option value="8">8</option><option value="9">9</option><option value="10">10</option>
              <option value="11">11</option><option value="12">12</option>
            </select>
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button class="btn secondary" id="resetBtn">RESET</button>
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button class="btn" id="runBtn">GENERATE</button>
          </div>
        </div>
      </div>

      <!-- MAIN: RESULTS + MAP -->
      <div class="main">

        <!-- LEFT: RESULTS -->
        <div class="results">

          <div class="panel">
            <div class="title">Packages</div>
            <div class="sub">ONE END (FROM COLUMN G) = ONE BEST PACKAGE (MAX LOCATIONS).</div>
            <div id="summaryPills"></div>

            <div class="pkgGrid" id="pkgGrid" style="margin-top:12px;">
              <div class="sub">TYPE START AND CLICK GENERATE…</div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px;">
            <div class="placesHdr">
              <div style="display:flex;gap:8px;align-items:baseline;flex-wrap:wrap;">
                <div class="title">Package Places</div>
                <div class="count" id="placesCount">—</div>
              </div>
              <div class="btnRow">
                <button class="btn secondary" id="fitBtn" style="width:auto;">FIT MAP</button>
                <button class="btn secondary" id="clearBtn" style="width:auto;">CLEAR ROUTE</button>
              </div>
            </div>

            <div class="placeBtns" id="placesButtons">
              <span class="sub">CLICK A PACKAGE TO SHOW PLACES…</span>
            </div>

            <div class="twoCards">
              <div class="detail" id="placeDetail">
                <h3>PLACE DETAILS</h3>
                <div class="meta">CLICK ANY PLACE TO SEE DETAILS.</div>
                <div class="desc" id="placeDesc">—</div>
              </div>

              <div class="costBox">
                <div class="title">PRICING</div>
                <div class="sub">OSRM ROAD KM + 6–10% DISCOUNT. PER PERSON PRICE.</div>
                <div id="costRows"></div>
              </div>
            </div>
          </div>

        </div>

        <!-- RIGHT: MAP -->
        <div class="mapPanel">
          <div class="panel">
            <div class="mapHdr">
              <div>
                <div class="title">Map</div>
                <div class="sub">ACTUAL ROAD ROUTE LINE</div>
              </div>
              <div class="sub" style="text-transform:none;">
                ✅ End derived from <b>Column G</b> • ✅ Route line = OSRM
              </div>
            </div>
            <div id="map"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/***********************
 * ✅ LIVE PARTICLES (VISIBLE)
 ***********************/
(function(){
  const c = document.getElementById('fx');
  const ctx = c.getContext('2d');
  let W, H, particles = [];
  function resize(){
    W = c.width = window.innerWidth;
    H = c.height = window.innerHeight;
    particles = Array.from({length: 90}, () => ({
      x: Math.random()*W,
      y: Math.random()*H,
      r: Math.random()*1.8 + 0.6,
      vx: (Math.random()*0.7 + 0.2) * (Math.random()<0.5?-1:1),
      vy: (Math.random()*0.7 + 0.2) * (Math.random()<0.5?-1:1),
      a: Math.random()*0.28 + 0.14
    }));
  }
  window.addEventListener('resize', resize);
  resize();
  function draw(){
    ctx.clearRect(0,0,W,H);
    for(const p of particles){
      p.x += p.vx; p.y += p.vy;
      if(p.x < -20) p.x = W+20;
      if(p.x > W+20) p.x = -20;
      if(p.y < -20) p.y = H+20;
      if(p.y > H+20) p.y = -20;
      ctx.beginPath();
      ctx.globalAlpha = p.a;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle = "#0b255a";
      ctx.fill();
    }
    for(let i=0;i<particles.length;i++){
      for(let j=i+1;j<particles.length;j++){
        const a = particles[i], b = particles[j];
        const dx = a.x-b.x, dy = a.y-b.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist < 165){
          ctx.globalAlpha = (1 - dist/165) * 0.16;
          ctx.strokeStyle = "#2563eb";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(a.x,a.y);
          ctx.lineTo(b.x,b.y);
          ctx.stroke();
        }
      }
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(draw);
  }
  draw();
})();

/***********************
 * ✅ FIREBASE CONFIG (yours)
 ***********************/
const firebaseConfig = {
  apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
  authDomain: "revnue-records.firebaseapp.com",
  databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "revnue-records",
  storageBucket: "revnue-records.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:0000000000000000000000",
  measurementId: "G-0000000000"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/***********************
 * ✅ MAP
 ***********************/
const map = L.map('map', { zoomControl: true }).setView([31.1048, 77.1734], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
let markersLayer = L.layerGroup().addTo(map);
let routeLine = null;

function clearMap(){
  markersLayer.clearLayers();
  if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
}

/***********************
 * ✅ HELPERS
 ***********************/
const $ = (id)=>document.getElementById(id);
function setStatus(msg){ $("dataStatus").textContent = msg; }
function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function safeLower(x){ return String(x ?? "").trim().toLowerCase(); }
function pill(label, value){
  const div = document.createElement("div");
  div.className = "pill";
  div.innerHTML = `${escapeHtml(label)}: <b>${escapeHtml(value)}</b>`;
  return div;
}
function initials(name){
  const parts = String(name||"").trim().split(/\s+/).slice(0,2);
  const ini = parts.map(x=>x[0]).join("").toUpperCase();
  return ini || "HP";
}
function rupees(n){
  return "₹" + Math.round(Number(n)||0).toLocaleString("en-IN");
}
function slugifyName(name){
  return String(name||"")
    .trim()
    .toLowerCase()
    .replace(/&/g," and ")
    .replace(/['"]/g,"")
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/-+/g,"-")
    .replace(/^-|-$/g,"");
}

/***********************
 * ✅ DATA
 ***********************/
let LOCS = {};
let TEMPLATES = {};
let ACTIVE_TEMPLATES = [];
let NAME_TO_ID = new Map();
let STARTS = [];

/***********************
 * ✅ LOAD
 ***********************/
async function loadAll(){
  setStatus("LOADING /templates & /locations…");
  const [tplSnap, locSnap] = await Promise.all([
    db.ref("templates").once("value"),
    db.ref("locations").once("value"),
  ]);
  TEMPLATES = tplSnap.val() || {};
  LOCS = locSnap.val() || {};

  ACTIVE_TEMPLATES = Object.entries(TEMPLATES)
    .map(([key, obj]) => ({ key, ...(obj||{}) }))
    .filter(t => {
      const st = safeLower(t.status || "active");
      return st === "active" || st === "enabled" || st === "true";
    });

  buildNameIndex();
  buildStartList(ACTIVE_TEMPLATES);

  setStatus(`LOADED ${ACTIVE_TEMPLATES.length} TEMPLATES • ${Object.keys(LOCS).length} LOCATIONS`);
}
function buildNameIndex(){
  NAME_TO_ID = new Map();
  for(const [pid, p] of Object.entries(LOCS)){
    const nm = String(p["Location Name"] || p.name || "").trim();
    if(!nm) continue;
    NAME_TO_ID.set(nm.toLowerCase(), pid);
  }
}
function buildStartList(templates){
  const set = new Set();
  templates.forEach(t=>{
    const s = String(t.start_point || "").trim();
    if(s) set.add(s);
  });
  STARTS = Array.from(set).sort((a,b)=>a.localeCompare(b));
  const dl = $("startList");
  dl.innerHTML = "";
  STARTS.forEach(s=>{
    const opt = document.createElement("option");
    opt.value = String(s).toUpperCase();
    dl.appendChild(opt);
  });
}

/***********************
 * ✅ STOPS IN ROUTE ORDER (DAY-WISE)
 ***********************/
function stopsFromTemplate(tpl){
  const days = Number(tpl.days || 1);
  const out = [];
  const seen = new Set();

  for(let d=1; d<=Math.min(12, Math.max(1, days)); d++){
    const k = `day${d}_place_ids`;
    const raw = String(tpl[k] || "").trim();
    if(!raw) continue;
    raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>{
      if(seen.has(pid)) return;
      seen.add(pid);
      out.push(pid);
    });
  }

  if(!out.length){
    const raw = String(tpl.major_place_ids || "").trim();
    raw.split(",").map(x=>x.trim()).filter(Boolean).forEach(pid=>out.push(pid));
  }
  return out;
}
function stopsCount(tpl){ return stopsFromTemplate(tpl).length; }

/***********************
 * ✅ END LOCATION FROM COLUMN G (route_path)
 ***********************/
function getEndNameFromColumnG(tpl){
  const start = String(tpl.start_point || "").trim().toLowerCase();
  const rpRaw = String(tpl.route_path || "").trim();
  if(!rpRaw) return String(tpl.end_point || "").trim() || "UNKNOWN";

  const tokens = rpRaw
    .replace(/->/g,">")
    .split(">")
    .map(x=>String(x||"").trim())
    .filter(Boolean);

  if(!tokens.length) return String(tpl.end_point || "").trim() || "UNKNOWN";

  let end = tokens[tokens.length - 1];
  if(end && start && end.trim().toLowerCase() === start && tokens.length >= 2){
    end = tokens[tokens.length - 2];
  }
  return end || "UNKNOWN";
}
function normCaps(x){ return String(x||"").trim().toUpperCase().replace(/\s+/g," "); }
function endKeyFromColumnG(tpl){
  const endName = getEndNameFromColumnG(tpl);
  const pidByName = NAME_TO_ID.get(String(endName).toLowerCase());

  if(pidByName){
    const p = LOCS[pidByName] || {};
    const d = normCaps(p["District"] || p.district || "");
    return d || normCaps(endName);
  }

  const slug = slugifyName(endName);
  if(LOCS[slug]){
    const p = LOCS[slug] || {};
    const d = normCaps(p["District"] || p.district || "");
    return d || normCaps(endName);
  }

  return normCaps(endName);
}

/***********************
 * ✅ PLACE THUMB
 ***********************/
function getPlaceThumbUrl(p){
  p = p || {};
  const p1 = p["photo 1"] || p.photo1 || p.photo_1 || p.photo || "";
  if(p1 && String(p1).trim()) return String(p1).trim();
  if(Array.isArray(p.photos) && p.photos[0]) return String(p.photos[0]).trim();
  if(Array.isArray(p.images) && p.images[0]) return String(p.images[0]).trim();
  const p2 = p["photo 2"] || p.photo2 || "";
  if(p2 && String(p2).trim()) return String(p2).trim();
  return "";
}

/***********************
 * ✅ VEHICLE & PRICING
 ***********************/
function pickVehicleByPax(pax){
  if(pax <= 4) return "sedan";
  if(pax <= 6) return "suv";
  return "tempo";
}
function discountedCost(marketCost){
  const discount = 0.06 + Math.random()*0.04;
  const finalCost = Math.round(marketCost * (1 - discount));
  return { final: finalCost, discountPercent: Math.round(discount*100) };
}
function estimateMarketCost({ km=0, days=3, pax=2, vehicle="sedan" }){
  const ratePerKm = { sedan:16, suv:20, tempo:28 }[vehicle] || 16;
  const driverPerDay = (vehicle==="tempo") ? 1300 : 1000;

  const minKm = Math.max(60, km || 0);
  const transport = Math.round(minKm * ratePerKm);
  const driver = Math.round(days * driverPerDay);

  const rooms = Math.ceil(pax / 2);
  const stayPerRoomNight = 1800;
  const stay = Math.round(rooms * stayPerRoomNight * Math.max(1, (days - 1)));

  const service = Math.round((transport + driver + stay) * 0.08);
  const marketTotal = transport + driver + stay + service;

  return { transport, driver, stay, service, marketTotal };
}
function renderCostBox({status="idle", km=0, days=3, pax=2}){
  const box = $("costRows");
  if(status === "idle"){
    box.innerHTML = `<div class="sub" style="margin-top:8px;">SELECT A PACKAGE TO CALCULATE COST.</div>`;
    return;
  }
  if(status === "error"){
    box.innerHTML = `<div class="sub" style="margin-top:8px;">COST NOT AVAILABLE (ROAD KM NOT READY).</div>`;
    return;
  }

  const vehicle = pickVehicleByPax(pax);
  const mk = estimateMarketCost({ km, days, pax, vehicle });
  const disc = discountedCost(mk.marketTotal);
  const perPerson = Math.ceil(disc.final / Math.max(1, pax));

  box.innerHTML = `
    <div class="costRow"><span>ROAD KM</span><b>${km.toFixed(1)} KM</b></div>
    <div class="costRow"><span>DAYS</span><b>${days}</b></div>
    <div class="costRow"><span>PEOPLE</span><b>${pax}</b></div>
    <div class="costRow"><span>VEHICLE</span><b>${vehicle.toUpperCase()}</b></div>

    <div class="costRow"><span>TRANSPORT (MARKET)</span><b>${rupees(mk.transport)}</b></div>
    <div class="costRow"><span>DRIVER</span><b>${rupees(mk.driver)}</b></div>
    <div class="costRow"><span>STAY</span><b>${rupees(mk.stay)}</b></div>
    <div class="costRow"><span>SERVICE / MARGIN</span><b>${rupees(mk.service)}</b></div>

    <div class="costTotal">
      <div>
        <div class="sub">OUR TOTAL PRICE</div>
        <div class="big">${rupees(disc.final)}</div>
        <div class="sub" style="margin-top:6px;">PER PERSON</div>
        <div class="big">${rupees(perPerson)}</div>
      </div>
      <div class="saveTag">CHEAPER BY ${disc.discountPercent}%</div>
    </div>
  `;
}

/***********************
 * ✅ ROAD ROUTE (OSRM)
 ***********************/
async function drawRoadRouteFromPlaces(placeIds){
  markersLayer.clearLayers();
  if(routeLine){ map.removeLayer(routeLine); routeLine = null; }

  const coords = [];
  const valid = [];
  placeIds.forEach(pid=>{
    const p = LOCS[pid] || {};
    const lat = Number(p.Latitude ?? p.lat);
    const lng = Number(p.Longitude ?? p.lng);
    if(isFinite(lat) && isFinite(lng)){
      coords.push([lng,lat]);
      valid.push(pid);
    }
  });
  if(coords.length < 2){
    toast("NOT ENOUGH COORDINATES FOR ROAD ROUTE");
    return { ok:false, km:0 };
  }

  try{
    const maxPts = 25;
    let used = coords;
    if(coords.length > maxPts){
      const step = Math.ceil(coords.length / maxPts);
      used = coords.filter((_,i)=> i % step === 0 || i === coords.length-1);
    }
    const url =
      "https://router.project-osrm.org/route/v1/driving/" +
      used.map(c=>c.join(",")).join(";") +
      "?overview=full&geometries=geojson&steps=false";

    const res = await fetch(url);
    const data = await res.json();
    if(!data.routes?.length){
      toast("ROAD ROUTE NOT AVAILABLE");
      return { ok:false, km:0 };
    }

    const route = data.routes[0];
    const latlngs = route.geometry.coordinates.map(c=>[c[1],c[0]]);
    routeLine = L.polyline(latlngs, { weight: 5, opacity: .95 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[20,20] });

    coords.forEach((c,i)=>{
      const pid = valid[i] || placeIds[i];
      const p = LOCS[pid] || {};
      const nm = (p["Location Name"] || pid).toUpperCase();
      L.marker([c[1], c[0]]).addTo(markersLayer).bindPopup(`<b>${i+1}. ${escapeHtml(nm)}</b>`);
    });

    return { ok:true, km: Number(route.distance/1000) };
  }catch(e){
    console.error(e);
    toast("ROAD ROUTE ERROR");
    return { ok:false, km:0 };
  }
}
function fitMap(){
  if(routeLine){ map.fitBounds(routeLine.getBounds(), { padding:[18,18] }); }
}

/***********************
 * ✅ PLACES UI
 ***********************/
function renderPlaceButtons(placeIds){
  const box = $("placesButtons");
  box.innerHTML = "";
  if(!placeIds.length){
    box.innerHTML = `<span class="sub">NO PLACES FOUND IN THIS PACKAGE.</span>`;
    $("placesCount").textContent = "0 PLACES";
    return;
  }
  $("placesCount").textContent = `${placeIds.length} PLACES`;

  placeIds.forEach((pid, idx)=>{
    const p = LOCS[pid] || {};
    const name = (p["Location Name"] || pid).toUpperCase();
    const seg  = String(p["Segment Type"] || p.segment || "—").toUpperCase();
    const url = getPlaceThumbUrl(p);

    const btn = document.createElement("button");
    btn.className = "place-btn";
    btn.innerHTML = `
      <div class="thumb">
        ${url ? `<img src="${escapeHtml(url)}" alt="${escapeHtml(name)}" loading="lazy"
                 referrerpolicy="no-referrer"
                 onerror="this.remove(); this.parentNode.textContent='${escapeHtml(initials(name))}';">`
              : `${escapeHtml(initials(name))}`}
      </div>
      <div class="pinfo">
        <div class="pname">${escapeHtml(name)}</div>
        <div class="pmeta">${escapeHtml(seg)}</div>
      </div>
      <span class="ord">${idx+1}</span>
    `;
    btn.onclick = ()=>selectPlace(pid, idx+1);
    box.appendChild(btn);
  });
}
function selectPlace(placeId, order){
  const btns = $("placesButtons").querySelectorAll(".place-btn");
  btns.forEach(b=>b.classList.remove("active"));
  const target = btns[order-1];
  if(target) target.classList.add("active");

  const p = LOCS[placeId] || {};
  const name = (p["Location Name"] || placeId).toUpperCase();
  const seg  = String(p["Segment Type"] || p.segment || "—").toUpperCase();
  const typ  = String(p["Location Type"] || p.type || "—").toUpperCase();
  const short= String(p["Short Description"] || "");
  const ov   = String(p["Overview"] || "");
  const how  = String(p["How to Reach"] || "");

  $("placeDetail").querySelector("h3").textContent = name;
  $("placeDetail").querySelector(".meta").textContent = `${seg} • ${typ}`;
  $("placeDesc").innerHTML =
    `<div class="sub" style="margin-bottom:6px;"><b>HOW TO REACH:</b> ${escapeHtml(how||"—").toUpperCase()}</div>` +
    `<div class="desc">${escapeHtml((short || ov || "—"))}</div>`;

  const lat = Number(p.Latitude ?? p.lat);
  const lng = Number(p.Longitude ?? p.lng);
  if(isFinite(lat) && isFinite(lng)){
    map.setView([lat,lng], Math.max(map.getZoom(), 12));
  }
}

/***********************
 * ✅ ONE END KEY = ONE BEST PACKAGE
 ***********************/
function packageScore(tpl){
  const locs = stopsCount(tpl);
  const pri  = Number(tpl.priority ?? 999);
  const km   = Number(tpl.total_km_est ?? tpl.estimated_drive_km ?? 1e9);
  return { locs, pri, km };
}
function isBetter(a,b){
  if(a.locs !== b.locs) return a.locs > b.locs;
  if(a.pri !== b.pri)   return a.pri < b.pri;
  return a.km < b.km;
}

/***********************
 * ✅ START INPUT NORMALIZATION
 ***********************/
function normalizeStartInput(){
  const typed = String($("startInp").value || "").trim().toUpperCase();
  if(!typed) return "";

  const exact = STARTS.find(s => String(s).trim().toUpperCase() === typed);
  if(exact) return exact;

  const partial = STARTS.find(s => String(s).trim().toUpperCase().startsWith(typed));
  if(partial) return partial;

  return "";
}

/***********************
 * ✅ PACKAGE THUMB
 ***********************/
function getPackageThumbFromTemplate(tpl){
  const stops = stopsFromTemplate(tpl);
  const first = stops[0];
  if(!first) return { url:"", ini:"HP" };
  const p = LOCS[first] || {};
  const nm = (p["Location Name"] || first).toUpperCase();
  const url = getPlaceThumbUrl(p);
  return { url, ini: initials(nm) };
}

/***********************
 * ✅ APPLY FILTERS + GENERATE
 ***********************/
function applyFilters(){
  const start = normalizeStartInput();
  const daysF = $("daysSel").value.trim();
  const pax   = Number($("paxSel").value || 2);

  $("summaryPills").innerHTML = "";
  $("pkgGrid").innerHTML = `<div class="sub">TYPE START AND CLICK GENERATE…</div>`;
  $("placesButtons").innerHTML = `<span class="sub">CLICK A PACKAGE TO SHOW PLACES…</span>`;
  $("placesCount").textContent = "—";
  renderCostBox({status:"idle"});
  clearMap();

  if(!start){
    toast("START NOT FOUND IN DATABASE");
    return;
  }

  let list = ACTIVE_TEMPLATES.filter(t => String(t.start_point||"").trim().toUpperCase() === String(start).trim().toUpperCase());
  if(daysF) list = list.filter(t => Number(t.days||0) === Number(daysF));

  const bestByEnd = new Map();
  const scByEnd = new Map();

  for(const t of list){
    const endKey = endKeyFromColumnG(t);
    const sc = packageScore(t);

    if(!bestByEnd.has(endKey)){
      bestByEnd.set(endKey, t);
      scByEnd.set(endKey, sc);
    }else{
      const prev = scByEnd.get(endKey);
      if(isBetter(sc, prev)){
        bestByEnd.set(endKey, t);
        scByEnd.set(endKey, sc);
      }
    }
  }

  const finalList = Array.from(bestByEnd.values()).sort((a,b)=>{
    const A = packageScore(a), B = packageScore(b);
    if(A.locs !== B.locs) return B.locs - A.locs;
    if(A.pri !== B.pri) return A.pri - B.pri;
    return A.km - B.km;
  });

  $("summaryPills").appendChild(pill("START", String(start).toUpperCase()));
  $("summaryPills").appendChild(pill("PACKAGES", String(finalList.length)));
  $("summaryPills").appendChild(pill("PAX", String(pax)));
  if(daysF) $("summaryPills").appendChild(pill("DAYS", String(daysF)));

  renderPackagesGrid(finalList, start);
}

function renderPackagesGrid(list, start){
  const grid = $("pkgGrid");
  grid.innerHTML = "";

  if(!list.length){
    grid.innerHTML = `<div class="sub">NO PACKAGES FOUND FOR THIS START (WITH CURRENT FILTERS).</div>`;
    return;
  }

  list.forEach(t=>{
    const key = t.key;
    const endKey = endKeyFromColumnG(t);
    const days = Number(t.days || 0) || 0;
    const tempoOk = (t.tempo_ok === true || safeLower(t.tempo_ok)==="true");
    const thumb = getPackageThumbFromTemplate(t);

    const card = document.createElement("div");
    card.className = "pkg";
    card.dataset.key = key;

    card.innerHTML = `
      <div class="pkgPic">
        ${thumb.url
          ? `<img src="${escapeHtml(thumb.url)}" alt="PACKAGE" loading="lazy"
                 referrerpolicy="no-referrer"
                 onerror="this.remove(); this.parentNode.textContent='${escapeHtml(thumb.ini)}';">`
          : `${escapeHtml(thumb.ini)}`
        }
      </div>

      <div class="pkgBody">
        <div class="pkgTop">
          <div class="pkgName">${escapeHtml(String(start).toUpperCase())} → ${escapeHtml(String(endKey).toUpperCase())}</div>
          <div class="badge ${tempoOk ? "" : "warn"}">${tempoOk ? "TEMPO OK" : "TEMPO RISK"}</div>
        </div>

        <div class="pkgMeta">
          <b>END (FROM G):</b> ${escapeHtml(String(endKey).toUpperCase())}<br/>
          <b>LOCATIONS:</b> ${stopsCount(t)} &nbsp;•&nbsp; <b>DAYS:</b> ${days || "—"}<br/>
          <b>ROUTE ID:</b> ${escapeHtml(String(t.route_id||"—").toUpperCase())}
        </div>
      </div>
    `;

    card.onclick = async ()=>{
      document.querySelectorAll(".pkg").forEach(x=>x.classList.remove("active"));
      card.classList.add("active");
      await openTemplate(key);
    };
    grid.appendChild(card);
  });
}

/***********************
 * ✅ OPEN PACKAGE
 ***********************/
async function openTemplate(key){
  const tpl = TEMPLATES[key];
  if(!tpl){ toast("PACKAGE NOT FOUND"); return; }

  const stops = stopsFromTemplate(tpl);
  renderPlaceButtons(stops);
  if(stops.length) selectPlace(stops[0], 1);

  renderCostBox({status:"idle"});
  const rr = await drawRoadRouteFromPlaces(stops);

  const days = Number(tpl.days || $("daysSel").value || 3);
  const pax = Number($("paxSel").value || 2);

  if(rr.ok){
    renderCostBox({status:"ok", km: rr.km, days, pax});
    toast("ROAD ROUTE LOADED");
  }else{
    renderCostBox({status:"error"});
  }
}

/***********************
 * ✅ EVENTS
 ***********************/
$("runBtn").addEventListener("click", applyFilters);
$("startInp").addEventListener("keydown",(e)=>{ if(e.key==="Enter") applyFilters(); });

$("resetBtn").addEventListener("click", ()=>{
  $("startInp").value = "";
  $("daysSel").value = "";
  $("paxSel").value = "2";

  $("summaryPills").innerHTML = "";
  $("pkgGrid").innerHTML = `<div class="sub">TYPE START AND CLICK GENERATE…</div>`;
  $("placesButtons").innerHTML = `<span class="sub">CLICK A PACKAGE TO SHOW PLACES…</span>`;
  $("placesCount").textContent = "—";
  renderCostBox({status:"idle"});

  $("placeDetail").querySelector("h3").textContent = "PLACE DETAILS";
  $("placeDetail").querySelector(".meta").textContent = "CLICK ANY PLACE TO SEE DETAILS.";
  $("placeDesc").textContent = "—";

  clearMap();
  toast("RESET DONE");
});

$("fitBtn").addEventListener("click", fitMap);
$("clearBtn").addEventListener("click", ()=>{
  clearMap();
  toast("ROUTE CLEARED");
});

/***********************
 * ✅ INIT
 ***********************/
renderCostBox({status:"idle"});
loadAll().catch(err=>{
  console.error(err);
  setStatus("ERROR LOADING FIREBASE DATA");
  toast("FIREBASE LOAD ERROR (CHECK RULES / NODE NAMES)");
});
</script>
</body>
</html>