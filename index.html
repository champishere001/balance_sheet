<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Himachal Explorer — Packages (Major Cities Only)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg0:#0a1020;
      --bg1:#0d1730;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.56);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r: 18px;
      --r2: 26px;

      --accent:#86b6ff;
      --accent2:#a5ffcf;
      --warn:#ffcc66;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(134,182,255,.22), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(165,255,207,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* Header */
    .topbar{
      position:sticky; top:0; z-index:50;
      padding: calc(12px + var(--safe-top)) 14px 10px;
      background: linear-gradient(180deg, rgba(10,16,32,.92), rgba(10,16,32,.55));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--stroke);
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
      font-weight: 750;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 18px rgba(134,182,255,.5);
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      max-width: 62vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip b{color: var(--text); font-weight:700}
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
      align-items:center;
    }

    /* Layout */
    .shell{
      height: calc(100% - 0px);
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      padding: 12px;
      padding-bottom: calc(12px + var(--safe-bottom));
    }

    .panel{
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .panelHead{
      padding: 12px;
      border-bottom:1px solid var(--stroke);
      background: rgba(0,0,0,.12);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .panelHead .title{
      font-size: 13px;
      font-weight: 750;
      letter-spacing:.2px;
    }
    .panelHead .sub{
      color: var(--muted);
      font-size: 12px;
      margin-top:2px;
    }
    .panelBody{
      padding: 12px;
      overflow:auto;
      min-height: 0;
    }

    /* Inputs */
    .lbl{display:block; font-size:12px; color: var(--muted); margin: 0 0 6px}
    .inp, select{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 11px 12px;
      outline:none;
      font-size: 14px;
    }
    .inp::placeholder{color: rgba(255,255,255,.45)}
    select option{color:#0b1220}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(134,182,255,.24), rgba(165,255,207,.18));
      border-color: rgba(134,182,255,.42);
    }
    .btn.danger{
      border-color: rgba(255,107,107,.45);
      background: rgba(255,107,107,.08);
      color: #ffd7d7;
    }
    .muted{color: var(--muted); font-size: 12px}
    .muted2{color: var(--muted2); font-size: 12px}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    .sep{height:1px; background: var(--stroke); margin: 12px 0}

    /* Tiles */
    .tiles{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .tile{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      overflow:hidden;
      cursor:pointer;
    }
    .tileTop{
      display:flex; gap:10px;
      padding: 10px;
      align-items:center;
    }
    .thumb{
      width:64px; height:64px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      flex:0 0 auto;
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .tileInfo{min-width:0}
    .tileInfo .name{
      font-weight: 800;
      font-size: 14px;
      line-height: 1.15;
      margin:0 0 6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .badges{display:flex; flex-wrap:wrap; gap:6px}
    .badge{
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .badge.good{border-color: rgba(165,255,207,.4); color: #d7ffee}
    .badge.blue{border-color: rgba(134,182,255,.45); color: #d9e7ff}
    .tileBot{
      padding: 0 10px 10px;
      color: var(--muted);
      font-size: 12px;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    /* Map */
    #map{ width:100%; height:100%; border-radius: var(--r2); }
    .mapWrap{position:relative; height:100%; min-height:0}
    .mapOverlay{
      position:absolute;
      left:12px; top:12px;
      display:flex; flex-direction:column; gap:8px;
      z-index: 400;
      max-width: min(440px, 64vw);
    }
    .overlayCard{
      border:1px solid var(--stroke);
      background: rgba(10,16,32,.55);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
    }
    .overlayRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .tiny{
      font-size:11px;
      padding: 6px 8px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .miniBtn{
      padding: 9px 10px;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      color: var(--text);
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      user-select:none;
    }

    /* Mobile UX: tabs + bottom planner */
    .mobileTabs{
      display:none;
      position:sticky;
      top: calc(58px + var(--safe-top));
      z-index:60;
      padding: 10px 12px;
      gap:10px;
      background: linear-gradient(180deg, rgba(10,16,32,.6), rgba(10,16,32,0));
      backdrop-filter: blur(6px);
    }
    .tabBtn{
      flex:1;
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.07);
      color: var(--text);
      font-weight: 800;
      font-size: 13px;
      text-align:center;
      cursor:pointer;
      user-select:none;
    }
    .tabBtn.active{
      border-color: rgba(134,182,255,.5);
      background: rgba(134,182,255,.14);
    }

    .bottomPlanner{
      display:none;
      position:fixed;
      left:12px; right:12px;
      bottom: calc(12px + var(--safe-bottom));
      z-index: 999;
    }
    .sheet{
      border:1px solid var(--stroke);
      background: rgba(10,16,32,.65);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheetHead{
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--stroke);
      gap:10px;
    }
    .sheetHead .left{min-width:0}
    .sheetHead .left .t{font-weight:900; font-size: 13px}
    .sheetHead .left .s{font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .sheetBody{padding: 12px}
    .hideOnMobile{display:block}

    @media (max-width: 980px){
      .shell{grid-template-columns: 340px 1fr}
    }
    @media (max-width: 860px){
      body{overflow:auto}
      .shell{
        height:auto;
        grid-template-columns: 1fr;
        padding: 0 12px 120px;
      }
      .panel.mapPanel{height: 62vh}
      .mobileTabs{display:flex}
      .bottomPlanner{display:block}
      .hideOnMobile{display:none!important}
      .panel.listPanel{display:none}
      .panel.listPanel.show{display:flex}
      .panel.mapPanel{display:none}
      .panel.mapPanel.show{display:flex}
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="topbar">
    <div class="brand">
      <h1><span class="dot"></span> Himachal Explorer</h1>
      <div id="statusChip" class="chip">Status: <b>Loading…</b></div>
    </div>

    <div class="row">
      <div class="chip" id="chipSelected">Selected: <b>None</b></div>
      <div class="chip" id="chipCount">Places: <b>0</b></div>
    </div>

    <!-- Mobile tabs -->
    <div class="mobileTabs">
      <div id="tabList" class="tabBtn active">Places</div>
      <div id="tabMap" class="tabBtn">Map</div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="shell">
    <!-- LEFT: LIST / FILTERS -->
    <div id="listPanel" class="panel listPanel show">
      <div class="panelHead">
        <div>
          <div class="title">Filters + Places</div>
          <div class="sub">Tap a place to select. Package start/end = major cities only.</div>
        </div>
        <button id="btnReset" class="btn" type="button">Reset</button>
      </div>

      <div class="panelBody">
        <div class="grid2">
          <div>
            <label class="lbl">District</label>
            <select id="fDistrict"></select>
          </div>
          <div>
            <label class="lbl">Segment</label>
            <select id="fSegment"></select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <div>
            <label class="lbl">Location Type</label>
            <select id="fType"></select>
          </div>
          <div>
            <label class="lbl">Search</label>
            <input id="fSearch" class="inp" placeholder="e.g. temple, lake, mall road"/>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid2">
          <button id="btnShowAll" class="btn" type="button">Show All</button>
          <button id="btnNearSelected" class="btn" type="button">Near Selected</button>
        </div>

        <div class="sep"></div>

        <div class="tiles" id="tiles"></div>
      </div>
    </div>

    <!-- RIGHT: MAP + PLANNER -->
    <div id="mapPanel" class="panel mapPanel show">
      <div class="mapWrap">
        <div id="map"></div>

        <!-- Overlay -->
        <div class="mapOverlay">
          <div class="overlayCard">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div style="min-width:0">
                <div style="font-weight:900; font-size:14px; line-height:1.1" id="selName">No place selected</div>
                <div class="muted2" id="selMeta">Tap a card to select</div>
              </div>
              <button id="btnCenter" class="miniBtn" type="button">Center</button>
            </div>

            <div class="overlayRow" style="margin-top:10px;">
              <span class="tiny" id="selBadge1">—</span>
              <span class="tiny" id="selBadge2">—</span>
              <span class="tiny" id="selBadge3">—</span>
            </div>

            <div class="sep" style="margin:10px 0"></div>

            <!-- DESKTOP PLANNER -->
            <div class="hideOnMobile">
              <div class="grid2">
                <div>
                  <label class="lbl">Start City (Major)</label>
                  <select id="startHub"></select>
                </div>
                <div>
                  <label class="lbl">End City (Major)</label>
                  <select id="endHub"></select>
                </div>
              </div>

              <div class="grid3" style="margin-top:10px;">
                <div>
                  <label class="lbl">Days</label>
                  <select id="pDays">
                    <option value="2">2</option><option value="3" selected>3</option><option value="4">4</option>
                    <option value="5">5</option><option value="6">6</option><option value="7">7</option>
                    <option value="8">8</option><option value="9">9</option>
                  </select>
                </div>
                <div>
                  <label class="lbl">People</label>
                  <select id="pPeople">
                    <option value="2">2</option><option value="4">4</option><option value="6" selected>6</option>
                    <option value="8">8</option><option value="10">10</option><option value="12">12</option>
                  </select>
                </div>
                <div>
                  <label class="lbl">Vehicle</label>
                  <select id="pVehicle">
                    <option value="hatchback">Hatchback</option>
                    <option value="sedan">Sedan</option>
                    <option value="suv" selected>SUV</option>
                    <option value="tempo">Tempo Traveller</option>
                  </select>
                </div>
              </div>

              <div class="grid2" style="margin-top:10px;">
                <button id="btnBuild" class="btn primary" type="button">Build Package</button>
                <button id="btnClearPlan" class="btn danger" type="button">Clear</button>
              </div>

              <div class="sep" style="margin:10px 0"></div>
              <div id="planOut" class="muted"></div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- MOBILE BOTTOM PLANNER -->
  <div class="bottomPlanner">
    <div class="sheet" id="plannerSheet">
      <div class="sheetHead">
        <div class="left">
          <div class="t">Quick Package Planner</div>
          <div class="s" id="mobileSelLine">Select a place to build package</div>
        </div>
        <button id="btnToggleSheet" class="miniBtn" type="button">Hide</button>
      </div>

      <div class="sheetBody" id="sheetBody">
        <div class="grid2">
          <div>
            <label class="lbl">Start City (Major)</label>
            <select id="startHubM"></select>
          </div>
          <div>
            <label class="lbl">End City (Major)</label>
            <select id="endHubM"></select>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px;">
          <div>
            <label class="lbl">Days</label>
            <select id="pDaysM">
              <option value="2">2</option><option value="3" selected>3</option><option value="4">4</option>
              <option value="5">5</option><option value="6">6</option><option value="7">7</option>
              <option value="8">8</option><option value="9">9</option>
            </select>
          </div>
          <div>
            <label class="lbl">People</label>
            <select id="pPeopleM">
              <option value="2">2</option><option value="4">4</option><option value="6" selected>6</option>
              <option value="8">8</option><option value="10">10</option><option value="12">12</option>
            </select>
          </div>
          <div>
            <label class="lbl">Vehicle</label>
            <select id="pVehicleM">
              <option value="hatchback">Hatchback</option>
              <option value="sedan">Sedan</option>
              <option value="suv" selected>SUV</option>
              <option value="tempo">Tempo Traveller</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:10px;">
          <button id="btnBuildM" class="btn primary" type="button">Build</button>
          <button id="btnClearPlanM" class="btn danger" type="button">Clear</button>
        </div>

        <div class="sep" style="margin:10px 0"></div>
        <div id="planOutM" class="muted"></div>
      </div>
    </div>
  </div>

  <script>
    /************************************************************
     * FIREBASE CONFIG (FILL YOUR CONFIG)
     ************************************************************/
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const LOC_NODE = "locations"; // /locations/{id}

    /************************************************************
     * MAJOR CITIES ONLY (START/END MUST BE FROM THIS LIST)
     ************************************************************/
    const HUBS = [
      { id:"delhi", name:"Delhi", lat:28.6139, lng:77.2090 },
      { id:"chandigarh", name:"Chandigarh", lat:30.7333, lng:76.7794 },
      { id:"dehradun", name:"Dehradun", lat:30.3165, lng:78.0322 },
      { id:"amritsar", name:"Amritsar", lat:31.6340, lng:74.8723 },

      { id:"shimla", name:"Shimla", lat:31.1048, lng:77.1734 },
      { id:"manali", name:"Manali", lat:32.2396, lng:77.1887 },
      { id:"dharamshala", name:"Dharamshala", lat:32.2190, lng:76.3234 },
      { id:"kullu", name:"Kullu", lat:31.9592, lng:77.1089 },
      { id:"mandi", name:"Mandi", lat:31.7088, lng:76.9313 },
      { id:"solan", name:"Solan", lat:30.9045, lng:77.0967 },
      { id:"una", name:"Una", lat:31.4685, lng:76.2708 },
      { id:"chamba", name:"Chamba", lat:32.5569, lng:76.1258 }
    ];

    function fillHubSelect(sel){
      sel.innerHTML = "";
      HUBS.forEach(h=>{
        const o = document.createElement("option");
        o.value = h.id;
        o.textContent = h.name;
        sel.appendChild(o);
      });
    }

    /************************************************************
     * APP STATE
     ************************************************************/
    let DB=null;
    let MAP=null;
    let MARKERS_LAYER=null;

    let ALL_PLACES=[];
    let VIEW_PLACES=[];
    let SELECTED_PLACE=null;
    let ROUTE_LINE=null;

    const $ = (id)=>document.getElementById(id);

    function setStatus(text, ok=true){
      const chip = $("statusChip");
      chip.innerHTML = `Status: <b>${text}</b>`;
      chip.style.borderColor = ok ? "rgba(165,255,207,.35)" : "rgba(255,107,107,.45)";
    }

    function safeStr(v){ return (v===undefined || v===null) ? "" : String(v); }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function pickFirstImage(p){
      if(Array.isArray(p.images) && p.images.length) return p.images.find(Boolean) || "";
      const keys = ["photo 1","photo 2","photo 3","photo 4","photo 5","photo 6","photo1","photo2","photo3","photo4","photo5","photo6","image","Image","Photo","photo"];
      for(const k of keys){
        if(p[k]) return String(p[k]).trim();
      }
      return "";
    }

    function getLatLng(p){
      const lat = parseFloat(p.Latitude ?? p.lat ?? p.latitude);
      const lng = parseFloat(p.Longitude ?? p.lng ?? p.longitude);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat,lng};

      const mapUrl = safeStr(p.Map || p.map);
      const m = mapUrl.match(/q=([-0-9.]+)\s*,\s*([-0-9.]+)/i);
      if(m) return {lat:parseFloat(m[1]), lng:parseFloat(m[2])};
      return null;
    }

    function distKm(aLat, aLng, bLat, bLng){
      const R = 6371;
      const dLat = (bLat-aLat) * Math.PI/180;
      const dLng = (bLng-aLng) * Math.PI/180;
      const s1 = Math.sin(dLat/2);
      const s2 = Math.sin(dLng/2);
      const aa = s1*s1 + Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*s2*s2;
      const c = 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1-aa));
      return R*c;
    }

    /************************************************************
     * FILTERS
     ************************************************************/
    function uniqueSorted(arr){
      return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
    }

    function fillFilterSelect(sel, values, labelAll="All"){
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = labelAll;
      sel.appendChild(opt0);

      values.forEach(v=>{
        const o=document.createElement("option");
        o.value = v;
        o.textContent = v;
        sel.appendChild(o);
      });
    }

    function applyFilters(){
      const d = $("fDistrict").value;
      const s = $("fSegment").value;
      const t = $("fType").value;
      const q = $("fSearch").value.trim().toLowerCase();

      VIEW_PLACES = ALL_PLACES.filter(p=>{
        const district = safeStr(p.District || p.district);
        const segment  = safeStr(p["Segment Type"] || p.segment || p.segmentType);
        const type     = safeStr(p["Location Type"] || p.type || p.locationType);
        const name     = safeStr(p["Location Name"] || p.name);
        const desc     = safeStr(p["Short Description"] || p.short || p.description || p.Overview || p.overview);

        if(d && district !== d) return false;
        if(s && segment !== s) return false;
        if(t && type !== t) return false;
        if(q){
          const hay = (name+" "+district+" "+segment+" "+type+" "+desc).toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      $("chipCount").innerHTML = `Places: <b>${VIEW_PLACES.length}</b>`;
      renderTiles();
      renderMarkers();
    }

    /************************************************************
     * TILES
     ************************************************************/
    function renderTiles(){
      const wrap = $("tiles");
      wrap.innerHTML = "";
      const max = 70;
      const list = VIEW_PLACES.slice(0, max);

      if(!list.length){
        const div = document.createElement("div");
        div.className="muted";
        div.textContent = "No places match. Try reset filters.";
        wrap.appendChild(div);
        return;
      }

      list.forEach(p=>{
        const name = safeStr(p["Location Name"] || p.name || p.firebase_id || p.id || "Untitled");
        const district = safeStr(p.District || p.district || "—");
        const segment  = safeStr(p["Segment Type"] || p.segment || "—");
        const type     = safeStr(p["Location Type"] || p.type || "—");
        const img = pickFirstImage(p);
        const desc = safeStr(p["Short Description"] || p.short || p.description || p.Overview || p.overview);

        const el = document.createElement("div");
        el.className = "tile";
        el.innerHTML = `
          <div class="tileTop">
            <div class="thumb">${img ? `<img src="${img}" alt="">` : `<span class="muted">IMG</span>`}</div>
            <div class="tileInfo">
              <div class="name">${escapeHtml(name)}</div>
              <div class="badges">
                <span class="badge blue">${escapeHtml(district)}</span>
                <span class="badge">${escapeHtml(segment)}</span>
                <span class="badge good">${escapeHtml(type)}</span>
              </div>
            </div>
          </div>
          <div class="tileBot">${escapeHtml(desc || "Tap to select & view on map")}</div>
        `;
        el.addEventListener("click", ()=>selectPlace(p, true));
        wrap.appendChild(el);
      });

      if(VIEW_PLACES.length > max){
        const more = document.createElement("div");
        more.className="muted";
        more.style.marginTop="8px";
        more.textContent = `Showing first ${max}. Use filters to narrow.`;
        wrap.appendChild(more);
      }
    }

    /************************************************************
     * MAP
     ************************************************************/
    function initMap(){
      MAP = L.map("map", { zoomControl:true });
      MAP.setView([31.8, 77.3], 7);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap"
      }).addTo(MAP);

      MARKERS_LAYER = L.layerGroup().addTo(MAP);
    }

    function renderMarkers(){
      if(!MARKERS_LAYER) return;
      MARKERS_LAYER.clearLayers();

      VIEW_PLACES.forEach(p=>{
        const ll = getLatLng(p);
        if(!ll) return;

        const name = safeStr(p["Location Name"] || p.name || "Place");
        const district = safeStr(p.District || p.district || "");

        const m = L.marker([ll.lat,ll.lng]);
        m.bindPopup(`<b>${escapeHtml(name)}</b><br><span>${escapeHtml(district)}</span>`);
        m.on("click", ()=>selectPlace(p,false));
        MARKERS_LAYER.addLayer(m);
      });
    }

    function centerOnSelected(){
      if(!SELECTED_PLACE) return;
      const ll = getLatLng(SELECTED_PLACE);
      if(!ll) return;
      MAP.setView([ll.lat,ll.lng], 12, {animate:true});
    }

    /************************************************************
     * SELECT PLACE
     ************************************************************/
    function selectPlace(place, center){
      SELECTED_PLACE = place;

      const name = safeStr(place["Location Name"] || place.name || place.firebase_id || place.id || "Selected");
      const district = safeStr(place.District || place.district || "—");
      const segment  = safeStr(place["Segment Type"] || place.segment || "—");
      const type     = safeStr(place["Location Type"] || place.type || "—");

      $("chipSelected").innerHTML = `Selected: <b>${escapeHtml(name)}</b>`;
      $("selName").textContent = name;
      $("selMeta").textContent = `${district} • ${segment} • ${type}`;
      $("selBadge1").textContent = district || "—";
      $("selBadge2").textContent = segment || "—";
      $("selBadge3").textContent = type || "—";
      $("mobileSelLine").textContent = `Selected: ${name}`;

      if(center) centerOnSelected();
    }

    /************************************************************
     * PACKAGE BUILDER (Major cities only)
     ************************************************************/
    function estimateCostKmRate(vehicle, people){
      const base = { hatchback: 13, sedan: 15, suv: 18, tempo: 26 }[vehicle] || 18;
      const scale = 1 + Math.max(0, (people-4)) * 0.03;
      return base * scale;
    }

    function hubNameById(id){
      const h = HUBS.find(x=>x.id===id);
      return h ? h.name : id;
    }

    function buildPackage(isMobile){
      if(!SELECTED_PLACE){
        alert("Select a place first (tap a place card).");
        return;
      }

      const out = isMobile ? $("planOutM") : $("planOut");
      const startSel = isMobile ? $("startHubM") : $("startHub");
      const endSel   = isMobile ? $("endHubM") : $("endHub");
      const daysEl   = isMobile ? $("pDaysM") : $("pDays");
      const pplEl    = isMobile ? $("pPeopleM") : $("pPeople");
      const vehEl    = isMobile ? $("pVehicleM") : $("pVehicle");

      const days = parseInt(daysEl.value,10);
      const people = parseInt(pplEl.value,10);
      const vehicle = vehEl.value;

      // ✅ MAJOR CITY ONLY
      const startId = startSel.value;
      const endId   = endSel.value;

      const startHub = HUBS.find(h=>h.id===startId);
      const endHub   = HUBS.find(h=>h.id===endId);
      const destLL   = getLatLng(SELECTED_PLACE);

      if(!startHub || !endHub){
        alert("Start/End must be selected from major cities.");
        return;
      }
      if(!destLL){
        alert("Selected place has no lat/lng. Add Latitude/Longitude in Firebase.");
        return;
      }

      const km1 = distKm(startHub.lat,startHub.lng, destLL.lat,destLL.lng);
      const km2 = distKm(destLL.lat,destLL.lng, endHub.lat,endHub.lng);
      const totalKm = km1 + km2;

      const perKm = estimateCostKmRate(vehicle, people);
      const transport = totalKm * perKm;

      const nights = Math.max(1, days-1);
      const stayPerPerson = 1200; // tune
      const stay = nights * people * stayPerPerson;

      const driver = (vehicle==="tempo" || vehicle==="suv") ? (nights*900) : (nights*700);

      const total = transport + stay + driver;

      const name = safeStr(SELECTED_PLACE["Location Name"] || SELECTED_PLACE.name || "Destination");
      const district = safeStr(SELECTED_PLACE.District || SELECTED_PLACE.district || "—");

      out.innerHTML = `
        <div style="font-weight:900; font-size:13px; margin-bottom:6px;">Package Preview</div>
        <div class="muted2" style="margin-bottom:10px;">
          <b>${escapeHtml(hubNameById(startId))}</b> → <b>${escapeHtml(name)}</b> (${escapeHtml(district)}) → <b>${escapeHtml(hubNameById(endId))}</b>
        </div>

        <div class="muted" style="line-height:1.55">
          • Days: <b>${days}</b> (${nights} nights)<br>
          • People: <b>${people}</b><br>
          • Vehicle: <b>${escapeHtml(vehicle.toUpperCase())}</b><br>
          • Est. travel distance: <b>${totalKm.toFixed(0)} km</b><br>
        </div>

        <div class="sep" style="margin:10px 0"></div>

        <div class="muted" style="line-height:1.55">
          Transport: <b>₹${transport.toFixed(0)}</b><br>
          Stay: <b>₹${stay.toFixed(0)}</b><br>
          Driver: <b>₹${driver.toFixed(0)}</b><br>
          <span style="color:var(--warn)">Total (estimate): <b>₹${total.toFixed(0)}</b></span>
        </div>

        <div class="muted2" style="margin-top:10px;">
          Note: This is a quick estimate. Replace straight-line km with your route/km sheet later for exact pricing.
        </div>
      `;

      drawRouteLine(startHub, destLL, endHub);
    }

    function drawRouteLine(startHub, destLL, endHub){
      if(!MAP) return;
      if(ROUTE_LINE){ MAP.removeLayer(ROUTE_LINE); ROUTE_LINE=null; }

      ROUTE_LINE = L.polyline(
        [[startHub.lat,startHub.lng],[destLL.lat,destLL.lng],[endHub.lat,endHub.lng]],
        {weight:4, opacity:.75}
      ).addTo(MAP);

      MAP.fitBounds(ROUTE_LINE.getBounds().pad(0.2));
    }

    function clearPlan(){
      const outs = [$("planOut"), $("planOutM")].filter(Boolean);
      outs.forEach(o=>o.innerHTML="");
      if(ROUTE_LINE && MAP){ MAP.removeLayer(ROUTE_LINE); ROUTE_LINE=null; }
    }

    /************************************************************
     * FIREBASE
     ************************************************************/
    async function initFirebase(){
      try{
        firebase.initializeApp(firebaseConfig);
        DB = firebase.database();
        setStatus("Firebase connected", true);
      }catch(e){
        console.error(e);
        setStatus("Firebase config missing / invalid", false);
      }
    }

    function listenPlaces(){
      if(!DB){
        setStatus("Firebase not ready", false);
        return;
      }
      setStatus("Loading places…", true);

      DB.ref(LOC_NODE).on("value", (snap)=>{
        const val = snap.val() || {};
        const arr = Object.keys(val).map(k=>{
          const obj = val[k] || {};
          obj.__key = k;
          return obj;
        });

        // normalize images array if photo fields exist
        arr.forEach(p=>{
          if(!Array.isArray(p.images)){
            const imgs = [];
            for(let i=1;i<=6;i++){
              const a = p[`photo ${i}`] || p[`photo${i}`] || p[`Photo ${i}`] || p[`Photo${i}`];
              if(a) imgs.push(String(a).trim());
            }
            if(imgs.length) p.images = imgs;
          }
        });

        ALL_PLACES = arr;
        setStatus(`Loaded ${ALL_PLACES.length} places`, true);
        $("chipCount").innerHTML = `Places: <b>${ALL_PLACES.length}</b>`;

        const districts = uniqueSorted(ALL_PLACES.map(p=>safeStr(p.District || p.district)));
        const segments  = uniqueSorted(ALL_PLACES.map(p=>safeStr(p["Segment Type"] || p.segment || p.segmentType)));
        const types     = uniqueSorted(ALL_PLACES.map(p=>safeStr(p["Location Type"] || p.type || p.locationType)));

        fillFilterSelect($("fDistrict"), districts, "All districts");
        fillFilterSelect($("fSegment"), segments, "All segments");
        fillFilterSelect($("fType"), types, "All types");

        applyFilters();
      }, (err)=>{
        console.error(err);
        setStatus("Firebase read blocked (check RTDB rules)", false);
      });
    }

    /************************************************************
     * MOBILE UX
     ************************************************************/
    function setupMobileUX(){
      const tabList = $("tabList");
      const tabMap  = $("tabMap");
      const listPanel = $("listPanel");
      const mapPanel = $("mapPanel");

      function show(which){
        if(which==="list"){
          tabList.classList.add("active");
          tabMap.classList.remove("active");
          listPanel.classList.add("show");
          mapPanel.classList.remove("show");
        }else{
          tabMap.classList.add("active");
          tabList.classList.remove("active");
          mapPanel.classList.add("show");
          listPanel.classList.remove("show");
          setTimeout(()=>MAP && MAP.invalidateSize(), 250);
        }
      }

      tabList.addEventListener("click", ()=>show("list"));
      tabMap.addEventListener("click", ()=>show("map"));

      const btn = $("btnToggleSheet");
      const body = $("sheetBody");
      let open = true;
      btn.addEventListener("click", ()=>{
        open = !open;
        body.style.display = open ? "block" : "none";
        btn.textContent = open ? "Hide" : "Show";
      });
    }

    function debounce(fn, wait){
      let t=null;
      return (...args)=>{
        clearTimeout(t);
        t=setTimeout(()=>fn(...args), wait);
      };
    }

    /************************************************************
     * EVENTS
     ************************************************************/
    function wireEvents(){
      $("fDistrict").addEventListener("change", applyFilters);
      $("fSegment").addEventListener("change", applyFilters);
      $("fType").addEventListener("change", applyFilters);
      $("fSearch").addEventListener("input", debounce(applyFilters, 180));

      $("btnReset").addEventListener("click", ()=>{
        $("fDistrict").value="";
        $("fSegment").value="";
        $("fType").value="";
        $("fSearch").value="";
        applyFilters();
      });

      $("btnShowAll").addEventListener("click", ()=>{
        $("fDistrict").value="";
        $("fSegment").value="";
        $("fType").value="";
        $("fSearch").value="";
        applyFilters();
      });

      $("btnNearSelected").addEventListener("click", ()=>{
        if(!SELECTED_PLACE){ alert("Select a place first."); return; }
        const ll = getLatLng(SELECTED_PLACE);
        if(!ll){ alert("Selected place has no lat/lng."); return; }

        const withinKm = 30;
        VIEW_PLACES = ALL_PLACES.filter(p=>{
          const pll = getLatLng(p);
          if(!pll) return false;
          return distKm(ll.lat,ll.lng, pll.lat,pll.lng) <= withinKm;
        });

        $("chipCount").innerHTML = `Places: <b>${VIEW_PLACES.length}</b>`;
        renderTiles();
        renderMarkers();
      });

      $("btnCenter").addEventListener("click", centerOnSelected);

      $("btnBuild").addEventListener("click", ()=>buildPackage(false));
      $("btnClearPlan").addEventListener("click", clearPlan);

      $("btnBuildM").addEventListener("click", ()=>buildPackage(true));
      $("btnClearPlanM").addEventListener("click", clearPlan);
    }

    /************************************************************
     * INIT
     ************************************************************/
    document.addEventListener("DOMContentLoaded", async ()=>{
      initMap();

      // Major city dropdowns only
      fillHubSelect($("startHub"));
      fillHubSelect($("endHub"));
      fillHubSelect($("startHubM"));
      fillHubSelect($("endHubM"));

      // Defaults
      $("startHub").value="chandigarh";
      $("endHub").value="shimla";
      $("startHubM").value="chandigarh";
      $("endHubM").value="shimla";

      setupMobileUX();
      wireEvents();

      await initFirebase();
      listenPlaces();

      setTimeout(()=>MAP && MAP.invalidateSize(), 250);
    });
  </script>
</body>
</html>