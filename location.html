<!-- location.html (FINAL) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Location • Himachal Explorer</title>

  <style>
    :root{
      --bg:#070a12; --stroke: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92); --muted: rgba(255,255,255,.72);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 18px; --r2: 26px;
      --ok:#49f2c2; --warn:#ffcf5a; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(120,120,255,.18), transparent 60%),
                  radial-gradient(1200px 800px at 80% 30%, rgba(0,255,200,.10), transparent 55%),
                  var(--bg);
      overflow-x:hidden;
    }
    .bg{
      position:fixed; inset:0;
      background:
        linear-gradient(180deg, rgba(5,8,16,.55), rgba(5,8,16,.90)),
        url("https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=2400&q=80");
      background-size:cover; background-position:center;
      z-index:-2; filter:saturate(1.08) contrast(1.05);
    }

    .wrap{max-width:1100px; margin:0 auto; padding:18px;}
    .topbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }
    .leftTop{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(255,255,255,.86);
    }
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:850;
      transition:.2s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{background: rgba(255,255,255,.16); transform:translateY(-1px)}

    .hero{
      margin-top:14px;
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .heroImg{
      height:260px;
      background-size:cover;
      background-position:center;
      position:relative;
    }
    .heroImg:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.78));
    }
    .heroBody{padding:14px}
    h1{margin:0;font-size:26px;line-height:1.15}
    .sub{margin:8px 0 0; color:var(--muted); line-height:1.5; max-width:70ch}
    .badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      min-height: 320px;
    }
    .card{
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .cardHead b{font-size:13px}
    .cardBody{padding:12px 14px}
    .kv{display:grid; gap:10px}
    .k{font-size:12px; letter-spacing:.14em; text-transform:uppercase; color:rgba(255,255,255,.70)}
    .v{font-size:13px; line-height:1.55; color:rgba(255,255,255,.90)}
    .muted{color:var(--muted)}
    .rowBtns{display:flex; gap:10px; flex-wrap:wrap}
    #map{
      height:320px;
      background:#0b1220;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      display:grid; place-items:center;
      color:rgba(255,255,255,.75); font-size:12px; text-align:center; padding:10px;
    }
    pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      color:rgba(255,255,255,.80);
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding:10px;
    }

    @media (max-width: 980px){ .grid{grid-template-columns:1fr} #map{height:280px} }
  </style>
</head>
<body>
  <div class="bg"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="leftTop">
        <a class="btn" href="index.html">← Back</a>
        <span class="pill" id="pDistrict">District: —</span>
        <span class="pill" id="pSeg">Segment: —</span>
        <span class="pill" id="pType">Type: —</span>
      </div>
      <div class="rowBtns">
        <a class="btn" id="openMapsBtn" target="_blank" rel="noopener">Open in Maps ↗</a>
        <button class="btn" id="addRouteBtn">+ Add to Route</button>
      </div>
    </div>

    <section class="hero">
      <div class="heroImg" id="heroImg"></div>
      <div class="heroBody">
        <h1 id="title">Loading…</h1>
        <p class="sub" id="subtitle">Fetching from Firebase…</p>
        <div class="badges" id="badges"></div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <div class="cardHead"><b>Details</b><span class="muted" id="coords">—</span></div>
        <div class="cardBody">
          <div class="kv">
            <div>
              <div class="k">Overview</div>
              <div class="v" id="overview">—</div>
            </div>
            <div>
              <div class="k">Short description</div>
              <div class="v" id="short">—</div>
            </div>
            <div>
              <div class="k">How to reach</div>
              <div class="v" id="reach">—</div>
            </div>
            <div>
              <div class="k">Key features</div>
              <div class="v" id="features">—</div>
            </div>
            <div>
              <div class="k">Task for location</div>
              <div class="v" id="task">—</div>
            </div>
            <div>
              <div class="k">Dist from HQ</div>
              <div class="v" id="distHq">—</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="k">Raw Firebase object</div>
            <pre id="raw">—</pre>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead"><b>Map</b><span class="muted" id="mapStatus">—</span></div>
        <div class="cardBody">
          <div id="map">Google Maps loading…</div>
          <div class="muted" style="margin-top:10px;font-size:12px;line-height:1.4">
            If map doesn’t load: enable Billing + Maps JavaScript API, and add your GitHub domain in HTTP referrers.
          </div>
        </div>
      </div>
    </section>

    <div style="margin-top:14px;" class="card">
      <div class="cardHead"><b>Nearby / Similar</b><span class="muted">Same district + segment</span></div>
      <div class="cardBody">
        <div id="similar" class="muted">Loading…</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    /******** CONFIG (same as index) ********/
    const GOOGLE_MAPS_API_KEY = "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug";
    const FIREBASE_LOCATIONS_PATH = "/locations"; // ✅ your data path

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.appspot.com",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ad"
    };

    const ROUTE_LS_KEY = "hp_route_v1";

    /******** UI refs ********/
    const titleEl = document.getElementById("title");
    const subtitleEl = document.getElementById("subtitle");
    const heroImgEl = document.getElementById("heroImg");
    const badgesEl = document.getElementById("badges");

    const pDistrict = document.getElementById("pDistrict");
    const pSeg = document.getElementById("pSeg");
    const pType = document.getElementById("pType");

    const coordsEl = document.getElementById("coords");
    const overviewEl = document.getElementById("overview");
    const shortEl = document.getElementById("short");
    const reachEl = document.getElementById("reach");
    const featuresEl = document.getElementById("features");
    const taskEl = document.getElementById("task");
    const distHqEl = document.getElementById("distHq");
    const rawEl = document.getElementById("raw");

    const openMapsBtn = document.getElementById("openMapsBtn");
    const addRouteBtn = document.getElementById("addRouteBtn");
    const similarEl = document.getElementById("similar");
    const mapStatus = document.getElementById("mapStatus");

    /******** Helpers for your DB keys ********/
    function pick(p, keys, fallback=""){
      for(const k of keys){
        if(p && p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== "") return p[k];
      }
      return fallback;
    }

    function parseLatLng(p){
      const lat = Number(p?.lat ?? p?.latitude ?? p?.Latitude);
      const lng = Number(p?.lng ?? p?.longitude ?? p?.Longitude);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat, lng};

      const m = String(p?.Map ?? p?.map ?? "").trim();
      const mm = m.match(/(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)/);
      if(mm) return { lat: Number(mm[1]), lng: Number(mm[3]) };

      return {lat: NaN, lng: NaN};
    }

    function fallbackImgFor(place){
      const seed = encodeURIComponent(`${place.segmentType} ${place.locationType} ${place.district} himachal`);
      return `https://source.unsplash.com/2400x1400/?${seed}`;
    }

    function pill(text){
      const s = document.createElement("span");
      s.className = "pill";
      s.textContent = text;
      return s;
    }

    function toast(msg){
      let t = document.getElementById("toast");
      if(!t){
        t = document.createElement("div");
        t.id="toast";
        t.style.cssText = `
          position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
          background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.16);
          color:white; padding:10px 12px; border-radius:999px; backdrop-filter: blur(10px);
          box-shadow: 0 20px 60px rgba(0,0,0,.55); z-index:999; font-weight:850;
          transition: opacity .2s ease;
          max-width:min(92vw, 900px);
          text-align:center;
        `;
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity="1";
      setTimeout(()=>{ t.style.opacity="0"; }, 1700);
    }

    /******** Firebase ********/
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    async function ensureAuth(){
      try{ if(!auth.currentUser) await signInAnonymously(auth); }catch{}
    }

    function getIdFromQuery(){
      const u = new URL(window.location.href);
      return u.searchParams.get("id");
    }

    async function loadOne(id){
      await ensureAuth();
      const snap = await get(ref(db, `${FIREBASE_LOCATIONS_PATH}/${id}`));
      return snap.exists() ? snap.val() : null;
    }

    async function loadAll(){
      await ensureAuth();
      const snap = await get(ref(db, FIREBASE_LOCATIONS_PATH));
      return snap.exists() ? snap.val() : {};
    }

    function normalizePlace(id, p){
      const {lat, lng} = parseLatLng(p);

      const name = String(pick(p, ["Location Name","locationName","name"], id)).trim();
      const district = String(pick(p, ["District","district"], "")).trim();
      const segmentType = String(pick(p, ["Segment Type","segmentType"], "Place")).trim();
      const locationType = String(pick(p, ["Location Type","locationType"], "—")).trim();

      return {
        id,
        name, district, segmentType, locationType,
        overview: String(pick(p, ["Overview","overview"], "")).trim(),
        shortDescription: String(pick(p, ["Short Description","shortDescription"], "")).trim(),
        howToReach: String(pick(p, ["How to Reach","howToReach"], "")).trim(),
        keyFeatures: String(pick(p, ["Key Features","keyFeatures"], "")).trim(),
        bestTimeToVisit: String(pick(p, ["Best Time to Visit","bestTimeToVisit"], "")).trim(),
        taskForLocation: String(pick(p, ["Task for Location","taskForLocation"], "")).trim(),
        distFromHQ: String(pick(p, ["Dist from HQ","Dist From HQ"], "")).trim(),
        mapUrl: String(pick(p, ["Map","mapUrl"], "")).trim(),
        lat, lng,
        raw: p
      };
    }

    /******** Route storage ********/
    function loadRoute(){
      try{
        const raw = localStorage.getItem(ROUTE_LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveRoute(route){
      localStorage.setItem(ROUTE_LS_KEY, JSON.stringify(route));
    }

    /******** Google Map ********/
    function loadGoogleMaps(){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_MAPS_API_KEY)}&callback=__initMap`;
        s.async = true; s.defer = true;
        window.__initMap = () => resolve();
        s.onerror = () => reject(new Error("Google Maps script failed"));
        document.head.appendChild(s);
      });
    }

    function showMapFixMessage(){
      mapStatus.textContent = "Maps failed";
      const mapEl = document.getElementById("map");
      mapEl.textContent =
        "Google Maps not loaded.\n\nFix:\n1) Enable Billing\n2) Enable Maps JavaScript API\n3) API Key restrictions: HTTP referrers add:\n   https://champishere001.github.io/*\n4) Wait 5 min and reload";
    }

    function renderMap(place){
      const mapEl = document.getElementById("map");

      if(!(window.google && google.maps)){
        showMapFixMessage();
        return;
      }
      if(!Number.isFinite(place.lat) || !Number.isFinite(place.lng)){
        mapStatus.textContent = "No coords";
        mapEl.textContent = "No coordinates for this location.";
        return;
      }

      mapStatus.textContent = "Ready";
      mapEl.textContent = "";
      const m = new google.maps.Map(mapEl, {
        center: {lat: place.lat, lng: place.lng},
        zoom: 12,
        mapTypeControl:false,
        streetViewControl:false,
        fullscreenControl:false
      });

      new google.maps.Marker({
        position: {lat: place.lat, lng: place.lng},
        map: m,
        title: place.name
      });
    }

    /******** Render ********/
    function setOpenMapsLink(place){
      const url = place.mapUrl
        || (Number.isFinite(place.lat) && Number.isFinite(place.lng)
          ? `https://www.google.com/maps?q=${place.lat},${place.lng}`
          : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.name + " " + (place.district||"") + " Himachal Pradesh")}`);

      openMapsBtn.href = url;
    }

    function renderPlace(place){
      titleEl.textContent = place.name || place.id;
      subtitleEl.textContent = (place.shortDescription || place.overview || "—");
      heroImgEl.style.backgroundImage = `url('${fallbackImgFor(place)}')`;

      pDistrict.textContent = "District: " + (place.district || "—");
      pSeg.textContent = "Segment: " + (place.segmentType || "—");
      pType.textContent = "Type: " + (place.locationType || "—");

      badgesEl.innerHTML = "";
      if(place.bestTimeToVisit) badgesEl.appendChild(pill("Best: " + place.bestTimeToVisit));
      if(place.distFromHQ) badgesEl.appendChild(pill("From HQ: " + place.distFromHQ));

      coordsEl.textContent = (Number.isFinite(place.lat) && Number.isFinite(place.lng))
        ? `${place.lat}, ${place.lng}`
        : "No coordinates";

      overviewEl.textContent = place.overview || "—";
      shortEl.textContent = place.shortDescription || "—";
      reachEl.textContent = place.howToReach || "—";
      featuresEl.textContent = place.keyFeatures || "—";
      taskEl.textContent = place.taskForLocation || "—";
      distHqEl.textContent = place.distFromHQ || "—";

      rawEl.textContent = JSON.stringify(place.raw || {}, null, 2);

      setOpenMapsLink(place);

      addRouteBtn.onclick = ()=>{
        if(!Number.isFinite(place.lat) || !Number.isFinite(place.lng)){
          toast("No coordinates. Add lat/lng first.");
          return;
        }
        const route = loadRoute();
        if(route.find(x=>x.id===place.id)){
          toast("Already in route");
          return;
        }
        route.push({ id: place.id, name: place.name, district: place.district, segmentType: place.segmentType, lat: place.lat, lng: place.lng });
        saveRoute(route);
        toast("Added to route ✅");
      };
    }

    function renderSimilar(list, current){
      const same = list
        .filter(x => x.id !== current.id)
        .filter(x => (x.district || "") === (current.district || ""))
        .filter(x => (x.segmentType || "") === (current.segmentType || ""))
        .slice(0, 12);

      if(!same.length){
        similarEl.textContent = "No similar places found.";
        return;
      }

      const wrap = document.createElement("div");
      wrap.style.display = "grid";
      wrap.style.gridTemplateColumns = "repeat(auto-fit, minmax(220px, 1fr))";
      wrap.style.gap = "10px";

      same.forEach(p=>{
        const a = document.createElement("a");
        a.href = `location.html?id=${encodeURIComponent(p.id)}`;
        a.className = "btn";
        a.style.justifyContent = "space-between";
        a.style.width = "100%";
        a.innerHTML = `<span>${p.name}</span><span style="opacity:.75;font-size:12px">${p.locationType || ""}</span>`;
        wrap.appendChild(a);
      });

      similarEl.innerHTML = "";
      similarEl.appendChild(wrap);
    }

    /******** Boot ********/
    (async ()=>{
      const id = getIdFromQuery();
      if(!id){
        titleEl.textContent = "Missing location id";
        subtitleEl.textContent = "Open from index page (card click).";
        document.getElementById("map").textContent = "—";
        similarEl.textContent = "—";
        return;
      }

      let placeRaw = null;
      try{
        placeRaw = await loadOne(id);
      }catch(e){
        titleEl.textContent = "Firebase error";
        subtitleEl.textContent = String(e?.message || e);
        return;
      }

      if(!placeRaw){
        titleEl.textContent = "Location not found";
        subtitleEl.textContent = "No data at /locations/" + id;
        similarEl.textContent = "—";
        return;
      }

      const place = normalizePlace(id, placeRaw);
      renderPlace(place);

      // load similar
      try{
        const all = await loadAll();
        const list = Object.entries(all || {}).map(([k,v])=> normalizePlace(k, v));
        renderSimilar(list, place);
      }catch{
        similarEl.textContent = "Similar places failed to load.";
      }

      // maps
      try{
        await loadGoogleMaps();
        renderMap(place);
      }catch{
        showMapFixMessage();
      }
    })();
  </script>
</body>
</html>