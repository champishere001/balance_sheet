<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Location • Himachal Explorer</title>

  <style>
    :root{
      --bg:#070a12;
      --stroke: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 18px; --r2: 26px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(120,120,255,.18), transparent 60%),
        radial-gradient(1200px 800px at 80% 30%, rgba(0,255,200,.10), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .bg{
      position:fixed; inset:0; z-index:-2;
      background-size:cover; background-position:center;
      filter:saturate(1.12) contrast(1.08);
      opacity:.75;
    }
    .bg::before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(5,8,16,.55), rgba(5,8,16,.92));
    }

    .wrap{max-width:1120px; margin:0 auto; padding:18px;}
    .topBar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:46px; height:46px; border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{width:70%;height:70%;object-fit:contain}
    .brand b{display:block}
    .brand small{color:var(--muted)}
    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      transition:.2s ease;
    }
    .btn:hover{transform:translateY(-1px); background: rgba(255,255,255,.16)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .heroImg{
      height:320px;
      background:#0b1220;
      background-size:cover;
      background-position:center;
      position:relative;
    }
    .heroImg::after{
      content:""; position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.70));
    }
    .heroInfo{
      position:absolute; left:14px; right:14px; bottom:14px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; justify-content:space-between;
    }
    .heroInfo h1{margin:0; font-size:24px; line-height:1.1}
    .pillRow{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      font-size:11px; padding:7px 9px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(10px);
    }

    .body{padding:14px}
    .sectionTitle{
      margin:12px 0 8px;
      font-size:12px; letter-spacing:.28em;
      text-transform:uppercase; color:rgba(255,255,255,.72);
    }
    .muted{color:var(--muted); font-size:13px; line-height:1.55}
    .kv{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media(max-width:560px){ .kv{grid-template-columns:1fr} }
    .kv .box{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding:10px;
    }
    .kv .box b{display:block; font-size:12px}
    .kv .box span{color:var(--muted); font-size:12px}

    .gallery{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:820px){ .gallery{grid-template-columns: repeat(2, minmax(0,1fr))} }
    @media(max-width:520px){ .gallery{grid-template-columns: 1fr} }
    .gimg{
      height:120px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:#0b1220;
      background-size:cover;
      background-position:center;
      cursor:pointer;
      transition:.2s ease;
    }
    .gimg:hover{transform:translateY(-2px); border-color: rgba(255,255,255,.20)}

    #map{
      height:280px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:#0b1220;
      display:grid;
      place-items:center;
      color:rgba(255,255,255,.75);
      padding:10px;
      text-align:center;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.16);
      color:white; padding:10px 12px; border-radius:999px; backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.55); z-index:999; font-weight:850;
      transition: opacity .2s ease;
      max-width:min(92vw, 900px);
      text-align:center;
      opacity:0;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <div class="bg" id="bg"></div>

  <div class="wrap">
    <div class="topBar">
      <div class="brand">
        <div class="logo"><img src="logo.png" alt="Logo" onerror="this.style.display='none'"></div>
        <div>
          <b>Himachal Explorer</b>
          <small id="sub">Loading location…</small>
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="backBtn">← Back</button>
        <button class="btn" id="openMapsBtn">Open in Google Maps</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="heroImg" id="heroImg">
          <div class="heroInfo">
            <div>
              <h1 id="title">—</h1>
              <div class="pillRow" id="pills"></div>
            </div>
          </div>
        </div>

        <div class="body">
          <div class="sectionTitle">Overview</div>
          <div class="muted" id="overview">—</div>

          <div class="sectionTitle">Key Info</div>
          <div class="kv">
            <div class="box"><b>How to Reach</b><span id="reach">—</span></div>
            <div class="box"><b>Best Time</b><span id="best">—</span></div>
            <div class="box"><b>Distance from HQ</b><span id="hq">—</span></div>
            <div class="box"><b>Tags</b><span id="tags">—</span></div>
          </div>

          <div class="sectionTitle">Gallery</div>
          <div class="gallery" id="gallery"></div>
        </div>
      </div>

      <div class="card">
        <div class="body">
          <div class="sectionTitle">Map</div>
          <div id="map">Loading map…</div>

          <div class="sectionTitle">Actions</div>
          <button class="btn" id="addToRouteBtn" style="width:100%;">+ Add to Route (from main page)</button>
          <div class="muted" style="margin-top:10px;">
            Tip: If you opened this from <b>Tracker/Packages mode</b>, build route there for full optimization.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    const GOOGLE_MAPS_API_KEY = "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug";
    const FIREBASE_LOCATIONS_PATH = "/locations";
    const ROUTE_LS_KEY = "hp_route_v1";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaFrj7JobWLloNQqzvx3SSibyrsiwzug",
      authDomain: "revnue-records.firebaseapp.com",
      databaseURL: "https://revnue-records-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "revnue-records",
      storageBucket: "revnue-records.appspot.com",
      messagingSenderId: "182348503564",
      appId: "1:182348503564:web:480085405b09177245ad"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const qs = new URLSearchParams(location.search);
    const id = qs.get("id");

    const bg = document.getElementById("bg");
    const sub = document.getElementById("sub");
    const title = document.getElementById("title");
    const overview = document.getElementById("overview");
    const reach = document.getElementById("reach");
    const best = document.getElementById("best");
    const hq = document.getElementById("hq");
    const tagsEl = document.getElementById("tags");
    const pills = document.getElementById("pills");
    const heroImg = document.getElementById("heroImg");
    const gallery = document.getElementById("gallery");
    const mapEl = document.getElementById("map");

    const backBtn = document.getElementById("backBtn");
    const openMapsBtn = document.getElementById("openMapsBtn");
    const addToRouteBtn = document.getElementById("addToRouteBtn");

    function pick(p, keys, fallback=""){
      for(const k of keys){
        if(p && p[k] !== undefined && p[k] !== null && String(p[k]).trim() !== "") return p[k];
      }
      return fallback;
    }
    function normalizeImages(p){
      const raw =
        pick(p, ["images","Images","Image URLs","Image Urls","imageUrls","photoUrls","photos","Photos"], "") ||
        [
          pick(p, ["Image 1","image1","Photo 1","photo1"], ""),
          pick(p, ["Image 2","image2","Photo 2","photo2"], ""),
          pick(p, ["Image 3","image3","Photo 3","photo3"], "")
        ].filter(Boolean).join(",");

      if(Array.isArray(raw)) return raw.map(x=>String(x).trim()).filter(Boolean);
      const s = String(raw || "").trim();
      if(!s) return [];
      if(s.includes(",")) return s.split(",").map(x=>x.trim()).filter(Boolean);
      return [s];
    }
    function parseLatLng(p){
      const lat = Number(p?.lat ?? p?.latitude ?? p?.Latitude);
      const lng = Number(p?.lng ?? p?.longitude ?? p?.Longitude);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return {lat, lng};

      const m = String(p?.Map ?? p?.map ?? "").trim();
      const mm = m.match(/(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)/);
      if(mm) return { lat: Number(mm[1]), lng: Number(mm[3]) };
      return {lat: NaN, lng: NaN};
    }
    function fallbackImg(name){
      const seed = encodeURIComponent(`${name} himachal`);
      return `https://source.unsplash.com/1200x800/?${seed}`;
    }

    async function ensureAuth(){
      try{ if(!auth.currentUser) await signInAnonymously(auth); }catch(e){}
    }

    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.opacity = "1";
      clearTimeout(window.__tt);
      window.__tt = setTimeout(()=> t.style.opacity="0", 1800);
    }

    backBtn.addEventListener("click", ()=>{
      history.length > 1 ? history.back() : (location.href="index.html");
    });

    function loadRoute(){
      try{
        const raw = localStorage.getItem(ROUTE_LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveRoute(route){
      localStorage.setItem(ROUTE_LS_KEY, JSON.stringify(route));
    }

    function setMapFallback(lat,lng){
      if(!Number.isFinite(lat) || !Number.isFinite(lng)){
        mapEl.textContent = "No coordinates available for this location.";
        return;
      }
      // no Google Maps? show link
      mapEl.innerHTML = `
        <div>
          Coordinates: ${lat.toFixed(5)}, ${lng.toFixed(5)}<br><br>
          <a style="color:white;" target="_blank" rel="noopener"
             href="https://www.google.com/maps?q=${lat},${lng}">Open Google Maps</a>
        </div>
      `;
    }

    function loadGoogleMaps(){
      return new Promise((resolve, reject)=>{
        const s = document.createElement("script");
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_MAPS_API_KEY)}&callback=__initMap2`;
        s.async = true; s.defer = true;
        window.__initMap2 = () => resolve();
        s.onerror = () => reject(new Error("Failed to load Google Maps"));
        document.head.appendChild(s);
      });
    }

    async function renderMap(lat,lng){
      if(!Number.isFinite(lat) || !Number.isFinite(lng)){
        setMapFallback(lat,lng);
        return;
      }
      try{
        await loadGoogleMaps();
        mapEl.textContent = "";
        const m = new google.maps.Map(mapEl, {
          center:{lat,lng},
          zoom: 11,
          mapTypeControl:false,
          streetViewControl:false,
          fullscreenControl:false
        });
        new google.maps.Marker({position:{lat,lng}, map:m});
      }catch(e){
        setMapFallback(lat,lng);
      }
    }

    async function loadLocation(){
      if(!id){
        sub.textContent = "Missing location id.";
        toast("Missing id in URL");
        return;
      }

      await ensureAuth();

      const snap = await get(ref(db, `${FIREBASE_LOCATIONS_PATH}/${id}`));
      if(!snap.exists()){
        sub.textContent = "Location not found.";
        toast("Not found in Firebase");
        return;
      }

      const p = snap.val();
      const name = String(pick(p, ["Location Name","locationName","name"], id)).trim();
      const district = String(pick(p, ["District","district"], "")).trim();
      const segmentType = String(pick(p, ["Segment Type","segmentType"], "Place")).trim();
      const locationType = String(pick(p, ["Location Type","locationType"], "—")).trim();

      const ov = String(pick(p, ["Overview","overview","Short Description","shortDescription"], "")).trim();
      const ht = String(pick(p, ["How to Reach","howToReach"], "")).trim();
      const bt = String(pick(p, ["Best Time to Visit","bestTimeToVisit"], "")).trim();
      const distHQ = String(pick(p, ["Dist from HQ","Dist From HQ","Distance from HQ"], "")).trim();
      const imgs = normalizeImages(p);
      const {lat,lng} = parseLatLng(p);

      title.textContent = name;
      sub.textContent = (district ? district + " • " : "") + segmentType;
      overview.textContent = ov || "No overview found in database yet.";
      reach.textContent = ht || "—";
      best.textContent = bt || "—";
      hq.textContent = distHQ || "—";

      // pills
      pills.innerHTML = "";
      [
        segmentType,
        district || "—",
        locationType || "—",
        (Number.isFinite(lat)&&Number.isFinite(lng)) ? "Coords ✓" : "No coords"
      ].forEach(x=>{
        const s = document.createElement("span");
        s.className = "pill";
        s.textContent = x;
        pills.appendChild(s);
      });

      // tags (simple)
      const tagSet = [];
      const text = (segmentType+" "+locationType+" "+ov+" "+ht).toLowerCase();
      if(/temple|mandir|devi|mahadev|shiva|shiv/.test(text)) tagSet.push("spiritual");
      if(/lake|river|waterfall|forest|valley|meadow|peak|mount|snow|nature|view|sunset/.test(text)) tagSet.push("nature");
      if(/trek|hike|trail|camp|adventure|paragliding|rafting|ski/.test(text)) tagSet.push("adventure");
      if(/heritage|colonial|fort|palace|museum|monastery|old/.test(text)) tagSet.push("heritage");
      if(/family|kids|picnic|easy/.test(text)) tagSet.push("family");
      tagsEl.textContent = tagSet.length ? tagSet.join(", ") : "—";

      // hero image + bg
      const hero = imgs[0] || fallbackImg(name);
      heroImg.style.backgroundImage = `url('${hero.replace(/'/g,"%27")}')`;
      bg.style.backgroundImage = `url('${hero.replace(/'/g,"%27")}')`;

      // gallery
      gallery.innerHTML = "";
      const all = (imgs.length ? imgs : [fallbackImg(name)]);
      all.slice(0,9).forEach(url=>{
        const d = document.createElement("div");
        d.className = "gimg";
        d.style.backgroundImage = `url('${String(url).replace(/'/g,"%27")}')`;
        d.title = "Open image";
        d.addEventListener("click", ()=> window.open(url, "_blank", "noopener"));
        gallery.appendChild(d);
      });

      // map + open maps
      openMapsBtn.addEventListener("click", ()=>{
        if(Number.isFinite(lat) && Number.isFinite(lng)){
          window.open(`https://www.google.com/maps?q=${lat},${lng}`, "_blank", "noopener");
        }else{
          window.open(`https://www.google.com/maps?q=${encodeURIComponent(name + " " + district + " Himachal Pradesh")}`, "_blank", "noopener");
        }
      });

      // add to route (LS shared with main page)
      addToRouteBtn.addEventListener("click", ()=>{
        if(!Number.isFinite(lat) || !Number.isFinite(lng)){
          toast("Can't add — coordinates missing.");
          return;
        }
        const r = loadRoute();
        if(r.find(x=>x.id===id)){
          toast("Already in route.");
          return;
        }
        r.push({id, name, district, segmentType, lat, lng});
        saveRoute(r);
        toast("Added to route ✅ (go back to main page)");
      });

      await renderMap(lat,lng);
    }

    loadLocation().catch(e=>{
      sub.textContent = "Failed to load.";
      toast("Error loading location");
      console.error(e);
    });
  </script>
</body>
</html>